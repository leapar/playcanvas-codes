!function(e,t){if("function"==typeof define&&define.amd)define([],t);else if("object"==typeof module&&module.exports)try{var i=(new(require("jsdom").JSDOM)).window,s=i.navigator;module.exports=t(i,s)}catch(e){module.exports=t()}else e.pc=t(e,e.navigator)}(this,function(e,t){window=e||window,navigator=t||navigator,Math.log2=Math.log2||function(e){return Math.log(e)*Math.LOG2E},"function"!=typeof Object.assign&&Object.defineProperty(Object,"assign",{value:function(e,t){if(null==e)throw new TypeError("Cannot convert undefined or null to object");for(var i=Object(e),s=1;s<arguments.length;s++){var n=arguments[s];if(null!=n)for(var a in n)Object.prototype.hasOwnProperty.call(n,a)&&(i[a]=n[a])}return i},writable:!0,configurable:!0}),function(){if("undefined"!=typeof navigator&&"undefined"!=typeof document){navigator.pointer=navigator.pointer||navigator.webkitPointer||navigator.mozPointer;var e=function(){var e=document.createEvent("CustomEvent");e.initCustomEvent("pointerlockchange",!0,!1,null),document.dispatchEvent(e)},t=function(){var e=document.createEvent("CustomEvent");e.initCustomEvent("pointerlockerror",!0,!1,null),document.dispatchEvent(e)};document.addEventListener("webkitpointerlockchange",e,!1),document.addEventListener("webkitpointerlocklost",e,!1),document.addEventListener("mozpointerlockchange",e,!1),document.addEventListener("mozpointerlocklost",e,!1),document.addEventListener("webkitpointerlockerror",t,!1),document.addEventListener("mozpointerlockerror",t,!1),Element.prototype.requestPointerLock=Element.prototype.mozRequestPointerLock?function(){this.mozRequestPointerLock()}:Element.prototype.requestPointerLock||Element.prototype.webkitRequestPointerLock||Element.prototype.mozRequestPointerLock,!Element.prototype.requestPointerLock&&navigator.pointer&&(Element.prototype.requestPointerLock=function(){document.pointerLockElement=this,navigator.pointer.lock(this,e,t)}),document.exitPointerLock=document.exitPointerLock||document.webkitExitPointerLock||document.mozExitPointerLock,document.exitPointerLock||(document.exitPointerLock=function(){navigator.pointer&&(document.pointerLockElement=null,navigator.pointer.unlock())})}}(),function(){for(var a=0,e=["ms","moz","webkit","o"],t=0;t<e.length&&!window.requestAnimationFrame;++t)window.requestAnimationFrame=window[e[t]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[e[t]+"CancelAnimationFrame"]||window[e[t]+"CancelRequestAnimationFrame"];window.requestAnimationFrame||(window.requestAnimationFrame=function(e,t){var i=(new Date).getTime(),s=Math.max(0,16-(i-a)),n=window.setTimeout(function(){e(i+s)},s);return a=i+s,n}),window.cancelAnimationFrame||(window.cancelAnimationFrame=function(e){clearTimeout(e)})}(),String.prototype.endsWith||(String.prototype.endsWith=function(e,t){return(void 0===t||t>this.length)&&(t=this.length),this.substring(t-e.length,t)===e}),String.prototype.includes||(String.prototype.includes=function(e,t){return"number"!=typeof t&&(t=0),!(t+e.length>this.length)&&-1!==this.indexOf(e,t)}),String.prototype.startsWith||(String.prototype.startsWith=function(e,t){return this.substr(!t||t<0?0:+t,e.length)===e});var i,s,n=function(){for(var e={},t="Array Object Function Date RegExp Float32Array".split(" "),i=0;i<t.length;i++)e["[object "+t[i]+"]"]=t[i].toLowerCase();return e}(),te={version:"1.22.0",revision:"01d9d5e",config:{},common:{},apps:{},data:{},unpack:function(){},makeArray:function(e){var t,i=[],s=e.length;for(t=0;t<s;++t)i.push(e[t]);return i},type:function(e){if(null===e)return"null";var t=typeof e;return"undefined"==t||"number"==t||"string"==t||"boolean"==t?t:n[Object.prototype.toString.call(e)]},extend:function(e,t){var i,s;for(i in t)s=t[i],"object"==te.type(s)?e[i]=te.extend({},s):"array"==te.type(s)?e[i]=te.extend([],s):e[i]=s;return e},isDefined:function(e){return void 0!==e}};"undefined"!=typeof exports&&(exports.pc=te),Object.assign(te,(i=function(e,t,i,s){var n=e&&e.length;3===n||4===n?(this.r=e[0],this.g=e[1],this.b=e[2],this.a=void 0!==e[3]?e[3]:1):(this.r=e||0,this.g=t||0,this.b=i||0,this.a=void 0!==s?s:1)},Object.assign(i.prototype,{clone:function(){return new te.Color(this.r,this.g,this.b,this.a)},copy:function(e){return this.r=e.r,this.g=e.g,this.b=e.b,this.a=e.a,this},set:function(e,t,i,s){return this.r=e,this.g=t,this.b=i,this.a=void 0===s?1:s,this},lerp:function(e,t,i){return this.r=e.r+i*(t.r-e.r),this.g=e.g+i*(t.g-e.g),this.b=e.b+i*(t.b-e.b),this.a=e.a+i*(t.a-e.a),this},fromString:function(e){var t=parseInt(e.replace("#","0x"),16);return 7<e.length?e=te.math.intToBytes32(t):(e=te.math.intToBytes24(t))[3]=255,this.set(e[0]/255,e[1]/255,e[2]/255,e[3]/255),this},toString:function(e){var t="#"+(16777216+(Math.round(255*this.r)<<16)+(Math.round(255*this.g)<<8)+Math.round(255*this.b)).toString(16).slice(1);return!0===e&&(e=Math.round(255*this.a).toString(16),t=this.a<16/255?t+"0"+e:t+e),t}}),{Color:i})),te.guid={create:function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=16*Math.random()|0;return("x"==e?t:3&t|8).toString(16)})}},Object.assign(te,(s=function(){this._isRunning=!1,this._b=this._a=0},Object.assign(s.prototype,{start:function(){this._isRunning=!0,this._a=te.now()},stop:function(){this._isRunning=!1,this._b=te.now()},getMilliseconds:function(){return this._b-this._a}}),{Timer:s,now:window.performance&&window.performance.now&&window.performance.timing?function(){return window.performance.now()}:Date.now})),Object.assign(te,{hashCode:function(e){for(var t=0,i=0,s=e.length;i<s;i++)t=(t<<5)-t+e.charCodeAt(i),t|=0;return t}}),Object.assign(te,{createURI:function(e){var t="";if((e.authority||e.scheme)&&(e.host||e.hostpath))throw Error("Can't have 'scheme' or 'authority' and 'host' or 'hostpath' option");if(e.host&&e.hostpath)throw Error("Can't have 'host' and 'hostpath' option");if(e.path&&e.hostpath)throw Error("Can't have 'path' and 'hostpath' option");return e.scheme&&(t+=e.scheme+":"),e.authority&&(t+="//"+e.authority),e.host&&(t+=e.host),e.path&&(t+=e.path),e.hostpath&&(t+=e.hostpath),e.query&&(t+="?"+e.query),e.fragment&&(t+="#"+e.fragment),t},URI:function(e){e=e.match(/^(([^:\/?#]+):)?(\/\/([^\/?#]*))?([^?#]*)(\?([^#]*))?(#(.*))?/),this.scheme=e[2],this.authority=e[4],this.path=e[5],this.query=e[7],this.fragment=e[9],this.toString=function(){var e="";return this.scheme&&(e+=this.scheme+":"),this.authority&&(e+="//"+this.authority),e+=this.path,this.query&&(e+="?"+this.query),this.fragment&&(e+="#"+this.fragment),e},this.getQuery=function(){var s,n={};return this.query&&decodeURIComponent(this.query).split("&").forEach(function(e,t,i){s=e.split("="),n[s[0]]=s[1]},this),n},this.setQuery=function(e){var t,i="";for(t in e)e.hasOwnProperty(t)&&(""!==i&&(i+="&"),i+=encodeURIComponent(t)+"="+encodeURIComponent(e[t]));this.query=i}}}),Object.assign(te,{log:{write:function(e){},open:function(){te.log.write("Powered by PlayCanvas "+te.version+" "+te.revision)},info:function(e){},debug:function(e){},error:function(e){},warning:function(e){},alert:function(e){te.log.write("ALERT:   "+e),alert(e)},assert:function(e,t){!1===e&&te.log.write("ASSERT:  "+t)}}});te.log.info,te.log.debug;var a,r,o,h,l,c,d,u,p,f,m,_,g,y,v,b,S,T,E,x,A,M,C,P,I,w,O,R,L,D,N,F,B,k,V,U,z,H,j,G,W,Y,X,q,K,Z,Q,$,J,ee,ie,se,ne,ae,re,oe,he,le,ce,de,ue,pe,fe,me,_e,ge,ye,ve,be,Se,Te,Ee,xe,Ae,Me,Ce,Pe,Ie=te.log.warning;te.log.error,te.log.alert,te.log.assert;te.path={delimiter:"/",join:function(){var e,t=arguments.length,i=arguments[0];for(e=0;e<t-1;++e){var s=arguments[e],n=arguments[e+1];if(!te.isDefined(s)||!te.isDefined(n))throw Error("undefined argument to pc.path.join");i=n[0]===te.path.delimiter?n:s&&n&&s[s.length-1]!==te.path.delimiter&&n[0]!==te.path.delimiter?i+(te.path.delimiter+n):i+n}return i},normalize:function(e){var t=e.startsWith(te.path.delimiter),i=e.endsWith(te.path.delimiter);e=e.split("/");for(var s=[],n=0;n<e.length;n++)""!==e[n]&&"."!==e[n]&&(".."===e[n]&&0<s.length?s=s.slice(0,s.length-2):(0<n&&s.push(te.path.delimiter),s.push(e[n])));return e=s.join(""),t||e[0]!==te.path.delimiter||(e=e.slice(1)),i&&e[e.length-1]!==te.path.delimiter&&(e+=te.path.delimiter),e},split:function(e){var t=(e=e.split(te.path.delimiter)).slice(e.length-1)[0];return[e.slice(0,e.length-1).join(te.path.delimiter),t]},getBasename:function(e){return te.path.split(e)[1]},getDirectory:function(e){return(e=e.split(te.path.delimiter)).slice(0,e.length-1).join(te.path.delimiter)},getExtension:function(e){var t=e.split("?")[0].split(".").pop();return t!==e?"."+t:""},isRelativePath:function(e){return"/"!==e.charAt(0)&&null===e.match(/:\/\//)},extractPath:function(e){var t=".",i=e.split("/");if(1<i.length)for(!1===te.path.isRelativePath(e)&&(t=""),e=0;e<i.length-1;++e)t+="/"+i[e];return t}},te.string=function(){function n(e,t){var i=e.length;if((t=t||0)<0||i<=t)return null;var s=e.charCodeAt(t);return 1<i&&55296<=s&&s<=56319&&(56320<=(i=e.charCodeAt(t+1))&&i<=57343)?{code:1024*(s-55296)+i-56320+65536,long:!0}:{code:s,long:!1}}function h(e,t,i){return!!e&&(!!(e=n(e))&&(t<=(e=e.code)&&e<=i))}return{ASCII_LOWERCASE:"abcdefghijklmnopqrstuvwxyz",ASCII_UPPERCASE:"ABCDEFGHIJKLMNOPQRSTUVWXYZ",ASCII_LETTERS:"abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ",format:function(e){var t,i,s=te.makeArray(arguments);for(s.shift(),t=0;t<s.length;t++)i=new RegExp("\\{"+t+"\\}","gi"),e=e.replace(i,s[t]);return e},startsWith:function(e,t){return e.startsWith(t)},endsWith:function(e,t){return e.endsWith(t)},toBool:function(e,t){if("true"===e)return!0;if(t){if("false"===e)return!1;throw new TypeError("Not a boolean string")}return!1},getCodePoint:function(e,t){var i=n(e,t);return i&&i.code},getCodePoints:function(e){if("string"!=typeof e)throw new TypeError("Not a string");for(var t,i=0,s=[];t=n(e,i);)s.push(t.code),i+=t.long?2:1;return s},getSymbols:function(e){if("string"!=typeof e)throw new TypeError("Not a string");for(var t,i=0,s=e.length,n=[],a=0;i<s;){var r=e,o=i+(t=a);h(t=e[i+(a=t+(a=o===r.length-1?1:h(r[o],55296,56319)?(a=r.substring(o,o+2),h(r=r.substring(o+2,o+4),127995,127999)||h(a,127462,127487)&&h(r,127462,127487)?4:h(r,65024,65039)?3:2):h(r[o+1],65024,65039)?2:1))],8400,8447)&&(t=e[i+a++]),h(t,65024,65039)&&(t=e[i+a++]),t&&8205===t.charCodeAt(0)?a++:(t=e.substring(i,i+a),n.push(t),i+=a,a=0)}return n},fromCodePoint:function(){for(var e,t,i=[],s=0;s<arguments.length;++s)t=(e=Number(arguments[s]))-65536,e=65535<e?[55296+(t>>10),t%1024+56320]:[e],i.push(String.fromCharCode.apply(null,e));return i.join("")}}}(),te.debug=(h=o=r=a=null,{display:function(e){for(var t in a||(a=document.createElement("table"),r=document.createElement("tr"),o=document.createElement("td"),h=document.createElement("td"),a.style.cssText="position:absolute;font-family:sans-serif;font-size:12px;color:#cccccc",a.style.top="0px",a.style.left="0px",a.style.border="thin solid #cccccc",document.body.appendChild(a)),a.innerHTML="",e){var i=r.cloneNode(),s=o.cloneNode(),n=h.cloneNode();s.textContent=t,n.textContent=e[t],i.appendChild(s),i.appendChild(n),a.appendChild(i)}}}),te.events={attach:function(e){var t=te.events;return e.on=t.on,e.off=t.off,e.fire=t.fire,e.once=t.once,e.hasEvent=t.hasEvent,e._callbacks={},e._callbackActive={},e},on:function(e,t,i){return e&&"string"==typeof e&&t&&(this._callbacks[e]||(this._callbacks[e]=[]),this._callbackActive[e]&&this._callbackActive[e]===this._callbacks[e]&&(this._callbackActive[e]=this._callbackActive[e].slice()),this._callbacks[e].push({callback:t,scope:i||this})),this},off:function(e,t,i){if(e)this._callbackActive[e]&&this._callbackActive[e]===this._callbacks[e]&&(this._callbackActive[e]=this._callbackActive[e].slice());else for(var s in this._callbackActive)this._callbacks[s]&&this._callbacks[s]===this._callbackActive[s]&&(this._callbackActive[s]=this._callbackActive[s].slice());if(e)if(t){if(!(e=this._callbacks[e]))return this;s=e.length;for(var n=0;n<s;n++)e[n].callback===t&&(i&&e[n].scope!==i||(e[n--]=e[--s]));e.length=s}else this._callbacks[e]&&(this._callbacks[e]=[]);else this._callbacks={};return this},fire:function(e,t,i,s,n,a,r,o,h){if(!e||!this._callbacks[e])return this;var l;this._callbackActive[e]?(this._callbackActive[e]===this._callbacks[e]&&(this._callbackActive[e]=this._callbackActive[e].slice()),l=this._callbacks[e].slice()):this._callbackActive[e]=this._callbacks[e];for(var c=0;(l||this._callbackActive[e])&&c<(l||this._callbackActive[e]).length;c++){var d=(l||this._callbackActive[e])[c];d.callback.call(d.scope,t,i,s,n,a,r,o,h),d.callback.once&&(-1!==(d=this._callbacks[e].indexOf(d))&&(this._callbackActive[e]===this._callbacks[e]&&(this._callbackActive[e]=this._callbackActive[e].slice()),this._callbacks[e].splice(d,1)))}return l||(this._callbackActive[e]=null),this},once:function(e,t,i){return t.once=!0,this.on(e,t,i),this},hasEvent:function(e){return this._callbacks[e]&&0!==this._callbacks[e].length||!1}},Object.assign(te,function(){var e=function(e){this._index={},this._key=e||null};Object.assign(e.prototype,{addItem:function(e){for(var t=e.tags._list,i=0;i<t.length;i++)this.add(t[i],e)},removeItem:function(e){for(var t=e.tags._list,i=0;i<t.length;i++)this.remove(t[i],e)},add:function(e,t){this._index[e]&&-1!==this._index[e].list.indexOf(t)||(this._index[e]||(this._index[e]={list:[]},this._key&&(this._index[e].keys={})),this._index[e].list.push(t),this._key&&(this._index[e].keys[t[this._key]]=t))},remove:function(e,t){if(this._index[e]&&(!this._key||this._index[e].keys[t[this._key]])){var i=this._index[e].indexOf(t);-1!==i&&(this._index[e].list.splice(i,1),this._key&&delete this._index[e].keys[t[this._key]],0===this._index[e].list.length&&delete this._index[e])}},find:function(e){var t,i,s,n,a,r=this,o={},h=[],l=function(e,t){return r._index[e].list.length-r._index[t].list.length};for(t=0;t<e.length;t++){if((n=e[t])instanceof Array){if(0===n.length)continue;if(1!==n.length){for(s=!1,i=0;i<n.length;i++)if(!this._index[n[i]]){s=!0;break}if(s)continue;for(1===(a=(n=n.slice(0).sort(l)).slice(1)).length&&(a=a[0]),i=0;i<this._index[n[0]].list.length;i++)s=this._index[n[0]].list[i],(this._key?!o[s[this._key]]:-1===h.indexOf(s))&&s.tags.has(a)&&(this._key&&(o[s[this._key]]=!0),h.push(s));continue}n=n[0]}if(n&&"string"==typeof n&&this._index[n])for(i=0;i<this._index[n].list.length;i++)s=this._index[n].list[i],this._key?o[s[this._key]]||(o[s[this._key]]=!0,h.push(s)):-1===h.indexOf(s)&&h.push(s)}return h}});var t=function(e){this._index={},this._list=[],this._parent=e,te.events.attach(this)};return Object.assign(t.prototype,{add:function(){var e=!1,t=this._processArguments(arguments,!0);if(!t.length)return e;for(var i=0;i<t.length;i++)this._index[t[i]]||(e=!0,this._index[t[i]]=!0,this._list.push(t[i]),this.fire("add",t[i],this._parent));return e&&this.fire("change",this._parent),e},remove:function(){var e=!1;if(!this._list.length)return e;var t=this._processArguments(arguments,!0);if(!t.length)return e;for(var i=0;i<t.length;i++)this._index[t[i]]&&(e=!0,delete this._index[t[i]],this._list.splice(this._list.indexOf(t[i]),1),this.fire("remove",t[i],this._parent));return e&&this.fire("change",this._parent),e},clear:function(){if(this._list.length){var e=this._list.slice(0);this._list=[],this._index={};for(var t=0;t<e.length;t++)this.fire("remove",e[t],this._parent);this.fire("change",this._parent)}},has:function(){return!!this._list.length&&this._has(this._processArguments(arguments))},_has:function(e){if(!this._list.length||!e.length)return!1;for(var t=0;t<e.length;t++)if(1===e[t].length){if(this._index[e[t][0]])return!0}else{for(var i=!0,s=0;s<e[t].length;s++)if(!this._index[e[t][s]]){i=!1;break}if(i)return!0}return!1},list:function(){return this._list.slice(0)},_processArguments:function(e,t){var i=[],s=[];if(!e||!e.length)return i;for(var n=0;n<e.length;n++)if(e[n]instanceof Array){t||(s=[]);for(var a=0;a<e[n].length;a++)"string"==typeof e[n][a]&&(t?i.push(e[n][a]):s.push(e[n][a]));!t&&s.length&&i.push(s)}else"string"==typeof e[n]&&(t?i.push(e[n]):i.push([e[n]]));return i}}),Object.defineProperty(t.prototype,"size",{get:function(){return this._list.length}}),{TagsCache:e,Tags:t}}()),Object.assign(te,(l=function(e,t){this._constructor=e,this._pool=[],this._count=0,this._resize(t)},Object.assign(l.prototype,{_resize:function(e){if(e>this._pool.length)for(var t=this._pool.length;t<e;t++)this._pool[t]=new this._constructor},allocate:function(){return this._count>=this._pool.length&&this._resize(2*this._pool.length),this._pool[this._count++]},freeAll:function(){this._count=0}}),{AllocatePool:l})),Object.assign(te,(c={desktop:!1,mobile:!1,ios:!1,android:!1,windows:!1,cocoonjs:!1,xbox:!1,gamepads:!1,touch:!1,workers:!1},d=navigator.userAgent,/(windows|mac os|linux|cros)/i.test(d)&&(c.desktop=!0),/xbox/i.test(d)&&(c.xbox=!0),/(windows phone|iemobile|wpdesktop)/i.test(d)?(c.desktop=!1,c.mobile=!0,c.windows=!0):/android/i.test(d)?(c.desktop=!1,c.mobile=!0,c.android=!0):/ip([ao]d|hone)/i.test(d)&&(c.desktop=!1,c.mobile=!0,c.ios=!0),navigator.isCocoonJS&&(c.cocoonjs=!0),c.touch="ontouchstart"in window||"maxTouchPoints"in navigator&&0<navigator.maxTouchPoints,c.gamepads="getGamepads"in navigator,c.workers="undefined"!=typeof Worker,{platform:c})),Object.assign(te,(u=function(){this._list=[],this._index={}},Object.assign(u.prototype,{push:function(e,t){if(this._index[e])throw Error("Key already in index "+e);var i=this._list.push(t)-1;this._index[e]=i},has:function(e){return void 0!==this._index[e]},get:function(e){return void 0!==(e=this._index[e])?this._list[e]:null},remove:function(e){var t=this._index[e];if(void 0===t)return!1;for(e in this._list.splice(t,1),delete this._index[e],this._index){var i=this._index[e];t<i&&(this._index[e]=i-1)}return!0},list:function(){return this._list},clear:function(){for(var e in this._list.length=0,this._index)delete this._index[e]}}),{IndexedList:u})),te.math={DEG_TO_RAD:Math.PI/180,RAD_TO_DEG:180/Math.PI,clamp:function(e,t,i){return i<=e?i:e<=t?t:e},intToBytes24:function(e){return[e>>16&255,e>>8&255,255&e]},intToBytes32:function(e){return[e>>24&255,e>>16&255,e>>8&255,255&e]},bytesToInt24:function(e,t,i){return e.length&&(i=e[2],t=e[1],e=e[0]),e<<16|t<<8|i},bytesToInt32:function(e,t,i,s){return e.length&&(s=e[3],i=e[2],t=e[1],e=e[0]),(e<<24|t<<16|i<<8|s)>>>32},lerp:function(e,t,i){return e+(t-e)*te.math.clamp(i,0,1)},lerpAngle:function(e,t,i){return 180<t-e&&(t-=360),t-e<-180&&(t+=360),te.math.lerp(e,t,te.math.clamp(i,0,1))},powerOfTwo:function(e){return 0!==e&&!(e&e-1)},nextPowerOfTwo:function(e){return e--,e|=e>>1,e|=e>>2,e|=e>>4,e|=e>>8,e|=e>>16,++e},random:function(e,t){return Math.random()*(t-e)+e},smoothstep:function(e,t,i){return i<=e?0:t<=i?1:(i=(i-e)/(t-e))*i*(3-2*i)},smootherstep:function(e,t,i){return i<=e?0:t<=i?1:(i=(i-e)/(t-e))*i*i*(i*(6*i-15)+10)}},Object.assign(te,(g=function(e,t){e&&2===e.length?(this.x=e[0],this.y=e[1]):(this.x=e||0,this.y=t||0)},Object.assign(g.prototype,{add:function(e){return this.x+=e.x,this.y+=e.y,this},add2:function(e,t){return this.x=e.x+t.x,this.y=e.y+t.y,this},clone:function(){return(new g).copy(this)},copy:function(e){return this.x=e.x,this.y=e.y,this},dot:function(e){return this.x*e.x+this.y*e.y},equals:function(e){return this.x===e.x&&this.y===e.y},length:function(){return Math.sqrt(this.x*this.x+this.y*this.y)},lengthSq:function(){return this.x*this.x+this.y*this.y},lerp:function(e,t,i){return this.x=e.x+i*(t.x-e.x),this.y=e.y+i*(t.y-e.y),this},mul:function(e){return this.x*=e.x,this.y*=e.y,this},mul2:function(e,t){return this.x=e.x*t.x,this.y=e.y*t.y,this},normalize:function(){var e=this.x*this.x+this.y*this.y;return 0<e&&(e=1/Math.sqrt(e),this.x*=e,this.y*=e),this},scale:function(e){return this.x*=e,this.y*=e,this},set:function(e,t){return this.x=e,this.y=t,this},sub:function(e){return this.x-=e.x,this.y-=e.y,this},sub2:function(e,t){return this.x=e.x-t.x,this.y=e.y-t.y,this},toString:function(){return"["+this.x+", "+this.y+"]"}}),Object.defineProperty(g,"ONE",{get:(p=new g(1,1),function(){return p})}),Object.defineProperty(g,"RIGHT",{get:(f=new g(1,0),function(){return f})}),Object.defineProperty(g,"UP",{get:(m=new g(0,1),function(){return m})}),Object.defineProperty(g,"ZERO",{get:(_=new g(0,0),function(){return _})}),{Vec2:g})),Object.assign(te,(M=function(e,t,i){e&&3===e.length?(this.x=e[0],this.y=e[1],this.z=e[2]):(this.x=e||0,this.y=t||0,this.z=i||0)},Object.assign(M.prototype,{add:function(e){return this.x+=e.x,this.y+=e.y,this.z+=e.z,this},add2:function(e,t){return this.x=e.x+t.x,this.y=e.y+t.y,this.z=e.z+t.z,this},clone:function(){return(new M).copy(this)},copy:function(e){return this.x=e.x,this.y=e.y,this.z=e.z,this},cross:function(e,t){var i=e.x,s=e.y,n=e.z,a=t.x,r=t.y,o=t.z;return this.x=s*o-r*n,this.y=n*a-o*i,this.z=i*r-a*s,this},dot:function(e){return this.x*e.x+this.y*e.y+this.z*e.z},equals:function(e){return this.x===e.x&&this.y===e.y&&this.z===e.z},length:function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)},lengthSq:function(){return this.x*this.x+this.y*this.y+this.z*this.z},lerp:function(e,t,i){return this.x=e.x+i*(t.x-e.x),this.y=e.y+i*(t.y-e.y),this.z=e.z+i*(t.z-e.z),this},mul:function(e){return this.x*=e.x,this.y*=e.y,this.z*=e.z,this},mul2:function(e,t){return this.x=e.x*t.x,this.y=e.y*t.y,this.z=e.z*t.z,this},normalize:function(){var e=this.x*this.x+this.y*this.y+this.z*this.z;return 0<e&&(e=1/Math.sqrt(e),this.x*=e,this.y*=e,this.z*=e),this},project:function(e){var t=(this.x*e.x+this.y*e.y+this.z*e.z)/(e.x*e.x+e.y*e.y+e.z*e.z);return this.x=e.x*t,this.y=e.y*t,this.z=e.z*t,this},scale:function(e){return this.x*=e,this.y*=e,this.z*=e,this},set:function(e,t,i){return this.x=e,this.y=t,this.z=i,this},sub:function(e){return this.x-=e.x,this.y-=e.y,this.z-=e.z,this},sub2:function(e,t){return this.x=e.x-t.x,this.y=e.y-t.y,this.z=e.z-t.z,this},toString:function(){return"["+this.x+", "+this.y+", "+this.z+"]"}}),Object.defineProperty(M,"BACK",{get:(y=new M(0,0,1),function(){return y})}),Object.defineProperty(M,"DOWN",{get:(v=new M(0,-1,0),function(){return v})}),Object.defineProperty(M,"FORWARD",{get:(b=new M(0,0,-1),function(){return b})}),Object.defineProperty(M,"LEFT",{get:(S=new M(-1,0,0),function(){return S})}),Object.defineProperty(M,"ONE",{get:(T=new M(1,1,1),function(){return T})}),Object.defineProperty(M,"RIGHT",{get:(E=new M(1,0,0),function(){return E})}),Object.defineProperty(M,"UP",{get:(x=new M(0,1,0),function(){return x})}),Object.defineProperty(M,"ZERO",{get:(A=new M(0,0,0),function(){return A})}),{Vec3:M})),Object.assign(te,(I=function(e,t,i,s){e&&4===e.length?(this.x=e[0],this.y=e[1],this.z=e[2],this.w=e[3]):(this.x=e||0,this.y=t||0,this.z=i||0,this.w=s||0)},Object.assign(I.prototype,{add:function(e){return this.x+=e.x,this.y+=e.y,this.z+=e.z,this.w+=e.w,this},add2:function(e,t){return this.x=e.x+t.x,this.y=e.y+t.y,this.z=e.z+t.z,this.w=e.w+t.w,this},clone:function(){return(new I).copy(this)},copy:function(e){return this.x=e.x,this.y=e.y,this.z=e.z,this.w=e.w,this},dot:function(e){return this.x*e.x+this.y*e.y+this.z*e.z+this.w*e.w},equals:function(e){return this.x===e.x&&this.y===e.y&&this.z===e.z&&this.w===e.w},length:function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)},lengthSq:function(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w},lerp:function(e,t,i){return this.x=e.x+i*(t.x-e.x),this.y=e.y+i*(t.y-e.y),this.z=e.z+i*(t.z-e.z),this.w=e.w+i*(t.w-e.w),this},mul:function(e){return this.x*=e.x,this.y*=e.y,this.z*=e.z,this.w*=e.w,this},mul2:function(e,t){return this.x=e.x*t.x,this.y=e.y*t.y,this.z=e.z*t.z,this.w=e.w*t.w,this},normalize:function(){var e=this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w;return 0<e&&(e=1/Math.sqrt(e),this.x*=e,this.y*=e,this.z*=e,this.w*=e),this},scale:function(e){return this.x*=e,this.y*=e,this.z*=e,this.w*=e,this},set:function(e,t,i,s){return this.x=e,this.y=t,this.z=i,this.w=s,this},sub:function(e){return this.x-=e.x,this.y-=e.y,this.z-=e.z,this.w-=e.w,this},sub2:function(e,t){return this.x=e.x-t.x,this.y=e.y-t.y,this.z=e.z-t.z,this.w=e.w-t.w,this},toString:function(){return"["+this.x+", "+this.y+", "+this.z+", "+this.w+"]"}}),Object.defineProperty(I,"ONE",{get:(C=new I(1,1,1,1),function(){return C})}),Object.defineProperty(I,"ZERO",{get:(P=new I(0,0,0,0),function(){return P})}),{Vec4:I})),Object.assign(te,(R=function(){var e;(e=new Float32Array(9))[0]=e[4]=e[8]=1,this.data=e},Object.assign(R.prototype,{clone:function(){return(new te.Mat3).copy(this)},copy:function(e){e=e.data;var t=this.data;return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],this},set:function(e){var t=this.data;return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],this},equals:function(e){var t=this.data;return e=e.data,t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]&&t[3]===e[3]&&t[4]===e[4]&&t[5]===e[5]&&t[6]===e[6]&&t[7]===e[7]&&t[8]===e[8]},isIdentity:function(){var e=this.data;return 1===e[0]&&0===e[1]&&0===e[2]&&0===e[3]&&1===e[4]&&0===e[5]&&0===e[6]&&0===e[7]&&1===e[8]},setIdentity:function(){var e=this.data;return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=1,e[5]=0,e[6]=0,e[7]=0,e[8]=1,this},toString:function(){for(var e="[",t=0;t<9;t++)e+=this.data[t],e+=8!==t?", ":"";return e+"]"},transpose:function(){var e,t=this.data;return e=t[1],t[1]=t[3],t[3]=e,e=t[2],t[2]=t[6],t[6]=e,e=t[5],t[5]=t[7],t[7]=e,this}}),Object.defineProperty(R,"IDENTITY",{get:(w=new R,function(){return w})}),Object.defineProperty(R,"ZERO",{get:(O=(new R).set([0,0,0,0,0,0,0,0,0]),function(){return O})}),{Mat3:R})),Object.assign(te,(H=function(){var e=new Float32Array(16);e[0]=e[5]=e[10]=e[15]=1,this.data=e},Object.assign(H.prototype,{add2:function(e,t){var i=e.data,s=t.data,n=this.data;return n[0]=i[0]+s[0],n[1]=i[1]+s[1],n[2]=i[2]+s[2],n[3]=i[3]+s[3],n[4]=i[4]+s[4],n[5]=i[5]+s[5],n[6]=i[6]+s[6],n[7]=i[7]+s[7],n[8]=i[8]+s[8],n[9]=i[9]+s[9],n[10]=i[10]+s[10],n[11]=i[11]+s[11],n[12]=i[12]+s[12],n[13]=i[13]+s[13],n[14]=i[14]+s[14],n[15]=i[15]+s[15],this},add:function(e){return this.add2(this,e)},clone:function(){return(new te.Mat4).copy(this)},copy:function(e){e=e.data;var t=this.data;return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15],this},equals:function(e){var t=this.data;return e=e.data,t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]&&t[3]===e[3]&&t[4]===e[4]&&t[5]===e[5]&&t[6]===e[6]&&t[7]===e[7]&&t[8]===e[8]&&t[9]===e[9]&&t[10]===e[10]&&t[11]===e[11]&&t[12]===e[12]&&t[13]===e[13]&&t[14]===e[14]&&t[15]===e[15]},isIdentity:function(){var e=this.data;return 1===e[0]&&0===e[1]&&0===e[2]&&0===e[3]&&0===e[4]&&1===e[5]&&0===e[6]&&0===e[7]&&0===e[8]&&0===e[9]&&1===e[10]&&0===e[11]&&0===e[12]&&0===e[13]&&0===e[14]&&1===e[15]},mul2:function(e,t){var i,s,n,a,r,o,h,l,c,d,u,p,f,m,_,g,y,v,b,S;g=e.data;var T=t.data,E=this.data;return i=g[0],s=g[1],n=g[2],a=g[3],r=g[4],o=g[5],h=g[6],l=g[7],c=g[8],d=g[9],u=g[10],p=g[11],f=g[12],m=g[13],_=g[14],g=g[15],y=T[0],v=T[1],b=T[2],S=T[3],E[0]=i*y+r*v+c*b+f*S,E[1]=s*y+o*v+d*b+m*S,E[2]=n*y+h*v+u*b+_*S,E[3]=a*y+l*v+p*b+g*S,y=T[4],v=T[5],b=T[6],S=T[7],E[4]=i*y+r*v+c*b+f*S,E[5]=s*y+o*v+d*b+m*S,E[6]=n*y+h*v+u*b+_*S,E[7]=a*y+l*v+p*b+g*S,y=T[8],v=T[9],b=T[10],S=T[11],E[8]=i*y+r*v+c*b+f*S,E[9]=s*y+o*v+d*b+m*S,E[10]=n*y+h*v+u*b+_*S,E[11]=a*y+l*v+p*b+g*S,y=T[12],v=T[13],b=T[14],S=T[15],E[12]=i*y+r*v+c*b+f*S,E[13]=s*y+o*v+d*b+m*S,E[14]=n*y+h*v+u*b+_*S,E[15]=a*y+l*v+p*b+g*S,this},mul:function(e){return this.mul2(this,e)},transformPoint:function(e,t){var i,s,n,a;return a=this.data,i=e.x,s=e.y,n=e.z,(t=void 0===t?new te.Vec3:t).x=i*a[0]+s*a[4]+n*a[8]+a[12],t.y=i*a[1]+s*a[5]+n*a[9]+a[13],t.z=i*a[2]+s*a[6]+n*a[10]+a[14],t},transformVector:function(e,t){var i,s,n,a;return a=this.data,i=e.x,s=e.y,n=e.z,(t=void 0===t?new te.Vec3:t).x=i*a[0]+s*a[4]+n*a[8],t.y=i*a[1]+s*a[5]+n*a[9],t.z=i*a[2]+s*a[6]+n*a[10],t},transformVec4:function(e,t){var i,s,n,a,r;return r=this.data,i=e.x,s=e.y,n=e.z,a=e.w,(t=void 0===t?new te.Vec4:t).x=i*r[0]+s*r[4]+n*r[8]+a*r[12],t.y=i*r[1]+s*r[5]+n*r[9]+a*r[13],t.z=i*r[2]+s*r[6]+n*r[10]+a*r[14],t.w=i*r[3]+s*r[7]+n*r[11]+a*r[15],t},setLookAt:(B=new te.Vec3,k=new te.Vec3,V=new te.Vec3,function(e,t,i){return V.sub2(e,t).normalize(),k.copy(i).normalize(),B.cross(k,V).normalize(),k.cross(V,B),(t=this.data)[0]=B.x,t[1]=B.y,t[2]=B.z,t[3]=0,t[4]=k.x,t[5]=k.y,t[6]=k.z,t[7]=0,t[8]=V.x,t[9]=V.y,t[10]=V.z,t[11]=0,t[12]=e.x,t[13]=e.y,t[14]=e.z,t[15]=1,this}),setFrustum:function(e,t,i,s,n,a){var r,o,h,l,c;return r=2*n,o=t-e,h=s-i,l=a-n,(c=this.data)[0]=r/o,c[1]=0,c[2]=0,c[3]=0,c[4]=0,c[5]=r/h,c[6]=0,c[7]=0,c[8]=(t+e)/o,c[9]=(s+i)/h,c[10]=(-a-n)/l,c[11]=-1,c[12]=0,c[13]=0,c[14]=-r*a/l,c[15]=0,this},setPerspective:function(e,t,i,s,n){return n?n=(e=i*Math.tan(e*Math.PI/360))/t:e=(n=i*Math.tan(e*Math.PI/360))*t,this.setFrustum(-e,e,-n,n,i,s)},setOrtho:function(e,t,i,s,n,a){var r=this.data;return r[0]=2/(t-e),r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[5]=2/(s-i),r[6]=0,r[7]=0,r[8]=0,r[9]=0,r[10]=-2/(a-n),r[11]=0,r[12]=-(t+e)/(t-e),r[13]=-(s+i)/(s-i),r[14]=-(a+n)/(a-n),r[15]=1,this},setFromAxisAngle:function(e,t){var i,s,n,a,r,o,h,l,c;return t*=te.math.DEG_TO_RAD,i=e.x,s=e.y,n=e.z,a=Math.cos(t),r=Math.sin(t),h=(o=1-a)*i,l=o*s,(c=this.data)[0]=h*i+a,c[1]=h*s+r*n,c[2]=h*n-r*s,c[3]=0,c[4]=h*s-r*n,c[5]=l*s+a,c[6]=l*n+r*i,c[7]=0,c[8]=h*n+r*s,c[9]=l*n-i*r,c[10]=o*n*n+a,c[11]=0,c[12]=0,c[13]=0,c[14]=0,c[15]=1,this},setTranslate:function(e,t,i){var s=this.data;return s[0]=1,s[1]=0,s[2]=0,s[3]=0,s[4]=0,s[5]=1,s[6]=0,s[7]=0,s[8]=0,s[9]=0,s[10]=1,s[11]=0,s[12]=e,s[13]=t,s[14]=i,s[15]=1,this},setScale:function(e,t,i){var s=this.data;return s[0]=e,s[1]=0,s[2]=0,s[3]=0,s[4]=0,s[5]=t,s[6]=0,s[7]=0,s[8]=0,s[9]=0,s[10]=i,s[11]=0,s[12]=0,s[13]=0,s[14]=0,s[15]=1,this},invert:function(){var e,t,i,s,n,a,r,o,h,l,c,d,u,p,f,m,_,g,y,v,b,S,T,E,x,A,M,C,P,I;return e=(I=this.data)[0],t=I[1],i=I[2],s=I[3],n=I[4],a=I[5],r=I[6],o=I[7],h=I[8],l=I[9],c=I[10],d=I[11],u=I[12],p=I[13],f=I[14],0==(P=(_=e*a-t*n)*(C=c*(m=I[15])-d*f)-(g=e*r-i*n)*(M=l*m-d*p)+(y=e*o-s*n)*(A=l*f-c*p)+(v=t*r-i*a)*(x=h*m-d*u)-(b=t*o-s*a)*(E=h*f-c*u)+(S=i*o-s*r)*(T=h*p-l*u))?this.setIdentity():(P=1/P,I[0]=(a*C-r*M+o*A)*P,I[1]=(-t*C+i*M-s*A)*P,I[2]=(p*S-f*b+m*v)*P,I[3]=(-l*S+c*b-d*v)*P,I[4]=(-n*C+r*x-o*E)*P,I[5]=(e*C-i*x+s*E)*P,I[6]=(-u*S+f*y-m*g)*P,I[7]=(h*S-c*y+d*g)*P,I[8]=(n*M-a*x+o*T)*P,I[9]=(-e*M+t*x-s*T)*P,I[10]=(u*b-p*y+m*_)*P,I[11]=(-h*b+l*y-d*_)*P,I[12]=(-n*A+a*E-r*T)*P,I[13]=(e*A-t*E+i*T)*P,I[14]=(-u*v+p*g-f*_)*P,I[15]=(h*v-l*g+c*_)*P),this},set:function(e){var t=this.data;return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15],this},setIdentity:function(){var e=this.data;return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,this},setTRS:function(e,t,i){var s,n,a,r,o,h,l,c,d,u,p,f,m;return s=e.x,n=e.y,e=e.z,a=t.x,r=t.y,o=t.z,h=t.w,t=i.x,l=i.y,i=i.z,p=a*(c=a+a),f=a*(d=r+r),a*=u=o+o,m=r*d,r*=u,o*=u,c*=h,d*=h,h*=u,(u=this.data)[0]=(1-(m+o))*t,u[1]=(f+h)*t,u[2]=(a-d)*t,u[3]=0,u[4]=(f-h)*l,u[5]=(1-(p+o))*l,u[6]=(r+c)*l,u[7]=0,u[8]=(a+d)*i,u[9]=(r-c)*i,u[10]=(1-(p+m))*i,u[11]=0,u[12]=s,u[13]=n,u[14]=e,u[15]=1,this},transpose:function(){var e,t=this.data;return e=t[1],t[1]=t[4],t[4]=e,e=t[2],t[2]=t[8],t[8]=e,e=t[3],t[3]=t[12],t[12]=e,e=t[6],t[6]=t[9],t[9]=e,e=t[7],t[7]=t[13],t[13]=e,e=t[11],t[11]=t[14],t[14]=e,this},invertTo3x3:function(e){var t,i,s,n;t=this.data,e=e.data;var a=t[0],r=t[1],o=t[2],h=t[4],l=t[5],c=t[6],d=t[8],u=t[9],p=t[10];return 0==(n=a*(t=p*l-c*u)+r*(i=-p*h+c*d)+o*(s=u*h-l*d))||(n=1/n,e[0]=n*t,e[1]=n*(-p*r+o*u),e[2]=n*(c*r-o*l),e[3]=n*i,e[4]=n*(p*a-o*d),e[5]=n*(-c*a+o*h),e[6]=n*s,e[7]=n*(-u*a+r*d),e[8]=n*(l*a-r*h)),this},getTranslation:function(e){return(e=void 0===e?new te.Vec3:e).set(this.data[12],this.data[13],this.data[14])},getX:function(e){return(e=void 0===e?new te.Vec3:e).set(this.data[0],this.data[1],this.data[2])},getY:function(e){return(e=void 0===e?new te.Vec3:e).set(this.data[4],this.data[5],this.data[6])},getZ:function(e){return(e=void 0===e?new te.Vec3:e).set(this.data[8],this.data[9],this.data[10])},getScale:(D=new te.Vec3,N=new te.Vec3,F=new te.Vec3,function(e){return e=void 0===e?new te.Vec3:e,this.getX(D),this.getY(N),this.getZ(F),e.set(D.length(),N.length(),F.length()),e}),setFromEulerAngles:function(e,t,i){var s,n,a,r;return e*=te.math.DEG_TO_RAD,t*=te.math.DEG_TO_RAD,i*=te.math.DEG_TO_RAD,s=Math.sin(-e),e=Math.cos(-e),n=Math.sin(-t),t=Math.cos(-t),a=Math.sin(-i),i=Math.cos(-i),(r=this.data)[0]=t*i,r[1]=-t*a,r[2]=n,r[3]=0,r[4]=e*a+i*s*n,r[5]=e*i-s*n*a,r[6]=-t*s,r[7]=0,r[8]=s*a-e*i*n,r[9]=i*s+e*n*a,r[10]=e*t,r[11]=0,r[12]=0,r[13]=0,r[14]=0,r[15]=1,this},getEulerAngles:(L=new te.Vec3,function(e){var t,i,s,n,a,r;return e=void 0===e?new te.Vec3:e,this.getScale(L),s=L.x,t=L.y,n=L.z,a=this.data,(i=Math.asin(-a[2]/s))<(r=.5*Math.PI)?-r<i?(t=Math.atan2(a[6]/t,a[10]/n),s=Math.atan2(a[1]/s,a[0]/s)):(s=0,t=-Math.atan2(a[4]/t,a[5]/t)):(s=0,t=Math.atan2(a[4]/t,a[5]/t)),e.set(t,i,s).scale(te.math.RAD_TO_DEG)}),toString:function(){var e,t;for(t="[",e=0;e<16;e+=1)t+=this.data[e],t+=15!==e?", ":"";return t+"]"}}),Object.defineProperty(H,"IDENTITY",{get:(U=new H,function(){return U})}),Object.defineProperty(H,"ZERO",{get:(z=(new H).set([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]),function(){return z})}),{Mat4:H})),Object.assign(te,(W=function(e,t,i,s){e&&4===e.length?(this.x=e[0],this.y=e[1],this.z=e[2],this.w=e[3]):(this.x=void 0===e?0:e,this.y=void 0===t?0:t,this.z=void 0===i?0:i,this.w=void 0===s?1:s)},Object.assign(W.prototype,{clone:function(){return new te.Quat(this.x,this.y,this.z,this.w)},conjugate:function(){return this.x*=-1,this.y*=-1,this.z*=-1,this},copy:function(e){return this.x=e.x,this.y=e.y,this.z=e.z,this.w=e.w,this},equals:function(e){return this.x===e.x&&this.y===e.y&&this.z===e.z&&this.w===e.w},getAxisAngle:function(e){var t=2*Math.acos(this.w),i=Math.sin(t/2);return 0!==i?(e.x=this.x/i,e.y=this.y/i,e.z=this.z/i,(e.x<0||e.y<0||e.z<0)&&(e.x*=-1,e.y*=-1,e.z*=-1,t*=-1)):(e.x=1,e.y=0,e.z=0),t*te.math.RAD_TO_DEG},getEulerAngles:function(e){var t,i,s,n,a,r;return e=void 0===e?new te.Vec3:e,s=this.x,n=this.y,a=this.z,s=(i=2*((r=this.w)*n-s*a))<=-.99999?(t=2*Math.atan2(s,r),i=-Math.PI/2,0):.99999<=i?(t=2*Math.atan2(s,r),i=Math.PI/2,0):(t=Math.atan2(2*(r*s+n*a),1-2*(s*s+n*n)),i=Math.asin(i),Math.atan2(2*(r*a+s*n),1-2*(n*n+a*a))),e.set(t,i,s).scale(te.math.RAD_TO_DEG)},invert:function(){return this.conjugate().normalize()},length:function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)},lengthSq:function(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w},mul:function(e){var t,i,s,n,a,r,o;return t=this.x,i=this.y,s=this.z,n=this.w,a=e.x,r=e.y,o=e.z,e=e.w,this.x=n*a+t*e+i*o-s*r,this.y=n*r+i*e+s*a-t*o,this.z=n*o+s*e+t*r-i*a,this.w=n*e-t*a-i*r-s*o,this},mul2:function(e,t){var i,s,n,a,r,o,h,l;return i=e.x,s=e.y,n=e.z,a=e.w,r=t.x,o=t.y,h=t.z,l=t.w,this.x=a*r+i*l+s*h-n*o,this.y=a*o+s*l+n*r-i*h,this.z=a*h+n*l+i*o-s*r,this.w=a*l-i*r-s*o-n*h,this},normalize:function(){var e=this.length();return 0===e?(this.x=this.y=this.z=0,this.w=1):(e=1/e,this.x*=e,this.y*=e,this.z*=e,this.w*=e),this},set:function(e,t,i,s){return this.x=e,this.y=t,this.z=i,this.w=s,this},setFromAxisAngle:function(e,t){var i,s;return t*=.5*te.math.DEG_TO_RAD,i=Math.sin(t),s=Math.cos(t),this.x=i*e.x,this.y=i*e.y,this.z=i*e.z,this.w=s,this},setFromEulerAngles:function(e,t,i){var s,n,a;return e*=s=.5*te.math.DEG_TO_RAD,t*=s,i*=s,s=Math.sin(e),e=Math.cos(e),n=Math.sin(t),t=Math.cos(t),a=Math.sin(i),i=Math.cos(i),this.x=s*t*i-e*n*a,this.y=e*n*i+s*t*a,this.z=e*t*a-s*n*i,this.w=e*t*i+s*n*a,this},setFromMat4:function(e){var t,i,s,n,a,r,o,h,l,c,d;return t=(e=e.data)[0],i=e[1],s=e[2],n=e[4],a=e[5],r=e[6],o=e[8],h=e[9],e=e[10],0==(l=t*t+i*i+s*s)||(l=1/Math.sqrt(l),0==(c=n*n+a*a+r*r)||(c=1/Math.sqrt(c),0==(d=o*o+h*h+e*e)||(i*=l,s*=l,n*=c,r*=c,o*=d=1/Math.sqrt(d),h*=d,0<=(l=(t*=l)+(a*=c)+(e*=d))?(t=Math.sqrt(l+1),this.w=.5*t,t=.5/t,this.x=(r-h)*t,this.y=(o-s)*t,this.z=(i-n)*t):a<t?e<t?(t=Math.sqrt(t-(a+e)+1),this.x=.5*t,t=.5/t,this.w=(r-h)*t,this.y=(i+n)*t,this.z=(s+o)*t):(t=Math.sqrt(e-(t+a)+1),this.z=.5*t,t=.5/t,this.w=(i-n)*t,this.x=(o+s)*t,this.y=(h+r)*t):e<a?(t=Math.sqrt(a-(e+t)+1),this.y=.5*t,t=.5/t,this.w=(o-s)*t,this.z=(r+h)*t,this.x=(n+i)*t):(t=Math.sqrt(e-(t+a)+1),this.z=.5*t,t=.5/t,this.w=(i-n)*t,this.x=(o+s)*t,this.y=(h+r)*t)))),this},slerp:function(e,t,i){var s,n,a,r,o,h;s=e.x,n=e.y,a=e.z,e=e.w,r=t.x,o=t.y,h=t.z;var l=e*(t=t.w)+s*r+n*o+a*h;if(l<0&&(t=-t,r=-r,o=-o,h=-h,l=-l),1<=Math.abs(l))return this.w=e,this.x=s,this.y=n,this.z=a,this;var c=Math.acos(l),d=Math.sqrt(1-l*l);return Math.abs(d)<.001?(this.w=.5*e+.5*t,this.x=.5*s+.5*r,this.y=.5*n+.5*o,this.z=.5*a+.5*h):(l=Math.sin((1-i)*c)/d,i=Math.sin(i*c)/d,this.w=e*l+t*i,this.x=s*l+r*i,this.y=n*l+o*i,this.z=a*l+h*i),this},transformVector:function(e,t){void 0===t&&(t=new te.Vec3);var i=e.x,s=e.y,n=e.z,a=this.x,r=this.y,o=this.z,h=this.w,l=h*i+r*n-o*s,c=h*s+o*i-a*n,d=h*n+a*s-r*i;return i=-a*i-r*s-o*n,t.x=l*h+i*-a+c*-o-d*-r,t.y=c*h+i*-r+d*-a-l*-o,t.z=d*h+i*-o+l*-r-c*-a,t},toString:function(){return"["+this.x+", "+this.y+", "+this.z+", "+this.w+"]"}}),Object.defineProperty(W,"IDENTITY",{get:(j=new W,function(){return j})}),Object.defineProperty(W,"ZERO",{get:(G=new W(0,0,0,0),function(){return G})}),{Quat:W})),Object.assign(te,(Y=function(e){if(this.keys=[],this.type=1,this.tension=.5,this._eval=new te.CurveEvaluator(this),e)for(var t=0;t<e.length-1;t+=2)this.keys.push([e[t],e[t+1]]);this.sort()},Object.assign(Y.prototype,{add:function(e,t){for(var i=this.keys,s=i.length,n=0;n<s&&!(i[n][0]>e);n++);return i=[e,t],this.keys.splice(n,0,i),i},get:function(e){return this.keys[e]},sort:function(){this.keys.sort(function(e,t){return e[0]-t[0]})},value:function(e){return this._eval.evaluate(e,!0)},closest:function(e){for(var t=this.keys,i=t.length,s=2,n=null,a=0;a<i;a++){var r=Math.abs(e-t[a][0]);if(!(r<=s))break;s=r,n=t[a]}return n},clone:function(){var e=new te.Curve;return e.keys=te.extend(e.keys,this.keys),e.type=this.type,e.tension=this.tension,e},quantize:function(e){e=Math.max(e,2);var t=new Float32Array(e),i=1/(e-1);t[0]=this._eval.evaluate(0,!0);for(var s=1;s<e;s++)t[s]=this._eval.evaluate(i*s);return t},quantizeClamped:function(e,t,i){e=this.quantize(e);for(var s=0;s<e.length;++s)e[s]=Math.min(i,Math.max(t,e[s]));return e}}),Object.defineProperty(Y.prototype,"length",{get:function(){return this.keys.length}}),{Curve:Y,CURVE_LINEAR:0,CURVE_SMOOTHSTEP:1,CURVE_CATMULL:2,CURVE_CARDINAL:3,CURVE_SPLINE:4,CURVE_STEP:5})),Object.assign(te,(X=function(){var e;if(this.curves=[],this._type=te.CURVE_SMOOTHSTEP,1<arguments.length)for(e=0;e<arguments.length;e++)this.curves.push(new te.Curve(arguments[e]));else if(0===arguments.length)this.curves.push(new te.Curve);else{var t=arguments[0];if("number"===te.type(t))for(e=0;e<t;e++)this.curves.push(new te.Curve);else for(e=0;e<t.length;e++)this.curves.push(new te.Curve(t[e]))}},Object.assign(X.prototype,{get:function(e){return this.curves[e]},value:function(e,t){var i=this.curves.length;(t=t||[]).length=i;for(var s=0;s<i;s++)t[s]=this.curves[s].value(e);return t},clone:function(){var e=new te.CurveSet;e.curves=[];for(var t=0;t<this.curves.length;t++)e.curves.push(this.curves[t].clone());return e._type=this._type,e},quantize:function(e){e=Math.max(e,2);for(var t=this.curves.length,i=new Float32Array(e*t),s=1/(e-1),n=0;n<t;n++)for(var a=new te.CurveEvaluator(this.curves[n]),r=0;r<e;r++)i[r*t+n]=a.evaluate(s*r);return i},quantizeClamped:function(e,t,i){e=this.quantize(e);for(var s=0;s<e.length;++s)e[s]=Math.min(i,Math.max(t,e[s]));return e}}),Object.defineProperty(X.prototype,"length",{get:function(){return this.curves.length}}),Object.defineProperty(X.prototype,"type",{get:function(){return this._type},set:function(e){this._type=e;for(var t=0;t<this.curves.length;t++)this.curves[t].type=e}}),{CurveSet:X})),Object.assign(te,(q=function(e,t){this._curve=e,this._left=-1/0,this._right=1/0,this._m1=this._m0=this._p1=this._p0=this._recip=0,this._reset(t||0)},Object.assign(q.prototype,{evaluate:function(e,t){var i;if((t||e<this._left||e>=this._right)&&this._reset(e),(i=this._curve.type)===te.CURVE_STEP)i=this._p0;else{var s=0===this._recip?0:(e-this._left)*this._recip;i=i===te.CURVE_LINEAR?te.math.lerp(this._p0,this._p1,s):i===te.CURVE_SMOOTHSTEP?te.math.lerp(this._p0,this._p1,s*s*(3-2*s)):this._evaluateHermite(this._p0,this._p1,this._m0,this._m1,s)}return i},_reset:function(e){var t=this._curve.keys,i=t.length;if(i)if(e<t[0][0])this._left=-1/0,this._right=t[0][0],this._recip=0,this._p0=this._p1=t[0][1],this._m0=this._m1=0;else if(e>=t[i-1][0])this._left=t[i-1][0],this._right=1/0,this._recip=0,this._p0=this._p1=t[i-1][1],this._m0=this._m1=0;else{for(i=0;e>=t[i+1][0];)i++;this._left=t[i][0],this._right=t[i+1][0],e=1/(this._right-this._left),this._recip=isFinite(e)?e:0,this._p0=t[i][1],this._p1=t[i+1][1],this._isHermite()&&this._calcTangents(t,i)}else this._left=-1/0,this._right=1/0,this._p0=this._p1=this._m0=this._m1=this._recip=0},_isHermite:function(){return this._curve.type===te.CURVE_CATMULL||this._curve.type===te.CURVE_CARDINAL||this._curve.type===te.CURVE_SPLINE},_calcTangents:function(e,t){var i,s,n=e[t],a=e[t+1];if(i=0===t?[e[0][0]+(e[0][0]-e[1][0]),e[0][1]+(e[0][1]-e[1][1])]:e[t-1],s=t==e.length-2?[e[t+1][0]+(e[t+1][0]-e[t][0]),e[t+1][1]+(e[t+1][1]-e[t][1])]:e[t+2],this._curve.type===te.CURVE_SPLINE){var r=2*(a[0]-n[0])/(a[0]-i[0]),o=2*(a[0]-n[0])/(s[0]-n[0]);this._m0=this._curve.tension*(isFinite(r)?r:0)*(a[1]-i[1]),this._m1=this._curve.tension*(isFinite(o)?o:0)*(s[1]-n[1])}else o=(a[0]-n[0])/(n[0]-i[0]),r=(a[0]-n[0])/(s[0]-a[0]),i=n[1]+(i[1]-n[1])*(isFinite(o)?o:0),s=a[1]+(s[1]-a[1])*(isFinite(r)?r:0),r=this._curve.type===te.CURVE_CATMULL?.5:this._curve.tension,this._m0=r*(a[1]-i),this._m1=r*(s-n[1])},_evaluateHermite:function(e,t,i,s,n){var a,r=n*n,o=n+n;return e*(1+o)*(a=(a=1-n)*a)+i*n*a+t*r*(3-o)+s*r*(n-1)}}),{CurveEvaluator:q})),Object.assign(te,(K=new te.Vec3,Z=new te.Vec3,Q=new te.Vec3,$=new te.Vec3,J=new te.Vec3,ee=function(e,t){this.center=e||new te.Vec3(0,0,0),this.halfExtents=t||new te.Vec3(.5,.5,.5),this._min=new te.Vec3,this._max=new te.Vec3},Object.assign(ee.prototype,{add:function(e){var t=this.center,i=t.x,s=t.y,n=t.z,a=this.halfExtents,r=i-(o=a.x),o=(i+=o,s-(h=a.y)),h=(s+=h,n-(d=a.z)),l=(n+=d,(d=e.center).x),c=d.y,d=d.z,u=(e=e.halfExtents).x,p=e.y,f=e.z;(e=l-u)<r&&(r=e),i<(l+=u)&&(i=l),(u=c-p)<o&&(o=u),s<(c+=p)&&(s=c),(p=d-f)<h&&(h=p),n<(d+=f)&&(n=d),t.x=.5*(r+i),t.y=.5*(o+s),t.z=.5*(h+n),a.x=.5*(i-r),a.y=.5*(s-o),a.z=.5*(n-h)},copy:function(e){this.center.copy(e.center),this.halfExtents.copy(e.halfExtents),this.type=e.type},clone:function(){return new te.BoundingBox(this.center.clone(),this.halfExtents.clone())},intersects:function(e){var t=this.getMax(),i=this.getMin(),s=e.getMax();return e=e.getMin(),i.x<=s.x&&t.x>=e.x&&i.y<=s.y&&t.y>=e.y&&i.z<=s.z&&t.z>=e.z},_intersectsRay:function(e,t){var i=K.copy(this.getMin()).sub(e.origin),s=Z.copy(this.getMax()).sub(e.origin),n=e.direction;return 0===n.x?(i.x=i.x<0?-Number.MAX_VALUE:Number.MAX_VALUE,s.x=s.x<0?-Number.MAX_VALUE:Number.MAX_VALUE):(i.x/=n.x,s.x/=n.x),0===n.y?(i.y=i.y<0?-Number.MAX_VALUE:Number.MAX_VALUE,s.y=s.y<0?-Number.MAX_VALUE:Number.MAX_VALUE):(i.y/=n.y,s.y/=n.y),0===n.z?(i.z=i.z<0?-Number.MAX_VALUE:Number.MAX_VALUE,s.z=s.z<0?-Number.MAX_VALUE:Number.MAX_VALUE):(i.z/=n.z,s.z/=n.z),n=Q.set(Math.min(i.x,s.x),Math.min(i.y,s.y),Math.min(i.z,s.z)),i=$.set(Math.max(i.x,s.x),Math.max(i.y,s.y),Math.max(i.z,s.z)),s=Math.max(Math.max(n.x,n.y),n.z),(i=Math.min(Math.min(i.x,i.y),i.z)>=s&&0<=s)&&t.copy(e.direction).scale(s).add(e.origin),i},_fastIntersectsRay:function(e){var t=e.direction;return K.sub2(e.origin,this.center),$.set(Math.abs(K.x),Math.abs(K.y),Math.abs(K.z)),Q.mul2(K,t),!($.x>this.halfExtents.x&&0<=Q.x||$.y>this.halfExtents.y&&0<=Q.y||$.z>this.halfExtents.z&&0<=Q.z||(J.set(Math.abs(t.x),Math.abs(t.y),Math.abs(t.z)),Z.cross(t,K),Z.set(Math.abs(Z.x),Math.abs(Z.y),Math.abs(Z.z)),Z.x>this.halfExtents.y*J.z+this.halfExtents.z*J.y||Z.y>this.halfExtents.x*J.z+this.halfExtents.z*J.x||Z.z>this.halfExtents.x*J.y+this.halfExtents.y*J.x))},intersectsRay:function(e,t){return t?this._intersectsRay(e,t):this._fastIntersectsRay(e)},setMinMax:function(e,t){this.center.add2(t,e).scale(.5),this.halfExtents.sub2(t,e).scale(.5)},getMin:function(){return this._min.copy(this.center).sub(this.halfExtents)},getMax:function(){return this._max.copy(this.center).add(this.halfExtents)},containsPoint:function(e){var t=this.getMin(),i=this.getMax();return!(e.x<t.x||e.x>i.x||e.y<t.y||e.y>i.y||e.z<t.z||e.z>i.z)},setFromTransformedAabb:function(e,t){var i=this.center,s=this.halfExtents,n=e.center,a=e.halfExtents,r=(t=t.data)[0],o=t[4],h=t[8],l=t[1],c=t[5],d=t[9],u=t[2],p=t[6],f=t[10],m=Math.abs(r),_=Math.abs(o),g=Math.abs(h),y=Math.abs(l),v=Math.abs(c),b=Math.abs(d),S=Math.abs(u),T=Math.abs(p),E=Math.abs(f);i.set(t[12]+r*n.x+o*n.y+h*n.z,t[13]+l*n.x+c*n.y+d*n.z,t[14]+u*n.x+p*n.y+f*n.z),s.set(m*a.x+_*a.y+g*a.z,y*a.x+v*a.y+b*a.z,S*a.x+T*a.y+E*a.z)},compute:function(e){for(var t=K.set(e[0],e[1],e[2]),i=Z.set(e[0],e[1],e[2]),s=e.length/3,n=1;n<s;n++){var a=e[3*n+0],r=e[3*n+1],o=e[3*n+2];a<t.x&&(t.x=a),r<t.y&&(t.y=r),o<t.z&&(t.z=o),a>i.x&&(i.x=a),r>i.y&&(i.y=r),o>i.z&&(i.z=o)}this.setMinMax(t,i)},intersectsBoundingSphere:function(e){return this._distanceToBoundingSphereSq(e)<=e.radius*e.radius},_distanceToBoundingSphereSq:function(e){for(var t=this.getMin(),i=this.getMax(),s=0,n=["x","y","z"],a=0;a<3;++a){var r=0,o=e.center[n[a]],h=t[n[a]],l=i[n[a]];o<h&&(r+=(h-=o)*h),l<o&&(r+=(h=o-l)*h),s+=r}return s}}),{BoundingBox:ee})),Object.assign(te,function(){function e(e,t){this.center=e||new te.Vec3(0,0,0),this.radius=void 0===t?.5:t}var n=new te.Vec3,a=new te.Vec3,r=new te.Vec3,o=new te.Vec3;return Object.assign(e.prototype,{containsPoint:function(e){e=n.sub2(e,this.center).lengthSq();var t=this.radius;return e<t*t},compute:function(e){var t,i=e.length/3;for(t=0;t<i;t++)n.set(e[3*t],e[3*t+1],e[3*t+2]),r.addSelf(n),0==t%100&&(r.scale(1/i),a.add(r),r.set(0,0,0));r.scale(1/i),a.add(r),this.center.copy(a);var s=0;for(t=0;t<i;t++)n.set(e[3*t],e[3*t+1],e[3*t+2]),o.sub2(n,this.center),s=Math.max(o.lengthSq(),s);this.radius=Math.sqrt(s)},intersectsRay:function(e,t){var i,s=(i=n.copy(e.origin).sub(this.center)).dot(a.copy(e.direction).normalize());return 0<(i=i.dot(i)-this.radius*this.radius)&&0<s?null:!((i=s*s-i)<0)&&(s=Math.abs(-s-Math.sqrt(i)),t&&t.copy(e.direction).scale(s).add(e.origin),!0)},intersectsBoundingSphere:function(e){return n.sub2(e.center,this.center),e=e.radius+this.radius,n.lengthSq()<=e*e}}),{BoundingSphere:e}}()),Object.assign(te,(ie=new te.Mat4,se=function(e,t){e=e||(new te.Mat4).setPerspective(90,16/9,.1,1e3),t=t||new te.Mat4,this.planes=[];for(var i=0;i<6;i++)this.planes[i]=[];this.update(e,t)},Object.assign(se.prototype,{update:function(e,t){ie.mul2(e,t);var i=ie.data;this.planes[0][0]=i[3]-i[0],this.planes[0][1]=i[7]-i[4],this.planes[0][2]=i[11]-i[8],this.planes[0][3]=i[15]-i[12];var s=Math.sqrt(this.planes[0][0]*this.planes[0][0]+this.planes[0][1]*this.planes[0][1]+this.planes[0][2]*this.planes[0][2]);this.planes[0][0]/=s,this.planes[0][1]/=s,this.planes[0][2]/=s,this.planes[0][3]/=s,this.planes[1][0]=i[3]+i[0],this.planes[1][1]=i[7]+i[4],this.planes[1][2]=i[11]+i[8],this.planes[1][3]=i[15]+i[12],s=Math.sqrt(this.planes[1][0]*this.planes[1][0]+this.planes[1][1]*this.planes[1][1]+this.planes[1][2]*this.planes[1][2]),this.planes[1][0]/=s,this.planes[1][1]/=s,this.planes[1][2]/=s,this.planes[1][3]/=s,this.planes[2][0]=i[3]+i[1],this.planes[2][1]=i[7]+i[5],this.planes[2][2]=i[11]+i[9],this.planes[2][3]=i[15]+i[13],s=Math.sqrt(this.planes[2][0]*this.planes[2][0]+this.planes[2][1]*this.planes[2][1]+this.planes[2][2]*this.planes[2][2]),this.planes[2][0]/=s,this.planes[2][1]/=s,this.planes[2][2]/=s,this.planes[2][3]/=s,this.planes[3][0]=i[3]-i[1],this.planes[3][1]=i[7]-i[5],this.planes[3][2]=i[11]-i[9],this.planes[3][3]=i[15]-i[13],s=Math.sqrt(this.planes[3][0]*this.planes[3][0]+this.planes[3][1]*this.planes[3][1]+this.planes[3][2]*this.planes[3][2]),this.planes[3][0]/=s,this.planes[3][1]/=s,this.planes[3][2]/=s,this.planes[3][3]/=s,this.planes[4][0]=i[3]-i[2],this.planes[4][1]=i[7]-i[6],this.planes[4][2]=i[11]-i[10],this.planes[4][3]=i[15]-i[14],s=Math.sqrt(this.planes[4][0]*this.planes[4][0]+this.planes[4][1]*this.planes[4][1]+this.planes[4][2]*this.planes[4][2]),this.planes[4][0]/=s,this.planes[4][1]/=s,this.planes[4][2]/=s,this.planes[4][3]/=s,this.planes[5][0]=i[3]+i[2],this.planes[5][1]=i[7]+i[6],this.planes[5][2]=i[11]+i[10],this.planes[5][3]=i[15]+i[14],s=Math.sqrt(this.planes[5][0]*this.planes[5][0]+this.planes[5][1]*this.planes[5][1]+this.planes[5][2]*this.planes[5][2]),this.planes[5][0]/=s,this.planes[5][1]/=s,this.planes[5][2]/=s,this.planes[5][3]/=s},containsPoint:function(e){for(var t=0;t<6;t++)if(this.planes[t][0]*e.x+this.planes[t][1]*e.y+this.planes[t][2]*e.z+this.planes[t][3]<=0)return!1;return!0},containsSphere:function(e){var t,i,s=0,n=e.radius;e=(i=e.center).x;var a=i.y,r=i.z,o=this.planes;for(i=0;i<6;i++){if((t=(t=o[i])[0]*e+t[1]*a+t[2]*r+t[3])<=-n)return 0;n<t&&s++}return 6===s?2:1}}),{Frustum:se})),Object.assign(te,(ne=new te.Vec3,ae=function(e,t){this.normal=t||new te.Vec3(0,0,1),this.point=e||new te.Vec3(0,0,0)},Object.assign(ae.prototype,{intersectsLine:function(e,t,i){var s,n=-this.normal.dot(this.point);return(n=0<=(s=(s=this.normal.dot(e)+n)/(s-(n=this.normal.dot(t)+n)))&&s<=1)&&i&&i.lerp(e,t,s),n},intersectsRay:function(e,t){var i=ne.sub2(this.point,e.origin),s=0<=(i=this.normal.dot(i)/this.normal.dot(e.direction));return s&&t&&t.copy(e.direction).scale(i).add(e.origin),s}}),{Plane:ae})),Object.assign(te,{Ray:function(e,t){this.origin=e||new te.Vec3(0,0,0),this.direction=t||new te.Vec3(0,0,-1)}}),Object.assign(te,(re=new te.Ray,oe=new te.Vec3,he=new te.BoundingSphere,le=new te.Mat4,ce=function(e,t){this.halfExtents=t||new te.Vec3(.5,.5,.5),e=e||le.setIdentity(),this._modelTransform=e.clone().invert(),this._worldTransform=e.clone(),this._aabb=new te.BoundingBox(new te.Vec3,this.halfExtents)},Object.assign(ce.prototype,{intersectsRay:function(e,t){if(this._modelTransform.transformPoint(e.origin,re.origin),this._modelTransform.transformVector(e.direction,re.direction),t){var i=this._aabb._intersectsRay(re,t);return le.copy(this._modelTransform).invert().transformPoint(t,t),i}return this._aabb._fastIntersectsRay(re)},containsPoint:function(e){return this._modelTransform.transformPoint(e,oe),this._aabb.containsPoint(oe)},intersectsBoundingSphere:function(e){return this._modelTransform.transformPoint(e.center,he.center),he.radius=e.radius,!!this._aabb.intersectsBoundingSphere(he)}}),Object.defineProperty(ce.prototype,"worldTransform",{get:function(){return this._worldTransform},set:function(e){this._worldTransform.copy(e),this._modelTransform.copy(e).invert()}}),{OrientedBox:ce})),de={ADDRESS_REPEAT:0,ADDRESS_CLAMP_TO_EDGE:1,ADDRESS_MIRRORED_REPEAT:2,BLENDMODE_ZERO:0,BLENDMODE_ONE:1,BLENDMODE_SRC_COLOR:2,BLENDMODE_ONE_MINUS_SRC_COLOR:3,BLENDMODE_DST_COLOR:4,BLENDMODE_ONE_MINUS_DST_COLOR:5,BLENDMODE_SRC_ALPHA:6,BLENDMODE_SRC_ALPHA_SATURATE:7,BLENDMODE_ONE_MINUS_SRC_ALPHA:8,BLENDMODE_DST_ALPHA:9,BLENDMODE_ONE_MINUS_DST_ALPHA:10,BLENDEQUATION_ADD:0,BLENDEQUATION_SUBTRACT:1,BLENDEQUATION_REVERSE_SUBTRACT:2,BLENDEQUATION_MIN:3,BLENDEQUATION_MAX:4,BUFFER_STATIC:0,BUFFER_DYNAMIC:1,BUFFER_STREAM:2,BUFFER_GPUDYNAMIC:3,CLEARFLAG_COLOR:1,CLEARFLAG_DEPTH:2,CLEARFLAG_STENCIL:4,CUBEFACE_POSX:0,CUBEFACE_NEGX:1,CUBEFACE_POSY:2,CUBEFACE_NEGY:3,CUBEFACE_POSZ:4,CUBEFACE_NEGZ:5,CULLFACE_NONE:0,CULLFACE_BACK:1,CULLFACE_FRONT:2,CULLFACE_FRONTANDBACK:3,TYPE_INT8:0,TYPE_UINT8:1,TYPE_INT16:2,TYPE_UINT16:3,TYPE_INT32:4,TYPE_UINT32:5,TYPE_FLOAT32:6,FILTER_NEAREST:0,FILTER_LINEAR:1,FILTER_NEAREST_MIPMAP_NEAREST:2,FILTER_NEAREST_MIPMAP_LINEAR:3,FILTER_LINEAR_MIPMAP_NEAREST:4,FILTER_LINEAR_MIPMAP_LINEAR:5,FUNC_NEVER:0,FUNC_LESS:1,FUNC_EQUAL:2,FUNC_LESSEQUAL:3,FUNC_GREATER:4,FUNC_NOTEQUAL:5,FUNC_GREATEREQUAL:6,FUNC_ALWAYS:7,INDEXFORMAT_UINT8:0,INDEXFORMAT_UINT16:1,INDEXFORMAT_UINT32:2,PIXELFORMAT_A8:0,PIXELFORMAT_L8:1,PIXELFORMAT_L8_A8:2,PIXELFORMAT_R5_G6_B5:3,PIXELFORMAT_R5_G5_B5_A1:4,PIXELFORMAT_R4_G4_B4_A4:5,PIXELFORMAT_R8_G8_B8:6,PIXELFORMAT_R8_G8_B8_A8:7,PIXELFORMAT_DXT1:8,PIXELFORMAT_DXT3:9,PIXELFORMAT_DXT5:10,PIXELFORMAT_RGB16F:11,PIXELFORMAT_RGBA16F:12,PIXELFORMAT_RGB32F:13,PIXELFORMAT_RGBA32F:14,PIXELFORMAT_R32F:15,PIXELFORMAT_DEPTH:16,PIXELFORMAT_DEPTHSTENCIL:17,PIXELFORMAT_111110F:18,PIXELFORMAT_SRGB:19,PIXELFORMAT_SRGBA:20,PIXELFORMAT_ETC1:21,PIXELFORMAT_ETC2_RGB:22,PIXELFORMAT_ETC2_RGBA:23,PIXELFORMAT_PVRTC_2BPP_RGB_1:24,PIXELFORMAT_PVRTC_2BPP_RGBA_1:25,PIXELFORMAT_PVRTC_4BPP_RGB_1:26,PIXELFORMAT_PVRTC_4BPP_RGBA_1:27,PRIMITIVE_POINTS:0,PRIMITIVE_LINES:1,PRIMITIVE_LINELOOP:2,PRIMITIVE_LINESTRIP:3,PRIMITIVE_TRIANGLES:4,PRIMITIVE_TRISTRIP:5,PRIMITIVE_TRIFAN:6,SEMANTIC_POSITION:"POSITION",SEMANTIC_NORMAL:"NORMAL",SEMANTIC_TANGENT:"TANGENT",SEMANTIC_BLENDWEIGHT:"BLENDWEIGHT",SEMANTIC_BLENDINDICES:"BLENDINDICES",SEMANTIC_COLOR:"COLOR",SEMANTIC_TEXCOORD0:"TEXCOORD0",SEMANTIC_TEXCOORD1:"TEXCOORD1",SEMANTIC_TEXCOORD2:"TEXCOORD2",SEMANTIC_TEXCOORD3:"TEXCOORD3",SEMANTIC_TEXCOORD4:"TEXCOORD4",SEMANTIC_TEXCOORD5:"TEXCOORD5",SEMANTIC_TEXCOORD6:"TEXCOORD6",SEMANTIC_TEXCOORD7:"TEXCOORD7",SEMANTIC_ATTR0:"ATTR0",SEMANTIC_ATTR1:"ATTR1",SEMANTIC_ATTR2:"ATTR2",SEMANTIC_ATTR3:"ATTR3",SEMANTIC_ATTR4:"ATTR4",SEMANTIC_ATTR5:"ATTR5",SEMANTIC_ATTR6:"ATTR6",SEMANTIC_ATTR7:"ATTR7",SEMANTIC_ATTR8:"ATTR8",SEMANTIC_ATTR9:"ATTR9",SEMANTIC_ATTR10:"ATTR10",SEMANTIC_ATTR11:"ATTR11",SEMANTIC_ATTR12:"ATTR12",SEMANTIC_ATTR13:"ATTR13",SEMANTIC_ATTR14:"ATTR14",SEMANTIC_ATTR15:"ATTR15",SHADERTAG_MATERIAL:1,STENCILOP_KEEP:0,STENCILOP_ZERO:1,STENCILOP_REPLACE:2,STENCILOP_INCREMENT:3,STENCILOP_INCREMENTWRAP:4,STENCILOP_DECREMENT:5,STENCILOP_DECREMENTWRAP:6,STENCILOP_INVERT:7,TEXTURELOCK_READ:1,TEXTURELOCK_WRITE:2,TEXHINT_NONE:0,TEXHINT_SHADOWMAP:1,TEXHINT_ASSET:2,TEXHINT_LIGHTMAP:3,UNIFORMTYPE_BOOL:0,UNIFORMTYPE_INT:1,UNIFORMTYPE_FLOAT:2,UNIFORMTYPE_VEC2:3,UNIFORMTYPE_VEC3:4,UNIFORMTYPE_VEC4:5,UNIFORMTYPE_IVEC2:6,UNIFORMTYPE_IVEC3:7,UNIFORMTYPE_IVEC4:8,UNIFORMTYPE_BVEC2:9,UNIFORMTYPE_BVEC3:10,UNIFORMTYPE_BVEC4:11,UNIFORMTYPE_MAT2:12,UNIFORMTYPE_MAT3:13,UNIFORMTYPE_MAT4:14,UNIFORMTYPE_TEXTURE2D:15,UNIFORMTYPE_TEXTURECUBE:16,UNIFORMTYPE_FLOATARRAY:17,UNIFORMTYPE_TEXTURE2D_SHADOW:18,UNIFORMTYPE_TEXTURECUBE_SHADOW:19,UNIFORMTYPE_TEXTURE3D:20},Object.assign(te,de),te.gfx={},Object.assign(te.gfx,de),Object.assign(te,(ue=function(e){this.name=e,this.value=null,this.versionObject=new te.VersionedObject},Object.assign(ue.prototype,{setValue:function(e){this.value=e,this.versionObject.increment()},getValue:function(){return this.value}}),{ScopeId:ue})),Object.assign(te,(pe=function(e){this.name=e,this.variables={},this.namespaces={}},Object.assign(pe.prototype,{resolve:function(e){return this.variables.hasOwnProperty(e)||(this.variables[e]=new te.ScopeId(e)),this.variables[e]},getSubSpace:function(e){return this.namespaces.hasOwnProperty(e)||(this.namespaces[e]=new te.ScopeSpace(e)),this.namespaces[e]}}),{ScopeSpace:pe})),Object.assign(te,(fe=function(){this.revision=this.globalId=0},Object.assign(fe.prototype,{equals:function(e){return this.globalId===e.globalId&&this.revision===e.revision},notequals:function(e){return this.globalId!==e.globalId||this.revision!==e.revision},copy:function(e){this.globalId=e.globalId,this.revision=e.revision},reset:function(){this.revision=this.globalId=0}}),{Version:fe})),Object.assign(te,(me=0,_e=function(){me++,this.version=new te.Version,this.version.globalId=me},Object.assign(_e.prototype,{increment:function(){this.version.revision++}}),{VersionedObject:_e})),Object.assign(te,function(){function s(e,t){switch(this.index=0,t.dataType){case te.TYPE_INT8:this.array=new Int8Array(e,t.offset);break;case te.TYPE_UINT8:this.array=new Uint8Array(e,t.offset);break;case te.TYPE_INT16:this.array=new Int16Array(e,t.offset);break;case te.TYPE_UINT16:this.array=new Uint16Array(e,t.offset);break;case te.TYPE_INT32:this.array=new Int32Array(e,t.offset);break;case te.TYPE_UINT32:this.array=new Uint32Array(e,t.offset);break;case te.TYPE_FLOAT32:this.array=new Float32Array(e,t.offset)}switch(t.numComponents){case 1:this.set=i;break;case 2:this.set=n;break;case 3:this.set=a;break;case 4:this.set=r}}function i(e){this.array[this.index]=e}function n(e,t){this.array[this.index]=e,this.array[this.index+1]=t}function a(e,t,i){this.array[this.index]=e,this.array[this.index+1]=t,this.array[this.index+2]=i}function r(e,t,i,s){this.array[this.index]=e,this.array[this.index+1]=t,this.array[this.index+2]=i,this.array[this.index+3]=s}function e(e){this.vertexBuffer=e,this.buffer=this.vertexBuffer.lock(),this.accessors=[],this.element={},e=this.vertexBuffer.getFormat();for(var t=0;t<e.elements.length;t++){var i=e.elements[t];this.accessors[t]=new s(this.buffer,i),this.element[i.name]=this.accessors[t]}}return s.prototype.get=function(e){return this.array[this.index+e]},Object.assign(e.prototype,{next:function(e){void 0===e&&(e=1);for(var t=0,i=this.accessors,s=this.accessors.length,n=this.vertexBuffer.getFormat();t<s;){var a=i[t++];a.index+=e*n.size/a.array.constructor.BYTES_PER_ELEMENT}},end:function(){this.vertexBuffer.unlock()}}),{VertexIterator:e}}()),Object.assign(te,((ge=[])[te.TYPE_INT8]=1,ge[te.TYPE_UINT8]=1,ge[te.TYPE_INT16]=2,ge[te.TYPE_UINT16]=2,ge[te.TYPE_INT32]=4,ge[te.TYPE_UINT32]=4,ge[te.TYPE_FLOAT32]=4,{VertexFormat:function(e,t){var i,s,n;for(this.elements=[],this.hasTangents=this.hasColor=this.hasUv1=this.hasUv0=!1,i=this.size=0,s=t.length;i<s;i++){var a=t[i];n={name:a.semantic,offset:0,stride:0,stream:-1,scopeId:e.scope.resolve(a.semantic),dataType:a.type,numComponents:a.components,normalize:void 0!==a.normalize&&a.normalize,size:a.components*ge[a.type]},this.elements.push(n),this.size+=4*Math.ceil(n.size/4),a.semantic===te.SEMANTIC_TEXCOORD0?this.hasUv0=!0:a.semantic===te.SEMANTIC_TEXCOORD1?this.hasUv1=!0:a.semantic===te.SEMANTIC_COLOR?this.hasColor=!0:a.semantic===te.SEMANTIC_TANGENT&&(this.hasTangents=!0)}for(i=a=0,s=this.elements.length;i<s;i++)(n=this.elements[i]).offset=a,n.stride=this.size,a+=n.size}})),Object.assign(te,(ye=function(e,t,i,s,n){this.usage=s||te.BUFFER_STATIC,this.format=t,this.numVertices=i,this.numBytes=t.size*i,e._vram.vb+=this.numBytes,this.device=e,n?this.setData(n):this.storage=new ArrayBuffer(this.numBytes),this.device.buffers.push(this)},Object.assign(ye.prototype,{destroy:function(){var e=this.device,t=e.buffers.indexOf(this);if(-1!==t&&e.buffers.splice(t,1),this.bufferId){for(var i in(t=e.gl).deleteBuffer(this.bufferId),e._vram.vb-=this.storage.byteLength,this.bufferId=null,e.boundBuffer=null,e.vertexBuffers.length=0,e.vbOffsets.length=0,e.attributesInvalidated=!0,e.enabledAttributes)t.disableVertexAttribArray(i);e.enabledAttributes={}}},getFormat:function(){return this.format},getUsage:function(){return this.usage},getNumVertices:function(){return this.numVertices},lock:function(){return this.storage},unlock:function(){var e,t=this.device.gl;switch(this.bufferId||(this.bufferId=t.createBuffer()),this.usage){case te.BUFFER_STATIC:e=t.STATIC_DRAW;break;case te.BUFFER_DYNAMIC:e=t.DYNAMIC_DRAW;break;case te.BUFFER_STREAM:e=t.STREAM_DRAW;break;case te.BUFFER_GPUDYNAMIC:e=this.device.webgl2?t.DYNAMIC_COPY:t.STATIC_DRAW}t.bindBuffer(t.ARRAY_BUFFER,this.bufferId),t.bufferData(t.ARRAY_BUFFER,this.storage,e)},setData:function(e){return e.byteLength===this.numBytes&&(this.storage=e,this.unlock(),!0)}}),{VertexBuffer:ye})),Object.assign(te,(ve=function(e,t,i,s,n){var a;this.usage=s||te.BUFFER_STATIC,this.format=t,this.numIndices=i,this.device=e,i=this.device.gl,t===te.INDEXFORMAT_UINT8?(a=1,this.glFormat=i.UNSIGNED_BYTE):t===te.INDEXFORMAT_UINT16?(a=2,this.glFormat=i.UNSIGNED_SHORT):t===te.INDEXFORMAT_UINT32&&(a=4,this.glFormat=i.UNSIGNED_INT),this.bytesPerIndex=a,this.numBytes=this.numIndices*a,n?this.setData(n):this.storage=new ArrayBuffer(this.numBytes),e._vram.ib+=this.numBytes,this.device.buffers.push(this)},Object.assign(ve.prototype,{destroy:function(){var e=this.device,t=e.buffers.indexOf(this);-1!==t&&e.buffers.splice(t,1),this.bufferId&&(this.device.gl.deleteBuffer(this.bufferId),this.device._vram.ib-=this.storage.byteLength,this.bufferId=null,this.device.indexBuffer===this&&(this.device.indexBuffer=null))},getFormat:function(){return this.format},getNumIndices:function(){return this.numIndices},lock:function(){return this.storage},unlock:function(){var e,t=this.device.gl;switch(this.bufferId||(this.bufferId=t.createBuffer()),this.usage){case te.BUFFER_STATIC:e=t.STATIC_DRAW;break;case te.BUFFER_DYNAMIC:e=t.DYNAMIC_DRAW;break;case te.BUFFER_STREAM:e=t.STREAM_DRAW;break;case te.BUFFER_GPUDYNAMIC:e=this.device.webgl2?t.DYNAMIC_COPY:t.STATIC_DRAW}t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,this.bufferId),t.bufferData(t.ELEMENT_ARRAY_BUFFER,this.storage,e)},setData:function(e){return e.byteLength===this.numBytes&&(this.storage=e,this.unlock(),!0)}}),{IndexBuffer:ve})),Object.assign(te,((be=function(e,t){t=t||te.BUFFER_GPUDYNAMIC,this.device=e.device;var i=this.device.gl;this._inputBuffer=e,t===te.BUFFER_GPUDYNAMIC&&e.usage!==t&&(i.bindBuffer(i.ARRAY_BUFFER,e.bufferId),i.bufferData(i.ARRAY_BUFFER,e.storage,i.DYNAMIC_COPY)),this._outputBuffer=new te.VertexBuffer(e.device,e.format,e.numVertices,t,e.storage)}).createShader=function(e,t,i){return te.shaderChunks.createShaderFromCode(e,t,null,i,!0)},Object.assign(be.prototype,{destroy:function(){this._outputBuffer.destroy()},process:function(e,t){void 0===t&&(t=!0);var i=this.device;i.setRenderTarget(null),i.updateBegin(),i.setVertexBuffer(this._inputBuffer,0),i.setRaster(!1),i.setTransformFeedbackBuffer(this._outputBuffer),i.setShader(e),i.draw({type:te.PRIMITIVE_POINTS,base:0,count:this._inputBuffer.numVertices,indexed:!1}),i.setTransformFeedbackBuffer(null),i.setRaster(!0),i.updateEnd(),t&&(i=this._inputBuffer.bufferId,this._inputBuffer.bufferId=this._outputBuffer.bufferId,this._outputBuffer.bufferId=i)}}),Object.defineProperty(be.prototype,"inputBuffer",{get:function(){return this._inputBuffer}}),Object.defineProperty(be.prototype,"outputBuffer",{get:function(){return this._outputBuffer}}),{TransformFeedback:be})),Object.assign(te,function(){var e=function(e,t){this.device=e,this.name=null,this._height=this._width=4,this._depth=1,this._pot=!0,this._format=te.PIXELFORMAT_R8_G8_B8_A8,this.fixCubemapSeams=this._volume=this._cubemap=this.rgbm=!1,this._flipY=!0,this._premultiplyAlpha=!1,this._mipmaps=!0,this._minFilter=te.FILTER_LINEAR_MIPMAP_LINEAR,this._magFilter=te.FILTER_LINEAR,this._anisotropy=1,this._addressW=this._addressV=this._addressU=te.ADDRESS_REPEAT,this._compareOnRead=!1,this._compareFunc=te.FUNC_LESS,void 0!==t&&(this._width=void 0!==t.width?t.width:this._width,this._height=void 0!==t.height?t.height:this._height,this._pot=te.math.powerOfTwo(this._width)&&te.math.powerOfTwo(this._height),this._format=void 0!==t.format?t.format:this._format,this.rgbm=void 0!==t.rgbm?t.rgbm:this.rgbm,this._mipmaps=void 0!==t.mipmaps?t.mipmaps:void 0!==t.autoMipmap?t.autoMipmap:this._mipmaps,this._levels=t.levels,this._cubemap=void 0!==t.cubemap?t.cubemap:this._cubemap,this.fixCubemapSeams=void 0!==t.fixCubemapSeams?t.fixCubemapSeams:this.fixCubemapSeams,this._minFilter=void 0!==t.minFilter?t.minFilter:this._minFilter,this._magFilter=void 0!==t.magFilter?t.magFilter:this._magFilter,this._anisotropy=void 0!==t.anisotropy?t.anisotropy:this._anisotropy,this._addressU=void 0!==t.addressU?t.addressU:this._addressU,this._addressV=void 0!==t.addressV?t.addressV:this._addressV,this._compareOnRead=void 0!==t.compareOnRead?t.compareOnRead:this._compareOnRead,this._compareFunc=void 0!==t._compareFunc?t._compareFunc:this._compareFunc,this._flipY=void 0!==t.flipY?t.flipY:this._flipY,this._premultiplyAlpha=void 0!==t.premultiplyAlpha?t.premultiplyAlpha:this._premultiplyAlpha,e.webgl2&&(this._depth=void 0!==t.depth?t.depth:this._depth,this._volume=void 0!==t.volume?t.volume:this._volume,this._addressW=void 0!==t.addressW?t.addressW:this._addressW)),this._compressed=this._format===te.PIXELFORMAT_DXT1||this._format===te.PIXELFORMAT_DXT3||this._format===te.PIXELFORMAT_DXT5||this._format>=te.PIXELFORMAT_ETC1,this._invalid=!1,this._lockedLevel=-1,this._levels||(this._levels=this._cubemap?[[null,null,null,null,null,null]]:[null]),this.dirtyAll(),this._gpuSize=0};Object.defineProperty(e.prototype,"minFilter",{get:function(){return this._minFilter},set:function(e){this._minFilter!==e&&(this._minFilter=e,this._parameterFlags|=1)}}),Object.defineProperty(e.prototype,"magFilter",{get:function(){return this._magFilter},set:function(e){this._magFilter!==e&&(this._magFilter=e,this._parameterFlags|=2)}}),Object.defineProperty(e.prototype,"addressU",{get:function(){return this._addressU},set:function(e){this._addressU!==e&&(this._addressU=e,this._parameterFlags|=4)}}),Object.defineProperty(e.prototype,"addressV",{get:function(){return this._addressV},set:function(e){this._addressV!==e&&(this._addressV=e,this._parameterFlags|=8)}}),Object.defineProperty(e.prototype,"addressW",{get:function(){return this._addressW},set:function(e){this.device.webgl2&&this._volume&&e!==this._addressW&&(this._addressW=e,this._parameterFlags|=16)}}),Object.defineProperty(e.prototype,"compareOnRead",{get:function(){return this._compareOnRead},set:function(e){this._compareOnRead!==e&&(this._compareOnRead=e,this._parameterFlags|=32)}}),Object.defineProperty(e.prototype,"compareFunc",{get:function(){return this._compareFunc},set:function(e){this._compareFunc!==e&&(this._compareFunc=e,this._parameterFlags|=64)}}),Object.defineProperty(e.prototype,"anisotropy",{get:function(){return this._anisotropy},set:function(e){this._anisotropy!==e&&(this._anisotropy=e,this._parameterFlags|=128)}}),Object.defineProperty(e.prototype,"autoMipmap",{get:function(){return this._mipmaps},set:function(e){this._mipmaps=e}}),Object.defineProperty(e.prototype,"mipmaps",{get:function(){return this._mipmaps},set:function(e){this._mipmaps!==e&&(this._mipmaps=e,this._minFilterDirty=!0,e&&(this._needsMipmapsUpload=!0))}}),Object.defineProperty(e.prototype,"width",{get:function(){return this._width}}),Object.defineProperty(e.prototype,"height",{get:function(){return this._height}}),Object.defineProperty(e.prototype,"depth",{get:function(){return this._depth}}),Object.defineProperty(e.prototype,"format",{get:function(){return this._format}}),Object.defineProperty(e.prototype,"cubemap",{get:function(){return this._cubemap}});var r=null;return Object.defineProperty(e.prototype,"gpuSize",{get:function(){r||((r=[])[te.PIXELFORMAT_A8]=1,r[te.PIXELFORMAT_L8]=1,r[te.PIXELFORMAT_L8_A8]=1,r[te.PIXELFORMAT_R5_G6_B5]=2,r[te.PIXELFORMAT_R5_G5_B5_A1]=2,r[te.PIXELFORMAT_R4_G4_B4_A4]=2,r[te.PIXELFORMAT_R8_G8_B8]=4,r[te.PIXELFORMAT_R8_G8_B8_A8]=4,r[te.PIXELFORMAT_RGB16F]=8,r[te.PIXELFORMAT_RGBA16F]=8,r[te.PIXELFORMAT_RGB32F]=16,r[te.PIXELFORMAT_RGBA32F]=16,r[te.PIXELFORMAT_R32F]=4,r[te.PIXELFORMAT_DEPTH]=4,r[te.PIXELFORMAT_DEPTHSTENCIL]=4,r[te.PIXELFORMAT_111110F]=4,r[te.PIXELFORMAT_SRGB]=4,r[te.PIXELFORMAT_SRGBA]=4);var e=1;!this._pot||!this._mipmaps&&this._minFilter!==te.FILTER_NEAREST_MIPMAP_NEAREST&&this._minFilter!==te.FILTER_NEAREST_MIPMAP_LINEAR&&this._minFilter!==te.FILTER_LINEAR_MIPMAP_NEAREST&&this._minFilter!==te.FILTER_LINEAR_MIPMAP_LINEAR||this._compressed&&1===this._levels.length||(e=Math.round(Math.log2(Math.max(this._width,this._height))+1));for(var t=this._width,i=this._height,s=this._depth,n=0,a=0;a<e;a++)n=this._compressed?this._format===te.PIXELFORMAT_ETC1?n+Math.floor((t+3)/4)*Math.floor((i+3)/4)*8*s:this._format===te.PIXELFORMAT_PVRTC_2BPP_RGB_1||this._format===te.PIXELFORMAT_PVRTC_2BPP_RGBA_1?n+Math.max(t,16)*Math.max(i,8)/4*s:this._format===te.PIXELFORMAT_PVRTC_4BPP_RGB_1||this._format===te.PIXELFORMAT_PVRTC_4BPP_RGBA_1?n+Math.max(t,8)*Math.max(i,8)/2*s:n+Math.floor((t+4-1)/4)*Math.floor((i+4-1)/4)*(this._format===te.PIXELFORMAT_DXT1?8:16)*s:n+t*i*s*r[this._format],t=Math.max(.5*t,1),i=Math.max(.5*i,1),s=Math.max(.5*s,1);return this._cubemap&&(n*=6),n}}),Object.defineProperty(e.prototype,"volume",{get:function(){return this._volume}}),Object.defineProperty(e.prototype,"flipY",{get:function(){return this._flipY},set:function(e){this._flipY!==e&&(this._flipY=e,this._needsUpload=!0)}}),Object.defineProperty(e.prototype,"premultiplyAlpha",{get:function(){return this._premultiplyAlpha},set:function(e){this._premultiplyAlpha!==e&&(this._premultiplyAlpha=e,this._needsUpload=!0)}}),Object.assign(e.prototype,{destroy:function(){this.device&&this.device.destroyTexture(this),this._levels=this.device=null},dirtyAll:function(){this._levelsUpdated=this._cubemap?[[!0,!0,!0,!0,!0,!0]]:[!0],this._needsUpload=!0,this._needsMipmapsUpload=this._mipmaps,this._mipmapsUploaded=!1,this._parameterFlags=255},lock:function(e){if(void 0===(e=e||{level:0,face:0,mode:te.TEXTURELOCK_WRITE}).level&&(e.level=0),void 0===e.face&&(e.face=0),void 0===e.mode&&(e.mode=te.TEXTURELOCK_WRITE),this._lockedLevel=e.level,null===this._levels[e.level])switch(this._format){case te.PIXELFORMAT_A8:case te.PIXELFORMAT_L8:this._levels[e.level]=new Uint8Array(this._width*this._height*this._depth);break;case te.PIXELFORMAT_L8_A8:this._levels[e.level]=new Uint8Array(this._width*this._height*this._depth*2);break;case te.PIXELFORMAT_R5_G6_B5:case te.PIXELFORMAT_R5_G5_B5_A1:case te.PIXELFORMAT_R4_G4_B4_A4:this._levels[e.level]=new Uint16Array(this._width*this._height*this._depth);break;case te.PIXELFORMAT_R8_G8_B8:this._levels[e.level]=new Uint8Array(this._width*this._height*this._depth*3);break;case te.PIXELFORMAT_R8_G8_B8_A8:this._levels[e.level]=new Uint8Array(this._width*this._height*this._depth*4);break;case te.PIXELFORMAT_DXT1:this._levels[e.level]=new Uint8Array(Math.floor((this._width+3)/4)*Math.floor((this._height+3)/4)*8*this._depth);break;case te.PIXELFORMAT_DXT3:case te.PIXELFORMAT_DXT5:this._levels[e.level]=new Uint8Array(Math.floor((this._width+3)/4)*Math.floor((this._height+3)/4)*16*this._depth);break;case te.PIXELFORMAT_RGB16F:this._levels[e.level]=new Uint16Array(this._width*this._height*this._depth*3);break;case te.PIXELFORMAT_RGB32F:this._levels[e.level]=new Float32Array(this._width*this._height*this._depth*3);break;case te.PIXELFORMAT_RGBA16F:this._levels[e.level]=new Uint16Array(this._width*this._height*this._depth*4);break;case te.PIXELFORMAT_RGBA32F:this._levels[e.level]=new Float32Array(this._width*this._height*this._depth*4)}return this._levels[e.level]},setSource:function(e,t){var i,s,n,a=!1;if(t=t||0,this._cubemap){if(e[0]){for(s=e[0].width||0,n=e[0].height||0,i=0;i<6;i++)if(!e[i]||e[i].width!==s||e[i].height!==n||!(e[i]instanceof HTMLImageElement||e[i]instanceof HTMLCanvasElement||e[i]instanceof HTMLVideoElement)){a=!0;break}}else a=!0;if(!a)for(i=0;i<6;i++)this._levels[t][i]!==e[i]&&(this._levelsUpdated[t][i]=!0)}else e instanceof HTMLImageElement||e instanceof HTMLCanvasElement||e instanceof HTMLVideoElement||(a=!0),a||(e!==this._levels[t]&&(this._levelsUpdated[t]=!0),s=e.width,n=e.height);if(a)if(this._height=this._width=4,this._pot=!0,this._cubemap)for(i=0;i<6;i++)this._levels[t][i]=null,this._levelsUpdated[t][i]=!0;else this._levels[t]=null,this._levelsUpdated[t]=!0;else 0===t&&(this._width=s,this._height=n),this._pot=te.math.powerOfTwo(this._width)&&te.math.powerOfTwo(this._height),this._levels[t]=e;this._invalid===a&&a||(this._invalid=a,this.upload())},getSource:function(e){return this._levels[e||0]},unlock:function(){this.upload(),this._lockedLevel=-1},upload:function(){this._needsUpload=!0,this._needsMipmapsUpload=this._mipmaps},getDds:function(){this.format,te.PIXELFORMAT_R8_G8_B8_A8;for(var e,t,i=128,s=0;this._levels[s];){if(this.cubemap)for(t=0;t<6;t++){if(!this._levels[s][t])return;if(!(e=this._levels[s][t].length))return;i+=e}else{if(!(e=this._levels[s].length))return;i+=e}i+=this._levels[s].length,s++}i=new ArrayBuffer(i),t=new Uint32Array(i,0,32),s=528391,1<this._levels.length&&(s|=131072),e=4096,1<this._levels.length&&(e|=4194304),(1<this._levels.length||this.cubemap)&&(e|=8);var n=this.cubemap?65024:0;for(t[0]=542327876,t[1]=124,t[2]=s,t[3]=this.height,t[4]=this.width,t[5]=this.width*this.height*4,t[6]=0,t[7]=this._levels.length,s=0;s<11;s++)t[8+s]=0;t[19]=32,t[20]=65,t[21]=0,t[22]=32,t[23]=16711680,t[24]=65280,t[25]=255,t[26]=4278190080,t[27]=e,t[28]=n,t[29]=0,t[30]=0,t[31]=0;var a,r;n=128;if(this.cubemap)for(t=0;t<6;t++)for(s=0;s<this._levels.length;s++){for(a=this._levels[s][t],r=new Uint8Array(i,n,a.length),e=0;e<a.length;e++)r[e]=a[e];n+=a.length}else for(s=0;s<this._levels.length;s++){for(a=this._levels[s],r=new Uint8Array(i,n,a.length),e=0;e<a.length;e++)r[e]=a[e];n+=a.length}return i}}),{Texture:e}}()),Object.assign(te,(Se={depth:!0,face:0},Te=function(e,t,i){e instanceof te.GraphicsDevice?(this._colorBuffer=t,e=i):this._colorBuffer=e.colorBuffer,this._glDepthBuffer=this._glFrameBuffer=null,e=void 0!==e?e:Se,this._depthBuffer=e.depthBuffer,this._face=void 0!==e.face?e.face:0,this._depthBuffer?(t=this._depthBuffer._format)===te.PIXELFORMAT_DEPTH?(this._depth=!0,this._stencil=!1):this._stencil=t===te.PIXELFORMAT_DEPTHSTENCIL?this._depth=!0:this._depth=!1:(this._depth=void 0===e.depth||e.depth,this._stencil=void 0!==e.stencil&&e.stencil),this._samples=void 0!==e.samples?e.samples:1,this.autoResolve=void 0===e.autoResolve||e.autoResolve,this._glMsaaDepthBuffer=this._glMsaaColorBuffer=this._glResolveFrameBuffer=null},Object.assign(Te.prototype,{destroy:function(){if(this._device){var e=this._device,t=e.targets.indexOf(this);-1!==t&&e.targets.splice(t,1),e=e.gl,this._glFrameBuffer&&(e.deleteFramebuffer(this._glFrameBuffer),this._glFrameBuffer=null),this._glDepthBuffer&&(e.deleteRenderbuffer(this._glDepthBuffer),this._glDepthBuffer=null),this._glResolveFrameBuffer&&(e.deleteFramebuffer(this._glResolveFrameBuffer),this._glResolveFrameBuffer=null),this._glMsaaColorBuffer&&(e.deleteRenderbuffer(this._glMsaaColorBuffer),this._glMsaaColorBuffer=null),this._glMsaaDepthBuffer&&(e.deleteRenderbuffer(this._glMsaaDepthBuffer),this._glMsaaDepthBuffer=null)}},resolve:function(e,t){if(this._device&&this._device.webgl2){var i=this._device.gl;void 0===e&&(e=!0),void 0===t&&this._depthBuffer&&(t=!0),i.bindFramebuffer(i.READ_FRAMEBUFFER,this._glFrameBuffer),i.bindFramebuffer(i.DRAW_FRAMEBUFFER,this._glResolveFrameBuffer),i.blitFramebuffer(0,0,this.width,this.height,0,0,this.width,this.height,(e?i.COLOR_BUFFER_BIT:0)|(t?i.DEPTH_BUFFER_BIT:0),i.NEAREST),i.bindFramebuffer(i.FRAMEBUFFER,this._glFrameBuffer)}},copy:function(e,t,i){if(!this._device){if(!e._device)return!1;this._device=e._device}return this._device.copyRenderTarget(e,this,t,i)}}),Object.defineProperty(Te.prototype,"colorBuffer",{get:function(){return this._colorBuffer}}),Object.defineProperty(Te.prototype,"depthBuffer",{get:function(){return this._depthBuffer}}),Object.defineProperty(Te.prototype,"face",{get:function(){return this._face}}),Object.defineProperty(Te.prototype,"width",{get:function(){return this._colorBuffer?this._colorBuffer.width:this._depthBuffer.width}}),Object.defineProperty(Te.prototype,"height",{get:function(){return this._colorBuffer?this._colorBuffer.height:this._depthBuffer.height}}),{RenderTarget:Te})),Object.assign(te,{ShaderInput:function(e,t,i,s){this.locationId=s,this.scopeId=e.scope.resolve(t),this.version=new te.Version,i===te.UNIFORMTYPE_FLOAT&&"[0]"===t.substr(t.length-3)&&(i=te.UNIFORMTYPE_FLOATARRAY),this.dataType=i,this.value=[null,null,null,null],this.array=[]}}),Object.assign(te,(Ee=function(e,t){this.device=e,this.definition=t,this.attributes=[],this.uniforms=[],this.samplers=[],this.ready=!1,this.device.createShader(this)},Object.assign(Ee.prototype,{destroy:function(){this.device.destroyShader(this)}}),{Shader:Ee})),Object.assign(te,((xe=function(e){this._device=e,this._cache={},this._generators={},this._precached=this._isClearingCache=!1,this._programsCollection=[],this._defaultStdMatOption={},this._defaultStdMatOptionMin={};var t=new te.StandardMaterial;t.shaderOptBuilder.updateRef(this._defaultStdMatOption,e,{},t,null,[],te.SHADER_FORWARD,null,null),t.shaderOptBuilder.updateMinRef(this._defaultStdMatOptionMin,e,{},t,null,[],te.SHADER_SHADOW,null,null)}).prototype.register=function(e,t){this.isRegistered(e)||(this._generators[e]=t)},xe.prototype.unregister=function(e){this.isRegistered(e)&&delete this._generators[e]},xe.prototype.isRegistered=function(e){return void 0!==this._generators[e]},xe.prototype.getProgram=function(e,t){var i=this._generators[e];if(void 0===i)return null;var s,n=this._device,a=i.generateKey(t),r=this._cache[a];return r||(t.lights&&(s=t.lights,t.lights=s.map(function(e){var t=e.clone?e.clone():e;return t.key=e.key,t})),this.storeNewProgram(e,t),t.lights&&(t.lights=s),this._precached,i=i.createShaderDefinition(n,t),r=this._cache[a]=new te.Shader(n,i)),r},xe.prototype.storeNewProgram=function(e,t){var i={};if("standard"===e){var s,n=this._getDefaultStdMatOptions(t.pass);for(s in t)(t.hasOwnProperty(s)&&n[s]!==t[s]||"pass"===s)&&(i[s]=t[s])}else i=t;this._programsCollection.push(JSON.stringify({name:e,options:i}))},xe.prototype.dumpPrograms=function(){var e;e="var device = pc.app ? pc.app.graphicsDevice : pc.Application.getApplication().graphicsDevice;\nvar shaders = [",this._programsCollection[0]&&(e+="\n\t"+this._programsCollection[0]);for(var t=1;t<this._programsCollection.length;++t)e+=",\n\t"+this._programsCollection[t];e=e+'\n];\ndevice.programLib.precompile(shaders);\nif (pc.version != "'+te.version+'" || pc.revision != "'+te.revision+'")\n',e+='\tconsole.warn("precompile-shaders.js: engine version mismatch, rebuild shaders lib with current engine");',(t=document.createElement("a")).setAttribute("href","data:text/plain;charset=utf-8,"+encodeURIComponent(e)),t.setAttribute("download","precompile-shaders.js"),t.style.display="none",document.body.appendChild(t),t.click(),document.body.removeChild(t)},xe.prototype.clearCache=function(){var e=this._cache;for(var t in this._isClearingCache=!0,e)e.hasOwnProperty(t)&&e[t].destroy();this._cache={},this._isClearingCache=!1},xe.prototype.removeFromCache=function(e){if(!this._isClearingCache){var t,i=this._cache;for(t in i)if(i.hasOwnProperty(t)&&i[t]===e){delete i[t];break}}},xe.prototype._getDefaultStdMatOptions=function(e){return e>te.SHADER_FORWARDHDR&&e<=te.SHADER_PICK?this._defaultStdMatOptionMin:this._defaultStdMatOption},xe.prototype.precompile=function(e){if(e)for(var t=Array(e.length),i=0;i<e.length;i++){if("standard"===e[i].name){var s,n=e[i].options,a=this._getDefaultStdMatOptions(n.pass);for(s in a)a.hasOwnProperty(s)&&void 0===n[s]&&(n[s]=a[s]);n.useTexCubeLod=this._device.useTexCubeLod}t[i]=this.getProgram(e[i].name,e[i].options)}this._precached=!0},{ProgramLibrary:xe})),Object.assign(te,function(){function u(e,t){var i=!0,s=e.createTexture();e.bindTexture(e.TEXTURE_2D,s),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,2,2,0,e.RGBA,t,null);var n=e.createFramebuffer();return e.bindFramebuffer(e.FRAMEBUFFER,n),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,s,0),e.checkFramebufferStatus(e.FRAMEBUFFER)!==e.FRAMEBUFFER_COMPLETE&&(i=!1),e.bindTexture(e.TEXTURE_2D,null),e.deleteTexture(s),e.bindFramebuffer(e.FRAMEBUFFER,null),e.deleteFramebuffer(n),i}var h=function(e,t){var i=e.width,s=e.height;if(t<i||t<s){var n=t/Math.max(i,s),a=Math.floor(i*n),r=(n=Math.floor(s*n),document.createElement("canvas"));return r.width=a,r.height=n,r.getContext("2d").drawImage(e,0,0,i,s,0,0,a,n),r}return e},e=function(e,t){var i;this.canvas=e,this.indexBuffer=this.shader=null,this.vertexBuffers=[],this.vbOffsets=[],this._enableAutoInstancing=!1,this.autoInstancingMaxObjects=16384,this.attributesInvalidated=!0,this.boundElementBuffer=this.boundBuffer=null,this.instancedAttribs={},this.enabledAttributes={},this.activeFramebuffer=this.transformFeedbackBuffer=null,this.textureUnit=0,this.textureUnits=[],this._maxPixelRatio=1,this.feedback=this.renderTarget=null,this._height=this._width=0,this.updateClientRect(),this.vertexShaderCache={},this.fragmentShaderCache={},this.shaders=[],this.buffers=[],this.textures=[],this.targets=[],this.contextLost=!1,this._contextLostHandler=function(e){e.preventDefault(),this.contextLost=!0,this.fire("devicelost")}.bind(this),this._contextRestoredHandler=function(){this.initializeContext(),this.contextLost=!1,this.fire("devicerestored")}.bind(this),e.addEventListener("webglcontextlost",this._contextLostHandler,!1),e.addEventListener("webglcontextrestored",this._contextRestoredHandler,!1);var s,n,a,r,o,h=!t||void 0===t.preferWebGl2||t.preferWebGl2,l=h?["webgl2","experimental-webgl2","webgl","experimental-webgl"]:["webgl","experimental-webgl"],c=null;for((t=t||{}).stencil=!0,i=0;i<l.length;i++){try{c=e.getContext(l[i],t)}catch(e){}if(c){this.webgl2=h&&i<2;break}}if(!c)throw Error("WebGL not supported");for(this.gl=c,this.initializeExtensions(),this.initializeCapabilities(),this.initializeRenderState(),i=0;i<this.maxCombinedTextures;i++)this.textureUnits.push([null,null,null]);for(var d in this.defaultClearOptions={color:[0,0,0,1],depth:1,stencil:0,flags:te.CLEARFLAG_COLOR|te.CLEARFLAG_DEPTH},this.glAddress=[c.REPEAT,c.CLAMP_TO_EDGE,c.MIRRORED_REPEAT],this.glBlendEquation=[c.FUNC_ADD,c.FUNC_SUBTRACT,c.FUNC_REVERSE_SUBTRACT,this.webgl2?c.MIN:this.extBlendMinmax?this.extBlendMinmax.MIN_EXT:c.FUNC_ADD,this.webgl2?c.MAX:this.extBlendMinmax?this.extBlendMinmax.MAX_EXT:c.FUNC_ADD],this.glBlendFunction=[c.ZERO,c.ONE,c.SRC_COLOR,c.ONE_MINUS_SRC_COLOR,c.DST_COLOR,c.ONE_MINUS_DST_COLOR,c.SRC_ALPHA,c.SRC_ALPHA_SATURATE,c.ONE_MINUS_SRC_ALPHA,c.DST_ALPHA,c.ONE_MINUS_DST_ALPHA],this.glComparison=[c.NEVER,c.LESS,c.EQUAL,c.LEQUAL,c.GREATER,c.NOTEQUAL,c.GEQUAL,c.ALWAYS],this.glStencilOp=[c.KEEP,c.ZERO,c.REPLACE,c.INCR,c.INCR_WRAP,c.DECR,c.DECR_WRAP,c.INVERT],this.glClearFlag=[0,c.COLOR_BUFFER_BIT,c.DEPTH_BUFFER_BIT,c.COLOR_BUFFER_BIT|c.DEPTH_BUFFER_BIT,c.STENCIL_BUFFER_BIT,c.STENCIL_BUFFER_BIT|c.COLOR_BUFFER_BIT,c.STENCIL_BUFFER_BIT|c.DEPTH_BUFFER_BIT,c.STENCIL_BUFFER_BIT|c.COLOR_BUFFER_BIT|c.DEPTH_BUFFER_BIT],this.glCull=[0,c.BACK,c.FRONT,c.FRONT_AND_BACK],this.glFilter=[c.NEAREST,c.LINEAR,c.NEAREST_MIPMAP_NEAREST,c.NEAREST_MIPMAP_LINEAR,c.LINEAR_MIPMAP_NEAREST,c.LINEAR_MIPMAP_LINEAR],this.glPrimitive=[c.POINTS,c.LINES,c.LINE_LOOP,c.LINE_STRIP,c.TRIANGLES,c.TRIANGLE_STRIP,c.TRIANGLE_FAN],this.glType=[c.BYTE,c.UNSIGNED_BYTE,c.SHORT,c.UNSIGNED_SHORT,c.INT,c.UNSIGNED_INT,c.FLOAT],this.pcUniformType={},this.pcUniformType[c.BOOL]=te.UNIFORMTYPE_BOOL,this.pcUniformType[c.INT]=te.UNIFORMTYPE_INT,this.pcUniformType[c.FLOAT]=te.UNIFORMTYPE_FLOAT,this.pcUniformType[c.FLOAT_VEC2]=te.UNIFORMTYPE_VEC2,this.pcUniformType[c.FLOAT_VEC3]=te.UNIFORMTYPE_VEC3,this.pcUniformType[c.FLOAT_VEC4]=te.UNIFORMTYPE_VEC4,this.pcUniformType[c.INT_VEC2]=te.UNIFORMTYPE_IVEC2,this.pcUniformType[c.INT_VEC3]=te.UNIFORMTYPE_IVEC3,this.pcUniformType[c.INT_VEC4]=te.UNIFORMTYPE_IVEC4,this.pcUniformType[c.BOOL_VEC2]=te.UNIFORMTYPE_BVEC2,this.pcUniformType[c.BOOL_VEC3]=te.UNIFORMTYPE_BVEC3,this.pcUniformType[c.BOOL_VEC4]=te.UNIFORMTYPE_BVEC4,this.pcUniformType[c.FLOAT_MAT2]=te.UNIFORMTYPE_MAT2,this.pcUniformType[c.FLOAT_MAT3]=te.UNIFORMTYPE_MAT3,this.pcUniformType[c.FLOAT_MAT4]=te.UNIFORMTYPE_MAT4,this.pcUniformType[c.SAMPLER_2D]=te.UNIFORMTYPE_TEXTURE2D,this.pcUniformType[c.SAMPLER_CUBE]=te.UNIFORMTYPE_TEXTURECUBE,this.webgl2&&(this.pcUniformType[c.SAMPLER_2D_SHADOW]=te.UNIFORMTYPE_TEXTURE2D_SHADOW,this.pcUniformType[c.SAMPLER_CUBE_SHADOW]=te.UNIFORMTYPE_TEXTURECUBE_SHADOW,this.pcUniformType[c.SAMPLER_3D]=te.UNIFORMTYPE_TEXTURE3D),this.targetToSlot={},this.targetToSlot[c.TEXTURE_2D]=0,this.targetToSlot[c.TEXTURE_CUBE_MAP]=1,this.targetToSlot[c.TEXTURE_3D]=2,this.commitFunction=[],this.commitFunction[te.UNIFORMTYPE_BOOL]=function(e,t){e.value!==t&&(c.uniform1i(e.locationId,t),e.value=t)},this.commitFunction[te.UNIFORMTYPE_INT]=this.commitFunction[te.UNIFORMTYPE_BOOL],this.commitFunction[te.UNIFORMTYPE_FLOAT]=function(e,t){e.value!==t&&(c.uniform1f(e.locationId,t),e.value=t)},this.commitFunction[te.UNIFORMTYPE_VEC2]=function(e,t){o=e.value,s=t[0],n=t[1],o[0]===s&&o[1]===n||(c.uniform2fv(e.locationId,t),o[0]=s,o[1]=n)},this.commitFunction[te.UNIFORMTYPE_VEC3]=function(e,t){o=e.value,s=t[0],n=t[1],a=t[2],o[0]===s&&o[1]===n&&o[2]===a||(c.uniform3fv(e.locationId,t),o[0]=s,o[1]=n,o[2]=a)},this.commitFunction[te.UNIFORMTYPE_VEC4]=function(e,t){o=e.value,s=t[0],n=t[1],a=t[2],r=t[3],o[0]===s&&o[1]===n&&o[2]===a&&o[3]===r||(c.uniform4fv(e.locationId,t),o[0]=s,o[1]=n,o[2]=a,o[3]=r)},this.commitFunction[te.UNIFORMTYPE_IVEC2]=function(e,t){o=e.value,s=t[0],n=t[1],o[0]===s&&o[1]===n||(c.uniform2iv(e.locationId,t),o[0]=s,o[1]=n)},this.commitFunction[te.UNIFORMTYPE_BVEC2]=this.commitFunction[te.UNIFORMTYPE_IVEC2],this.commitFunction[te.UNIFORMTYPE_IVEC3]=function(e,t){o=e.value,s=t[0],n=t[1],a=t[2],o[0]===s&&o[1]===n&&o[2]===a||(c.uniform3iv(e.locationId,t),o[0]=s,o[1]=n,o[2]=a)},this.commitFunction[te.UNIFORMTYPE_BVEC3]=this.commitFunction[te.UNIFORMTYPE_IVEC3],this.commitFunction[te.UNIFORMTYPE_IVEC4]=function(e,t){o=e.value,s=t[0],n=t[1],a=t[2],r=t[3],o[0]===s&&o[1]===n&&o[2]===a&&o[3]===r||(c.uniform4iv(e.locationId,t),o[0]=s,o[1]=n,o[2]=a,o[3]=r)},this.commitFunction[te.UNIFORMTYPE_BVEC4]=this.commitFunction[te.UNIFORMTYPE_IVEC4],this.commitFunction[te.UNIFORMTYPE_MAT2]=function(e,t){c.uniformMatrix2fv(e.locationId,!1,t)},this.commitFunction[te.UNIFORMTYPE_MAT3]=function(e,t){c.uniformMatrix3fv(e.locationId,!1,t)},this.commitFunction[te.UNIFORMTYPE_MAT4]=function(e,t){c.uniformMatrix4fv(e.locationId,!1,t)},this.commitFunction[te.UNIFORMTYPE_FLOATARRAY]=function(e,t){c.uniform1fv(e.locationId,t)},this.scope=new te.ScopeSpace("Device"),this.programLib=new te.ProgramLibrary(this),te.programlib)this.programLib.register(d,te.programlib[d]);for(te.events.attach(this),this.supportsBoneTextures=this.extTextureFloat&&0<this.maxVertexTextures,this.useTexCubeLod=this.extTextureLod&&this.maxTextures<16,this.boneLimit=Math.floor((this.vertexUniformsCount-16-8-1-16)/4),this.boneLimit=Math.min(this.boneLimit,128),"Mali-450 MP"===this.unmaskedRenderer&&(this.boneLimit=34),this._shaderSwitchesPerFrame=this._drawCallsPerFrame=0,this._primsPerFrame=[],i=te.PRIMITIVE_POINTS;i<=te.PRIMITIVE_TRIFAN;i++)this._primsPerFrame[i]=0;this._renderTargetCreationTime=0,this._vram={tex:0,vb:0,ib:0},this._shaderStats={vsCompiled:0,fsCompiled:0,linked:0,materialShaders:0,compileTime:0},this.constantTexSource=this.scope.resolve("source"),this.textureFloatRenderable=!!this.extTextureFloat&&(this.webgl2?!!this.extColorBufferFloat:u(c,c.FLOAT)),this.textureHalfFloatRenderable=!!this.extTextureHalfFloat&&(this.webgl2?!!this.extColorBufferFloat:u(c,this.extTextureHalfFloat.HALF_FLOAT_OES)),this._textureFloatHighPrecision=void 0,this.initializeGrabPassTexture()};return Object.assign(e.prototype,{getPrecision:function(){var e="highp";if((n=this.gl).getShaderPrecisionFormat){var t=n.getShaderPrecisionFormat(n.VERTEX_SHADER,n.HIGH_FLOAT),i=n.getShaderPrecisionFormat(n.VERTEX_SHADER,n.MEDIUM_FLOAT),s=n.getShaderPrecisionFormat(n.FRAGMENT_SHADER,n.HIGH_FLOAT),n=n.getShaderPrecisionFormat(n.FRAGMENT_SHADER,n.MEDIUM_FLOAT);i=0<i.precision&&0<n.precision;0<t.precision&&0<s.precision||(e=i?"mediump":"lowp")}return e},initializeExtensions:function(){var e,i=this.gl,s=i.getSupportedExtensions(),t=function(){for(var e=null,t=0;t<arguments.length;t++)-1!==s.indexOf(arguments[t])&&(e=i.getExtension(arguments[t]));return e};this.webgl2?(this.extVertexArrayObject=this.extUintElement=this.extTextureLod=this.extTextureHalfFloatLinear=this.extTextureHalfFloat=this.extTextureFloat=this.extStandardDerivatives=this.extInstancing=this.extDrawBuffers=this.extBlendMinmax=!0,this.extColorBufferFloat=t("EXT_color_buffer_float")):(this.extBlendMinmax=t("EXT_blend_minmax"),this.extDrawBuffers=t("EXT_draw_buffers"),(this.extInstancing=t("ANGLE_instanced_arrays"))&&(e=this.extInstancing,i.drawArraysInstanced=e.drawArraysInstancedANGLE.bind(e),i.drawElementsInstanced=e.drawElementsInstancedANGLE.bind(e),i.vertexAttribDivisor=e.vertexAttribDivisorANGLE.bind(e)),this.extStandardDerivatives=t("OES_standard_derivatives"),this.extTextureFloat=t("OES_texture_float"),this.extTextureHalfFloat=t("OES_texture_half_float"),this.extTextureHalfFloatLinear=t("OES_texture_half_float_linear"),this.extTextureLod=t("EXT_shader_texture_lod"),this.extUintElement=t("OES_element_index_uint"),(this.extVertexArrayObject=t("OES_vertex_array_object"))&&(e=this.extVertexArrayObject,i.createVertexArray=e.createVertexArrayOES.bind(e),i.deleteVertexArray=e.deleteVertexArrayOES.bind(e),i.isVertexArray=e.isVertexArrayOES.bind(e),i.bindVertexArray=e.bindVertexArrayOES.bind(e)),this.extColorBufferFloat=null),this.extDebugRendererInfo=t("WEBGL_debug_renderer_info"),this.extTextureFloatLinear=t("OES_texture_float_linear"),this.extTextureFilterAnisotropic=t("EXT_texture_filter_anisotropic","WEBKIT_EXT_texture_filter_anisotropic"),this.extCompressedTextureETC1=t("WEBGL_compressed_texture_etc1"),this.extCompressedTextureETC=t("WEBGL_compressed_texture_etc"),this.extCompressedTexturePVRTC=t("WEBGL_compressed_texture_pvrtc","WEBKIT_WEBGL_compressed_texture_pvrtc"),this.extCompressedTextureS3TC=t("WEBGL_compressed_texture_s3tc","WEBKIT_WEBGL_compressed_texture_s3tc"),this.extParallelShaderCompile=t("KHR_parallel_shader_compile")},initializeCapabilities:function(){var e,t=this.gl;this.maxPrecision=this.precision=this.getPrecision(),e=t.getContextAttributes(),this.supportsMsaa=e.antialias,this.supportsStencil=e.stencil,this.maxTextureSize=t.getParameter(t.MAX_TEXTURE_SIZE),this.maxCubeMapSize=t.getParameter(t.MAX_CUBE_MAP_TEXTURE_SIZE),this.maxRenderBufferSize=t.getParameter(t.MAX_RENDERBUFFER_SIZE),this.maxTextures=t.getParameter(t.MAX_TEXTURE_IMAGE_UNITS),this.maxCombinedTextures=t.getParameter(t.MAX_COMBINED_TEXTURE_IMAGE_UNITS),this.maxVertexTextures=t.getParameter(t.MAX_VERTEX_TEXTURE_IMAGE_UNITS),this.vertexUniformsCount=t.getParameter(t.MAX_VERTEX_UNIFORM_VECTORS),this.fragmentUniformsCount=t.getParameter(t.MAX_FRAGMENT_UNIFORM_VECTORS),this.webgl2?(this.maxDrawBuffers=t.getParameter(t.MAX_DRAW_BUFFERS),this.maxColorAttachments=t.getParameter(t.MAX_COLOR_ATTACHMENTS),this.maxVolumeSize=t.getParameter(t.MAX_3D_TEXTURE_SIZE)):(this.maxDrawBuffers=(e=this.extDrawBuffers)?t.getParameter(e.MAX_DRAW_BUFFERS_EXT):1,this.maxColorAttachments=e?t.getParameter(e.MAX_COLOR_ATTACHMENTS_EXT):1,this.maxVolumeSize=1),this.unmaskedRenderer=(e=this.extDebugRendererInfo)?t.getParameter(e.UNMASKED_RENDERER_WEBGL):"",this.unmaskedVendor=e?t.getParameter(e.UNMASKED_VENDOR_WEBGL):"",this.maxAnisotropy=(e=this.extTextureFilterAnisotropic)?t.getParameter(e.MAX_TEXTURE_MAX_ANISOTROPY_EXT):1},initializeRenderState:function(){var e=this.gl;this.blending=!1,e.disable(e.BLEND),this.blendSrc=te.BLENDMODE_ONE,this.blendDst=te.BLENDMODE_ZERO,this.blendSrcAlpha=te.BLENDMODE_ONE,this.blendDstAlpha=te.BLENDMODE_ZERO,this.separateAlphaBlend=!1,this.blendAlphaEquation=this.blendEquation=te.BLENDEQUATION_ADD,this.separateAlphaEquation=!1,e.blendFunc(e.ONE,e.ZERO),e.blendEquation(e.FUNC_ADD),this.writeAlpha=this.writeBlue=this.writeGreen=this.writeRed=!0,e.colorMask(!0,!0,!0,!0),this.cullMode=te.CULLFACE_BACK,e.enable(e.CULL_FACE),e.cullFace(e.BACK),this.depthTest=!0,e.enable(e.DEPTH_TEST),this.depthFunc=te.FUNC_LESSEQUAL,e.depthFunc(e.LEQUAL),this.depthWrite=!0,e.depthMask(!0),this.stencil=!1,e.disable(e.STENCIL_TEST),this.stencilFuncFront=this.stencilFuncBack=te.FUNC_ALWAYS,this.stencilRefFront=this.stencilRefBack=0,this.stencilMaskFront=this.stencilMaskBack=255,e.stencilFunc(e.ALWAYS,0,255),this.stencilZpassFront=this.stencilZpassBack=this.stencilZfailFront=this.stencilZfailBack=this.stencilFailFront=this.stencilFailBack=te.STENCILOP_KEEP,this.stencilWriteMaskBack=this.stencilWriteMaskFront=255,e.stencilOp(e.KEEP,e.KEEP,e.KEEP),e.stencilMask(255),this.alphaToCoverage=!1,this.raster=!0,this.webgl2&&(e.disable(e.SAMPLE_ALPHA_TO_COVERAGE),e.disable(e.RASTERIZER_DISCARD)),this.depthBiasEnabled=!1,e.disable(e.POLYGON_OFFSET_FILL),this.clearDepth=1,e.clearDepth(1),this.clearAlpha=this.clearGreen=this.clearBlue=this.clearRed=0,e.clearColor(0,0,0,0),this.clearStencil=0,e.clearStencil(0),this.sx=this.sy=this.sw=this.sh=this.vx=this.vy=this.vw=this.vh=0,this.webgl2?e.hint(e.FRAGMENT_SHADER_DERIVATIVE_HINT,e.NICEST):this.extStandardDerivatives&&e.hint(this.extStandardDerivatives.FRAGMENT_SHADER_DERIVATIVE_HINT_OES,e.NICEST),e.enable(e.SCISSOR_TEST),e.pixelStorei(e.UNPACK_COLORSPACE_CONVERSION_WEBGL,e.NONE),this.unpackFlipY=!1,e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,!1),this.unpackPremultiplyAlpha=!1,e.pixelStorei(e.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1)},initializeContext:function(){var e,t;for(this.initializeExtensions(),this.initializeCapabilities(),this.initializeRenderState(),e=0,t=this.shaders.length;e<t;e++)this.compileAndLinkShader(this.shaders[e]);for(this.shader=null,e=0,t=this.buffers.length;e<t;e++)this.buffers[e].bufferId=void 0,this.buffers[e].unlock();for(this.indexBuffer=this.boundElementBuffer=this.boundBuffer=null,this.attributesInvalidated=!0,this.enabledAttributes={},this.vertexBuffers=[],e=0,t=this.textures.length;e<t;e++){var i=this.textures[e];this.destroyTexture(i),i.dirtyAll()}for(this.textureUnit=0,e=this.textureUnits.length=0;e<this.maxCombinedTextures;e++)this.textureUnits.push([null,null,null]);for(e=0,t=this.targets.length;e<t;e++)this.targets[e]._glFrameBuffer=void 0,this.targets[e]._glDepthBuffer=void 0,this.targets[e]._glResolveFrameBuffer=void 0,this.targets[e]._glMsaaColorBuffer=void 0,this.targets[e]._glMsaaDepthBuffer=void 0;this.transformFeedbackBuffer=this.feedback=this.activeFramebuffer=this.renderTarget=null},initializeGrabPassTexture:function(){if(!this.grabPassTexture){var e=new te.Texture(this,{format:te.PIXELFORMAT_R8_G8_B8_A8,autoMipmap:!1});e.minFilter=te.FILTER_LINEAR,e.magFilter=te.FILTER_LINEAR,e.addressU=te.ADDRESS_CLAMP_TO_EDGE,e.addressV=te.ADDRESS_CLAMP_TO_EDGE,e.name="texture_grabPass",e.setSource(this.canvas);var t=this.scope.resolve(e.name);t.setValue(e),this.grabPassTextureId=t,this.grabPassTexture=e}},updateClientRect:function(){this.clientRect=this.canvas.getBoundingClientRect()},setViewport:function(e,t,i,s){this.vx===e&&this.vy===t&&this.vw===i&&this.vh===s||(this.gl.viewport(e,t,i,s),this.vx=e,this.vy=t,this.vw=i,this.vh=s)},setScissor:function(e,t,i,s){this.sx===e&&this.sy===t&&this.sw===i&&this.sh===s||(this.gl.scissor(e,t,i,s),this.sx=e,this.sy=t,this.sw=i,this.sh=s)},getProgramLibrary:function(){return this.programLib},setProgramLibrary:function(e){this.programLib=e},setFramebuffer:function(e){this.activeFramebuffer!==e&&(this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,e),this.activeFramebuffer=e)},_checkFbo:function(){var e=this.gl;switch(e.checkFramebufferStatus(e.FRAMEBUFFER)){case e.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:case e.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:case e.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:break;case e.FRAMEBUFFER_UNSUPPORTED:}},copyRenderTarget:function(e,t,i,s){var n=this.gl;if(!this.webgl2&&s)return!1;if(i)if(t){if(!e._colorBuffer||!t._colorBuffer||e._colorBuffer._format!==t._colorBuffer._format)return!1}else if(!e._colorBuffer)return!1;if(s&&(!e._depthBuffer||!t._depthBuffer||e._depthBuffer._format!==t._depthBuffer._format))return!1;if(this.webgl2&&t){var a=this.renderTarget;this.renderTarget=t,this.updateBegin(),n.bindFramebuffer(n.READ_FRAMEBUFFER,e?e._glFrameBuffer:null),n.bindFramebuffer(n.DRAW_FRAMEBUFFER,t._glFrameBuffer);var r=e?e.width:t.width;e=e?e.height:t.height,n.blitFramebuffer(0,0,r,e,0,0,r,e,(i?n.COLOR_BUFFER_BIT:0)|(s?n.DEPTH_BUFFER_BIT:0),n.NEAREST),this.renderTarget=a,n.bindFramebuffer(n.FRAMEBUFFER,a?a._glFrameBuffer:null)}else this._copyShader||(i=te.shaderChunks,this._copyShader=i.createShaderFromCode(this,i.fullscreenQuadVS,i.outputTex2DPS,"outputTex2D")),this.constantTexSource.setValue(e._colorBuffer),te.drawQuadWithShader(this,t,this._copyShader);return!0},updateBegin:function(){var e=this.gl;this.boundElementBuffer=this.boundBuffer=null;var t=this.renderTarget;if(t)if(t._glFrameBuffer)this.setFramebuffer(t._glFrameBuffer);else{t._device=this,t._glFrameBuffer=e.createFramebuffer(),this.setFramebuffer(t._glFrameBuffer);var i=t._colorBuffer;i&&(i._glTexture||(i._width=Math.min(i.width,this.maxRenderBufferSize),i._height=Math.min(i.height,this.maxRenderBufferSize),this.setTexture(i,0)),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,i._cubemap?e.TEXTURE_CUBE_MAP_POSITIVE_X+t._face:e.TEXTURE_2D,i._glTexture,0));var s=t._depthBuffer;s&&this.webgl2?(s._glTexture||(s._width=Math.min(s.width,this.maxRenderBufferSize),s._height=Math.min(s.height,this.maxRenderBufferSize),this.setTexture(s,0)),t._stencil?e.framebufferTexture2D(e.FRAMEBUFFER,e.DEPTH_STENCIL_ATTACHMENT,s._cubemap?e.TEXTURE_CUBE_MAP_POSITIVE_X+t._face:e.TEXTURE_2D,t._depthBuffer._glTexture,0):e.framebufferTexture2D(e.FRAMEBUFFER,e.DEPTH_ATTACHMENT,s._cubemap?e.TEXTURE_CUBE_MAP_POSITIVE_X+t._face:e.TEXTURE_2D,t._depthBuffer._glTexture,0)):!t._depth||1<t._samples&&this.webgl2||(t._glDepthBuffer||(t._glDepthBuffer=e.createRenderbuffer()),e.bindRenderbuffer(e.RENDERBUFFER,t._glDepthBuffer),t._stencil?(e.renderbufferStorage(e.RENDERBUFFER,e.DEPTH_STENCIL,t.width,t.height),e.framebufferRenderbuffer(e.FRAMEBUFFER,e.DEPTH_STENCIL_ATTACHMENT,e.RENDERBUFFER,t._glDepthBuffer)):(e.renderbufferStorage(e.RENDERBUFFER,e.DEPTH_COMPONENT16,t.width,t.height),e.framebufferRenderbuffer(e.FRAMEBUFFER,e.DEPTH_ATTACHMENT,e.RENDERBUFFER,t._glDepthBuffer)),e.bindRenderbuffer(e.RENDERBUFFER,null)),this.webgl2&&1<t._samples&&(t._glResolveFrameBuffer=t._glFrameBuffer,t._glFrameBuffer=e.createFramebuffer(),this.setFramebuffer(t._glFrameBuffer),i&&(t._glMsaaColorBuffer||(t._glMsaaColorBuffer=e.createRenderbuffer()),e.bindRenderbuffer(e.RENDERBUFFER,t._glMsaaColorBuffer),e.renderbufferStorageMultisample(e.RENDERBUFFER,t._samples,i._glInternalFormat,t.width,t.height),e.framebufferRenderbuffer(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.RENDERBUFFER,t._glMsaaColorBuffer)),t._depth&&(t._glMsaaDepthBuffer||(t._glMsaaDepthBuffer=e.createRenderbuffer()),e.bindRenderbuffer(e.RENDERBUFFER,t._glMsaaDepthBuffer),t._stencil?(e.renderbufferStorageMultisample(e.RENDERBUFFER,t._samples,e.DEPTH24_STENCIL8,t.width,t.height),e.framebufferRenderbuffer(e.FRAMEBUFFER,e.DEPTH_STENCIL_ATTACHMENT,e.RENDERBUFFER,t._glMsaaDepthBuffer)):(e.renderbufferStorageMultisample(e.RENDERBUFFER,t._samples,e.DEPTH_COMPONENT32F,t.width,t.height),e.framebufferRenderbuffer(e.FRAMEBUFFER,e.DEPTH_ATTACHMENT,e.RENDERBUFFER,t._glMsaaDepthBuffer)))),this.targets.push(t)}else this.setFramebuffer(null)},updateEnd:function(){var e=this.gl,t=this.renderTarget;if(t){var i=t._colorBuffer;i&&i._glTexture&&i.mipmaps&&i._pot&&(this.activeTexture(this.maxCombinedTextures-1),this.bindTexture(i),e.generateMipmap(i._glTarget)),this.webgl2&&1<t._samples&&t.autoResolve&&t.resolve()}},initializeTexture:function(e){var t,i=this.gl;switch(e._glTexture=i.createTexture(),e._glTarget=e._cubemap?i.TEXTURE_CUBE_MAP:e._volume?i.TEXTURE_3D:i.TEXTURE_2D,e._format){case te.PIXELFORMAT_A8:e._glFormat=i.ALPHA,e._glInternalFormat=i.ALPHA,e._glPixelType=i.UNSIGNED_BYTE;break;case te.PIXELFORMAT_L8:e._glFormat=i.LUMINANCE,e._glInternalFormat=i.LUMINANCE,e._glPixelType=i.UNSIGNED_BYTE;break;case te.PIXELFORMAT_L8_A8:e._glFormat=i.LUMINANCE_ALPHA,e._glInternalFormat=i.LUMINANCE_ALPHA,e._glPixelType=i.UNSIGNED_BYTE;break;case te.PIXELFORMAT_R5_G6_B5:e._glFormat=i.RGB,e._glInternalFormat=i.RGB,e._glPixelType=i.UNSIGNED_SHORT_5_6_5;break;case te.PIXELFORMAT_R5_G5_B5_A1:e._glFormat=i.RGBA,e._glInternalFormat=i.RGBA,e._glPixelType=i.UNSIGNED_SHORT_5_5_5_1;break;case te.PIXELFORMAT_R4_G4_B4_A4:e._glFormat=i.RGBA,e._glInternalFormat=i.RGBA,e._glPixelType=i.UNSIGNED_SHORT_4_4_4_4;break;case te.PIXELFORMAT_R8_G8_B8:e._glFormat=i.RGB,e._glInternalFormat=this.webgl2?i.RGB8:i.RGB,e._glPixelType=i.UNSIGNED_BYTE;break;case te.PIXELFORMAT_R8_G8_B8_A8:e._glFormat=i.RGBA,e._glInternalFormat=this.webgl2?i.RGBA8:i.RGBA,e._glPixelType=i.UNSIGNED_BYTE;break;case te.PIXELFORMAT_DXT1:t=this.extCompressedTextureS3TC,e._glFormat=i.RGB,e._glInternalFormat=t.COMPRESSED_RGB_S3TC_DXT1_EXT;break;case te.PIXELFORMAT_DXT3:t=this.extCompressedTextureS3TC,e._glFormat=i.RGBA,e._glInternalFormat=t.COMPRESSED_RGBA_S3TC_DXT3_EXT;break;case te.PIXELFORMAT_DXT5:t=this.extCompressedTextureS3TC,e._glFormat=i.RGBA,e._glInternalFormat=t.COMPRESSED_RGBA_S3TC_DXT5_EXT;break;case te.PIXELFORMAT_ETC1:t=this.extCompressedTextureETC1,e._glFormat=i.RGB,e._glInternalFormat=t.COMPRESSED_RGB_ETC1_WEBGL;break;case te.PIXELFORMAT_PVRTC_2BPP_RGB_1:t=this.extCompressedTexturePVRTC,e._glFormat=i.RGB,e._glInternalFormat=t.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;break;case te.PIXELFORMAT_PVRTC_2BPP_RGBA_1:t=this.extCompressedTexturePVRTC,e._glFormat=i.RGBA,e._glInternalFormat=t.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG;break;case te.PIXELFORMAT_PVRTC_4BPP_RGB_1:t=this.extCompressedTexturePVRTC,e._glFormat=i.RGB,e._glInternalFormat=t.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;break;case te.PIXELFORMAT_PVRTC_4BPP_RGBA_1:t=this.extCompressedTexturePVRTC,e._glFormat=i.RGBA,e._glInternalFormat=t.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;break;case te.PIXELFORMAT_ETC2_RGB:t=this.extCompressedTextureETC,e._glFormat=i.RGB,e._glInternalFormat=t.COMPRESSED_RGB8_ETC2;break;case te.PIXELFORMAT_ETC2_RGBA:t=this.extCompressedTextureETC,e._glFormat=i.RGBA,e._glInternalFormat=t.COMPRESSED_RGBA8_ETC2_EAC;break;case te.PIXELFORMAT_RGB16F:t=this.extTextureHalfFloat,e._glFormat=i.RGB,this.webgl2?(e._glInternalFormat=i.RGB16F,e._glPixelType=i.HALF_FLOAT):(e._glInternalFormat=i.RGB,e._glPixelType=t.HALF_FLOAT_OES);break;case te.PIXELFORMAT_RGBA16F:t=this.extTextureHalfFloat,e._glFormat=i.RGBA,this.webgl2?(e._glInternalFormat=i.RGBA16F,e._glPixelType=i.HALF_FLOAT):(e._glInternalFormat=i.RGBA,e._glPixelType=t.HALF_FLOAT_OES);break;case te.PIXELFORMAT_RGB32F:e._glFormat=i.RGB,e._glInternalFormat=this.webgl2?i.RGB32F:i.RGB,e._glPixelType=i.FLOAT;break;case te.PIXELFORMAT_RGBA32F:e._glFormat=i.RGBA,e._glInternalFormat=this.webgl2?i.RGBA32F:i.RGBA,e._glPixelType=i.FLOAT;break;case te.PIXELFORMAT_R32F:e._glFormat=i.RED,e._glInternalFormat=i.R32F,e._glPixelType=i.FLOAT;break;case te.PIXELFORMAT_DEPTH:this.webgl2?(e._glFormat=i.DEPTH_COMPONENT,e._glInternalFormat=i.DEPTH_COMPONENT32F,e._glPixelType=i.FLOAT):(e._glFormat=i.DEPTH_COMPONENT,e._glInternalFormat=i.DEPTH_COMPONENT,e._glPixelType=i.UNSIGNED_SHORT);break;case te.PIXELFORMAT_DEPTHSTENCIL:e._glFormat=i.DEPTH_STENCIL,e._glInternalFormat=i.DEPTH24_STENCIL8,e._glPixelType=i.UNSIGNED_INT_24_8;break;case te.PIXELFORMAT_111110F:e._glFormat=i.RGB,e._glInternalFormat=i.R11F_G11F_B10F,e._glPixelType=i.FLOAT;break;case te.PIXELFORMAT_SRGB:e._glFormat=i.RGB,e._glInternalFormat=i.SRGB8,e._glPixelType=i.UNSIGNED_BYTE;break;case te.PIXELFORMAT_SRGBA:e._glFormat=i.RGBA,e._glInternalFormat=i.SRGB8_ALPHA8,e._glPixelType=i.UNSIGNED_BYTE}this.textures.push(e)},destroyTexture:function(e){if(e._glTexture){var t=this.textures.indexOf(e);for(var i in-1!==t&&this.textures.splice(t,1),this.scope.variables)(t=this.scope.variables[i]).value===e&&(t.value=null);for(i=0;i<this.textureUnits.length;i++){t=this.textureUnits[i];for(var s=0;s<t.length;s++)t[s]===e._glTexture&&(t[s]=null)}this.gl.deleteTexture(e._glTexture),delete e._glTexture,delete e._glTarget,delete e._glFormat,delete e._glInternalFormat,delete e._glPixelType,this._vram.tex-=e._gpuSize}},setUnpackFlipY:function(e){if(this.unpackFlipY!==e){this.unpackFlipY=e;var t=this.gl;t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,e)}},setUnpackPremultiplyAlpha:function(e){if(this.unpackPremultiplyAlpha!==e){this.unpackPremultiplyAlpha=e;var t=this.gl;t.pixelStorei(t.UNPACK_PREMULTIPLY_ALPHA_WEBGL,e)}},uploadTexture:function(e){var t=this.gl;if(e._needsUpload||!(e._needsMipmapsUpload&&e._mipmapsUploaded||!e._pot)){for(var i,s,n=0,a=Math.log2(Math.max(e._width,e._height))+1;e._levels[n]||0===n;){if(e._needsUpload||0!==n){if(n&&(!e._needsMipmapsUpload||!e._mipmaps))break;var r;if(i=e._levels[n],1==n&&!e._compressed&&e._levels.length<a&&(t.generateMipmap(e._glTarget),e._mipmapsUploaded=!0),e._cubemap){if(i[0]instanceof HTMLCanvasElement||i[0]instanceof HTMLImageElement||i[0]instanceof HTMLVideoElement)for(r=0;r<6;r++)e._levelsUpdated[0][r]&&((s=i[r])instanceof HTMLImageElement&&(s.width>this.maxCubeMapSize||s.height>this.maxCubeMapSize)&&(s=h(s,this.maxCubeMapSize),0===n&&(e.width=s.width,e.height=s.height)),this.setUnpackFlipY(!1),this.setUnpackPremultiplyAlpha(e._premultiplyAlpha),t.texImage2D(t.TEXTURE_CUBE_MAP_POSITIVE_X+r,n,e._glInternalFormat,e._glFormat,e._glPixelType,s));else for(s=1/Math.pow(2,n),r=0;r<6;r++)if(e._levelsUpdated[0][r]){var o=i[r];e._compressed?t.compressedTexImage2D(t.TEXTURE_CUBE_MAP_POSITIVE_X+r,n,e._glInternalFormat,Math.max(e._width*s,1),Math.max(e._height*s,1),0,o):(this.setUnpackFlipY(!1),this.setUnpackPremultiplyAlpha(e._premultiplyAlpha),t.texImage2D(t.TEXTURE_CUBE_MAP_POSITIVE_X+r,n,e._glInternalFormat,Math.max(e._width*s,1),Math.max(e._height*s,1),0,e._glFormat,e._glPixelType,o))}}else e._volume?(s=1/Math.pow(2,n),e._compressed?t.compressedTexImage3D(t.TEXTURE_3D,n,e._glInternalFormat,Math.max(e._width*s,1),Math.max(e._height*s,1),Math.max(e._depth*s,1),0,i):(this.setUnpackFlipY(!1),this.setUnpackPremultiplyAlpha(e._premultiplyAlpha),t.texImage3D(t.TEXTURE_3D,n,e._glInternalFormat,Math.max(e._width*s,1),Math.max(e._height*s,1),Math.max(e._depth*s,1),0,e._glFormat,e._glPixelType,i))):(i instanceof HTMLCanvasElement||i instanceof HTMLImageElement||i instanceof HTMLVideoElement?(i instanceof HTMLImageElement&&(i.width>this.maxTextureSize||i.height>this.maxTextureSize)&&(i=h(i,this.maxTextureSize),0===n&&(e.width=i.width,e.height=i.height)),this.setUnpackFlipY(e._flipY),this.setUnpackPremultiplyAlpha(e._premultiplyAlpha),t.texImage2D(t.TEXTURE_2D,n,e._glInternalFormat,e._glFormat,e._glPixelType,i)):(s=1/Math.pow(2,n),e._compressed?t.compressedTexImage2D(t.TEXTURE_2D,n,e._glInternalFormat,Math.max(e._width*s,1),Math.max(e._height*s,1),0,i):(this.setUnpackFlipY(!1),this.setUnpackPremultiplyAlpha(e._premultiplyAlpha),t.texImage2D(t.TEXTURE_2D,n,e._glInternalFormat,Math.max(e._width*s,1),Math.max(e._height*s,1),0,e._glFormat,e._glPixelType,i))),e._mipmapsUploaded=0!==n)}n++}if(e._needsUpload)if(e._cubemap)for(n=0;n<6;n++)e._levelsUpdated[0][n]=!1;else e._levelsUpdated[0]=!1;!e._compressed&&e._mipmaps&&e._needsMipmapsUpload&&e._pot&&1===e._levels.length&&(t.generateMipmap(e._glTarget),e._mipmapsUploaded=!0),e._gpuSize&&(this._vram.tex-=e._gpuSize),e._gpuSize=e.gpuSize,this._vram.tex+=e._gpuSize}},activeTexture:function(e){this.textureUnit!==e&&(this.gl.activeTexture(this.gl.TEXTURE0+e),this.textureUnit=e)},bindTexture:function(e){var t=e._glTarget;e=e._glTexture;var i=this.textureUnit,s=this.targetToSlot[t];this.textureUnits[i][s]!==e&&(this.gl.bindTexture(t,e),this.textureUnits[i][s]=e)},bindTextureOnUnit:function(e,t){var i=e._glTarget,s=e._glTexture,n=this.targetToSlot[i];this.textureUnits[t][n]!==s&&(this.activeTexture(t),this.gl.bindTexture(i,s),this.textureUnits[t][n]=s)},setTextureParameters:function(e){var t=this.gl,i=e._parameterFlags,s=e._glTarget;if(1&i){var n=e._minFilter;(!e._pot||!e._mipmaps||e._compressed&&1===e._levels.length)&&(n===te.FILTER_NEAREST_MIPMAP_NEAREST||n===te.FILTER_NEAREST_MIPMAP_LINEAR?n=te.FILTER_NEAREST:n!==te.FILTER_LINEAR_MIPMAP_NEAREST&&n!==te.FILTER_LINEAR_MIPMAP_LINEAR||(n=te.FILTER_LINEAR)),t.texParameteri(s,t.TEXTURE_MIN_FILTER,this.glFilter[n])}2&i&&t.texParameteri(s,t.TEXTURE_MAG_FILTER,this.glFilter[e._magFilter]),4&i&&(this.webgl2?t.texParameteri(s,t.TEXTURE_WRAP_S,this.glAddress[e._addressU]):t.texParameteri(s,t.TEXTURE_WRAP_S,this.glAddress[e._pot?e._addressU:te.ADDRESS_CLAMP_TO_EDGE])),8&i&&(this.webgl2?t.texParameteri(s,t.TEXTURE_WRAP_T,this.glAddress[e._addressV]):t.texParameteri(s,t.TEXTURE_WRAP_T,this.glAddress[e._pot?e._addressV:te.ADDRESS_CLAMP_TO_EDGE])),16&i&&this.webgl2&&t.texParameteri(s,t.TEXTURE_WRAP_R,this.glAddress[e._addressW]),32&i&&this.webgl2&&t.texParameteri(s,t.TEXTURE_COMPARE_MODE,e._compareOnRead?t.COMPARE_REF_TO_TEXTURE:t.NONE),64&i&&this.webgl2&&t.texParameteri(s,t.TEXTURE_COMPARE_FUNC,this.glComparison[e._compareFunc]),128&i&&(i=this.extTextureFilterAnisotropic)&&t.texParameterf(s,i.TEXTURE_MAX_ANISOTROPY_EXT,Math.max(1,Math.min(Math.round(e._anisotropy),this.maxAnisotropy)))},setTexture:function(e,t){e._glTexture||this.initializeTexture(e),0<e._parameterFlags||e._needsUpload||e._needsMipmapsUpload?(this.activeTexture(t),this.bindTexture(e),e._parameterFlags&&(this.setTextureParameters(e),e._parameterFlags=0),(e._needsUpload||e._needsMipmapsUpload)&&(this.uploadTexture(e),e!==this.grabPassTexture&&(e._needsUpload=!1,e._needsMipmapsUpload=!1))):this.bindTextureOnUnit(e,t)},setBuffers:function(e){var t,i,s,n,a=this.gl,r=this.shader.attributes;if(this.attributesInvalidated){for(var o=0,h=r.length;o<h;o++)null!==(i=(t=r[o]).scopeId.value)&&(s=this.vertexBuffers[i.stream],n=this.vbOffsets[i.stream]||0,s=s.bufferId,this.boundBuffer!==s&&(a.bindBuffer(a.ARRAY_BUFFER,s),this.boundBuffer=s),t=t.locationId,this.enabledAttributes[t]||(a.enableVertexAttribArray(t),this.enabledAttributes[t]=!0),a.vertexAttribPointer(t,i.numComponents,this.glType[i.dataType],i.normalize,i.stride,i.offset+n),1===i.stream&&1<e?this.instancedAttribs[t]||(a.vertexAttribDivisor(t,1),this.instancedAttribs[t]=!0):this.instancedAttribs[t]&&(a.vertexAttribDivisor(t,0),this.instancedAttribs[t]=!1));this.attributesInvalidated=!1}s=this.indexBuffer?this.indexBuffer.bufferId:null,this.boundElementBuffer!==s&&(a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,s),this.boundElementBuffer=s)},draw:function(e,t){var i,s,n,a,r,o,h,l,c=this.gl;l=(i=this.shader).samplers;var d=i.uniforms;1<t&&(this.boundBuffer=null,this.attributesInvalidated=!0),this.setBuffers(t);var u=0;for(i=0,n=l.length;i<n;i++)if(r=(a=l[i]).scopeId.value)if(r instanceof te.Texture)o=r,this.setTexture(o,u),a.slot!==u&&(c.uniform1i(a.locationId,u),a.slot=u),u++;else{for(a.array.length=0,h=r.length,s=0;s<h;s++)o=r[s],this.setTexture(o,u),a.array[s]=u,u++;c.uniform1iv(a.locationId,a.array)}for(i=0,n=d.length;i<n;i++)s=(l=d[i]).scopeId,a=l.version,r=s.versionObject.version,(a.globalId!==r.globalId||a.revision!==r.revision)&&(a.globalId=r.globalId,a.revision=r.revision,null!==s.value&&this.commitFunction[l.dataType](l,s.value));this.webgl2&&this.transformFeedbackBuffer&&(c.bindBufferBase(c.TRANSFORM_FEEDBACK_BUFFER,0,this.transformFeedbackBuffer.bufferId),c.beginTransformFeedback(c.POINTS)),i=this.glPrimitive[e.type],n=e.count,e.indexed?(d=(l=this.indexBuffer).glFormat,l=e.base*l.bytesPerIndex,1<t?c.drawElementsInstanced(i,n,d,l,t):c.drawElements(i,n,d,l)):(d=e.base,1<t?c.drawArraysInstanced(i,d,n,t):c.drawArrays(i,d,n)),this.webgl2&&this.transformFeedbackBuffer&&(c.endTransformFeedback(),c.bindBufferBase(c.TRANSFORM_FEEDBACK_BUFFER,0,null))},clear:function(e){var t=this.defaultClearOptions,i=null==(e=e||t).flags?t.flags:e.flags;if(0!==i){var s=this.gl;if(i&te.CLEARFLAG_COLOR){var n=null==e.color?t.color:e.color;this.setClearColor(n[0],n[1],n[2],n[3])}i&te.CLEARFLAG_DEPTH&&(this.setClearDepth(null==e.depth?t.depth:e.depth),this.depthWrite||s.depthMask(!0)),i&te.CLEARFLAG_STENCIL&&this.setClearStencil(null==e.stencil?t.stencil:e.stencil),s.clear(this.glClearFlag[i]),i&te.CLEARFLAG_DEPTH&&(this.depthWrite||s.depthMask(!1))}},readPixels:function(e,t,i,s,n){var a=this.gl;a.readPixels(e,t,i,s,a.RGBA,a.UNSIGNED_BYTE,n)},setClearDepth:function(e){e!==this.clearDepth&&(this.gl.clearDepth(e),this.clearDepth=e)},setClearColor:function(e,t,i,s){e===this.clearRed&&t===this.clearGreen&&i===this.clearBlue&&s===this.clearAlpha||(this.gl.clearColor(e,t,i,s),this.clearRed=e,this.clearGreen=t,this.clearBlue=i,this.clearAlpha=s)},setClearStencil:function(e){e!==this.clearStencil&&(this.gl.clearStencil(e),this.clearStencil=e)},setRenderTarget:function(e){this.renderTarget=e},getRenderTarget:function(){return this.renderTarget},getDepthTest:function(){return this.depthTest},setDepthTest:function(e){if(this.depthTest!==e){var t=this.gl;e?t.enable(t.DEPTH_TEST):t.disable(t.DEPTH_TEST),this.depthTest=e}},setDepthFunc:function(e){this.depthFunc!==e&&(this.gl.depthFunc(this.glComparison[e]),this.depthFunc=e)},getDepthWrite:function(){return this.depthWrite},setDepthWrite:function(e){this.depthWrite!==e&&(this.gl.depthMask(e),this.depthWrite=e)},setColorWrite:function(e,t,i,s){this.writeRed===e&&this.writeGreen===t&&this.writeBlue===i&&this.writeAlpha===s||(this.gl.colorMask(e,t,i,s),this.writeRed=e,this.writeGreen=t,this.writeBlue=i,this.writeAlpha=s)},setAlphaToCoverage:function(e){this.webgl2&&this.alphaToCoverage!==e&&((this.alphaToCoverage=e)?this.gl.enable(this.gl.SAMPLE_ALPHA_TO_COVERAGE):this.gl.disable(this.gl.SAMPLE_ALPHA_TO_COVERAGE))},setTransformFeedbackBuffer:function(e){if(this.transformFeedbackBuffer!==e&&(this.transformFeedbackBuffer=e,this.webgl2)){var t=this.gl;e?(this.feedback||(this.feedback=t.createTransformFeedback()),t.bindTransformFeedback(t.TRANSFORM_FEEDBACK,this.feedback)):t.bindTransformFeedback(t.TRANSFORM_FEEDBACK,null)}},setRaster:function(e){this.raster!==e&&(this.raster=e,this.webgl2&&(e?this.gl.disable(this.gl.RASTERIZER_DISCARD):this.gl.enable(this.gl.RASTERIZER_DISCARD)))},setDepthBias:function(e){this.depthBiasEnabled!==e&&((this.depthBiasEnabled=e)?this.gl.enable(this.gl.POLYGON_OFFSET_FILL):this.gl.disable(this.gl.POLYGON_OFFSET_FILL))},setDepthBiasValues:function(e,t){this.gl.polygonOffset(t,e)},getBlending:function(){return this.blending},setBlending:function(e){if(this.blending!==e){var t=this.gl;e?t.enable(t.BLEND):t.disable(t.BLEND),this.blending=e}},setStencilTest:function(e){if(this.stencil!==e){var t=this.gl;e?t.enable(t.STENCIL_TEST):t.disable(t.STENCIL_TEST),this.stencil=e}},setStencilFunc:function(e,t,i){this.stencilFuncFront===e&&this.stencilRefFront===t&&this.stencilMaskFront===i&&this.stencilFuncBack===e&&this.stencilRefBack===t&&this.stencilMaskBack===i||(this.gl.stencilFunc(this.glComparison[e],t,i),this.stencilFuncFront=this.stencilFuncBack=e,this.stencilRefFront=this.stencilRefBack=t,this.stencilMaskFront=this.stencilMaskBack=i)},setStencilFuncFront:function(e,t,i){if(this.stencilFuncFront!==e||this.stencilRefFront!==t||this.stencilMaskFront!==i){var s=this.gl;s.stencilFuncSeparate(s.FRONT,this.glComparison[e],t,i),this.stencilFuncFront=e,this.stencilRefFront=t,this.stencilMaskFront=i}},setStencilFuncBack:function(e,t,i){if(this.stencilFuncBack!==e||this.stencilRefBack!==t||this.stencilMaskBack!==i){var s=this.gl;s.stencilFuncSeparate(s.BACK,this.glComparison[e],t,i),this.stencilFuncBack=e,this.stencilRefBack=t,this.stencilMaskBack=i}},setStencilOperation:function(e,t,i,s){this.stencilFailFront===e&&this.stencilZfailFront===t&&this.stencilZpassFront===i&&this.stencilFailBack===e&&this.stencilZfailBack===t&&this.stencilZpassBack===i||(this.gl.stencilOp(this.glStencilOp[e],this.glStencilOp[t],this.glStencilOp[i]),this.stencilFailFront=this.stencilFailBack=e,this.stencilZfailFront=this.stencilZfailBack=t,this.stencilZpassFront=this.stencilZpassBack=i),this.stencilWriteMaskFront===s&&this.stencilWriteMaskBack===s||(this.gl.stencilMask(s),this.stencilWriteMaskBack=this.stencilWriteMaskFront=s)},setStencilOperationFront:function(e,t,i,s){this.stencilFailFront===e&&this.stencilZfailFront===t&&this.stencilZpassFront===i||(this.gl.stencilOpSeparate(this.gl.FRONT,this.glStencilOp[e],this.glStencilOp[t],this.glStencilOp[i]),this.stencilFailFront=e,this.stencilZfailFront=t,this.stencilZpassFront=i),this.stencilWriteMaskFront!==s&&(this.gl.stencilMaskSeparate(this.gl.FRONT,s),this.stencilWriteMaskFront=s)},setStencilOperationBack:function(e,t,i,s){this.stencilFailBack===e&&this.stencilZfailBack===t&&this.stencilZpassBack===i||(this.gl.stencilOpSeparate(this.gl.BACK,this.glStencilOp[e],this.glStencilOp[t],this.glStencilOp[i]),this.stencilFailBack=e,this.stencilZfailBack=t,this.stencilZpassBack=i),this.stencilWriteMaskBack!==s&&(this.gl.stencilMaskSeparate(this.gl.BACK,s),this.stencilWriteMaskBack=s)},setBlendFunction:function(e,t){(this.blendSrc!==e||this.blendDst!==t||this.separateAlphaBlend)&&(this.gl.blendFunc(this.glBlendFunction[e],this.glBlendFunction[t]),this.blendSrc=e,this.blendDst=t,this.separateAlphaBlend=!1)},setBlendFunctionSeparate:function(e,t,i,s){this.blendSrc===e&&this.blendDst===t&&this.blendSrcAlpha===i&&this.blendDstAlpha===s&&this.separateAlphaBlend||(this.gl.blendFuncSeparate(this.glBlendFunction[e],this.glBlendFunction[t],this.glBlendFunction[i],this.glBlendFunction[s]),this.blendSrc=e,this.blendDst=t,this.blendSrcAlpha=i,this.blendDstAlpha=s,this.separateAlphaBlend=!0)},setBlendEquation:function(e){(this.blendEquation!==e||this.separateAlphaEquation)&&(this.gl.blendEquation(this.glBlendEquation[e]),this.blendEquation=e,this.separateAlphaEquation=!1)},setBlendEquationSeparate:function(e,t){this.blendEquation===e&&this.blendAlphaEquation===t&&this.separateAlphaEquation||(this.gl.blendEquationSeparate(this.glBlendEquation[e],this.glBlendEquation[t]),this.blendEquation=e,this.blendAlphaEquation=t,this.separateAlphaEquation=!0)},setCullMode:function(e){if(this.cullMode!==e){if(e===te.CULLFACE_NONE)this.gl.disable(this.gl.CULL_FACE);else{this.cullMode===te.CULLFACE_NONE&&this.gl.enable(this.gl.CULL_FACE);var t=this.glCull[e];this.cullFace!==t&&(this.gl.cullFace(t),this.cullFace=t)}this.cullMode=e}},getCullMode:function(){return this.cullMode},setIndexBuffer:function(e){this.indexBuffer=e},setVertexBuffer:function(e,t,i){if(this.vertexBuffers[t]!==e||this.vbOffsets[t]!==i){this.vertexBuffers[t]=e,this.vbOffsets[t]=i,i=0;for(var s=(e=e.getFormat().elements).length;i<s;){var n=e[i++];n.stream=t,n.scopeId.setValue(n)}this.attributesInvalidated=!0}},compileShaderSource:function(e,t){var i=this.gl,s=t?this.vertexShaderCache[e]:this.fragmentShaderCache[e];return s||(s=i.createShader(t?i.VERTEX_SHADER:i.FRAGMENT_SHADER),i.shaderSource(s,e),i.compileShader(s),t?this.vertexShaderCache[e]=s:this.fragmentShaderCache[e]=s),s},compileAndLinkShader:function(e){var t=this.gl,i=e.definition,s=this.compileShaderSource(i.vshader,!0),n=this.compileShaderSource(i.fshader,!1),a=t.createProgram();if(t.attachShader(a,s),t.attachShader(a,n),this.webgl2&&i.useTransformFeedback){i=i.attributes;var r,o=[];for(r in i)i.hasOwnProperty(r)&&o.push("out_"+r);t.transformFeedbackVaryings(a,o,t.INTERLEAVED_ATTRIBS)}t.linkProgram(a),e._glVertexShader=s,e._glFragmentShader=n,e._glProgram=a},createShader:function(e){this.compileAndLinkShader(e),this.shaders.push(e)},destroyShader:function(e){var t=this.shaders.indexOf(e);-1!==t&&this.shaders.splice(t,1),e._glProgram&&(this.gl.deleteProgram(e._glProgram),e._glProgram=null,this.removeShaderFromCache(e))},_addLineNumbers:function(e){for(var t=0,i=(e=e.split("\n")).length;t<i;t++)e[t]=t+1+":\t"+e[t];return e.join("\n")},postLink:function(e){var t=this.gl,i=e._glVertexShader,s=e._glFragmentShader,n=e._glProgram,a=e.definition;if(!t.getShaderParameter(i,t.COMPILE_STATUS))return!1;if(!t.getShaderParameter(s,t.COMPILE_STATUS))return!1;if(!t.getProgramParameter(n,t.LINK_STATUS))return!1;i=0;for(var r,o=t.getProgramParameter(n,t.ACTIVE_ATTRIBUTES);i<o;)s=t.getActiveAttrib(n,i++),r=t.getAttribLocation(n,s.name),a.attributes[s.name],r=new te.ShaderInput(this,a.attributes[s.name],this.pcUniformType[s.type],r),e.attributes.push(r);for(i=0,a=t.getProgramParameter(n,t.ACTIVE_UNIFORMS);i<a;)s=t.getActiveUniform(n,i++),r=t.getUniformLocation(n,s.name),r=new te.ShaderInput(this,s.name,this.pcUniformType[s.type],r),s.type===t.SAMPLER_2D||s.type===t.SAMPLER_CUBE||this.webgl2&&(s.type===t.SAMPLER_2D_SHADOW||s.type===t.SAMPLER_CUBE_SHADOW||s.type===t.SAMPLER_3D)?e.samplers.push(r):e.uniforms.push(r);return e.ready=!0},setShader:function(e){if(e!==this.shader){if(!e.ready&&!this.postLink(e))return!1;this.shader=e,this.gl.useProgram(e._glProgram),this.attributesInvalidated=!0}return!0},getHdrFormat:function(){return this.textureHalfFloatRenderable?te.PIXELFORMAT_RGB16F:this.textureFloatRenderable?te.PIXELFORMAT_RGB32F:te.PIXELFORMAT_R8_G8_B8_A8},getBoneLimit:function(){return this.boneLimit},setBoneLimit:function(e){this.boneLimit=e},resizeCanvas:function(e,t){this._width=e,this._height=t;var i=Math.min(this._maxPixelRatio,window.devicePixelRatio);e*=i,t*=i,this.canvas.width=e,this.canvas.height=t,this.fire("resizecanvas",e,t)},setResolution:function(e,t){this._width=e,this._height=t,this.canvas.width=e,this.canvas.height=t,this.fire("resizecanvas",e,t)},clearShaderCache:function(){var e,t=this.gl;for(e in this.fragmentShaderCache)t.deleteShader(this.fragmentShaderCache[e]),delete this.fragmentShaderCache[e];for(e in this.vertexShaderCache)t.deleteShader(this.vertexShaderCache[e]),delete this.vertexShaderCache[e];this.programLib.clearCache()},removeShaderFromCache:function(e){this.programLib.removeFromCache(e)},destroy:function(){var e=this.gl;this.grabPassTexture.destroy(),this.webgl2&&this.feedback&&e.deleteTransformFeedback(this.feedback),this.clearShaderCache(),this.canvas.removeEventListener("webglcontextlost",this._contextLostHandler,!1),this.canvas.removeEventListener("webglcontextrestored",this._contextRestoredHandler,!1),this.gl=this.canvas=this._contextRestoredHandler=this._contextLostHandler=null}}),Object.defineProperty(e.prototype,"width",{get:function(){return this.gl.drawingBufferWidth||this.canvas.width}}),Object.defineProperty(e.prototype,"height",{get:function(){return this.gl.drawingBufferHeight||this.canvas.height}}),Object.defineProperty(e.prototype,"fullscreen",{get:function(){return!!document.fullscreenElement},set:function(e){e?this.gl.canvas.requestFullscreen():document.exitFullscreen()}}),Object.defineProperty(e.prototype,"enableAutoInstancing",{get:function(){return this._enableAutoInstancing},set:function(e){this._enableAutoInstancing=e&&this.extInstancing}}),Object.defineProperty(e.prototype,"maxPixelRatio",{get:function(){return this._maxPixelRatio},set:function(e){this._maxPixelRatio=e,this.resizeCanvas(this._width,this._height)}}),Object.defineProperty(e.prototype,"textureFloatHighPrecision",{get:function(){if(void 0===this._textureFloatHighPrecision){var e;if(this.textureFloatRenderable){var t=(e=te.shaderChunks).createShaderFromCode(this,e.fullscreenQuadVS,e.precisionTestPS,"ptest1"),i=e.createShaderFromCode(this,e.fullscreenQuadVS,e.precisionTest2PS,"ptest2"),s={format:te.PIXELFORMAT_RGBA32F,width:1,height:1,mipmaps:!1,minFilter:te.FILTER_NEAREST,magFilter:te.FILTER_NEAREST};(e=new te.Texture(this,s)).name="testFHP";var n=new te.RenderTarget(this,e,{depth:!1});te.drawQuadWithShader(this,n,t),s.format=te.PIXELFORMAT_R8_G8_B8_A8,(t=new te.Texture(this,s)).name="testFHP",s=new te.RenderTarget(this,t,{depth:!1}),this.constantTexSource.setValue(e),te.drawQuadWithShader(this,s,i),i=this.activeFramebuffer,this.setFramebuffer(s._glFrameBuffer);var a=new Uint8Array(4);this.readPixels(0,0,1,1,a),this.setFramebuffer(i),i=a[0]/255/16777216+a[1]/255/65536+a[2]/255/256+a[3]/255,e.destroy(),n.destroy(),t.destroy(),s.destroy(),e=0===i}else e=!1;this._textureFloatHighPrecision=e}return this._textureFloatHighPrecision}}),{GraphicsDevice:e}}()),Object.assign(te,(Ae={},Me={vertex_position:te.SEMANTIC_POSITION,vertex_normal:te.SEMANTIC_NORMAL,vertex_tangent:te.SEMANTIC_TANGENT,vertex_texCoord0:te.SEMANTIC_TEXCOORD0,vertex_texCoord1:te.SEMANTIC_TEXCOORD1,vertex_texCoord2:te.SEMANTIC_TEXCOORD2,vertex_texCoord3:te.SEMANTIC_TEXCOORD3,vertex_texCoord4:te.SEMANTIC_TEXCOORD4,vertex_texCoord5:te.SEMANTIC_TEXCOORD5,vertex_texCoord6:te.SEMANTIC_TEXCOORD6,vertex_texCoord7:te.SEMANTIC_TEXCOORD7,vertex_color:te.SEMANTIC_COLOR,vertex_boneIndices:te.SEMANTIC_BLENDINDICES,vertex_boneWeights:te.SEMANTIC_BLENDWEIGHT},Ae.collectAttribs=function(e){for(var t={},i=0,s=e.indexOf("attribute");0<=s&&!(0<s&&"/"===e[s-1]);){var n=e.indexOf(";",s),a=e.lastIndexOf(" ",n);n=e.substr(a+1,n-(a+1)),void 0!==(a=Me[n])?t[n]=a:(t[n]="ATTR"+i,i++),s=e.indexOf("attribute",s+1)}return t},Ae.createShader=function(e,t,i,s){t=Ae[t],i=te.programlib.precisionCode(e)+"\n"+Ae[i];var n=this.collectAttribs(t);return e.webgl2&&(t=te.programlib.versionCode(e)+this.gles3VS+t,i=te.programlib.versionCode(e)+this.gles3PS+i),new te.Shader(e,{attributes:n,vshader:t,fshader:i,useTransformFeedback:s})},Ae.createShaderFromCode=function(e,t,i,s,n){var a=e.programLib._cache,r=a[s];return void 0!==r?r:(i=te.programlib.precisionCode(e)+"\n"+(i||te.programlib.dummyFragmentCode()),r=this.collectAttribs(t),e.webgl2&&(t=te.programlib.versionCode(e)+this.gles3VS+t,i=te.programlib.versionCode(e)+this.gles3PS+i),a[s]=new te.Shader(e,{attributes:r,vshader:t,fshader:i,useTransformFeedback:n}),a[s])},{shaderChunks:Ae})),Object.assign(te,(Ce=null,Pe={type:te.PRIMITIVE_TRISTRIP,base:0,count:4,indexed:!1},{drawQuadWithShader:function(e,t,i,s,n,a){if(null===Ce){var r=new te.VertexFormat(e,[{semantic:te.SEMANTIC_POSITION,components:2,type:te.TYPE_FLOAT32}]);Ce=new te.VertexBuffer(e,r,4),(r=new te.VertexIterator(Ce)).element[te.SEMANTIC_POSITION].set(-1,-1),r.next(),r.element[te.SEMANTIC_POSITION].set(1,-1),r.next(),r.element[te.SEMANTIC_POSITION].set(-1,1),r.next(),r.element[te.SEMANTIC_POSITION].set(1,1),r.end()}var o,h,l,c,d,u,p,f;r=e.renderTarget,e.setRenderTarget(t),e.updateBegin(),s?(o=s.x,h=s.y,l=s.z,c=s.w):(l=t?t.width:e.width,c=t?t.height:e.height,h=o=0),f=n?(d=n.x,u=n.y,p=n.z,n.w):(d=o,u=h,p=l,c),n=e.vx,s=e.vy,t=e.vw;var m=e.vh;e.setViewport(o,h,l,c),l=e.sx,o=e.sy,h=e.sw,c=e.sh,e.setScissor(d,u,p,f),d=e.getDepthTest(),u=e.getDepthWrite(),p=e.getCullMode(),f=e.writeRed;var _=e.writeGreen,g=e.writeBlue,y=e.writeAlpha;e.setDepthTest(!1),e.setDepthWrite(!1),e.setCullMode(te.CULLFACE_NONE),e.setColorWrite(!0,!0,!0,!0),a||e.setBlending(!1),e.setVertexBuffer(Ce,0),e.setShader(i),e.draw(Pe),e.setDepthTest(d),e.setDepthWrite(u),e.setCullMode(p),e.setColorWrite(f,_,g,y),e.updateEnd(),e.setRenderTarget(r),e.updateBegin(),e.setViewport(n,s,t,m),e.setScissor(l,o,h,c)},destroyPostEffectQuad:function(){Ce&&(Ce.destroy(),Ce=null)}})),Object.assign(te,function(){function T(e,t,i){var s=t._colorBuffer;if(s.format==te.PIXELFORMAT_R8_G8_B8_A8){var n=new Uint8Array(s.width*s.height*4),a=e.gl;e.setFramebuffer(t._glFrameBuffer),a.readPixels(0,0,s.width,s.height,a.RGBA,a.UNSIGNED_BYTE,n),s._levels||(s._levels=[]),s._levels[0]||(s._levels[0]=[]),s._levels[0][i]=n}}function E(e,t){return Math.atan2(e*t,Math.sqrt(e*e+t*t+1))}return{prefilterCubemap:function(e){var t=e.device,i=e.sourceCubemap,s=e.method,n=e.samples,a=e.cpuSync;if(a&&!i._levels[0]);else{var r,o,h,l,c=te.shaderChunks,d=i.rgbm,u=(n=c.createShaderFromCode(t,c.fullscreenQuadVS,c.rgbmPS+c.prefilterCubemapPS.replace(/\$METHOD/g,0===s?"cos":"phong").replace(/\$NUMSAMPLES/g,n).replace(/\$textureCube/g,d?"textureCubeRGBM":"textureCube"),"prefilter"+s+n+d),c.createShaderFromCode(t,c.fullscreenQuadVS,c.outputCubemapPS,"outputCubemap")),p=t.scope.resolve("source"),f=t.scope.resolve("params"),m=new te.Vec4,_=i.width,g=(c=i.format,[[],e.filteredFixed,e.filteredRgbm,e.filteredFixedRgbm]),y=0===s?[.9,.85,.7,.4,.25,.15,.1]:[512,128,32,8,2,1,1],v=[64,32,16,8,4,2,1];if(o=c===te.PIXELFORMAT_R8_G8_B8,r=!1,a&&(r=i._levels[0][0]instanceof HTMLImageElement),(o||r)&&a){for(c=te.PIXELFORMAT_R8_G8_B8_A8,(l=new te.Texture(t,{cubemap:!0,rgbm:d,format:c,width:_,height:_,mipmaps:!1})).name="prefiltered-cube",h=0;h<6;h++)r=new te.RenderTarget(t,l,{face:h,depth:!1}),m.x=h,m.y=0,p.setValue(i),f.setValue(m.data),te.drawQuadWithShader(t,r,u),T(t,r,h);i=l}if(128<_){var b=Math.round(Math.log2(_))-Math.round(Math.log2(128));for(o=0;o<b;o++){_=.5*i.width;var S=0===s?1:Math.pow(2,Math.round(Math.log2(y[0])+2*(b-o)));for((l=new te.Texture(t,{cubemap:!0,rgbm:d,format:c,width:_,height:_,mipmaps:!1})).name="prefiltered-cube",h=0;h<6;h++)r=new te.RenderTarget(t,l,{face:h,depth:!1}),m.x=h,m.y=S,m.z=_,m.w=d?3:0,p.setValue(i),f.setValue(m.data),te.drawQuadWithShader(t,r,u),o===b-1&&a&&T(t,r,h);i=l}}if(e.sourceCubemap=i,l=null,!d&&e.filteredFixedRgbm)for((l=new te.Texture(t,{cubemap:!0,rgbm:!0,format:te.PIXELFORMAT_R8_G8_B8_A8,width:_,height:_,mipmaps:!1})).name="prefiltered-cube",h=0;h<6;h++)r=new te.RenderTarget(t,l,{face:h,depth:!1}),m.x=h,m.w=2,p.setValue(i),f.setValue(m.data),te.drawQuadWithShader(t,r,u),T(t,r,h);for(_=0===s?1:2048,g[r=0===s?0:-1]=[],o=0;o<7;o++)for(u=r;u<g.length;u++)null!=g[u]&&(g[u][o]=new te.Texture(t,{cubemap:!0,rgbm:!(u<2)||d,format:u<2?c:te.PIXELFORMAT_R8_G8_B8_A8,fixCubemapSeams:1===u||3===u,width:v[o],height:v[o],mipmaps:!1}),g[u][o].name="prefiltered-cube");for(u=r;u<g.length;u++)if(null!=g[u])if(1<u&&d)g[u]=g[u-2];else for(o=0;o<7;o++)for(h=0;h<6;h++)r=new te.RenderTarget(t,g[u][o],{face:h,depth:!1}),m.x=h,m.y=u<0?_:y[o],m.z=v[o],m.w=d?3:u,p.setValue(0===o?i:0===s?g[0][o-1]:g[-1][o-1]),f.setValue(m.data),te.drawQuadWithShader(t,r,n),a&&T(t,r,h);if(e.filtered=g[0],a&&e.singleFilteredFixed){for(i=[i].concat(e.filteredFixed),(d=new te.Texture(t,{cubemap:!0,rgbm:d,fixCubemapSeams:!0,format:c,width:128,height:128,addressU:te.ADDRESS_CLAMP_TO_EDGE,addressV:te.ADDRESS_CLAMP_TO_EDGE})).name="prefiltered-cube",o=0;o<i.length;o++)d._levels[o]=i[o]._levels[0];d.upload(),d._prefilteredMips=!0,e.singleFilteredFixed=d}if(a&&e.singleFilteredFixedRgbm&&e.filteredFixedRgbm){for(i=[l].concat(e.filteredFixedRgbm),(d=new te.Texture(t,{cubemap:!0,rgbm:!0,fixCubemapSeams:!0,format:te.PIXELFORMAT_R8_G8_B8_A8,width:128,height:128,addressU:te.ADDRESS_CLAMP_TO_EDGE,addressV:te.ADDRESS_CLAMP_TO_EDGE})).name="prefiltered-cube",o=0;o<i.length;o++)d._levels[o]=i[o]._levels[0];d.upload(),d._prefilteredMips=!0,e.singleFilteredFixedRgbm=d}}},shFromCubemap:function(e,t){var i,s,n,a=e.width;if(e.format!=te.PIXELFORMAT_R8_G8_B8_A8);else if(e._levels[0]){if(!e._levels[0][0].length){if(!(e._levels[0][0]instanceof HTMLImageElement))return;n=(s=te.Application.getApplication().graphicsDevice).gl;var r=(i=te.shaderChunks).createShaderFromCode(s,i.fullscreenQuadVS,i.fullscreenQuadPS,"fsQuadSimple"),o=s.scope.resolve("source");for(i=0;i<6;i++){var h=e._levels[0][i],l=new te.Texture(s,{cubemap:!1,rgbm:!1,format:e.format,width:a,height:a,mipmaps:!1});l.name="prefiltered-cube",l._levels[0]=h,l.upload(),(h=new te.Texture(s,{cubemap:!1,rgbm:!1,format:e.format,width:a,height:a,mipmaps:!1})).name="prefiltered-cube",h=new te.RenderTarget(s,h,{depth:!1}),o.setValue(l),te.drawQuadWithShader(s,h,r);var c=new Uint8Array(a*a*4);n.bindFramebuffer(n.FRAMEBUFFER,h._glFrameBuffer),n.readPixels(0,0,l.width,l.height,n.RGBA,n.UNSIGNED_BYTE,c),e._levels[0][i]=c}}for(r=[],n=0;n<a;n++)for(s=0;s<a;s++)r[n*a+s]=new te.Vec3(s/(a-1)*2-1,n/(a-1)*2-1,1).normalize();var d,u,p,f,m,_,g,y,v,b,S;o=new Float32Array(27);for(i=h=0;i<6;i++)for(n=0;n<a;n++)for(s=0;s<a;s++)for(l=n*a+s,v=(u=(2*((c=s)+.5)/(y=a)-1)*(1-1/y))-(d=1/y),b=(S=(2*((g=n)+.5)/y-1)*(1-1/y))-d,u+=d,S+=d,v=E(v,b)-E(v,S)-E(u,b)+E(u,S),0===c&&0===g||c===y-1&&0===g||0===c&&g===y-1||c===y-1&&g===y-1?v/=3:0!==c&&0!==g&&c!==y-1&&g!==y-1||(v*=.5),g=4*(c=v)/17,y=8*c/17,v=15*c/17,b=5*c/68,S=15*c/68,d=r[l],0==i?(f=d.z,m=-d.y,_=-d.x):1==i?(f=-d.z,m=-d.y,_=d.x):2==i?(f=d.x,m=d.z,_=d.y):3==i?(f=d.x,m=-d.z,_=-d.y):4==i?(f=d.x,m=-d.y,_=d.z):5==i&&(f=-d.x,m=-d.y,_=-d.z),t||(f=-f),u=e._levels[0][i][4*l+3]/255,d=0;d<3;d++)p=e._levels[0][i][4*l+d]/255,e.rgbm?(p*=8*u,p*=p):p=Math.pow(p,2.2),o[0+d]+=p*g,o[3+d]+=p*y*f,o[6+d]+=p*y*m,o[9+d]+=p*y*_,o[12+d]+=p*v*f*_,o[15+d]+=p*v*_*m,o[18+d]+=p*v*m*f,o[21+d]+=p*b*(3*_*_-1),o[24+d]+=p*S*(f*f-m*m),h+=c;for(d=0;d<o.length;d++)o[d]*=4*Math.PI/h;return o}}}}()),Object.assign(te,{paraboloidFromCubemap:function(e,t,i,s){var n=(n=te.shaderChunks).createShaderFromCode(e,n.fullscreenQuadVS,(t.fixCubemapSeams?n.fixCubemapSeamsStretchPS:n.fixCubemapSeamsNonePS)+n.genParaboloidPS,"genParaboloid"),a=e.scope.resolve("source"),r=e.scope.resolve("params"),o=new te.Vec4,h=t.width,l=t.rgbm,c=t.format;return h=2*Math.max(h,8),(h=new te.Texture(e,{rgbm:l,format:c,width:2*h,height:h,mipmaps:!1})).name="paraboloid",l=new te.RenderTarget(e,h,{depth:!1}),o.x=i,o.y=s?-1:1,a.setValue(t),r.setValue(o.data),te.drawQuadWithShader(e,l,n),h},generateDpAtlas:function(e,t,i){var s,n;n=new te.Vec4;var a=new te.Vec4,r=4*t[0].width,o=(o=te.shaderChunks).createShaderFromCode(e,o.fullscreenQuadVS,o.dpAtlasQuadPS,"dpAtlasQuad"),h=e.scope.resolve("source"),l=e.scope.resolve("params"),c=new te.Texture(e,{rgbm:t[0].rgbm,format:t[0].format,width:r,height:r,mipmaps:!1});c.name="paraboloid";for(var d=new te.RenderTarget(e,c,{depth:!1}),u=(2+r)/r-1,p=0;p<6;p++){s=te.paraboloidFromCubemap(e,t[p],p,i),h.setValue(s);var f=p;(s=n).x=.5*te.math.clamp(f-2,0,1),f-=6*s.x;var m=1-s.x;s.y=Math.min(.5*f,.75)*m+s.x,s.z=(1-.5*te.math.clamp(f,0,1))*m,s.w=.5*s.z,s=1/s.z,a.x=s*u,a.y=2*a.x,a.x+=1,a.y+=1,l.setValue(a.data),n.x*=r,n.y*=r,n.z*=r,n.w*=r,te.drawQuadWithShader(e,d,o,n)}return c}}),te.shaderChunks.TBNPS="void getTBN() {\n    dTBN = mat3(normalize(dTangentW), normalize(dBinormalW), normalize(dVertexNormalW));\n}\n",te.shaderChunks.TBNderivativePS="// http://www.thetenthplanet.de/archives/1180\nvoid getTBN() {\n    vec2 uv = $UV;\n    // get edge vectors of the pixel triangle\n    vec3 dp1 = dFdx( vPositionW );\n    vec3 dp2 = dFdy( vPositionW );\n    vec2 duv1 = dFdx( uv );\n    vec2 duv2 = dFdy( uv );\n    // solve the linear system\n    vec3 dp2perp = cross( dp2, dVertexNormalW );\n    vec3 dp1perp = cross( dVertexNormalW, dp1 );\n    vec3 T = dp2perp * duv1.x + dp1perp * duv2.x;\n    vec3 B = dp2perp * duv1.y + dp1perp * duv2.y;\n    // construct a scale-invariant frame\n    float invmax = 1.0 / sqrt( max( dot(T,T), dot(B,B) ) );\n    dTBN = mat3( T * invmax, B * invmax, dVertexNormalW );\n}\n",te.shaderChunks.TBNfastPS="void getTBN() {\n    dTBN = mat3(dTangentW, dBinormalW, dVertexNormalW);\n}\n",te.shaderChunks.alphaTestPS="uniform float alpha_ref;\nvoid alphaTest(float a) {\n    if (a < alpha_ref) discard;\n}\n",te.shaderChunks.ambientConstantPS="\nvoid addAmbient() {\n    dDiffuseLight += light_globalAmbient;\n}\n",te.shaderChunks.ambientPrefilteredCubePS="#ifndef PMREM4\n#define PMREM4\nuniform samplerCube texture_prefilteredCubeMap4;\n#endif\nvoid addAmbient() {\n    vec3 fixedReflDir = fixSeamsStatic(dNormalW, 1.0 - 1.0 / 4.0);\n    fixedReflDir.x *= -1.0;\n    dDiffuseLight += processEnvironment($DECODE(textureCube(texture_prefilteredCubeMap4, fixedReflDir)).rgb);\n}\n",te.shaderChunks.ambientPrefilteredCubeLodPS="#ifndef PMREM4\n#define PMREM4\n#extension GL_EXT_shader_texture_lod : enable\nuniform samplerCube texture_prefilteredCubeMap128;\n#endif\nvoid addAmbient() {\n    vec3 fixedReflDir = fixSeamsStatic(dNormalW, 1.0 - 1.0 / 4.0);\n    fixedReflDir.x *= -1.0;\n    dDiffuseLight += processEnvironment($DECODE( textureCubeLodEXT(texture_prefilteredCubeMap128, fixedReflDir, 5.0) ).rgb);\n}\n",te.shaderChunks.ambientSHPS="uniform vec3 ambientSH[9];\nvoid addAmbient() {\n    vec3 n = dNormalW;\n    vec3 color =\n                        ambientSH[0] +\n                        ambientSH[1] * n.x +\n                        ambientSH[2] * n.y +\n                        ambientSH[3] * n.z +\n                        ambientSH[4] * n.x * n.z +\n                        ambientSH[5] * n.z * n.y +\n                        ambientSH[6] * n.y * n.x +\n                        ambientSH[7] * (3.0 * n.z * n.z - 1.0) +\n                        ambientSH[8] * (n.x * n.x - n.y * n.y);\n    dDiffuseLight += processEnvironment(max(color, vec3(0.0)));\n}\n",te.shaderChunks.aoPS="#ifdef MAPTEXTURE\nuniform sampler2D texture_aoMap;\n#endif\nvoid applyAO() {\n    dAo = 1.0;\n    #ifdef MAPTEXTURE\n        dAo *= texture2D(texture_aoMap, $UV).$CH;\n    #endif\n    #ifdef MAPVERTEX\n        dAo *= saturate(vVertexColor.$VC);\n    #endif\n    dDiffuseLight *= dAo;\n}\n",te.shaderChunks.aoSpecOccPS="uniform float material_occludeSpecularIntensity;\nvoid occludeSpecular() {\n    // approximated specular occlusion from AO\n    float specPow = exp2(dGlossiness * 11.0);\n    // http://research.tri-ace.com/Data/cedec2011_RealtimePBR_Implementation_e.pptx\n    float specOcc = saturate(pow(dot(dNormalW, dViewDirW) + dAo, 0.01*specPow) - 1.0 + dAo);\n    specOcc = mix(1.0, specOcc, material_occludeSpecularIntensity);\n    dSpecularLight *= specOcc;\n    dReflection *= specOcc;\n}\n",te.shaderChunks.aoSpecOccConstPS="void occludeSpecular() {\n    // approximated specular occlusion from AO\n    float specPow = exp2(dGlossiness * 11.0);\n    // http://research.tri-ace.com/Data/cedec2011_RealtimePBR_Implementation_e.pptx\n    float specOcc = saturate(pow(dot(dNormalW, dViewDirW) + dAo, 0.01*specPow) - 1.0 + dAo);\n    dSpecularLight *= specOcc;\n    dReflection *= specOcc;\n}\n",te.shaderChunks.aoSpecOccConstSimplePS="void occludeSpecular() {\n    float specOcc = dAo;\n    dSpecularLight *= specOcc;\n    dReflection *= specOcc;\n}\n",te.shaderChunks.aoSpecOccSimplePS="uniform float material_occludeSpecularIntensity;\nvoid occludeSpecular() {\n    float specOcc = mix(1.0, dAo, material_occludeSpecularIntensity);\n    dSpecularLight *= specOcc;\n    dReflection *= specOcc;\n}\n",te.shaderChunks.bakeDirLmEndPS="\n    vec4 dirLm = texture2D(texture_dirLightMap, vUv1);\n    if (bakeDir > 0.5) {\n        if (dAtten > 0.00001) {\n            dirLm.xyz = dirLm.xyz * 2.0 - vec3(1.0);\n            dAtten = saturate(dAtten);\n            gl_FragColor.rgb = normalize(dLightDirNormW.xyz*dAtten + dirLm.xyz*dirLm.w) * 0.5 + vec3(0.5);\n            gl_FragColor.a = dirLm.w + dAtten;\n            gl_FragColor.a = max(gl_FragColor.a, 1.0 / 255.0);\n        } else {\n            gl_FragColor = dirLm;\n        }\n    } else {\n        gl_FragColor.rgb = dirLm.xyz;\n        gl_FragColor.a = max(dirLm.w, dAtten > 0.00001? (1.0/255.0) : 0.0);\n    }\n",te.shaderChunks.bakeLmEndPS="\ngl_FragColor.rgb = dDiffuseLight;\ngl_FragColor.rgb = pow(gl_FragColor.rgb, vec3(0.5));\ngl_FragColor.rgb /= 8.0;\ngl_FragColor.a = clamp( max( max( gl_FragColor.r, gl_FragColor.g ), max( gl_FragColor.b, 1.0 / 255.0 ) ), 0.0,1.0 );\ngl_FragColor.a = ceil(gl_FragColor.a * 255.0) / 255.0;\ngl_FragColor.rgb /= gl_FragColor.a;\n",te.shaderChunks.basePS="\nuniform vec3 view_position;\nuniform vec3 light_globalAmbient;\nfloat square(float x) {\n    return x*x;\n}\nfloat saturate(float x) {\n    return clamp(x, 0.0, 1.0);\n}\nvec3 saturate(vec3 x) {\n    return clamp(x, vec3(0.0), vec3(1.0));\n}\n",te.shaderChunks.baseVS="\nattribute vec3 vertex_position;\nattribute vec3 vertex_normal;\nattribute vec4 vertex_tangent;\nattribute vec2 vertex_texCoord0;\nattribute vec2 vertex_texCoord1;\nattribute vec4 vertex_color;\nuniform mat4 matrix_viewProjection;\nuniform mat4 matrix_model;\nuniform mat3 matrix_normal;\nvec3 dPositionW;\nmat4 dModelMatrix;\nmat3 dNormalMatrix;\nvec3 dLightPosW;\nvec3 dLightDirNormW;\nvec3 dNormalW;\n",te.shaderChunks.baseNineSlicedPS="#define NINESLICED\nvarying vec2 vMask;\nvarying vec2 vTiledUv;\nuniform mediump vec4 innerOffset;\nuniform mediump vec2 outerScale;\nuniform mediump vec4 atlasRect;\nvec2 nineSlicedUv;\n",te.shaderChunks.baseNineSlicedVS="#define NINESLICED\nvarying vec2 vMask;\nvarying vec2 vTiledUv;\nuniform mediump vec4 innerOffset;\nuniform mediump vec2 outerScale;\nuniform mediump vec4 atlasRect;\n",te.shaderChunks.baseNineSlicedTiledPS="#define NINESLICED\n#define NINESLICETILED\nvarying vec2 vMask;\nvarying vec2 vTiledUv;\nuniform mediump vec4 innerOffset;\nuniform mediump vec2 outerScale;\nuniform mediump vec4 atlasRect;\nvec2 nineSlicedUv;\n",te.shaderChunks.biasConstPS="#define SHADOWBIAS\nfloat getShadowBias(float resolution, float maxBias) {\n    return maxBias;\n}\n",te.shaderChunks.blurVSMPS="\nvarying vec2 vUv0;\nuniform sampler2D source;\nuniform vec2 pixelOffset;\n#ifdef GAUSS\nuniform float weight[SAMPLES];\n#endif\n#ifdef PACKED\nfloat decodeFloatRG(vec2 rg) {\n    return rg.y*(1.0/255.0) + rg.x;\n}\nvec2 encodeFloatRG( float v ) {\n  vec2 enc = vec2(1.0, 255.0) * v;\n  enc = fract(enc);\n  enc -= enc.yy * vec2(1.0/255.0, 1.0/255.0);\n  return enc;\n}\n#endif\nvoid main(void) {\n    vec3 moments = vec3(0.0);\n    vec2 uv = vUv0 - pixelOffset * (float(SAMPLES) * 0.5);\n    for(int i=0; i<SAMPLES; i++) {\n        vec4 c = texture2D(source, uv + pixelOffset * float(i));\n        #ifdef PACKED\n        c.xy = vec2(decodeFloatRG(c.xy), decodeFloatRG(c.zw));\n        #endif\n        #ifdef GAUSS\n        moments += c.xyz * weight[i];\n        #else\n        moments += c.xyz;\n        #endif\n    }\n    #ifndef GAUSS\n    moments /= float(SAMPLES);\n    #endif\n    #ifdef PACKED\n    gl_FragColor = vec4(encodeFloatRG(moments.x), encodeFloatRG(moments.y));\n    #else\n    gl_FragColor = vec4(moments.x, moments.y, moments.z, 1.0);\n    #endif\n}\n",te.shaderChunks.combineDiffusePS="vec3 combineColor() {\n    return dAlbedo * dDiffuseLight;\n}\n",te.shaderChunks.combineDiffuseSpecularPS="vec3 combineColor() {\n    return mix(dAlbedo * dDiffuseLight, dSpecularLight + dReflection.rgb * dReflection.a, dSpecularity);\n}\n",te.shaderChunks.combineDiffuseSpecularNoConservePS="vec3 combineColor() {\n    return dAlbedo * dDiffuseLight + (dSpecularLight + dReflection.rgb * dReflection.a) * dSpecularity;\n}\n",te.shaderChunks.combineDiffuseSpecularNoReflPS="vec3 combineColor() {\n    return dAlbedo * dDiffuseLight + dSpecularLight * dSpecularity;\n}\n",te.shaderChunks.combineDiffuseSpecularNoReflSeparateAmbientPS="uniform vec3 material_ambient;\nvec3 combineColor() {\n    return (dDiffuseLight - light_globalAmbient) * dAlbedo + dSpecularLight * dSpecularity + material_ambient * light_globalAmbient;\n}\n",te.shaderChunks.combineDiffuseSpecularOldPS="vec3 combineColor() {\n    return mix(dAlbedo * dDiffuseLight + dSpecularLight * dSpecularity, dReflection.rgb, dReflection.a);\n}\n",te.shaderChunks.cookiePS="vec4 getCookie2D(sampler2D tex, mat4 transform, float intensity) {\n    vec4 projPos = transform * vec4(vPositionW, 1.0);\n    projPos.xy /= projPos.w;\n    return mix(vec4(1.0), texture2D(tex, projPos.xy), intensity);\n}\nvec4 getCookie2DClip(sampler2D tex, mat4 transform, float intensity) {\n    vec4 projPos = transform * vec4(vPositionW, 1.0);\n    projPos.xy /= projPos.w;\n    if (projPos.x < 0.0 || projPos.x > 1.0 || projPos.y < 0.0 || projPos.y > 1.0 || projPos.z < 0.0) return vec4(0.0);\n    return mix(vec4(1.0), texture2D(tex, projPos.xy), intensity);\n}\nvec4 getCookie2DXform(sampler2D tex, mat4 transform, float intensity, vec4 cookieMatrix, vec2 cookieOffset) {\n    vec4 projPos = transform * vec4(vPositionW, 1.0);\n    projPos.xy /= projPos.w;\n    projPos.xy += cookieOffset;\n    vec2 uv = mat2(cookieMatrix) * (projPos.xy-vec2(0.5)) + vec2(0.5);\n    return mix(vec4(1.0), texture2D(tex, uv), intensity);\n}\nvec4 getCookie2DClipXform(sampler2D tex, mat4 transform, float intensity, vec4 cookieMatrix, vec2 cookieOffset) {\n    vec4 projPos = transform * vec4(vPositionW, 1.0);\n    projPos.xy /= projPos.w;\n    projPos.xy += cookieOffset;\n    if (projPos.x < 0.0 || projPos.x > 1.0 || projPos.y < 0.0 || projPos.y > 1.0 || projPos.z < 0.0) return vec4(0.0);\n    vec2 uv = mat2(cookieMatrix) * (projPos.xy-vec2(0.5)) + vec2(0.5);\n    return mix(vec4(1.0), texture2D(tex, uv), intensity);\n}\nvec4 getCookieCube(samplerCube tex, mat4 transform, float intensity) {\n    return mix(vec4(1.0), textureCube(tex, dLightDirNormW * mat3(transform)), intensity);\n}\n",te.shaderChunks.cubeMapProjectBoxPS="uniform vec3 envBoxMin, envBoxMax;\nvec3 cubeMapProject(vec3 nrdir) {\n    vec3 rbmax = (envBoxMax - vPositionW) / nrdir;\n    vec3 rbmin = (envBoxMin - vPositionW) / nrdir;\n    vec3 rbminmax;\n    rbminmax.x = nrdir.x>0.0? rbmax.x : rbmin.x;\n    rbminmax.y = nrdir.y>0.0? rbmax.y : rbmin.y;\n    rbminmax.z = nrdir.z>0.0? rbmax.z : rbmin.z;\n    float fa = min(min(rbminmax.x, rbminmax.y), rbminmax.z);\n    vec3 posonbox = vPositionW + nrdir * fa;\n    vec3 envBoxPos = (envBoxMin + envBoxMax) * 0.5;\n    return posonbox - envBoxPos;\n}\n",te.shaderChunks.cubeMapProjectNonePS="vec3 cubeMapProject(vec3 dir) {\n    return dir;\n}\n",te.shaderChunks.diffusePS="#ifdef MAPCOLOR\nuniform vec3 material_diffuse;\n#endif\n#ifdef MAPTEXTURE\nuniform sampler2D texture_diffuseMap;\n#endif\nvoid getAlbedo() {\n    dAlbedo = vec3(1.0);\n    #ifdef MAPCOLOR\n        dAlbedo *= material_diffuse.rgb;\n    #endif\n    #ifdef MAPTEXTURE\n        dAlbedo *= texture2DSRGB(texture_diffuseMap, $UV).$CH;\n    #endif\n    #ifdef MAPVERTEX\n        dAlbedo *= gammaCorrectInput(saturate(vVertexColor.$VC));\n    #endif\n}\n",te.shaderChunks.dilatePS="varying vec2 vUv0;\nuniform sampler2D source;\nuniform vec2 pixelOffset;\nvoid main(void) {\n    vec4 c = texture2D(source, vUv0);\n    c = c.a>0.0? c : texture2D(source, vUv0 - pixelOffset);\n    c = c.a>0.0? c : texture2D(source, vUv0 + vec2(0, -pixelOffset.y));\n    c = c.a>0.0? c : texture2D(source, vUv0 + vec2(pixelOffset.x, -pixelOffset.y));\n    c = c.a>0.0? c : texture2D(source, vUv0 + vec2(-pixelOffset.x, 0));\n    c = c.a>0.0? c : texture2D(source, vUv0 + vec2(pixelOffset.x, 0));\n    c = c.a>0.0? c : texture2D(source, vUv0 + vec2(-pixelOffset.x, pixelOffset.y));\n    c = c.a>0.0? c : texture2D(source, vUv0 + vec2(0, pixelOffset.y));\n    c = c.a>0.0? c : texture2D(source, vUv0 + pixelOffset);\n    gl_FragColor = c;\n}\n",te.shaderChunks.dpAtlasQuadPS="varying vec2 vUv0;\nuniform sampler2D source;\nuniform vec4 params;\nvoid main(void) {\n    vec2 uv = vUv0;\n    uv = uv * 2.0 - vec2(1.0);\n    uv *= params.xy;\n    uv = uv * 0.5 + 0.5;\n    gl_FragColor = texture2D(source, uv);\n}\n",te.shaderChunks.emissivePS="#ifdef MAPCOLOR\nuniform vec3 material_emissive;\n#endif\n#ifdef MAPFLOAT\nuniform float material_emissiveIntensity;\n#endif\n#ifdef MAPTEXTURE\nuniform sampler2D texture_emissiveMap;\n#endif\nvec3 getEmission() {\n    vec3 emission = vec3(1.0);\n    #ifdef MAPFLOAT\n        emission *= material_emissiveIntensity;\n    #endif\n    #ifdef MAPCOLOR\n        emission *= material_emissive;\n    #endif\n    #ifdef MAPTEXTURE\n        emission *= $texture2DSAMPLE(texture_emissiveMap, $UV).$CH;\n    #endif\n    #ifdef MAPVERTEX\n        emission *= gammaCorrectInput(saturate(vVertexColor.$VC));\n    #endif\n    return emission;\n}\n",te.shaderChunks.endPS="   gl_FragColor.rgb = combineColor();\n   gl_FragColor.rgb += getEmission();\n   gl_FragColor.rgb = addFog(gl_FragColor.rgb);\n   #ifndef HDR\n    gl_FragColor.rgb = toneMap(gl_FragColor.rgb);\n    gl_FragColor.rgb = gammaCorrectOutput(gl_FragColor.rgb);\n   #endif\n",te.shaderChunks.envConstPS="vec3 processEnvironment(vec3 color) {\n    return color;\n}\n",te.shaderChunks.envMultiplyPS="uniform float skyboxIntensity;\nvec3 processEnvironment(vec3 color) {\n    return color * skyboxIntensity;\n}\n",te.shaderChunks.extensionPS="",te.shaderChunks.extensionVS="\n",te.shaderChunks.falloffInvSquaredPS="float getFalloffInvSquared(float lightRadius) {\n    float sqrDist = dot(dLightDirW, dLightDirW);\n    float falloff = 1.0 / (sqrDist + 1.0);\n    float invRadius = 1.0 / lightRadius;\n    falloff *= 16.0;\n    falloff *= square( saturate( 1.0 - square( sqrDist * square(invRadius) ) ) );\n    return falloff;\n}\n",te.shaderChunks.falloffLinearPS="float getFalloffLinear(float lightRadius) {\n    float d = length(dLightDirW);\n    return max(((lightRadius - d) / lightRadius), 0.0);\n}\n",te.shaderChunks.fixCubemapSeamsNonePS="vec3 fixSeams(vec3 vec, float mipmapIndex) {\n    return vec;\n}\nvec3 fixSeams(vec3 vec) {\n    return vec;\n}\nvec3 fixSeamsStatic(vec3 vec, float invRecMipSize) {\n    return vec;\n}\n",te.shaderChunks.fixCubemapSeamsStretchPS="vec3 fixSeams(vec3 vec, float mipmapIndex) {\n    float scale = 1.0 - exp2(mipmapIndex) / 128.0;\n    float M = max(max(abs(vec.x), abs(vec.y)), abs(vec.z));\n    if (abs(vec.x) != M) vec.x *= scale;\n    if (abs(vec.y) != M) vec.y *= scale;\n    if (abs(vec.z) != M) vec.z *= scale;\n    return vec;\n}\nvec3 fixSeams(vec3 vec) {\n    float scale = 1.0 - 1.0 / 128.0;\n    float M = max(max(abs(vec.x), abs(vec.y)), abs(vec.z));\n    if (abs(vec.x) != M) vec.x *= scale;\n    if (abs(vec.y) != M) vec.y *= scale;\n    if (abs(vec.z) != M) vec.z *= scale;\n    return vec;\n}\nvec3 fixSeamsStatic(vec3 vec, float invRecMipSize) {\n    float scale = invRecMipSize;\n    float M = max(max(abs(vec.x), abs(vec.y)), abs(vec.z));\n    if (abs(vec.x) != M) vec.x *= scale;\n    if (abs(vec.y) != M) vec.y *= scale;\n    if (abs(vec.z) != M) vec.z *= scale;\n    return vec;\n}\n",te.shaderChunks.fogExpPS="uniform vec3 fog_color;\nuniform float fog_density;\nvec3 addFog(vec3 color) {\n    float depth = gl_FragCoord.z / gl_FragCoord.w;\n    float fogFactor = exp(-depth * fog_density);\n    fogFactor = clamp(fogFactor, 0.0, 1.0);\n    return mix(fog_color, color, fogFactor);\n}\n",te.shaderChunks.fogExp2PS="uniform vec3 fog_color;\nuniform float fog_density;\nvec3 addFog(vec3 color) {\n    float depth = gl_FragCoord.z / gl_FragCoord.w;\n    float fogFactor = exp(-depth * depth * fog_density * fog_density);\n    fogFactor = clamp(fogFactor, 0.0, 1.0);\n    return mix(fog_color, color, fogFactor);\n}\n",te.shaderChunks.fogLinearPS="uniform vec3 fog_color;\nuniform float fog_start;\nuniform float fog_end;\nvec3 addFog(vec3 color) {\n    float depth = gl_FragCoord.z / gl_FragCoord.w;\n    float fogFactor = (fog_end - depth) / (fog_end - fog_start);\n    fogFactor = clamp(fogFactor, 0.0, 1.0);\n    fogFactor = gammaCorrectInput(fogFactor);\n    return mix(fog_color, color, fogFactor);\n}\n",te.shaderChunks.fogNonePS="vec3 addFog(vec3 color) {\n    return color;\n}\n",te.shaderChunks.fresnelSchlickPS="// Schlick's approximation\nuniform float material_fresnelFactor; // unused\nvoid getFresnel() {\n    float fresnel = 1.0 - max(dot(dNormalW, dViewDirW), 0.0);\n    float fresnel2 = fresnel * fresnel;\n    fresnel *= fresnel2 * fresnel2;\n    fresnel *= dGlossiness * dGlossiness;\n    dSpecularity = dSpecularity + (1.0 - dSpecularity) * fresnel;\n}\n",te.shaderChunks.fullscreenQuadPS="varying vec2 vUv0;\nuniform sampler2D source;\nvoid main(void) {\n    gl_FragColor = texture2D(source, vUv0);\n}\n",te.shaderChunks.fullscreenQuadVS="attribute vec2 vertex_position;\nvarying vec2 vUv0;\nvoid main(void)\n{\n    gl_Position = vec4(vertex_position, 0.5, 1.0);\n    vUv0 = vertex_position.xy*0.5+0.5;\n}\n",te.shaderChunks.gamma1_0PS="vec4 texture2DSRGB(sampler2D tex, vec2 uv) {\n    return texture2D(tex, uv);\n}\nvec4 texture2DSRGB(sampler2D tex, vec2 uv, float bias) {\n    return texture2D(tex, uv, bias);\n}\nvec4 textureCubeSRGB(samplerCube tex, vec3 uvw) {\n    return textureCube(tex, uvw);\n}\nvec3 gammaCorrectOutput(vec3 color) {\n    return color;\n}\nvec3 gammaCorrectInput(vec3 color) {\n    return color;\n}\nfloat gammaCorrectInput(float color) {\n    return color;\n}\nvec4 gammaCorrectInput(vec4 color) {\n    return color;\n}\n",te.shaderChunks.gamma2_2PS="vec3 gammaCorrectInput(vec3 color) {\n    return pow(color, vec3(2.2));\n}\nfloat gammaCorrectInput(float color) {\n    return pow(color, 2.2);\n}\nvec4 gammaCorrectInput(vec4 color) {\n    return vec4(pow(color.rgb, vec3(2.2)), color.a);\n}\nvec4 texture2DSRGB(sampler2D tex, vec2 uv) {\n    vec4 rgba = texture2D(tex, uv);\n    rgba.rgb = gammaCorrectInput(rgba.rgb);\n    return rgba;\n}\nvec4 texture2DSRGB(sampler2D tex, vec2 uv, float bias) {\n    vec4 rgba = texture2D(tex, uv, bias);\n    rgba.rgb = gammaCorrectInput(rgba.rgb);\n    return rgba;\n}\nvec4 textureCubeSRGB(samplerCube tex, vec3 uvw) {\n    vec4 rgba = textureCube(tex, uvw);\n    rgba.rgb = gammaCorrectInput(rgba.rgb);\n    return rgba;\n}\nvec3 gammaCorrectOutput(vec3 color) {\n#ifdef HDR\n    return color;\n#else\n    color += vec3(0.0000001);\n    return pow(color, vec3(0.45));\n#endif\n}\n",te.shaderChunks.genParaboloidPS="varying vec2 vUv0;\nuniform samplerCube source;\nuniform vec4 params; // x = mip\nvoid main(void) {\n    vec2 uv = vUv0;\n    float side = uv.x < 0.5? 1.0 : -1.0;\n    vec2 tc;\n    tc.x = fract(uv.x * 2.0) * 2.0 - 1.0;\n    tc.y = uv.y * 2.0 - 1.0;\n    // scale projection a bit to have a little overlap for filtering\n    const float scale = 1.1;\n    tc *= scale;\n    vec3 dir;\n    dir.y = (dot(tc, tc) - 1.0) * side; // from 1.0 center to 0.0 borders quadratically\n    dir.xz = tc * -2.0;\n    dir.x *= -side * params.y; // flip original cubemap x instead of doing it at runtime\n    dir = fixSeams(dir, params.x);\n    vec4 color = textureCube(source, dir, -100.0);\n    gl_FragColor = color;\n}\n",te.shaderChunks.gles3PS="#define varying in\nout highp vec4 pc_fragColor;\n#define gl_FragColor pc_fragColor\n#define texture2D texture\n#define textureCube texture\n#define texture2DProj textureProj\n#define texture2DLodEXT textureLod\n#define texture2DProjLodEXT textureProjLod\n#define textureCubeLodEXT textureLod\n#define texture2DGradEXT textureGrad\n#define texture2DProjGradEXT textureProjGrad\n#define textureCubeGradEXT textureGrad\n#define GL2\n",te.shaderChunks.gles3VS="#define attribute in\n#define varying out\n#define texture2D texture\n#define GL2\n#define VERTEXSHADER\n",te.shaderChunks.glossPS="#ifdef MAPFLOAT\nuniform float material_shininess;\n#endif\n#ifdef MAPTEXTURE\nuniform sampler2D texture_glossMap;\n#endif\nvoid getGlossiness() {\n    dGlossiness = 1.0;\n    #ifdef MAPFLOAT\n        dGlossiness *= material_shininess;\n    #endif\n    #ifdef MAPTEXTURE\n        dGlossiness *= texture2D(texture_glossMap, $UV).$CH;\n    #endif\n    #ifdef MAPVERTEX\n        dGlossiness *= saturate(vVertexColor.$VC);\n    #endif\n    dGlossiness += 0.0000001;\n}\n",te.shaderChunks.instancingVS="\nattribute vec4 instance_line1;\nattribute vec4 instance_line2;\nattribute vec4 instance_line3;\nattribute vec4 instance_line4;\n",te.shaderChunks.lightDiffuseLambertPS="float getLightDiffuse() {\n    return max(dot(dNormalW, -dLightDirNormW), 0.0);\n}\n",te.shaderChunks.lightDirPointPS="void getLightDirPoint(vec3 lightPosW) {\n    dLightDirW = vPositionW - lightPosW;\n    dLightDirNormW = normalize(dLightDirW);\n    dLightPosW = lightPosW;\n}\n",te.shaderChunks.lightSpecularBlinnPS="// Energy-conserving (hopefully) Blinn-Phong\nfloat getLightSpecular() {\n    vec3 h = normalize( -dLightDirNormW + dViewDirW );\n    float nh = max( dot( h, dNormalW ), 0.0 );\n    float specPow = exp2(dGlossiness * 11.0); // glossiness is linear, power is not; 0 - 2048\n    specPow = antiAliasGlossiness(specPow);\n    // Hack: On Mac OS X, calling pow with zero for the exponent generates hideous artifacts so bias up a little\n    specPow = max(specPow, 0.0001);\n    return pow(nh, specPow) * (specPow + 2.0) / 8.0;\n}\n",te.shaderChunks.lightSpecularPhongPS="float getLightSpecular() {\n    float specPow = dGlossiness;\n    specPow = antiAliasGlossiness(specPow);\n    // Hack: On Mac OS X, calling pow with zero for the exponent generates hideous artifacts so bias up a little\n    return pow(max(dot(dReflDirW, -dLightDirNormW), 0.0), specPow + 0.0001);\n}\n",te.shaderChunks.lightmapDirPS="uniform sampler2D texture_lightMap;\nuniform sampler2D texture_dirLightMap;\nvoid addLightMap() {\n    vec3 color = $texture2DSAMPLE(texture_lightMap, $UV).$CH;\n    vec4 dir = texture2D(texture_dirLightMap, $UV);\n    if (dot(dir.xyz,vec3(1.0)) < 0.00001) {\n        dDiffuseLight += color;\n        return;\n    }\n    dLightDirNormW = normalize(dir.xyz * 2.0 - vec3(1.0));\n    float vlight = saturate(dot(dLightDirNormW, -dVertexNormalW));\n    float flight = saturate(dot(dLightDirNormW, -dNormalW));\n    float nlight = (flight / max(vlight,0.01)) * 0.5;\n    dDiffuseLight += color * nlight * 2.0;\n}\nvoid addDirLightMap() {\n    vec4 dir = texture2D(texture_dirLightMap, $UV);\n    if (dot(dir.xyz,vec3(1.0)) < 0.00001) return;\n    vec3 color = $texture2DSAMPLE(texture_lightMap, $UV).$CH;\n    dLightDirNormW = normalize(dir.xyz * 2.0 - vec3(1.0));\n    dSpecularLight += vec3(getLightSpecular()) * color;\n}\n",te.shaderChunks.lightmapSinglePS="#ifdef MAPTEXTURE\nuniform sampler2D texture_lightMap;\n#endif\nvoid addLightMap() {\n    vec3 lm = vec3(1.0);\n    #ifdef MAPTEXTURE\n        lm *= $texture2DSAMPLE(texture_lightMap, $UV).$CH;\n    #endif\n    #ifdef MAPVERTEX\n        lm *= saturate(vVertexColor.$VC);\n    #endif\n    \n    dDiffuseLight += lm;\n}\n",te.shaderChunks.lightmapSingleVertPS="void addLightMap() {\n    dDiffuseLight += saturate(vVertexColor.$CH);\n}\n",te.shaderChunks.metalnessPS="void processMetalness(float metalness) {\n    const float dielectricF0 = 0.04;\n    dSpecularity = mix(vec3(dielectricF0), dAlbedo, metalness);\n    dAlbedo *= 1.0 - metalness;\n}\n#ifdef MAPFLOAT\nuniform float material_metalness;\n#endif\n#ifdef MAPTEXTURE\nuniform sampler2D texture_metalnessMap;\n#endif\nvoid getSpecularity() {\n    float metalness = 1.0;\n    #ifdef MAPFLOAT\n        metalness *= material_metalness;\n    #endif\n    #ifdef MAPTEXTURE\n        metalness *= texture2D(texture_metalnessMap, $UV).$CH;\n    #endif\n    #ifdef MAPVERTEX\n        metalness *= saturate(vVertexColor.$VC);\n    #endif\n    processMetalness(metalness);\n}\n",te.shaderChunks.msdfPS="uniform sampler2D texture_msdfMap;\n#ifdef GL_OES_standard_derivatives\n#define USE_FWIDTH\n#endif\n#ifdef GL2\n#define USE_FWIDTH\n#endif\nfloat median(float r, float g, float b) {\n    return max(min(r, g), min(max(r, g), b));\n}\nfloat map (float min, float max, float v) {\n    return (v - min) / (max - min);\n}\nuniform float font_sdfIntensity; // intensity is used to boost the value read from the SDF, 0 is no boost, 1.0 is max boost\nuniform float font_pxrange;      // the number of pixels between inside and outside the font in SDF\nuniform float font_textureWidth; // the width of the texture atlas\nuniform vec4 outline_color;\nuniform float outline_thickness;\nuniform vec4 shadow_color;\nuniform vec2 shadow_offset;\nvec4 applyMsdf(vec4 color) {\n    // sample the field\n    vec3 tsample = texture2D(texture_msdfMap, vUv0).rgb;\n    vec2 uvShdw = vUv0 - shadow_offset;\n    vec3 ssample = texture2D(texture_msdfMap, uvShdw).rgb;\n    // get the signed distance value\n    float sigDist = median(tsample.r, tsample.g, tsample.b);\n    float sigDistShdw = median(ssample.r, ssample.g, ssample.b);\n    #ifdef USE_FWIDTH\n        // smoothing depends on size of texture on screen\n        vec2 w = fwidth(vUv0);\n        float smoothing = clamp(w.x * font_textureWidth / font_pxrange, 0.0, 0.5);\n    #else\n        float font_size = 16.0; // TODO fix this\n        // smoothing gets smaller as the font size gets bigger\n        // don't have fwidth we can approximate from font size, this doesn't account for scaling\n        // so a big font scaled down will be wrong...\n        float smoothing = clamp(font_pxrange / font_size, 0.0, 0.5);\n    #endif\n    float mapMin = 0.05;\n    float mapMax = clamp(1.0 - font_sdfIntensity, mapMin, 1.0);\n    // remap to a smaller range (used on smaller font sizes)\n    float sigDistInner = map(mapMin, mapMax, sigDist);\n    float sigDistOutline = map(mapMin, mapMax, sigDist + outline_thickness);\n    sigDistShdw = map(mapMin, mapMax, sigDistShdw + outline_thickness);\n    float center = 0.5;\n    // calculate smoothing and use to generate opacity\n    float inside = smoothstep(center-smoothing, center+smoothing, sigDistInner);\n    float outline = smoothstep(center-smoothing, center+smoothing, sigDistOutline);\n    float shadow = smoothstep(center-smoothing, center+smoothing, sigDistShdw);\n    vec4 tcolor = (outline > inside) ? outline * vec4(outline_color.a * outline_color.rgb, outline_color.a) : vec4(0.0);\n    tcolor = mix(tcolor, color, inside);\n    vec4 scolor = (shadow > outline) ? shadow * vec4(shadow_color.a * shadow_color.rgb, shadow_color.a) : tcolor;\n    tcolor = mix(scolor, tcolor, outline);\n    \n    return tcolor;\n}",te.shaderChunks.normalVS="vec3 getNormal() {\n    #ifdef SKIN\n        dNormalMatrix = mat3(dModelMatrix[0].xyz, dModelMatrix[1].xyz, dModelMatrix[2].xyz);\n    #elif defined(INSTANCING)\n        dNormalMatrix = mat3(instance_line1.xyz, instance_line2.xyz, instance_line3.xyz);\n    #else\n        dNormalMatrix = matrix_normal;\n    #endif\n    return normalize(dNormalMatrix * vertex_normal);\n}\n",te.shaderChunks.normalInstancedVS="vec3 getNormal() {\n    dNormalMatrix = mat3(instance_line1.xyz, instance_line2.xyz, instance_line3.xyz);\n    return normalize(dNormalMatrix * vertex_normal);\n}\n",te.shaderChunks.normalMapPS="uniform sampler2D texture_normalMap;\nuniform float material_bumpiness;\nvoid getNormal() {\n    vec3 normalMap = unpackNormal(texture2D(texture_normalMap, $UV));\n    dNormalMap = normalMap;\n    dNormalW = dTBN * normalMap;\n}\n",te.shaderChunks.normalMapFloatPS="uniform sampler2D texture_normalMap;\nuniform float material_bumpiness;\nvoid getNormal() {\n    vec3 normalMap = unpackNormal(texture2D(texture_normalMap, $UV));\n    dNormalMap = normalMap;\n    normalMap = normalize(mix(vec3(0.0, 0.0, 1.0), normalMap, material_bumpiness));\n    dNormalW = dTBN * normalMap;\n}\n",te.shaderChunks.normalMapFloatTBNfastPS="uniform sampler2D texture_normalMap;\nuniform float material_bumpiness;\nvoid getNormal() {\n    vec3 normalMap = unpackNormal(texture2D(texture_normalMap, $UV));\n    dNormalMap = normalMap;\n    normalMap = mix(vec3(0.0, 0.0, 1.0), normalMap, material_bumpiness);\n    dNormalW = normalize(dTBN * normalMap);\n}\n",te.shaderChunks.normalSkinnedVS="vec3 getNormal() {\n    dNormalMatrix = mat3(dModelMatrix[0].xyz, dModelMatrix[1].xyz, dModelMatrix[2].xyz);\n    return normalize(dNormalMatrix * vertex_normal);\n}\n",te.shaderChunks.normalVertexPS="void getNormal() {\n    dNormalW = normalize(dVertexNormalW);\n}\n",te.shaderChunks.normalXYPS="vec3 unpackNormal(vec4 nmap) {\n    vec3 normal;\n    normal.xy = nmap.wy * 2.0 - 1.0;\n    normal.z = sqrt(1.0 - saturate(dot(normal.xy, normal.xy)));\n    return normal;\n}\n",te.shaderChunks.normalXYZPS="vec3 unpackNormal(vec4 nmap) {\n    return nmap.xyz * 2.0 - 1.0;\n}\n",te.shaderChunks.opacityPS="#ifdef MAPFLOAT\nuniform float material_opacity;\n#endif\n#ifdef MAPTEXTURE\nuniform sampler2D texture_opacityMap;\n#endif\nvoid getOpacity() {\n    dAlpha = 1.0;\n    #ifdef MAPFLOAT\n        dAlpha *= material_opacity;\n    #endif\n    #ifdef MAPTEXTURE\n        dAlpha *= texture2D(texture_opacityMap, $UV).$CH;\n    #endif\n    #ifdef MAPVERTEX\n        dAlpha *= saturate(vVertexColor.$VC);\n    #endif\n}\n",te.shaderChunks.outputAlphaPS="gl_FragColor.a = dAlpha;\n",te.shaderChunks.outputAlphaOpaquePS="gl_FragColor.a = 1.0;\n",te.shaderChunks.outputAlphaPremulPS="gl_FragColor.rgb *= dAlpha;\ngl_FragColor.a = dAlpha;\n",te.shaderChunks.outputCubemapPS="varying vec2 vUv0;\nuniform samplerCube source;\nuniform vec4 params;\nfloat saturate(float x) {\n    return clamp(x, 0.0, 1.0);\n}\nvec4 encodeRGBM(vec4 color) { // modified RGBM\n    color.rgb = pow(color.rgb, vec3(0.5));\n    color.rgb *= 1.0 / 8.0;\n    color.a = saturate( max( max( color.r, color.g ), max( color.b, 1.0 / 255.0 ) ) );\n    color.a = ceil(color.a * 255.0) / 255.0;\n    color.rgb /= color.a;\n    return color;\n}\nvoid main(void) {\n    vec2 st = vUv0 * 2.0 - 1.0;\n    float face = params.x;\n    vec3 vec;\n    if (face==0.0) {\n        vec = vec3(1, -st.y, -st.x);\n    } else if (face==1.0) {\n        vec = vec3(-1, -st.y, st.x);\n    } else if (face==2.0) {\n        vec = vec3(st.x, 1, st.y);\n    } else if (face==3.0) {\n        vec = vec3(st.x, -1, -st.y);\n    } else if (face==4.0) {\n        vec = vec3(st.x, -st.y, 1);\n    } else {\n        vec = vec3(-st.x, -st.y, -1);\n    }\n    gl_FragColor = textureCube(source, vec);\n    if (params.w >= 2.0) gl_FragColor = encodeRGBM(gl_FragColor);\n}\n",te.shaderChunks.outputTex2DPS="varying vec2 vUv0;\nuniform sampler2D source;\nvoid main(void) {\n    gl_FragColor = texture2D(source, vUv0);\n}\n",te.shaderChunks.packDepthPS="// Packing a float in GLSL with multiplication and mod\n// http://blog.gradientstudios.com/2012/08/23/shadow-map-improvement\nvec4 packFloat(float depth) {\n    const vec4 bit_shift = vec4(256.0 * 256.0 * 256.0, 256.0 * 256.0, 256.0, 1.0);\n    const vec4 bit_mask  = vec4(0.0, 1.0 / 256.0, 1.0 / 256.0, 1.0 / 256.0);\n    // combination of mod and multiplication and division works better\n    vec4 res = mod(depth * bit_shift * vec4(255), vec4(256) ) / vec4(255);\n    res -= res.xxyz * bit_mask;\n    return res;\n}\n",te.shaderChunks.packDepthMaskPS="vec4 packFloat(float depth) {\n    const vec4 bit_shift = vec4(256.0 * 256.0 * 256.0, 256.0 * 256.0, 256.0, 1.0);\n    const vec4 bit_mask  = vec4(0.0, 1.0 / 256.0, 1.0 / 256.0, 1.0 / 256.0);\n    // combination of mod and multiplication and division works better\n    vec4 res = mod(depth * bit_shift * vec4(255), vec4(256) ) / vec4(255);\n    res.x = 0.0;\n    res -= res.xxyz * bit_mask;\n    return res;\n}\n",te.shaderChunks.parallaxPS="uniform sampler2D texture_heightMap;\nuniform float material_heightMapFactor;\nvoid getParallax() {\n    float parallaxScale = material_heightMapFactor;\n    float height = texture2D(texture_heightMap, $UV).$CH;\n    height = height * parallaxScale - parallaxScale*0.5;\n    vec3 viewDirT = dViewDirW * dTBN;\n    viewDirT.z += 0.42;\n    dUvOffset = height * (viewDirT.xy / viewDirT.z);\n}\n",te.shaderChunks.particlePS="varying vec4 texCoordsAlphaLife;\nuniform sampler2D colorMap;\nuniform sampler2D colorParam;\nuniform float graphSampleSize;\nuniform float graphNumSamples;\n#ifndef CAMERAPLANES\n#define CAMERAPLANES\nuniform vec4 camera_params;\n#endif\nuniform float softening;\nuniform float colorMult;\nfloat saturate(float x) {\n    return clamp(x, 0.0, 1.0);\n}\n#ifndef UNPACKFLOAT\n#define UNPACKFLOAT\nfloat unpackFloat(vec4 rgbaDepth) {\n    const vec4 bitShift = vec4(1.0 / (256.0 * 256.0 * 256.0), 1.0 / (256.0 * 256.0), 1.0 / 256.0, 1.0);\n    float depth = dot(rgbaDepth, bitShift);\n    return depth;\n}\n#endif\nvoid main(void) {\n    vec4 tex         = texture2DSRGB(colorMap, texCoordsAlphaLife.xy);\n    vec4 ramp     = texture2DSRGB(colorParam, vec2(texCoordsAlphaLife.w, 0.0));\n    ramp.rgb *= colorMult;\n    ramp.a += texCoordsAlphaLife.z;\n    vec3 rgb =     tex.rgb * ramp.rgb;\n    float a =         tex.a * ramp.a;\n",te.shaderChunks.particleVS="\nvec3 unpack3NFloats(float src) {\n    float r = fract(src);\n    float g = fract(src * 256.0);\n    float b = fract(src * 65536.0);\n    return vec3(r, g, b);\n}\nfloat saturate(float x) {\n    return clamp(x, 0.0, 1.0);\n}\nvec4 tex1Dlod_lerp(sampler2D tex, vec2 tc) {\n    return mix( texture2D(tex,tc), texture2D(tex,tc + graphSampleSize), fract(tc.x*graphNumSamples) );\n}\nvec4 tex1Dlod_lerp(sampler2D tex, vec2 tc, out vec3 w) {\n    vec4 a = texture2D(tex,tc);\n    vec4 b = texture2D(tex,tc + graphSampleSize);\n    float c = fract(tc.x*graphNumSamples);\n    vec3 unpackedA = unpack3NFloats(a.w);\n    vec3 unpackedB = unpack3NFloats(b.w);\n    w = mix(unpackedA, unpackedB, c);\n    return mix(a, b, c);\n}\nvec2 rotate(vec2 quadXY, float pRotation, out mat2 rotMatrix) {\n    float c = cos(pRotation);\n    float s = sin(pRotation);\n    mat2 m = mat2(c, -s, s, c);\n    rotMatrix = m;\n    return m * quadXY;\n}\nvec3 billboard(vec3 InstanceCoords, vec2 quadXY) {\n   vec3 pos = -matrix_viewInverse[0].xyz * quadXY.x + -matrix_viewInverse[1].xyz * quadXY.y;\n   return pos;\n}\nvec3 customFace(vec3 InstanceCoords, vec2 quadXY) {\n    vec3 pos = faceTangent * quadXY.x + faceBinorm * quadXY.y;\n    return pos;\n}\nvoid main(void) {\n    vec3 meshLocalPos = particle_vertexData.xyz;\n    float id = floor(particle_vertexData.w);\n    float rndFactor = fract(sin(id + 1.0 + seed));\n    vec3 rndFactor3 = vec3(rndFactor, fract(rndFactor*10.0), fract(rndFactor*100.0));\n    float uv = id / numParticlesPot;\n    readInput(uv);\n#ifdef LOCAL_SPACE\n    inVel = mat3(matrix_model) * inVel;\n#endif\n    vec2 velocityV = normalize((mat3(matrix_view) * inVel).xy); // should be removed by compiler if align/stretch is not used\n    float particleLifetime = lifetime;\n    if (inLife <= 0.0 || inLife > particleLifetime || !inShow) meshLocalPos = vec3(0.0);\n    vec2 quadXY = meshLocalPos.xy;\n    float nlife = clamp(inLife / particleLifetime, 0.0, 1.0);\n    vec3 paramDiv;\n    vec4 params = tex1Dlod_lerp(internalTex2, vec2(nlife, 0), paramDiv);\n    float scale = params.y;\n    float scaleDiv = paramDiv.x;\n    float alphaDiv = paramDiv.z;\n    scale += (scaleDiv * 2.0 - 1.0) * scaleDivMult * fract(rndFactor*10000.0);\n#ifndef USE_MESH\n    texCoordsAlphaLife = vec4(quadXY * -0.5 + 0.5, (alphaDiv * 2.0 - 1.0) * alphaDivMult * fract(rndFactor*1000.0), nlife);\n#else\n    texCoordsAlphaLife = vec4(particle_uv, (alphaDiv * 2.0 - 1.0) * alphaDivMult * fract(rndFactor*1000.0), nlife);\n#endif\n    vec3 particlePos = inPos;\n    vec3 particlePosMoved = vec3(0.0);\n    mat2 rotMatrix;\n",te.shaderChunks.particleAnimFrameClampVS="\n    float animFrame = min(floor(texCoordsAlphaLife.w * animTexParams.z), animTexParams.w);\n",te.shaderChunks.particleAnimFrameLoopVS="\n    float animFrame = floor(texCoordsAlphaLife.w * animTexParams.z);\n",te.shaderChunks.particleAnimTexVS="\n    float atlasX = animFrame * animTexParams.x;\n    float atlasY = 1.0 - floor(atlasX + 1.0) * animTexParams.y;\n    atlasX = fract(atlasX);\n    texCoordsAlphaLife.xy *= animTexParams.xy;\n    texCoordsAlphaLife.xy += vec2(atlasX, atlasY);\n",te.shaderChunks.particleInputFloatPS="void readInput(float uv) {\n    vec4 tex = texture2D(particleTexIN, vec2(uv, 0.25));\n    vec4 tex2 = texture2D(particleTexIN, vec2(uv, 0.75));\n    inPos = tex.xyz;\n    inVel = tex2.xyz;\n    inAngle = (tex.w < 0.0? -tex.w : tex.w) - 1000.0;\n    inShow = tex.w >= 0.0;\n    inLife = tex2.w;\n}\n",te.shaderChunks.particleInputRgba8PS="//RG=X, BA=Y\n//RG=Z, BA=A\n//RGB=V, A=visMode\n//RGBA=life\n#define PI2 6.283185307179586\nuniform vec3 inBoundsSize;\nuniform vec3 inBoundsCenter;\nuniform float maxVel;\nfloat decodeFloatRG(vec2 rg) {\n    return rg.y*(1.0/255.0) + rg.x;\n}\nfloat decodeFloatRGBA( vec4 rgba ) {\n  return dot( rgba, vec4(1.0, 1.0/255.0, 1.0/65025.0, 1.0/160581375.0) );\n}\nvoid readInput(float uv) {\n    vec4 tex0 = texture2D(particleTexIN, vec2(uv, 0.125));\n    vec4 tex1 = texture2D(particleTexIN, vec2(uv, 0.375));\n    vec4 tex2 = texture2D(particleTexIN, vec2(uv, 0.625));\n    vec4 tex3 = texture2D(particleTexIN, vec2(uv, 0.875));\n    inPos = vec3(decodeFloatRG(tex0.rg), decodeFloatRG(tex0.ba), decodeFloatRG(tex1.rg));\n    inPos = (inPos - vec3(0.5)) * inBoundsSize + inBoundsCenter;\n    inVel = tex2.xyz;\n    inVel = (inVel - vec3(0.5)) * maxVel;\n    inAngle = decodeFloatRG(tex1.ba) * PI2;\n    inShow = tex2.a > 0.5;\n    inLife = decodeFloatRGBA(tex3);\n    float maxNegLife = max(lifetime, (numParticles - 1.0) * (rate+rateDiv));\n    float maxPosLife = lifetime+1.0;\n    inLife = inLife * (maxNegLife + maxPosLife) - maxNegLife;\n}\n",te.shaderChunks.particleOutputFloatPS="void writeOutput() {\n    if (gl_FragCoord.y<1.0) {\n        gl_FragColor = vec4(outPos, (outAngle + 1000.0) * visMode);\n    } else {\n        gl_FragColor = vec4(outVel, outLife);\n    }\n}\n",te.shaderChunks.particleOutputRgba8PS="uniform vec3 outBoundsMul;\nuniform vec3 outBoundsAdd;\nvec2 encodeFloatRG( float v ) {\n  vec2 enc = vec2(1.0, 255.0) * v;\n  enc = fract(enc);\n  enc -= enc.yy * vec2(1.0/255.0, 1.0/255.0);\n  return enc;\n}\nvec4 encodeFloatRGBA( float v ) {\n  vec4 enc = vec4(1.0, 255.0, 65025.0, 160581375.0) * v;\n  enc = fract(enc);\n  enc -= enc.yzww * vec4(1.0/255.0,1.0/255.0,1.0/255.0,0.0);\n  return enc;\n}\nvoid writeOutput() {\n    //outPos = (outPos - outBoundsCenter) / outBoundsSize + vec3(0.5);\n    outPos = outPos * outBoundsMul + outBoundsAdd;\n    outAngle = fract(outAngle / PI2);\n    outVel = (outVel / maxVel) + vec3(0.5); // TODO: mul\n    float maxNegLife = max(lifetime, (numParticles - 1.0) * (rate+rateDiv));\n    float maxPosLife = lifetime+1.0;\n    outLife = (outLife + maxNegLife) / (maxNegLife + maxPosLife);\n    if (gl_FragCoord.y < 1.0) {\n        gl_FragColor = vec4(encodeFloatRG(outPos.x), encodeFloatRG(outPos.y));\n    } else if (gl_FragCoord.y < 2.0) {\n        gl_FragColor = vec4(encodeFloatRG(outPos.z), encodeFloatRG(outAngle));\n    } else if (gl_FragCoord.y < 3.0) {\n        gl_FragColor = vec4(outVel, visMode*0.5+0.5);\n    } else {\n        gl_FragColor = encodeFloatRGBA(outLife);\n    }\n}\n",te.shaderChunks.particleUpdaterAABBPS="uniform mat3 spawnBounds;\nuniform vec3 spawnPosInnerRatio;\nvec3 calcSpawnPosition(vec3 inBounds, float rndFactor) {\n    vec3 pos = inBounds - vec3(0.5);\n    vec3 posAbs = abs(pos);\n    vec3 maxPos = vec3(max(posAbs.x, max(posAbs.y, posAbs.z)));\n    vec3 edge = maxPos + (vec3(0.5) - maxPos) * spawnPosInnerRatio;\n    //pos = edge * mix(2.0 * pos, sign(pos), equal(maxPos, posAbs));\n    pos.x = edge.x * (maxPos.x == posAbs.x ? sign(pos.x) : 2.0 * pos.x);\n    pos.y = edge.y * (maxPos.y == posAbs.y ? sign(pos.y) : 2.0 * pos.y);\n    pos.z = edge.z * (maxPos.z == posAbs.z ? sign(pos.z) : 2.0 * pos.z);\n#ifndef LOCAL_SPACE\n    return emitterPos + spawnBounds * pos;\n#else\n    return spawnBounds * pos;\n#endif\n}\nvoid addInitialVelocity(inout vec3 localVelocity, vec3 inBounds) {\n    localVelocity -= vec3(0, 0, initialVelocity);\n}\n",te.shaderChunks.particleUpdaterEndPS="\n    writeOutput();\n}\n",te.shaderChunks.particleUpdaterInitPS="varying vec2 vUv0;\nuniform sampler2D particleTexIN;\nuniform sampler2D internalTex0;\nuniform sampler2D internalTex1;\nuniform sampler2D internalTex2;\nuniform sampler2D internalTex3;\nuniform mat3 emitterMatrix, emitterMatrixInv;\nuniform vec3 emitterScale;\nuniform vec3 emitterPos, frameRandom, localVelocityDivMult, velocityDivMult;\nuniform float delta, rate, rateDiv, lifetime, numParticles, rotSpeedDivMult, radialSpeedDivMult, seed;\nuniform float startAngle, startAngle2;\nuniform float initialVelocity;\nuniform float graphSampleSize;\nuniform float graphNumSamples;\nvec3 inPos;\nvec3 inVel;\nfloat inAngle;\nbool inShow;\nfloat inLife;\nfloat visMode;\nvec3 outPos;\nvec3 outVel;\nfloat outAngle;\nbool outShow;\nfloat outLife;\n",te.shaderChunks.particleUpdaterNoRespawnPS="    if (outLife >= lifetime) {\n        outLife -= max(lifetime, (numParticles - 1.0) * particleRate);\n        visMode = -1.0;\n    }\n",te.shaderChunks.particleUpdaterOnStopPS="    visMode = outLife < 0.0? -1.0: visMode;\n",te.shaderChunks.particleUpdaterRespawnPS="    if (outLife >= lifetime) {\n        outLife -= max(lifetime, (numParticles - 1.0) * particleRate);\n        visMode = 1.0;\n    }\n    visMode = outLife < 0.0? 1.0: visMode;\n",te.shaderChunks.particleUpdaterSpherePS="uniform float spawnBoundsSphere;\nuniform float spawnBoundsSphereInnerRatio;\nvec3 calcSpawnPosition(vec3 inBounds, float rndFactor) {\n    float rnd4 = fract(rndFactor * 1000.0);\n    vec3 norm = normalize(inBounds.xyz - vec3(0.5));\n    float r = rnd4 * (1.0 - spawnBoundsSphereInnerRatio) + spawnBoundsSphereInnerRatio;\n#ifndef LOCAL_SPACE\n    return emitterPos + norm * r * spawnBoundsSphere;\n#else\n    return norm * r * spawnBoundsSphere;\n#endif\n}\nvoid addInitialVelocity(inout vec3 localVelocity, vec3 inBounds) {\n    localVelocity += normalize(inBounds - vec3(0.5)) * initialVelocity;\n}\n",te.shaderChunks.particleUpdaterStartPS="float saturate(float x) {\n    return clamp(x, 0.0, 1.0);\n}\nvec3 unpack3NFloats(float src) {\n    float r = fract(src);\n    float g = fract(src * 256.0);\n    float b = fract(src * 65536.0);\n    return vec3(r, g, b);\n}\nvec3 tex1Dlod_lerp(sampler2D tex, vec2 tc, out vec3 w) {\n    vec4 a = texture2D(tex, tc);\n    vec4 b = texture2D(tex, tc + graphSampleSize);\n    float c = fract(tc.x * graphNumSamples);\n    vec3 unpackedA = unpack3NFloats(a.w);\n    vec3 unpackedB = unpack3NFloats(b.w);\n    w = mix(unpackedA, unpackedB, c);\n    return mix(a.xyz, b.xyz, c);\n}\n#define HASHSCALE4 vec4(1031, .1030, .0973, .1099)\nvec4 hash41(float p) {\n    vec4 p4 = fract(vec4(p) * HASHSCALE4);\n    p4 += dot(p4, p4.wzxy+19.19);\n    return fract(vec4((p4.x + p4.y)*p4.z, (p4.x + p4.z)*p4.y, (p4.y + p4.z)*p4.w, (p4.z + p4.w)*p4.x));\n}\nvoid main(void)\n{\n    if (gl_FragCoord.x > numParticles) discard;\n    readInput(vUv0.x);\n    visMode = inShow? 1.0 : -1.0;\n    vec4 rndFactor = hash41(gl_FragCoord.x + seed);\n    float particleRate = rate + rateDiv * rndFactor.x;\n    outLife = inLife + delta;\n    float nlife = clamp(outLife / lifetime, 0.0, 1.0);\n    vec3 localVelocityDiv;\n    vec3 velocityDiv;\n    vec3 paramDiv;\n    vec3 localVelocity = tex1Dlod_lerp(internalTex0, vec2(nlife, 0), localVelocityDiv);\n    vec3 velocity =      tex1Dlod_lerp(internalTex1, vec2(nlife, 0), velocityDiv);\n    vec3 params =        tex1Dlod_lerp(internalTex2, vec2(nlife, 0), paramDiv);\n    float rotSpeed = params.x;\n    float rotSpeedDiv = paramDiv.y;\n    vec3 radialParams = tex1Dlod_lerp(internalTex3, vec2(nlife, 0), paramDiv);\n    float radialSpeed = radialParams.x;\n    float radialSpeedDiv = radialParams.y;\n    bool respawn = inLife <= 0.0 || outLife >= lifetime;\n    inPos = respawn ? calcSpawnPosition(rndFactor.xyz, rndFactor.x) : inPos;\n    inAngle = respawn ? mix(startAngle, startAngle2, rndFactor.x) : inAngle;\n#ifndef LOCAL_SPACE\n    vec3 radialVel = inPos - emitterPos;\n#else\n    vec3 radialVel = inPos;\n#endif\n    radialVel = (dot(radialVel, radialVel) > 1.0E-8) ? radialSpeed * normalize(radialVel) : vec3(0.0);\n    radialVel += (radialSpeedDiv * vec3(2.0) - vec3(1.0)) * radialSpeedDivMult * rndFactor.xyz;\n    localVelocity +=    (localVelocityDiv * vec3(2.0) - vec3(1.0)) * localVelocityDivMult * rndFactor.xyz;\n    velocity +=         (velocityDiv * vec3(2.0) - vec3(1.0)) * velocityDivMult * rndFactor.xyz;\n    rotSpeed +=         (rotSpeedDiv * 2.0 - 1.0) * rotSpeedDivMult * rndFactor.y;\n    addInitialVelocity(localVelocity, rndFactor.xyz);\n#ifndef LOCAL_SPACE\n    outVel = emitterMatrix * localVelocity + (radialVel + velocity) * emitterScale;\n#else\n    outVel = (localVelocity + radialVel) / emitterScale + emitterMatrixInv * velocity;\n#endif\n    outPos = inPos + outVel * delta;\n    outAngle = inAngle + rotSpeed * delta;\n",te.shaderChunks.particle_TBNVS="\n    mat3 rot3 = mat3(rotMatrix[0][0], rotMatrix[0][1], 0.0,        rotMatrix[1][0], rotMatrix[1][1], 0.0,        0.0, 0.0, 1.0);\n    ParticleMat = mat3(-matrix_viewInverse[0].xyz, -matrix_viewInverse[1].xyz, matrix_viewInverse[2].xyz) * rot3;\n",te.shaderChunks.particle_billboardVS="\n    quadXY = rotate(quadXY, inAngle, rotMatrix);\n    vec3 localPos = billboard(particlePos, quadXY);\n",te.shaderChunks.particle_blendAddPS="\n    rgb *= saturate(gammaCorrectInput(a));\n    if ((rgb.r + rgb.g + rgb.b) < 0.000001) discard;\n",te.shaderChunks.particle_blendMultiplyPS="\n    rgb = mix(vec3(1.0), rgb, vec3(a));\n    if (rgb.r + rgb.g + rgb.b > 2.99) discard;\n",te.shaderChunks.particle_blendNormalPS="\n    if (a < 0.01) discard;\n",te.shaderChunks.particle_cpuVS="attribute vec4 particle_vertexData;     // XYZ = world pos, W = life\nattribute vec4 particle_vertexData2;     // X = angle, Y = scale, Z = alpha, W = velocity.x\nattribute vec4 particle_vertexData3;     // XYZ = particle local pos, W = velocity.y\n#ifndef USE_MESH\n#define VDATA4TYPE vec2\n#else\n#define VDATA4TYPE vec4\n#endif\nattribute VDATA4TYPE particle_vertexData4;     // VDATA4TYPE depends on useMesh property. Start with X = velocity.z, Y = particle ID and for mesh particles proceeds with Z = mesh UV.x, W = mesh UV.y\nuniform mat4 matrix_viewProjection;\nuniform mat4 matrix_model;\n#ifndef VIEWMATRIX\n#define VIEWMATRIX\nuniform mat4 matrix_view;\n#endif\nuniform mat3 matrix_normal;\nuniform mat4 matrix_viewInverse;\nuniform float numParticles;\nuniform float lifetime;\nuniform float stretch;\n//uniform float graphSampleSize;\n//uniform float graphNumSamples;\nuniform vec3 wrapBounds, emitterScale, faceTangent, faceBinorm;\nuniform sampler2D texLifeAndSourcePosOUT;\nuniform sampler2D internalTex0;\nuniform sampler2D internalTex1;\nuniform sampler2D internalTex2;\nuniform vec3 emitterPos;\nvarying vec4 texCoordsAlphaLife;\nvec2 rotate(vec2 quadXY, float pRotation, out mat2 rotMatrix)\n{\n    float c = cos(pRotation);\n    float s = sin(pRotation);\n    //vec4 rotationMatrix = vec4(c, -s, s, c);\n    mat2 m = mat2(c, -s, s, c);\n    rotMatrix = m;\n    return m * quadXY;\n}\nvec3 billboard(vec3 InstanceCoords, vec2 quadXY)\n{\n    vec3 pos = -matrix_viewInverse[0].xyz * quadXY.x + -matrix_viewInverse[1].xyz * quadXY.y;\n    return pos;\n}\nvec3 customFace(vec3 InstanceCoords, vec2 quadXY)\n{\n    vec3 pos = faceTangent * quadXY.x + faceBinorm * quadXY.y;\n    return pos;\n}\nvoid main(void)\n{\n    vec3 particlePos = particle_vertexData.xyz;\n    vec3 inPos = particlePos;\n    vec3 vertPos = particle_vertexData3.xyz;\n    vec3 inVel = vec3(particle_vertexData2.w, particle_vertexData3.w, particle_vertexData4.x);\n#ifdef LOCAL_SPACE\n    inVel = mat3(matrix_model) * inVel;\n#endif\n    vec2 velocityV = normalize((mat3(matrix_view) * inVel).xy); // should be removed by compiler if align/stretch is not used\n    vec2 quadXY = vertPos.xy;\n    \n#ifndef USE_MESH\n    texCoordsAlphaLife = vec4(quadXY * -0.5 + 0.5, particle_vertexData2.z, particle_vertexData.w);\n#else\n    texCoordsAlphaLife = vec4(particle_vertexData4.zw, particle_vertexData2.z, particle_vertexData.w);\n#endif\n    mat2 rotMatrix;\n    float inAngle = particle_vertexData2.x;\n    vec3 particlePosMoved = vec3(0.0);\n    vec3 meshLocalPos = particle_vertexData3.xyz;\n",te.shaderChunks.particle_cpu_endVS="\n    localPos *= particle_vertexData2.y * emitterScale;\n    localPos += particlePos;\n    gl_Position = matrix_viewProjection * vec4(localPos, 1.0);\n",te.shaderChunks.particle_customFaceVS="\n    quadXY = rotate(quadXY, inAngle, rotMatrix);\n    vec3 localPos = customFace(particlePos, quadXY);\n",te.shaderChunks.particle_endPS="    rgb = addFog(rgb);\n    rgb = toneMap(rgb);\n    rgb = gammaCorrectOutput(rgb);\n    gl_FragColor = vec4(rgb, a);\n}\n",te.shaderChunks.particle_endVS="\n    localPos *= scale * emitterScale;\n    localPos += particlePos;\n    gl_Position = matrix_viewProjection * vec4(localPos.xyz, 1.0);\n",te.shaderChunks.particle_halflambertPS="\n    vec3 negNormal = normal*0.5+0.5;\n    vec3 posNormal = -normal*0.5+0.5;\n    negNormal *= negNormal;\n    posNormal *= posNormal;\n",te.shaderChunks.particle_initVS="attribute vec4 particle_vertexData; // XYZ = particle position, W = particle ID + random factor\n#ifdef USE_MESH\nattribute vec2 particle_uv;         // mesh UV\n#endif\nuniform mat4 matrix_viewProjection;\nuniform mat4 matrix_model;\nuniform mat3 matrix_normal;\nuniform mat4 matrix_viewInverse;\n#ifndef VIEWMATRIX\n#define VIEWMATRIX\nuniform mat4 matrix_view;\n#endif\nuniform float numParticles, numParticlesPot;\nuniform float graphSampleSize;\nuniform float graphNumSamples;\nuniform float stretch;\nuniform vec3 wrapBounds;\nuniform vec3 emitterScale, emitterPos, faceTangent, faceBinorm;\nuniform float rate, rateDiv, lifetime, deltaRandomnessStatic, scaleDivMult, alphaDivMult, seed, delta;\nuniform sampler2D particleTexOUT, particleTexIN;\nuniform sampler2D internalTex0;\nuniform sampler2D internalTex1;\nuniform sampler2D internalTex2;\n#ifndef CAMERAPLANES\n#define CAMERAPLANES\nuniform vec4 camera_params;\n#endif\nvarying vec4 texCoordsAlphaLife;\nvec3 inPos;\nvec3 inVel;\nfloat inAngle;\nbool inShow;\nfloat inLife;\n",te.shaderChunks.particle_lambertPS="\n    vec3 negNormal = max(normal, vec3(0.0));\n    vec3 posNormal = max(-normal, vec3(0.0));\n",te.shaderChunks.particle_lightingPS="\n    vec3 light = negNormal.x*lightCube[0] + posNormal.x*lightCube[1] +\n                        negNormal.y*lightCube[2] + posNormal.y*lightCube[3] +\n                        negNormal.z*lightCube[4] + posNormal.z*lightCube[5];\n    rgb *= light;\n",te.shaderChunks.particle_localShiftVS="    particlePos = (matrix_model * vec4(particlePos, 1.0)).xyz;\n",te.shaderChunks.particle_meshVS="\n    vec3 localPos = meshLocalPos;\n    localPos.xy = rotate(localPos.xy, inAngle, rotMatrix);\n    localPos.yz = rotate(localPos.yz, inAngle, rotMatrix);\n    billboard(particlePos, quadXY);\n",te.shaderChunks.particle_normalVS="\n    Normal = normalize(localPos + matrix_viewInverse[2].xyz);\n",te.shaderChunks.particle_normalMapPS="\n    vec3 normalMap         = normalize( texture2D(normalMap, texCoordsAlphaLife.xy).xyz * 2.0 - 1.0 );\n    vec3 normal = ParticleMat * normalMap;\n",te.shaderChunks.particle_pointAlongVS="    inAngle = atan(velocityV.x, velocityV.y); // not the fastest way, but easier to plug in; TODO: create rot matrix right from vectors\n",te.shaderChunks.particle_softPS="\n    float depth = getLinearScreenDepth();\n    float particleDepth = vDepth;\n    float depthDiff = saturate(abs(particleDepth - depth) * softening);\n    a *= depthDiff;\n",te.shaderChunks.particle_softVS="\n    vDepth = getLinearDepth(localPos);\n",te.shaderChunks.particle_stretchVS="    vec3 moveDir = inVel * stretch;\n    vec3 posPrev = particlePos - moveDir;\n    posPrev += particlePosMoved;\n    vec2 centerToVertexV = normalize((mat3(matrix_view) * localPos).xy);\n    float interpolation = dot(-velocityV, centerToVertexV) * 0.5 + 0.5;\n    particlePos = mix(particlePos, posPrev, interpolation);\n",te.shaderChunks.particle_wrapVS="\n    vec3 origParticlePos = particlePos;\n    particlePos -= matrix_model[3].xyz;\n    particlePos = mod(particlePos, wrapBounds) - wrapBounds * 0.5;\n    particlePos += matrix_model[3].xyz;\n    particlePosMoved = particlePos - origParticlePos;\n",te.shaderChunks.precisionTestPS="void main(void) {\n    gl_FragColor = vec4(2147483648.0);\n}\n",te.shaderChunks.precisionTest2PS="uniform sampler2D source;\nvec4 packFloat(float depth) {\n    const vec4 bit_shift = vec4(256.0 * 256.0 * 256.0, 256.0 * 256.0, 256.0, 1.0);\n    const vec4 bit_mask  = vec4(0.0, 1.0 / 256.0, 1.0 / 256.0, 1.0 / 256.0);\n    vec4 res = mod(depth * bit_shift * vec4(255), vec4(256) ) / vec4(255);\n    res -= res.xxyz * bit_mask;\n    return res;\n}\nvoid main(void) {\n    float c = texture2D(source, vec2(0.0)).r;\n    float diff = abs(c - 2147483648.0) / 2147483648.0;\n    gl_FragColor = packFloat(diff);\n}\n",te.shaderChunks.prefilterCubemapPS="varying vec2 vUv0;\nuniform samplerCube source;\nuniform vec4 params;\nfloat saturate(float x) {\n    return clamp(x, 0.0, 1.0);\n}\nfloat rnd(vec2 uv) {\n    return fract(sin(dot(uv, vec2(12.9898, 78.233) * 2.0)) * 43758.5453);\n}\nconst float PI = 3.14159265358979;\nvec3 hemisphereSample_cos(vec2 uv, mat3 vecSpace, vec3 cubeDir, float gloss) { // cos + lerped cone size (better than just lerped)\n    float phi = uv.y * 2.0 * PI;\n    float cosTheta = sqrt(1.0 - uv.x);\n    float sinTheta = sqrt(1.0 - cosTheta * cosTheta);\n    vec3 sampleDir = vec3(cos(phi) * sinTheta, sin(phi) * sinTheta, cosTheta);\n    return normalize(mix(vecSpace * sampleDir, cubeDir, params.y));\n}\nvec3 hemisphereSample_phong(vec2 uv, mat3 vecSpace, vec3 cubeDir, float specPow) {\n    float phi = uv.y * 2.0 * PI;\n    float cosTheta = pow(1.0 - uv.x, 1.0 / (specPow + 1.0));\n    float sinTheta = sqrt(1.0 - cosTheta * cosTheta);\n    vec3 sampleDir = vec3(cos(phi) * sinTheta, sin(phi) * sinTheta, cosTheta);\n    return vecSpace * sampleDir;\n}\nmat3 matrixFromVector(vec3 n) { // frisvad\n    float a = 1.0 / (1.0 + n.z);\n    float b = -n.x * n.y * a;\n    vec3 b1 = vec3(1.0 - n.x * n.x * a, b, -n.x);\n    vec3 b2 = vec3(b, 1.0 - n.y * n.y * a, -n.y);\n    return mat3(b1, b2, n);\n}\nvec4 encodeRGBM(vec3 color) { // modified RGBM\n    vec4 encoded;\n    encoded.rgb = pow(color.rgb, vec3(0.5));\n    encoded.rgb *= 1.0 / 8.0;\n    encoded.a = saturate( max( max( encoded.r, encoded.g ), max( encoded.b, 1.0 / 255.0 ) ) );\n    encoded.a = ceil(encoded.a * 255.0) / 255.0;\n    encoded.rgb /= encoded.a;\n    return encoded;\n}\nvoid main(void) {\n    vec2 st = vUv0 * 2.0 - 1.0;\n    if (params.w==1.0 || params.w==3.0) {\n        st = 2.0 * floor(gl_FragCoord.xy) / (params.z - 1.0) - 1.0;\n    }\n    float face = params.x;\n    vec3 vec;\n    if (face==0.0) {\n        vec = vec3(1, -st.y, -st.x);\n    } else if (face==1.0) {\n        vec = vec3(-1, -st.y, st.x);\n    } else if (face==2.0) {\n        vec = vec3(st.x, 1, st.y);\n    } else if (face==3.0) {\n        vec = vec3(st.x, -1, -st.y);\n    } else if (face==4.0) {\n        vec = vec3(st.x, -st.y, 1);\n    } else {\n        vec = vec3(-st.x, -st.y, -1);\n    }\n    mat3 vecSpace = matrixFromVector(normalize(vec));\n    vec3 color = vec3(0.0);\n    const int samples = $NUMSAMPLES;\n    vec3 vect;\n    for(int i=0; i<samples; i++) {\n        float sini = sin(float(i));\n        float cosi = cos(float(i));\n        float rand = rnd(vec2(sini, cosi));\n        vect = hemisphereSample_$METHOD(vec2(float(i) / float(samples), rand), vecSpace, vec, params.y);\n        color += $textureCube(source, vect).rgb;\n    }\n    color /= float(samples);\n    gl_FragColor = params.w < 2.0? vec4(color, 1.0) : encodeRGBM(color);\n}\n",te.shaderChunks.reflDirPS="void getReflDir() {\n    dReflDirW = normalize(-reflect(dViewDirW, dNormalW));\n}\n",te.shaderChunks.reflectionCubePS="uniform samplerCube texture_cubeMap;\nuniform float material_reflectivity;\nvoid addReflection() {\n    vec3 lookupVec = fixSeams(cubeMapProject(dReflDirW));\n    lookupVec.x *= -1.0;\n    dReflection += vec4($textureCubeSAMPLE(texture_cubeMap, lookupVec).rgb, material_reflectivity);\n}\n",te.shaderChunks.reflectionDpAtlasPS="uniform sampler2D texture_sphereMap;\nuniform float material_reflectivity;\nvec2 getDpAtlasUv(vec2 uv, float mip) {\n    vec4 rect;\n    float sx = saturate(mip - 2.0);\n    rect.x = sx * 0.5;\n    float t = mip - rect.x * 6.0;\n    float i = 1.0 - rect.x;\n    rect.y = min(t * 0.5, 0.75) * i + rect.x;\n    float st = saturate(t);\n    rect.z = (1.0 - st * 0.5) * i;\n    rect.w = rect.z * 0.5;\n    float rcRectZ = 1.0 / rect.z;\n    float scaleFactor = 0.00390625 * rcRectZ; // 0.0078125 = (256 + 2) / 256 - 1, 0.00390625 same for 512\n    vec2 scale = vec2(scaleFactor, scaleFactor * 2.0);\n    uv = uv * (vec2(1.0) - scale) + scale * 0.5;\n    uv = uv * rect.zw + rect.xy;\n    return uv;\n}\nvoid addReflection() {\n    vec3 reflDir = normalize(cubeMapProject(dReflDirW));\n    // Convert vector to DP coords\n    bool up = reflDir.y > 0.0;\n    float scale = 0.90909090909090909090909090909091;// 1.0 / 1.1;\n    vec3 reflDirWarp = reflDir.xzx * vec3(-0.25, 0.5, 0.25);\n    float reflDirVer = abs(reflDir.y) + 1.0;\n    reflDirWarp /= reflDirVer;\n    reflDirWarp *= scale;\n    reflDirWarp = vec3(0.75, 0.5, 0.25) - reflDirWarp;\n    vec2 tc = up? reflDirWarp.xy : reflDirWarp.zy;\n    float bias = saturate(1.0 - dGlossiness) * 5.0; // multiply by max mip level\n    float mip = floor(bias);\n    vec3 tex1 = $texture2DSAMPLE(texture_sphereMap, getDpAtlasUv(tc, mip)).rgb;\n    mip = min(mip + 1.0, 5.0);\n    vec3 tex2 = $texture2DSAMPLE(texture_sphereMap, getDpAtlasUv(tc, mip)).rgb;\n    tex1 = mix(tex1, tex2, fract(bias));\n    tex1 = processEnvironment(tex1);\n    dReflection += vec4(tex1, material_reflectivity);\n}\n",te.shaderChunks.reflectionPrefilteredCubePS="uniform samplerCube texture_prefilteredCubeMap128;\nuniform samplerCube texture_prefilteredCubeMap64;\nuniform samplerCube texture_prefilteredCubeMap32;\nuniform samplerCube texture_prefilteredCubeMap16;\nuniform samplerCube texture_prefilteredCubeMap8;\n#ifndef PMREM4\n#define PMREM4\nuniform samplerCube texture_prefilteredCubeMap4;\n#endif\nuniform float material_reflectivity;\nvoid addReflection() {\n    // Unfortunately, WebGL doesn't allow us using textureCubeLod. Therefore bunch of nasty workarounds is required.\n    // We fix mip0 to 128x128, so code is rather static.\n    // Mips smaller than 4x4 aren't great even for diffuse. Don't forget that we don't have bilinear filtering between different faces.\n    float bias = saturate(1.0 - dGlossiness) * 5.0; // multiply by max mip level\n    int index1 = int(bias);\n    int index2 = int(min(bias + 1.0, 7.0));\n    vec3 fixedReflDir = fixSeams(cubeMapProject(dReflDirW), bias);\n    fixedReflDir.x *= -1.0;\n    vec4 cubes[6];\n    cubes[0] = textureCube(texture_prefilteredCubeMap128, fixedReflDir);\n    cubes[1] = textureCube(texture_prefilteredCubeMap64, fixedReflDir);\n    cubes[2] = textureCube(texture_prefilteredCubeMap32, fixedReflDir);\n    cubes[3] = textureCube(texture_prefilteredCubeMap16, fixedReflDir);\n    cubes[4] = textureCube(texture_prefilteredCubeMap8, fixedReflDir);\n    cubes[5] = textureCube(texture_prefilteredCubeMap4, fixedReflDir);\n    // Also we don't have dynamic indexing in PS, so...\n    vec4 cube[2];\n    for(int i = 0; i < 6; i++) {\n        if (i == index1) {\n            cube[0] = cubes[i];\n        }\n        if (i == index2) {\n            cube[1] = cubes[i];\n        }\n    }\n    // another variant\n    /*if (index1==0){ cube[0]=cubes[0];\n    }else if (index1==1){ cube[0]=cubes[1];\n    }else if (index1==2){ cube[0]=cubes[2];\n    }else if (index1==3){ cube[0]=cubes[3];\n    }else if (index1==4){ cube[0]=cubes[4];\n    }else if (index1==5){ cube[0]=cubes[5];}\n    if (index2==0){ cube[1]=cubes[0];\n    }else if (index2==1){ cube[1]=cubes[1];\n    }else if (index2==2){ cube[1]=cubes[2];\n    }else if (index2==3){ cube[1]=cubes[3];\n    }else if (index2==4){ cube[1]=cubes[4];\n    }else if (index2==5){ cube[1]=cubes[5];}*/\n    vec4 cubeFinal = mix(cube[0], cube[1], fract(bias));\n    vec3 refl = processEnvironment($DECODE(cubeFinal).rgb);\n    dReflection += vec4(refl, material_reflectivity);\n}\n",te.shaderChunks.reflectionPrefilteredCubeLodPS="\n#ifndef PMREM4\n#define PMREM4\n#extension GL_EXT_shader_texture_lod : enable\nuniform samplerCube texture_prefilteredCubeMap128;\n#endif\nuniform float material_reflectivity;\nvoid addReflection() {\n    float bias = saturate(1.0 - dGlossiness) * 5.0; // multiply by max mip level\n    vec3 fixedReflDir = fixSeams(cubeMapProject(dReflDirW), bias);\n    fixedReflDir.x *= -1.0;\n    vec3 refl = processEnvironment($DECODE( textureCubeLodEXT(texture_prefilteredCubeMap128, fixedReflDir, bias) ).rgb);\n    dReflection += vec4(refl, material_reflectivity);\n}\n",te.shaderChunks.reflectionSpherePS="#ifndef VIEWMATRIX\n#define VIEWMATRIX\nuniform mat4 matrix_view;\n#endif\nuniform sampler2D texture_sphereMap;\nuniform float material_reflectivity;\nvoid addReflection() {\n    vec3 reflDirV = (mat3(matrix_view) * dReflDirW).xyz;\n    float m = 2.0 * sqrt( dot(reflDirV.xy, reflDirV.xy) + (reflDirV.z+1.0)*(reflDirV.z+1.0) );\n    vec2 sphereMapUv = reflDirV.xy / m + 0.5;\n    dReflection += vec4($texture2DSAMPLE(texture_sphereMap, sphereMapUv).rgb, material_reflectivity);\n}\n",te.shaderChunks.reflectionSphereLowPS="uniform sampler2D texture_sphereMap;\nuniform float material_reflectivity;\nvoid addReflection() {\n    vec3 reflDirV = vNormalV;\n    vec2 sphereMapUv = reflDirV.xy * 0.5 + 0.5;\n    dReflection += vec4($texture2DSAMPLE(texture_sphereMap, sphereMapUv).rgb, material_reflectivity);\n}\n",te.shaderChunks.refractionPS="uniform float material_refraction, material_refractionIndex;\nvec3 refract2(vec3 viewVec, vec3 Normal, float IOR) {\n    float vn = dot(viewVec, Normal);\n    float k = 1.0 - IOR * IOR * (1.0 - vn * vn);\n    vec3 refrVec = IOR * viewVec - (IOR * vn + sqrt(k)) * Normal;\n    return refrVec;\n}\nvoid addRefraction() {\n    // use same reflection code with refraction vector\n    vec3 tmp = dReflDirW;\n    vec4 tmp2 = dReflection;\n    dReflection = vec4(0.0);\n    dReflDirW = refract2(-dViewDirW, dNormalW, material_refractionIndex);\n    addReflection();\n    dDiffuseLight = mix(dDiffuseLight, dReflection.rgb * dAlbedo, material_refraction);\n    dReflDirW = tmp;\n    dReflection = tmp2;\n}\n",te.shaderChunks.rgbmPS="vec3 decodeRGBM(vec4 rgbm) {\n    vec3 color = (8.0 * rgbm.a) * rgbm.rgb;\n    return color * color;\n}\nvec3 texture2DRGBM(sampler2D tex, vec2 uv) {\n    return decodeRGBM(texture2D(tex, uv));\n}\nvec3 textureCubeRGBM(samplerCube tex, vec3 uvw) {\n    return decodeRGBM(textureCube(tex, uvw));\n}\n",te.shaderChunks.screenDepthPS="uniform sampler2D uDepthMap;\n#ifndef SCREENSIZE\n#define SCREENSIZE\nuniform vec4 uScreenSize;\n#endif\n#ifndef VIEWMATRIX\n#define VIEWMATRIX\nuniform mat4 matrix_view;\n#endif\n#ifndef CAMERAPLANES\n#define CAMERAPLANES\nuniform vec4 camera_params; // 1 / camera_far,      camera_far,     (1 - f / n) / 2,        (1 + f / n) / 2\n#endif\n#ifdef GL2\n    float linearizeDepth(float z) {\n        z = z * 2.0 - 1.0;\n        return 1.0 / (camera_params.z * z + camera_params.w);\n    }\n#else\n    #ifndef UNPACKFLOAT\n    #define UNPACKFLOAT\n    float unpackFloat(vec4 rgbaDepth) {\n        const vec4 bitShift = vec4(1.0 / (256.0 * 256.0 * 256.0), 1.0 / (256.0 * 256.0), 1.0 / 256.0, 1.0);\n        return dot(rgbaDepth, bitShift);\n    }\n    #endif\n#endif\n// Retrieves rendered linear camera depth by UV\nfloat getLinearScreenDepth(vec2 uv) {\n    #ifdef GL2\n        return linearizeDepth(texture2D(uDepthMap, uv).r) * camera_params.y;\n    #else\n        return unpackFloat(texture2D(uDepthMap, uv)) * camera_params.y;\n    #endif\n}\n#ifndef VERTEXSHADER\n// Retrieves rendered linear camera depth under the current pixel\nfloat getLinearScreenDepth() {\n    vec2 uv = gl_FragCoord.xy * uScreenSize.zw;\n    return getLinearScreenDepth(uv);\n}\n#endif\n// Generates linear camera depth for the given world position\nfloat getLinearDepth(vec3 pos) {\n    return -(matrix_view * vec4(pos, 1.0)).z;\n}\n",te.shaderChunks.shadowCommonPS="void normalOffsetPointShadow(vec4 shadowParams) {\n    float distScale = length(dLightDirW);\n    vec3 wPos = vPositionW + dVertexNormalW * shadowParams.y * clamp(1.0 - dot(dVertexNormalW, -dLightDirNormW), 0.0, 1.0) * distScale; //0.02\n    vec3 dir = wPos - dLightPosW;\n    dLightDirW = dir;\n}\n",te.shaderChunks.shadowCoordPS="void _getShadowCoordOrtho(mat4 shadowMatrix, vec3 shadowParams, vec3 wPos) {\n    dShadowCoord = (shadowMatrix * vec4(wPos, 1.0)).xyz;\n    dShadowCoord.z = saturate(dShadowCoord.z) - 0.0001;\n    #ifdef SHADOWBIAS\n        dShadowCoord.z += getShadowBias(shadowParams.x, shadowParams.z);\n    #endif\n}\nvoid _getShadowCoordPersp(mat4 shadowMatrix, vec4 shadowParams, vec3 wPos) {\n    vec4 projPos = shadowMatrix * vec4(wPos, 1.0);\n    projPos.xy /= projPos.w;\n    dShadowCoord.xy = projPos.xy;\n    dShadowCoord.z = length(dLightDirW) * shadowParams.w;\n    #ifdef SHADOWBIAS\n        dShadowCoord.z += getShadowBias(shadowParams.x, shadowParams.z);\n    #endif\n}\nvoid getShadowCoordOrtho(mat4 shadowMatrix, vec3 shadowParams) {\n    _getShadowCoordOrtho(shadowMatrix, shadowParams, vPositionW);\n}\nvoid getShadowCoordPersp(mat4 shadowMatrix, vec4 shadowParams) {\n    _getShadowCoordPersp(shadowMatrix, shadowParams, vPositionW);\n}\nvoid getShadowCoordPerspNormalOffset(mat4 shadowMatrix, vec4 shadowParams) {\n    float distScale = abs(dot(vPositionW - dLightPosW, dLightDirNormW)); // fov?\n    vec3 wPos = vPositionW + dVertexNormalW * shadowParams.y * clamp(1.0 - dot(dVertexNormalW, -dLightDirNormW), 0.0, 1.0) * distScale;\n    _getShadowCoordPersp(shadowMatrix, shadowParams, wPos);\n}\nvoid getShadowCoordOrthoNormalOffset(mat4 shadowMatrix, vec3 shadowParams) {\n    vec3 wPos = vPositionW + dVertexNormalW * shadowParams.y * clamp(1.0 - dot(dVertexNormalW, -dLightDirNormW), 0.0, 1.0); //0.08\n    _getShadowCoordOrtho(shadowMatrix, shadowParams, wPos);\n}\n",te.shaderChunks.shadowCoordVS="void getLightDirPoint(vec3 lightPosW) {\n    vec3 lightDirW = vPositionW - lightPosW;\n    dLightDirNormW = normalize(lightDirW);\n    dLightPosW = lightPosW;\n}\nvoid _getShadowCoordOrtho(mat4 shadowMatrix, vec3 shadowParams, vec3 wPos) {\n    vec4 projPos = shadowMatrix * vec4(wPos, 1.0);\n    vMainShadowUv = projPos;\n}\nvoid _getShadowCoordPersp(mat4 shadowMatrix, vec3 shadowParams, vec3 wPos) {\n    vec4 projPos = shadowMatrix * vec4(wPos, 1.0);\n    vMainShadowUv = projPos;\n}\nvoid getShadowCoordOrtho(mat4 shadowMatrix, vec3 shadowParams) {\n    _getShadowCoordOrtho(shadowMatrix, shadowParams, vPositionW);\n}\nvoid getShadowCoordPersp(mat4 shadowMatrix, vec3 shadowParams) {\n    _getShadowCoordPersp(shadowMatrix, shadowParams, vPositionW);\n}\nvoid getShadowCoordPerspNormalOffset(mat4 shadowMatrix, vec3 shadowParams) {\n    float distScale = abs(dot(vPositionW - dLightPosW, dLightDirNormW)); // fov?\n    vec3 wPos = vPositionW + dNormalW * shadowParams.y * clamp(1.0 - dot(dNormalW, -dLightDirNormW), 0.0, 1.0) * distScale;\n    _getShadowCoordPersp(shadowMatrix, shadowParams, wPos);\n}\nvoid getShadowCoordOrthoNormalOffset(mat4 shadowMatrix, vec3 shadowParams) {\n    vec3 wPos = vPositionW + dNormalW * shadowParams.y * clamp(1.0 - dot(dNormalW, -dLightDirNormW), 0.0, 1.0); //0.08\n    _getShadowCoordOrtho(shadowMatrix, shadowParams, wPos);\n}\n",te.shaderChunks.shadowCoordPerspZbufferPS="void _getShadowCoordPerspZbuffer(mat4 shadowMatrix, vec4 shadowParams, vec3 wPos) {\n    vec4 projPos = shadowMatrix * vec4(wPos, 1.0);\n    projPos.xyz /= projPos.w;\n    dShadowCoord = projPos.xyz;\n    // depth bias is already applied on render\n}\nvoid getShadowCoordPerspZbufferNormalOffset(mat4 shadowMatrix, vec4 shadowParams) {\n    float distScale = abs(dot(vPositionW - dLightPosW, dLightDirNormW)); // fov?\n    vec3 wPos = vPositionW + dVertexNormalW * shadowParams.y * clamp(1.0 - dot(dVertexNormalW, -dLightDirNormW), 0.0, 1.0) * distScale;\n    _getShadowCoordPerspZbuffer(shadowMatrix, shadowParams, wPos);\n}\nvoid getShadowCoordPerspZbuffer(mat4 shadowMatrix, vec4 shadowParams) {\n    _getShadowCoordPerspZbuffer(shadowMatrix, shadowParams, vPositionW);\n}\n",te.shaderChunks.shadowEVSMPS="float VSM$(sampler2D tex, vec2 texCoords, float resolution, float Z, float vsmBias, float exponent) {\n    vec3 moments = texture2D(tex, texCoords).xyz;\n    return calculateEVSM(moments, Z, vsmBias, exponent);\n}\nfloat getShadowVSM$(sampler2D shadowMap, vec3 shadowParams, float exponent) {\n    return VSM$(shadowMap, dShadowCoord.xy, shadowParams.x, dShadowCoord.z, shadowParams.y, exponent);\n}\nfloat getShadowSpotVSM$(sampler2D shadowMap, vec4 shadowParams, float exponent) {\n    return VSM$(shadowMap, dShadowCoord.xy, shadowParams.x, length(dLightDirW) * shadowParams.w + shadowParams.z, shadowParams.y, exponent);\n}\n",te.shaderChunks.shadowEVSMnPS="float VSM$(sampler2D tex, vec2 texCoords, float resolution, float Z, float vsmBias, float exponent) {\n    float pixelSize = 1.0 / resolution;\n    texCoords -= vec2(pixelSize);\n    vec3 s00 = texture2D(tex, texCoords).xyz;\n    vec3 s10 = texture2D(tex, texCoords + vec2(pixelSize, 0)).xyz;\n    vec3 s01 = texture2D(tex, texCoords + vec2(0, pixelSize)).xyz;\n    vec3 s11 = texture2D(tex, texCoords + vec2(pixelSize)).xyz;\n    vec2 fr = fract(texCoords * resolution);\n    vec3 h0 = mix(s00, s10, fr.x);\n    vec3 h1 = mix(s01, s11, fr.x);\n    vec3 moments = mix(h0, h1, fr.y);\n    return calculateEVSM(moments, Z, vsmBias, exponent);\n}\nfloat getShadowVSM$(sampler2D shadowMap, vec3 shadowParams, float exponent) {\n    return VSM$(shadowMap, dShadowCoord.xy, shadowParams.x, dShadowCoord.z, shadowParams.y, exponent);\n}\nfloat getShadowSpotVSM$(sampler2D shadowMap, vec4 shadowParams, float exponent) {\n    return VSM$(shadowMap, dShadowCoord.xy, shadowParams.x, length(dLightDirW) * shadowParams.w + shadowParams.z, shadowParams.y, exponent);\n}\n",te.shaderChunks.shadowStandardPS="vec3 lessThan2(vec3 a, vec3 b) {\n    return clamp((b - a)*1000.0, 0.0, 1.0); // softer version\n}\n#ifndef UNPACKFLOAT\n#define UNPACKFLOAT\nfloat unpackFloat(vec4 rgbaDepth) {\n    const vec4 bitShift = vec4(1.0 / (256.0 * 256.0 * 256.0), 1.0 / (256.0 * 256.0), 1.0 / 256.0, 1.0);\n    return dot(rgbaDepth, bitShift);\n}\n#endif\n// ----- Direct/Spot Sampling -----\n#ifdef GL2\n    float _getShadowPCF3x3(sampler2DShadow shadowMap, vec3 shadowParams) {\n        float z = dShadowCoord.z;\n        vec2 uv = dShadowCoord.xy * shadowParams.x; // 1 unit - 1 texel\n        float shadowMapSizeInv = 1.0 / shadowParams.x;\n        vec2 base_uv = floor(uv + 0.5);\n        float s = (uv.x + 0.5 - base_uv.x);\n        float t = (uv.y + 0.5 - base_uv.y);\n        base_uv -= vec2(0.5);\n        base_uv *= shadowMapSizeInv;\n        float sum = 0.0;\n        float uw0 = (3.0 - 2.0 * s);\n        float uw1 = (1.0 + 2.0 * s);\n        float u0 = (2.0 - s) / uw0 - 1.0;\n        float u1 = s / uw1 + 1.0;\n        float vw0 = (3.0 - 2.0 * t);\n        float vw1 = (1.0 + 2.0 * t);\n        float v0 = (2.0 - t) / vw0 - 1.0;\n        float v1 = t / vw1 + 1.0;\n        u0 = u0 * shadowMapSizeInv + base_uv.x;\n        v0 = v0 * shadowMapSizeInv + base_uv.y;\n        u1 = u1 * shadowMapSizeInv + base_uv.x;\n        v1 = v1 * shadowMapSizeInv + base_uv.y;\n        sum += uw0 * vw0 * texture(shadowMap, vec3(u0, v0, z));\n        sum += uw1 * vw0 * texture(shadowMap, vec3(u1, v0, z));\n        sum += uw0 * vw1 * texture(shadowMap, vec3(u0, v1, z));\n        sum += uw1 * vw1 * texture(shadowMap, vec3(u1, v1, z));\n        sum *= 1.0f / 16.0;\n        return sum;\n    }\n    float getShadowPCF3x3(sampler2DShadow shadowMap, vec3 shadowParams) {\n        return _getShadowPCF3x3(shadowMap, shadowParams);\n    }\n    float getShadowSpotPCF3x3(sampler2DShadow shadowMap, vec4 shadowParams) {\n        return _getShadowPCF3x3(shadowMap, shadowParams.xyz);\n    }\n#else\n    float _xgetShadowPCF3x3(mat3 depthKernel, sampler2D shadowMap, vec3 shadowParams) {\n        mat3 shadowKernel;\n        vec3 shadowCoord = dShadowCoord;\n        vec3 shadowZ = vec3(shadowCoord.z);\n        shadowKernel[0] = vec3(greaterThan(depthKernel[0], shadowZ));\n        shadowKernel[1] = vec3(greaterThan(depthKernel[1], shadowZ));\n        shadowKernel[2] = vec3(greaterThan(depthKernel[2], shadowZ));\n        vec2 fractionalCoord = fract( shadowCoord.xy * shadowParams.x );\n        shadowKernel[0] = mix(shadowKernel[0], shadowKernel[1], fractionalCoord.x);\n        shadowKernel[1] = mix(shadowKernel[1], shadowKernel[2], fractionalCoord.x);\n        vec4 shadowValues;\n        shadowValues.x = mix(shadowKernel[0][0], shadowKernel[0][1], fractionalCoord.y);\n        shadowValues.y = mix(shadowKernel[0][1], shadowKernel[0][2], fractionalCoord.y);\n        shadowValues.z = mix(shadowKernel[1][0], shadowKernel[1][1], fractionalCoord.y);\n        shadowValues.w = mix(shadowKernel[1][1], shadowKernel[1][2], fractionalCoord.y);\n        return dot( shadowValues, vec4( 1.0 ) ) * 0.25;\n    }\n    float _getShadowPCF3x3(sampler2D shadowMap, vec3 shadowParams) {\n        vec3 shadowCoord = dShadowCoord;\n        float xoffset = 1.0 / shadowParams.x; // 1/shadow map width\n        float dx0 = -xoffset;\n        float dx1 = xoffset;\n        mat3 depthKernel;\n        depthKernel[0][0] = unpackFloat(texture2D(shadowMap, shadowCoord.xy + vec2(dx0, dx0)));\n        depthKernel[0][1] = unpackFloat(texture2D(shadowMap, shadowCoord.xy + vec2(dx0, 0.0)));\n        depthKernel[0][2] = unpackFloat(texture2D(shadowMap, shadowCoord.xy + vec2(dx0, dx1)));\n        depthKernel[1][0] = unpackFloat(texture2D(shadowMap, shadowCoord.xy + vec2(0.0, dx0)));\n        depthKernel[1][1] = unpackFloat(texture2D(shadowMap, shadowCoord.xy));\n        depthKernel[1][2] = unpackFloat(texture2D(shadowMap, shadowCoord.xy + vec2(0.0, dx1)));\n        depthKernel[2][0] = unpackFloat(texture2D(shadowMap, shadowCoord.xy + vec2(dx1, dx0)));\n        depthKernel[2][1] = unpackFloat(texture2D(shadowMap, shadowCoord.xy + vec2(dx1, 0.0)));\n        depthKernel[2][2] = unpackFloat(texture2D(shadowMap, shadowCoord.xy + vec2(dx1, dx1)));\n        return _xgetShadowPCF3x3(depthKernel, shadowMap, shadowParams);\n    }\n    float getShadowPCF3x3(sampler2D shadowMap, vec3 shadowParams) {\n        return _getShadowPCF3x3(shadowMap, shadowParams);\n    }\n    float getShadowSpotPCF3x3(sampler2D shadowMap, vec4 shadowParams) {\n        return _getShadowPCF3x3(shadowMap, shadowParams.xyz);\n    }\n#endif\n// ----- Point Sampling -----\nfloat _getShadowPoint(samplerCube shadowMap, vec4 shadowParams, vec3 dir) {\n    vec3 tc = normalize(dir);\n    vec3 tcAbs = abs(tc);\n    vec4 dirX = vec4(1,0,0, tc.x);\n    vec4 dirY = vec4(0,1,0, tc.y);\n    float majorAxisLength = tc.z;\n    if ((tcAbs.x > tcAbs.y) && (tcAbs.x > tcAbs.z)) {\n        dirX = vec4(0,0,1, tc.z);\n        dirY = vec4(0,1,0, tc.y);\n        majorAxisLength = tc.x;\n    } else if ((tcAbs.y > tcAbs.x) && (tcAbs.y > tcAbs.z)) {\n        dirX = vec4(1,0,0, tc.x);\n        dirY = vec4(0,0,1, tc.z);\n        majorAxisLength = tc.y;\n    }\n    float shadowParamsInFaceSpace = ((1.0/shadowParams.x) * 2.0) * abs(majorAxisLength);\n    vec3 xoffset = (dirX.xyz * shadowParamsInFaceSpace);\n    vec3 yoffset = (dirY.xyz * shadowParamsInFaceSpace);\n    vec3 dx0 = -xoffset;\n    vec3 dy0 = -yoffset;\n    vec3 dx1 = xoffset;\n    vec3 dy1 = yoffset;\n    mat3 shadowKernel;\n    mat3 depthKernel;\n    depthKernel[0][0] = unpackFloat(textureCube(shadowMap, tc + dx0 + dy0));\n    depthKernel[0][1] = unpackFloat(textureCube(shadowMap, tc + dx0));\n    depthKernel[0][2] = unpackFloat(textureCube(shadowMap, tc + dx0 + dy1));\n    depthKernel[1][0] = unpackFloat(textureCube(shadowMap, tc + dy0));\n    depthKernel[1][1] = unpackFloat(textureCube(shadowMap, tc));\n    depthKernel[1][2] = unpackFloat(textureCube(shadowMap, tc + dy1));\n    depthKernel[2][0] = unpackFloat(textureCube(shadowMap, tc + dx1 + dy0));\n    depthKernel[2][1] = unpackFloat(textureCube(shadowMap, tc + dx1));\n    depthKernel[2][2] = unpackFloat(textureCube(shadowMap, tc + dx1 + dy1));\n    vec3 shadowZ = vec3(length(dir) * shadowParams.w + shadowParams.z);\n    shadowKernel[0] = vec3(lessThan2(depthKernel[0], shadowZ));\n    shadowKernel[1] = vec3(lessThan2(depthKernel[1], shadowZ));\n    shadowKernel[2] = vec3(lessThan2(depthKernel[2], shadowZ));\n    vec2 uv = (vec2(dirX.w, dirY.w) / abs(majorAxisLength)) * 0.5;\n    vec2 fractionalCoord = fract( uv * shadowParams.x );\n    shadowKernel[0] = mix(shadowKernel[0], shadowKernel[1], fractionalCoord.x);\n    shadowKernel[1] = mix(shadowKernel[1], shadowKernel[2], fractionalCoord.x);\n    vec4 shadowValues;\n    shadowValues.x = mix(shadowKernel[0][0], shadowKernel[0][1], fractionalCoord.y);\n    shadowValues.y = mix(shadowKernel[0][1], shadowKernel[0][2], fractionalCoord.y);\n    shadowValues.z = mix(shadowKernel[1][0], shadowKernel[1][1], fractionalCoord.y);\n    shadowValues.w = mix(shadowKernel[1][1], shadowKernel[1][2], fractionalCoord.y);\n    return 1.0 - dot( shadowValues, vec4( 1.0 ) ) * 0.25;\n}\nfloat getShadowPointPCF3x3(samplerCube shadowMap, vec4 shadowParams) {\n    return _getShadowPoint(shadowMap, shadowParams, dLightDirW);\n}\n",te.shaderChunks.shadowStandardGL2PS="float _getShadowPCF5x5(sampler2DShadow shadowMap, vec3 shadowParams) {\n    // http://the-witness.net/news/2013/09/shadow-mapping-summary-part-1/\n    float z = dShadowCoord.z;\n    vec2 uv = dShadowCoord.xy * shadowParams.x; // 1 unit - 1 texel\n    float shadowMapSizeInv = 1.0 / shadowParams.x;\n    vec2 base_uv = floor(uv + 0.5);\n    float s = (uv.x + 0.5 - base_uv.x);\n    float t = (uv.y + 0.5 - base_uv.y);\n    base_uv -= vec2(0.5);\n    base_uv *= shadowMapSizeInv;\n    float uw0 = (4.0 - 3.0 * s);\n    float uw1 = 7.0;\n    float uw2 = (1.0 + 3.0 * s);\n    float u0 = (3.0 - 2.0 * s) / uw0 - 2.0;\n    float u1 = (3.0 + s) / uw1;\n    float u2 = s / uw2 + 2.0;\n    float vw0 = (4.0 - 3.0 * t);\n    float vw1 = 7.0;\n    float vw2 = (1.0 + 3.0 * t);\n    float v0 = (3.0 - 2.0 * t) / vw0 - 2.0;\n    float v1 = (3.0 + t) / vw1;\n    float v2 = t / vw2 + 2.0;\n    float sum = 0.0;\n    u0 = u0 * shadowMapSizeInv + base_uv.x;\n    v0 = v0 * shadowMapSizeInv + base_uv.y;\n    u1 = u1 * shadowMapSizeInv + base_uv.x;\n    v1 = v1 * shadowMapSizeInv + base_uv.y;\n    u2 = u2 * shadowMapSizeInv + base_uv.x;\n    v2 = v2 * shadowMapSizeInv + base_uv.y;\n    sum += uw0 * vw0 * texture(shadowMap, vec3(u0, v0, z));\n    sum += uw1 * vw0 * texture(shadowMap, vec3(u1, v0, z));\n    sum += uw2 * vw0 * texture(shadowMap, vec3(u2, v0, z));\n    sum += uw0 * vw1 * texture(shadowMap, vec3(u0, v1, z));\n    sum += uw1 * vw1 * texture(shadowMap, vec3(u1, v1, z));\n    sum += uw2 * vw1 * texture(shadowMap, vec3(u2, v1, z));\n    sum += uw0 * vw2 * texture(shadowMap, vec3(u0, v2, z));\n    sum += uw1 * vw2 * texture(shadowMap, vec3(u1, v2, z));\n    sum += uw2 * vw2 * texture(shadowMap, vec3(u2, v2, z));\n    sum *= 1.0f / 144.0;\n    sum = gammaCorrectInput(sum); // gives softer gradient\n    sum = saturate(sum);\n    return sum;\n}\nfloat getShadowPCF5x5(sampler2DShadow shadowMap, vec3 shadowParams) {\n    return _getShadowPCF5x5(shadowMap, shadowParams);\n}\nfloat getShadowSpotPCF5x5(sampler2DShadow shadowMap, vec4 shadowParams) {\n    return _getShadowPCF5x5(shadowMap, shadowParams.xyz);\n}\n",te.shaderChunks.shadowStandardGL2VSPS="float getShadowPCF5x5VS(sampler2DShadow shadowMap, vec3 shadowParams) {\n    dShadowCoord = vMainShadowUv.xyz;\n    dShadowCoord.z = saturate(dShadowCoord.z) - 0.0001; // prevent going to dark after the far plane\n    return _getShadowPCF5x5(shadowMap, shadowParams);\n}\n",te.shaderChunks.shadowStandardVSPS="#ifdef GL2\n#define SHADOW_SAMPLERVS sampler2DShadow\n#else\n#define SHADOW_SAMPLERVS sampler2D\n#endif\nfloat getShadowPCF3x3VS(SHADOW_SAMPLERVS shadowMap, vec3 shadowParams) {\n    dShadowCoord = vMainShadowUv.xyz;\n    dShadowCoord.z = saturate(dShadowCoord.z) - 0.0001;\n    #ifdef SHADOWBIAS\n        dShadowCoord.z += getShadowBias(shadowParams.x, shadowParams.z);\n    #endif\n    return _getShadowPCF3x3(shadowMap, shadowParams);\n}\n",te.shaderChunks.shadowVSM8PS="float calculateVSM8(vec3 moments, float Z, float vsmBias) {\n    float VSMBias = vsmBias;//0.01 * 0.25;\n    float depthScale = VSMBias * Z;\n    float minVariance1 = depthScale * depthScale;\n    return chebyshevUpperBound(moments.xy, Z, minVariance1, 0.1);\n}\nfloat decodeFloatRG(vec2 rg) {\n    return rg.y*(1.0/255.0) + rg.x;\n}\nfloat VSM8(sampler2D tex, vec2 texCoords, float resolution, float Z, float vsmBias, float exponent) {\n    vec4 c = texture2D(tex, texCoords);\n    vec3 moments = vec3(decodeFloatRG(c.xy), decodeFloatRG(c.zw), 0.0);\n    return calculateVSM8(moments, Z, vsmBias);\n}\nfloat getShadowVSM8(sampler2D shadowMap, vec3 shadowParams, float exponent) {\n    return VSM8(shadowMap, dShadowCoord.xy, shadowParams.x, dShadowCoord.z, shadowParams.y, 0.0);\n}\nfloat getShadowSpotVSM8(sampler2D shadowMap, vec4 shadowParams, float exponent) {\n    return VSM8(shadowMap, dShadowCoord.xy, shadowParams.x, length(dLightDirW) * shadowParams.w + shadowParams.z, shadowParams.y, 0.0);\n}\n",te.shaderChunks.shadowVSMVSPS="float getShadowVSM$VS(sampler2D shadowMap, vec3 shadowParams, float exponent) {\n    dShadowCoord = vMainShadowUv.xyz;\n    dShadowCoord.z += shadowParams.z;\n    dShadowCoord.xyz /= vMainShadowUv.w;\n    dShadowCoord.z = min(dShadowCoord.z, 1.0);\n    return $VSM(shadowMap, dShadowCoord.xy, shadowParams.x, dShadowCoord.z, shadowParams.y, exponent);\n}\n",te.shaderChunks.shadowVSM_commonPS="float linstep(float a, float b, float v) {\n    return saturate((v - a) / (b - a));\n}\nfloat reduceLightBleeding(float pMax, float amount) {\n  // Remove the [0, amount] tail and linearly rescale (amount, 1].\n   return linstep(amount, 1.0, pMax);\n}\nfloat chebyshevUpperBound(vec2 moments, float mean, float minVariance, float lightBleedingReduction) {\n    // Compute variance\n    float variance = moments.y - (moments.x * moments.x);\n    variance = max(variance, minVariance);\n    // Compute probabilistic upper bound\n    float d = mean - moments.x;\n    float pMax = variance / (variance + (d * d));\n    pMax = reduceLightBleeding(pMax, lightBleedingReduction);\n    // One-tailed Chebyshev\n    return (mean <= moments.x ? 1.0 : pMax);\n}\nfloat calculateEVSM(vec3 moments, float Z, float vsmBias, float exponent) {\n    Z = 2.0 * Z - 1.0;\n    float warpedDepth = exp(exponent * Z);\n    moments.xy += vec2(warpedDepth, warpedDepth*warpedDepth) * (1.0 - moments.z);\n    float VSMBias = vsmBias;//0.01 * 0.25;\n    float depthScale = VSMBias * exponent * warpedDepth;\n    float minVariance1 = depthScale * depthScale;\n    return chebyshevUpperBound(moments.xy, warpedDepth, minVariance1, 0.1);\n}\n",te.shaderChunks.skinBatchConstVS="attribute float vertex_boneIndices;\nuniform mat4 matrix_pose[BONE_LIMIT];\nmat4 getBoneMatrix(const in float i) {\n    mat4 bone = matrix_pose[int(i)];\n    return bone;\n}\n",te.shaderChunks.skinBatchTexVS="attribute float vertex_boneIndices;\nuniform sampler2D texture_poseMap;\nuniform vec2 texture_poseMapSize;\nmat4 getBoneMatrix(const in float i) {\n    float j = i * 4.0;\n    float x = mod(j, float(texture_poseMapSize.x));\n    float y = floor(j / float(texture_poseMapSize.x));\n    float dx = 1.0 / float(texture_poseMapSize.x);\n    float dy = 1.0 / float(texture_poseMapSize.y);\n    y = dy * (y + 0.5);\n    vec4 v1 = texture2D(texture_poseMap, vec2(dx * (x + 0.5), y));\n    vec4 v2 = texture2D(texture_poseMap, vec2(dx * (x + 1.5), y));\n    vec4 v3 = texture2D(texture_poseMap, vec2(dx * (x + 2.5), y));\n    vec4 v4 = texture2D(texture_poseMap, vec2(dx * (x + 3.5), y));\n    mat4 bone = mat4(v1, v2, v3, v4);\n    return bone;\n}\n",te.shaderChunks.skinConstVS="attribute vec4 vertex_boneWeights;\nattribute vec4 vertex_boneIndices;\nuniform mat4 matrix_pose[BONE_LIMIT];\nmat4 getBoneMatrix(const in float i)\n{\n    mat4 bone = matrix_pose[int(i)];\n    return bone;\n}\n",te.shaderChunks.skinTexVS="attribute vec4 vertex_boneWeights;\nattribute vec4 vertex_boneIndices;\nuniform sampler2D texture_poseMap;\nuniform vec2 texture_poseMapSize;\nmat4 getBoneMatrix(const in float i)\n{\n    float j = i * 4.0;\n    float x = mod(j, float(texture_poseMapSize.x));\n    float y = floor(j / float(texture_poseMapSize.x));\n    float dx = 1.0 / float(texture_poseMapSize.x);\n    float dy = 1.0 / float(texture_poseMapSize.y);\n    y = dy * (y + 0.5);\n    vec4 v1 = texture2D(texture_poseMap, vec2(dx * (x + 0.5), y));\n    vec4 v2 = texture2D(texture_poseMap, vec2(dx * (x + 1.5), y));\n    vec4 v3 = texture2D(texture_poseMap, vec2(dx * (x + 2.5), y));\n    vec4 v4 = texture2D(texture_poseMap, vec2(dx * (x + 3.5), y));\n    mat4 bone = mat4(v1, v2, v3, v4);\n    return bone;\n}\n",te.shaderChunks.skyboxPS="varying vec3 vViewDir;\nuniform samplerCube texture_cubeMap;\nvoid main(void) {\n    gl_FragColor = textureCube(texture_cubeMap, fixSeams(vViewDir));\n}\n",te.shaderChunks.skyboxVS="attribute vec3 aPosition;\n#ifndef VIEWMATRIX\n#define VIEWMATRIX\nuniform mat4 matrix_view;\n#endif\nuniform mat4 matrix_projection;\nvarying vec3 vViewDir;\nvoid main(void)\n{\n    mat4 view = matrix_view;\n    view[3][0] = view[3][1] = view[3][2] = 0.0;\n    gl_Position = matrix_projection * view * vec4(aPosition, 1.0);\n    // Force skybox to far Z, regardless of the clip planes on the camera\n    // Subtract a tiny fudge factor to ensure floating point errors don't\n    // still push pixels beyond far Z. See:\n    // http://www.opengl.org/discussion_boards/showthread.php/171867-skybox-problem\n    gl_Position.z = gl_Position.w - 0.00001;\n    vViewDir = aPosition;\n    vViewDir.x *= -1.0;\n}\n",te.shaderChunks.skyboxHDRPS="varying vec3 vViewDir;\nuniform samplerCube texture_cubeMap;\nvoid main(void) {\n    vec3 color = processEnvironment($textureCubeSAMPLE(texture_cubeMap, fixSeamsStatic(vViewDir, $FIXCONST)).rgb);\n    color = toneMap(color);\n    color = gammaCorrectOutput(color);\n    gl_FragColor = vec4(color, 1.0);\n}\n",te.shaderChunks.skyboxPrefilteredCubePS="varying vec3 vViewDir;\nuniform samplerCube texture_cubeMap;\nvec3 fixSeamsStretch(vec3 vec, float mipmapIndex, float cubemapSize) {\n    float scale = 1.0 - exp2(mipmapIndex) / cubemapSize;\n    float M = max(max(abs(vec.x), abs(vec.y)), abs(vec.z));\n    if (abs(vec.x) != M) vec.x *= scale;\n    if (abs(vec.y) != M) vec.y *= scale;\n    if (abs(vec.z) != M) vec.z *= scale;\n    return vec;\n}\nvoid main(void) {\n    vec3 color = textureCubeRGBM(texture_cubeMap, fixSeamsStretch(vViewDir, 0.0, 128.0));\n    color = toneMap(color);\n    color = gammaCorrectOutput(color);\n    gl_FragColor = vec4(color, 1.0);\n}\n",te.shaderChunks.specularPS="#ifdef MAPCOLOR\nuniform vec3 material_specular;\n#endif\n#ifdef MAPTEXTURE\nuniform sampler2D texture_specularMap;\n#endif\nvoid getSpecularity() {\n    dSpecularity = vec3(1.0);\n    #ifdef MAPCOLOR\n        dSpecularity *= material_specular;\n    #endif\n    #ifdef MAPTEXTURE\n        dSpecularity *= texture2D(texture_specularMap, $UV).$CH;\n    #endif\n    #ifdef MAPVERTEX\n        dSpecularity *= saturate(vVertexColor.$VC);\n    #endif\n}\n",te.shaderChunks.specularAaNonePS="float antiAliasGlossiness(float power) {\n    return power;\n}\n",te.shaderChunks.specularAaToksvigPS="float antiAliasGlossiness(float power) {\n    float rlen = 1.0 / saturate(length(dNormalMap));\n    float toksvig = 1.0 / (1.0 + power * (rlen - 1.0));\n    return power * toksvig;\n}\n",te.shaderChunks.specularAaToksvigFloatPS="float antiAliasGlossiness(float power) {\n    float rlen = 1.0 / saturate(length(dNormalMap));\n    float toksvig = 1.0 / (1.0 + power * (rlen - 1.0));\n    return power * mix(1.0, toksvig, material_bumpiness);\n}\n",te.shaderChunks.spotPS="float getSpotEffect(vec3 lightSpotDirW, float lightInnerConeAngle, float lightOuterConeAngle) {\n    float cosAngle = dot(dLightDirNormW, lightSpotDirW);\n    return smoothstep(lightOuterConeAngle, lightInnerConeAngle, cosAngle);\n}\n",te.shaderChunks.startPS="\nvoid main(void) {\n    dDiffuseLight = vec3(0);\n    dSpecularLight = vec3(0);\n    dReflection = vec4(0);\n    dSpecularity = vec3(0);\n",te.shaderChunks.startVS="\nvoid main(void) {\n    gl_Position = getPosition();\n",te.shaderChunks.startNineSlicedPS="    nineSlicedUv = vUv0;\n",te.shaderChunks.startNineSlicedTiledPS="\n    vec2 tileMask = step(vMask, vec2(0.99999));\n    vec2 clampedUv = mix(innerOffset.xy*0.5, vec2(1.0) - innerOffset.zw*0.5, fract(vTiledUv));\n    clampedUv = clampedUv * atlasRect.zw + atlasRect.xy;\n    nineSlicedUv = vUv0 * tileMask + clampedUv * (vec2(1.0) - tileMask);\n",te.shaderChunks.storeEVSMPS="float exponent = VSM_EXPONENT;\ndepth = 2.0 * depth - 1.0;\ndepth =  exp(exponent * depth);\ngl_FragColor = vec4(depth, depth*depth, 1.0, 1.0);\n",te.shaderChunks.tangentBinormalVS="\nvec3 getTangent() {\n    return normalize(dNormalMatrix * vertex_tangent.xyz);\n}\nvec3 getBinormal() {\n    return cross(vNormalW, vTangentW) * vertex_tangent.w;\n}\n",te.shaderChunks.tonemappingAcesPS="uniform float exposure;\nvec3 toneMap(vec3 color) {\n    float tA = 2.51;\n    float tB = 0.03;\n    float tC = 2.43;\n    float tD = 0.59;\n    float tE = 0.14;\n    vec3 x = color * exposure;\n    return (x*(tA*x+tB))/(x*(tC*x+tD)+tE);\n}\n",te.shaderChunks.tonemappingAces2PS="uniform float exposure;\n// ACES approximation by Stephen Hill\n// sRGB => XYZ => D65_2_D60 => AP1 => RRT_SAT\nconst mat3 ACESInputMat = mat3(\n    0.59719, 0.35458, 0.04823,\n    0.07600, 0.90834, 0.01566,\n    0.02840, 0.13383, 0.83777\n);\n// ODT_SAT => XYZ => D60_2_D65 => sRGB\nconst mat3 ACESOutputMat = mat3(\n     1.60475, -0.53108, -0.07367,\n    -0.10208,  1.10813, -0.00605,\n    -0.00327, -0.07276,  1.07602\n);\nvec3 RRTAndODTFit(vec3 v) {\n    vec3 a = v * (v + 0.0245786) - 0.000090537;\n    vec3 b = v * (0.983729 * v + 0.4329510) + 0.238081;\n    return a / b;\n}\nvec3 toneMap(vec3 color) {\n    color *= exposure;\n    color = color * ACESInputMat;\n    // Apply RRT and ODT\n    color = RRTAndODTFit(color);\n    color = color * ACESOutputMat;\n    // Clamp to [0, 1]\n    color = clamp(color, 0.0, 1.0);\n    return color;\n}\n",te.shaderChunks.tonemappingFilmicPS="const float A =  0.15;\nconst float B =  0.50;\nconst float C =  0.10;\nconst float D =  0.20;\nconst float E =  0.02;\nconst float F =  0.30;\nconst float W =  11.2;\nuniform float exposure;\nvec3 uncharted2Tonemap(vec3 x) {\n   return ((x*(A*x+C*B)+D*E)/(x*(A*x+B)+D*F))-E/F;\n}\nvec3 toneMap(vec3 color) {\n    color = uncharted2Tonemap(color * exposure);\n    vec3 whiteScale = 1.0 / uncharted2Tonemap(vec3(W,W,W));\n    color = color * whiteScale;\n    return color;\n}\n",te.shaderChunks.tonemappingHejlPS="uniform float exposure;\nvec3 toneMap(vec3 color) {\n    color *= exposure;\n    const float  A = 0.22, B = 0.3, C = .1, D = 0.2, E = .01, F = 0.3;\n    const float Scl = 1.25;\n    vec3 h = max( vec3(0.0), color - vec3(0.004) );\n    return (h*((Scl*A)*h+Scl*vec3(C*B,C*B,C*B))+Scl*vec3(D*E,D*E,D*E)) / (h*(A*h+vec3(B,B,B))+vec3(D*F,D*F,D*F)) - Scl*vec3(E/F,E/F,E/F);\n}\n",te.shaderChunks.tonemappingLinearPS="uniform float exposure;\nvec3 toneMap(vec3 color) {\n    return color * exposure;\n}\n",te.shaderChunks.tonemappingNonePS="vec3 toneMap(vec3 color) {\n    return color;\n}\n",te.shaderChunks.transformVS="#ifdef PIXELSNAP\n    uniform vec4 uScreenSize;\n#endif\nmat4 getModelMatrix() {\n    #ifdef DYNAMICBATCH\n        return getBoneMatrix(vertex_boneIndices);\n    #elif defined(SKIN)\n        return matrix_model * (getBoneMatrix(vertex_boneIndices.x) * vertex_boneWeights.x +\n               getBoneMatrix(vertex_boneIndices.y) * vertex_boneWeights.y +\n               getBoneMatrix(vertex_boneIndices.z) * vertex_boneWeights.z +\n               getBoneMatrix(vertex_boneIndices.w) * vertex_boneWeights.w);\n    #elif defined(INSTANCING)\n        return mat4(instance_line1, instance_line2, instance_line3, instance_line4);\n    #else\n        return matrix_model;\n    #endif\n}\nvec4 getPosition() {\n    dModelMatrix = getModelMatrix();\n    vec3 localPos = vertex_position;\n    #ifdef NINESLICED\n        // outer and inner vertices are at the same position, scale both\n        localPos.xz *= outerScale;\n        // offset inner vertices inside\n        // (original vertices must be in [-1;1] range)\n        vec2 positiveUnitOffset = clamp(vertex_position.xz, vec2(0.0), vec2(1.0));\n        vec2 negativeUnitOffset = clamp(-vertex_position.xz, vec2(0.0), vec2(1.0));\n        localPos.xz += (-positiveUnitOffset * innerOffset.xy + negativeUnitOffset * innerOffset.zw) * vertex_texCoord0.xy;\n        vTiledUv = (localPos.xz - outerScale + innerOffset.xy) * -0.5 + 1.0; // uv = local pos - inner corner\n        localPos.xz *= -0.5; // move from -1;1 to -0.5;0.5\n        localPos = localPos.xzy;\n    #endif\n    vec4 posW = dModelMatrix * vec4(localPos, 1.0);\n    #ifdef SCREENSPACE\n        posW.zw = vec2(0.0, 1.0);\n    #endif\n    dPositionW = posW.xyz;\n    vec4 screenPos;\n    #ifdef UV1LAYOUT\n        screenPos = vec4(vertex_texCoord1.xy * 2.0 - 1.0, 0.5, 1);\n    #else\n        #ifdef SCREENSPACE\n            screenPos = posW;\n        #else\n            screenPos = matrix_viewProjection * posW;\n        #endif\n        #ifdef PIXELSNAP\n            // snap vertex to a pixel boundary\n            screenPos.xy = (screenPos.xy * 0.5) + 0.5;\n            screenPos.xy *= uScreenSize.xy;\n            screenPos.xy = floor(screenPos.xy);\n            screenPos.xy *= uScreenSize.zw;\n            screenPos.xy = (screenPos.xy * 2.0) - 1.0;\n        #endif\n    #endif\n    return screenPos;\n}\nvec3 getWorldPosition() {\n    return dPositionW;\n}\n",te.shaderChunks.transformDeclVS="attribute vec3 vertex_position;\nuniform mat4 matrix_model;\nuniform mat4 matrix_viewProjection;\nvec3 dPositionW;\nmat4 dModelMatrix;\n",te.shaderChunks.uv0VS="#ifdef NINESLICED\nvec2 getUv0() {\n    vec2 uv = vertex_position.xz;\n    // offset inner vertices inside\n    // (original vertices must be in [-1;1] range)\n    vec2 positiveUnitOffset = clamp(vertex_position.xz, vec2(0.0), vec2(1.0));\n    vec2 negativeUnitOffset = clamp(-vertex_position.xz, vec2(0.0), vec2(1.0));\n    uv += (-positiveUnitOffset * innerOffset.xy + negativeUnitOffset * innerOffset.zw) * vertex_texCoord0.xy;\n    uv = uv * -0.5 + 0.5;\n    uv = uv * atlasRect.zw + atlasRect.xy;\n    vMask = vertex_texCoord0.xy;\n    return uv;\n}\n#else\nvec2 getUv0() {\n    return vertex_texCoord0;\n}\n#endif\n",te.shaderChunks.uv1VS="\nvec2 getUv1() {\n    return vertex_texCoord1;\n}\n",te.shaderChunks.viewDirPS="void getViewDir() {\n    dViewDirW = normalize(view_position - vPositionW);\n}\n",te.shaderChunks.viewNormalVS="\n#ifndef VIEWMATRIX\n#define VIEWMATRIX\nuniform mat4 matrix_view;\n#endif\nvec3 getViewNormal() {\n    return mat3(matrix_view) * vNormalW;\n}\n",te.programlib={gammaCode:function(e,t){return t||(t=te.shaderChunks),e===te.GAMMA_SRGB||e===te.GAMMA_SRGBFAST?t.gamma2_2PS?t.gamma2_2PS:te.shaderChunks.gamma2_2PS:e===te.GAMMA_SRGBHDR?"#define HDR\n"+(t.gamma2_2PS?t.gamma2_2PS:te.shaderChunks.gamma2_2PS):t.gamma1_0PS?t.gamma1_0PS:te.shaderChunks.gamma1_0PS},tonemapCode:function(e,t){return t||(t=te.shaderChunks),e===te.TONEMAP_FILMIC?t.tonemappingFilmicPS?t.tonemappingFilmicPS:te.shaderChunks.tonemappingFilmicPS:e===te.TONEMAP_LINEAR?t.tonemappingLinearPS?t.tonemappingLinearPS:te.shaderChunks.tonemappingLinearPS:e===te.TONEMAP_HEJL?t.tonemappingHejlPS?t.tonemappingHejlPS:te.shaderChunks.tonemappingHejlPS:e===te.TONEMAP_ACES?t.tonemappingAcesPS?t.tonemappingAcesPS:te.shaderChunks.tonemappingAcesPS:e===te.TONEMAP_ACES2?t.tonemappingAces2PS?t.tonemappingAces2PS:te.shaderChunks.tonemappingAces2PS:t.tonemapingNonePS?t.tonemapingNonePS:te.shaderChunks.tonemappingNonePS},fogCode:function(e,t){return t||(t=te.shaderChunks),"linear"===e?t.fogLinearPS?t.fogLinearPS:te.shaderChunks.fogLinearPS:"exp"===e?t.fogExpPS?t.fogExpPS:te.shaderChunks.fogExpPS:"exp2"===e?t.fogExp2PS?t.fogExp2PS:te.shaderChunks.fogExp2PS:t.fogNonePS?t.fogNonePS:te.shaderChunks.fogNonePS},skinCode:function(e,t){return t||(t=te.shaderChunks),e.supportsBoneTextures?t.skinTexVS:"#define BONE_LIMIT "+e.getBoneLimit()+"\n"+t.skinConstVS},precisionCode:function(e){var t="precision "+e.precision+" float;\n";return e.webgl2&&(t+="#ifdef GL2\nprecision "+e.precision+" sampler2DShadow;\n#endif\n"),t},versionCode:function(e){return e.webgl2?"#version 300 es\n":""},dummyFragmentCode:function(){return"void main(void) {gl_FragColor = vec4(0.0);}"},begin:function(){return"void main(void)\n{\n"},end:function(){return"}\n"}},te.programlib.basic={generateKey:function(e){var t="basic";return e.fog&&(t+="_fog"),e.alphaTest&&(t+="_atst"),e.vertexColors&&(t+="_vcol"),e.diffuseMap&&(t+="_diff"),t+"_"+e.pass},createShaderDefinition:function(e,t){var i={vertex_position:te.SEMANTIC_POSITION};t.skin&&(i.vertex_boneWeights=te.SEMANTIC_BLENDWEIGHT,i.vertex_boneIndices=te.SEMANTIC_BLENDINDICES),t.vertexColors&&(i.vertex_color=te.SEMANTIC_COLOR),t.diffuseMap&&(i.vertex_texCoord0=te.SEMANTIC_TEXCOORD0);var s,n=te.shaderChunks;s=""+n.transformDeclVS,t.skin?(s+=te.programlib.skinCode(e),s+=n.transformSkinnedVS):s+=n.transformVS,t.vertexColors&&(s+="attribute vec4 vertex_color;\nvarying vec4 vColor;\n"),t.diffuseMap&&(s+="attribute vec2 vertex_texCoord0;\nvarying vec2 vUv0;\n"),t.pass===te.SHADER_DEPTH&&(s+="varying float vDepth;\n#ifndef VIEWMATRIX\n#define VIEWMATRIX\nuniform mat4 matrix_view;\n#endif\n#ifndef CAMERAPLANES\n#define CAMERAPLANES\nuniform vec4 camera_params;\n\n#endif\n"),s+=te.programlib.begin(),s+="   gl_Position = getPosition();\n",t.pass===te.SHADER_DEPTH&&(s+="    vDepth = -(matrix_view * vec4(getWorldPosition(),1.0)).z * camera_params.x;\n"),t.vertexColors&&(s+="    vColor = vertex_color;\n"),t.diffuseMap&&(s+="    vUv0 = vertex_texCoord0;\n");var a=s+=te.programlib.end();return s=te.programlib.precisionCode(e),s=t.vertexColors?s+"varying vec4 vColor;\n":s+"uniform vec4 uColor;\n",t.diffuseMap&&(s+="varying vec2 vUv0;\nuniform sampler2D texture_diffuseMap;\n"),t.fog&&(s+=te.programlib.fogCode(t.fog)),t.alphatest&&(s+=n.alphaTestPS),t.pass===te.SHADER_DEPTH&&(s=s+"varying float vDepth;\n"+n.packDepthPS),s+=te.programlib.begin(),s=t.vertexColors?s+"    gl_FragColor = vColor;\n":s+"    gl_FragColor = uColor;\n",t.diffuseMap&&(s+="    gl_FragColor *= texture2D(texture_diffuseMap, vUv0);\n"),t.alphatest&&(s+="   alphaTest(gl_FragColor.a);\n"),t.pass!==te.SHADER_PICK&&(t.pass===te.SHADER_DEPTH?s+="    gl_FragColor = packFloat(vDepth);\n":t.fog&&(s+="   glFragColor.rgb = addFog(gl_FragColor.rgb);\n")),{attributes:i,vshader:a,fshader:s+=te.programlib.end()}}},te.programlib.particle={generateKey:function(e){var t,i="particle";for(t in e)e.hasOwnProperty(t)&&(i+=e[t]);return i},_animTex:function(e,t){return""+(e.animTexLoop?t.particleAnimFrameLoopVS:t.particleAnimFrameClampVS)+t.particleAnimTexVS},createShaderDefinition:function(e,t){var i=te.shaderChunks,s="",n=te.programlib.precisionCode(e)+"\n";e.webgl2&&(s+="#define GL2\n",n+="#define GL2\n"),s+="#define VERTEXSHADER\n",t.mesh&&(s+="#define USE_MESH\n"),t.localSpace&&(s+="#define LOCAL_SPACE\n"),t.animTex&&(s+="\nuniform vec4 animTexParams;\n"),2==t.normal&&(s+="\nvarying mat3 ParticleMat;\n"),1==t.normal&&(s+="\nvarying vec3 Normal;\n"),t.soft&&(s+="\nvarying float vDepth;\n");var a=t.customFace?i.particle_customFaceVS:i.particle_billboardVS;return t.useCpu?(0<t.soft&&(s+=i.screenDepthPS),s+=i.particle_cpuVS,t.localSpace&&(s+=i.particle_localShiftVS),t.animTex&&(s+=this._animTex(t,i)),t.alignToMotion&&(s+=i.particle_pointAlongVS),s+=t.mesh?i.particle_meshVS:a,1==t.normal&&(s+=i.particle_normalVS),2==t.normal&&(s+=i.particle_TBNVS),0<t.stretch&&(s+=i.particle_stretchVS),s+=i.particle_cpu_endVS):(s+=i.particle_initVS,s+=t.pack8?i.particleInputRgba8PS:i.particleInputFloatPS,0<t.soft&&(s+=i.screenDepthPS),s+=i.particleVS,t.localSpace&&(s+=i.particle_localShiftVS),t.animTex&&(s+=this._animTex(t,i)),t.wrap&&(s+=i.particle_wrapVS),t.alignToMotion&&(s+=i.particle_pointAlongVS),s+=t.mesh?i.particle_meshVS:a,1==t.normal&&(s+=i.particle_normalVS),2==t.normal&&(s+=i.particle_TBNVS),0<t.stretch&&(s+=i.particle_stretchVS),s+=i.particle_endVS),0<t.soft&&(s+=i.particle_softVS),s+="}\n",0<t.normal&&(1==t.normal?n+="\nvarying vec3 Normal;\n":2==t.normal&&(n+="\nvarying mat3 ParticleMat;\n"),n+="\nuniform vec3 lightCube[6];\n"),t.soft&&(n+="\nvarying float vDepth;\n"),0===t.normal&&"none"===t.fog&&(t.srgb=!1),n+=te.programlib.gammaCode(t.gamma),n+=te.programlib.tonemapCode(t.toneMap),n="linear"===t.fog?n+i.fogLinearPS:"exp"===t.fog?n+i.fogExpPS:"exp2"===t.fog?n+i.fogExp2PS:n+i.fogNonePS,2==t.normal&&(n+="\nuniform sampler2D normalMap;\n"),0<t.soft&&(n+=i.screenDepthPS),n+=i.particlePS,0<t.soft&&(n+=i.particle_softPS),1==t.normal&&(n+="\nvec3 normal = Normal;\n"),2==t.normal&&(n+=i.particle_normalMapPS),0<t.normal&&(n+=t.halflambert?i.particle_halflambertPS:i.particle_lambertPS),0<t.normal&&(n+=i.particle_lightingPS),t.blend==te.BLEND_NORMAL?n+=i.particle_blendNormalPS:t.blend==te.BLEND_ADDITIVE?n+=i.particle_blendAddPS:t.blend==te.BLEND_MULTIPLICATIVE&&(n+=i.particle_blendMultiplyPS),n+=i.particle_endPS,{attributes:te.shaderChunks.collectAttribs(s),vshader:s,fshader:n}}};var we,Oe,Re,Le,De,Ne,Fe,Be,ke,Ve,Ue,ze,He,je,Ge,We,Ye,Xe,qe,Ke,Ze,Qe,$e,Je,et,tt,it,st,nt,at,rt,ot,ht,lt,ct,dt,ut,pt,ft,mt,_t,gt,yt,vt,bt,St,Tt,Et,xt=function(e,t,i){return"\n#ifdef MAPFLOAT\n"+e+"\n#else\n"+te.shaderChunks[t]+"\n#endif\n"},At=function(e,t,i){return"\n#ifdef MAPCOLOR\n"+e+"\n#else\n"+te.shaderChunks[t]+"\n#endif\n"},Mt=function(e,t,i){return"\n#ifdef MAPTEXTURE\n"+e+"\n#else\n"+te.shaderChunks[t]+"\n#endif\n"},Ct=function(e,t,i){return"#undef MAPTEXTURECOLOR\n#ifdef MAPTEXTURE\n#ifdef MAPCOLOR\n#define MAPTEXTURECOLOR\n#endif\n#endif\n#ifdef MAPTEXTURECOLOR\n"+e+"\n#else\n"+te.shaderChunks[t]+"\n#endif\n"},Pt=function(e,t,i){return"#undef MAPTEXTUREFLOAT\n#ifdef MAPTEXTURE\n#ifdef MAPFLOAT\n#define MAPTEXTUREFLOAT\n#endif\n#endif\n#ifdef MAPTEXTUREFLOAT\n"+e+"\n#else\n"+te.shaderChunks[t]+"\n#endif\n"},It=function(e,t,i){return"\n#ifdef MAPVERTEX\n"+e+"\n#else\n"+te.shaderChunks[t]+"\n#endif\n"},wt=function(e,t,i){return"#undef MAPVERTEXCOLOR\n#ifdef MAPVERTEX\n#ifdef MAPCOLOR\n#define MAPVERTEXCOLOR\n#endif\n#endif\n#ifdef MAPVERTEXCOLOR\n"+e+"\n#else\n"+te.shaderChunks[t]+"\n#endif\n"},Ot=function(e,t,i){return"#undef MAPVERTEXFLOAT\n#ifdef MAPVERTEX\n#ifdef MAPFLOAT\n#define MAPVERTEXFLOAT\n#endif\n#endif\n#ifdef MAPVERTEXFLOAT\n"+e+"\n#else\n"+te.shaderChunks[t]+"\n#endif\n"};te.programlib.standard={_oldChunkToNew:{aoTexPS:{n:"aoPS",f:Mt},aoVertPS:{n:"aoPS",f:It},diffuseConstPS:{n:"diffusePS",f:At},diffuseTexPS:{n:"diffusePS",f:Mt},diffuseTexConstPS:{n:"diffusePS",f:Ct},diffuseVertPS:{n:"diffusePS",f:It},diffuseVertConstPS:{n:"diffusePS",f:wt},emissiveConstPS:{n:"emissivePS",f:At},emissiveTexPS:{n:"emissivePS",f:Mt},emissiveTexConstPS:{n:"emissivePS",f:Ct},emissiveTexConstFloatPS:{n:"emissivePS",f:Pt},emissiveVertPS:{n:"emissivePS",f:It},emissiveVertConstPS:{n:"emissivePS",f:wt},emissiveVertConstFloatPS:{n:"emissivePS",f:Ot},glossConstPS:{n:"glossPS",f:xt},glossTexPS:{n:"glossPS",f:Mt},glossTexConstPS:{n:"glossPS",f:Pt},glossVertPS:{n:"glossPS",f:It},glossVertConstPS:{n:"glossPS",f:Ot},metalnessConstPS:{n:"metalnessPS",f:xt},metalnessTexPS:{n:"metalnessPS",f:Mt},metalnessTexConstPS:{n:"metalnessPS",f:Pt},metalnessVertPS:{n:"metalnessPS",f:It},metalnessVertConstPS:{n:"metalnessPS",f:Ot},opacityConstPS:{n:"opacityPS",f:xt},opacityTexPS:{n:"opacityPS",f:Mt},opacityTexConstPS:{n:"opacityPS",f:Pt},opacityVertPS:{n:"opacityPS",f:It},opacityVertConstPS:{n:"opacityPS",f:Ot},specularConstPS:{n:"specularPS",f:At},specularTexPS:{n:"specularPS",f:Mt},specularTexConstPS:{n:"specularPS",f:Ct},specularVertPS:{n:"specularPS",f:It},specularVertConstPS:{n:"specularPS",f:wt},transformBatchSkinnedVS:{n:"transformVS",f:function(e,t,i){return"\n#ifdef DYNAMICBATCH\n"+e+"\n#else\n"+te.shaderChunks[t]+"\n#endif\n"}},transformInstancedVS:{n:"transformVS",f:function(e,t,i){return"\n#ifdef INSTANCING\n"+e+"\n#else\n"+te.shaderChunks[t]+"\n#endif\n"}},transformPixelSnapVS:{n:"transformVS",f:function(e,t,i){return"\n#ifdef PIXELSNAP\n"+e+"\n#else\n"+te.shaderChunks[t]+"\n#endif\n"}},transformScreenSpaceVS:{n:"transformVS",f:function(e,t,i){return"\n#ifdef SCREENSPACE\n"+e+"\n#else\n"+te.shaderChunks[t]+"\n#endif\n"}},transformScreenSpaceBatchSkinned:{n:"transformVS",f:function(e,t,i){return"#undef SCREENSPACEBATCH\n#ifdef SCREENSPACE\n#ifdef BATCH\n#define SCREENSPACEBATCH\n#endif\n#endif\n#ifdef SCREENSPACEBATCH\n"+e+"\n#else\n"+te.shaderChunks[t]+"\n#endif\n"}},transformSkinned:{n:"transformVS",f:function(e,t,i){return"\n#ifdef SKIN\n"+e+"\n#else\n"+te.shaderChunks[t]+"\n#endif\n"}},transformUv1:{n:"transformVS",f:function(e,t,i){return"\n#ifdef UV1LAYOUT\n"+e+"\n#else\n"+te.shaderChunks[t]+"\n#endif\n"}}},optionsContext:{},optionsContextMin:{},generateKey:function(e){var t,i=function(e){var t,i=[];for(t in e)e.hasOwnProperty(t)&&"chunks"!==t&&"lights"!==t&&i.push(t);return i.sort()};t=e===this.optionsContextMin?(this.propsMin||(this.propsMin=i(e)),this.propsMin):e===this.optionsContext?(this.props||(this.props=i(e)),this.props):i(e);var s;i="standard";for(s=0;s<t.length;s++)e[t[s]]&&(i+=t[s]+e[t[s]]);if(e.chunks){for(var n in t=[],e.chunks)e.chunks.hasOwnProperty(n)&&t.push(n+e.chunks[n]);t.sort(),i+=t}if(e.lights)for(s=0;s<e.lights.length;s++)i+=e.lights[s].key;return te.hashCode(i)},_correctChannel:function(e,t){if(0<te._matTex2D[e]){if(te._matTex2D[e]<t.length)return t.substring(0,te._matTex2D[e]);if(te._matTex2D[e]>t.length){for(var i=t,s=i.charAt(i.length-1),n=te._matTex2D[e]-i.length,a=0;a<n;a++)i+=s;return i}return t}},_setMapTransform:function(e,t,i,s){e[0]+="uniform vec4 texture_"+t+"MapTransform;\n";var n=i+100*s;return e[3][n]||(e[1]+="varying vec2 vUV"+s+"_"+i+";\n",e[2]+="   vUV"+s+"_"+i+" = uv"+s+" * texture_"+t+"MapTransform.xy + texture_"+t+"MapTransform.zw;\n",e[3][n]=!0),e},_getUvSourceExpression:function(e,t,i){var s=i[e];return t=i[t],i.nineSlicedMode===te.SPRITE_RENDERMODE_SLICED?s="nineSlicedUv":i.nineSlicedMode===te.SPRITE_RENDERMODE_TILED?s="nineSlicedUv, -1000.0":(s=0===s?"vUv"+t:"vUV"+t+"_"+s,i.heightMap&&"heightMapTransform"!==e&&(s+=" + dUvOffset")),s},_addMapDef:function(e,t){var i="\n#undef "+e+"\n";return t&&(i+=" #define "+e+"\n"),i},_addMapDefs:function(e,t,i,s){return e=""+this._addMapDef("MAPFLOAT",e),e+=this._addMapDef("MAPCOLOR",t),(e+=this._addMapDef("MAPVERTEX",i))+this._addMapDef("MAPTEXTURE",s)},_addMap:function(e,t,i,s,n){var a=e+"Map",r=a+"Uv",o=a+"Transform",h=a+"Channel",l=e+"VertexColorChannel",c=i[e+"Tint"];return e=i[e+"VertexColor"],a=i[a],t=s[t],a&&(r=this._getUvSourceExpression(o,r,i),t=t.replace(/\$UV/g,r).replace(/\$CH/g,i[h]),void 0!==n&&(t=t.replace(/\$texture2DSAMPLE/g,0===n?"texture2DSRGB":1===n?"texture2DRGBM":"texture2D"))),e&&(t=t.replace(/\$VC/g,i[l])),(t=this._addMapDefs(1===c,3===c,e,a)+t).replace(/\$/g,"")},_nonPointShadowMapProjection:function(e,t,i){return!t._normalOffsetBias||t._isVsm?t._type===te.LIGHTTYPE_SPOT?t._isPcf&&(e.webgl2||e.extStandardDerivatives)?"       getShadowCoordPerspZbuffer"+i:"       getShadowCoordPersp"+i:"       getShadowCoordOrtho"+i:t._type===te.LIGHTTYPE_SPOT?t._isPcf&&(e.webgl2||e.extStandardDerivatives)?"       getShadowCoordPerspZbufferNormalOffset"+i:"       getShadowCoordPerspNormalOffset"+i:"       getShadowCoordOrthoNormalOffset"+i},_addVaryingIfNeeded:function(e,t,i){return 0<=e.indexOf(i)?"varying "+t+" "+i+";\n":""},_vsAddTransformCode:function(e,t,i,s){return e+i.transformVS},_vsAddBaseCode:function(e,t,i,s){return e+=i.baseVS,s.nineSlicedMode!==te.SPRITE_RENDERMODE_SLICED&&s.nineSlicedMode!==te.SPRITE_RENDERMODE_TILED||(e+=i.baseNineSlicedVS),e},_fsAddBaseCode:function(e,t,i,s){return e+=i.basePS,s.nineSlicedMode===te.SPRITE_RENDERMODE_SLICED?e+=i.baseNineSlicedPS:s.nineSlicedMode===te.SPRITE_RENDERMODE_TILED&&(e+=i.baseNineSlicedTiledPS),e},_fsAddStartCode:function(e,t,i,s){return e+=i.startPS,s.nineSlicedMode===te.SPRITE_RENDERMODE_SLICED?e+=i.startNineSlicedPS:s.nineSlicedMode===te.SPRITE_RENDERMODE_TILED&&(e+=i.startNineSlicedTiledPS),e},createShaderDefinition:function(e,t){var i,s,n=0<t.lights.length;t.dirLightMap&&(n=!0,t.useSpecular=!0),t.shadingModel===te.SPECULAR_PHONG?(t.fresnelModel=0,t.specularAntialias=!1,t.prefilteredCubemap=!1,t.dpAtlas=!1,t.ambientSH=!1):t.fresnelModel=0===t.fresnelModel?te.FRESNEL_SCHLICK:t.fresnelModel;var a=(t.cubeMap||t.prefilteredCubemap&&t.useSpecular)&&!t.sphereMap&&!t.dpAtlas,r=t.sphereMap||a||t.dpAtlas,o=t.useTexCubeLod;t.cubeMap&&(t.sphereMap=null),t.dpAtlas&&(t.prefilteredCubemap=null),t.useSpecular||(t.specularMap=t.glossMap=null);var h=n||r||t.ambientSH||t.prefilteredCubemap||t.heightMap,l=t.pass>=te.SHADER_SHADOW&&t.pass<=17;this.options=t;var c,d="",u="",p="",f=te.shaderChunks,m={vertex_position:te.SEMANTIC_POSITION};if(t.chunks){var _={};for(s in f)f.hasOwnProperty(s)&&(t.chunks[s]?(0<=(c=t.chunks[s]).indexOf("vertex_normal")&&(m.vertex_normal=te.SEMANTIC_NORMAL),0<=c.indexOf("vertex_tangent")&&(m.vertex_tangent=te.SEMANTIC_TANGENT),0<=c.indexOf("vertex_texCoord0")&&(m.vertex_texCoord0=te.SEMANTIC_TEXCOORD0),0<=c.indexOf("vertex_texCoord1")&&(m.vertex_texCoord1=te.SEMANTIC_TEXCOORD1),0<=c.indexOf("vertex_color")&&(m.vertex_color=te.SEMANTIC_COLOR),0<=c.indexOf("vertex_boneWeights")&&(m.vertex_boneWeights=te.SEMANTIC_BLENDWEIGHT),0<=c.indexOf("vertex_boneIndices")&&(m.vertex_boneIndices=te.SEMANTIC_BLENDINDICES),_[s]=c):_[s]=f[s]);for(s in t.chunks)(f=this._oldChunkToNew[s])&&(_[f.n]=f.f(t.chunks[s],f.n,s));f=_}if(d=this._vsAddBaseCode(d,e,f,t),_=-1,!t.noShadow&&!t.twoSidedLighting){for(i=0;i<t.lights.length;i++)if(c=t.lights[i]._type,t.lights[i].castShadows&&c===te.LIGHTTYPE_DIRECTIONAL){d+="uniform mat4 light"+i+"_shadowMatrixVS;\n",d+="uniform vec3 light"+i+"_shadowParamsVS;\n",d+="uniform vec3 light"+i+(c===te.LIGHTTYPE_DIRECTIONAL?"_directionVS":"_positionVS")+";\n",_=i;break}0<=_&&(d+=f.shadowCoordVS)}u+="   vPositionW    = getWorldPosition();\n",t.pass===te.SHADER_DEPTH&&(d+="varying float vDepth;\n#ifndef VIEWMATRIX\n#define VIEWMATRIX\nuniform mat4 matrix_view;\n#endif\n#ifndef CAMERAPLANES\n#define CAMERAPLANES\nuniform vec4 camera_params;\n\n#endif\n",u+="    vDepth = -(matrix_view * vec4(vPositionW,1.0)).z * camera_params.x;\n"),t.useInstancing&&(m.instance_line1=te.SEMANTIC_TEXCOORD2,m.instance_line2=te.SEMANTIC_TEXCOORD3,m.instance_line3=te.SEMANTIC_TEXCOORD4,m.instance_line4=te.SEMANTIC_TEXCOORD5,d+=f.instancingVS),h&&(m.vertex_normal=te.SEMANTIC_NORMAL,u+="   vNormalW    = dNormalW = getNormal();\n",t.sphereMap&&e.fragmentUniformsCount<=16&&(d+=f.viewNormalVS,u+="   vNormalV    = getViewNormal();\n"),(t.heightMap||t.normalMap)&&t.hasTangents&&(m.vertex_tangent=te.SEMANTIC_TANGENT,d+=f.tangentBinormalVS,u+="   vTangentW   = getTangent();\n   vBinormalW  = getBinormal();\n"),0<=_&&(u=(c=t.lights[_]._type)===te.LIGHTTYPE_DIRECTIONAL?u+"   dLightDirNormW = light"+_+"_directionVS;\n":u+"   getLightDirPoint(light"+_+"_positionVS);\n",u+=this._nonPointShadowMapProjection(e,t.lights[_],"(light"+_+"_shadowMatrixVS, light"+_+"_shadowParamsVS);\n"))),c=[];var g,y,v,b=[];for(s in te._matTex2D)i=s+"Map",t[s+"VertexColor"]&&(t[g=s+"VertexColorChannel"]=this._correctChannel(s,t[g])),t[i]&&(g=i+"Channel",y=i+"Transform",t[v=i+"Uv"]=Math.min(t[v],1),t[g]=this._correctChannel(s,t[g]),c[v=t[v]]=!0,b[v]=b[v]||t[i]&&!t[y]);for(t.forceUv1&&(c[1]=!0),i=0;i<2;i++)c[i]&&(m["vertex_texCoord"+i]=te["SEMANTIC_TEXCOORD"+i],d+=f["uv"+i+"VS"],u+="   vec2 uv"+i+" = getUv"+i+"();\n"),b[i]&&(u+="   vUv"+i+" = uv"+i+";\n");for(s in c=[d,p,u,[]],te._matTex2D)t[i=s+"Map"]&&(t[y=i+"Transform"]&&(v=i+"Uv",this._setMapTransform(c,s,t[y],t[v])));if(d=c[0],p=c[1],u=c[2],t.vertexColors&&(m.vertex_color=te.SEMANTIC_COLOR,u+="   vVertexColor = vertex_color;\n"),t.skin?(m.vertex_boneWeights=te.SEMANTIC_BLENDWEIGHT,m.vertex_boneIndices=te.SEMANTIC_BLENDINDICES,d+=te.programlib.skinCode(e,f),d+="#define SKIN\n"):t.useInstancing&&(d+="#define INSTANCING\n"),t.screenSpace&&(d+="#define SCREENSPACE\n"),t.pixelSnap&&(d+="#define PIXELSNAP\n"),d=this._vsAddTransformCode(d,e,f,t),h&&(d+=f.normalVS),s=d=(d=d+"\n"+f.startVS)+u+"}",c=p,p=""+this._addVaryingIfNeeded(d,"vec4","vMainShadowUv"),p+=this._addVaryingIfNeeded(d,"vec4","vVertexColor"),p+=this._addVaryingIfNeeded(d,"vec3","vPositionW"),p+=this._addVaryingIfNeeded(d,"vec3","vNormalV"),p+=this._addVaryingIfNeeded(d,"vec3","vNormalW"),p+=this._addVaryingIfNeeded(d,"vec3","vTangentW"),p+=this._addVaryingIfNeeded(d,"vec3","vBinormalW"),p+=this._addVaryingIfNeeded(d,"vec2","vUv0"),p+=this._addVaryingIfNeeded(d,"vec2","vUv1"),s=(p+=c)+s,d="",s=e.webgl2?(d=te.programlib.versionCode(e),f.extensionVS&&(d+=f.extensionVS+"\n"),d+f.gles3VS+s):(f.extensionVS&&(d=f.extensionVS+"\n"),d+s),t.forceFragmentPrecision&&"highp"!=t.forceFragmentPrecision&&"mediump"!==t.forceFragmentPrecision&&"lowp"!==t.forceFragmentPrecision&&(t.forceFragmentPrecision=null),t.forceFragmentPrecision&&("highp"===t.forceFragmentPrecision&&"highp"!==e.maxPrecision&&(t.forceFragmentPrecision="mediump"),"mediump"===t.forceFragmentPrecision&&"lowp"===e.maxPrecision&&(t.forceFragmentPrecision="lowp")),d="",e.webgl2&&(d+=te.programlib.versionCode(e)),e.extStandardDerivatives&&!e.webgl2&&(d+="#extension GL_OES_standard_derivatives : enable\n\n"),f.extensionPS&&(d+=f.extensionPS+"\n"),e.webgl2&&(d+=f.gles3PS),d+=t.forceFragmentPrecision?"precision "+t.forceFragmentPrecision+" float;\n\n":te.programlib.precisionCode(e),t.pass===te.SHADER_PICK)return d=d+"uniform vec4 uColor;"+p,t.alphaTest&&(d=d+"float dAlpha;\n"+this._addMap("opacity","opacityPS",t,f),d+=f.alphaTestPS),d+=te.programlib.begin(),t.alphaTest&&(d+="   getOpacity();\n   alphaTest(dAlpha);\n"),{attributes:m,vshader:s,fshader:d=d+"    gl_FragColor = uColor;\n"+te.programlib.end()};if(t.pass===te.SHADER_DEPTH)return d=d+"varying float vDepth;\n"+p+f.packDepthPS,t.alphaTest&&(d+="float dAlpha;\n",d+=this._addMap("opacity","opacityPS",t,f),d+=f.alphaTestPS),d+=te.programlib.begin(),t.alphaTest&&(d+="   getOpacity();\n",d+="   alphaTest(dAlpha);\n"),d+="    gl_FragColor = packFloat(vDepth);\n",{attributes:m,vshader:s,fshader:d+=te.programlib.end()};if(l){a=t.pass-te.SHADER_SHADOW,a-=5*(c=Math.floor(a/5)),e.extStandardDerivatives&&!e.webgl2&&(d+="uniform vec2 polygonOffset;\n"),a===te.SHADOW_VSM32?d=e.textureFloatHighPrecision?d+"#define VSM_EXPONENT 15.0\n\n":d+"#define VSM_EXPONENT 5.54\n\n":a===te.SHADOW_VSM16&&(d+="#define VSM_EXPONENT 5.54\n\n"),c!==te.LIGHTTYPE_DIRECTIONAL&&(d+="uniform vec3 view_position;\n",d+="uniform float light_radius;\n"),d+=p,t.alphaTest&&(d+="float dAlpha;\n",d+=this._addMap("opacity","opacityPS",t,f),d+=f.alphaTestPS),a!==te.SHADOW_PCF3||e.webgl2&&c!==te.LIGHTTYPE_POINT?a===te.SHADOW_VSM8&&(d+="vec2 encodeFloatRG( float v ) {\n",d+="    vec2 enc = vec2(1.0, 255.0) * v;\n",d+="    enc = fract(enc);\n",d+="    enc -= enc.yy * vec2(1.0/255.0, 1.0/255.0);\n",d+="    return enc;\n",d+="}\n\n"):d+=f.packDepthPS,d+=te.programlib.begin(),t.alphaTest&&(d+="   getOpacity();\n",d+="   alphaTest(dAlpha);\n");var S=a===te.SHADOW_VSM8||a===te.SHADOW_VSM16||a===te.SHADOW_VSM32;d=c===te.LIGHTTYPE_POINT||S&&c!==te.LIGHTTYPE_DIRECTIONAL?d+"   float depth = min(distance(view_position, vPositionW) / light_radius, 0.99999);\n":d+"   float depth = gl_FragCoord.z;\n";return a!==te.SHADOW_PCF3||e.webgl2&&c!==te.LIGHTTYPE_POINT?d=a===te.SHADOW_PCF3||a===te.SHADOW_PCF5?d+"   gl_FragColor = vec4(1.0);\n":a===te.SHADOW_VSM8?d+"   gl_FragColor = vec4(encodeFloatRG(depth), encodeFloatRG(depth*depth));\n":d+f.storeEVSMPS:(e.extStandardDerivatives&&!e.webgl2&&(d+="   float minValue = 2.3374370500153186e-10; //(1.0 / 255.0) / (256.0 * 256.0 * 256.0);\n",d+="   depth += polygonOffset.x * max(abs(dFdx(depth)), abs(dFdy(depth))) + minValue * polygonOffset.y;\n"),d+="   gl_FragColor = packFloat(depth);\n"),{attributes:m,vshader:s,fshader:d+=te.programlib.end()}}if(t.customFragmentShader)return{attributes:m,vshader:s,fshader:d+=t.customFragmentShader,tag:te.SHADERTAG_MATERIAL};for(p=d=this._fsAddBaseCode(d+p,e,f,t),d="",g=v=!(y=[]),i=b=0;i<t.lights.length;i++)d+="uniform vec3 light"+i+"_color;\n",(c=(u=t.lights[i])._type)===te.LIGHTTYPE_DIRECTIONAL?d+="uniform vec3 light"+i+"_direction;\n":(d+="uniform vec3 light"+i+"_position;\n",d+="uniform float light"+i+"_radius;\n",c===te.LIGHTTYPE_SPOT&&(d+="uniform vec3 light"+i+"_direction;\n",d+="uniform float light"+i+"_innerConeAngle;\n",d+="uniform float light"+i+"_outerConeAngle;\n")),u.castShadows&&!t.noShadow&&(d+="uniform mat4 light"+i+"_shadowMatrix;\n",d=c!==te.LIGHTTYPE_DIRECTIONAL?d+"uniform vec4 light"+i+"_shadowParams;\n":d+"uniform vec3 light"+i+"_shadowParams;\n",d=c===te.LIGHTTYPE_POINT?d+"uniform samplerCube light"+i+"_shadowMap;\n":u._isPcf&&e.webgl2?d+"uniform sampler2DShadow light"+i+"_shadowMap;\n":d+"uniform sampler2D light"+i+"_shadowMap;\n",b++,y[u._shadowType]=!0,u._isVsm&&(v=!0),u._isPcf&&(e.webgl2||e.extStandardDerivatives)&&c===te.LIGHTTYPE_SPOT&&(g=!0)),u._cookie&&(u._cookie._cubemap?c===te.LIGHTTYPE_POINT&&(d+="uniform samplerCube light"+i+"_cookie;\n",d+="uniform float light"+i+"_cookieIntensity;\n",!u.castShadows||t.noShadow)&&(d+="uniform mat4 light"+i+"_shadowMatrix;\n"):c===te.LIGHTTYPE_SPOT&&(d+="uniform sampler2D light"+i+"_cookie;\n",d+="uniform float light"+i+"_cookieIntensity;\n",u.castShadows&&!t.noShadow||(d+="uniform mat4 light"+i+"_shadowMatrix;\n"),u._cookieTransform&&(d+="uniform vec4 light"+i+"_cookieMatrix;\n",d+="uniform vec2 light"+i+"_cookieOffset;\n")));if(d+="\n",c=t.hasTangents?t.fastTbn?f.TBNfastPS:f.TBNPS:f.TBNderivativePS,h&&(t.normalMap?(d+=t.packedNormal?f.normalXYPS:f.normalXYZPS,i=this._getUvSourceExpression("normalMapTransform","normalMapUv",t),d=t.needsNormalFloat?d+(t.fastTbn?f.normalMapFloatTBNfastPS:f.normalMapFloatPS).replace(/\$UV/g,i):d+f.normalMapPS.replace(/\$UV/g,i),t.hasTangents||(c=c.replace(/\$UV/g,i)),d+=c):d+=f.normalVertexPS),d+=te.programlib.gammaCode(t.gamma,f),d+=te.programlib.tonemapCode(t.toneMap,f),d+=te.programlib.fogCode(t.fog,f),t.useRgbm&&(d+=f.rgbmPS),(a||t.prefilteredCubemap)&&(d+=t.fixSeams?f.fixCubemapSeamsStretchPS:f.fixCubemapSeamsNonePS),h&&(d+=0<t.cubeMapProjection?f.cubeMapProjectBoxPS:f.cubeMapProjectNonePS,d+=t.skyboxIntensity?f.envMultiplyPS:f.envConstPS),d+=this._addMap("diffuse","diffusePS",t,f),(t.blendType!==te.BLEND_NONE||t.alphaTest||t.alphaToCoverage)&&(d+=this._addMap("opacity","opacityPS",t,f)),d+=this._addMap("emissive","emissivePS",t,f,t.emissiveFormat),t.useSpecular&&(n||r)&&(d=t.specularAntialias&&t.normalMap?t.needsNormalFloat&&h?d+f.specularAaToksvigFloatPS:d+f.specularAaToksvigPS:d+f.specularAaNonePS,i=t.useMetalness?"metalness":"specular",d+=this._addMap(i,i+"PS",t,f),d+=this._addMap("gloss","glossPS",t,f),0<t.fresnelModel&&(t.fresnelModel===te.FRESNEL_SIMPLE?d+=f.fresnelSimplePS:t.fresnelModel===te.FRESNEL_SCHLICK?d+=f.fresnelSchlickPS:t.fresnelModel===te.FRESNEL_COMPLEX&&(d+=f.fresnelComplexPS))),t.heightMap&&(t.normalMap||(i=this._getUvSourceExpression("heightMapTransform","heightMapUv",t),t.hasTangents||(c=c.replace(/\$UV/g,i)),d+=c),d+=this._addMap("height","parallaxPS",t,f)),(l=t.aoMap||t.aoVertexColor)&&(d+=this._addMap("ao","aoPS",t,f),t.occludeSpecular&&(d=t.occludeSpecular===te.SPECOCC_AO?d+(t.occludeSpecularFloat?f.aoSpecOccSimplePS:f.aoSpecOccConstSimplePS):d+(t.occludeSpecularFloat?f.aoSpecOccPS:f.aoSpecOccConstPS))),c=t.rgbmReflection?"decodeRGBM":t.hdrReflection?"":"gammaCorrectInput",t.sphereMap?d+=c=(c=16<e.fragmentUniformsCount?f.reflectionSpherePS:f.reflectionSphereLowPS).replace(/\$texture2DSAMPLE/g,t.rgbmReflection?"texture2DRGBM":t.hdrReflection?"texture2D":"texture2DSRGB"):a?d=t.prefilteredCubemap?o?d+f.reflectionPrefilteredCubeLodPS.replace(/\$DECODE/g,c):d+f.reflectionPrefilteredCubePS.replace(/\$DECODE/g,c):d+f.reflectionCubePS.replace(/\$textureCubeSAMPLE/g,t.rgbmReflection?"textureCubeRGBM":t.hdrReflection?"textureCube":"textureCubeSRGB"):t.dpAtlas&&(d+=f.reflectionDpAtlasPS.replace(/\$texture2DSAMPLE/g,t.rgbmReflection?"texture2DRGBM":t.hdrReflection?"texture2D":"texture2DSRGB")),(a||t.sphereMap||t.dpAtlas)&&t.refraction&&(d+=f.refractionPS),0<b&&(y[te.SHADOW_PCF3]&&(d+=f.shadowStandardPS),y[te.SHADOW_PCF5]&&(d+=f.shadowStandardGL2PS),v&&(d+=f.shadowVSM_commonPS,y[te.SHADOW_VSM8]&&(d+=f.shadowVSM8PS),y[te.SHADOW_VSM16]&&(d+=e.extTextureHalfFloatLinear?f.shadowEVSMPS.replace(/\$/g,"16"):f.shadowEVSMnPS.replace(/\$/g,"16")),y[te.SHADOW_VSM32]&&(d+=e.extTextureFloatLinear?f.shadowEVSMPS.replace(/\$/g,"32"):f.shadowEVSMnPS.replace(/\$/g,"32"))),e.webgl2||e.extStandardDerivatives||(d+=f.biasConstPS),d+=f.shadowCoordPS+f.shadowCommonPS,g&&(d+=f.shadowCoordPerspZbufferPS),0<=_&&(y[te.SHADOW_PCF3]&&(d+=f.shadowStandardVSPS),y[te.SHADOW_PCF5]&&(d+=f.shadowStandardGL2VSPS),v&&(y[te.SHADOW_VSM8]&&(d+=f.shadowVSMVSPS.replace(/\$VSM/g,"VSM8").replace(/\$/g,"8")),y[te.SHADOW_VSM16]&&(d+=f.shadowVSMVSPS.replace(/\$VSM/g,"VSM16").replace(/\$/g,"16")),y[te.SHADOW_VSM32]&&(d+=f.shadowVSMVSPS.replace(/\$VSM/g,"VSM32").replace(/\$/g,"32"))))),n&&(d+=f.lightDiffuseLambertPS),c=!1,t.useSpecular?(n&&(d+=t.shadingModel===te.SPECULAR_PHONG?f.lightSpecularPhongPS:f.lightSpecularBlinnPS),t.sphereMap||a||t.dpAtlas||0<t.fresnelModel?d=0<t.fresnelModel?t.conserveEnergy?d+f.combineDiffuseSpecularPS:d+f.combineDiffuseSpecularNoConservePS:d+f.combineDiffuseSpecularOldPS:t.diffuseMap?d+=f.combineDiffuseSpecularNoReflPS:(d+=f.combineDiffuseSpecularNoReflSeparateAmbientPS,c=!0)):d+=f.combineDiffusePS,i=!0,(t.lightMap||t.lightVertexColor)&&(d+=this._addMap("light",t.dirLightMap?"lightmapDirPS":"lightmapSinglePS",t,f,t.lightMapFormat),i=t.lightMapWithoutAmbient),i&&(u=t.rgbmAmbient?"decodeRGBM":t.hdrAmbient?"":"gammaCorrectInput",d=t.ambientSH?d+f.ambientSHPS:t.prefilteredCubemap?o?d+f.ambientPrefilteredCubeLodPS.replace(/\$DECODE/g,u):d+f.ambientPrefilteredCubePS.replace(/\$DECODE/g,u):d+f.ambientConstantPS),t.ambientTint&&!c&&(d+="uniform vec3 material_ambient;\n"),t.alphaTest&&(d+=f.alphaTestPS),t.msdf&&(d+=f.msdfPS),h&&(d+=f.viewDirPS,t.useSpecular&&(d+=f.reflDirPS)),g=v=y=b=o=!1,d=this._fsAddStartCode(d,e,f,t),h&&(d=t.twoSidedLighting?d+"   dVertexNormalW = gl_FrontFacing ? vNormalW : -vNormalW;\n":d+"   dVertexNormalW = vNormalW;\n",(t.heightMap||t.normalMap)&&t.hasTangents&&(t.twoSidedLighting?(d+="   dTangentW = gl_FrontFacing ? vTangentW : -vTangentW;\n",d+="   dBinormalW = gl_FrontFacing ? vBinormalW : -vBinormalW;\n"):(d+="   dTangentW = vTangentW;\n",d+="   dBinormalW = vBinormalW;\n"))),u=!1,t.blendType!==te.BLEND_NONE||t.alphaTest||t.alphaToCoverage?t.heightMap&&t.opacityMap?u=!0:(d+="   getOpacity();\n",t.alphaTest&&(d+="   alphaTest(dAlpha);\n")):d+="   dAlpha = 1.0;\n",h&&(d+="   getViewDir();\n",(t.heightMap||t.normalMap)&&(d+="   getTBN();\n"),t.heightMap&&(d+="   getParallax();\n"),u&&(d+="   getOpacity();\n",t.alphaTest&&(d+="   alphaTest(dAlpha);\n")),d+="   getNormal();\n",t.useSpecular&&(d+="   getReflDir();\n")),d+="   getAlbedo();\n",(n&&t.useSpecular||r)&&(d+="   getSpecularity();\n",d+="   getGlossiness();\n",0<t.fresnelModel&&(d+="   getFresnel();\n")),i&&(d+="   addAmbient();\n"),t.ambientTint&&!c&&(d+="   dDiffuseLight *= material_ambient;\n"),l&&!t.occludeDirect&&(d+="    applyAO();\n"),(t.lightMap||t.lightVertexColor)&&(d+="   addLightMap();\n"),n||r){for((a||t.sphereMap||t.dpAtlas)&&(d+="   addReflection();\n"),t.dirLightMap&&(d+="   addDirLightMap();\n"),i=0;i<t.lights.length;i++)r=!1,(c=(u=t.lights[i])._type)===te.LIGHTTYPE_DIRECTIONAL?(d+="   dLightDirNormW = light"+i+"_direction;\n",d+="   dAtten = 1.0;\n"):(u._cookie&&(c!==te.LIGHTTYPE_SPOT||u._cookie._cubemap?c===te.LIGHTTYPE_POINT&&u._cookie._cubemap&&(r=g=!0):r=g=!0),d+="   getLightDirPoint(light"+i+"_position);\n",o=!0,r&&(d=c===te.LIGHTTYPE_SPOT?d+"   dAtten3 = getCookie2D"+(u._cookieFalloff?"":"Clip")+(u._cookieTransform?"Xform":"")+"(light"+i+"_cookie, light"+i+"_shadowMatrix, light"+i+"_cookieIntensity"+(u._cookieTransform?", light"+i+"_cookieMatrix, light"+i+"_cookieOffset":"")+")."+u._cookieChannel+";\n":d+"   dAtten3 = getCookieCube(light"+i+"_cookie, light"+i+"_shadowMatrix, light"+i+"_cookieIntensity)."+u._cookieChannel+";\n"),u._falloffMode===te.LIGHTFALLOFF_LINEAR?(d+="   dAtten = getFalloffLinear(light"+i+"_radius);\n",b=!0):(d+="   dAtten = getFalloffInvSquared(light"+i+"_radius);\n",y=!0),d+="   if (dAtten > 0.00001) {\n",c!==te.LIGHTTYPE_SPOT||r&&!u._cookieFalloff||(d+="       dAtten *= getSpotEffect(light"+i+"_direction, light"+i+"_innerConeAngle, light"+i+"_outerConeAngle);\n",v=!0)),d+="       dAtten *= getLightDiffuse();\n",u.castShadows&&!t.noShadow&&(u._shadowType===te.SHADOW_VSM8?(h="VSM8",S="0.0"):u._shadowType===te.SHADOW_VSM16?(h="VSM16",S="5.54"):u._shadowType===te.SHADOW_VSM32?(h="VSM32",S=e.textureFloatHighPrecision?"15.0":"5.54"):h=u._shadowType===te.SHADOW_PCF5?"PCF5x5":"PCF3x3",null!==h&&(c===te.LIGHTTYPE_POINT?(n="(light"+i+"_shadowMap, light"+i+"_shadowParams);\n",u._normalOffsetBias&&(d+="       normalOffsetPointShadow(light"+i+"_shadowParams);\n"),d+="       dAtten *= getShadowPoint"+h+n):(_===i?h+="VS":(n="(light"+i+"_shadowMatrix, light"+i+"_shadowParams);\n",d+=this._nonPointShadowMapProjection(e,t.lights[i],n)),c===te.LIGHTTYPE_SPOT&&(h="Spot"+h),d+="       dAtten *= getShadow"+h+"(light"+i+"_shadowMap, light"+i+"_shadowParams"+(u._isVsm?", "+S:"")+");\n"))),d+="       dDiffuseLight += dAtten * light"+i+"_color"+(r?" * dAtten3":"")+";\n",t.useSpecular&&(d+="       dAtten *= getLightSpecular();\n",d+="       dSpecularLight += dAtten * light"+i+"_color"+(r?" * dAtten3":"")+";\n"),c!==te.LIGHTTYPE_DIRECTIONAL&&(d+="   }\n"),d+="\n";(a||t.sphereMap||t.dpAtlas)&&t.refraction&&(d+="   addRefraction();\n")}return d+="\n",l&&(t.occludeDirect&&(d+="    applyAO();\n"),t.occludeSpecular&&(d+="    occludeSpecular();\n")),d+=f.endPS,d=t.blendType===te.BLEND_NORMAL||t.blendType===te.BLEND_ADDITIVEALPHA||t.alphaToCoverage?d+f.outputAlphaPS:t.blendType===te.BLEND_PREMULTIPLIED?d+f.outputAlphaPremulPS:d+f.outputAlphaOpaquePS,t.msdf&&(d+="   gl_FragColor = applyMsdf(gl_FragColor);\n"),d+="\n",d+=te.programlib.end(),o&&(d=f.lightDirPointPS+d),b&&(d=f.falloffLinearPS+d),y&&(d=f.falloffInvSquaredPS+d),v&&(d=f.spotPS+d),g&&(d=f.cookiePS+d),f="",d.includes("dReflection")&&(f+="vec4 dReflection;\n"),d.includes("dTBN")&&(f+="mat3 dTBN;\n"),d.includes("dAlbedo")&&(f+="vec3 dAlbedo;\n"),d.includes("dEmission")&&(f+="vec3 dEmission;\n"),d.includes("dNormalW")&&(f+="vec3 dNormalW;\n"),d.includes("dVertexNormalW")&&(f+="vec3 dVertexNormalW;\n"),d.includes("dTangentW")&&(f+="vec3 dTangentW;\n"),d.includes("dBinormalW")&&(f+="vec3 dBinormalW;\n"),d.includes("dViewDirW")&&(f+="vec3 dViewDirW;\n"),d.includes("dReflDirW")&&(f+="vec3 dReflDirW;\n"),d.includes("dDiffuseLight")&&(f+="vec3 dDiffuseLight;\n"),d.includes("dSpecularLight")&&(f+="vec3 dSpecularLight;\n"),d.includes("dLightDirNormW")&&(f+="vec3 dLightDirNormW;\n"),d.includes("dLightDirW")&&(f+="vec3 dLightDirW;\n"),d.includes("dLightPosW")&&(f+="vec3 dLightPosW;\n"),d.includes("dShadowCoord")&&(f+="vec3 dShadowCoord;\n"),d.includes("dNormalMap")&&(f+="vec3 dNormalMap;\n"),d.includes("dSpecularity")&&(f+="vec3 dSpecularity;\n"),d.includes("dUvOffset")&&(f+="vec2 dUvOffset;\n"),d.includes("dGlossiness")&&(f+="float dGlossiness;\n"),d.includes("dAlpha")&&(f+="float dAlpha;\n"),d.includes("dAtten")&&(f+="float dAtten;\n"),d.includes("dAtten3")&&(f+="vec3 dAtten3;\n"),d.includes("dAo")&&(f+="float dAo;\n"),d.includes("dMsdf")&&(f+="vec4 dMsdf;\n"),{attributes:m,vshader:s,fshader:d=p+f+d,tag:te.SHADERTAG_MATERIAL}}},te.programlib.skybox={generateKey:function(e){return"skybox"+e.rgbm+" "+e.hdr+" "+e.fixSeams+e.toneMapping+e.gamma+e.useIntensity+e.mip},createShaderDefinition:function(e,t){var i=te.shaderChunks;return{attributes:{aPosition:te.SEMANTIC_POSITION},vshader:i.skyboxVS,fshader:te.programlib.precisionCode(e)+(t.mip?i.fixCubemapSeamsStretchPS:i.fixCubemapSeamsNonePS)+(t.useIntensity?i.envMultiplyPS:i.envConstPS)+te.programlib.gammaCode(t.gamma)+te.programlib.tonemapCode(t.toneMapping)+i.rgbmPS+i.skyboxHDRPS.replace(/\$textureCubeSAMPLE/g,t.rgbm?"textureCubeRGBM":t.hdr?"textureCube":"textureCubeSRGB").replace(/\$FIXCONST/g,1-1/[128,64,16,8,4,2][t.mip]+"")}}},Object.assign(te,(we={type:te.PRIMITIVE_TRISTRIP,base:0,count:4,indexed:!1},Oe=function(e){this.device=e,this.depthMap=this.shader=null,this.vertexBuffer=te.createFullscreenQuad(e),this.needsDepthBuffer=!1},Object.assign(Oe.prototype,{render:function(e,t,i){}}),{PostEffect:Oe,createFullscreenQuad:function(e){var t=new te.VertexFormat(e,[{semantic:te.SEMANTIC_POSITION,components:2,type:te.TYPE_FLOAT32}]);return e=new te.VertexBuffer(e,t,4),(t=new te.VertexIterator(e)).element[te.SEMANTIC_POSITION].set(-1,-1),t.next(),t.element[te.SEMANTIC_POSITION].set(1,-1),t.next(),t.element[te.SEMANTIC_POSITION].set(-1,1),t.next(),t.element[te.SEMANTIC_POSITION].set(1,1),t.end(),e},drawFullscreenQuad:function(e,t,i,s,n){var a=e.getRenderTarget();e.setRenderTarget(t),e.updateBegin();var r=null!==t?t.width:e.width,o=null!==t?t.height:e.height,h=0,l=0;n&&(h=n.x*r,l=n.y*o,r*=n.z,o*=n.w),n=e.vx,t=e.vy;var c=e.vw,d=e.vh;e.setViewport(h,l,r,o);var u=e.sx,p=e.sy,f=e.sw,m=e.sh;e.setScissor(h,l,r,o),r=e.getBlending(),o=e.getDepthTest(),h=e.getDepthWrite(),l=e.getCullMode();var _=e.writeRed,g=e.writeGreen,y=e.writeBlue,v=e.writeAlpha;e.setBlending(!1),e.setDepthTest(!1),e.setDepthWrite(!1),e.setCullMode(te.CULLFACE_NONE),e.setColorWrite(!0,!0,!0,!0),e.setVertexBuffer(i,0),e.setShader(s),e.draw(we),e.setBlending(r),e.setDepthTest(o),e.setDepthWrite(h),e.setCullMode(l),e.setColorWrite(_,g,y,v),e.updateEnd(),e.setRenderTarget(a),e.updateBegin(),e.setViewport(n,t,c,d),e.setScissor(u,p,f,m)}})),Re={BLEND_SUBTRACTIVE:0,BLEND_ADDITIVE:1,BLEND_NORMAL:2,BLEND_NONE:3,BLEND_PREMULTIPLIED:4,BLEND_MULTIPLICATIVE:5,BLEND_ADDITIVEALPHA:6,BLEND_MULTIPLICATIVE2X:7,BLEND_SCREEN:8,BLEND_MIN:9,BLEND_MAX:10,FOG_NONE:"none",FOG_LINEAR:"linear",FOG_EXP:"exp",FOG_EXP2:"exp2",FRESNEL_NONE:0,FRESNEL_SCHLICK:2,LAYER_HUD:0,LAYER_GIZMO:1,LAYER_FX:2,LAYER_WORLD:15,LAYERID_WORLD:0,LAYERID_DEPTH:1,LAYERID_SKYBOX:2,LAYERID_IMMEDIATE:3,LAYERID_UI:4,LIGHTTYPE_DIRECTIONAL:0,LIGHTTYPE_POINT:1,LIGHTTYPE_SPOT:2,LIGHTFALLOFF_LINEAR:0,LIGHTFALLOFF_INVERSESQUARED:1,SHADOW_PCF3:0,SHADOW_DEPTH:0,SHADOW_VSM8:1,SHADOW_VSM16:2,SHADOW_VSM32:3,SHADOW_PCF5:4,BLUR_BOX:0,BLUR_GAUSSIAN:1,PARTICLESORT_NONE:0,PARTICLESORT_DISTANCE:1,PARTICLESORT_NEWER_FIRST:2,PARTICLESORT_OLDER_FIRST:3,PARTICLEMODE_GPU:0,PARTICLEMODE_CPU:1,EMITTERSHAPE_BOX:0,EMITTERSHAPE_SPHERE:1,PARTICLEORIENTATION_SCREEN:0,PARTICLEORIENTATION_WORLD:1,PARTICLEORIENTATION_EMITTER:2,PROJECTION_PERSPECTIVE:0,PROJECTION_ORTHOGRAPHIC:1,RENDERSTYLE_SOLID:0,RENDERSTYLE_WIREFRAME:1,RENDERSTYLE_POINTS:2,CUBEPROJ_NONE:0,CUBEPROJ_BOX:1,SPECULAR_PHONG:0,SPECULAR_BLINN:1,GAMMA_NONE:0,GAMMA_SRGB:1,GAMMA_SRGBFAST:2,GAMMA_SRGBHDR:3,TONEMAP_LINEAR:0,TONEMAP_FILMIC:1,TONEMAP_HEJL:2,TONEMAP_ACES:3,TONEMAP_ACES2:4,SPECOCC_NONE:0,SPECOCC_AO:1,SPECOCC_GLOSSDEPENDENT:2,SHADERDEF_NOSHADOW:1,SHADERDEF_SKIN:2,SHADERDEF_UV0:4,SHADERDEF_UV1:8,SHADERDEF_VCOLOR:16,SHADERDEF_INSTANCING:32,SHADERDEF_LM:64,SHADERDEF_DIRLM:128,SHADERDEF_SCREENSPACE:256,SHADERDEF_TANGENTS:512,LINEBATCH_WORLD:0,LINEBATCH_OVERLAY:1,LINEBATCH_GIZMO:2,SHADOWUPDATE_NONE:0,SHADOWUPDATE_THISFRAME:1,SHADOWUPDATE_REALTIME:2,SORTKEY_FORWARD:0,SORTKEY_DEPTH:1,MASK_DYNAMIC:1,MASK_BAKED:2,MASK_LIGHTMAP:4,SHADER_FORWARD:0,SHADER_FORWARDHDR:1,SHADER_DEPTH:2,SHADER_SHADOW:3,SHADER_PICK:18,BAKE_COLOR:0,BAKE_COLORDIR:1,VIEW_CENTER:0,VIEW_LEFT:1,VIEW_RIGHT:2,SORTMODE_NONE:0,SORTMODE_MANUAL:1,SORTMODE_MATERIALMESH:2,SORTMODE_BACK2FRONT:3,SORTMODE_FRONT2BACK:4,SORTMODE_CUSTOM:5,COMPUPDATED_INSTANCES:1,COMPUPDATED_LIGHTS:2,COMPUPDATED_CAMERAS:4,COMPUPDATED_BLEND:8,ASPECT_AUTO:0,ASPECT_MANUAL:1,ORIENTATION_HORIZONTAL:0,ORIENTATION_VERTICAL:1},Object.assign(te,Re),te.scene={},Object.assign(te.scene,Re),Object.assign(te,((Le=function(){this.root=null,this._gravity=new te.Vec3(0,-9.8,0),this._layers=null,this._fog=te.FOG_NONE,this.fogColor=new te.Color(0,0,0),this.fogStart=1,this.fogEnd=1e3,this.fogDensity=0,this.ambientLight=new te.Color(0,0,0),this._gammaCorrection=te.GAMMA_NONE,this._toneMapping=0,this.exposure=1,this._skyboxPrefiltered=[null,null,null,null,null,null],this.skyboxModel=this._skyboxCubeMap=null,this._skyboxIntensity=1,this._skyboxMip=0,this.lightmapSizeMultiplier=1,this.lightmapMaxResolution=2048,this.lightmapMode=te.BAKE_COLORDIR,this._stats={meshInstances:0,lights:0,dynamicLights:0,bakedLights:0,lastStaticPrepareFullTime:0,lastStaticPrepareSearchTime:0,lastStaticPrepareWriteTime:0,lastStaticPrepareTriAabbTime:0,lastStaticPrepareCombineTime:0,updateShadersTime:0},this.updateSkybox=this.updateShaders=!0,this._shaderVersion=0,this._statsUpdated=!1,this._models=[],this.defaultMaterial=new te.StandardMaterial,this.defaultMaterial.name="Default Material",this.defaultMaterial.shadingModel=te.SPECULAR_BLINN,te.events.attach(this)}).prototype.destroy=function(){this.root=null,this.defaultMaterial.destroy(),this.defaultMaterial=null,this.off()},Object.defineProperty(Le.prototype,"fog",{get:function(){return this._fog},set:function(e){e!==this._fog&&(this._fog=e,this.updateShaders=!0)}}),Object.defineProperty(Le.prototype,"gammaCorrection",{get:function(){return this._gammaCorrection},set:function(e){e!==this._gammaCorrection&&(this._gammaCorrection=e,this.updateShaders=!0)}}),Object.defineProperty(Le.prototype,"toneMapping",{get:function(){return this._toneMapping},set:function(e){e!==this._toneMapping&&(this._toneMapping=e,this.updateShaders=!0)}}),Object.defineProperty(Le.prototype,"skybox",{get:function(){return this._skyboxCubeMap},set:function(e){this._skyboxCubeMap=e,this._resetSkyboxModel(),this.updateShaders=!0}}),Object.defineProperty(Le.prototype,"skyboxIntensity",{get:function(){return this._skyboxIntensity},set:function(e){this._skyboxIntensity=e,this._resetSkyboxModel(),this.updateShaders=!0}}),Object.defineProperty(Le.prototype,"skyboxMip",{get:function(){return this._skyboxMip},set:function(e){this._skyboxMip=e,this._resetSkyboxModel(),this.updateShaders=!0}}),Object.defineProperty(Le.prototype,"skyboxPrefiltered128",{get:function(){return this._skyboxPrefiltered[0]},set:function(e){this._skyboxPrefiltered[0]!==e&&(this._skyboxPrefiltered[0]=e,this.updateShaders=!0)}}),Object.defineProperty(Le.prototype,"skyboxPrefiltered64",{get:function(){return this._skyboxPrefiltered[1]},set:function(e){this._skyboxPrefiltered[1]!==e&&(this._skyboxPrefiltered[1]=e,this.updateShaders=!0)}}),Object.defineProperty(Le.prototype,"skyboxPrefiltered32",{get:function(){return this._skyboxPrefiltered[2]},set:function(e){this._skyboxPrefiltered[2]!==e&&(this._skyboxPrefiltered[2]=e,this.updateShaders=!0)}}),Object.defineProperty(Le.prototype,"skyboxPrefiltered16",{get:function(){return this._skyboxPrefiltered[3]},set:function(e){this._skyboxPrefiltered[3]!==e&&(this._skyboxPrefiltered[3]=e,this.updateShaders=!0)}}),Object.defineProperty(Le.prototype,"skyboxPrefiltered8",{get:function(){return this._skyboxPrefiltered[4]},set:function(e){this._skyboxPrefiltered[4]!==e&&(this._skyboxPrefiltered[4]=e,this.updateShaders=!0)}}),Object.defineProperty(Le.prototype,"skyboxPrefiltered4",{get:function(){return this._skyboxPrefiltered[5]},set:function(e){this._skyboxPrefiltered[5]!==e&&(this._skyboxPrefiltered[5]=e,this.updateShaders=!0)}}),Object.defineProperty(Le.prototype,"drawCalls",{get:function(){var e=this.layers._meshInstances;return e.length||(this.layers._update(),e=this.layers._meshInstances),e},set:function(e){}}),Object.defineProperty(Le.prototype,"layers",{get:function(){return this._layers},set:function(e){var t=this._layers;this._layers=e,this.fire("set:layers",t,e)}}),Le.prototype.applySettings=function(e){this._gravity.set(e.physics.gravity[0],e.physics.gravity[1],e.physics.gravity[2]),this.ambientLight.set(e.render.global_ambient[0],e.render.global_ambient[1],e.render.global_ambient[2]),this._fog=e.render.fog,this.fogColor.set(e.render.fog_color[0],e.render.fog_color[1],e.render.fog_color[2]),this.fogStart=e.render.fog_start,this.fogEnd=e.render.fog_end,this.fogDensity=e.render.fog_density,this._gammaCorrection=e.render.gamma_correction,this._toneMapping=e.render.tonemapping,this.lightmapSizeMultiplier=e.render.lightmapSizeMultiplier,this.lightmapMaxResolution=e.render.lightmapMaxResolution,this.lightmapMode=e.render.lightmapMode,this.exposure=e.render.exposure,this._skyboxIntensity=void 0===e.render.skyboxIntensity?1:e.render.skyboxIntensity,this._skyboxMip=void 0===e.render.skyboxMip?0:e.render.skyboxMip,this._resetSkyboxModel(),this.updateShaders=!0},Le.prototype._updateSkybox=function(a){if(this._skyboxCubeMap&&!this.skyboxModel){var e,t=new te.Material,r=this;if(t.updateShader=function(e,t,i,s,n){this.shader=a.getProgramLibrary().getProgram("skybox",{rgbm:r._skyboxCubeMap.rgbm,hdr:r._skyboxCubeMap.rgbm||r._skyboxCubeMap.format===te.PIXELFORMAT_RGBA32F,useIntensity:1!==r.skyboxIntensity,mip:r._skyboxCubeMap.fixCubemapSeams?r.skyboxMip:0,fixSeams:r._skyboxCubeMap.fixCubemapSeams,gamma:n===te.SHADER_FORWARDHDR?r.gammaCorrection?te.GAMMA_SRGBHDR:te.GAMMA_NONE:r.gammaCorrection,toneMapping:n===te.SHADER_FORWARDHDR?te.TONEMAP_LINEAR:r.toneMapping})},t.updateShader(),this._skyboxCubeMap.fixCubemapSeams&&r._skyboxMip){var i=this["skyboxPrefiltered"+[null,"64","16","8","4"][r._skyboxMip]];i&&(e=i)}else e=this._skyboxCubeMap;if(t.setParameter("texture_cubeMap",e),t.cull=te.CULLFACE_NONE,i=this.layers.getLayerById(te.LAYERID_SKYBOX)){var s=new te.GraphNode,n=te.createBox(a);(t=new te.MeshInstance(s,n,t)).cull=!1,t._noDepthDrawGl1=!0,(n=new te.Model).graph=s,n.meshInstances=[t],this.skyboxModel=n,i.addMeshInstances(n.meshInstances),i.enabled=!0,this.skyLayer=i,this.fire("set:skybox",e)}}},Le.prototype._resetSkyboxModel=function(){this.skyboxModel&&(this.skyLayer.removeMeshInstances(this.skyboxModel.meshInstances),this.skyLayer.enabled=!1,this.skyboxModel.destroy()),this.skyboxModel=null,this.updateSkybox=!0},Le.prototype.setSkybox=function(e){var t;e||(e=[null,null,null,null,null,null,null]);var i=!1;if(this._skyboxCubeMap!==e[0]&&(i=!0),!i)for(t=0;t<6&&!i;t++)this._skyboxPrefiltered[t]!==e[t+1]&&(i=!0);if(i){for(t=0;t<6;t++)this._skyboxPrefiltered[t]=e[t+1];this.skybox=e[0]}},Le.prototype.destroy=function(){this.skybox=null},Le.prototype.addModel=function(e){if(!this.containsModel(e)){var t=this.layers.getLayerById(te.LAYERID_WORLD);t&&(t.addMeshInstances(e.meshInstances),this._models.push(e))}},Le.prototype.addShadowCaster=function(e){var t=this.layers.getLayerById(te.LAYERID_WORLD);t&&t.addShadowCasters(e.meshInstances)},Le.prototype.removeModel=function(e){var t=this._models.indexOf(e);if(-1!==t){var i=this.layers.getLayerById(te.LAYERID_WORLD);i&&(i.removeMeshInstances(e.meshInstances),this._models.splice(t,1))}},Le.prototype.removeShadowCasters=function(e){var t=this.layers.getLayerById(te.LAYERID_WORLD);t&&t.removeShadowCasters(e.meshInstances)},Le.prototype.containsModel=function(e){return 0<=this._models.indexOf(e)},Le.prototype.getModels=function(e){return this._models},{Scene:Le})),Object.assign(te,function(){function a(e,t,i,s){var n=s===te.SHADOW_VSM32?te.PIXELFORMAT_RGBA32F:s===te.SHADOW_VSM16?te.PIXELFORMAT_RGBA16F:s===te.SHADOW_PCF5||s===te.SHADOW_PCF3&&e.webgl2?te.PIXELFORMAT_DEPTH:te.PIXELFORMAT_R8_G8_B8_A8,a=function(e,t){return t!==te.SHADOW_PCF3||e.webgl2?t===te.SHADOW_VSM32?e.extTextureFloatLinear?te.FILTER_LINEAR:te.FILTER_NEAREST:t===te.SHADOW_VSM16?e.extTextureHalfFloatLinear?te.FILTER_LINEAR:te.FILTER_NEAREST:te.FILTER_LINEAR:te.FILTER_NEAREST}(e,s);return(t=new te.Texture(e,{format:n,width:t,height:i,mipmaps:!1,minFilter:a,magFilter:a,addressU:te.ADDRESS_CLAMP_TO_EDGE,addressV:te.ADDRESS_CLAMP_TO_EDGE})).name="shadowmap",s===te.SHADOW_PCF5||s===te.SHADOW_PCF3&&e.webgl2?(t.compareOnRead=!0,t.compareFunc=te.FUNC_LESS,new te.RenderTarget({depthBuffer:t})):new te.RenderTarget({colorBuffer:t,depth:!0})}function s(e,t){var i=new te.Texture(e,{format:te.PIXELFORMAT_R8_G8_B8_A8,width:t,height:t,cubemap:!0,mipmaps:!1,minFilter:te.FILTER_NEAREST,magFilter:te.FILTER_NEAREST,addressU:te.ADDRESS_CLAMP_TO_EDGE,addressV:te.ADDRESS_CLAMP_TO_EDGE});i.name="shadowcube";for(var s,n=[],a=0;a<6;a++)s=new te.RenderTarget({colorBuffer:i,face:a,depth:!0}),n.push(s);return n}function x(e){25<e&&(e=25);var t,i,s,n,a=(e-1)/6;for(n=.5*(e-1),i=Array(e),t=s=0;t<e;++t){var r=t-n;i[t]=Math.exp(-r*r/(2*a*a)),s+=i[t]}for(t=0;t<e;++t)i[t]/=s;return i}function A(e,t,i,s){s||(s=0),s=1e4*s+t;var n=f[i][s];return n||(n=a(e,t,t,i||te.SHADOW_PCF3),f[i][s]=n),n}function r(e,t){var i;t._type===te.LIGHTTYPE_POINT?(t._shadowType>te.SHADOW_PCF3&&(t._shadowType=te.SHADOW_PCF3),t._cacheShadowMap?(i=q[t._shadowResolution])||(i=s(e,t._shadowResolution),q[t._shadowResolution]=i):i=s(e,t._shadowResolution),t._shadowCamera.renderTarget=i[0],t._shadowCubeMap=i):(i=t._cacheShadowMap?A(e,t._shadowResolution,t._shadowType):a(e,t._shadowResolution,t._shadowResolution,t._shadowType),t._shadowCamera.renderTarget=i),t._isCachedShadowMap=t._cacheShadowMap}function e(e){e=this.device=e,this._instancingTime=this._morphTime=this._skinTime=this._sortTime=this._cullTime=this._forwardTime=this._depthMapTime=this._shadowMapTime=this._shadowMapUpdates=this._materialSwitches=this._camerasRendered=this._skinDrawCalls=this._forwardDrawCalls=this._shadowDrawCalls=0,this.library=e.getProgramLibrary(),e=e.scope,this.projId=e.resolve("matrix_projection"),this.viewId=e.resolve("matrix_view"),this.viewId3=e.resolve("matrix_view3"),this.viewInvId=e.resolve("matrix_viewInverse"),this.viewProjId=e.resolve("matrix_viewProjection"),this.viewPos=new Float32Array(3),this.viewPosId=e.resolve("view_position"),this.nearClipId=e.resolve("camera_near"),this.farClipId=e.resolve("camera_far"),this.cameraParamsId=e.resolve("camera_params"),this.shadowMapLightRadiusId=e.resolve("light_radius"),this.fogColorId=e.resolve("fog_color"),this.fogStartId=e.resolve("fog_start"),this.fogEndId=e.resolve("fog_end"),this.fogDensityId=e.resolve("fog_density"),this.modelMatrixId=e.resolve("matrix_model"),this.normalMatrixId=e.resolve("matrix_normal"),this.poseMatrixId=e.resolve("matrix_pose[0]"),this.boneTextureId=e.resolve("texture_poseMap"),this.boneTextureSizeId=e.resolve("texture_poseMapSize"),this.alphaTestId=e.resolve("alpha_ref"),this.opacityMapId=e.resolve("texture_opacityMap"),this.ambientId=e.resolve("light_globalAmbient"),this.exposureId=e.resolve("exposure"),this.skyboxIntensityId=e.resolve("skyboxIntensity"),this.lightColorId=[],this.lightDir=[],this.lightDirId=[],this.lightShadowMapId=[],this.lightShadowMatrixId=[],this.lightShadowParamsId=[],this.lightShadowMatrixVsId=[],this.lightShadowParamsVsId=[],this.lightDirVs=[],this.lightDirVsId=[],this.lightRadiusId=[],this.lightPos=[],this.lightPosId=[],this.lightInAngleId=[],this.lightOutAngleId=[],this.lightPosVsId=[],this.lightCookieId=[],this.lightCookieIntId=[],this.lightCookieMatrixId=[],this.lightCookieOffsetId=[],this.depthMapId=e.resolve("uDepthMap"),this.screenSizeId=e.resolve("uScreenSize"),this._screenSize=new Float32Array(4),this.sourceId=e.resolve("source"),this.pixelOffsetId=e.resolve("pixelOffset"),this.weightId=e.resolve("weight[0]");var t=te.shaderChunks;this.blurVsmShaderCode=[t.blurVSMPS,"#define GAUSS\n"+t.blurVSMPS],this.blurPackedVsmShaderCode=["#define PACKED\n"+this.blurVsmShaderCode[0],"#define PACKED\n"+this.blurVsmShaderCode[1]],this.blurVsmShader=[{},{}],this.blurPackedVsmShader=[{},{}],this.blurVsmWeights={},this.polygonOffsetId=e.resolve("polygonOffset"),this.polygonOffset=new Float32Array(2),this.fogColor=new Float32Array(3),this.ambientColor=new Float32Array(3)}function c(e,t){e.data[0]=t.data[0],e.data[1]=t.data[1],e.data[2]=t.data[2],e.data[3]=t.data[4],e.data[4]=t.data[5],e.data[5]=t.data[6],e.data[6]=t.data[8],e.data[7]=t.data[9],e.data[8]=t.data[10]}for(var d,M,C,i,n,o,h,l,u,p,P=(new te.Mat4).mul2((new te.Mat4).setTranslate(.5,.5,.5),(new te.Mat4).setScale(.5,.5,.5)),I={r:1,g:2,b:3,a:4},w=[(new te.Quat).setFromEulerAngles(0,90,180),(new te.Quat).setFromEulerAngles(0,-90,180),(new te.Quat).setFromEulerAngles(90,0,0),(new te.Quat).setFromEulerAngles(-90,0,0),(new te.Quat).setFromEulerAngles(0,180,180),(new te.Quat).setFromEulerAngles(0,0,180)],f=[{},{},{},{},{}],O=new Float32Array(2),R={x:1,y:1,z:0,w:0},L=new te.Mat4,D=new te.Mat4,_=new te.Mat4,m=new te.Mat4,g=new te.Mat4,y=new te.Mat3,v=new te.Mat4,N=new te.Mat4,F=new te.Mat4,B=new te.Mat4,k=new te.Mat4,V=new te.Vec3,U=new te.Vec3,z=new te.Mat4,H=new te.Mat4,j=new te.Mat4,G=new te.Mat4,b=new te.Vec3,S=new te.Vec3,T=new te.Vec3,E=new te.Vec3,W={center:null,radius:0},Y=new te.BoundingBox,X=[0,0],q={},K=[],t=0;t<8;t++)K.push(new te.Vec3);var Z=[new te.Vec3,new te.Vec3,new te.Vec3,new te.Vec3,new te.Vec3,new te.Vec3,new te.Vec3,new te.Vec3];return Object.assign(e.prototype,{sortCompare:function(e,t){if(e.layer===t.layer){if(e.drawOrder&&t.drawOrder)return e.drawOrder-t.drawOrder;if(e.zdist&&t.zdist)return t.zdist-e.zdist;if(e.zdist2&&t.zdist2)return e.zdist2-t.zdist2}return t._key[te.SORTKEY_FORWARD]-e._key[te.SORTKEY_FORWARD]},sortCompareMesh:function(e,t){if(e.layer===t.layer){if(e.drawOrder&&t.drawOrder)return e.drawOrder-t.drawOrder;if(e.zdist&&t.zdist)return t.zdist-e.zdist}return u=e._key[te.SORTKEY_FORWARD],p=t._key[te.SORTKEY_FORWARD],u===p&&e.mesh&&t.mesh?t.mesh.id-e.mesh.id:p-u},depthSortCompare:function(e,t){return u=e._key[te.SORTKEY_DEPTH],p=t._key[te.SORTKEY_DEPTH],u===p&&e.mesh&&t.mesh?t.mesh.id-e.mesh.id:p-u},lightCompare:function(e,t){return e.key-t.key},_isVisible:function(e,t){return!!t.visible&&(t.isVisibleFunc?t.isVisibleFunc(e):(i=t.aabb.center,t._aabb._radiusVer!==t._aabbVer&&(t._aabb._radius=t._aabb.halfExtents.length(),t._aabb._radiusVer=t._aabbVer),W.radius=t._aabb._radius,W.center=i,e.frustum.containsSphere(W)))},getShadowCamera:function(e,t){var i,s=t._shadowCamera;if(null===s){s=t._shadowType,i=te.CLEARFLAG_DEPTH;var n=s===te.SHADOW_PCF5||s===te.SHADOW_PCF3&&e.webgl2;t._type===te.LIGHTTYPE_POINT&&(n=!1),n||(i|=te.CLEARFLAG_COLOR),n=new te.Camera,s>=te.SHADOW_VSM8&&s<=te.SHADOW_VSM32?(n.clearColor[0]=0,n.clearColor[1]=0,n.clearColor[2]=0,n.clearColor[3]=0):(n.clearColor[0]=1,n.clearColor[1]=1,n.clearColor[2]=1,n.clearColor[3]=1),n.clearDepth=1,n.clearFlags=i,n.clearStencil=null,n._node=new te.GraphNode,s=t._shadowCamera=n,r(e,t)}else(i=s.renderTarget).width===t._shadowResolution&&i.height===t._shadowResolution||r(e,t);return s},updateCameraFrustum:function(e){if(e.vrDisplay&&e.vrDisplay.presenting){d=e.vrDisplay.combinedProj,(t=e._node.parent)?g.copy(t.getWorldTransform()).mul(e.vrDisplay.combinedViewInv).invert():g.copy(e.vrDisplay.combinedView),m.copy(g).invert(),this.viewInvId.setValue(m.data)}else{if(d=e.getProjectionMatrix(),e.overrideCalculateProjection&&e.calculateProjection(d,te.VIEW_CENTER),e.overrideCalculateTransform)e.calculateTransform(m,te.VIEW_CENTER);else{var t=e._node.getPosition(),i=e._node.getRotation();m.setTRS(t,i,te.Vec3.ONE),this.viewInvId.setValue(m.data)}g.copy(m).invert()}e.frustum.update(d,g)},setCamera:function(e,t,i,s){var n=e.vrDisplay;if(n&&n.presenting){if(M=n.leftProj,C=n.rightProj,d=n.combinedProj,e.overrideCalculateProjection&&(e.calculateProjection(M,te.VIEW_LEFT),e.calculateProjection(C,te.VIEW_RIGHT),e.calculateProjection(d,te.VIEW_CENTER)),e.overrideCalculateTransform)e.calculateTransform(N,te.VIEW_LEFT),e.calculateTransform(F,te.VIEW_RIGHT),e.calculateTransform(m,te.VIEW_CENTER),B.copy(N).invert(),k.copy(F).invert(),g.copy(m).invert();else{var a=e._node.parent;if(a){var r=a.getWorldTransform();N.mul2(r,n.leftViewInv),F.mul2(r,n.rightViewInv),B.copy(N).invert(),k.copy(F).invert(),g.copy(a.getWorldTransform()).mul(n.combinedViewInv).invert()}else N.copy(n.leftViewInv),F.copy(n.rightViewInv),B.copy(n.leftView),k.copy(n.rightView),g.copy(n.combinedView)}c(z,B),c(H,k),j.mul2(M,B),G.mul2(C,k),V.x=N.data[12],V.y=N.data[13],V.z=N.data[14],U.x=F.data[12],U.y=F.data[13],U.z=F.data[14]}else d=e.getProjectionMatrix(),e.overrideCalculateProjection&&e.calculateProjection(d,te.VIEW_CENTER),this.projId.setValue(d.data),e.overrideCalculateTransform?e.calculateTransform(m,te.VIEW_CENTER):(n=e._node.getPosition(),a=e._node.getRotation(),m.setTRS(n,a,te.Vec3.ONE)),this.viewInvId.setValue(m.data),g.copy(m).invert(),this.viewId.setValue(g.data),c(y,g),this.viewId3.setValue(y.data),v.mul2(d,g),this.viewProjId.setValue(v.data),n=e._node.getPosition(),this.viewPos[0]=n.x,this.viewPos[1]=n.y,this.viewPos[2]=n.z,this.viewPosId.setValue(this.viewPos);e.frustum.update(d,g),this.nearClipId.setValue(e._nearClip),this.farClipId.setValue(e._farClip),this.cameraParamsId.setValue(e._shaderParams),(n=this.device).setRenderTarget(t),n.updateBegin(),r=e.getRect(),a=t?t.width:n.width,t=t?t.height:n.height;var o=Math.floor(r.x*a),h=Math.floor(r.y*t),l=Math.floor(r.width*a);r=Math.floor(r.height*t);n.setViewport(o,h,l,r),n.setScissor(o,h,l,r),i&&n.clear(e._clearOptions),r=e._scissorRect,o=Math.floor(r.x*a),h=Math.floor(r.y*t),l=Math.floor(r.width*a),r=Math.floor(r.height*t),n.setScissor(o,h,l,r),s&&n.setScissor(1,1,a-2,t-2)},dispatchGlobalLights:function(e){var t;if(this.mainLight=-1,this.ambientColor[0]=e.ambientLight.r,this.ambientColor[1]=e.ambientLight.g,this.ambientColor[2]=e.ambientLight.b,e.gammaCorrection)for(t=0;t<3;t++)this.ambientColor[t]=Math.pow(this.ambientColor[t],2.2);this.ambientId.setValue(this.ambientColor),this.exposureId.setValue(e.exposure),e.skyboxModel&&this.skyboxIntensityId.setValue(e.skyboxIntensity)},_resolveLight:function(e,t){var i="light"+t;this.lightColorId[t]=e.resolve(i+"_color"),this.lightDir[t]=new Float32Array(3),this.lightDirId[t]=e.resolve(i+"_direction"),this.lightShadowMapId[t]=e.resolve(i+"_shadowMap"),this.lightShadowMatrixId[t]=e.resolve(i+"_shadowMatrix"),this.lightShadowParamsId[t]=e.resolve(i+"_shadowParams"),this.lightShadowMatrixVsId[t]=e.resolve(i+"_shadowMatrixVS"),this.lightShadowParamsVsId[t]=e.resolve(i+"_shadowParamsVS"),this.lightDirVs[t]=new Float32Array(3),this.lightDirVsId[t]=e.resolve(i+"_directionVS"),this.lightRadiusId[t]=e.resolve(i+"_radius"),this.lightPos[t]=new Float32Array(3),this.lightPosId[t]=e.resolve(i+"_position"),this.lightInAngleId[t]=e.resolve(i+"_innerConeAngle"),this.lightOutAngleId[t]=e.resolve(i+"_outerConeAngle"),this.lightPosVsId[t]=e.resolve(i+"_positionVS"),this.lightCookieId[t]=e.resolve(i+"_cookie"),this.lightCookieIntId[t]=e.resolve(i+"_cookieIntensity"),this.lightCookieMatrixId[t]=e.resolve(i+"_cookieMatrix"),this.lightCookieOffsetId[t]=e.resolve(i+"_cookieOffset")},dispatchDirectLights:function(e,t,i){var s,n,a,r=e.length,o=0;this.mainLight=-1;var h=this.device.scope;for(s=0;s<r;s++)if(e[s]._mask&i){if(a=(n=e[s])._node.getWorldTransform(),this.lightColorId[o]||this._resolveLight(h,o),this.lightColorId[o].setValue(t.gammaCorrection?n._linearFinalColor:n._finalColor),a.getY(n._direction).scale(-1),n._direction.normalize(),this.lightDir[o][0]=n._direction.x,this.lightDir[o][1]=n._direction.y,this.lightDir[o][2]=n._direction.z,this.lightDirId[o].setValue(this.lightDir[o]),n.castShadows){var l=n._isPcf&&this.device.webgl2?n._shadowCamera.renderTarget.depthBuffer:n._shadowCamera.renderTarget.colorBuffer;n._isVsm?a=-2e-4:(a=n.shadowBias/n._shadowCamera._farClip*100,!this.device.webgl2&&this.device.extStandardDerivatives&&(a*=-100));var c=n._isVsm?n.vsmBias/(n._shadowCamera._farClip/7):n._normalOffsetBias;this.lightShadowMapId[o].setValue(l),this.lightShadowMatrixId[o].setValue(n._shadowMatrix.data),3!==(l=n._rendererParams).length&&(l.length=3),l[0]=n._shadowResolution,l[1]=c,l[2]=a,this.lightShadowParamsId[o].setValue(l),this.mainLight<0&&(this.lightShadowMatrixVsId[o].setValue(n._shadowMatrix.data),this.lightShadowParamsVsId[o].setValue(l),n._direction.normalize(),this.lightDirVs[o][0]=n._direction.x,this.lightDirVs[o][1]=n._direction.y,this.lightDirVs[o][2]=n._direction.z,this.lightDirVsId[o].setValue(this.lightDirVs[o]),this.mainLight=s)}o++}return o},dispatchPointLight:function(e,t,i,s){var n=i._node.getWorldTransform();this.lightColorId[s]||this._resolveLight(t,s),this.lightRadiusId[s].setValue(i.attenuationEnd),this.lightColorId[s].setValue(e.gammaCorrection?i._linearFinalColor:i._finalColor),n.getTranslation(i._position),this.lightPos[s][0]=i._position.x,this.lightPos[s][1]=i._position.y,this.lightPos[s][2]=i._position.z,this.lightPosId[s].setValue(this.lightPos[s]),i.castShadows&&(this.lightShadowMapId[s].setValue(i._shadowCamera.renderTarget.colorBuffer),4!==(e=i._rendererParams).length&&(e.length=4),e[0]=i._shadowResolution,e[1]=i._normalOffsetBias,e[2]=i.shadowBias,e[3]=1/i.attenuationEnd,this.lightShadowParamsId[s].setValue(e)),i._cookie&&(this.lightCookieId[s].setValue(i._cookie),this.lightShadowMatrixId[s].setValue(n.data),this.lightCookieIntId[s].setValue(i.cookieIntensity))},dispatchSpotLight:function(e,t,i,s){var n=i._node.getWorldTransform();this.lightColorId[s]||this._resolveLight(t,s),this.lightInAngleId[s].setValue(i._innerConeAngleCos),this.lightOutAngleId[s].setValue(i._outerConeAngleCos),this.lightRadiusId[s].setValue(i.attenuationEnd),this.lightColorId[s].setValue(e.gammaCorrection?i._linearFinalColor:i._finalColor),n.getTranslation(i._position),this.lightPos[s][0]=i._position.x,this.lightPos[s][1]=i._position.y,this.lightPos[s][2]=i._position.z,this.lightPosId[s].setValue(this.lightPos[s]),n.getY(i._direction).scale(-1),i._direction.normalize(),this.lightDir[s][0]=i._direction.x,this.lightDir[s][1]=i._direction.y,this.lightDir[s][2]=i._direction.z,this.lightDirId[s].setValue(this.lightDir[s]),i.castShadows&&(i._isVsm?e=-2e-4:(e=20*i.shadowBias,!this.device.webgl2&&this.device.extStandardDerivatives&&(e*=-100)),t=i._isVsm?i.vsmBias/(i.attenuationEnd/7):i._normalOffsetBias,this.lightShadowMapId[s].setValue(i._isPcf&&this.device.webgl2?i._shadowCamera.renderTarget.depthBuffer:i._shadowCamera.renderTarget.colorBuffer),this.lightShadowMatrixId[s].setValue(i._shadowMatrix.data),4!==(n=i._rendererParams).length&&(n.length=4),n[0]=i._shadowResolution,n[1]=t,n[2]=e,n[3]=1/i.attenuationEnd,this.lightShadowParamsId[s].setValue(n)),i._cookie&&(this.lightCookieId[s].setValue(i._cookie),i.castShadows||((t=(e=this.getShadowCamera(this.device,i))._node).setPosition(i._node.getPosition()),t.setRotation(i._node.getRotation()),t.rotateLocal(-90,0,0),e.projection=te.PROJECTION_PERSPECTIVE,e.aspectRatio=1,e.fov=2*i._outerConeAngle,L.setTRS(t.getPosition(),t.getRotation(),te.Vec3.ONE).invert(),D.mul2(e.getProjectionMatrix(),L),i._shadowMatrix.mul2(P,D)),this.lightShadowMatrixId[s].setValue(i._shadowMatrix.data),this.lightCookieIntId[s].setValue(i.cookieIntensity),i._cookieTransform&&(i._cookieTransformUniform[0]=i._cookieTransform.x,i._cookieTransformUniform[1]=i._cookieTransform.y,i._cookieTransformUniform[2]=i._cookieTransform.z,i._cookieTransformUniform[3]=i._cookieTransform.w,this.lightCookieMatrixId[s].setValue(i._cookieTransformUniform),i._cookieOffsetUniform[0]=i._cookieOffset.x,i._cookieOffsetUniform[1]=i._cookieOffset.y,this.lightCookieOffsetId[s].setValue(i._cookieOffsetUniform)))},dispatchLocalLights:function(e,t,i,s,n){var a,r=e[te.LIGHTTYPE_POINT];e=e[te.LIGHTTYPE_SPOT];var o=r.length,h=e.length,l=s,c=this.device.scope;for(s=0;s<o;s++)(a=r[s])._mask&i&&!a.isStatic&&(this.dispatchPointLight(t,c,a,l),l++);if(r=0,n)for(a=n[r];a&&a._type===te.LIGHTTYPE_POINT;)this.dispatchPointLight(t,c,a,l),l++,a=n[++r];for(s=0;s<h;s++)(a=e[s])._mask&i&&!a.isStatic&&(this.dispatchSpotLight(t,c,a,l),l++);if(n)for(a=n[r];a&&a._type===te.LIGHTTYPE_SPOT;)this.dispatchSpotLight(t,c,a,l),l++,a=n[++r]},cull:function(e,t,i){var s,n,a,r=0,o=t.length,h=e.cullingMask||4294967295;if(!e.frustumCulling){for(s=0;s<o;s++)((n=t[s]).visible||n.command)&&(n.mask&&0==(n.mask&h)||(i[r]=n,r++,n.visibleThisFrame=!0));return r}for(s=0;s<o;s++)(n=t[s]).command?(i[r]=n,r++,n.visibleThisFrame=!0):n.visible&&(a=!0,n.mask&&0==(n.mask&h)||(n.cull&&(a=this._isVisible(e,n)),a&&(i[r]=n,r++,n.visibleThisFrame=!0)));return r},cullLights:function(e,t){var i,s,n;for(i=0;i<t.length;i++)n=(s=t[i])._type,s.castShadows&&s._enabled&&s.shadowUpdateMode!==te.SHADOWUPDATE_NONE&&n!==te.LIGHTTYPE_DIRECTIONAL&&(s.getBoundingSphere(W),e.frustum.containsSphere(W)&&(s.visibleThisFrame=!0))},updateCpuSkinMatrices:function(e){var t,i,s=e.length;if(0!==s)for(t=0;t<s;t++)(i=e[t].skinInstance)&&(i.updateMatrices(e[t].node),i._dirty=!0)},updateGpuSkinMatrices:function(e){var t,i,s=e.length;for(t=0;t<s;t++)e[t].visibleThisFrame&&(i=e[t].skinInstance)&&i._dirty&&(i.updateMatrixPalette(),i._dirty=!1)},updateMorphedBounds:function(e){var t,i,s=e.length;for(t=0;t<s;t++)(i=e[t].morphInstance)&&i._dirty&&i.updateBounds(e[t].mesh)},updateMorphing:function(e){var t,i,s=e.length;for(t=0;t<s;t++)e[t].visibleThisFrame&&(i=e[t].morphInstance)&&i._dirty&&(i.update(e[t].mesh),i._dirty=!1)},setBaseConstants:function(e,t){e.setCullMode(t.cull),t.opacityMap&&(this.opacityMapId.setValue(t.opacityMap),this.alphaTestId.setValue(t.alphaTest))},setSkinning:function(e,t,i){t.skinInstance&&(this._skinDrawCalls++,e.supportsBoneTextures?(n=t.skinInstance.boneTexture,this.boneTextureId.setValue(n),X[0]=n.width,X[1]=n.height,this.boneTextureSizeId.setValue(X)):this.poseMatrixId.setValue(t.skinInstance.matrixPalette))},drawInstance:function(e,t,i,s,n){return(o=t.instancingData)?(this._instancedDrawCalls++,this._removedByInstancing+=o.count,e.setVertexBuffer(o._buffer,1,o.offset),e.draw(i.primitive[s],o.count),o._buffer===te._autoInstanceBuffer?(t.instancingData=null,o.count-1):void 0):(h=t.node.worldTransform,this.modelMatrixId.setValue(h.data),n&&(l=t.node.normalMatrix,t.node._dirtyNormal&&(h.invertTo3x3(l),l.transpose(),t.node._dirtyNormal=!1),this.normalMatrixId.setValue(l.data)),e.draw(i.primitive[s]),0)},drawInstance2:function(e,t,i,s){return(o=t.instancingData)?(this._instancedDrawCalls++,this._removedByInstancing+=o.count,e.setVertexBuffer(o._buffer,1,o.offset),e.draw(i.primitive[s],o.count),o._buffer===te._autoInstanceBuffer?(t.instancingData=null,o.count-1):void 0):(e.draw(i.primitive[s]),0)},renderShadows:function(e,t){var i,s,n,a,r,o,h,l,c,d,u,p,f,m,_,g,y=this.device,v=1<<te.SHADER_SHADOW;for(i=0;i<e.length;i++)if(r=(n=e[i])._type,n.castShadows&&n._enabled&&(n._shadowCamera||this.getShadowCamera(y,n),n.shadowUpdateMode!==te.SHADOWUPDATE_NONE&&n.visibleThisFrame)){if(h=(o=this.getShadowCamera(y,n))._node,l=0,c=1,r===te.LIGHTTYPE_DIRECTIONAL){if(n._visibleLength[t]<0)continue;l=n._visibleCameraSettings[t],h.setPosition(l.x,l.y,l.z),o.orthoHeight=l.orthoHeight,o.farClip=l.farClip,l=t}else r===te.LIGHTTYPE_SPOT?(m=h.getPosition(),this.viewPos[0]=m.x,this.viewPos[1]=m.y,this.viewPos[2]=m.z,this.viewPosId.setValue(this.viewPos),this.shadowMapLightRadiusId.setValue(n.attenuationEnd)):r===te.LIGHTTYPE_POINT&&(m=h.getPosition(),this.viewPos[0]=m.x,this.viewPos[1]=m.y,this.viewPos[2]=m.z,this.viewPosId.setValue(this.viewPos),this.shadowMapLightRadiusId.setValue(n.attenuationEnd),c=6);for(r!==te.LIGHTTYPE_POINT&&(L.setTRS(h.getPosition(),h.getRotation(),te.Vec3.ONE).invert(),D.mul2(o.getProjectionMatrix(),L),n._shadowMatrix.mul2(P,D)),y.webgl2?r===te.LIGHTTYPE_POINT?y.setDepthBias(!1):(y.setDepthBias(!0),y.setDepthBiasValues(-1e3*n.shadowBias,-1e3*n.shadowBias)):y.extStandardDerivatives&&(r===te.LIGHTTYPE_POINT?(this.polygonOffset[0]=0,this.polygonOffset[1]=0):(this.polygonOffset[0]=-1e3*n.shadowBias,this.polygonOffset[1]=-1e3*n.shadowBias),this.polygonOffsetId.setValue(this.polygonOffset)),n.shadowUpdateMode===te.SHADOWUPDATE_THISFRAME&&(n.shadowUpdateMode=te.SHADOWUPDATE_NONE),this._shadowMapUpdates+=c,y.setBlending(!1),y.setDepthWrite(!0),y.setDepthTest(!0),n._isPcf&&y.webgl2&&r!==te.LIGHTTYPE_POINT?y.setColorWrite(!1,!1,!1,!1):y.setColorWrite(!0,!0,!0,!0),l?c=l+1:l=0;l<c;){for(r===te.LIGHTTYPE_POINT&&(h.setRotation(w[l]),o.renderTarget=n._shadowCubeMap[l]),this.setCamera(o,o.renderTarget,!0,r!==te.LIGHTTYPE_POINT),m=n._visibleList[l],u=n._visibleLength[l],d=(s=n._shadowType)+5*r,s=0;s<u;s++){if(f=(p=m[s]).mesh,a=p.material,this.setBaseConstants(y,a),this.setSkinning(y,p,a),a.dirty&&(a.updateUniforms(),a.dirty=!1),a.chunks){for(_ in g=a.parameters)(a=g[_]).passFlags&v&&(a.scopeId||(a.scopeId=y.scope.resolve(_)),a.scopeId.setValue(a.data));for(_ in this.setCullMode(!0,!1,p),g=p.parameters)(a=g[_]).passFlags&v&&(a.scopeId||(a.scopeId=y.scope.resolve(_)),a.scopeId.setValue(a.data))}if(!(a=p._shader[te.SHADER_SHADOW+d])){this.updateShader(p,p._shaderDefs,null,te.SHADER_SHADOW+d),a=p._shader[te.SHADER_SHADOW+d],g=p._key;var b=te.SORTKEY_DEPTH,S=p.material,T=p.skinInstance?10:0,E=0;S.opacityMap&&(S=S.opacityMapChannel)&&(E=I[S]),g[b]=T+E}y.setShader(a),a=p.renderStyle,y.setVertexBuffer(p.morphInstance&&p.morphInstance._vertexBuffer?p.morphInstance._vertexBuffer:f.vertexBuffer,0),y.setIndexBuffer(f.indexBuffer[a]),s+=this.drawInstance(y,p,f,a),this._shadowDrawCalls++}l++,r===te.LIGHTTYPE_DIRECTIONAL&&(n._visibleLength[t]=-1)}n._isVsm&&(1<(r=n._vsmBlurSize)&&(o=o.renderTarget,h=A(y,n._shadowResolution,n._shadowType,1),c=n._shadowType===te.SHADOW_VSM8,l=n.vsmBlurMode,(m=(c?this.blurPackedVsmShader:this.blurVsmShader)[l][r])||(this.blurVsmWeights[r]=x(r),m=te.shaderChunks.fullscreenQuadVS,s="#define SAMPLES "+r+"\n",s=c?s+this.blurPackedVsmShaderCode[l]:s+this.blurVsmShaderCode[l],m=te.shaderChunks.createShaderFromCode(this.device,m,s,"blurVsm"+l+r+c),c?this.blurPackedVsmShader[l][r]=m:this.blurVsmShader[l][r]=m),R.z=n._shadowResolution-2,R.w=R.z,this.sourceId.setValue(o.colorBuffer),O[0]=1/n._shadowResolution,O[1]=0,this.pixelOffsetId.setValue(O),l===te.BLUR_GAUSSIAN&&this.weightId.setValue(this.blurVsmWeights[r]),te.drawQuadWithShader(y,h,m,null,R),this.sourceId.setValue(h.colorBuffer),O[1]=O[0],O[0]=0,this.pixelOffsetId.setValue(O),te.drawQuadWithShader(y,o,m,null,R)))}y.webgl2?y.setDepthBias(!1):y.extStandardDerivatives&&(this.polygonOffset[0]=0,this.polygonOffset[1]=0,this.polygonOffsetId.setValue(this.polygonOffset))},updateShader:function(e,t,i,s,n){e.material._scene=this.scene,e.material.updateShader(this.device,this.scene,t,i,s,n),e._shader[s]=e.material.shader},setCullMode:function(e,t,i){var s=i.material,n=te.CULLFACE_NONE;e&&(e=1,s.cull>te.CULLFACE_NONE&&s.cull<te.CULLFACE_FRONTANDBACK&&(i.flipFaces&&(e*=-1),t&&(e*=-1),(t=i.node.worldTransform).getX(b),t.getY(S),t.getZ(T),b.cross(b,S),b.dot(T)<0&&(e*=-1)),n=e<0?s.cull===te.CULLFACE_FRONT?te.CULLFACE_BACK:te.CULLFACE_FRONT:s.cull),this.device.setCullMode(n)},renderForward:function(e,t,i,s,n,a,r,o){var h=this.device,l=this.scene,c=e.vrDisplay,d=1<<n;o=o?o._lightHash:0;var u,p,f,m,_,g,y,v,b,S,T=null,E=.5*h.width;for(u=0;u<i;u++)if(p=t[u],!a||!p.mask||a&p.mask)if(p.command)p.command();else{if(f=p.mesh,m=p.material,_=p._shaderDefs,y=p.mask,this.setSkinning(h,p,m),m&&m===T&&_!==g&&(T=null),(p.isStatic||b)&&(T=null),m!==T){for(S in this._materialSwitches++,m.dirty&&(m.updateUniforms(),m.dirty=!1),p._shader[n]&&p._shaderDefs===_&&p._lightHash===o||(p.isStatic?this.updateShader(p,_,p._staticLightList,n,s):(g=n+"_"+_+"_"+o,p._shader[n]=m.variants[g],p._shader[n]||(this.updateShader(p,_,null,n,s),m.variants[g]=p._shader[n])),p._shaderDefs=_,p._lightHash=o),h.setShader(p._shader[n]),g=m.parameters)(b=g[S]).passFlags&d&&(b.scopeId||(b.scopeId=h.scope.resolve(S)),b.scopeId.setValue(b.data));T&&y===v||(v=this.dispatchDirectLights(s[te.LIGHTTYPE_DIRECTIONAL],l,y),this.dispatchLocalLights(s,l,y,v,p._staticLightList)),this.alphaTestId.setValue(m.alphaTest),h.setBlending(m.blend),m.blend&&(m.separateAlphaBlend?(h.setBlendFunctionSeparate(m.blendSrc,m.blendDst,m.blendSrcAlpha,m.blendDstAlpha),h.setBlendEquationSeparate(m.blendEquation,m.blendAlphaEquation)):(h.setBlendFunction(m.blendSrc,m.blendDst),h.setBlendEquation(m.blendEquation))),h.setColorWrite(m.redWrite,m.greenWrite,m.blueWrite,m.alphaWrite),h.setDepthWrite(m.depthWrite),h.setDepthTest(m.depthTest),h.setAlphaToCoverage(m.alphaToCoverage),m.depthBias||m.slopeDepthBias?(h.setDepthBias(!0),h.setDepthBiasValues(m.depthBias,m.slopeDepthBias)):h.setDepthBias(!1)}for(S in this.setCullMode(e._cullFaces,e._flipFaces,p),v=p.stencilFront||m.stencilFront,T=p.stencilBack||m.stencilBack,v||T?(h.setStencilTest(!0),v===T?(h.setStencilFunc(v.func,v.ref,v.readMask),h.setStencilOperation(v.fail,v.zfail,v.zpass,v.writeMask)):(v?(h.setStencilFuncFront(v.func,v.ref,v.readMask),h.setStencilOperationFront(v.fail,v.zfail,v.zpass,v.writeMask)):(h.setStencilFuncFront(te.FUNC_ALWAYS,0,255),h.setStencilOperationFront(te.STENCILOP_KEEP,te.STENCILOP_KEEP,te.STENCILOP_KEEPP,255)),T?(h.setStencilFuncBack(T.func,T.ref,T.readMask),h.setStencilOperationBack(T.fail,T.zfail,T.zpass,T.writeMask)):(h.setStencilFuncBack(te.FUNC_ALWAYS,0,255),h.setStencilOperationBack(te.STENCILOP_KEEP,te.STENCILOP_KEEP,te.STENCILOP_KEEP,255)))):h.setStencilTest(!1),g=p.parameters)(b=g[S]).passFlags&d&&(b.scopeId||(b.scopeId=h.scope.resolve(S)),b.scopeId.setValue(b.data));if(h.setVertexBuffer(p.morphInstance&&p.morphInstance._vertexBuffer?p.morphInstance._vertexBuffer:f.vertexBuffer,0),v=p.renderStyle,h.setIndexBuffer(f.indexBuffer[v]),r&&r(p,u),c&&c.presenting?(h.setViewport(0,0,E,h.height),this.projId.setValue(M.data),this.viewInvId.setValue(N.data),this.viewId.setValue(B.data),this.viewId3.setValue(z.data),this.viewProjId.setValue(j.data),this.viewPos[0]=V.x,this.viewPos[1]=V.y,this.viewPos[2]=V.z,this.viewPosId.setValue(this.viewPos),u+=this.drawInstance(h,p,f,v,!0),this._forwardDrawCalls++,h.setViewport(E,0,E,h.height),this.projId.setValue(C.data),this.viewInvId.setValue(F.data),this.viewId.setValue(k.data),this.viewId3.setValue(H.data),this.viewProjId.setValue(G.data),this.viewPos[0]=U.x,this.viewPos[1]=U.y,this.viewPos[2]=U.z,this.viewPosId.setValue(this.viewPos),u+=this.drawInstance2(h,p,f,v)):u+=this.drawInstance(h,p,f,v,!0),this._forwardDrawCalls++,u<i-1&&t[u+1].material===m)for(S in g)(b=m.parameters[S])&&(b.scopeId||(b.scopeId=h.scope.resolve(S)),b.scopeId.setValue(b.data));T=m,g=_,v=y,b=p.isStatic}h.updateEnd()},setupInstancing:function(e){te._instanceVertexFormat||(te._instanceVertexFormat=new te.VertexFormat(e,[{semantic:te.SEMANTIC_TEXCOORD2,components:4,type:te.TYPE_FLOAT32},{semantic:te.SEMANTIC_TEXCOORD3,components:4,type:te.TYPE_FLOAT32},{semantic:te.SEMANTIC_TEXCOORD4,components:4,type:te.TYPE_FLOAT32},{semantic:te.SEMANTIC_TEXCOORD5,components:4,type:te.TYPE_FLOAT32}])),e.enableAutoInstancing&&!te._autoInstanceBuffer&&(te._autoInstanceBuffer=new te.VertexBuffer(e,te._instanceVertexFormat,e.autoInstancingMaxObjects,te.BUFFER_DYNAMIC),te._autoInstanceBufferData=new Float32Array(te._autoInstanceBuffer.lock()))},revertStaticMeshes:function(e){var t,i,s,n=e.length,a=[];for(t=0;t<n;t++)(i=e[t])._staticSource?i._staticSource!==s&&(a.push(i._staticSource),s=i._staticSource):a.push(i);for(e.length=a.length,t=0;t<a.length;t++)e[t]=a[t]},prepareStaticMeshes:function(e,t){var i,s,n,a,r,o,h,l,c,d,u,p,f,m,_,g,y,v,b,S,T,E,x,A=this.device,M=e.length,C=[],P=new te.Vec3,I=new te.Vec3,w=new te.BoundingBox,O=new te.Mat4,R=[],L=[],D=[],N=[];for(i=0;i<M;i++)if((o=e[i]).isStatic){for(l=o.aabb,N.length=0,E=te.LIGHTTYPE_POINT;E<=te.LIGHTTYPE_SPOT;E++)for(s=0;s<t.length;s++)(h=t[s])._type===E&&h._enabled&&h._mask&o.mask&&h.isStatic&&(L[s]||(L[s]=new te.BoundingBox,h._node.getWorldTransform(),h.getBoundingSphere(W),L[s].center.copy(W.center),L[s].halfExtents.x=W.radius,L[s].halfExtents.y=W.radius,L[s].halfExtents.z=W.radius),L[s].intersects(l)&&N.push(s));if(0===N.length)C.push(o);else{for(E=(l=o.mesh).vertexBuffer,c=2===(h=l.indexBuffer[o.renderStyle]).bytesPerIndex?new Uint16Array(h.lock()):new Uint32Array(h.lock()),d=l.primitive[o.renderStyle].count/3,m=l.primitive[o.renderStyle].base,u=E.format.elements,p=E.format.size/4,l=new Float32Array(E.storage),n=0;n<u.length;n++)u[n].name===te.SEMANTIC_POSITION&&(f=u[n].offset/4);for(R.length=d,n=0;n<d;n++)R[n]=0;for(u=!1,D.length=6*d,n=0;n<d;n++){for(v=y=g=Number.MAX_VALUE,b=-Number.MAX_VALUE,S=-Number.MAX_VALUE,T=-Number.MAX_VALUE,a=0;a<3;a++)(r=l[s=(s=c[3*n+a+m])*p+f])<g&&(g=r),(_=l[s+1])<y&&(y=_),(s=l[s+2])<v&&(v=s),b<r&&(b=r),S<_&&(S=_),T<s&&(T=s);D[s=6*n]=g,D[s+1]=y,D[s+2]=v,D[s+3]=b,D[s+4]=S,D[s+5]=T}for(r=0;r<N.length;r++)for(s=N[r],O.copy(o.node.worldTransform).invert(),w.setFromTransformedAabb(L[s],O),_=w.getMin(),g=w.getMax(),a=1<<r,n=0;n<d;n++)D[s=6*n]<=g.x&&D[s+3]>=_.x&&D[s+1]<=g.y&&D[s+4]>=_.y&&D[s+2]<=g.z&&D[s+5]>=_.z&&(R[n]|=a,u=!0);if(u){for(u={},n=0;n<d;n++)s=3*n+m,u[x=R[n]]||(u[x]=[]),(a=u[x]).push(c[s]),a.push(c[s+1]),a.push(c[s+2]);for(x in u){for(a=u[x],(2===(c=new te.IndexBuffer(A,h.format,a.length,h.usage)).bytesPerIndex?new Uint16Array(c.lock()):new Uint32Array(c.lock())).set(a),c.unlock(),v=y=g=Number.MAX_VALUE,b=-Number.MAX_VALUE,S=-Number.MAX_VALUE,T=-Number.MAX_VALUE,n=0;n<a.length;n++)(r=l[(s=a[n])*p+f])<g&&(g=r),(_=l[s*p+f+1])<y&&(y=_),(s=l[s*p+f+2])<v&&(v=s),b<r&&(b=r),S<_&&(S=_),T<s&&(T=s);for(P.set(g,y,v),I.set(b,S,T),(n=new te.BoundingBox).setMinMax(P,I),(d=new te.Mesh).vertexBuffer=E,d.indexBuffer[0]=c,d.primitive[0].type=te.PRIMITIVE_TRIANGLES,d.primitive[0].base=0,d.primitive[0].count=a.length,d.primitive[0].indexed=!0,d.aabb=n,(c=new te.MeshInstance(o.node,d,o.material)).isStatic=o.isStatic,c.visible=o.visible,c.layer=o.layer,c.castShadow=o.castShadow,c._receiveShadow=o._receiveShadow,c.cull=o.cull,c.pick=o.pick,c.mask=o.mask,c.parameters=o.parameters,c._shaderDefs=o._shaderDefs,c._staticSource=o,c._staticLightList=o._staticLightList?o._staticLightList:[],n=0;n<N.length;n++)x&(a=1<<n)&&(d=t[N[n]],c._staticLightList.indexOf(d)<0&&c._staticLightList.push(d));c._staticLightList.sort(this.lightCompare),C.push(c)}}else C.push(o)}}else C.push(o);for(e.length=C.length,i=0;i<C.length;i++)e[i]=C[i]},updateShaders:function(e){var t,i=[];for(t=0;t<e.length;t++){var s=e[t];void 0!==s.material&&-1===i.indexOf(s.material)&&i.push(s.material)}for(t=0;t<i.length;t++)(e=i[t]).updateShader!==te.Material.prototype.updateShader&&(e.clearVariants(),e.shader=null)},updateLitShaders:function(e){for(var t=0;t<e.length;t++){var i=e[t];void 0!==i.material&&((i=i.material).updateShader===te.Material.prototype.updateShader||!1===i.useLighting||i.emitter&&!i.emitter.lighting||(i.clearVariants(),i.shader=null))}},beginFrame:function(e){var t=this.device,i=this.scene,s=e._meshInstances;for(e=e._lights,i.updateSkybox&&(i._updateSkybox(t),i.updateSkybox=!1),i.updateShaders?(this.updateShaders(s),i.updateShaders=!1,i.updateLitShaders=!1,i._shaderVersion++):i.updateLitShaders&&(this.updateLitShaders(s),i.updateLitShaders=!1,i._shaderVersion++),this.updateCpuSkinMatrices(s),this.updateMorphedBounds(s),i=s.length,t=0;t<i;t++)s[t].visibleThisFrame=!1;for(i=e.length,t=0;t<i;t++)e[t].visibleThisFrame=e[t]._type===te.LIGHTTYPE_DIRECTIONAL},beginLayers:function(e){var t,i,s,n=this.scene,a=e.layerList.length,r=this.scene._shaderVersion;for(i=0;i<a;i++)e.layerList[i]._postRenderCounter=0;for(i=0;i<a;i++){for((t=e.layerList[i])._shaderVersion=r,t._preRenderCalledForCameras=0,t._postRenderCalledForCameras=0,s=e.subLayerList[i],t._postRenderCounter=s?2|t._postRenderCounter:1|t._postRenderCounter,t._postRenderCounterMax=t._postRenderCounter,s=0;s<t.cameras.length;s++)t.instances.visibleOpaque[s]||(t.instances.visibleOpaque[s]=new te.VisibleInstanceList),t.instances.visibleTransparent[s]||(t.instances.visibleTransparent[s]=new te.VisibleInstanceList),t.instances.visibleOpaque[s].done=!1,t.instances.visibleTransparent[s].done=!1;t.cameras.length<t.instances.visibleOpaque.length&&t.instances.visibleOpaque.splice(t.cameras.length,1),t.cameras.length<t.instances.visibleTransparent.length&&t.instances.visibleTransparent.splice(t.cameras.length,1),t._needsStaticPrepare&&t._staticLightHash&&(t._staticPrepareDone&&(this.revertStaticMeshes(t.opaqueMeshInstances),this.revertStaticMeshes(t.transparentMeshInstances)),this.prepareStaticMeshes(t.opaqueMeshInstances,t._lights),this.prepareStaticMeshes(t.transparentMeshInstances,t._lights),e._dirty=!0,n.updateShaders=!0,t._needsStaticPrepare=!1,t._staticPrepareDone=!0)}},cullLocalShadowmap:function(e,t){var i,s,n,a,r,o,h,l,c,d,u;if((s=e._type)!==te.LIGHTTYPE_DIRECTIONAL)for(e.visibleThisFrame=!0,(n=this.getShadowCamera(this.device,e)).projection=te.PROJECTION_PERSPECTIVE,n.nearClip=e.attenuationEnd/1e3,n.farClip=e.attenuationEnd,n.aspectRatio=1,r=s===te.LIGHTTYPE_SPOT?(n.fov=2*e._outerConeAngle,1):(n.fov=90,6),a=n._node,i=e._node,a.setPosition(i.getPosition()),s===te.LIGHTTYPE_SPOT&&(a.setRotation(i.getRotation()),a.rotateLocal(-90,0,0)),o=0;o<r;o++){for(s===te.LIGHTTYPE_POINT&&(a.setRotation(w[o]),n.renderTarget=e._shadowCubeMap[o]),this.updateCameraFrustum(n),(c=e._visibleList[o])||(c=e._visibleList[o]=[]),i=d=e._visibleLength[o]=0,h=t.length;i<h;i++)u=!0,(l=t[i]).cull&&(u=this._isVisible(n,l)),u&&(c[d]=l,d++,l.visibleThisFrame=!0);e._visibleLength[o]=d,c.length!==d&&(c.length=d),c.sort(this.depthSortCompare)}},cullDirectionalShadowmap:function(e,t,i,s){var n,a,r,o,h,l,c,d,u,p,f,m;for(a=this.device,e.visibleThisFrame=!0,r=(a=this.getShadowCamera(a,e))._node,o=e._node,r.setPosition(o.getPosition()),r.setRotation(o.getRotation()),r.rotateLocal(-90,0,0),d=e.shadowDistance||i._farClip,u=i._nearClip,n=i._fov*Math.PI/180,h=i._aspect,p=(f=(l=i._projection)===te.PROJECTION_PERSPECTIVE?Math.tan(n/2)*u:i._orthoHeight)*h,K[0].x=p,K[0].y=-f,K[0].z=-u,K[1].x=p,K[1].y=f,K[1].z=-u,K[2].x=-p,K[2].y=f,K[2].z=-u,K[3].x=-p,K[3].y=-f,K[3].z=-u,l===te.PROJECTION_PERSPECTIVE&&(p=(f=Math.tan(n/2)*d)*h),K[4].x=p,K[4].y=-f,K[4].z=-d,K[5].x=p,K[5].y=f,K[5].z=-d,K[6].x=-p,K[6].y=f,K[6].z=-d,K[7].x=-p,K[7].y=-f,K[7].z=-d,h=E.sub2(K[0],K[6]).length(),h=Math.max(h,E.sub2(K[4],K[6]).length()),L.copy(r.getWorldTransform()).invert(),_.copy(L).mul(i._node.worldTransform),n=0;n<8;n++)_.transformPoint(K[n],K[n]);for(d=u=i=1e6,p=f=l=-1e6,n=0;n<8;n++)(c=K[n]).x<d&&(d=c.x),c.x>p&&(p=c.x),c.y<u&&(u=c.y),c.y>f&&(f=c.y),c.z<i&&(i=c.z),c.z>l&&(l=c.z);for(n=h/e._shadowResolution,d=.5*((d=Math.floor((d-.5*(h-(p-d)))/n)*n)+h+d),u=.5*((u=Math.floor((u-.5*(h-(f-u)))/n)*n)+h+u),r.translateLocal(d,u,1e5),a.projection=te.PROJECTION_ORTHOGRAPHIC,a.nearClip=0,a.farClip=2e5,a.aspectRatio=1,a.orthoHeight=.5*h,this.updateCameraFrustum(a),f=!0,(l=e._visibleList[s])||(l=e._visibleList[s]=[]),n=h=e._visibleLength[s]=0,p=t.length;n<p;n++)c=!0,(m=t[n]).cull&&(c=this._isVisible(a,m)),c&&(l[h]=m,h++,m.visibleThisFrame=!0,c=m.aabb,f?(Y.copy(c),f=!1):Y.add(c));for(e._visibleLength[s]=h,l.length!==h&&(l.length=h),l.sort(this.depthSortCompare),t=Y.getMin(),n=Y.getMax(),Z[0].x=Z[1].x=Z[2].x=Z[3].x=t.x,Z[1].y=Z[3].y=Z[7].y=Z[5].y=t.y,Z[2].z=Z[3].z=Z[6].z=Z[7].z=t.z,Z[4].x=Z[5].x=Z[6].x=Z[7].x=n.x,Z[0].y=Z[2].y=Z[4].y=Z[6].y=n.y,Z[0].z=Z[1].z=Z[4].z=Z[5].z=n.z,t=-(n=9999999999),l=0;l<8;++l)L.transformPoint(Z[l],Z[l]),(h=Z[l].z)<n&&(n=h),t<h&&(t=h);l=t,i<n&&(i=n),r.setPosition(o.getPosition()),r.translateLocal(d,u,l+.01),a.farClip=l-i,(o=e._visibleCameraSettings[s])||(o=e._visibleCameraSettings[s]={}),e=r.getPosition(),o.x=e.x,o.y=e.y,o.z=e.z,o.orthoHeight=a.orthoHeight,o.farClip=a.farClip},gpuUpdate:function(e){this.updateGpuSkinMatrices(e),this.updateMorphing(e)},clearView:function(e,t,i){e=e.camera;var s=this.device;s.setRenderTarget(t),s.updateBegin(),s.setColorWrite(!0,!0,!0,!0),s.setDepthWrite(!0);var n=e.getRect(),a=t?t.width:s.width,r=t?t.height:s.height;t=Math.floor(n.x*a);var o=Math.floor(n.y*r);a=Math.floor(n.width*a),n=Math.floor(n.height*r);s.setViewport(t,o,a,n),s.setScissor(t,o,a,n),s.clear(i||e._clearOptions)},setSceneConstants:function(){var e,t=this.device,i=this.scene;if(this.dispatchGlobalLights(i),i.fog!==te.FOG_NONE){if(this.fogColor[0]=i.fogColor.r,this.fogColor[1]=i.fogColor.g,this.fogColor[2]=i.fogColor.b,i.gammaCorrection)for(e=0;e<3;e++)this.fogColor[e]=Math.pow(this.fogColor[e],2.2);this.fogColorId.setValue(this.fogColor),i.fog===te.FOG_LINEAR?(this.fogStartId.setValue(i.fogStart),this.fogEndId.setValue(i.fogEnd)):this.fogDensityId.setValue(i.fogDensity)}this._screenSize[0]=t.width,this._screenSize[1]=t.height,this._screenSize[2]=1/t.width,this._screenSize[3]=1/t.height,this.screenSizeId.setValue(this._screenSize)},renderComposition:function(e){var t,i,s,n,a,r,o,h,l,c=this.device,d=e._renderedRt,u=e._renderedByCam,p=e._renderedLayer;this.beginLayers(e),e._update()&te.COMPUPDATED_LIGHTS&&(this.scene.updateLitShaders=!0),this.beginFrame(e),this.setSceneConstants();var f,m,_=0;for(i=0;i<e.layerList.length;i++)if((s=e.layerList[i]).enabled&&e.subLayerEnabled[i])for(n=e.subLayerList[i],f=s.instances,a=s.cameras,r=0;r<a.length;r++)if(t=a[r]){for(t.frameBegin(s.renderTarget),m=n?s.transparentMeshInstances:s.opaqueMeshInstances,l=h=!1,o=0;o<_;o++)if(u[o]===t&&(h=!0,p[o]===s)){l=!0;break}h||(this.updateCameraFrustum(t.camera),this._camerasRendered++),l||this.cullLights(t.camera,s._lights),h&&l||(u[_]=t,p[_]=s,_++),(o=n?f.visibleTransparent[r]:f.visibleOpaque[r]).done||(s.onPreCull&&s.onPreCull(r),o.length=this.cull(t.camera,m,o.list),o.done=!0,s.onPostCull&&s.onPostCull(r)),t.frameEnd()}for(i=0;i<e._lights.length;i++)(t=e._lights[i]).visibleThisFrame&&t._type!==te.LIGHTTYPE_DIRECTIONAL&&t.castShadows&&t._enabled&&t.shadowUpdateMode!==te.SHADOWUPDATE_NONE&&(s=e._lightShadowCasters[i],this.cullLocalShadowmap(t,s));for(n=-1,i=0;i<e._lights.length;i++)if((t=e._lights[i])._type===te.LIGHTTYPE_DIRECTIONAL&&(n++,t.castShadows&&t._enabled&&t.shadowUpdateMode!==te.SHADOWUPDATE_NONE))for(s=e._lightShadowCasters[i],a=e._globalLightCameras[n],r=0;r<a.length;r++)this.cullDirectionalShadowmap(t,s,a[r].camera,e._globalLightCameraIds[n][r]);for(this.gpuUpdate(e._meshInstances),this.renderShadows(e._sortedLights[te.LIGHTTYPE_SPOT]),this.renderShadows(e._sortedLights[te.LIGHTTYPE_POINT]),i=_=0;i<e._renderList.length;i++)if((s=e.layerList[e._renderList[i]]).enabled&&e.subLayerEnabled[e._renderList[i]]){if(f=s.instances,n=e.subLayerList[e._renderList[i]],a=e._renderListCamera[i],(t=s.cameras[a])&&t.frameBegin(s.renderTarget),!n&&s.onPreRenderOpaque?s.onPreRenderOpaque(a):n&&s.onPreRenderTransparent&&s.onPreRenderTransparent(a),s._preRenderCalledForCameras&1<<a||(s.onPreRender&&s.onPreRender(a),s._preRenderCalledForCameras|=1<<a,s.overrideClear&&this.clearView(t,s.renderTarget,s._clearOptions)),t){for(r=s.renderTarget,p=!1,o=0;o<_;o++)if(d[o]===r&&u[o]===t){p=!0;break}p||(s.overrideClear||this.clearView(t,s.renderTarget),d[_]=r,u[_]=t,_++),this.renderShadows(s._sortedLights[te.LIGHTTYPE_DIRECTIONAL],a),s._sortVisible(n,t.node,a),o=n?f.visibleTransparent[a]:f.visibleOpaque[a],this.scene._activeCamera=t.camera,this.setCamera(t.camera,s.renderTarget),this.renderForward(t.camera,o.list,o.length,s._sortedLights,s.shaderPass,s.cullingMask,s.onDrawCall,s),c.setColorWrite(!0,!0,!0,!0),c.setStencilTest(!1),c.setAlphaToCoverage(!1),c.setDepthBias(!1),t.frameEnd()}!n&&s.onPostRenderOpaque?s.onPostRenderOpaque(a):n&&s.onPostRenderTransparent&&s.onPostRenderTransparent(a),!s.onPostRender||s._postRenderCalledForCameras&1<<a||(s._postRenderCounter&=~(n?2:1),0===s._postRenderCounter&&(s.onPostRender(a),s._postRenderCalledForCameras|=1<<a,s._postRenderCounter=s._postRenderCounterMax))}}}),{ForwardRenderer:e,gaussWeights:x}}()),Object.assign(te,(qe=new te.Mat4,Ke=new te.Vec3,Ze=new te.Quat,Qe=new te.Quat,$e=new te.Vec3,Je=new te.Vec3,et=new te.Mat4,tt=new te.Quat,it=function(e){this.name="string"==typeof e?e:"Untitled",this.tags=new te.Tags(this),this._labels={},this.localPosition=new te.Vec3(0,0,0),this.localRotation=new te.Quat(0,0,0,1),this.localScale=new te.Vec3(1,1,1),this.localEulerAngles=new te.Vec3(0,0,0),this.position=new te.Vec3(0,0,0),this.rotation=new te.Quat(0,0,0,1),this.eulerAngles=new te.Vec3(0,0,0),this._scale=null,this.localTransform=new te.Mat4,this._dirtyLocal=!1,this._aabbVer=0,this._frozen=!1,this.worldTransform=new te.Mat4,this._dirtyWorld=!1,this.normalMatrix=new te.Mat3,this._dirtyNormal=!0,this._parent=this._forward=this._up=this._right=null,this._children=[],this._graphDepth=0,this._enabled=!0,this.scaleCompensation=this._enabledInHierarchy=!1},Object.defineProperty(it.prototype,"right",{get:function(){return this._right||(this._right=new te.Vec3),this.getWorldTransform().getX(this._right).normalize()}}),Object.defineProperty(it.prototype,"up",{get:function(){return this._up||(this._up=new te.Vec3),this.getWorldTransform().getY(this._up).normalize()}}),Object.defineProperty(it.prototype,"forward",{get:function(){return this._forward||(this._forward=new te.Vec3),this.getWorldTransform().getZ(this._forward).normalize().scale(-1)}}),Object.defineProperty(it.prototype,"enabled",{get:function(){return this._enabled&&this._enabledInHierarchy},set:function(e){this._enabled!==e&&(this._enabled=e,this._parent&&!this._parent.enabled||this._notifyHierarchyStateChanged(this,e))}}),Object.defineProperty(it.prototype,"parent",{get:function(){return this._parent}}),Object.defineProperty(it.prototype,"path",{get:function(){var e=this._parent;if(e){for(var t=this.name;e&&e._parent;)t=te.string.format("{0}/{1}",e.name,t),e=e._parent;return t}return""}}),Object.defineProperty(it.prototype,"root",{get:function(){var e=this._parent;if(!e)return this;for(;e._parent;)e=e._parent;return e}}),Object.defineProperty(it.prototype,"children",{get:function(){return this._children}}),Object.defineProperty(it.prototype,"graphDepth",{get:function(){return this._graphDepth}}),Object.assign(it.prototype,{_notifyHierarchyStateChanged:function(e,t){e._onHierarchyStateChanged(t);for(var i=e._children,s=0,n=i.length;s<n;s++)i[s]._enabled&&this._notifyHierarchyStateChanged(i[s],t)},_onHierarchyStateChanged:function(e){(this._enabledInHierarchy=e)&&!this._frozen&&this._unfreezeParentToRoot()},_cloneInternal:function(e){e.name=this.name;for(var t=this.tags._list,i=0;i<t.length;i++)e.tags.add(t[i]);e._labels=Object.assign({},this._labels),e.localPosition.copy(this.localPosition),e.localRotation.copy(this.localRotation),e.localScale.copy(this.localScale),e.localEulerAngles.copy(this.localEulerAngles),e.position.copy(this.position),e.rotation.copy(this.rotation),e.eulerAngles.copy(this.eulerAngles),e.localTransform.copy(this.localTransform),e._dirtyLocal=this._dirtyLocal,e.worldTransform.copy(this.worldTransform),e._dirtyWorld=this._dirtyWorld,e._dirtyNormal=this._dirtyNormal,e._aabbVer=this._aabbVer+1,e._enabled=this._enabled,e.scaleCompensation=this.scaleCompensation,e._enabledInHierarchy=!1},clone:function(){var e=new te.GraphNode;return this._cloneInternal(e),e},find:function(e,t){var i,s,n=[],a=this._children.length;if(e instanceof Function)for(i=0;i<a;i++)e(this._children[i])&&n.push(this._children[i]),(s=this._children[i].find(e)).length&&(n=n.concat(s));else for(this[e]&&(i=this[e]instanceof Function?this[e]():this[e])===t&&n.push(this),i=0;i<a;++i)(s=this._children[i].find(e,t)).length&&(n=n.concat(s));return n},findOne:function(e,t){var i,s,n=this._children.length;if(e instanceof Function){if(s=e(this))return this;for(i=0;i<n;i++)if(s=this._children[i].findOne(e))return s}else{if(this[e]&&(i=this[e]instanceof Function?this[e]():this[e])===t)return this;for(i=0;i<n;i++)if(null!==(s=this._children[i].findOne(e,t)))return s}return null},findByTag:function(){var e=this.tags._processArguments(arguments);return this._findByTag(e)},_findByTag:function(e){var t,i,s=[],n=this._children.length;for(t=0;t<n;t++)this._children[t].tags._has(e)&&s.push(this._children[t]),(i=this._children[t]._findByTag(e)).length&&(s=s.concat(i));return s},findByName:function(e){if(this.name===e)return this;for(var t=0;t<this._children.length;t++){var i=this._children[t].findByName(e);if(null!==i)return i}return null},findByPath:function(e){for(var t=this,i=null,s=0,n=(e=e.split("/")).length;s<n&&t;s++){for(var a=e[s],r=(i=null,0),o=(t=t._children).length;r<o;r++)if(t[r].name==a){i=t[r];break}t=i}return i},forEach:function(e,t){e.call(t,this);for(var i=this._children,s=0;s<i.length;s++)i[s].forEach(e,t)},isDescendantOf:function(e){for(var t=this._parent;t;){if(t===e)return!0;t=t._parent}return!1},isAncestorOf:function(e){return e.isDescendantOf(this)},getEulerAngles:function(){return this.getWorldTransform().getEulerAngles(this.eulerAngles),this.eulerAngles},getLocalEulerAngles:function(){return this.localRotation.getEulerAngles(this.localEulerAngles),this.localEulerAngles},getLocalPosition:function(){return this.localPosition},getLocalRotation:function(){return this.localRotation},getLocalScale:function(){return this.localScale},getLocalTransform:function(){return this._dirtyLocal&&(this.localTransform.setTRS(this.localPosition,this.localRotation,this.localScale),this._dirtyLocal=!1),this.localTransform},getPosition:function(){return this.getWorldTransform().getTranslation(this.position),this.position},getRotation:function(){return this.rotation.setFromMat4(this.getWorldTransform()),this.rotation},getScale:function(){return this._scale||(this._scale=new te.Vec3),this.getWorldTransform().getScale(this._scale)},getWorldTransform:function(){return(this._dirtyLocal||this._dirtyWorld)&&(this._parent&&this._parent.getWorldTransform(),this._sync()),this.worldTransform},reparent:function(e,t){var i=this._parent;i&&i.removeChild(this),e&&(0<=t?e.insertChild(this,t):e.addChild(this))},setLocalEulerAngles:function(e,t,i){e instanceof te.Vec3?this.localRotation.setFromEulerAngles(e.x,e.y,e.z):this.localRotation.setFromEulerAngles(e,t,i),this._dirtyLocal||this._dirtifyLocal()},setLocalPosition:function(e,t,i){e instanceof te.Vec3?this.localPosition.copy(e):this.localPosition.set(e,t,i),this._dirtyLocal||this._dirtifyLocal()},setLocalRotation:function(e,t,i,s){e instanceof te.Quat?this.localRotation.copy(e):this.localRotation.set(e,t,i,s),this._dirtyLocal||this._dirtifyLocal()},setLocalScale:function(e,t,i){e instanceof te.Vec3?this.localScale.copy(e):this.localScale.set(e,t,i),this._dirtyLocal||this._dirtifyLocal()},_dirtifyLocal:function(){this._dirtyLocal||(this._dirtyLocal=!0,this._dirtyWorld||this._dirtifyWorld())},_unfreezeParentToRoot:function(){for(var e=this._parent;e;)e._frozen=!1,e=e._parent},_dirtifyWorld:function(){this._dirtyWorld||this._unfreezeParentToRoot(),this._dirtifyWorldInternal()},_dirtifyWorldInternal:function(){if(!this._dirtyWorld){this._frozen=!1,this._dirtyWorld=!0;for(var e=0;e<this._children.length;e++)this._children[e]._dirtyWorld||this._children[e]._dirtifyWorldInternal()}this._dirtyNormal=!0,this._aabbVer++},setPosition:(Ye=new te.Vec3,Xe=new te.Mat4,function(e,t,i){e instanceof te.Vec3?Ye.copy(e):Ye.set(e,t,i),null===this._parent?this.localPosition.copy(Ye):(Xe.copy(this._parent.getWorldTransform()).invert(),Xe.transformPoint(Ye,this.localPosition)),this._dirtyLocal||this._dirtifyLocal()}),setRotation:(Ge=new te.Quat,We=new te.Quat,function(e,t,i,s){e instanceof te.Quat?Ge.copy(e):Ge.set(e,t,i,s),null===this._parent?this.localRotation.copy(Ge):(e=this._parent.getRotation(),We.copy(e).invert(),this.localRotation.copy(We).mul(Ge)),this._dirtyLocal||this._dirtifyLocal()}),setEulerAngles:(je=new te.Quat,function(e,t,i){e instanceof te.Vec3?this.localRotation.setFromEulerAngles(e.x,e.y,e.z):this.localRotation.setFromEulerAngles(e,t,i),null!==this._parent&&(e=this._parent.getRotation(),je.copy(e).invert(),this.localRotation.mul2(je,this.localRotation)),this._dirtyLocal||this._dirtifyLocal()}),addChild:function(e){if(null!==e._parent)throw Error("GraphNode is already parented");this._children.push(e),this._onInsertChild(e)},addChildAndSaveTransform:function(e){var t=e.getPosition(),i=e.getRotation(),s=e._parent;s&&s.removeChild(e),e.setPosition(et.copy(this.worldTransform).invert().transformPoint(t)),e.setRotation(tt.copy(this.getRotation()).invert().mul(i)),this._children.push(e),this._onInsertChild(e)},insertChild:function(e,t){if(null!==e._parent)throw Error("GraphNode is already parented");this._children.splice(t,0,e),this._onInsertChild(e)},_onInsertChild:function(e){e._parent=this;var t=e._enabled&&this.enabled;e._enabledInHierarchy!==t&&(e._enabledInHierarchy=t,e._notifyHierarchyStateChanged(e,t)),e._updateGraphDepth(),e._dirtifyWorld(),this._frozen&&e._unfreezeParentToRoot(),e.fire&&e.fire("insert",this),this.fire&&this.fire("childinsert",e)},_updateGraphDepth:function(){this._graphDepth=this._parent?this._parent._graphDepth+1:0;for(var e=0,t=this._children.length;e<t;e++)this._children[e]._updateGraphDepth()},removeChild:function(e){var t,i=this._children.length;for(t=0;t<i;++t)if(this._children[t]===e){this._children.splice(t,1),e._parent=null,this.fire&&this.fire("childremove",e);break}},_sync:function(){if(this._dirtyLocal&&(this.localTransform.setTRS(this.localPosition,this.localRotation,this.localScale),this._dirtyLocal=!1),this._dirtyWorld){if(null===this._parent)this.worldTransform.copy(this.localTransform);else if(this.scaleCompensation){var e,t=this._parent,i=this.localScale,s=t;if(s){for(;s&&s.scaleCompensation;)s=s._parent;s&&(s=s._parent)&&(e=s.worldTransform.getScale(),$e.mul2(e,this.localScale),i=$e)}Qe.setFromMat4(t.worldTransform),Ze.mul2(Qe,this.localRotation),s=t.worldTransform,t.scaleCompensation&&(Je.mul2(e,t.getLocalScale()),qe.setTRS(t.worldTransform.getTranslation(Ke),Qe,Je),s=qe),s.transformPoint(this.localPosition,Ke),this.worldTransform.setTRS(Ke,Ze,i)}else this.worldTransform.mul2(this._parent.worldTransform,this.localTransform);this._dirtyWorld=!1}},syncHierarchy:function(){if(this._enabled&&!this._frozen){this._frozen=!0,(this._dirtyLocal||this._dirtyWorld)&&this._sync();for(var e=this._children,t=0,i=e.length;t<i;t++)e[t].syncHierarchy()}},lookAt:(Ve=new te.Mat4,Ue=new te.Vec3,ze=new te.Vec3,He=new te.Quat,function(e,t,i,s,n,a){if(e instanceof te.Vec3)Ue.copy(e),t instanceof te.Vec3?ze.copy(t):ze.copy(te.Vec3.UP);else{if(void 0===i)return;Ue.set(e,t,i),void 0!==s?ze.set(s,n,a):ze.copy(te.Vec3.UP)}Ve.setLookAt(this.getPosition(),Ue,ze),He.setFromMat4(Ve),this.setRotation(He)}),translate:(ke=new te.Vec3,function(e,t,i){e instanceof te.Vec3?ke.copy(e):ke.set(e,t,i),ke.add(this.getPosition()),this.setPosition(ke)}),translateLocal:(Be=new te.Vec3,function(e,t,i){e instanceof te.Vec3?Be.copy(e):Be.set(e,t,i),this.localRotation.transformVector(Be,Be),this.localPosition.add(Be),this._dirtyLocal||this._dirtifyLocal()}),rotate:(Ne=new te.Quat,Fe=new te.Quat,function(e,t,i){e instanceof te.Vec3?Ne.setFromEulerAngles(e.x,e.y,e.z):Ne.setFromEulerAngles(e,t,i),null===this._parent?this.localRotation.mul2(Ne,this.localRotation):(e=this.getRotation(),t=this._parent.getRotation(),Fe.copy(t).invert(),Ne.mul2(Fe,Ne),this.localRotation.mul2(Ne,e)),this._dirtyLocal||this._dirtifyLocal()}),rotateLocal:(De=new te.Quat,function(e,t,i){e instanceof te.Vec3?De.setFromEulerAngles(e.x,e.y,e.z):De.setFromEulerAngles(e,t,i),this.localRotation.mul(De),this._dirtyLocal||this._dirtifyLocal()})}),{GraphNode:it})),Object.assign(te,(st=new te.Vec3,nt=new te.Vec3,at=new te.Vec3,rt=new te.Mat4,ot=function(){this._projection=te.PROJECTION_PERSPECTIVE,this._nearClip=.1,this._farClip=1e4,this._shaderParams=new Float32Array(4),this._fov=45,this._orthoHeight=10,this._aspect=16/9,this._aspectRatioMode=te.ASPECT_AUTO,this.frustumCulling=this._horizontalFov=!1,this.cullingMask=4294967295,this._renderDepthRequests=0,this._projMatDirty=!0,this._projMat=new te.Mat4,this._viewMatDirty=!0,this._viewMat=new te.Mat4,this._viewProjMatDirty=!0,this._viewProjMat=new te.Mat4,this.vrDisplay=null,this._rect={x:0,y:0,width:1,height:1},this._scissorRect={x:0,y:0,width:1,height:1},this.frustum=new te.Frustum(this._projMat,this._viewMat),this._depthTarget=this.renderTarget=null,this._clearOptions={color:[.5,.5,.5,1],depth:1,stencil:0,flags:te.CLEARFLAG_COLOR|te.CLEARFLAG_DEPTH|te.CLEARFLAG_STENCIL},this.calculateTransform=this._node=null,this.overrideCalculateTransform=!1,this.calculateProjection=null,this.overrideCalculateProjection=!1,this._cullFaces=!0,this._flipFaces=!1,this._component=null},Object.assign(ot.prototype,{clone:function(){var e=new te.Camera;return e.projection=this._projection,e.nearClip=this._nearClip,e.farClip=this._farClip,e._shaderParams=this._shaderParams.slice(),e.fov=this._fov,e.aspectRatio=this._aspect,e._aspectRatioMode=this._aspectRatioMode,e.renderTarget=this.renderTarget,e.setClearOptions(this.getClearOptions()),e.frustumCulling=this.frustumCulling,e.cullingMask=this.cullingMask,e},worldToScreen:function(e,t,i,s){if(void 0===s&&(s=new te.Vec3),this._projMatDirty||this._viewMatDirty||this._viewProjMatDirty){var n=this.getProjectionMatrix(),a=this.getViewMatrix();this._viewProjMat.mul2(n,a),this._viewProjMatDirty=!1}return this._viewProjMat.transformPoint(e,s),n=this._viewProjMat.data,e=e.x*n[3]+e.y*n[7]+e.z*n[11]+1*n[15],s.x=.5*(s.x/e+1)*t,s.y=.5*(1-s.y/e)*i,s},screenToWorld:function(e,t,i,s,n,a){if(void 0===a&&(a=new te.Vec3),this._projMatDirty||this._viewMatDirty||this._viewProjMatDirty){var r=this.getProjectionMatrix(),o=this.getViewMatrix();this._viewProjMat.mul2(r,o),this._viewProjMatDirty=!1}return rt.copy(this._viewProjMat).invert(),this._projection===te.PROJECTION_PERSPECTIVE?(nt.set(e/s*2-1,(n-t)/n*2-1,1),rt.transformPoint(nt,at),at.scale(1/(nt.x*rt.data[3]+nt.y*rt.data[7]+nt.z*rt.data[11]+rt.data[15])),e=i/this._farClip,a.lerp(this._node.getPosition(),at,e)):(st.set(e/s,(n-t)/n,i/(this._farClip-this._nearClip)),st.scale(2),st.sub(te.Vec3.ONE),rt.transformPoint(st,a)),a},getClearOptions:function(){return this._clearOptions},getProjectionMatrix:function(){if(this._projMatDirty){if(this._projection===te.PROJECTION_PERSPECTIVE)this._projMat.setPerspective(this._fov,this._aspect,this._nearClip,this._farClip,this._horizontalFov);else{var e=this._orthoHeight,t=e*this._aspect;this._projMat.setOrtho(-t,t,-e,e,this._nearClip,this._farClip)}e=this._nearClip,t=this._farClip,this._shaderParams[0]=1/t,this._shaderParams[1]=t,this._shaderParams[2]=(1-t/e)/2,this._shaderParams[3]=(1+t/e)/2,this._projMatDirty=!1}return this._projMat},getViewMatrix:function(){if(this._viewMatDirty){var e=this._node.getWorldTransform();this._viewMat.copy(e).invert(),this._viewMatDirty=!1}return this._viewMat},getRect:function(){return this._rect},setClearOptions:function(e){this._clearOptions.color[0]=e.color[0],this._clearOptions.color[1]=e.color[1],this._clearOptions.color[2]=e.color[2],this._clearOptions.color[3]=e.color[3],this._clearOptions.depth=e.depth,this._clearOptions.stencil=e.stencil,this._clearOptions.flags=e.flags},setRect:function(e,t,i,s){this._rect.x=e,this._rect.y=t,this._rect.width=i,this._rect.height=s},setScissorRect:function(e,t,i,s){this._scissorRect.x=e,this._scissorRect.y=t,this._scissorRect.width=i,this._scissorRect.height=s},requestDepthMap:function(){this._renderDepthRequests++},releaseDepthMap:function(){this._renderDepthRequests--}}),Object.defineProperty(ot.prototype,"aspectRatio",{get:function(){return this._aspect},set:function(e){this._aspect!==e&&(this._aspect=e,this._projMatDirty=!0)}}),Object.defineProperty(ot.prototype,"projection",{get:function(){return this._projection},set:function(e){this._projection!==e&&(this._projection=e,this._projMatDirty=!0)}}),Object.defineProperty(ot.prototype,"nearClip",{get:function(){return this._nearClip},set:function(e){this._nearClip!==e&&(this._nearClip=e,this._projMatDirty=!0)}}),Object.defineProperty(ot.prototype,"farClip",{get:function(){return this._farClip},set:function(e){this._farClip!==e&&(this._farClip=e,this._projMatDirty=!0)}}),Object.defineProperty(ot.prototype,"fov",{get:function(){return this._fov},set:function(e){this._fov!==e&&(this._fov=e,this._projMatDirty=!0)}}),Object.defineProperty(ot.prototype,"horizontalFov",{get:function(){return this._horizontalFov},set:function(e){this._horizontalFov!==e&&(this._horizontalFov=e,this._projMatDirty=!0)}}),Object.defineProperty(ot.prototype,"orthoHeight",{get:function(){return this._orthoHeight},set:function(e){this._orthoHeight!==e&&(this._orthoHeight=e,this._projMatDirty=!0)}}),Object.defineProperty(ot.prototype,"clearColor",{get:function(){return this._clearOptions.color},set:function(e){this._clearOptions.color[0]=e[0],this._clearOptions.color[1]=e[1],this._clearOptions.color[2]=e[2],this._clearOptions.color[3]=e[3]}}),Object.defineProperty(ot.prototype,"clearDepth",{get:function(){return this._clearOptions.depth},set:function(e){this._clearOptions.depth=e}}),Object.defineProperty(ot.prototype,"clearStencil",{get:function(){return this._clearOptions.stencil},set:function(e){this._clearOptions.stencil=e}}),Object.defineProperty(ot.prototype,"clearFlags",{get:function(){return this._clearOptions.flags},set:function(e){this._clearOptions.flags=e}}),{Camera:ot})),Object.assign(te,(ht=new te.Vec3,lt=new te.Vec3,ct=new te.Vec3,dt={r:0,g:1,b:2,a:3},ut=function(){this._type=te.LIGHTTYPE_DIRECTIONAL,this._color=new te.Color(.8,.8,.8),this._intensity=1,this._enabled=this._castShadows=!1,this._mask=1,this.isStatic=!1,this.key=0,this.bakeDir=!0,this.attenuationEnd=this.attenuationStart=10,this._falloffMode=0,this._shadowType=te.SHADOW_PCF3,this._vsmBlurSize=11,this.vsmBlurMode=te.BLUR_GAUSSIAN,this.vsmBias=.0025,this._cookie=null,this.cookieIntensity=1,this._cookieFalloff=!0,this._cookieChannel="rgb",this._cookieTransform=null,this._cookieTransformUniform=new Float32Array(4),this._cookieOffset=null,this._cookieOffsetUniform=new Float32Array(2),this._cookieOffsetSet=this._cookieTransformSet=!1,this._innerConeAngle=40,this._outerConeAngle=45,this._finalColor=new Float32Array([.8,.8,.8]);var e=Math.pow(this._finalColor[0],2.2);this._linearFinalColor=new Float32Array([e,e,e]),this._position=new te.Vec3(0,0,0),this._direction=new te.Vec3(0,0,0),this._innerConeAngleCos=Math.cos(this._innerConeAngle*Math.PI/180),this._outerConeAngleCos=Math.cos(this._outerConeAngle*Math.PI/180),this._shadowCamera=null,this._shadowMatrix=new te.Mat4,this.shadowDistance=40,this._shadowResolution=1024,this.shadowBias=-5e-4,this._normalOffsetBias=0,this.shadowUpdateMode=te.SHADOWUPDATE_REALTIME,this._node=this._scene=null,this._rendererParams=[],this._isVsm=!1,this._isPcf=!0,this._isCachedShadowMap=this._cacheShadowMap=!1,this._visibleLength=[0],this._visibleList=[[]],this._visibleCameraSettings=[]},Object.assign(ut.prototype,{destroy:function(){this._destroyShadowMap()},clone:function(){var e=new te.Light;return e.type=this._type,e.setColor(this._color),e.intensity=this._intensity,e.castShadows=this.castShadows,e.enabled=this._enabled,e.attenuationStart=this.attenuationStart,e.attenuationEnd=this.attenuationEnd,e.falloffMode=this._falloffMode,e.shadowType=this._shadowType,e.vsmBlurSize=this._vsmBlurSize,e.vsmBlurMode=this.vsmBlurMode,e.vsmBias=this.vsmBias,e.shadowUpdateMode=this.shadowUpdateMode,e.mask=this._mask,e.innerConeAngle=this._innerConeAngle,e.outerConeAngle=this._outerConeAngle,e.shadowBias=this.shadowBias,e.normalOffsetBias=this._normalOffsetBias,e.shadowResolution=this._shadowResolution,e.shadowDistance=this.shadowDistance,e},getColor:function(){return this._color},getBoundingSphere:function(e){if(this._type===te.LIGHTTYPE_SPOT){var t=this.attenuationEnd,i=this._outerConeAngle,s=Math.cos(i*te.math.DEG_TO_RAD),n=this._node;ht.copy(n.up),ht.scale(.5*-t*s),ht.add(n.getPosition()),e.center=ht,lt.copy(n.up),lt.scale(-t),ct.copy(n.right),ct.scale(Math.sin(i*te.math.DEG_TO_RAD)*t),lt.add(ct),e.radius=.5*lt.length()}else this._type===te.LIGHTTYPE_POINT&&(e.center=this._node.getPosition(),e.radius=this.attenuationEnd)},getBoundingBox:function(e){if(this._type===te.LIGHTTYPE_SPOT){var t=this.attenuationEnd,i=this._node,s=Math.abs(Math.sin(this._outerConeAngle*te.math.DEG_TO_RAD)*t);e.center.set(0,.5*-t,0),e.halfExtents.set(s,.5*t,s),e.setFromTransformedAabb(e,i.getWorldTransform())}else this._type===te.LIGHTTYPE_POINT&&(e.center.copy(this._node.getPosition()),e.halfExtents.set(this.attenuationEnd,this.attenuationEnd,this.attenuationEnd))},_updateFinalColor:function(){var e=(i=this._color).r,t=i.g,i=i.b,s=this._intensity,n=this._finalColor,a=this._linearFinalColor;n[0]=e*s,n[1]=t*s,n[2]=i*s,1<=s?(a[0]=Math.pow(e,2.2)*s,a[1]=Math.pow(t,2.2)*s,a[2]=Math.pow(i,2.2)*s):(a[0]=Math.pow(n[0],2.2),a[1]=Math.pow(n[1],2.2),a[2]=Math.pow(n[2],2.2))},setColor:function(){var e,t,i;1===arguments.length?(e=arguments[0].r,t=arguments[0].g,i=arguments[0].b):3===arguments.length&&(e=arguments[0],t=arguments[1],i=arguments[2]),this._color.set(e,t,i),this._updateFinalColor()},_destroyShadowMap:function(){if(this._shadowCamera){if(!this._isCachedShadowMap){var e,t=this._shadowCamera.renderTarget;if(t)if(t.length)for(e=0;e<t.length;e++)t[e].colorBuffer&&t[e].colorBuffer.destroy(),t[e].destroy();else t.colorBuffer&&t.colorBuffer.destroy(),t.depthBuffer&&t.depthBuffer.destroy(),t.destroy()}this._shadowCubeMap=this._shadowCamera=this._shadowCamera.renderTarget=null,this.shadowUpdateMode===te.SHADOWUPDATE_NONE&&(this.shadowUpdateMode=te.SHADOWUPDATE_THISFRAME)}},updateShadow:function(){this.shadowUpdateMode!==te.SHADOWUPDATE_REALTIME&&(this.shadowUpdateMode=te.SHADOWUPDATE_THISFRAME)},updateKey:function(){var e=this._type<<29|(this._castShadows?1:0)<<28|this._shadowType<<25|this._falloffMode<<23|(0!==this._normalOffsetBias?1:0)<<22|(this._cookie?1:0)<<21|(this._cookieFalloff?1:0)<<20|dt[this._cookieChannel.charAt(0)]<<18|(this._cookieTransform?1:0)<<12;3===this._cookieChannel.length&&(e|=dt[this._cookieChannel.charAt(1)]<<16,e|=dt[this._cookieChannel.charAt(2)]<<14),e!==this.key&&null!==this._scene&&(this._scene.layers._dirtyLights=!0),this.key=e}}),Object.defineProperty(ut.prototype,"enabled",{get:function(){return this._type},set:function(e){this._type!==e&&(this._enabled=e)}}),Object.defineProperty(ut.prototype,"type",{get:function(){return this._type},set:function(e){this._type!==e&&(this._type=e,this._destroyShadowMap(),this.updateKey(),e=this._shadowType,this._shadowType=null,this.shadowType=e)}}),Object.defineProperty(ut.prototype,"mask",{get:function(){return this._mask},set:function(e){this._mask!==e&&(this._mask=e)}}),Object.defineProperty(ut.prototype,"shadowType",{get:function(){return this._shadowType},set:function(e){if(this._shadowType!==e){var t=te.Application.getApplication().graphicsDevice;this._type===te.LIGHTTYPE_POINT&&(e=te.SHADOW_PCF3),e!==te.SHADOW_PCF5||t.webgl2||(e=te.SHADOW_PCF3),e!==te.SHADOW_VSM32||t.textureFloatRenderable||(e=te.SHADOW_VSM16),e!==te.SHADOW_VSM16||t.textureHalfFloatRenderable||(e=te.SHADOW_VSM8),this._isVsm=e>=te.SHADOW_VSM8&&e<=te.SHADOW_VSM32,this._isPcf=e===te.SHADOW_PCF5||e===te.SHADOW_PCF3,this._shadowType=e,this._destroyShadowMap(),this.updateKey()}}}),Object.defineProperty(ut.prototype,"castShadows",{get:function(){return this._castShadows&&this._mask!==te.MASK_LIGHTMAP&&0!==this._mask},set:function(e){this._castShadows!==e&&(this._castShadows=e,this.updateKey())}}),Object.defineProperty(ut.prototype,"shadowResolution",{get:function(){return this._shadowResolution},set:function(e){if(this._shadowResolution!==e){var t=te.Application.getApplication().graphicsDevice;this._shadowResolution=e=this._type===te.LIGHTTYPE_POINT?Math.min(e,t.maxCubeMapSize):Math.min(e,t.maxTextureSize)}}}),Object.defineProperty(ut.prototype,"vsmBlurSize",{get:function(){return this._vsmBlurSize},set:function(e){this._vsmBlurSize!==e&&(0==e%2&&e++,this._vsmBlurSize=e)}}),Object.defineProperty(ut.prototype,"normalOffsetBias",{get:function(){return this._normalOffsetBias},set:function(e){this._normalOffsetBias!==e&&((!this._normalOffsetBias&&e||this._normalOffsetBias&&!e)&&this.updateKey(),this._normalOffsetBias=e)}}),Object.defineProperty(ut.prototype,"falloffMode",{get:function(){return this._falloffMode},set:function(e){this._falloffMode!==e&&(this._falloffMode=e,this.updateKey())}}),Object.defineProperty(ut.prototype,"innerConeAngle",{get:function(){return this._innerConeAngle},set:function(e){this._innerConeAngle!==e&&(this._innerConeAngle=e,this._innerConeAngleCos=Math.cos(e*Math.PI/180))}}),Object.defineProperty(ut.prototype,"outerConeAngle",{get:function(){return this._outerConeAngle},set:function(e){this._outerConeAngle!==e&&(this._outerConeAngle=e,this._outerConeAngleCos=Math.cos(e*Math.PI/180))}}),Object.defineProperty(ut.prototype,"intensity",{get:function(){return this._intensity},set:function(e){this._intensity!==e&&(this._intensity=e,this._updateFinalColor())}}),Object.defineProperty(ut.prototype,"cookie",{get:function(){return this._cookie},set:function(e){this._cookie!==e&&(this._cookie=e,this.updateKey())}}),Object.defineProperty(ut.prototype,"cookieFalloff",{get:function(){return this._cookieFalloff},set:function(e){this._cookieFalloff!==e&&(this._cookieFalloff=e,this.updateKey())}}),Object.defineProperty(ut.prototype,"cookieChannel",{get:function(){return this._cookieChannel},set:function(e){if(this._cookieChannel!==e){if(e.length<3)for(var t=e.charAt(e.length-1),i=3-e.length,s=0;s<i;s++)e+=t;this._cookieChannel=e,this.updateKey()}}}),Object.defineProperty(ut.prototype,"cookieTransform",{get:function(){return this._cookieTransform},set:function(e){this._cookieTransform!==e&&(this._cookieTransform=e,this._cookieTransformSet=!!e,e&&!this._cookieOffset&&(this.cookieOffset=new te.Vec2,this._cookieOffsetSet=!1),this.updateKey())}}),Object.defineProperty(ut.prototype,"cookieOffset",{get:function(){return this._cookieOffset},set:function(e){this._cookieOffset!==e&&((this._cookieTransformSet||e)&&!e&&this._cookieOffset?this._cookieOffset.set(0,0):this._cookieOffset=e,this._cookieOffsetSet=!!e,e&&!this._cookieTransform&&(this.cookieTransform=new te.Vec4(1,1,0,0),this._cookieTransformSet=!1),this.updateKey())}}),{Light:ut})),Object.assign(te,(pt=0,ft=function(){this.name="Untitled",this.id=pt++,this._shader=null,this.variants={},this.parameters={},this.alphaTest=0,this.blend=this.alphaToCoverage=!1,this.blendSrc=te.BLENDMODE_ONE,this.blendDst=te.BLENDMODE_ZERO,this.blendEquation=te.BLENDEQUATION_ADD,this.separateAlphaBlend=!1,this.blendSrcAlpha=te.BLENDMODE_ONE,this.blendDstAlpha=te.BLENDMODE_ZERO,this.blendAlphaEquation=te.BLENDEQUATION_ADD,this.cull=te.CULLFACE_BACK,this.depthWrite=this.depthTest=!0,this.stencilBack=this.stencilFront=null,this.slopeDepthBias=this.depthBias=0,this.alphaWrite=this.blueWrite=this.greenWrite=this.redWrite=!0,this.meshInstances=[],this._shaderVersion=0,this._scene=null,this._dirtyBlend=!1,this.dirty=!0},Object.defineProperty(ft.prototype,"shader",{get:function(){return this._shader},set:function(e){this._shader=e}}),Object.defineProperty(ft.prototype,"blendType",{get:function(){if(!this.blend&&this.blendSrc===te.BLENDMODE_ONE&&this.blendDst===te.BLENDMODE_ZERO&&this.blendEquation===te.BLENDEQUATION_ADD)return te.BLEND_NONE;if(!this.blend||this.blendSrc!==te.BLENDMODE_SRC_ALPHA||this.blendDst!==te.BLENDMODE_ONE_MINUS_SRC_ALPHA||this.blendEquation!==te.BLENDEQUATION_ADD){if(this.blend&&this.blendSrc===te.BLENDMODE_ONE&&this.blendDst===te.BLENDMODE_ONE&&this.blendEquation===te.BLENDEQUATION_ADD)return te.BLEND_ADDITIVE;if(this.blend&&this.blendSrc===te.BLENDMODE_SRC_ALPHA&&this.blendDst===te.BLENDMODE_ONE&&this.blendEquation===te.BLENDEQUATION_ADD)return te.BLEND_ADDITIVEALPHA;if(this.blend&&this.blendSrc===te.BLENDMODE_DST_COLOR&&this.blendDst===te.BLENDMODE_SRC_COLOR&&this.blendEquation===te.BLENDEQUATION_ADD)return te.BLEND_MULTIPLICATIVE2X;if(this.blend&&this.blendSrc===te.BLENDMODE_ONE_MINUS_DST_COLOR&&this.blendDst===te.BLENDMODE_ONE&&this.blendEquation===te.BLENDEQUATION_ADD)return te.BLEND_SCREEN;if(this.blend&&this.blendSrc===te.BLENDMODE_ONE&&this.blendDst===te.BLENDMODE_ONE&&this.blendEquation===te.BLENDEQUATION_MIN)return te.BLEND_MIN;if(this.blend&&this.blendSrc===te.BLENDMODE_ONE&&this.blendDst===te.BLENDMODE_ONE&&this.blendEquation===te.BLENDEQUATION_MAX)return te.BLEND_MAX;if(this.blend&&this.blendSrc===te.BLENDMODE_DST_COLOR&&this.blendDst===te.BLENDMODE_ZERO&&this.blendEquation===te.BLENDEQUATION_ADD)return te.BLEND_MULTIPLICATIVE;if(this.blend&&this.blendSrc===te.BLENDMODE_ONE&&this.blendDst===te.BLENDMODE_ONE_MINUS_SRC_ALPHA&&this.blendEquation===te.BLENDEQUATION_ADD)return te.BLEND_PREMULTIPLIED}return te.BLEND_NORMAL},set:function(e){var t=this.blend!==te.BLEND_NONE;switch(e){case te.BLEND_NONE:this.blend=!1,this.blendSrc=te.BLENDMODE_ONE,this.blendDst=te.BLENDMODE_ZERO,this.blendEquation=te.BLENDEQUATION_ADD;break;case te.BLEND_NORMAL:this.blend=!0,this.blendSrc=te.BLENDMODE_SRC_ALPHA,this.blendDst=te.BLENDMODE_ONE_MINUS_SRC_ALPHA,this.blendEquation=te.BLENDEQUATION_ADD;break;case te.BLEND_PREMULTIPLIED:this.blend=!0,this.blendSrc=te.BLENDMODE_ONE,this.blendDst=te.BLENDMODE_ONE_MINUS_SRC_ALPHA,this.blendEquation=te.BLENDEQUATION_ADD;break;case te.BLEND_ADDITIVE:this.blend=!0,this.blendDst=this.blendSrc=te.BLENDMODE_ONE,this.blendEquation=te.BLENDEQUATION_ADD;break;case te.BLEND_ADDITIVEALPHA:this.blend=!0,this.blendSrc=te.BLENDMODE_SRC_ALPHA,this.blendDst=te.BLENDMODE_ONE,this.blendEquation=te.BLENDEQUATION_ADD;break;case te.BLEND_MULTIPLICATIVE2X:this.blend=!0,this.blendSrc=te.BLENDMODE_DST_COLOR,this.blendDst=te.BLENDMODE_SRC_COLOR,this.blendEquation=te.BLENDEQUATION_ADD;break;case te.BLEND_SCREEN:this.blend=!0,this.blendSrc=te.BLENDMODE_ONE_MINUS_DST_COLOR,this.blendDst=te.BLENDMODE_ONE,this.blendEquation=te.BLENDEQUATION_ADD;break;case te.BLEND_MULTIPLICATIVE:this.blend=!0,this.blendSrc=te.BLENDMODE_DST_COLOR,this.blendDst=te.BLENDMODE_ZERO,this.blendEquation=te.BLENDEQUATION_ADD;break;case te.BLEND_MIN:this.blend=!0,this.blendDst=this.blendSrc=te.BLENDMODE_ONE,this.blendEquation=te.BLENDEQUATION_MIN;break;case te.BLEND_MAX:this.blend=!0,this.blendDst=this.blendSrc=te.BLENDMODE_ONE,this.blendEquation=te.BLENDEQUATION_MAX}t!=(this.blend!==te.BLEND_NONE)&&(this._scene?this._scene.layers._dirtyBlend=!0:this._dirtyBlend=!0),this._updateMeshInstanceKeys()}}),ft.prototype._cloneInternal=function(e){e.name=this.name,e.shader=this.shader,e.alphaTest=this.alphaTest,e.alphaToCoverage=this.alphaToCoverage,e.blend=this.blend,e.blendSrc=this.blendSrc,e.blendDst=this.blendDst,e.blendEquation=this.blendEquation,e.separateAlphaBlend=this.separateAlphaBlend,e.blendSrcAlpha=this.blendSrcAlpha,e.blendDstAlpha=this.blendDstAlpha,e.blendAlphaEquation=this.blendAlphaEquation,e.cull=this.cull,e.depthTest=this.depthTest,e.depthWrite=this.depthWrite,e.depthBias=this.depthBias,e.slopeDepthBias=this.slopeDepthBias,this.stencilFront&&(e.stencilFront=this.stencilFront.clone()),this.stencilBack&&(e.stencilBack=this.stencilFront===this.stencilBack?e.stencilFront:this.stencilBack.clone()),e.redWrite=this.redWrite,e.greenWrite=this.greenWrite,e.blueWrite=this.blueWrite,e.alphaWrite=this.alphaWrite},ft.prototype.clone=function(){var e=new te.Material;return this._cloneInternal(e),e},ft.prototype._updateMeshInstanceKeys=function(){var e,t=this.meshInstances;for(e=0;e<t.length;e++)t[e].updateKey()},ft.prototype.updateUniforms=function(){},ft.prototype.updateShader=function(e,t,i){},ft.prototype.update=function(){this.dirty=!0},ft.prototype.clearParameters=function(){this.parameters={}},ft.prototype.getParameters=function(){return this.parameters},ft.prototype.clearVariants=function(){var e;this.variants={};for(var t,i=0;i<this.meshInstances.length;i++)for(e=this.meshInstances[i],t=0;t<e._shader.length;t++)e._shader[t]=null},ft.prototype.getParameter=function(e){return this.parameters[e]},ft.prototype.setParameter=function(e,t,i){if(void 0===i&&(i=-524285),void 0===t&&"object"==typeof e){if((t=e).length){for(e=0;e<t.length;e++)this.setParameter(t[e]);return}e=t.name,t=t.value}var s=this.parameters[e];s?(s.data=t,s.passFlags=i):this.parameters[e]={scopeId:null,data:t,passFlags:i}},ft.prototype.deleteParameter=function(e){this.parameters[e]&&delete this.parameters[e]},ft.prototype.setParameters=function(){for(var e in this.parameters){var t=this.parameters[e];t.scopeId.setValue(t.data)}},ft.prototype.destroy=function(){this.variants={},this.shader=null;for(var e,t,i=0;i<this.meshInstances.length;i++){for(e=this.meshInstances[i],t=0;t<e._shader.length;t++)e._shader[t]=null;e._material=null,this!==(t=te.getDefaultMaterial())&&(e.material=t)}},{Material:ft})),Object.assign(te,(((mt=function(){te.Material.call(this),this.color=new te.Color(1,1,1,1),this.colorUniform=new Float32Array(4),this.colorMap=null,this.vertexColors=!1}).prototype=Object.create(te.Material.prototype)).constructor=mt,Object.assign(mt.prototype,{clone:function(){var e=new te.BasicMaterial;return te.Material.prototype._cloneInternal.call(this,e),e.color.copy(this.color),e.colorMap=this.colorMap,e.vertexColors=this.vertexColors,e},updateUniforms:function(){this.clearParameters(),this.colorUniform[0]=this.color.r,this.colorUniform[1]=this.color.g,this.colorUniform[2]=this.color.b,this.colorUniform[3]=this.color.a,this.setParameter("uColor",this.colorUniform),this.colorMap&&this.setParameter("texture_diffuseMap",this.colorMap)},updateShader:function(e,t,i,s,n,a){t={skin:!!this.meshInstances[0].skinInstance,vertexColors:this.vertexColors,diffuseMap:this.colorMap,pass:n},this.shader=e.getProgramLibrary().getProgram("basic",t)}}),{BasicMaterial:mt})),Object.assign(te,(((_t=function(){te.Material.call(this)}).prototype=Object.create(te.Material.prototype)).constructor=_t,Object.assign(_t.prototype,{clone:function(){var e=new te.DepthMaterial;return te.Material.prototype._cloneInternal.call(this,e),e},updateShader:function(e){var t={skin:!!this.meshInstances[0].skinInstance};this.shader=e.getProgramLibrary().getProgram("depth",t)}}),{DepthMaterial:_t})),Object.assign(te,function(){var f=function(){te.Material.call(this),this._assetReferences={},this._validator=null,this.shaderOptBuilder=new te.StandardMaterialOptionsBuilder,this.reset()};(f.prototype=Object.create(te.Material.prototype)).constructor=f;var m=[],i=[],_=[],s=[],g={},n=function(e,t,i,s,n){var a="_"+t+"Map",r=a+"Tiling",o=a+"Offset",h=a.substring(1)+"Transform",l=h+"Uniform",c=a+"Uv",d=a+"Channel",u="_"+t+"VertexColor",p="_"+t+"VertexColorChannel";e[a]=null,e[r]=new te.Vec2(1,1),e[o]=new te.Vec2(0,0),e[h]=null,e[l]=null,e[c]=i,0<s&&(i=n||(1<s?"rgb":"g"),e[d]=i,e[p]=i),e[u]=!1,te._matTex2D||(te._matTex2D=[]),te._matTex2D[t]=s,Object.defineProperty(f.prototype,a.substring(1),{get:function(){return this[a]},set:function(e){var t=this[a];!!t^!!e&&(this.dirtyShader=!0),t&&e&&(t.rgbm!==e.rgbm||t.fixCubemapSeams!==e.fixCubemapSeams||t.format!==e.format)&&(this.dirtyShader=!0),this[a]=e}}),e=r.substring(1),t=o.substring(1),Object.defineProperty(f.prototype,e,{get:function(){return this[r]},set:function(e){this.dirtyShader=!0,this[r]=e}}),g[e]=function(e,t,i){return e=e._updateMapTransform(i?e[h]:null,t,e[o]),{name:"texture_"+h,value:e.data}},Object.defineProperty(f.prototype,t,{get:function(){return this[o]},set:function(e){this.dirtyShader=!0,this[o]=e}}),g[t]=function(e,t,i){return e=e._updateMapTransform(i?e[h]:null,e[r],t),{name:"texture_"+h,value:e.data}},Object.defineProperty(f.prototype,c.substring(1),{get:function(){return this[c]},set:function(e){this[c]!==e&&(this.dirtyShader=!0),this[c]=e}}),Object.defineProperty(f.prototype,d.substring(1),{get:function(){return this[d]},set:function(e){this[d]!==e&&(this.dirtyShader=!0),this[d]=e}}),Object.defineProperty(f.prototype,u.substring(1),{get:function(){return this[u]},set:function(e){this.dirtyShader=!0,this[u]=e}}),Object.defineProperty(f.prototype,p.substring(1),{get:function(){return this[p]},set:function(e){this[p]!==e&&(this.dirtyShader=!0),this[p]=e}}),m.push(a.substring(1)),m.push(r.substring(1)),m.push(o.substring(1)),m.push(c.substring(1)),m.push(d.substring(1)),m.push(u.substring(1)),m.push(p.substring(1)),_.push(h)},l=[],a=function(e,a,t,r){var n="_"+a,o=a+"Uniform",i=a+"Intensity",h="_"+i;e[n]=t,e[o]=new Float32Array(3),Object.defineProperty(f.prototype,a,{get:function(){return this.dirtyShader=this.dirtyColor=!0,this[n]},set:function(e){var t=this[n];(0===t.r&&0===t.g&&0===t.b||1===t.r&&1===t.g&&1===t.b)^(0===e.r&&0===e.g&&0===e.b||1===e.r&&1===e.g&&1===e.b)&&(this.dirtyShader=!0),this.dirtyColor=!0,this[n]=e}}),m.push(a),s.push(o),l.push(a),g[a]=function(e,t,i){i=i?e[o]:new Float32Array(3);var s=!1;e.useGammaTonemap&&(s=(e._scene||te.Application.getApplication().scene).gammaCorrection);for(var n=0;n<3;n++)i[n]=s?Math.pow(t.data[n],2.2):t.data[n],r&&(i[n]*=e[h]);return{name:"material_"+a,value:i}},r&&(e[h]=1,Object.defineProperty(f.prototype,i,{get:function(){return this[h]},set:function(e){var t=this[h];(0===t||1===t)^(0===e||1===e)&&(this.dirtyShader=!0),this.dirtyColor=!0,this[h]=e}}),m.push(i),g[i]=function(e,t,i){t=i?e[o]:new Float32Array(3),i=!1,e.useGammaTonemap&&(i=(e._scene||te.Application.getApplication().scene).gammaCorrection);for(var s=0;s<3;s++)t[s]=i?Math.pow(e[n].data[s],2.2):e[n].data[s],t[s]*=e[h];return{name:"material_"+a,value:t}})},r=function(e,s,t,i){var n="_"+s;e[n]=t,Object.defineProperty(f.prototype,s,{get:function(){return this[n]},set:function(e){var t=this[n];t!==e&&(this[n]=e,0===t||1===t||0===e||1===e)&&(this.dirtyShader=!0)}}),m.push(s),g[s]=void 0!==i?i:function(e,t,i){return{name:"material_"+s,value:t}}},o=function(e,t,i){var s="_"+t;e[s]=null,Object.defineProperty(f.prototype,t,{get:function(){return this[s]},set:function(e){!!this[s]^!!e&&(this.dirtyShader=!0),this[s]=e}}),m.push(t),g[t]=i},h=function(e,t,i){Object.defineProperty(f.prototype,i,{get:function(){return this[t]},set:function(e){this[t]=e}})},c=function(e,t,i){var s="_"+t;e[s]=i,Object.defineProperty(f.prototype,t,{get:function(){return this[s]},set:function(e){this[s]!==e&&(this.dirtyShader=!0),this[s]=e}}),m.push(t)},d=function(){};return d.prototype.copy=function(e){for(var t in e)e.hasOwnProperty(t)&&"copy"!==t&&(this[t]=e[t])},Object.assign(f.prototype,{reset:function(){var e;for(e=0;e<m.length;e++){var t=i[e];this[m[e]]=t&&t.clone?t.clone():t}for(e=0;e<_.length;e++)this[_[e]]=null;for(e=0;e<s.length;e++)this[s[e]]=new Float32Array(3);this._chunks=new d,this.cubeMapMinUniform=new Float32Array(3),this.cubeMapMaxUniform=new Float32Array(3)},clone:function(){var e=new te.StandardMaterial;te.Material.prototype._cloneInternal.call(this,e);for(var t,i=0;i<m.length;i++)void 0!==this[t=m[i]]&&(this[t]&&this[t].copy?e[t]?e[t].copy(this[t]):e[t]=this[t].clone():e[t]=this[t]);return e},_updateMapTransform:function(e,t,i){return(e=e||new te.Vec4).set(t.x,t.y,i.x,i.y),1===e.x&&1===e.y&&0===e.z&&0===e.w?null:e},_setParameter:function(e,t){this.parameters[e]||this._propsSet.push(e),this.setParameter(e,t)},_clearParameters:function(){for(var e=this._propsSet,t=0;t<e.length;t++)delete this.parameters[e[t]];this._propsSet=[]},_updateMap:function(e){if(this[e+="Map"]){this._setParameter("texture_"+e,this[e]);var t=e+"Transform",i=e+"TransformUniform";this[t]||(this[i]=new Float32Array(4)),this[t]=this._updateMapTransform(this[t],this[e+"Tiling"],this[e+"Offset"]),this[t]&&(this[i][0]=this[t].x,this[i][1]=this[t].y,this[i][2]=this[t].z,this[i][3]=this[t].w,this._setParameter("texture_"+t,this[i]))}},getUniform:function(e,t,i){return(e=g[e])?e(this,t,i):null},updateUniforms:function(){var e;for(var t in this._clearParameters(),this._setParameter("material_ambient",this.ambientUniform),this.diffuseMap&&!this.diffuseTint||this._setParameter("material_diffuse",this.diffuseUniform),this.useMetalness?(!this.metalnessMap||this.metalness<1)&&this._setParameter("material_metalness",this.metalness):this.specularMap&&!this.specularTint||this._setParameter("material_specular",this.specularUniform),e=this.getUniform("shininess",this.shininess,!0),this._setParameter(e.name,e.value),this.emissiveMap&&!this.emissiveTint||this._setParameter("material_emissive",this.emissiveUniform),this.emissiveMap&&this._setParameter("material_emissiveIntensity",this.emissiveIntensity),0<this.refraction&&(this._setParameter("material_refraction",this.refraction),this._setParameter("material_refractionIndex",this.refractionIndex)),this._setParameter("material_opacity",this.opacity),this.occludeSpecular&&this._setParameter("material_occludeSpecularIntensity",this.occludeSpecularIntensity),this.cubeMapProjection===te.CUBEPROJ_BOX&&this._setParameter(this.getUniform("cubeMapProjectionBox",this.cubeMapProjectionBox,!0)),te._matTex2D)this._updateMap(t);this.ambientSH&&this._setParameter("ambientSH[0]",this.ambientSH),this.normalMap&&this._setParameter("material_bumpiness",this.bumpiness),this.heightMap&&(e=this.getUniform("heightMapFactor",this.heightMapFactor,!0),this._setParameter(e.name,e.value)),this.cubeMap&&this._setParameter("texture_cubeMap",this.cubeMap),this.prefilteredCubeMap128?this._setParameter("texture_prefilteredCubeMap128",this.prefilteredCubeMap128):this._scene&&this._scene._skyboxPrefiltered[0]&&this._setParameter("texture_prefilteredCubeMap128",this._scene._skyboxPrefiltered[0]),this.prefilteredCubeMap64?this._setParameter("texture_prefilteredCubeMap64",this.prefilteredCubeMap64):this._scene&&this._scene._skyboxPrefiltered[1]&&this._setParameter("texture_prefilteredCubeMap64",this._scene._skyboxPrefiltered[1]),this.prefilteredCubeMap32?this._setParameter("texture_prefilteredCubeMap32",this.prefilteredCubeMap32):this._scene&&this._scene._skyboxPrefiltered[2]&&this._setParameter("texture_prefilteredCubeMap32",this._scene._skyboxPrefiltered[2]),this.prefilteredCubeMap16?this._setParameter("texture_prefilteredCubeMap16",this.prefilteredCubeMap16):this._scene&&this._scene._skyboxPrefiltered[3]&&this._setParameter("texture_prefilteredCubeMap16",this._scene._skyboxPrefiltered[3]),this.prefilteredCubeMap8?this._setParameter("texture_prefilteredCubeMap8",this.prefilteredCubeMap8):this._scene&&this._scene._skyboxPrefiltered[4]&&this._setParameter("texture_prefilteredCubeMap8",this._scene._skyboxPrefiltered[4]),this.prefilteredCubeMap4?this._setParameter("texture_prefilteredCubeMap4",this.prefilteredCubeMap4):this._scene&&this._scene._skyboxPrefiltered[5]&&this._setParameter("texture_prefilteredCubeMap4",this._scene._skyboxPrefiltered[5]),this.sphereMap&&this._setParameter("texture_sphereMap",this.sphereMap),this.dpAtlas&&this._setParameter("texture_sphereMap",this.dpAtlas),this._setParameter("material_reflectivity",this.reflectivity),!this.dirtyShader&&this._scene||(this.shader=null,this.clearVariants()),this._processColor()},_processColor:function(){var e;if(this.dirtyColor&&(this._scene||!this.useGammaTonemap)){var t=!1;for(this.useGammaTonemap&&(t=this._scene.gammaCorrection),e=0;e<l.length;e++){var i=this["_"+l[e]],s=this[l[e]+"Uniform"];t?(s[0]=Math.pow(i.r,2.2),s[1]=Math.pow(i.g,2.2),s[2]=Math.pow(i.b,2.2)):(s[0]=i.r,s[1]=i.g,s[2]=i.b)}for(e=0;e<3;e++)this.emissiveUniform[e]*=this.emissiveIntensity;this.dirtyColor=!1}},updateShader:function(e,t,i,s,n,a){!this._colorProcessed&&this._scene&&(this._colorProcessed=!0,this._processColor());var r,o,h,l,c,d,u=e.useTexCubeLod,p=!e.extTextureLod;if(this.useSkybox&&(r=t._skyboxPrefiltered[0],o=t._skyboxPrefiltered[1],h=t._skyboxPrefiltered[2],l=t._skyboxPrefiltered[3],c=t._skyboxPrefiltered[4],d=t._skyboxPrefiltered[5]),r=this.prefilteredCubeMap128||r,o=this.prefilteredCubeMap64||o,h=this.prefilteredCubeMap32||h,l=this.prefilteredCubeMap16||l,c=this.prefilteredCubeMap8||c,d=this.prefilteredCubeMap4||d,r){var f=r&&o&&h&&l&&c&&d;p&&f?(r.dpAtlas||(r.dpAtlas=te.generateDpAtlas(e,[r,o,h,l,c,d]),r.sh=te.shFromCubemap(l)),this.dpAtlas=r.dpAtlas,this.ambientSH=r.sh,this._setParameter("ambientSH[0]",this.ambientSH),this._setParameter("texture_sphereMap",this.dpAtlas)):u?r._levels.length<6?f&&this._setParameter("texture_prefilteredCubeMap128",r):this._setParameter("texture_prefilteredCubeMap128",r):f&&(this._setParameter("texture_prefilteredCubeMap128",r),this._setParameter("texture_prefilteredCubeMap64",o),this._setParameter("texture_prefilteredCubeMap32",h),this._setParameter("texture_prefilteredCubeMap16",l),this._setParameter("texture_prefilteredCubeMap8",c),this._setParameter("texture_prefilteredCubeMap4",d))}p=te.programlib.standard,p=(u=n>te.SHADER_FORWARDHDR&&n<=te.SHADER_PICK)?p.optionsContextMin:p.optionsContext,u?this.shaderOptBuilder.updateMinRef(p,e,t,this,i,s,n,a,r):this.shaderOptBuilder.updateRef(p,e,t,this,i,s,n,a,r),this.onUpdateShader&&(p=this.onUpdateShader(p)),this.shader=e.getProgramLibrary().getProgram("standard",p),i||(this.clearVariants(),this.variants[0]=this.shader),this.dirtyShader=!1}}),function(e){e.dirtyShader=!0,e.dirtyColor=!0,e._scene=null,e._colorProcessed=!1,a(e,"ambient",new te.Color(.7,.7,.7)),a(e,"diffuse",new te.Color(1,1,1)),a(e,"specular",new te.Color(0,0,0)),a(e,"emissive",new te.Color(0,0,0),!0),r(e,"shininess",25,function(e,t){return{name:"material_shininess",value:e.shadingModel===te.SPECULAR_PHONG?Math.pow(2,.11*t):.01*t}}),r(e,"heightMapFactor",1,function(e,t){return{name:"material_heightMapFactor",value:.025*t}}),r(e,"opacity",1),r(e,"alphaTest",0),r(e,"bumpiness",1),r(e,"reflectivity",1),r(e,"occludeSpecularIntensity",1),r(e,"refraction",0),r(e,"refractionIndex",1/1.5),r(e,"metalness",1),r(e,"aoUvSet",0,null),o(e,"ambientSH",function(e,t,i){return{name:"ambientSH[0]",value:t}}),o(e,"cubeMapProjectionBox",function(e,t,i){var s=i?e.cubeMapMinUniform:new Float32Array(3);return e=i?e.cubeMapMaxUniform:new Float32Array(3),s[0]=t.center.x-t.halfExtents.x,s[1]=t.center.y-t.halfExtents.y,s[2]=t.center.z-t.halfExtents.z,e[0]=t.center.x+t.halfExtents.x,e[1]=t.center.y+t.halfExtents.y,e[2]=t.center.z+t.halfExtents.z,[{name:"envBoxMin",value:s},{name:"envBoxMax",value:e}]}),Object.defineProperty(f.prototype,"chunks",{get:function(){return this.dirtyShader=!0,this._chunks},set:function(e){this.dirtyShader=!0,this._chunks=e}}),m.push("chunks"),c(e,"ambientTint",!1),c(e,"diffuseTint",!1),c(e,"specularTint",!1),c(e,"emissiveTint",!1),c(e,"fastTbn",!1),c(e,"specularAntialias",!1),c(e,"useMetalness",!1),c(e,"occludeDirect",!1),c(e,"normalizeNormalMap",!0),c(e,"conserveEnergy",!0),c(e,"occludeSpecular",te.SPECOCC_AO),c(e,"shadingModel",te.SPECULAR_BLINN),c(e,"fresnelModel",te.FRESNEL_NONE),c(e,"cubeMapProjection",te.CUBEPROJ_NONE),c(e,"customFragmentShader",null),c(e,"forceFragmentPrecision",null),c(e,"useFog",!0),c(e,"useLighting",!0),c(e,"useGammaTonemap",!0),c(e,"useSkybox",!0),c(e,"forceUv1",!1),c(e,"pixelSnap",!1),c(e,"twoSidedLighting",!1),c(e,"nineSlicedMode",te.SPRITE_RENDERMODE_SLICED),n(e,"diffuse",0,3),n(e,"specular",0,3),n(e,"emissive",0,3),n(e,"normal",0,-1),n(e,"metalness",0,1),n(e,"gloss",0,1),n(e,"opacity",0,1,"a"),n(e,"height",0,1),n(e,"ao",0,1),n(e,"light",1,3),n(e,"msdf",0,3),o(e,"cubeMap"),o(e,"sphereMap"),o(e,"dpAtlas"),o(e,"prefilteredCubeMap128"),o(e,"prefilteredCubeMap64"),o(e,"prefilteredCubeMap32"),o(e,"prefilteredCubeMap16"),o(e,"prefilteredCubeMap8"),o(e,"prefilteredCubeMap4"),h(0,"diffuseTint","diffuseMapTint"),h(0,"specularTint","specularMapTint"),h(0,"emissiveTint","emissiveMapTint"),h(0,"aoVertexColor","aoMapVertexColor"),h(0,"diffuseVertexColor","diffuseMapVertexColor"),h(0,"specularVertexColor","specularMapVertexColor"),h(0,"emissiveVertexColor","emissiveMapVertexColor"),h(0,"metalnessVertexColor","metalnessMapVertexColor"),h(0,"glossVertexColor","glossMapVertexColor"),h(0,"opacityVertexColor","opacityMapVertexColor"),h(0,"lightVertexColor","lightMapVertexColor");for(var t=0;t<m.length;t++)i[t]=e[m[t]];e._propsSet=[]}(f.prototype),{StandardMaterial:f}}()),function(){var e;for(e in te.StandardMaterial.PARAMETER_TYPES={name:"string",chunks:"chunks",mappingFormat:"string",_engine:"boolean",ambient:"rgb",ambientTint:"boolean",aoVertexColor:"boolean",aoVertexColorChannel:"string",aoMap:"texture",aoMapChannel:"string",aoMapUv:"number",aoMapTiling:"vec2",aoMapOffset:"vec2",diffuse:"rgb",diffuseTint:"boolean",diffuseVertexColor:"boolean",diffuseVertexColorChannel:"string",diffuseMap:"texture",diffuseMapChannel:"string",diffuseMapUv:"number",diffuseMapTiling:"vec2",diffuseMapOffset:"vec2",specular:"rgb",specularTint:"boolean",specularVertexColor:"boolean",specularVertexColorChannel:"string",specularMap:"texture",specularMapChannel:"string",specularMapUv:"number",specularMapTiling:"vec2",specularMapOffset:"vec2",specularAntialias:"boolean",occludeSpecular:"enum:occludeSpecular",useMetalness:"boolean",metalness:"number",metalnessTint:"boolean",metalnessVertexColor:"boolean",metalnessVertexColorChannel:"string",metalnessMap:"texture",metalnessMapChannel:"string",metalnessMapUv:"number",metalnessMapTiling:"vec2",metalnessMapOffset:"vec2",conserveEnergy:"boolean",shininess:"number",glossVertexColor:"boolean",glossVertexColorChannel:"string",glossMap:"texture",glossMapChannel:"string",glossMapUv:"number",glossMapTiling:"vec2",glossMapOffset:"vec2",fresnelModel:"number",emissive:"rgb",emissiveTint:"boolean",emissiveVertexColor:"boolean",emissiveVertexColorChannel:"string",emissiveMap:"texture",emissiveMapChannel:"string",emissiveMapUv:"number",emissiveMapTiling:"vec2",emissiveMapOffset:"vec2",emissiveIntensity:"number",normalMap:"texture",normalMapTiling:"vec2",normalMapOffset:"vec2",normalMapUv:"number",bumpiness:"number",heightMap:"texture",heightMapChannel:"string",heightMapUv:"number",heightMapTiling:"vec2",heightMapOffset:"vec2",heightMapFactor:"number",alphaToCoverage:"boolean",alphaTest:"number",opacity:"number",opacityVertexColor:"boolean",opacityVertexColorChannel:"string",opacityMap:"texture",opacityMapChannel:"string",opacityMapUv:"number",opacityMapTiling:"vec2",opacityMapOffset:"vec2",reflectivity:"number",refraction:"number",refractionIndex:"number",sphereMap:"texture",cubeMap:"cubemap",cubeMapProjection:"number",cubeMapProjectionBox:"boundingbox",lightVertexColor:"boolean",lightVertexColorChannel:"string",lightMap:"texture",lightMapChannel:"string",lightMapUv:"number",lightMapTiling:"vec2",lightMapOffset:"vec2",depthTest:"boolean",depthWrite:"boolean",depthBias:"number",slopeDepthBias:"number",cull:"enum:cull",blendType:"enum:blendType",shadingModel:"enum:shadingModel",useFog:"boolean",useLighting:"boolean",useSkybox:"boolean",useGammaTonemap:"boolean",prefilteredCubeMap128:"texture",prefilteredCubeMap64:"texture",prefilteredCubeMap32:"texture",prefilteredCubeMap16:"texture",prefilteredCubeMap8:"texture",prefilteredCubeMap4:"texture"},te.StandardMaterial.TEXTURE_PARAMETERS=[],te.StandardMaterial.PARAMETER_TYPES)"texture"===te.StandardMaterial.PARAMETER_TYPES[e]&&te.StandardMaterial.TEXTURE_PARAMETERS.push(e);for(e in te.StandardMaterial.CUBEMAP_PARAMETERS=[],te.StandardMaterial.PARAMETER_TYPES)"cubemap"===te.StandardMaterial.PARAMETER_TYPES[e]&&te.StandardMaterial.CUBEMAP_PARAMETERS.push(e)}(),Object.assign(te,((gt=function(){this.valid=this.removeInvalid=!0,this.enumValidators={occludeSpecular:this._createEnumValidator([te.SPECOCC_NONE,te.SPECOCC_AO,te.SPECOCC_GLOSSDEPENDENT]),cull:this._createEnumValidator([te.CULLFACE_NONE,te.CULLFACE_BACK,te.CULLFACE_FRONT,te.CULLFACE_FRONTANDBACK]),blendType:this._createEnumValidator([te.BLEND_SUBTRACTIVE,te.BLEND_ADDITIVE,te.BLEND_NORMAL,te.BLEND_NONE,te.BLEND_PREMULTIPLIED,te.BLEND_MULTIPLICATIVE,te.BLEND_ADDITIVEALPHA,te.BLEND_MULTIPLICATIVE2X,te.BLEND_SCREEN,te.BLEND_MIN,te.BLEND_MAX]),shadingModel:this._createEnumValidator([te.SPECULAR_PHONG,te.SPECULAR_BLINN])}}).prototype.setInvalid=function(e,t){this.valid=!1,this.removeInvalid&&delete t[e]},gt.prototype.validate=function(e){var t,i,s=te.StandardMaterial.PARAMETER_TYPES,n="path"===e.mappingFormat;for(i in e)if(t=s[i]){if(t.startsWith("enum"))t=t.split(":")[1],this.enumValidators[t]&&(this.enumValidators[t](e[i])||this.setInvalid(i,e));else if("number"===t)"number"!=typeof e[i]&&this.setInvalid(i,e);else if("boolean"===t)"boolean"!=typeof e[i]&&this.setInvalid(i,e);else if("string"===t)"string"!=typeof e[i]&&this.setInvalid(i,e);else if("vec2"===t)e[i]instanceof Array&&2===e[i].length||this.setInvalid(i,e);else if("rgb"===t)e[i]instanceof Array&&3===e[i].length||this.setInvalid(i,e);else if("texture"===t)n?"string"==typeof e[i]||e[null===i]||e[i]instanceof te.Texture||this.setInvalid(i,e):"number"!=typeof e[i]&&null!==e[i]&&(e[i]instanceof te.Texture||this.setInvalid(i,e));else if("boundingbox"===t)e[i].center&&e[i].center instanceof Array&&3===e[i].center.length||this.setInvalid(i,e),e[i].halfExtents&&e[i].halfExtents instanceof Array&&3===e[i].halfExtents.length||this.setInvalid(i,e);else if("cubemap"===t)"number"!=typeof e[i]&&null!==e[i]&&void 0!==e[i]&&(e[i]instanceof te.Texture&&e[i].cubemap||this.setInvalid(i,e));else if("chunks"===t){var a=Object.keys(e[i]);for(t=0;t<a.length;t++)"string"!=typeof e[i][a[t]]&&this.setInvalid(a[t],e[i])}}else this.valid=!1;return e.validated=!0,this.valid},gt.prototype._createEnumValidator=function(t){return function(e){return 0<=t.indexOf(e)}},{StandardMaterialValidator:gt})),Object.assign(te,((yt=function(){this._mapXForms=null}).prototype.updateMinRef=function(e,t,i,s,n,a,r,o,h){this._updateSharedOptions(e,s,n,r),this._updateMinOptions(e,s),this._updateUVOptions(e,s,n,!0)},yt.prototype.updateRef=function(e,t,i,s,n,a,r,o,h){this._updateSharedOptions(e,s,n,r),e.useTexCubeLod=t.useTexCubeLod,this._updateEnvOptions(e,s,i,h),this._updateMaterialOptions(e,s),r===te.SHADER_FORWARDHDR&&(e.gamma&&(e.gamma=te.GAMMA_SRGBHDR),e.toneMap=te.TONEMAP_LINEAR),e.hasTangents=n&&s.normalMap&&0!=(n&te.SHADERDEF_TANGENTS),this._updateLightOptions(e,s,n,o,a),this._updateUVOptions(e,s,n,!1)},yt.prototype._updateSharedOptions=function(e,t,i,s){e.pass=s,e.alphaTest=0<t.alphaTest,e.forceFragmentPrecision=t.forceFragmentPrecision||"",e.chunks=t.chunks||"",e.blendType=t.blendType,e.forceUv1=t.forceUv1,e.screenSpace=i&&0!=(i&te.SHADERDEF_SCREENSPACE),e.skin=i&&0!=(i&te.SHADERDEF_SKIN),e.useInstancing=i&&0!=(i&te.SHADERDEF_INSTANCING),e.nineSlicedMode=t.nineSlicedMode||0},yt.prototype._updateUVOptions=function(e,t,i,s){var n=!1,a=!1,r=!1;for(var o in i&&(n=0!=(i&te.SHADERDEF_UV0),a=0!=(i&te.SHADERDEF_UV1),r=0!=(i&te.SHADERDEF_VCOLOR)),e.vertexColors=!1,this._mapXForms=[],te._matTex2D)this._updateTexOptions(e,t,o,n,a,r,s);this._mapXForms=null},yt.prototype._updateMinOptions=function(e,t){e.opacityTint=1!==t.opacity&&t.blendType!==te.BLEND_NONE,e.lights=[]},yt.prototype._updateMaterialOptions=function(e,t){var i=1===t.diffuse.r&&1===t.diffuse.g&&1===t.diffuse.b||!t.diffuseTint&&(t.diffuseMap||t.diffuseVertexColor)?0:3,s=!1,n=!!(t.useMetalness||t.specularMap||t.sphereMap||t.cubeMap||t.dpAtlas);(n=n||!!t.useMetalness||!(0===t.specular.r&&0===t.specular.g&&0===t.specular.b))&&(!t.specularTint&&(t.specularMap||t.specularVertexColor)||t.useMetalness||(s=1!==t.specular.r||1!==t.specular.g||1!==t.specular.b));var a=t.emissiveMap?0:3;a||(a=(a=(1!==t.emissive.r||1!==t.emissive.g||1!==t.emissive.b||1!==t.emissiveIntensity)&&t.emissiveTint)?3:1!==t.emissiveIntensity?1:0),e.opacityTint=1!==t.opacity&&t.blendType!==te.BLEND_NONE?1:0,e.blendMapsWithColors=!0,e.ambientTint=t.ambientTint,e.diffuseTint=i,e.specularTint=s?3:0,e.metalnessTint=t.useMetalness&&t.metalness<1?1:0,e.glossTint=1,e.emissiveTint=a,e.alphaToCoverage=t.alphaToCoverage,e.needsNormalFloat=t.normalizeNormalMap,e.sphereMap=!!t.sphereMap,e.cubeMap=!!t.cubeMap,e.dpAtlas=!!t.dpAtlas,e.ambientSH=!!t.ambientSH,e.useSpecular=n,e.emissiveFormat=t.emissiveMap?t.emissiveMap.rgbm?1:t.emissiveMap.format===te.PIXELFORMAT_RGBA32F?2:0:null,e.lightMapFormat=t.lightMap?t.lightMap.rgbm?1:t.lightMap.format===te.PIXELFORMAT_RGBA32F?2:0:null,e.specularAntialias=t.specularAntialias,e.conserveEnergy=t.conserveEnergy,e.occludeSpecular=t.occludeSpecular,e.occludeSpecularFloat=1!==t.occludeSpecularIntensity,e.occludeDirect=t.occludeDirect,e.shadingModel=t.shadingModel,e.fresnelModel=t.fresnelModel,e.packedNormal=!!t.normalMap&&t.normalMap.format===te.PIXELFORMAT_DXT5,e.fastTbn=t.fastTbn,e.cubeMapProjection=t.cubeMapProjection,e.customFragmentShader=t.customFragmentShader,e.refraction=!!t.refraction,e.useMetalness=t.useMetalness,e.msdf=!!t.msdfMap,e.twoSidedLighting=t.twoSidedLighting,e.pixelSnap=t.pixelSnap,e.aoMapUv=t.aoUvSet},yt.prototype._updateEnvOptions=function(e,t,i,s){var n,a=!!s&&s.rgbm||!!t.cubeMap&&t.cubeMap.rgbm||!!t.dpAtlas&&t.dpAtlas.rgbm,r=!!s&&(s.rgbm||s.format===te.PIXELFORMAT_RGBA32F)||!!t.cubeMap&&(t.cubeMap.rgbm||t.cubeMap.format===te.PIXELFORMAT_RGBA32F)||!!t.dpAtlas&&(t.dpAtlas.rgbm||t.dpAtlas.format===te.PIXELFORMAT_RGBA32F),o=!(!s||t.cubeMap||t.sphereMap||t.dpAtlas)&&s.rgbm||!!t.cubeMap&&t.cubeMap.rgbm||!!t.sphereMap&&t.sphereMap.rgbm||!!t.dpAtlas&&t.dpAtlas.rgbm,h=!(!s||t.cubeMap||t.sphereMap||t.dpAtlas)&&(s.rgbm||s.format===te.PIXELFORMAT_RGBA32F)||!!t.cubeMap&&(t.cubeMap.rgbm||t.cubeMap.format===te.PIXELFORMAT_RGBA32F)||!!t.sphereMap&&(t.sphereMap.rgbm||t.sphereMap.format===te.PIXELFORMAT_RGBA32F)||!!t.dpAtlas&&(t.dpAtlas.rgbm||t.dpAtlas.format===te.PIXELFORMAT_RGBA32F);t.useSkybox&&i._skyboxPrefiltered&&(n=i._skyboxPrefiltered[0]),e.fog=t.useFog?i.fog:"none",e.gamma=t.useGammaTonemap?i.gammaCorrection:te.GAMMA_NONE,e.toneMap=t.useGammaTonemap?i.toneMapping:-1,e.rgbmAmbient=a,e.hdrAmbient=r,e.rgbmReflection=o,e.hdrReflection=h,e.useRgbm=o||a||!!t.emissiveMap&&t.emissiveMap.rgbm||!!t.lightMap&&t.lightMap.rgbm,e.fixSeams=s?s.fixCubemapSeams:!!t.cubeMap&&t.cubeMap.fixCubemapSeams,e.prefilteredCubemap=!!s,e.skyboxIntensity=s&&n&&s===n&&1!==i.skyboxIntensity},yt.prototype._updateLightOptions=function(e,t,i,s,n){e.lightMap=!1,e.lightMapChannel="",e.lightMapUv=0,e.lightMapTransform=0,e.lightMapWithoutAmbient=!1,e.dirLightMap=!1,i&&(e.noShadow=0!=(i&te.SHADERDEF_NOSHADOW),0!=(i&te.SHADERDEF_LM)&&(e.lightMapFormat=1,e.lightMap=!0,e.lightMapChannel="rgb",e.lightMapUv=1,e.lightMapTransform=0,e.lightMapWithoutAmbient=!t.lightMap,e.useRgbm=!0,0!=(i&te.SHADERDEF_DIRLM)&&(e.dirLightMap=!0))),t.useLighting?(t=[],i=i?i>>16:1,s&&(this._collectLights(te.LIGHTTYPE_DIRECTIONAL,s[te.LIGHTTYPE_DIRECTIONAL],t,i),this._collectLights(te.LIGHTTYPE_POINT,s[te.LIGHTTYPE_POINT],t,i,n),this._collectLights(te.LIGHTTYPE_SPOT,s[te.LIGHTTYPE_SPOT],t,i,n)),e.lights=t):e.lights=[],0===e.lights.length&&(e.noShadow=!0)},yt.prototype._updateTexOptions=function(e,t,i,s,n,a,r){var o=i+"Map",h=i+"VertexColor",l=i+"VertexColorChannel",c=o+"Channel",d=o+"Transform",u=o+"Uv";"light"!==i&&(e[o]=!1,e[c]="",e[d]=0,e[u]=0),e[h]=!1,e[l]="";var p="opacity"===i;if(p&&t.blendType===te.BLEND_NONE&&0===t.alphaTest&&!t.alphaToCoverage)return e;r&&!p||("height"!==i&&t[h]&&a&&(e[h]=t[h],e[l]=t[l],e.vertexColors=!0),t[o]&&(i=!0,0!==t[u]||s||(i=!1),1!==t[u]||n||(i=!1),i&&(e[o]=!!t[o],e[d]=this._getMapTransformID(t[d],t[u]),e[c]=t[c],e[u]=t[u])))},yt.prototype._collectLights=function(e,t,i,s,n){var a,r;for(r=0;r<t.length;r++)(a=t[r])._enabled&&a._mask&s&&(e===te.LIGHTTYPE_DIRECTIONAL||!a.isStatic)&&i.push(a);if(n)for(r=0;r<n.length;r++)(a=n[r])._type===e&&i.push(a)},yt.prototype._getMapTransformID=function(e,t){if(!e)return 0;var i;for(this._mapXForms[t]||(this._mapXForms[t]=[]),i=0;i<this._mapXForms[t].length&&this._mapXForms[t][i][0]==e.x&&this._mapXForms[t][i][1]==e.y&&this._mapXForms[t][i][2]==e.z&&this._mapXForms[t][i][3]==e.w;)return i+1;return i=this._mapXForms[t].length,this._mapXForms[t][i]=[],this._mapXForms[t][i][0]=e.x,this._mapXForms[t][i][1]=e.y,this._mapXForms[t][i][2]=e.z,this._mapXForms[t][i][3]=e.w,i+1},{StandardMaterialOptionsBuilder:yt})),Object.assign(te,function(){function s(e,t,i,s){return(15&e)<<27|(t===te.BLEND_NONE?1:0)<<26|(i?1:0)<<25|(33554431&s)<<0}var e=0,x=new te.BoundingBox,t=function(){this._refCount=0,this.id=e++,this.vertexBuffer=null,this.indexBuffer=[null],this.primitive=[{type:0,base:0,count:0}],this.morph=this.skin=null,this._aabb=new te.BoundingBox,this.boneAabb=null};Object.defineProperty(t.prototype,"aabb",{get:function(){return this.morph?this.morph.aabb:this._aabb},set:function(e){this.morph?(this._aabb=this.morph._baseAabb=e,this.morph._calculateAabb()):this._aabb=e}});var i=function(e,t,i){this._key=[0,0],this._shader=[null,null,null],this.isStatic=!1,this._staticSource=this._staticLightList=null,this.node=e,(this._mesh=t)._refCount++,this.material=i,this._shaderDefs=te.MASK_DYNAMIC<<16,this._shaderDefs|=t.vertexBuffer.format.hasUv0?te.SHADERDEF_UV0:0,this._shaderDefs|=t.vertexBuffer.format.hasUv1?te.SHADERDEF_UV1:0,this._shaderDefs|=t.vertexBuffer.format.hasColor?te.SHADERDEF_VCOLOR:0,this._shaderDefs|=t.vertexBuffer.format.hasTangents?te.SHADERDEF_TANGENTS:0,this._lightHash=0,this.visible=!0,this.layer=te.LAYER_WORLD,this.renderStyle=te.RENDERSTYLE_SOLID,this.castShadow=!1,this._receiveShadow=!0,this._noDepthDrawGl1=this._screenSpace=!1,this._updateAabb=this.pick=this.cull=!0,this._updateAabbFunc=null,this.updateKey(),this.instancingData=this.morphInstance=this._skinInstance=null,this.aabb=new te.BoundingBox,this._boneAabb=null,this._aabbVer=-1,this.visibleThisFrame=this.drawOrder=0,this.isVisibleFunc=null,this.parameters={},this.stencilBack=this.stencilFront=null,this.flipFaces=!1};Object.defineProperty(i.prototype,"mesh",{get:function(){return this._mesh},set:function(e){this._mesh&&this._mesh._refCount--,(this._mesh=e)&&e._refCount++}}),Object.defineProperty(i.prototype,"aabb",{get:function(){var e;if(!this._updateAabb)return this._aabb;if(this._updateAabbFunc)return this._updateAabbFunc(this._aabb);if(this.skinInstance){var t,i,s=this.mesh.skin.boneNames.length;if(!this.mesh.boneAabb){this.mesh.boneAabb=[],this.mesh.boneUsed=[];var n,a,r,o,h,l=this.mesh.vertexBuffer.format.elements,c=this.mesh.vertexBuffer.numVertices;for(e=this.mesh.vertexBuffer.format.size,i=0;i<l.length;i++)l[i].name===te.SEMANTIC_POSITION?a=l[i].offset:l[i].name===te.SEMANTIC_BLENDINDICES?r=l[i].offset:l[i].name===te.SEMANTIC_BLENDWEIGHT&&(o=l[i].offset);l=new Uint8Array(this.mesh.vertexBuffer.storage);var d,u,p,f,m,_=new Float32Array(this.mesh.vertexBuffer.storage),g=a/4,y=o/4,v=e/4;for(o=[],a=[],t=this.mesh.boneUsed,i=0;i<s;i++)o[i]=new te.Vec3(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),a[i]=new te.Vec3(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);for(h=0;h<c;h++)for(i=0;i<4;i++)0<_[h*v+y+i]&&(n=l[h*e+r+i],p=_[h*v+g],f=_[h*v+g+1],m=_[h*v+g+2],d=a[n],(u=o[n]).x>p&&(u.x=p),u.y>f&&(u.y=f),u.z>m&&(u.z=m),d.x<p&&(d.x=p),d.y<f&&(d.y=f),d.z<m&&(d.z=m),t[n]=!0);if(this.morphInstance){var b;t=this.morphInstance.morph._targets;var S,T=new Float32Array(3*c),E=new Float32Array(3*c);for(h=0;h<c;h++)T[3*h]=E[3*h]=_[h*v+g],T[3*h+1]=E[3*h+1]=_[h*v+g+1],T[3*h+2]=E[3*h+2]=_[h*v+g+2];for(c=0;c<t.length;c++)for(h=(g=(i=t[c]).indices).length,p=i.deltaPositions,i=0;i<h;i++)b=g[i],n=p[3*i],d=p[3*i+1],u=p[3*i+2],n<0?T[3*b]+=n:E[3*b]+=n,d<0?T[3*b+1]+=d:E[3*b+1]+=d,u<0?T[3*b+2]+=u:E[3*b+2]+=u;for(c=0;c<t.length;c++)for(h=(g=(i=t[c]).indices).length,i=0;i<h;i++)for(b=g[i],S=0;S<4;S++)0<_[b*v+y+S]&&(d=a[n=l[b*e+r+S]],u=o[n],p=T[3*b],f=T[3*b+1],m=T[3*b+2],u.x>p&&(u.x=p),u.y>f&&(u.y=f),u.z>m&&(u.z=m),p=E[3*b],f=E[3*b+1],m=E[3*b+2],d.x<p&&(d.x=p),d.y<f&&(d.y=f),d.z<m&&(d.z=m))}for(i=0;i<s;i++)(e=new te.BoundingBox).setMinMax(o[i],a[i]),this.mesh.boneAabb.push(e)}if(!this._boneAabb)for(this._boneAabb=[],i=0;i<this.mesh.boneAabb.length;i++)this._boneAabb[i]=new te.BoundingBox;for(t=this.mesh.boneUsed,i=0;i<this.mesh.boneAabb.length;i++)t[i]&&this._boneAabb[i].setFromTransformedAabb(this.mesh.boneAabb[i],this.skinInstance.matrices[i]);for(s=this.node.getWorldTransform(),e=!0,i=0;i<this.mesh.boneAabb.length;i++)t[i]&&(e?(x.center.copy(this._boneAabb[i].center),x.halfExtents.copy(this._boneAabb[i].halfExtents),e=!1):x.add(this._boneAabb[i]));this._aabb.setFromTransformedAabb(x,s)}else this.node._aabbVer!==this._aabbVer&&(e=this.mesh?this.mesh.aabb:this._aabb,this.mesh||(e.center.set(0,0,0),e.halfExtents.set(0,0,0)),this._aabb.setFromTransformedAabb(e,this.node.getWorldTransform()),this._aabbVer=this.node._aabbVer);return this._aabb},set:function(e){this._aabb=e}}),Object.defineProperty(i.prototype,"material",{get:function(){return this._material},set:function(e){var t;for(t=0;t<this._shader.length;t++)this._shader[t]=null;if(this._material){var i=this._material.meshInstances;-1!==(t=i.indexOf(this))&&i.splice(t,1)}i=!!this._material&&this._material.blendType!==te.BLEND_NONE,t=this._material,(this._material=e)&&(this._material.meshInstances.push(this),this.updateKey()),e&&e.blendType!==te.BLEND_NONE!==i&&(!(i=e._scene)&&t&&t._scene&&(i=t._scene),i?i.layers._dirtyBlend=!0:e._dirtyBlend=!0)}}),Object.defineProperty(i.prototype,"layer",{get:function(){return this._layer},set:function(e){this._layer=e,this.updateKey()}}),Object.defineProperty(i.prototype,"receiveShadow",{get:function(){return this._receiveShadow},set:function(e){this._shaderDefs=(this._receiveShadow=e)?this._shaderDefs&~te.SHADERDEF_NOSHADOW:this._shaderDefs|te.SHADERDEF_NOSHADOW,this._shader[te.SHADER_FORWARD]=null,this._shader[te.SHADER_FORWARDHDR]=null}}),Object.defineProperty(i.prototype,"skinInstance",{get:function(){return this._skinInstance},set:function(e){for(this._shaderDefs=(this._skinInstance=e)?this._shaderDefs|te.SHADERDEF_SKIN:this._shaderDefs&~te.SHADERDEF_SKIN,e=0;e<this._shader.length;e++)this._shader[e]=null}}),Object.defineProperty(i.prototype,"screenSpace",{get:function(){return this._screenSpace},set:function(e){this._shaderDefs=(this._screenSpace=e)?this._shaderDefs|te.SHADERDEF_SCREENSPACE:this._shaderDefs&~te.SHADERDEF_SCREENSPACE,this._shader[te.SHADER_FORWARD]=null}}),Object.defineProperty(i.prototype,"key",{get:function(){return this._key[te.SORTKEY_FORWARD]},set:function(e){this._key[te.SORTKEY_FORWARD]=e}}),Object.defineProperty(i.prototype,"mask",{get:function(){return this._shaderDefs>>16},set:function(e){this._shaderDefs=65535&this._shaderDefs|e<<16,this._shader[te.SHADER_FORWARD]=null,this._shader[te.SHADER_FORWARDHDR]=null}}),Object.assign(i.prototype,{syncAabb:function(){},updateKey:function(){var e=this.material;this._key[te.SORTKEY_FORWARD]=s(this.layer,e.alphaToCoverage||e.alphaTest?te.BLEND_NORMAL:e.blendType,!1,e.id)},setParameter:te.Material.prototype.setParameter,setParameters:te.Material.prototype.setParameters,deleteParameter:te.Material.prototype.deleteParameter,getParameter:te.Material.prototype.getParameter,getParameters:te.Material.prototype.getParameters,clearParameters:te.Material.prototype.clearParameters});var n=function(e,t,i){this._key=[],this._key[te.SORTKEY_FORWARD]=s(e,t,!0,0),this.command=i};Object.defineProperty(n.prototype,"key",{get:function(){return this._key[te.SORTKEY_FORWARD]},set:function(e){this._key[te.SORTKEY_FORWARD]=e}});var a=function(e,t,i){this.buffer=new Float32Array(e*(i||16)),this.count=e,this.offset=0,this.usage=t?te.BUFFER_DYNAMIC:te.BUFFER_STATIC,this._buffer=null};return Object.assign(a.prototype,{update:function(){this._buffer&&this._buffer.setData(this.buffer)}}),{Command:n,Mesh:t,MeshInstance:i,InstancingData:a,_getDrawcallSortKey:s}}()),Object.assign(te,(vt=new te.Mat4,bt=function(e){this.skin=e,this._dirty=!0,this.bones=[];var t,i=e.inverseBindPose.length;(e=e.device).supportsBoneTextures?(t=256<i?64:64<i?32:16<i?16:8,this.boneTexture=new te.Texture(e,{width:t,height:t,format:te.PIXELFORMAT_RGBA32F,mipmaps:!1,minFilter:te.FILTER_NEAREST,magFilter:te.FILTER_NEAREST}),this.boneTexture.name="skin",this.matrixPalette=this.boneTexture.lock()):this.matrixPalette=new Float32Array(16*i);for(this.matrices=[],e=0;e<i;e++)this.matrices[e]=new te.Mat4},Object.assign(bt.prototype,{updateMatrices:function(e){for(vt.copy(e.getWorldTransform()).invert(),e=this.bones.length-1;0<=e;e--)this.matrices[e].mul2(vt,this.bones[e].getWorldTransform()),this.matrices[e].mul2(this.matrices[e],this.skin.inverseBindPose[e])},updateMatrixPalette:function(){for(var e,t,i=this.matrixPalette,s=this.bones.length-1;0<=s;s--)e=this.matrices[s].data,i[t=16*s]=e[0],i[1+t]=e[1],i[2+t]=e[2],i[3+t]=e[3],i[4+t]=e[4],i[5+t]=e[5],i[6+t]=e[6],i[7+t]=e[7],i[8+t]=e[8],i[9+t]=e[9],i[10+t]=e[10],i[11+t]=e[11],i[12+t]=e[12],i[13+t]=e[13],i[14+t]=e[14],i[15+t]=e[15];this.skin.device.supportsBoneTextures&&(this.boneTexture.lock(),this.boneTexture.unlock())}}),{Skin:function(e,t,i){this.device=e,this.inverseBindPose=t,this.boneNames=i},SkinInstance:bt})),Object.assign(te,function(){function x(){this.index=0,this.boneIndices=[0,0,0,0]}function A(){this.indexCount=this.indexStart=this.vertexCount=this.vertexStart=this.partition=0,this.boneIndices=[],this.vertices=[],this.indices=[],this.indexMap={}}return Object.assign(A.prototype,{addVertex:function(e,t,i){if(void 0!==this.indexMap[t])i=this.indexMap[t],this.indices.push(i);else{for(var s=0;s<4;s++)0!==i.blendWeight.data[4*t+s]&&(e.boneIndices[s]=this.getBoneRemap(i.blendIndices.data[4*e.index+s]));i=this.vertices.length,this.indices.push(i),this.vertices.push(e),this.indexMap[t]=i}},addPrimitive:function(e,t,i,s){var n,a,r=[],o=0,h=e.length;for(n=0;n<h;n++)for(var l=e[n].index,c=0;c<4;c++)if(0<i.blendWeight.data[4*l+c]){var d=i.blendIndices.data[4*l+c],u=!0;for(a=0;a<o;a++)if(r[a]==d){u=!1;break}u&&(r[o]=d,o+=-1===(a=this.getBoneRemap(d))?1:0)}if(this.boneIndices.length+o>s)return!1;for(n=0;n<o;n++)this.boneIndices.push(r[n]);for(n=0;n<h;n++)this.addVertex(e[n],t[n],i);return!0},getBoneRemap:function(e){for(var t=0;t<this.boneIndices.length;t++)if(this.boneIndices[t]===e)return t;return-1}}),{partitionSkin:function(e,t,i){var s,n,a,r;!function(e){var t=e.vertices,i=e.skins,s=e.meshes,n=e.meshInstances;for(e=0;e<s.length;e++)s[e].vertices=t[s[e].vertices],void 0!==s[e].skin&&(s[e].skin=i[s[e].skin]);for(e=0;e<n.length;e++)n[e].mesh=s[n[e].mesh]}(e);var o,h=e.vertices,l=e.skins,c=e.meshes,d=e.meshInstances,u=function(e){var t=new x;return t.index=e,t};for(s=l.length-1;0<=s;s--)if(l[s].boneNames.length>i){var p=l.splice(s,1)[0],f=[];for(n=0;n<c.length;n++)c[n].skin===p&&f.push(c[n]);for(n=0;n<f.length;n++)-1!==(r=c.indexOf(f[n]))&&c.splice(r,1);if(0===f.length)throw Error("partitionSkin: There should be at least one mesh that references a skin");var m=f[0].vertices;for(n=1;n<f.length;n++)if(f[n].vertices!==m)throw Error("partitionSkin: All meshes that share a skin should also share the same vertex buffer");var _=[],g=[];a=[];var y=0;for(n=0;n<f.length;n++){for(var v=(o=f[n]).indices,b=o.base;b<o.base+o.count;){r=v[b++],g[0]=u(r),a[0]=r,r=v[b++],g[1]=u(r),a[1]=r,r=v[b++],g[2]=u(r),a[2]=r;for(var S=!1,T=y;T<_.length;T++)if((r=_[T]).addPrimitive(g,a,m,i)){S=!0;break}S||((r=new A).originalMesh=o,r.addPrimitive(g,a,m,i),_.push(r))}y=_.length}for(o=[],f=[],n=0;n<_.length;n++)if((r=_[n]).vertices.length&&r.indices.length){for(g=o.length,a=r.vertices.length,y=f.length,v=r.indices.length,r.partition=n,r.vertexStart=g,r.vertexCount=a,r.indexStart=y,r.indexCount=v,b=0,S=g;b<a;)o[S++]=r.vertices[b++];for(b=0,S=y;b<v;)f[S++]=r.indices[b++]+g}for(g=[],n=0;n<_.length;n++){for(r=_[n],y=[],v=[],a=0;a<r.boneIndices.length;a++)y.push(p.inverseBindMatrices[r.boneIndices[a]]),v.push(p.boneNames[r.boneIndices[a]]);r={inverseBindMatrices:y,boneNames:v},g.push(r),l.push(r)}var E;p={};for(E in m)p[E]={components:m[E].components,data:[],type:m[E].type};for(E in m)if("blendIndices"===E)for(r=p[E].data,n=0;n<o.length;n++)a=o[n].boneIndices,r.push(a[0],a[1],a[2],a[3]);else for(y=(n=m[E]).data,v=n.components,n=0;n<o.length;n++)for(r=o[n].index,a=0;a<v;a++)p[E].data.push(y[r*v+a]);for(h[h.indexOf(m)]=p,n=0;n<_.length;n++)for(r=_[n],o={aabb:{min:[0,0,0],max:[0,0,0]},vertices:p,skin:g[n],indices:f.splice(0,r.indexCount),type:"triangles",base:0,count:r.indexCount},c.push(o),a=d.length-1;0<=a;a--)d[a].mesh===r.originalMesh&&(d.push({mesh:o,node:d[a].node}),t&&t.push({material:t[a].material,path:t[a].path}));for(n=0;n<_.length;n++)for(r=_[n],a=d.length-1;0<=a;a--)d[a].mesh===r.originalMesh&&(d.splice(a,1),t&&t.splice(a,1))}!function(e){var t=e.vertices,i=e.skins,s=e.meshes,n=e.meshInstances;for(e=0;e<s.length;e++)s[e].vertices=t.indexOf(s[e].vertices),void 0!==s[e].skin&&(s[e].skin=i.indexOf(s[e].skin));for(e=0;e<n.length;e++)n[e].mesh=s.indexOf(n[e].mesh)}(e)}}}()),Object.assign(te,function(){var c=new te.Vec3,d=new te.Vec3,e=function(e){this.aabb=new te.BoundingBox,this._baseAabb=this._baseBuffer=null,this._targets=e,this._aabbDirty=this._dirty=!0,this._baseData=null,this._vertSizeF=this._offsetTF=this._offsetNF=this._offsetPF=0};Object.assign(e.prototype,{_setBaseMesh:function(e){this._baseBuffer=e.vertexBuffer,this._baseAabb=e._aabb,this._baseData=new Float32Array(this._baseBuffer.storage);for(var t=e=-1,i=-1,s=this._baseBuffer.format.elements,n=this._baseBuffer.format.size,a=0;a<s.length;a++)s[a].name===te.SEMANTIC_POSITION?e=s[a].offset:s[a].name===te.SEMANTIC_NORMAL?t=s[a].offset:s[a].name===te.SEMANTIC_TANGENT&&(i=s[a].offset);this._offsetPF=e/4,this._offsetNF=t/4,this._offsetTF=i/4,this._vertSizeF=n/4,this._dirty=!0},_calculateAabb:function(){if(this._baseBuffer){this.aabb.copy(this._baseAabb);var e,t,i,s,n,a,r,o=this._vertSizeF,h=this._offsetPF,l=this._baseData;for(t=0;t<this._targets.length;t++){if(!(s=this._targets[t]).aabb&&0<s.indices.length){for(s.aabb=this.aabb.clone(),c.set(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),d.set(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE),e=s.indices.length,i=0;i<e;i++)n=l[a=(n=s.indices[i])*o+h]+s.deltaPositions[3*i],r=l[a+1]+s.deltaPositions[3*i+1],a=l[a+2]+s.deltaPositions[3*i+2],c.x>n&&(c.x=n),c.y>r&&(c.y=r),c.z>a&&(c.z=a),d.x<n&&(d.x=n),d.y<r&&(d.y=r),d.z<a&&(d.z=a);s.aabb.setMinMax(c,d)}s.aabb&&this.aabb.add(s.aabb)}this._aabbDirty=!1}},addTarget:function(e){this._targets.push(e),this._aabbDirty=!0},removeTarget:function(e){-1!==(e=this._targets.indexOf(e))&&(this._targets.splice(e,1),this._aabbDirty=!0)},getTarget:function(e){return this._targets[e]}});var t=function(e){this.morph=e,this._vertexData=this._vertexBuffer=null,this._weights=[],this._dirty=!0};return Object.assign(t.prototype,{_setBaseMesh:function(e){for(this.destroy(),this._vertexBuffer=new te.VertexBuffer(this.morph._baseBuffer.device,this.morph._baseBuffer.format,this.morph._baseBuffer.numVertices,te.BUFFER_DYNAMIC,this.morph._baseBuffer.storage.slice(0)),this._vertexData=new Float32Array(this._vertexBuffer.storage),this._weights=[],this._weights.length=this.morph._targets.length,e=0;e<this.morph._targets.length;e++)this._weights[e]=0;this._dirty=!0},destroy:function(){this._vertexBuffer&&(this._vertexBuffer.destroy(),this._vertexBuffer=null)},getWeight:function(e){return this._weights[e]},setWeight:function(e,t){this._weights[e]=t,this._dirty=!0},updateBounds:function(e){this.morph._baseBuffer!==e.vertexBuffer&&this.morph._setBaseMesh(e),this._vertexData||this._setBaseMesh(e),this.morph._aabbDirty&&this.morph._calculateAabb()},update:function(e){this.morph._baseBuffer!==e.vertexBuffer&&this.morph._setBaseMesh(e),this._vertexData||this._setBaseMesh(e);var t,i,s,n,a,r,o=this.morph._targets,h=this._weights,l=this.morph._vertSizeF,c=this.morph._offsetPF,d=this.morph._offsetNF,u=this.morph._offsetTF,p=this._vertexData;p.set(this.morph._baseData);for(var f=0;f<o.length;f++)if(0!==(s=h[f]))for(e=(i=o[f]).indices.length,n=0;n<e;n++)r=3*n,p[a=(t=i.indices[n])*l+c]+=i.deltaPositions[r]*s,p[a+1]+=i.deltaPositions[r+1]*s,p[a+2]+=i.deltaPositions[r+2]*s,i.deltaNormals&&(p[a=t*l+d]+=i.deltaNormals[r]*s,p[a+1]+=i.deltaNormals[r+1]*s,p[a+2]+=i.deltaNormals[r+2]*s,i.deltaTangents&&(r=4*n,p[a=t*l+u]+=i.deltaTangents[r]*s,p[a+1]+=i.deltaTangents[r+1]*s,p[a+2]+=i.deltaTangents[r+2]*s,p[a+3]+=i.deltaTangents[r+3]*s,p[a+3]=0<p[a+3]?1:-1));this._vertexBuffer.unlock()}}),{MorphTarget:function(e){if(e.indices)this.indices=e.indices;else{var t=e.deltaPositions;this.indices=[],this.indices.length=t.length;for(var i=0;i<t.length;i++)this.indices[i]=i}this.deltaPositions=e.deltaPositions,this.deltaNormals=e.deltaNormals,this.deltaTangents=e.deltaTangents,this.name=e.name,this.aabb=e.aabb},Morph:e,MorphInstance:t}}()),Object.assign(te,(St=function(){this.graph=null,this.meshInstances=[],this.skinInstances=[],this.morphInstances=[],this.cameras=[],this.lights=[],this._shadersVersion=0},Object.assign(St.prototype,{getGraph:function(){return this.graph},setGraph:function(e){this.graph=e},getCameras:function(){return this.cameras},setCameras:function(e){this.cameras=e},getLights:function(){return this.lights},setLights:function(e){this.lights=e},getMaterials:function(){var e,t=[];for(e=0;e<this.meshInstances.length;e++){var i=this.meshInstances[e];-1===t.indexOf(i.material)&&t.push(i.material)}return t},clone:function(){var e,t,s=[],n=[],a=function(e){var t=e.clone();s.push(e),n.push(t);for(var i=0;i<e._children.length;i++)t.addChild(a(e._children[i]));return t},i=a(this.graph),r=[],o=[],h=[];for(e=0;e<this.skinInstances.length;e++){var l=this.skinInstances[e].skin,c=new te.SkinInstance(l),d=[];for(t=0;t<l.boneNames.length;t++){var u=i.findByName(l.boneNames[t]);d.push(u)}c.bones=d,o.push(c)}for(e=0;e<this.morphInstances.length;e++)t=new te.MorphInstance(this.morphInstances[e].morph),h.push(t);for(e=0;e<this.meshInstances.length;e++)t=this.meshInstances[e],l=s.indexOf(t.node),l=new te.MeshInstance(n[l],t.mesh,t.material),t.skinInstance&&(c=this.skinInstances.indexOf(t.skinInstance),l.skinInstance=o[c]),t.morphInstance&&(t=this.morphInstances.indexOf(t.morphInstance),l.morphInstance=h[t]),r.push(l);return(e=new te.Model).graph=i,e.meshInstances=r,e.skinInstances=o,e.morphInstances=h,e.getGraph().syncHierarchy(),e},destroy:function(){for(var e,t,i,s,n=this.meshInstances,a=0;a<n.length;a++){if((t=(e=n[a]).mesh)&&(t._refCount--,t._refCount<1)){for(t.vertexBuffer&&(t.vertexBuffer.destroy(),t.vertexBuffer=null),s=0;s<t.indexBuffer.length;s++)(i=t.indexBuffer[s])&&i.destroy();t.indexBuffer.length=0}(t=e.skinInstance)&&(t=t.boneTexture)&&t.destroy(),e.skinInstance=null,(t=e.morphInstance)&&t.destroy(),e.morphInstance=null,e.material=null}},generateWireframe:function(){var e,t,i,s,n,a,r,o,h,l,c=[];for(e=0;e<this.meshInstances.length;e++)a=this.meshInstances[e].mesh,-1===c.indexOf(a)&&c.push(a);var d=[[0,1],[1,2],[2,0]];for(e=0;e<c.length;e++){r=(a=c[e]).primitive[te.RENDERSTYLE_SOLID].base,o=a.primitive[te.RENDERSTYLE_SOLID].count,h=a.indexBuffer[te.RENDERSTYLE_SOLID],l=new Uint16Array(h.lock());var u={},p=[];for(t=r;t<r+o;t+=3)for(i=0;i<3;i++){s=l[t+d[i][0]];var f=(n=l[t+d[i][1]])<s?n<<16|s:s<<16|n;void 0===u[f]&&(u[f]=0,p.push(s,n))}h.unlock(),t=new te.IndexBuffer(h.device,te.INDEXFORMAT_UINT16,p.length),(i=new Uint16Array(t.lock())).set(p),t.unlock(),a.primitive[te.RENDERSTYLE_WIREFRAME]={type:te.PRIMITIVE_LINES,base:0,count:p.length,indexed:!0},a.indexBuffer[te.RENDERSTYLE_WIREFRAME]=t}}}),{Model:St})),Object.assign(te,function(){function o(e,t){h[e]=void 0!==u[e]&&null!==u[e]?u[e]:t}function l(e,t){for(var i=e.length/3,s=Array(4*i),n=0;n<i;n++)s[4*n]=e[3*n],s[4*n+1]=e[3*n+1],s[4*n+2]=e[3*n+2],s[4*n+3]=(255*t[3*n]<<16|255*t[3*n+1]<<8|255*t[3*n+2])/16777216;return s}function c(e,t){var i,s,n=t.length,a=e.length/n;for(i=0;i<a;i++)for(s=0;s<n;s++)t[s]=Math.max(t[s],Math.abs(e[i*n+s]))}function d(e,t,i){for(var s=new Float32Array(t.length),n=0;n<t.length;n++)s[n]=t[n]-e[n];c(s,i),e=i.length;var a=s.length/e;for(t=0;t<a;t++)for(n=0;n<e;n++)s[t*e+n]/=0===i[n]?1:i[n],s[t*e+n]*=.5,s[t*e+n]+=.5;return s}var h,u,p=[[-1,-1],[1,-1],[1,1],[-1,1]],f=function(e,t,i,s,n,a,r){n||(n=te.PIXELFORMAT_RGBA32F);var o=te.FILTER_NEAREST;if(r&&n===te.PIXELFORMAT_R8_G8_B8_A8&&(o=te.FILTER_LINEAR),(e=new te.Texture(e,{width:t,height:i,format:n,cubemap:!1,mipmaps:!1,minFilter:o,magFilter:o,addressU:te.ADDRESS_CLAMP_TO_EDGE,addressV:te.ADDRESS_CLAMP_TO_EDGE})).name="PSTexture",t=e.lock(),n===te.PIXELFORMAT_R8_G8_B8_A8){for(n=new Uint8Array(s.length),i=0;i<s.length;i++)n[i]=s[i]*a*255;s=n}return t.set(s),e.unlock(),e},m=new te.Curve([0,0,1,0]),_=new te.Curve([0,1,1,1]),g=new te.CurveSet([0,0,1,0],[0,0,1,0],[0,0,1,0]),y=new te.CurveSet([0,1,1,1],[0,1,1,1],[0,1,1,1]),r=2,v=new Float32Array(3),b=new te.Mat4,S=new te.Vec3,T=new te.Vec3,E=new te.Vec3,x=function(e,t){if(this.graphicsDevice=e,this.precision=32,this._addTimeTime=0,!x.DEFAULT_PARAM_TEXTURE){var i,s,n,a,r=new Float32Array(1024);for(s=0;s<16;s++)for(i=0;i<16;i++)n=i+1-8.5,a=s+1-8.5,a=Math.max(Math.min(1-Math.max(Math.min(Math.sqrt(n*n+a*a)/16,1),0)-.5,1),0),r[4*(n=16*s+i)]=1,r[4*n+1]=1,r[4*n+2]=1,r[4*n+3]=a;x.DEFAULT_PARAM_TEXTURE=f(e,16,16,r,te.PIXELFORMAT_R8_G8_B8_A8,1,!0),x.DEFAULT_PARAM_TEXTURE.minFilter=te.FILTER_LINEAR,x.DEFAULT_PARAM_TEXTURE.magFilter=te.FILTER_LINEAR}h=this,u=t,o("numParticles",1),this.numParticles>e.maxTextureSize&&(this.numParticles=e.maxTextureSize),o("rate",1),o("rate2",this.rate),o("lifetime",50),o("emitterExtents",new te.Vec3(0,0,0)),o("emitterExtentsInner",new te.Vec3(0,0,0)),o("emitterRadius",0),o("emitterRadiusInner",0),o("emitterShape",te.EMITTERSHAPE_BOX),o("initialVelocity",1),o("wrap",!1),o("localSpace",!1),o("wrapBounds",null),o("colorMap",x.DEFAULT_PARAM_TEXTURE),o("normalMap",null),o("loop",!0),o("preWarm",!1),o("sort",te.PARTICLESORT_NONE),o("mode",te.PARTICLEMODE_GPU),o("scene",null),o("lighting",!1),o("halfLambert",!1),o("intensity",1),o("stretch",0),o("alignToMotion",!1),o("depthSoftening",0),o("mesh",null),o("particleNormal",new te.Vec3(0,1,0)),o("orientation",te.PARTICLEORIENTATION_SCREEN),o("depthWrite",!1),o("noFog",!1),o("blendType",te.BLEND_NORMAL),o("node",null),o("startAngle",0),o("startAngle2",this.startAngle),o("animTilesX",1),o("animTilesY",1),o("animNumFrames",1),o("animSpeed",1),o("animLoop",!0),this._gpuUpdater=new te.ParticleGPUUpdater(this,e),this._cpuUpdater=new te.ParticleCPUUpdater(this),this.constantLightCube=e.scope.resolve("lightCube[0]"),this.emitterPosUniform=new Float32Array(3),this.wrapBoundsUniform=new Float32Array(3),this.emitterScaleUniform=new Float32Array([1,1,1]),o("colorGraph",y),o("colorGraph2",this.colorGraph),o("scaleGraph",_),o("scaleGraph2",this.scaleGraph),o("alphaGraph",_),o("alphaGraph2",this.alphaGraph),o("localVelocityGraph",g),o("localVelocityGraph2",this.localVelocityGraph),o("velocityGraph",g),o("velocityGraph2",this.velocityGraph),o("rotationSpeedGraph",m),o("rotationSpeedGraph2",this.rotationSpeedGraph),o("radialSpeedGraph",m),o("radialSpeedGraph2",this.radialSpeedGraph),this.lightCube=new Float32Array(18),this.lightCubeDir=Array(6),this.lightCubeDir[0]=new te.Vec3(-1,0,0),this.lightCubeDir[1]=new te.Vec3(1,0,0),this.lightCubeDir[2]=new te.Vec3(0,-1,0),this.lightCubeDir[3]=new te.Vec3(0,1,0),this.lightCubeDir[4]=new te.Vec3(0,0,-1),this.lightCubeDir[5]=new te.Vec3(0,0,1),this.animParams=new Float32Array(4),this.camera=this.particleDistance=this.vbOld=this.vbToSort=this.colorParam=this.internalTex2=this.internalTex1=this.internalTex0=null,this.swapTex=!1,this.useMesh=!0,this.useCpu=!1,this.pack8=!0,this.localBounds=new te.BoundingBox,this.worldBoundsNoTrail=new te.BoundingBox,this.worldBoundsTrail=[new te.BoundingBox,new te.BoundingBox],this.worldBounds=new te.BoundingBox,this.worldBoundsSize=new te.Vec3,this.prevWorldBoundsSize=new te.Vec3,this.prevWorldBoundsCenter=new te.Vec3,this.worldBoundsMul=new te.Vec3,this.worldBoundsAdd=new te.Vec3,this.timeToSwitchBounds=0,this.shaderParticleUpdateOnStop=this.shaderParticleUpdateNoRespawn=this.shaderParticleUpdateRespawn=null,this.numParticleIndices=this.numParticleVerts=0,this.meshInstance=this.material=null,this.seed=0,this.fixedTimeStep=1/60,this.maxSubSteps=10,this.simTimeTotal=this.simTime=0,this.beenReset=!1,this._layer=null,this.rebuild()};return Object.assign(x.prototype,{onChangeCamera:function(){this.regenShader(),this.resetMaterial()},calculateBoundsMad:function(){this.worldBoundsMul.x=1/this.worldBoundsSize.x,this.worldBoundsMul.y=1/this.worldBoundsSize.y,this.worldBoundsMul.z=1/this.worldBoundsSize.z,this.worldBoundsAdd.copy(this.worldBounds.center).mul(this.worldBoundsMul).scale(-1),this.worldBoundsAdd.x+=.5,this.worldBoundsAdd.y+=.5,this.worldBoundsAdd.z+=.5},calculateWorldBounds:function(){if(this.node){this.prevWorldBoundsSize.copy(this.worldBoundsSize),this.prevWorldBoundsCenter.copy(this.worldBounds.center);var e=this.node.getWorldTransform();this.localSpace?this.worldBoundsNoTrail.copy(this.localBounds):this.worldBoundsNoTrail.setFromTransformedAabb(this.localBounds,e),this.worldBoundsTrail[0].add(this.worldBoundsNoTrail),this.worldBoundsTrail[1].add(this.worldBoundsNoTrail);var t=this.simTimeTotal;t>=this.timeToSwitchBounds&&(this.worldBoundsTrail[0].copy(this.worldBoundsTrail[1]),this.worldBoundsTrail[1].copy(this.worldBoundsNoTrail),this.timeToSwitchBounds=t+this.lifetime),this.worldBounds.copy(this.worldBoundsTrail[0]),this.worldBoundsSize.copy(this.worldBounds.halfExtents).scale(2),this.localSpace?(this.meshInstance.aabb.setFromTransformedAabb(this.worldBounds,e),this.meshInstance.mesh.aabb.setFromTransformedAabb(this.worldBounds,e)):(this.meshInstance.aabb.copy(this.worldBounds),this.meshInstance.mesh.aabb.copy(this.worldBounds)),this.meshInstance._aabbVer=1-this.meshInstance._aabbVer,this.pack8&&this.calculateBoundsMad()}},resetWorldBounds:function(){this.node&&(this.worldBoundsNoTrail.setFromTransformedAabb(this.localBounds,this.localSpace?te.Mat4.IDENTITY:this.node.getWorldTransform()),this.worldBoundsTrail[0].copy(this.worldBoundsNoTrail),this.worldBoundsTrail[1].copy(this.worldBoundsNoTrail),this.worldBounds.copy(this.worldBoundsTrail[0]),this.worldBoundsSize.copy(this.worldBounds.halfExtents).scale(2),this.prevWorldBoundsSize.copy(this.worldBoundsSize),this.prevWorldBoundsCenter.copy(this.worldBounds.center),this.timeToSwitchBounds=this.simTimeTotal=0)},calculateLocalBounds:function(){var e,t,i,s,n,a,r=Number.MAX_VALUE,o=Number.MAX_VALUE,h=Number.MAX_VALUE,l=-Number.MAX_VALUE,c=-Number.MAX_VALUE,d=-Number.MAX_VALUE,u=0,p=0,f=this.lifetime/this.precision,m=[this.qVelocity,this.qVelocity2],_=[this.qLocalVelocity,this.qLocalVelocity2],g=[0,0],y=[0,0],v=[0,0],b=[0,0],S=[0,0];for(e=0;e<this.precision+1;e++){for(i=Math.min(e,this.precision-1),t=0;t<2;t++)s=_[t][3*i+0]*f+g[t],n=_[t][3*i+1]*f+y[t],a=_[t][3*i+2]*f+v[t],r=Math.min(s,r),o=Math.min(n,o),h=Math.min(a,h),l=Math.max(s,l),c=Math.max(n,c),d=Math.max(a,d),g[t]=s,y[t]=n,v[t]=a;for(t=0;t<2;t++)S[t]+=f*Math.sqrt(m[t][3*i+0]*m[t][3*i+0]+m[t][3*i+1]*m[t][3*i+1]+m[t][3*i+2]*m[t][3*i+2]);b[0]+=this.qRadialSpeed[i]*f,b[1]+=this.qRadialSpeed2[i]*f,u=Math.max(u,Math.max(Math.abs(b[0]),Math.abs(b[1]))),p=Math.max(p,this.qScale[i])}a=this.emitterShape===te.EMITTERSHAPE_BOX?(s=.5*this.emitterExtents.x,n=.5*this.emitterExtents.y,.5*this.emitterExtents.z):n=s=this.emitterRadius,f=Math.max(S[0],S[1]),T.x=r-p-s-u-f,T.y=o-p-n-u-f,T.z=h-p-a-u-f,E.x=l+p+s+u+f,E.y=c+p+n+u+f,E.z=d+p+a+u+f,this.localBounds.setMinMax(T,E)},rebuild:function(){var e,t=this.graphicsDevice;for(null===this.colorMap&&(this.colorMap=x.DEFAULT_PARAM_TEXTURE),this.spawnBounds=this.emitterShape===te.EMITTERSHAPE_BOX?this.emitterExtents:this.emitterRadius,this.useCpu=this.useCpu||this.sort>te.PARTICLESORT_NONE||t.maxVertexTextures<=1||t.fragmentUniformsCount<64||t.forceCpuParticles||!t.extTextureFloat,this._destroyResources(),this.pack8=(this.pack8||!t.textureFloatRenderable)&&!this.useCpu,r=this.useCpu||this.pack8?4:2,this.useMesh=!1,this.mesh&&(65535<this.numParticles*this.mesh.vertexBuffer.numVertices||(this.useMesh=!0)),this.numParticlesPot=te.math.nextPowerOfTwo(this.numParticles),this.rebuildGraphs(),this.calculateLocalBounds(),this.resetWorldBounds(),this.node&&(this.worldBounds.setFromTransformedAabb(this.localBounds,this.localSpace?te.Mat4.IDENTITY:this.node.getWorldTransform()),this.worldBoundsTrail[0].copy(this.worldBounds),this.worldBoundsTrail[1].copy(this.worldBounds),this.worldBoundsSize.copy(this.worldBounds.halfExtents).scale(2),this.prevWorldBoundsSize.copy(this.worldBoundsSize),this.prevWorldBoundsCenter.copy(this.worldBounds.center),this.pack8&&this.calculateBoundsMad()),this.vbToSort=Array(this.numParticles),e=0;e<this.numParticles;e++)this.vbToSort[e]=[0,0];this.particleDistance=new Float32Array(this.numParticles),this._gpuUpdater.randomize(),this.particleTex=new Float32Array(this.numParticlesPot*r*4);var i=null===this.node||this.localSpace?te.Vec3.ZERO:this.node.getPosition();for(this.emitterShape===te.EMITTERSHAPE_BOX&&(null===this.node||this.localSpace?b.setTRS(te.Vec3.ZERO,te.Quat.IDENTITY,this.spawnBounds):b.setTRS(te.Vec3.ZERO,this.node.getRotation(),S.copy(this.spawnBounds).mul(this.node.localScale)),v[0]=0!=this.emitterExtents.x?this.emitterExtentsInner.x/this.emitterExtents.x:0,v[1]=0!=this.emitterExtents.y?this.emitterExtentsInner.y/this.emitterExtents.y:0,v[2]=0!=this.emitterExtents.z?this.emitterExtentsInner.z/this.emitterExtents.z:0),e=0;e<this.numParticles;e++)this._cpuUpdater.calcSpawnPosition(this.particleTex,b,v,i,e),this.useCpu&&(this.particleTex[4*e+3+8*this.numParticlesPot]=1);for(this.particleTexStart=new Float32Array(this.numParticlesPot*r*4),e=0;e<this.particleTexStart.length;e++)this.particleTexStart[e]=this.particleTex[e];this.useCpu||(this.pack8?(this.particleTexIN=f(t,this.numParticlesPot,r,this.particleTex,te.PIXELFORMAT_R8_G8_B8_A8,1,!1),this.particleTexOUT=f(t,this.numParticlesPot,r,this.particleTex,te.PIXELFORMAT_R8_G8_B8_A8,1,!1),this.particleTexStart=f(t,this.numParticlesPot,r,this.particleTexStart,te.PIXELFORMAT_R8_G8_B8_A8,1,!1)):(this.particleTexIN=f(t,this.numParticlesPot,r,this.particleTex),this.particleTexOUT=f(t,this.numParticlesPot,r,this.particleTex),this.particleTexStart=f(t,this.numParticlesPot,r,this.particleTexStart)),this.rtParticleTexIN=new te.RenderTarget(t,this.particleTexIN,{depth:!1}),this.rtParticleTexOUT=new te.RenderTarget(t,this.particleTexOUT,{depth:!1}),this.swapTex=!1),e=te.shaderChunks;var s=(i=(this.localSpace?"#define LOCAL_SPACE\n":"")+e.particleUpdaterInitPS+(this.pack8?e.particleInputRgba8PS+e.particleOutputRgba8PS:e.particleInputFloatPS+e.particleOutputFloatPS)+(this.emitterShape===te.EMITTERSHAPE_BOX?e.particleUpdaterAABBPS:e.particleUpdaterSpherePS)+e.particleUpdaterStartPS)+e.particleUpdaterNoRespawnPS+e.particleUpdaterEndPS,n=i+e.particleUpdaterOnStopPS+e.particleUpdaterEndPS,a=this.emitterShape+""+this.pack8+this.localSpace;this.shaderParticleUpdateRespawn=e.createShaderFromCode(t,e.fullscreenQuadVS,i+e.particleUpdaterRespawnPS+e.particleUpdaterEndPS,"fsQuad0"+a),this.shaderParticleUpdateNoRespawn=e.createShaderFromCode(t,e.fullscreenQuadVS,s,"fsQuad1"+a),this.shaderParticleUpdateOnStop=e.createShaderFromCode(t,e.fullscreenQuadVS,n,"fsQuad2"+a),this.numParticleVerts=this.useMesh?this.mesh.vertexBuffer.numVertices:4,this.numParticleIndices=this.useMesh?this.mesh.indexBuffer[0].numIndices:6,this._allocate(this.numParticles),(t=new te.Mesh).vertexBuffer=this.vertexBuffer,t.indexBuffer[0]=this.indexBuffer,t.primitive[0].type=te.PRIMITIVE_TRIANGLES,t.primitive[0].base=0,t.primitive[0].count=this.numParticles*this.numParticleIndices,t.primitive[0].indexed=!0,this.material=new te.Material,this.material.name=this.node.name,this.material.cull=te.CULLFACE_NONE,this.material.alphaWrite=!1,this.material.blend=!0,this.material.blendType=this.blendType,this.material.depthWrite=this.depthWrite,(this.material.emitter=this).regenShader(),this.resetMaterial(),e=!this.meshInstance||this.meshInstance.visible,this.meshInstance=new te.MeshInstance(this.node,t,this.material),this.meshInstance.pick=!1,this.meshInstance.updateKey(),this.meshInstance.cull=!0,this.meshInstance._noDepthDrawGl1=!0,this.localSpace?this.meshInstance.aabb.setFromTransformedAabb(this.worldBounds,this.node.getWorldTransform()):this.meshInstance.aabb.copy(this.worldBounds),this.meshInstance._updateAabb=!1,this.meshInstance.visible=e,this._initializeTextures(),this.resetTime(),this.addTime(0,!1),this.preWarm&&this.prewarm(this.lifetime)},_isAnimated:function(){return 1<=this.animNumFrames&&(1<this.animTilesX||1<this.animTilesY)&&(this.colorMap&&this.colorMap!==x.DEFAULT_PARAM_TEXTURE||this.normalMap)},rebuildGraphs:function(){var e,t=this.precision,i=this.graphicsDevice;for(this.qLocalVelocity=this.localVelocityGraph.quantize(t),this.qVelocity=this.velocityGraph.quantize(t),this.qColor=this.colorGraph.quantizeClamped(t,0,1),this.qRotSpeed=this.rotationSpeedGraph.quantize(t),this.qScale=this.scaleGraph.quantize(t),this.qAlpha=this.alphaGraph.quantize(t),this.qRadialSpeed=this.radialSpeedGraph.quantize(t),this.qLocalVelocity2=this.localVelocityGraph2.quantize(t),this.qVelocity2=this.velocityGraph2.quantize(t),this.qColor2=this.colorGraph2.quantizeClamped(t,0,1),this.qRotSpeed2=this.rotationSpeedGraph2.quantize(t),this.qScale2=this.scaleGraph2.quantize(t),this.qAlpha2=this.alphaGraph2.quantize(t),this.qRadialSpeed2=this.radialSpeedGraph2.quantize(t),e=0;e<t;e++)this.qRotSpeed[e]*=te.math.DEG_TO_RAD,this.qRotSpeed2[e]*=te.math.DEG_TO_RAD;if(this.localVelocityUMax=new Float32Array(3),this.velocityUMax=new Float32Array(3),this.colorUMax=new Float32Array(3),this.rotSpeedUMax=[0],this.scaleUMax=[0],this.alphaUMax=[0],this.radialSpeedUMax=[0],this.qLocalVelocityDiv=d(this.qLocalVelocity,this.qLocalVelocity2,this.localVelocityUMax),this.qVelocityDiv=d(this.qVelocity,this.qVelocity2,this.velocityUMax),this.qColorDiv=d(this.qColor,this.qColor2,this.colorUMax),this.qRotSpeedDiv=d(this.qRotSpeed,this.qRotSpeed2,this.rotSpeedUMax),this.qScaleDiv=d(this.qScale,this.qScale2,this.scaleUMax),this.qAlphaDiv=d(this.qAlpha,this.qAlpha2,this.alphaUMax),this.qRadialSpeedDiv=d(this.qRadialSpeed,this.qRadialSpeed2,this.radialSpeedUMax),this.pack8){var s=[0,0,0];c(this.qVelocity,s);var n=[0,0,0];c(this.qVelocity2,n),e=[0,0,0],c(this.qLocalVelocity,e);var a=[0,0,0];c(this.qLocalVelocity2,a);var r=[0];c(this.qRadialSpeed,r);var o=[0];c(this.qRadialSpeed2,o);var h=Math.max(s[0],n[0]);h=Math.max(h,s[1]),h=Math.max(h,n[1]),h=Math.max(h,s[2]),h=Math.max(h,n[2]),s=Math.max(e[0],a[0]),s=Math.max(s,e[1]),s=Math.max(s,a[1]),s=Math.max(s,e[2]),s=Math.max(s,a[2]);this.maxVel=h+s+Math.max(r[0],o[0])}if(!this.useCpu){for(this.internalTex0=f(i,t,1,l(this.qLocalVelocity,this.qLocalVelocityDiv)),this.internalTex1=f(i,t,1,l(this.qVelocity,this.qVelocityDiv)),e=this.qRotSpeed,a=this.qScale,r=this.qScaleDiv,o=this.qRotSpeedDiv,h=this.qAlphaDiv,s=Array(4*e.length),n=0;n<e.length;n++)s[4*n]=e[n],s[4*n+1]=a[n],s[4*n+2]=0,s[4*n+3]=(255*r[n]<<16|255*o[n]<<8|255*h[n])/16777216;for(this.internalTex2=f(i,t,1,s),e=this.qRadialSpeed,a=this.qRadialSpeedDiv,r=Array(4*e.length),o=0;o<e.length;o++)r[4*o]=e[o],r[4*o+1]=a[o],r[4*o+2]=0,r[4*o+3]=0;this.internalTex3=f(i,t,1,r)}for(e=this.qColor,a=this.qAlpha,r=Array(4*a.length),o=0;o<a.length;o++)r[4*o]=e[3*o],r[4*o+1]=e[3*o+1],r[4*o+2]=e[3*o+2],r[4*o+3]=a[o];this.colorParam=f(i,t,1,r,te.PIXELFORMAT_R8_G8_B8_A8,1,!0)},_initializeTextures:function(){this.colorMap&&(this.material.setParameter("colorMap",this.colorMap),this.lighting&&this.normalMap&&this.material.setParameter("normalMap",this.normalMap))},regenShader:function(){var e=this.graphicsDevice.getProgramLibrary(),t=null!==this.normalMap;this.normalOption=0,this.lighting&&(this.normalOption=t?2:1),this.material.updateShader=function(){this.emitter.scene&&this.emitter.camera!=this.emitter.scene._activeCamera&&(this.emitter.camera=this.emitter.scene._activeCamera,this.emitter.onChangeCamera()),this.shader=e.getProgram("particle",{useCpu:this.emitter.useCpu,normal:this.emitter.normalOption,halflambert:this.emitter.halfLambert,stretch:this.emitter.stretch,alignToMotion:this.emitter.alignToMotion,soft:this.emitter.depthSoftening,mesh:this.emitter.useMesh,gamma:this.emitter.scene?this.emitter.scene.gammaCorrection:0,toneMap:this.emitter.scene?this.emitter.scene.toneMapping:0,fog:this.emitter.scene&&!this.emitter.noFog?this.emitter.scene.fog:"none",wrap:this.emitter.wrap&&this.emitter.wrapBounds,localSpace:this.emitter.localSpace,blend:this.blendType,animTex:this.emitter._isAnimated(),animTexLoop:this.emitter.animLoop,pack8:this.emitter.pack8,customFace:this.emitter.orientation!=te.PARTICLEORIENTATION_SCREEN})},this.material.updateShader()},resetMaterial:function(){var e=this.material;e.setParameter("stretch",this.stretch),this._isAnimated()&&e.setParameter("animTexParams",this.animParams),e.setParameter("colorMult",this.intensity),this.useCpu||(e.setParameter("internalTex0",this.internalTex0),e.setParameter("internalTex1",this.internalTex1),e.setParameter("internalTex2",this.internalTex2),e.setParameter("internalTex3",this.internalTex3)),e.setParameter("colorParam",this.colorParam),e.setParameter("numParticles",this.numParticles),e.setParameter("numParticlesPot",this.numParticlesPot),e.setParameter("lifetime",this.lifetime),e.setParameter("rate",this.rate),e.setParameter("rateDiv",this.rate2-this.rate),e.setParameter("seed",this.seed),e.setParameter("scaleDivMult",this.scaleUMax[0]),e.setParameter("alphaDivMult",this.alphaUMax[0]),e.setParameter("radialSpeedDivMult",this.radialSpeedUMax[0]),e.setParameter("graphNumSamples",this.precision),e.setParameter("graphSampleSize",1/this.precision),e.setParameter("emitterScale",new Float32Array([1,1,1])),this.pack8&&(this._gpuUpdater._setInputBounds(),e.setParameter("inBoundsSize",this._gpuUpdater.inBoundsSizeUniform),e.setParameter("inBoundsCenter",this._gpuUpdater.inBoundsCenterUniform),e.setParameter("maxVel",this.maxVel)),this.wrap&&this.wrapBounds&&(this.wrapBoundsUniform[0]=this.wrapBounds.x,this.wrapBoundsUniform[1]=this.wrapBounds.y,this.wrapBoundsUniform[2]=this.wrapBounds.z,e.setParameter("wrapBounds",this.wrapBoundsUniform)),this.colorMap&&e.setParameter("colorMap",this.colorMap),this.lighting&&this.normalMap&&e.setParameter("normalMap",this.normalMap),0<this.depthSoftening&&e.setParameter("softening",1/(this.depthSoftening*this.depthSoftening*100)),0<this.stretch&&(e.cull=te.CULLFACE_NONE),this._compParticleFaceParams()},_compParticleFaceParams:function(){var e,t;if(this.orientation==te.PARTICLEORIENTATION_SCREEN)e=new Float32Array([1,0,0]),t=new Float32Array([0,0,1]);else{e=this.orientation==te.PARTICLEORIENTATION_WORLD?this.particleNormal.normalize():(null===this.node?te.Mat4.IDENTITY:this.node.getWorldTransform()).transformVector(this.particleNormal).normalize();var i=new te.Vec3(1,0,0);1==Math.abs(i.dot(e))&&i.set(0,0,1),t=(new te.Vec3).cross(e,i).normalize(),i.cross(t,e).normalize(),e=new Float32Array([i.x,i.y,i.z]),t=new Float32Array([t.x,t.y,t.z])}this.material.setParameter("faceTangent",e),this.material.setParameter("faceBinorm",t)},_allocate:function(e){var t,i=e*this.numParticleVerts,s=e*this.numParticleIndices;if(void 0===this.vertexBuffer||this.vertexBuffer.getNumVertices()!==i){var n,a,r;if(this.useCpu?t=[{semantic:te.SEMANTIC_ATTR0,components:4,type:te.TYPE_FLOAT32},{semantic:te.SEMANTIC_ATTR1,components:4,type:te.TYPE_FLOAT32},{semantic:te.SEMANTIC_ATTR2,components:4,type:te.TYPE_FLOAT32},{semantic:te.SEMANTIC_ATTR3,components:this.useMesh?4:2,type:te.TYPE_FLOAT32}]:(t=[{semantic:te.SEMANTIC_ATTR0,components:4,type:te.TYPE_FLOAT32}],this.useMesh&&t.push({semantic:te.SEMANTIC_ATTR1,components:2,type:te.TYPE_FLOAT32})),t=new te.VertexFormat(this.graphicsDevice,t),this.vertexBuffer=new te.VertexBuffer(this.graphicsDevice,t,i,te.BUFFER_DYNAMIC),this.indexBuffer=new te.IndexBuffer(this.graphicsDevice,te.INDEXFORMAT_UINT16,s),t=new Float32Array(this.vertexBuffer.lock()),this.useMesh)for(a=(n=new Float32Array(this.mesh.vertexBuffer.lock())).length/this.mesh.vertexBuffer.numVertices,s=0;s<this.mesh.vertexBuffer.format.elements.length;s++)if(this.mesh.vertexBuffer.format.elements[s].name===te.SEMANTIC_TEXCOORD0){r=this.mesh.vertexBuffer.format.elements[s].offset/4;break}var o;for(s=0;s<i;s++)if(o=Math.floor(s/this.numParticleVerts),this.useMesh){var h=s%this.numParticleVerts;t[6*s]=n[h*a],t[6*s+1]=n[h*a+1],t[6*s+2]=n[h*a+2],t[6*s+3]=o,t[6*s+4]=n[h*a+r+0],t[6*s+5]=n[h*a+r+1]}else h=s%4,t[4*s]=p[h][0],t[4*s+1]=p[h][1],t[4*s+2]=0,t[4*s+3]=o;for(this.useCpu&&(this.vbCPU=new Float32Array(t),this.vbOld=new Float32Array(this.vbCPU.length)),this.vertexBuffer.unlock(),this.useMesh&&this.mesh.vertexBuffer.unlock(),i=0,a=new Uint16Array(this.indexBuffer.lock()),this.useMesh&&(n=new Uint16Array(this.mesh.indexBuffer[0].lock())),s=0;s<e;s++)if(this.useMesh)for(r=0;r<this.numParticleIndices;r++)a[s*this.numParticleIndices+r]=n[r]+s*this.numParticleVerts;else r=4*s,a[i++]=r,a[i++]=r+1,a[i++]=r+2,a[i++]=r,a[i++]=r+2,a[i++]=r+3;this.indexBuffer.unlock(),this.useMesh&&this.mesh.indexBuffer[0].unlock()}},reset:function(){if(this.beenReset=!0,this.seed=Math.random(),this.material.setParameter("seed",this.seed),this.useCpu)for(var e=0;e<this.particleTexStart.length;e++)this.particleTex[e]=this.particleTexStart[e];else this._initializeTextures();this.resetWorldBounds(),this.resetTime(),e=this.loop,this.loop=!0,this.addTime(0,!1),this.loop=e,this.preWarm&&this.prewarm(this.lifetime)},prewarm:function(e){var t=Math.min(Math.floor(e/this.lifetime*this.precision),this.precision);e/=t;for(var i=0;i<t;i++)this.addTime(e,!1)},resetTime:function(){var e=Math.max(this.rate,this.rate2)*this.numParticles+this.lifetime;this.endTime=Date.now()+1e3*e},finishFrame:function(){this.useCpu&&this.vertexBuffer.unlock()},addTime:function(e,t){var i=this.graphicsDevice;(this.simTimeTotal+=e,this.calculateWorldBounds(),this._isAnimated())&&((n=this.animParams)[0]=1/this.animTilesX,n[1]=1/this.animTilesY,n[2]=this.animNumFrames*this.animSpeed,n[3]=this.animNumFrames-1);this.scene&&this.camera!=this.scene._activeCamera&&(this.camera=this.scene._activeCamera,this.onChangeCamera()),this.emitterShape===te.EMITTERSHAPE_BOX&&(v[0]=0!=this.emitterExtents.x?this.emitterExtentsInner.x/this.emitterExtents.x:0,v[1]=0!=this.emitterExtents.y?this.emitterExtentsInner.y/this.emitterExtents.y:0,v[2]=0!=this.emitterExtents.z?this.emitterExtentsInner.z/this.emitterExtents.z:0,null===this.meshInstance.node?b.setTRS(te.Vec3.ZERO,te.Quat.IDENTITY,this.emitterExtents):b.setTRS(te.Vec3.ZERO,this.meshInstance.node.getRotation(),S.copy(this.emitterExtents).mul(this.meshInstance.node.localScale)));var s,n=null===this.meshInstance.node?te.Vec3.ONE:this.meshInstance.node.localScale;this.emitterScaleUniform[0]=n.x,this.emitterScaleUniform[1]=n.y,this.emitterScaleUniform[2]=n.z,this.material.setParameter("emitterScale",this.emitterScaleUniform),this.localSpace&&this.meshInstance.node&&(s=this.meshInstance.node.getPosition(),this.emitterPosUniform[0]=s.x,this.emitterPosUniform[1]=s.y,this.emitterPosUniform[2]=s.z,this.material.setParameter("emitterPos",this.emitterPosUniform)),this._compParticleFaceParams(),this.useCpu?(i=new Float32Array(this.vertexBuffer.lock()),this._cpuUpdater.update(i,this.vbToSort,this.particleTex,b,v,s,e,t)):this._gpuUpdater.update(i,b,v,e,t),!this.loop&&Date.now()>this.endTime&&(this.onFinished&&this.onFinished(),this.meshInstance.visible=!1)},_destroyResources:function(){this.particleTexIN&&(this.particleTexIN.destroy(),this.particleTexIN=null),this.particleTexOUT&&(this.particleTexOUT.destroy(),this.particleTexOUT=null),this.particleTexStart&&this.particleTexStart.destroy&&(this.particleTexStart.destroy(),this.particleTexStart=null),this.rtParticleTexIN&&(this.rtParticleTexIN.destroy(),this.rtParticleTexIN=null),this.rtParticleTexOUT&&(this.rtParticleTexOUT.destroy(),this.rtParticleTexOUT=null),this.internalTex0&&(this.internalTex0.destroy(),this.internalTex0=null),this.internalTex1&&(this.internalTex1.destroy(),this.internalTex1=null),this.internalTex2&&(this.internalTex2.destroy(),this.internalTex2=null),this.internalTex3&&(this.internalTex3.destroy(),this.internalTex3=null),this.colorParam&&(this.colorParam.destroy(),this.colorParam=null),this.vertexBuffer&&(this.vertexBuffer.destroy(),this.vertexBuffer=void 0),this.indexBuffer&&(this.indexBuffer.destroy(),this.indexBuffer=void 0),this.material&&(this.material.destroy(),this.material=null)},destroy:function(){this.camera=null,this._destroyResources()}}),{ParticleEmitter:x}}()),Object.assign(te,function(){function c(e){return e-Math.floor(e)}function R(e,t){return e-t*Math.floor(e/t)}function d(e){return[c(e)-(e=c(255*e))/255,e-e/255]}var L,D=1,N=new te.Mat4,F=new te.Mat4,u=new te.Vec3,B=new te.Vec3,k=new te.Vec3,V=new te.Vec3,U=new te.Vec3,z=new te.Vec3,H=new te.Vec3,j=new te.Vec3,G=new te.Vec3,W=new te.Vec3,Y=new te.Vec3,X=new te.Vec3,q=new te.Vec3,e=function(e){this._emitter=e};return e.prototype.calcSpawnPosition=function(e,t,i,s,n){var a=this._emitter,r=Math.random(),o=Math.random(),h=Math.random(),l=Math.random();a.useCpu&&(e[4*n+0+8*a.numParticlesPot]=r,e[4*n+1+8*a.numParticlesPot]=o,e[4*n+2+8*a.numParticlesPot]=h),B.x=r-.5,B.y=o-.5,B.z=h-.5,a.emitterShape===te.EMITTERSHAPE_BOX?(o=(l=Math.max(Math.abs(B.x),Math.max(Math.abs(B.y),Math.abs(B.z))))+(.5-l)*i[1],h=l+(.5-l)*i[2],B.x=(l+(.5-l)*i[0])*(l==Math.abs(B.x)?Math.sign(B.x):2*B.x),B.y=o*(l==Math.abs(B.y)?Math.sign(B.y):2*B.y),B.z=h*(l==Math.abs(B.z)?Math.sign(B.z):2*B.z),a.localSpace?u.copy(t.transformPoint(B)):u.copy(s).add(t.transformPoint(B))):(B.normalize(),t=l*(1-(t=0===a.emitterRadius?0:a.emitterRadiusInner/a.emitterRadius))+t,a.localSpace?u.copy(B.scale(t*a.emitterRadius)):u.copy(s).add(B.scale(t*a.emitterRadius))),s=-te.math.lerp(a.rate,a.rate2,r)*n,a.pack8?(l=(u.x-a.worldBounds.center.x)/a.worldBoundsSize.x+.5,i=(u.y-a.worldBounds.center.y)/a.worldBoundsSize.y+.5,t=(u.z-a.worldBounds.center.z)/a.worldBoundsSize.z+.5,r=(r=te.math.lerp(a.startAngle*te.math.DEG_TO_RAD,a.startAngle2*te.math.DEG_TO_RAD,r))%(2*Math.PI)/(2*Math.PI),l=d(l),e[4*n]=l[0],e[4*n+1]=l[1],i=d(i),e[4*n+2]=i[0],e[4*n+3]=i[1],t=d(t),e[4*n+0+4*a.numParticlesPot]=t[0],e[4*n+1+4*a.numParticlesPot]=t[1],r=d(r),e[4*n+2+4*a.numParticlesPot]=r[0],e[4*n+3+4*a.numParticlesPot]=r[1],e[4*n+3+8*a.numParticlesPot]=1,r=c(i=(s+(r=Math.max(a.lifetime,(a.numParticles-1)*Math.max(a.rate,a.rate2))))/(r+(a.lifetime+1))),r=[r-=(s=c(255*i))/255,s-=(t=c(65025*i))/255,t-(i=c(160581375*i))/255,i-i/255],e[4*n+0+12*a.numParticlesPot]=r[0],e[4*n+1+12*a.numParticlesPot]=r[1],e[4*n+2+12*a.numParticlesPot]=r[2],e[4*n+3+12*a.numParticlesPot]=r[3]):(e[4*n]=u.x,e[4*n+1]=u.y,e[4*n+2]=u.z,e[4*n+3]=te.math.lerp(a.startAngle*te.math.DEG_TO_RAD,a.startAngle2*te.math.DEG_TO_RAD,r),e[4*n+3+4*a.numParticlesPot]=s)},e.prototype.update=function(e,t,i,s,n,a,r,o){var h,l,c,d,u=this._emitter;if(u.meshInstance.node){for(d=u.meshInstance.node.worldTransform,a=0;a<12;a++)N.data[a]=d.data[a];F.copy(N),F.invert(),L=u.meshInstance.node.localScale,D=Math.max(Math.max(L.x,L.y),L.z)}a=null===u.meshInstance.node||u.localSpace?te.Vec3.ZERO:u.meshInstance.node.getPosition();var p,f,m,_,g,y,v,b,S=u.camera?u.camera._node.getPosition():te.Vec3.ZERO,T=u.useMesh?16:14,E=u.precision-1;for(d=0;d<u.numParticles;d++){var x=Math.floor(u.vbCPU[d*u.numParticleVerts*(u.useMesh?6:4)+3]),A=i[4*x+0+8*u.numParticlesPot];k.x=A,k.y=i[4*x+1+8*u.numParticlesPot],k.z=i[4*x+2+8*u.numParticlesPot];var M=u.rate+(u.rate2-u.rate)*A,C=u.lifetime,P=i[4*x+3+4*u.numParticlesPot]+r,I=Math.max(Math.min(P/C,1),0),w=0;(P-r<=(c=0)||C<=P)&&this.calcSpawnPosition(i,s,n,a,x);var O=0<P&&P<C;for(O&&(c=I*E,p=Math.floor(c),f=Math.ceil(c),c%=1,m=(h=u.qRotSpeed[p])+((l=u.qRotSpeed[f])-h)*c,_=(h=u.qRotSpeed2[p])+((l=u.qRotSpeed2[f])-h)*c,w=(h=u.qScale[p])+((l=u.qScale[f])-h)*c,g=(h=u.qScale2[p])+((l=u.qScale2[f])-h)*c,y=(h=u.qAlpha[p])+((l=u.qAlpha[f])-h)*c,v=(h=u.qAlpha2[p])+((l=u.qAlpha2[f])-h)*c,b=(h=u.qRadialSpeed[p])+((l=u.qRadialSpeed[f])-h)*c,h=u.qRadialSpeed2[p],b+=100*A%1*((h+=((l=u.qRadialSpeed2[f])-h)*c)-b),V.x=i[4*x],V.y=i[4*x+1],V.z=i[4*x+2],u.localSpace?G.copy(V):G.copy(V).sub(a),G.normalize().scale(b),p*=3,f*=3,h=u.qLocalVelocity[p],l=u.qLocalVelocity[f],z.x=h+(l-h)*c,h=u.qLocalVelocity[p+1],l=u.qLocalVelocity[f+1],z.y=h+(l-h)*c,h=u.qLocalVelocity[p+2],l=u.qLocalVelocity[f+2],z.z=h+(l-h)*c,h=u.qLocalVelocity2[p],l=u.qLocalVelocity2[f],j.x=h+(l-h)*c,h=u.qLocalVelocity2[p+1],l=u.qLocalVelocity2[f+1],j.y=h+(l-h)*c,h=u.qLocalVelocity2[p+2],l=u.qLocalVelocity2[f+2],j.z=h+(l-h)*c,h=u.qVelocity[p],l=u.qVelocity[f],U.x=h+(l-h)*c,h=u.qVelocity[p+1],l=u.qVelocity[f+1],U.y=h+(l-h)*c,h=u.qVelocity[p+2],l=u.qVelocity[f+2],U.z=h+(l-h)*c,h=u.qVelocity2[p],l=u.qVelocity2[f],H.x=h+(l-h)*c,h=u.qVelocity2[p+1],l=u.qVelocity2[f+1],H.y=h+(l-h)*c,h=u.qVelocity2[p+2],l=u.qVelocity2[f+2],H.z=h+(l-h)*c,z.x+=(j.x-z.x)*k.x,z.y+=(j.y-z.y)*k.y,z.z+=(j.z-z.z)*k.z,0<u.initialVelocity&&(u.emitterShape===te.EMITTERSHAPE_SPHERE?(B.copy(k).scale(2).sub(te.Vec3.ONE).normalize(),z.add(B.scale(u.initialVelocity))):z.add(te.Vec3.FORWARD.scale(u.initialVelocity))),U.x+=(H.x-U.x)*k.x,U.y+=(H.y-U.y)*k.y,U.z+=(H.z-U.z)*k.z,m+=(_-m)*k.y,w=(w+1e4*A%1*(g-w))*D,c=1e3*A%1*(v-y),u.meshInstance.node&&(u.localSpace?(z.x/=L.x,z.y/=L.y,z.z/=L.z):N.transformPoint(z,z)),u.localSpace?(F.transformPoint(U,U),z.add(U).add(G)):(z.add(U.mul(L)),z.add(G.mul(L))),X.copy(z),W.copy(V).add(z.scale(r)),Y.copy(W),i[4*x]=Y.x,i[4*x+1]=Y.y,i[4*x+2]=Y.z,i[4*x+3]+=m*r,u.wrap&&u.wrapBounds&&(u.localSpace||Y.sub(a),Y.x=R(Y.x,u.wrapBounds.x)-.5*u.wrapBounds.x,Y.y=R(Y.y,u.wrapBounds.y)-.5*u.wrapBounds.y,Y.z=R(Y.z,u.wrapBounds.z)-.5*u.wrapBounds.z,u.localSpace||Y.add(a)),0<u.sort&&(1===u.sort?(q.copy(Y).sub(S),u.particleDistance[x]=-(q.x*q.x+q.y*q.y+q.z*q.z)):2===u.sort?u.particleDistance[x]=P:3===u.sort&&(u.particleDistance[x]=-P))),o?P<0&&(i[4*x+3+8*u.numParticlesPot]=-1):(C<=P&&(P-=Math.max(C,(u.numParticles-1)*M),i[4*x+3+8*u.numParticlesPot]=u.loop?1:-1),P<0&&u.loop&&(i[4*x+3+8*u.numParticlesPot]=1)),i[4*x+3+8*u.numParticlesPot]<0&&(O=!1),i[4*x+3+4*u.numParticlesPot]=P,m=0;m<u.numParticleVerts;m++)A=(d*u.numParticleVerts+m)*(u.useMesh?6:4),M=u.vbCPU[A],C=u.vbCPU[A+1],P=u.vbCPU[A+2],O||(M=C=P=0),e[p=d*u.numParticleVerts*T+m*T]=Y.x,e[p+1]=Y.y,e[p+2]=Y.z,e[p+3]=I,e[p+4]=u.alignToMotion?0:i[4*x+3],e[p+5]=w,e[p+6]=c,e[p+7]=X.x,e[p+8]=M,e[p+9]=C,e[p+10]=P,e[p+11]=X.y,e[p+12]=X.z,e[p+13]=u.vbCPU[A+3],u.useMesh&&(e[p+14]=u.vbCPU[A+4],e[p+15]=u.vbCPU[A+5])}if(u.sort>te.PARTICLESORT_NONE&&u.camera){for(e=u.useMesh?6:4,i=u.particleDistance,d=0;d<u.numParticles;d++)t[d][0]=d,t[d][1]=i[Math.floor(u.vbCPU[d*u.numParticleVerts*e+3])];for(u.vbOld.set(u.vbCPU),t.sort(function(e,t){return e[1]-t[1]}),d=0;d<u.numParticles;d++)for(i=t[d][0]*u.numParticleVerts*e,s=d*u.numParticleVerts*e,a=0;a<u.numParticleVerts*e;a++)u.vbCPU[s+a]=u.vbOld[i+a]}},{ParticleCPUUpdater:e}}()),Object.assign(te,function(){function l(e,t){t.data[0]=e.data[0],t.data[1]=e.data[1],t.data[2]=e.data[2],t.data[3]=e.data[4],t.data[4]=e.data[5],t.data[5]=e.data[6],t.data[6]=e.data[8],t.data[7]=e.data[9],t.data[8]=e.data[10]}var c=new te.Mat3,d=new te.Mat3,u=new te.Mat3,e=function(e,t){this._emitter=e,this.frameRandomUniform=new Float32Array(3),this.emitterPosUniform=new Float32Array(3),this.emitterScaleUniform=new Float32Array([1,1,1]),this.worldBoundsMulUniform=new Float32Array(3),this.worldBoundsAddUniform=new Float32Array(3),this.inBoundsSizeUniform=new Float32Array(3),this.inBoundsCenterUniform=new Float32Array(3),this.constantParticleTexIN=t.scope.resolve("particleTexIN"),this.constantParticleTexOUT=t.scope.resolve("particleTexOUT"),this.constantEmitterPos=t.scope.resolve("emitterPos"),this.constantEmitterScale=t.scope.resolve("emitterScale"),this.constantSpawnBounds=t.scope.resolve("spawnBounds"),this.constantSpawnPosInnerRatio=t.scope.resolve("spawnPosInnerRatio"),this.constantSpawnBoundsSphere=t.scope.resolve("spawnBoundsSphere"),this.constantSpawnBoundsSphereInnerRatio=t.scope.resolve("spawnBoundsSphereInnerRatio"),this.constantInitialVelocity=t.scope.resolve("initialVelocity"),this.constantFrameRandom=t.scope.resolve("frameRandom"),this.constantDelta=t.scope.resolve("delta"),this.constantRate=t.scope.resolve("rate"),this.constantRateDiv=t.scope.resolve("rateDiv"),this.constantLifetime=t.scope.resolve("lifetime"),this.constantGraphSampleSize=t.scope.resolve("graphSampleSize"),this.constantGraphNumSamples=t.scope.resolve("graphNumSamples"),this.constantInternalTex0=t.scope.resolve("internalTex0"),this.constantInternalTex1=t.scope.resolve("internalTex1"),this.constantInternalTex2=t.scope.resolve("internalTex2"),this.constantInternalTex3=t.scope.resolve("internalTex3"),this.constantEmitterMatrix=t.scope.resolve("emitterMatrix"),this.constantEmitterMatrixInv=t.scope.resolve("emitterMatrixInv"),this.constantNumParticles=t.scope.resolve("numParticles"),this.constantNumParticlesPot=t.scope.resolve("numParticlesPot"),this.constantLocalVelocityDivMult=t.scope.resolve("localVelocityDivMult"),this.constantVelocityDivMult=t.scope.resolve("velocityDivMult"),this.constantRotSpeedDivMult=t.scope.resolve("rotSpeedDivMult"),this.constantSeed=t.scope.resolve("seed"),this.constantStartAngle=t.scope.resolve("startAngle"),this.constantStartAngle2=t.scope.resolve("startAngle2"),this.constantOutBoundsMul=t.scope.resolve("outBoundsMul"),this.constantOutBoundsAdd=t.scope.resolve("outBoundsAdd"),this.constantInBoundsSize=t.scope.resolve("inBoundsSize"),this.constantInBoundsCenter=t.scope.resolve("inBoundsCenter"),this.constantMaxVel=t.scope.resolve("maxVel"),this.constantFaceTangent=t.scope.resolve("faceTangent"),this.constantFaceBinorm=t.scope.resolve("faceBinorm")};return e.prototype._setInputBounds=function(){this.inBoundsSizeUniform[0]=this._emitter.prevWorldBoundsSize.x,this.inBoundsSizeUniform[1]=this._emitter.prevWorldBoundsSize.y,this.inBoundsSizeUniform[2]=this._emitter.prevWorldBoundsSize.z,this.constantInBoundsSize.setValue(this.inBoundsSizeUniform),this.inBoundsCenterUniform[0]=this._emitter.prevWorldBoundsCenter.x,this.inBoundsCenterUniform[1]=this._emitter.prevWorldBoundsCenter.y,this.inBoundsCenterUniform[2]=this._emitter.prevWorldBoundsCenter.z,this.constantInBoundsCenter.setValue(this.inBoundsCenterUniform)},e.prototype.randomize=function(){this.frameRandomUniform[0]=Math.random(),this.frameRandomUniform[1]=Math.random(),this.frameRandomUniform[2]=Math.random()},e.prototype.update=function(e,t,i,s,n){var a=this._emitter;e.setBlending(!1),e.setColorWrite(!0,!0,!0,!0),e.setCullMode(te.CULLFACE_NONE),e.setDepthTest(!1),e.setDepthWrite(!1),this.randomize(),this.constantGraphSampleSize.setValue(1/a.precision),this.constantGraphNumSamples.setValue(a.precision),this.constantNumParticles.setValue(a.numParticles),this.constantNumParticlesPot.setValue(a.numParticlesPot),this.constantInternalTex0.setValue(a.internalTex0),this.constantInternalTex1.setValue(a.internalTex1),this.constantInternalTex2.setValue(a.internalTex2),this.constantInternalTex3.setValue(a.internalTex3);var r=a.meshInstance.node,o=null===r?te.Vec3.ONE:r.localScale;if(a.pack8){this.worldBoundsMulUniform[0]=a.worldBoundsMul.x,this.worldBoundsMulUniform[1]=a.worldBoundsMul.y,this.worldBoundsMulUniform[2]=a.worldBoundsMul.z,this.constantOutBoundsMul.setValue(this.worldBoundsMulUniform),this.worldBoundsAddUniform[0]=a.worldBoundsAdd.x,this.worldBoundsAddUniform[1]=a.worldBoundsAdd.y,this.worldBoundsAddUniform[2]=a.worldBoundsAdd.z,this.constantOutBoundsAdd.setValue(this.worldBoundsAddUniform),this._setInputBounds();var h=a.maxVel*Math.max(Math.max(o.x,o.y),o.z);h=Math.max(h,1);this.constantMaxVel.setValue(h)}h=null===r||a.localSpace?te.Vec3.ZERO:r.getPosition(),r=null===r?te.Mat4.IDENTITY:r.getWorldTransform(),a.emitterShape===te.EMITTERSHAPE_BOX?(l(t,c),this.constantSpawnBounds.setValue(c.data),this.constantSpawnPosInnerRatio.setValue(i)):(this.constantSpawnBoundsSphere.setValue(a.emitterRadius),this.constantSpawnBoundsSphereInnerRatio.setValue(0===a.emitterRadius?0:a.emitterRadiusInner/a.emitterRadius)),this.constantInitialVelocity.setValue(a.initialVelocity),l(r,d),r.invertTo3x3(u),this.emitterPosUniform[0]=h.x,this.emitterPosUniform[1]=h.y,this.emitterPosUniform[2]=h.z,this.constantEmitterPos.setValue(this.emitterPosUniform),this.constantFrameRandom.setValue(this.frameRandomUniform),this.constantDelta.setValue(s),this.constantRate.setValue(a.rate),this.constantRateDiv.setValue(a.rate2-a.rate),this.constantStartAngle.setValue(a.startAngle*te.math.DEG_TO_RAD),this.constantStartAngle2.setValue(a.startAngle2*te.math.DEG_TO_RAD),this.constantSeed.setValue(a.seed),this.constantLifetime.setValue(a.lifetime),this.emitterScaleUniform[0]=o.x,this.emitterScaleUniform[1]=o.y,this.emitterScaleUniform[2]=o.z,this.constantEmitterScale.setValue(this.emitterScaleUniform),this.constantEmitterMatrix.setValue(d.data),this.constantEmitterMatrixInv.setValue(u.data),this.constantLocalVelocityDivMult.setValue(a.localVelocityUMax),this.constantVelocityDivMult.setValue(a.velocityUMax),this.constantRotSpeedDivMult.setValue(a.rotSpeedUMax[0]),t=a.swapTex?a.particleTexOUT:a.particleTexIN,t=a.beenReset?a.particleTexStart:t,i=a.swapTex?a.particleTexIN:a.particleTexOUT,this.constantParticleTexIN.setValue(t),te.drawQuadWithShader(e,a.swapTex?a.rtParticleTexIN:a.rtParticleTexOUT,n?a.shaderParticleUpdateOnStop:a.loop?a.shaderParticleUpdateRespawn:a.shaderParticleUpdateNoRespawn),a.material.setParameter("particleTexOUT",t),a.material.setParameter("particleTexIN",i),a.beenReset=!1,a.swapTex=!a.swapTex,e.setDepthTest(!0),e.setDepthWrite(!0),a.prevWorldBoundsSize.copy(a.worldBoundsSize),a.prevWorldBoundsCenter.copy(a.worldBounds.center),a.pack8&&this._setInputBounds()},{ParticleGPUUpdater:e}}()),Object.assign(te,(Tt=!1,(Et=function(e,t,i){e instanceof te.GraphicsDevice&&(e=te.Application.getApplication(),Tt||(Tt=!0)),this.app=e;var s=this.device=e.graphicsDevice;this.library=s.getProgramLibrary(),this.pickColor=new Float32Array(4),this.pickColor[3]=1,this.scene=null,this.drawCalls=[],this.layerComp=this.layer=null,this.clearOptions={color:[1,1,1,1],depth:1,flags:te.CLEARFLAG_COLOR|te.CLEARFLAG_DEPTH};var n=this;this._clearDepthOptions={depth:1,flags:te.CLEARFLAG_DEPTH},this.clearDepthCommand=new te.Command(0,0,function(){s.clear(n._clearDepthOptions)}),this.resize(t,i),this._ignoreOpacityFor=null}).prototype.getSelection=function(e,t,i,s){var n=this.device;"object"==typeof e?(e=(s=e).x,t=s.y,i=s.width,s=s.height):t=this.layer.renderTarget.height-(t+(s||1)),i=i||1,s=s||1;var a=n.renderTarget;n.setRenderTarget(this.layer.renderTarget),n.updateBegin();var r=new Uint8Array(4*i*s);for(n.readPixels(e,t,i,s,r),n.updateEnd(),n.setRenderTarget(a),e=[],t=this.layer.instances.visibleOpaque[0].list,n=0;n<i*s;n++)16777215!=(a=(a=r[4*n+0])<<16|r[4*n+1]<<8|r[4*n+2])&&(a=t[a],-1===e.indexOf(a)&&e.push(a));return e},Et.prototype.prepare=function(e,t,i){var s,n=this.device,a=this;e instanceof te.Camera&&(e=e._component),this.scene=t;var r,o,h,l=null,c=null;if(i instanceof te.Layer?l=i:c=i,!this.layer){var d=n.scope.resolve("uColor");this.layer=new te.Layer({name:"Picker",shaderPass:te.SHADER_PICK,opaqueSortMode:te.SORTMODE_NONE,onEnable:function(){if(!this.renderTarget){var e=new te.Texture(n,{format:te.PIXELFORMAT_R8_G8_B8_A8,width:a.width,height:a.height});e.name="pick",e.minFilter=te.FILTER_NEAREST,e.magFilter=te.FILTER_NEAREST,e.addressU=te.ADDRESS_CLAMP_TO_EDGE,e.addressV=te.ADDRESS_CLAMP_TO_EDGE,this.renderTarget=new te.RenderTarget(n,e,{depth:!0})}},onDisable:function(){this.renderTarget&&(this.renderTarget._colorBuffer.destroy(),this.renderTarget.destroy(),this.renderTarget=null)},onDrawCall:function(e,t){a.pickColor[0]=(t>>16&255)/255,a.pickColor[1]=(t>>8&255)/255,a.pickColor[2]=(255&t)/255,d.setValue(a.pickColor),n.setBlending(!1)}}),this.layerComp=new te.LayerComposition,this.layerComp.pushOpaque(this.layer),this.meshInstances=this.layer.opaqueMeshInstances,this._instancesVersion=-1}if(l){if(this._instancesVersion!==l._version){for(this.layer.clearMeshInstances(),o=(r=l.instances.opaqueMeshInstances).length,s=0;s<o;s++)(h=r[s]).pick&&this.meshInstances.push(h);for(o=(r=l.instances.transparentMeshInstances).length,s=0;s<o;s++)(h=r[s]).pick&&this.meshInstances.push(h);this._instancesVersion=l._version}}else{this.layer.clearMeshInstances(),i=t.layers.layerList;var u=t.layers.subLayerEnabled,p=t.layers.subLayerList;for(t=0;t<i.length;t++)i[t].overrideClear&&i[t]._clearDepthBuffer&&(i[t]._pickerCleared=!1);for(t=0;t<i.length;t++)if((s=i[t]).renderTarget===c&&s.enabled&&u[t]&&!((r=s.cameras.indexOf(e))<0))for(s.overrideClear&&s._clearDepthBuffer&&!s._pickerCleared&&(this.meshInstances.push(this.clearDepthCommand),s._pickerCleared=!0),o=(r=(r=p[t])?s.instances.transparentMeshInstances:s.instances.opaqueMeshInstances).length,s=0;s<o;s++)(h=r[s]).pick&&this.meshInstances.push(h)}this.layer.cameras[0]!==e&&(this.layer.clearCameras(),this.layer.addCamera(e)),this.onLayerPreRender(this.layer,l,c),this.app.renderer.renderComposition(this.layerComp),this.onLayerPostRender(this.layer)},Et.prototype.onLayerPreRender=function(e,t,i){this.width===e.renderTarget.width&&this.height===e.renderTarget.height||(e.onDisable(),e.onEnable()),e.oldClear=e.cameras[0].camera._clearOptions,e.oldAspectMode=e.cameras[0].aspectRatioMode,e.oldAspect=e.cameras[0].aspectRatio,e.cameras[0].camera._clearOptions=this.clearOptions,e.cameras[0].aspectRatioMode=te.ASPECT_MANUAL,e.cameras[0].aspectRatio=e.cameras[0].calculateAspectRatio(i||(t?t.renderTarget:null)),this.app.renderer.updateCameraFrustum(e.cameras[0].camera)},Et.prototype.onLayerPostRender=function(e){e.cameras[0].camera._clearOptions=e.oldClear,e.cameras[0].aspectRatioMode=e.oldAspectMode,e.cameras[0].aspectRatio=e.oldAspect},Et.prototype.resize=function(e,t){this.width=e,this.height=t},Object.defineProperty(Et.prototype,"renderTarget",{get:function(){return this.layer.renderTarget}}),{Picker:Et}));var Rt,Lt,Dt,Nt,Ft,Bt,kt,Vt,Ut,zt,Ht,jt,Gt,Wt,Yt,Xt,qt,Kt,Zt,Qt,$t,Jt,ei,ti,ii,si,ni,ai,ri,oi,hi,li,ci,di,ui,pi,fi,mi,_i,gi,yi,vi,bi,Si,Ti,Ei,xi,Ai,Mi,Ci,Pi,Ii,wi,Oi,Ri,Li,Di,Ni,Fi,Bi,ki,Vi,Ui,zi,Hi,ji,Gi,Wi,Yi,Xi,qi,Ki,Zi,Qi,$i,Ji,es,ts,is,ss,ns,as,rs,os,hs,ls,cs,ds,us,ps,fs,ms,_s,gs,ys,vs,bs,Ss,Ts,Es,xs,As,Ms,Cs,Ps,Is,ws,Os,Rs,Ls,Ds,Ns,Fs,Bs,ks,Vs,Us,zs,Hs,js,Gs,Ws,Ys,Xs,qs,Ks,Zs,Qs,$s,Js,en,tn,sn,nn,an,rn,on,hn,ln,cn,dn,un,pn,fn,mn,_n,gn,yn,vn,bn,Sn,Tn,En,xn,An,Mn,Cn,Pn,In,wn,On,Rn,Ln,Dn,Nn,Fn,Bn,kn,Vn,Un,zn,Hn,jn,Gn,Wn,Yn,Xn,qn,Kn,Zn,Qn,$n,Jn,ea,ta,ia,sa,na,aa,ra,oa,ha=.0625,la=.875;return te.calculateNormals=function(e,t){var i,s,n,a,r=t.length/3,o=e.length/3,h=new te.Vec3,l=new te.Vec3,c=new te.Vec3,d=new te.Vec3,u=new te.Vec3,p=new te.Vec3,f=[];for(a=0;a<e.length;a++)f[a]=0;for(a=0;a<r;a++)i=t[3*a],s=t[3*a+1],n=t[3*a+2],h.set(e[3*i],e[3*i+1],e[3*i+2]),l.set(e[3*s],e[3*s+1],e[3*s+2]),c.set(e[3*n],e[3*n+1],e[3*n+2]),d.sub2(l,h),u.sub2(c,h),p.cross(d,u).normalize(),f[3*i]+=p.x,f[3*i+1]+=p.y,f[3*i+2]+=p.z,f[3*s]+=p.x,f[3*s+1]+=p.y,f[3*s+2]+=p.z,f[3*n]+=p.x,f[3*n+1]+=p.y,f[3*n+2]+=p.z;for(a=0;a<o;a++)r=f[3*a],i=f[3*a+1],s=f[3*a+2],r=1/Math.sqrt(r*r+i*i+s*s),f[3*a]*=r,f[3*a+1]*=r,f[3*a+2]*=r;return f},te.calculateTangents=function(e,t,i,s){var n,a,r,o,h,l,c,d,u,p,f,m,_,g,y,v=s.length/3,b=e.length/3,S=new te.Vec3,T=new te.Vec3,E=new te.Vec3,x=new te.Vec3,A=new te.Vec3,M=new te.Vec2,C=new te.Vec2,P=new te.Vec2,I=new Float32Array(3*b),w=new Float32Array(3*b),O=[];for(y=0;y<v;y++)n=s[3*y],a=s[3*y+1],r=s[3*y+2],E.set(e[3*n],e[3*n+1],e[3*n+2]),x.set(e[3*a],e[3*a+1],e[3*a+2]),A.set(e[3*r],e[3*r+1],e[3*r+2]),M.set(i[2*n],i[2*n+1]),C.set(i[2*a],i[2*a+1]),P.set(i[2*r],i[2*r+1]),o=x.x-E.x,h=A.x-E.x,l=x.y-E.y,c=A.y-E.y,d=x.z-E.z,u=A.z-E.z,p=C.x-M.x,f=P.x-M.x,m=C.y-M.y,0==(g=p*(_=P.y-M.y)-f*m)?(S.set(0,1,0),T.set(1,0,0)):(g=1/g,S.set((_*o-m*h)*g,(_*l-m*c)*g,(_*d-m*u)*g),T.set((p*h-f*o)*g,(p*c-f*l)*g,(p*u-f*d)*g)),I[3*n+0]+=S.x,I[3*n+1]+=S.y,I[3*n+2]+=S.z,I[3*a+0]+=S.x,I[3*a+1]+=S.y,I[3*a+2]+=S.z,I[3*r+0]+=S.x,I[3*r+1]+=S.y,I[3*r+2]+=S.z,w[3*n+0]+=T.x,w[3*n+1]+=T.y,w[3*n+2]+=T.z,w[3*a+0]+=T.x,w[3*a+1]+=T.y,w[3*a+2]+=T.z,w[3*r+0]+=T.x,w[3*r+1]+=T.y,w[3*r+2]+=T.z;for(m=new te.Vec3,_=new te.Vec3,e=new te.Vec3,i=new te.Vec3,y=0;y<b;y++)e.set(t[3*y],t[3*y+1],t[3*y+2]),m.set(I[3*y],I[3*y+1],I[3*y+2]),_.set(w[3*y],w[3*y+1],w[3*y+2]),s=e.dot(m),i.copy(e).scale(s),i.sub2(m,i).normalize(),O[4*y]=i.x,O[4*y+1]=i.y,O[4*y+2]=i.z,i.cross(e,m),O[4*y+3]=i.dot(_)<0?-1:1;return O},te.createMesh=function(e,t,i){var s=i&&void 0!==i.normals?i.normals:null,n=i&&void 0!==i.tangents?i.tangents:null,a=i&&void 0!==i.colors?i.colors:null,r=i&&void 0!==i.uvs?i.uvs:null,o=i&&void 0!==i.uvs1?i.uvs1:null,h=i&&void 0!==i.indices?i.indices:null,l=i&&void 0!==i.blendIndices?i.blendIndices:null,c=i&&void 0!==i.blendWeights?i.blendWeights:null;i=[{semantic:te.SEMANTIC_POSITION,components:3,type:te.TYPE_FLOAT32}],null!==s&&i.push({semantic:te.SEMANTIC_NORMAL,components:3,type:te.TYPE_FLOAT32}),null!==n&&i.push({semantic:te.SEMANTIC_TANGENT,components:4,type:te.TYPE_FLOAT32}),null!==a&&i.push({semantic:te.SEMANTIC_COLOR,components:4,type:te.TYPE_UINT8,normalize:!0}),null!==r&&i.push({semantic:te.SEMANTIC_TEXCOORD0,components:2,type:te.TYPE_FLOAT32}),null!==o&&i.push({semantic:te.SEMANTIC_TEXCOORD1,components:2,type:te.TYPE_FLOAT32}),null!==l&&i.push({semantic:te.SEMANTIC_BLENDINDICES,components:2,type:te.TYPE_UINT8}),null!==c&&i.push({semantic:te.SEMANTIC_BLENDWEIGHT,components:2,type:te.TYPE_FLOAT32});var d=new te.VertexFormat(e,i);i=t.length/3;d=new te.VertexBuffer(e,d,i);for(var u=new te.VertexIterator(d),p=0;p<i;p++)u.element[te.SEMANTIC_POSITION].set(t[3*p],t[3*p+1],t[3*p+2]),null!==s&&u.element[te.SEMANTIC_NORMAL].set(s[3*p],s[3*p+1],s[3*p+2]),null!==n&&u.element[te.SEMANTIC_TANGENT].set(n[4*p],n[4*p+1],n[4*p+2],n[4*p+3]),null!==a&&u.element[te.SEMANTIC_COLOR].set(a[4*p],a[4*p+1],a[4*p+2],a[4*p+3]),null!==r&&u.element[te.SEMANTIC_TEXCOORD0].set(r[2*p],r[2*p+1]),null!==o&&u.element[te.SEMANTIC_TEXCOORD1].set(o[2*p],o[2*p+1]),null!==l&&u.element[te.SEMANTIC_BLENDINDICES].set(l[2*p],l[2*p+1]),null!==c&&u.element[te.SEMANTIC_BLENDWEIGHT].set(c[2*p],c[2*p+1]),u.next();return u.end(),(n=(s=null)!==h)&&(s=new te.IndexBuffer(e,te.INDEXFORMAT_UINT16,h.length),new Uint16Array(s.lock()).set(h),s.unlock()),(e=new te.BoundingBox).compute(t),(t=new te.Mesh).vertexBuffer=d,t.indexBuffer[0]=s,t.primitive[0].type=te.PRIMITIVE_TRIANGLES,t.primitive[0].base=0,t.primitive[0].count=n?h.length:i,t.primitive[0].indexed=n,t.aabb=e,t},te.createTorus=function(e,t){var i,s,n,a,r,o,h,l,c,d,u=t&&void 0!==t.tubeRadius?t.tubeRadius:.2,p=t&&void 0!==t.ringRadius?t.ringRadius:.3,f=t&&void 0!==t.segments?t.segments:30,m=t&&void 0!==t.sides?t.sides:20,_=!(!t||void 0===t.calculateTangents)&&t.calculateTangents,g=[],y=[],v=[],b=[];for(i=0;i<=m;i++)for(s=0;s<=f;s++)n=Math.cos(2*Math.PI*s/f)*(p+u*Math.cos(2*Math.PI*i/m)),a=Math.sin(2*Math.PI*i/m)*u,r=Math.sin(2*Math.PI*s/f)*(p+u*Math.cos(2*Math.PI*i/m)),o=Math.cos(2*Math.PI*s/f)*Math.cos(2*Math.PI*i/m),h=Math.sin(2*Math.PI*i/m),l=Math.sin(2*Math.PI*s/f)*Math.cos(2*Math.PI*i/m),c=i/m,d=1-s/f,g.push(n,a,r),y.push(o,h,l),v.push(c,d),i<m&&s<f&&(n=i*(f+1)+s,a=(i+1)*(f+1)+s,r=i*(f+1)+(s+1),o=(i+1)*(f+1)+(s+1),b.push(n,a,r),b.push(a,o,r));return u={normals:y,uvs:v,indices:b},_&&(u.tangents=te.calculateTangents(g,y,v,b)),te.createMesh(e,g,u)},te._createConeData=function(e,t,i,s,n,a){var r,o,h,l,c,d=new te.Vec3,u=new te.Vec3;h=new te.Vec3;var p,f,m=[],_=[],g=[],y=[],v=[];if(0<i)for(r=0;r<=s;r++)for(o=0;o<=n;o++)f=o/n*2*Math.PI-Math.PI,p=Math.sin(f),f=Math.cos(f),c=new te.Vec3(p*e,-i/2,f*e),l=new te.Vec3(p*t,i/2,f*t),d.lerp(c,l,r/s),u.sub2(l,c).normalize(),p=new te.Vec3(f,0,-p),h.cross(p,u).normalize(),m.push(d.x,d.y,d.z),_.push(h.x,h.y,h.z),l=o/n,c=r/s,g.push(l,c),p=c,c=l,l=p,l=(l/=3)*la+ha,c=c*la+ha,y.push(l,c),r<s&&o<n&&(p=r*(n+1)+o,f=r*(n+1)+(o+1),l=(r+1)*(n+1)+o,c=(r+1)*(n+1)+(o+1),v.push(p,f,l),v.push(f,c,l));if(a){for(e=Math.floor(n/2),r=i/2,i=0;i<=e;i++)for(f=i*Math.PI*.5/e,p=Math.sin(f),f=Math.cos(f),d=0;d<=n;d++)a=2*d*Math.PI/n-Math.PI/2,l=Math.sin(a),a=Math.cos(a),a*=p,o=f,h=l*p,l=1-d/n,c=1-i/e,m.push(a*t,o*t+r,h*t),_.push(a,o,h),g.push(l,c),l=(l/=3)*la+ha,c=(c/=3)*la+ha,l+=1/3,y.push(l,c);for(u=(s+1)*(n+1),i=0;i<e;++i)for(d=0;d<n;++d)f=(p=i*(n+1)+d)+n+1,v.push(u+p+1,u+f,u+p),v.push(u+p+1,u+f+1,u+f);for(i=0;i<=e;i++)for(f=.5*Math.PI+i*Math.PI*.5/e,p=Math.sin(f),f=Math.cos(f),d=0;d<=n;d++)a=2*d*Math.PI/n-Math.PI/2,l=Math.sin(a),a=Math.cos(a),a*=p,o=f,h=l*p,l=1-d/n,c=1-i/e,m.push(a*t,o*t-r,h*t),_.push(a,o,h),g.push(l,c),l=(l/=3)*la+ha,c=(c/=3)*la+ha,l+=2/3,y.push(l,c);for(u=(s+1)*(n+1)+(n+1)*(e+1),i=0;i<e;++i)for(d=0;d<n;++d)f=(p=i*(n+1)+d)+n+1,v.push(u+p+1,u+f,u+p),v.push(u+p+1,u+f+1,u+f)}else{if(u=(s+1)*(n+1),0<e)for(r=0;r<n;r++)f=r/n*2*Math.PI,o=-i/2,l=1-((a=Math.sin(f))+1)/2,c=((h=Math.cos(f))+1)/2,m.push(a*e,o,h*e),_.push(0,-1,0),g.push(l,c),l=(l/=3)*la+ha,c=(c/=3)*la+ha,l+=1/3,y.push(l,c),1<r&&v.push(u,u+r,u+r-1);if(u+=n,0<t)for(r=0;r<n;r++)f=r/n*2*Math.PI,o=i/2,l=1-((a=Math.sin(f))+1)/2,c=((h=Math.cos(f))+1)/2,m.push(a*t,o,h*t),_.push(0,1,0),g.push(l,c),l=(l/=3)*la+ha,c=(c/=3)*la+ha,l+=2/3,y.push(l,c),1<r&&v.push(u,u+r-1,u+r)}return{positions:m,normals:_,uvs:g,uvs1:y,indices:v}},te.createCylinder=function(e,t){var i=void 0!==(i=t&&(t.radius||t.baseRadius))?i:.5,s=!(!t||void 0===t.calculateTangents)&&t.calculateTangents;i=te._createConeData(i,i,t&&void 0!==t.height?t.height:1,t&&void 0!==t.heightSegments?t.heightSegments:5,t&&void 0!==t.capSegments?t.capSegments:20,!1);return s&&(i.tangents=te.calculateTangents(i.positions,i.normals,i.uvs,i.indices)),te.createMesh(e,i.positions,i)},te.createCapsule=function(e,t){var i=t&&void 0!==t.radius?t.radius:.3,s=!(!t||void 0===t.calculateTangents)&&t.calculateTangents;i=te._createConeData(i,i,(t&&void 0!==t.height?t.height:1)-2*i,t&&void 0!==t.heightSegments?t.heightSegments:1,t&&void 0!==t.sides?t.sides:20,!0);return s&&(i.tangents=te.calculateTangents(i.positions,i.normals,i.uvs,i.indices)),te.createMesh(e,i.positions,i)},te.createCone=function(e,t){var i=!(!t||void 0===t.calculateTangents)&&t.calculateTangents,s=te._createConeData(t&&void 0!==t.baseRadius?t.baseRadius:.5,t&&void 0!==t.peakRadius?t.peakRadius:0,t&&void 0!==t.height?t.height:1,t&&void 0!==t.heightSegments?t.heightSegments:5,t&&void 0!==t.capSegments?t.capSegments:18,!1);return i&&(s.tangents=te.calculateTangents(s.positions,s.normals,s.uvs,s.indices)),te.createMesh(e,s.positions,s)},te.createSphere=function(e,t){var i,s,n,a,r,o,h,l,c,d=t&&void 0!==t.radius?t.radius:.5,u=t&&void 0!==t.latitudeBands?t.latitudeBands:16,p=t&&void 0!==t.longitudeBands?t.longitudeBands:16,f=!(!t||void 0===t.calculateTangents)&&t.calculateTangents,m=[],_=[],g=[],y=[];for(s=0;s<=u;s++)for(i=s*Math.PI/u,n=Math.sin(i),a=Math.cos(i),i=0;i<=p;i++)r=2*i*Math.PI/p-Math.PI/2,o=Math.sin(r),r=Math.cos(r),r*=n,h=a,o*=n,l=1-i/p,c=1-s/u,m.push(r*d,h*d,o*d),_.push(r,h,o),g.push(l,c);for(s=0;s<u;++s)for(i=0;i<p;++i)n=(d=s*(p+1)+i)+p+1,y.push(d+1,n,d),y.push(d+1,n+1,n);return u={normals:_,uvs:g,uvs1:g,indices:y},f&&(u.tangents=te.calculateTangents(m,_,g,y)),te.createMesh(e,m,u)},te.createPlane=function(e,t){var i,s,n,a,r,o,h=t&&void 0!==t.halfExtents?t.halfExtents:new te.Vec2(.5,.5),l=t&&void 0!==t.widthSegments?t.widthSegments:5,c=t&&void 0!==t.lengthSegments?t.lengthSegments:5,d=!(!t||void 0===t.calculateTangents)&&t.calculateTangents,u=[],p=[],f=[],m=[],_=0;for(i=0;i<=l;i++)for(s=0;s<=c;s++)n=-h.x+2*h.x*i/l,a=-(-h.y+2*h.y*s/c),r=i/l,o=s/c,u.push(n,0,a),p.push(0,1,0),f.push(r,o),i<l&&s<c&&(m.push(_+c+1,_+1,_),m.push(_+c+1,_+c+2,_+1)),_++;return h={normals:p,uvs:f,uvs1:f,indices:m},d&&(h.tangents=te.calculateTangents(u,p,f,m)),te.createMesh(e,u,h)},te.createBox=function(e,t){var i=t&&void 0!==t.halfExtents?t.halfExtents:new te.Vec3(.5,.5,.5),s=t&&void 0!==t.widthSegments?t.widthSegments:1,n=t&&void 0!==t.lengthSegments?t.lengthSegments:1,a=t&&void 0!==t.heightSegments?t.heightSegments:1,r=!(!t||void 0===t.calculateTangents)&&t.calculateTangents,l=[new te.Vec3(-i.x,-i.y,i.z),new te.Vec3(i.x,-i.y,i.z),new te.Vec3(i.x,i.y,i.z),new te.Vec3(-i.x,i.y,i.z),new te.Vec3(i.x,-i.y,-i.z),new te.Vec3(-i.x,-i.y,-i.z),new te.Vec3(-i.x,i.y,-i.z),new te.Vec3(i.x,i.y,-i.z)],c=[[0,1,3],[4,5,7],[3,2,6],[1,0,4],[1,4,2],[5,0,6]],d=[[0,0,1],[0,0,-1],[0,1,0],[0,-1,0],[1,0,0],[-1,0,0]],u=[],p=[],f=[],m=[],_=[],g=0;return(i=function(e,t,i){var s,n,a,r;for(a=0;a<=t;a++)for(r=0;r<=i;r++){s=new te.Vec3,n=new te.Vec3;var o=new te.Vec3,h=new te.Vec3;s.lerp(l[c[e][0]],l[c[e][1]],a/t),n.lerp(l[c[e][0]],l[c[e][2]],r/i),o.sub2(n,l[c[e][0]]),h.add2(s,o),s=a/t,n=r/i,u.push(h.x,h.y,h.z),p.push(d[e][0],d[e][1],d[e][2]),f.push(s,n),s=(s/=3)*la+ha,n=(n/=3)*la+ha,s+=e%3/3,n+=Math.floor(e/3)/3,m.push(s,n),a<t&&r<i&&(_.push(g+i+1,g+1,g),_.push(g+i+1,g+i+2,g+1)),g++}})(0,s,a),i(1,s,a),i(2,s,n),i(3,s,n),i(4,n,a),i(5,n,a),s={normals:p,uvs:f,uvs1:m,indices:_},r&&(s.tangents=te.calculateTangents(u,p,f,_)),te.createMesh(e,u,s)},te.getDefaultMaterial=function(){return te.Application.getApplication().scene.defaultMaterial},Object.assign(te,function(){function i(e,t){return e.priority-t.priority}function s(e,t){return t.key-e.key}var n,a,r,o,h=[null,function(e,t){return e.drawOrder-t.drawOrder},function(e,t){return n=e._key[te.SORTKEY_FORWARD],a=t._key[te.SORTKEY_FORWARD],n===a&&e.mesh&&t.mesh?t.mesh.id-e.mesh.id:a-n},function(e,t){return t.zdist-e.zdist},function(e,t){return e.zdist-t.zdist}],t=0,l=function(){this.opaqueMeshInstances=[],this.transparentMeshInstances=[],this.shadowCasters=[],this.visibleOpaque=[],this.visibleTransparent=[]};l.prototype.clearVisibleLists=function(e){this.visibleOpaque[e]&&(this.visibleOpaque[e].length=0,this.visibleOpaque[e].list.length=0),this.visibleTransparent[e]&&(this.visibleTransparent[e].length=0,this.visibleTransparent[e].list.length=0)};var e=function(e){void 0!==(e=e||{}).id?(this.id=e.id,t=Math.max(this.id+1,t)):this.id=t++,this.name=e.name,this._refCounter=(this._enabled=void 0===e.enabled||e.enabled)?1:0,this.opaqueSortMode=void 0===e.opaqueSortMode?te.SORTMODE_MATERIALMESH:e.opaqueSortMode,this.transparentSortMode=void 0===e.transparentSortMode?te.SORTMODE_BACK2FRONT:e.transparentSortMode,this.renderTarget=e.renderTarget,this.shaderPass=void 0===e.shaderPass?te.SHADER_FORWARD:e.shaderPass,this.passThrough=void 0!==e.passThrough&&e.passThrough,this.overrideClear=void 0!==e.overrideClear&&e.overrideClear,this._clearColor=new te.Color(0,0,0,1),e.clearColor&&this._clearColor.copy(e.clearColor),this._clearColorBuffer=void 0!==e.clearColorBuffer&&e.clearColorBuffer,this._clearDepthBuffer=void 0!==e.clearDepthBuffer&&e.clearDepthBuffer,this._clearStencilBuffer=void 0!==e.clearStencilBuffer&&e.clearStencilBuffer,this._clearOptions={color:[this._clearColor.r,this._clearColor.g,this._clearColor.b,this._clearColor.a],depth:1,stencil:0,flags:(this._clearColorBuffer?te.CLEARFLAG_COLOR:0)|(this._clearDepthBuffer?te.CLEARFLAG_DEPTH:0)|(this._clearStencilBuffer?te.CLEARFLAG_STENCIL:0)},this.onPreCull=e.onPreCull,this.onPreRender=e.onPreRender,this.onPreRenderOpaque=e.onPreRenderOpaque,this.onPreRenderTransparent=e.onPreRenderTransparent,this.onPostCull=e.onPostCull,this.onPostRender=e.onPostRender,this.onPostRenderOpaque=e.onPostRenderOpaque,this.onPostRenderTransparent=e.onPostRenderTransparent,this.onDrawCall=e.onDrawCall,this.onEnable=e.onEnable,this.onDisable=e.onDisable,this._enabled&&this.onEnable&&this.onEnable(),this.instances=(this.layerReference=e.layerReference)?e.layerReference.instances:new l,this.cullingMask=e.cullingMask?e.cullingMask:4294967295,this.opaqueMeshInstances=this.instances.opaqueMeshInstances,this.transparentMeshInstances=this.instances.transparentMeshInstances,this.shadowCasters=this.instances.shadowCasters,this.customCalculateSortValues=this.customSortCallback=null,this._lightComponents=[],this._lights=[],this._sortedLights=[[],[],[]],this.cameras=[],this._dirtyCameras=this._dirtyLights=this._dirty=!1,this._staticLightHash=this._lightHash=this._cameraHash=0,this._needsStaticPrepare=!0,this._staticPrepareDone=!1,this._shaderVersion=-1,this._version=0,this._lightCube=null};return Object.defineProperty(e.prototype,"enabled",{get:function(){return this._enabled},set:function(e){e!==this._enabled&&((this._enabled=e)?(this.incrementCounter(),this.onEnable&&this.onEnable()):(this.decrementCounter(),this.onDisable&&this.onDisable()))}}),Object.defineProperty(e.prototype,"clearColor",{get:function(){return this._clearColor},set:function(e){this._clearColor.copy(e)}}),e.prototype._updateClearFlags=function(){var e=0;this._clearColorBuffer&&(e|=te.CLEARFLAG_COLOR),this._clearDepthBuffer&&(e|=te.CLEARFLAG_DEPTH),this._clearStencilBuffer&&(e|=te.CLEARFLAG_STENCIL),this._clearOptions.flags=e},Object.defineProperty(e.prototype,"clearColorBuffer",{get:function(){return this._clearColorBuffer},set:function(e){this._clearColorBuffer=e,this._updateClearFlags()}}),Object.defineProperty(e.prototype,"clearDepthBuffer",{get:function(){return this._clearDepthBuffer},set:function(e){this._clearDepthBuffer=e,this._updateClearFlags()}}),Object.defineProperty(e.prototype,"clearStencilBuffer",{get:function(){return this._clearStencilBuffer},set:function(e){this._clearStencilBuffer=e,this._updateClearFlags()}}),e.prototype.incrementCounter=function(){0===this._refCounter&&(this._enabled=!0,this.onEnable)&&this.onEnable(),this._refCounter++},e.prototype.decrementCounter=function(){if(1===this._refCounter)this._enabled=!1,this.onDisable&&this.onDisable();else if(0===this._refCounter)return;this._refCounter--},e.prototype.addMeshInstances=function(e,t){for(var i,s,n,a=this._shaderVersion,r=this.shadowCasters,o=0;o<e.length;o++)(s=(n=(i=e[o]).material).blendType===te.BLEND_NONE?this.opaqueMeshInstances:this.transparentMeshInstances).indexOf(i)<0&&s.push(i),!t&&i.castShadow&&r.indexOf(i)<0&&r.push(i),!this.passThrough&&0<=a&&n._shaderVersion!==a&&(n.updateShader!==te.Material.prototype.updateShader&&(n.clearVariants(),n.shader=null),n._shaderVersion=a);this.passThrough||(this._dirty=!0)},e.prototype.removeMeshInstances=function(e,t){var i,s,n,a,r,o,h,l=this.opaqueMeshInstances,c=this.transparentMeshInstances,d=this.shadowCasters;for(i=0;i<e.length;i++){for(n=e[i],a=-1,r=0,o=l.length,s=0;s<o;s++){if((h=l[s])===n){a=s,r=1;break}if(h._staticSource===n)a<0&&(a=s),r++;else if(0<=a)break}for(0<=a&&l.splice(a,r),a=-1,r=0,o=c.length,s=0;s<o;s++){if((h=c[s])===n){a=s,r=1;break}if(h._staticSource===n)a<0&&(a=s),r++;else if(0<=a)break}0<=a&&c.splice(a,r),t||0<=(s=d.indexOf(n))&&d.splice(s,1)}this._dirty=!0},e.prototype.clearMeshInstances=function(e){(0!==this.opaqueMeshInstances.length||0!==this.transparentMeshInstances.length||!e&&0!==this.shadowCasters.length)&&(this.opaqueMeshInstances.length=0,this.transparentMeshInstances.length=0,e||(this.shadowCasters.length=0),this.passThrough||(this._dirty=!0))},e.prototype.addLight=function(e){0<=this._lightComponents.indexOf(e)||(this._lightComponents.push(e),this._lights.push(e.light),this._dirtyLights=!0,this._generateLightHash())},e.prototype.removeLight=function(e){var t=this._lightComponents.indexOf(e);t<0||(this._lightComponents.splice(t,1),t=this._lights.indexOf(e.light),this._lights.splice(t,1),this._dirtyLights=!0,this._generateLightHash())},e.prototype.clearLights=function(){this._lightComponents.length=0,this._lights.length=0,this._dirtyLights=!0},e.prototype.addShadowCasters=function(e){for(var t,i=this.shadowCasters,s=0;s<e.length;s++)(t=e[s]).castShadow&&i.indexOf(t)<0&&i.push(t);this._dirtyLights=!0},e.prototype.removeShadowCasters=function(e){for(var t,i=this.shadowCasters,s=0;s<e.length;s++)0<=(t=i.indexOf(e[s]))&&i.splice(t,1);this._dirtyLights=!0},e.prototype._generateLightHash=function(){if(0<this._lights.length){this._lights.sort(s);for(var e="",t="",i=0;i<this._lights.length;i++)this._lights[i].isStatic?t+=this._lights[i].key:e+=this._lights[i].key;this._lightHash=0===e.length?0:te.hashCode(e),this._staticLightHash=0===t.length?0:te.hashCode(t)}else this._staticLightHash=this._lightHash=0},e.prototype._generateCameraHash=function(){if(1<this.cameras.length){this.cameras.sort(i);for(var e="",t=0;t<this.cameras.length;t++)e+=this.cameras[t].entity.getGuid();this._cameraHash=te.hashCode(e)}else this._cameraHash=0;this._dirtyCameras=!0},e.prototype.addCamera=function(e){0<=this.cameras.indexOf(e)||(this.cameras.push(e),this._generateCameraHash())},e.prototype.removeCamera=function(e){(e=this.cameras.indexOf(e))<0||(this.cameras.splice(e,1),this._generateCameraHash(),this.instances.clearVisibleLists(e))},e.prototype.clearCameras=function(){this._cameraHash=this.cameras.length=0,this._dirtyCameras=!0},e.prototype._sortCameras=function(){this._generateCameraHash()},e.prototype._calculateSortDistances=function(e,t,i,s){var n,a,r,o,h;for(n=0;n<t;n++)(a=e[n]).command||a.layer<=te.LAYER_FX||(o=(r=a.aabb.center).x-i.x,h=r.y-i.y,r=r.z-i.z,a.zdist=o*s.x+h*s.y+r*s.z)},e.prototype._sortVisible=function(e,t,i){var s=this.instances,n=e?this.transparentSortMode:this.opaqueSortMode;n!==te.SORTMODE_NONE&&(e=e?s.visibleTransparent[i]:s.visibleOpaque[i],n===te.SORTMODE_CUSTOM?(r=t.getPosition(),o=t.forward,this.customCalculateSortValues&&this.customCalculateSortValues(e.list,e.length,r,o),e.list.length!==e.length&&(e.list.length=e.length),this.customSortCallback&&e.list.sort(this.customSortCallback)):(n!==te.SORTMODE_BACK2FRONT&&n!==te.SORTMODE_FRONT2BACK||(r=t.getPosition(),o=t.forward,this._calculateSortDistances(e.list,e.length,r,o)),e.list.length!==e.length&&(e.list.length=e.length),e.list.sort(h[n])))},{Layer:e,InstanceList:l,VisibleInstanceList:function(){this.list=[],this.length=0,this.done=!1}}}()),Object.assign(te,((Rt=function(){this.layerList=[],this.subLayerList=[],this.subLayerEnabled=[],this._opaqueOrder={},this._transparentOrder={},this._dirtyCameras=this._dirtyLights=this._dirtyBlend=this._dirty=!1,this._meshInstances=[],this._lights=[],this.cameras=[],this._sortedLights=[[],[],[]],this._lightShadowCasters=[],this._globalLightCameras=[],this._globalLightCameraIds=[],this._renderedRt=[],this._renderedByCam=[],this._renderedLayer=[],this._renderList=[],this._renderListCamera=[],te.events.attach(this)}).prototype._sortLights=function(e){var t,i=e._lights;e._sortedLights[te.LIGHTTYPE_DIRECTIONAL].length=0,e._sortedLights[te.LIGHTTYPE_POINT].length=0;for(var s=e._sortedLights[te.LIGHTTYPE_SPOT].length=0;s<i.length;s++)(t=i[s])._enabled&&e._sortedLights[t._type].push(t)},Rt.prototype._update=function(){var e,t,i,s,n,a=this.layerList.length,r=0;if(!this._dirty||!this._dirtyLights||!this._dirtyCameras)for(e=0;e<a;e++)(s=this.layerList[e])._dirty&&(this._dirty=!0),s._dirtyLights&&(this._dirtyLights=!0),s._dirtyCameras&&(this._dirtyCameras=!0);if(this._dirty){for(r|=te.COMPUPDATED_INSTANCES,e=this._meshInstances.length=0;e<a;e++)if(!(s=this.layerList[e]).passThrough){for(n=s.opaqueMeshInstances,t=0;t<n.length;t++)i=n[t],this._meshInstances.indexOf(i)<0&&(this._meshInstances.push(i),i.material&&i.material._dirtyBlend&&(this._dirtyBlend=!0,i.material._dirtyBlend=!1));for(n=s.transparentMeshInstances,t=0;t<n.length;t++)i=n[t],this._meshInstances.indexOf(i)<0&&(this._meshInstances.push(i),i.material&&i.material._dirtyBlend&&(this._dirtyBlend=!0,i.material._dirtyBlend=!1))}for(e=0;e<a;e++)this.layerList[e]._dirty=!1,this.layerList[e]._version++}if(this._dirtyBlend){var o,h;for(r|=te.COMPUPDATED_BLEND,e=0;e<a;e++)if(!(s=this.layerList[e]).passThrough){for(n=s.opaqueMeshInstances,i=s.transparentMeshInstances,o=[],h=[],t=0;t<n.length;t++)n[t].material&&n[t].material.blendType!==te.BLEND_NONE?h.push(n[t]):o.push(n[t]);for(t=0;t<i.length;t++)i[t].material&&i[t].material.blendType!==te.BLEND_NONE?h.push(i[t]):o.push(i[t]);for(s.opaqueMeshInstances.length=o.length,t=0;t<o.length;t++)s.opaqueMeshInstances[t]=o[t];for(s.transparentMeshInstances.length=h.length,t=0;t<h.length;t++)s.transparentMeshInstances[t]=h[t]}this._dirtyBlend=!1}if(this._dirty=!1,this._dirtyLights)for(r|=te.COMPUPDATED_LIGHTS,this._lights.length=0,e=this._lightShadowCasters.length=0;e<a;e++)for(n=(s=this.layerList[e])._lights,t=0;t<n.length;t++)o=n[t],(i=this._lights.indexOf(o))<0&&(this._lights.push(o),i=this._lights.length-1),(o=this._lightShadowCasters[i])||(this._lightShadowCasters[i]=[]);if(this._dirtyLights)for(this._sortLights(this),this._dirtyLights=!1,e=0;e<a;e++)s=this.layerList[e],this._sortLights(s),s._dirtyLights=!1;if(r)for(e=0;e<a;e++)for(n=(s=this.layerList[e])._lights,t=0;t<n.length;t++){for(o=n[t],i=this._lights.indexOf(o),o=this._lightShadowCasters[i],h=s.shadowCasters,i=0;i<o.length;)this._meshInstances.indexOf(o[i])<0?(o[i]=o[o.length-1],--o.length):i++;for(i=0;i<h.length;i++)o.indexOf(h[i])<0&&o.push(h[i])}if(r&te.COMPUPDATED_LIGHTS||this._dirtyCameras)for(this._globalLightCameras.length=0,n=this._sortedLights[te.LIGHTTYPE_DIRECTIONAL],t=0;t<n.length;t++)for(o=n[t],this._globalLightCameras[t]=[],e=0;e<a;e++)if(!((s=this.layerList[e])._sortedLights[te.LIGHTTYPE_DIRECTIONAL].indexOf(o)<0))for(i=0;i<s.cameras.length;i++)0<=this._globalLightCameras[t].indexOf(s.cameras[i])||this._globalLightCameras[t].push(s.cameras[i]);if(this._dirtyCameras){for(r|=te.COMPUPDATED_CAMERAS,e=this.cameras.length=0;e<a;e++)for(s=this.layerList[e],t=0;t<s.cameras.length;t++)n=s.cameras[t],(i=this.cameras.indexOf(n))<0&&this.cameras.push(n);for(this._renderList.length=0,e=i=this._renderListCamera.length=0;e<a;e++)if(i)i--;else if(0!==(s=this.layerList[e]).cameras.length||s.isPostEffect)if(0===(o=s._cameraHash))this._renderList.push(e),this._renderListCamera.push(0);else{for(t=e+(n=1);t<a;t++){if(o!==(h=this.layerList[t]._cameraHash)){n=t-e-1;break}t===a-1&&(n=t-e)}if(1===n)for(o=0;o<s.cameras.length;o++)this._renderList.push(e),this._renderListCamera.push(o);else{for(o=0;o<s.cameras.length;o++)for(t=0;t<=n;t++)this._renderList.push(e+t),this._renderListCamera.push(o);i=n}}for(this._dirtyCameras=!1,e=0;e<a;e++)this.layerList[e]._dirtyCameras=!1}if(r&te.COMPUPDATED_LIGHTS||r&te.COMPUPDATED_CAMERAS)for(t=this._globalLightCameraIds.length=0;t<this._globalLightCameras.length;t++){for(n=[],e=0;e<this._globalLightCameras[t].length;e++)(i=this.cameras.indexOf(this._globalLightCameras[t][e]))<0||n.push(i);this._globalLightCameraIds.push(n)}return r},Rt.prototype._isLayerAdded=function(e){return 0<=this.layerList.indexOf(e)},Rt.prototype._isSublayerAdded=function(e,t){for(var i=0;i<this.layerList.length;i++)if(this.layerList[i]===e&&this.subLayerList[i]===t)return!0;return!1},Rt.prototype.push=function(e){this._isLayerAdded(e)||(this.layerList.push(e),this.layerList.push(e),this._opaqueOrder[e.id]=this.subLayerList.push(!1)-1,this._transparentOrder[e.id]=this.subLayerList.push(!0)-1,this.subLayerEnabled.push(!0),this.subLayerEnabled.push(!0),this._dirtyCameras=this._dirtyLights=this._dirty=!0,this.fire("add",e))},Rt.prototype.insert=function(e,t){if(!this._isLayerAdded(e)){this.layerList.splice(t,0,e,e),this.subLayerList.splice(t,0,!1,!0);var i=this.layerList.length;this._updateOpaqueOrder(t,i-1),this._updateTransparentOrder(t,i-1),this.subLayerEnabled.splice(t,0,!0,!0),this._dirtyCameras=this._dirtyLights=this._dirty=!0,this.fire("add",e)}},Rt.prototype.remove=function(e){var t=this.layerList.indexOf(e);for(delete this._opaqueOrder[t],delete this._transparentOrder[t];0<=t;)this.layerList.splice(t,1),this.subLayerList.splice(t,1),this.subLayerEnabled.splice(t,1),t=this.layerList.indexOf(e),this._dirtyCameras=this._dirtyLights=this._dirty=!0,this.fire("remove",e);e=this.layerList.length,this._updateOpaqueOrder(0,e-1),this._updateTransparentOrder(0,e-1)},Rt.prototype.pushOpaque=function(e){this._isSublayerAdded(e,!1)||(this.layerList.push(e),this._opaqueOrder[e.id]=this.subLayerList.push(!1)-1,this.subLayerEnabled.push(!0),this._dirtyCameras=this._dirtyLights=this._dirty=!0,this.fire("add",e))},Rt.prototype.insertOpaque=function(e,t){this._isSublayerAdded(e,!1)||(this.layerList.splice(t,0,e),this.subLayerList.splice(t,0,!1),this._updateOpaqueOrder(t,this.subLayerList.length-1),this.subLayerEnabled.splice(t,0,!0),this._dirtyCameras=this._dirtyLights=this._dirty=!0,this.fire("add",e))},Rt.prototype.removeOpaque=function(e){for(var t=0,i=this.layerList.length;t<i;t++)if(this.layerList[t]===e&&!this.subLayerList[t]){this.layerList.splice(t,1),this.subLayerList.splice(t,1),i--,this._updateOpaqueOrder(t,i-1),this.subLayerEnabled.splice(t,1),this._dirtyCameras=this._dirtyLights=this._dirty=!0,this.layerList.indexOf(e)<0&&this.fire("remove",e);break}},Rt.prototype.pushTransparent=function(e){this._isSublayerAdded(e,!0)||(this.layerList.push(e),this._transparentOrder[e.id]=this.subLayerList.push(!0)-1,this.subLayerEnabled.push(!0),this._dirtyCameras=this._dirtyLights=this._dirty=!0,this.fire("add",e))},Rt.prototype.insertTransparent=function(e,t){this._isSublayerAdded(e,!0)||(this.layerList.splice(t,0,e),this.subLayerList.splice(t,0,!0),this._updateTransparentOrder(t,this.subLayerList.length-1),this.subLayerEnabled.splice(t,0,!0),this._dirtyCameras=this._dirtyLights=this._dirty=!0,this.fire("add",e))},Rt.prototype.removeTransparent=function(e){for(var t=0,i=this.layerList.length;t<i;t++)if(this.layerList[t]===e&&this.subLayerList[t]){this.layerList.splice(t,1),this.subLayerList.splice(t,1),i--,this._updateTransparentOrder(t,i-1),this.subLayerEnabled.splice(t,1),this._dirtyCameras=this._dirtyLights=this._dirty=!0,this.layerList.indexOf(e)<0&&this.fire("remove",e);break}},Rt.prototype._getSublayerIndex=function(e,t){var i=this.layerList.indexOf(e);return i<0||this.subLayerList[i]!==t&&((i=this.layerList.indexOf(e,i+1))<0||this.subLayerList[i]!==t)?-1:i},Rt.prototype.getOpaqueIndex=function(e){return this._getSublayerIndex(e,!1)},Rt.prototype.getTransparentIndex=function(e){return this._getSublayerIndex(e,!0)},Rt.prototype.getLayerById=function(e){for(var t=0;t<this.layerList.length;t++)if(this.layerList[t].id===e)return this.layerList[t];return null},Rt.prototype.getLayerByName=function(e){for(var t=0;t<this.layerList.length;t++)if(this.layerList[t].name===e)return this.layerList[t];return null},Rt.prototype._updateOpaqueOrder=function(e,t){for(var i=e;i<=t;i++)!1===this.subLayerList[i]&&(this._opaqueOrder[this.layerList[i].id]=i)},Rt.prototype._updateTransparentOrder=function(e,t){for(var i=e;i<=t;i++)!0===this.subLayerList[i]&&(this._transparentOrder[this.layerList[i].id]=i)},Rt.prototype._sortLayersDescending=function(e,t,i){var s,n,a,r=-1,o=-1;for(s=0,n=e.length;s<n;s++)a=e[s],i.hasOwnProperty(a)&&(r=Math.max(r,i[a]));for(s=0,n=t.length;s<n;s++)a=t[s],i.hasOwnProperty(a)&&(o=Math.max(o,i[a]));return-1===r&&-1!==o?1:-1===o&&-1!==r?-1:o-r},Rt.prototype.sortTransparentLayers=function(e,t){return this._sortLayersDescending(e,t,this._transparentOrder)},Rt.prototype.sortOpaqueLayers=function(e,t){return this._sortLayersDescending(e,t,this._opaqueOrder)},{LayerComposition:Rt})),Object.assign(te,function(){te.SPRITE_RENDERMODE_SIMPLE=0,te.SPRITE_RENDERMODE_SLICED=1,te.SPRITE_RENDERMODE_TILED=2;var l=[0,0,1,0,0,1,0,0,1,0,0,1],c=[0,1,3,2,3,1],e=function(e,t){this._device=e,this._pixelsPerUnit=t&&void 0!==t.pixelsPerUnit?t.pixelsPerUnit:1,this._renderMode=t&&void 0!==t.renderMode?t.renderMode:te.SPRITE_RENDERMODE_SIMPLE,this._atlas=t&&void 0!==t.atlas?t.atlas:null,this._frameKeys=t&&void 0!==t.frameKeys?t.frameKeys:null,this._meshes=[],this._meshesDirty=this._updatingProperties=!1,te.events.attach(this),this._atlas&&this._frameKeys&&this._createMeshes()};return e.prototype._createMeshes=function(){var e,t;for(e=0,t=this._meshes.length;e<t;e++){var i=this._meshes[e];if(i){i.vertexBuffer.destroy();for(var s=0,n=i.indexBuffer.length;s<n;s++)i.indexBuffer[s].destroy()}}for(t=this._frameKeys.length,this._meshes=Array(t),i=this.renderMode===te.SPRITE_RENDERMODE_SLICED||this._renderMode===te.SPRITE_RENDERMODE_TILED?this._create9SliceMesh:this._createSimpleMesh,e=0;e<t;e++)s=this._atlas.frames[this._frameKeys[e]],this._meshes[e]=s?i.call(this,s):null;this.fire("set:meshes")},e.prototype._createSimpleMesh=function(e){var t=e.rect,i=this._atlas.texture.width,s=this._atlas.texture.height,n=t.z/this._pixelsPerUnit,a=t.w/this._pixelsPerUnit,r=e.pivot.x;e=e.pivot.y;var o=t.x/i,h=t.y/s;i=(t.x+t.z)/i,t=(t.y+t.w)/s;return te.createMesh(this._device,[-r*n,-e*a,0,(1-r)*n,-e*a,0,(1-r)*n,(1-e)*a,0,-r*n,(1-e)*a,0],{uvs:[o,h,i,h,i,t,o,t],normals:l,indices:c})},e.prototype._create9SliceMesh=function(){var e,t,i,s,n,a,r=te.Vec2.ONE,o=[],h=[],l=[],c=[],d=0;for(e=0;e<=3;e++)for(n=0===e||3===e?0:1,t=0;t<=3;t++)i=-r.x+2*r.x*(e<=1?0:3)/3,s=-(-r.y+2*r.y*(t<=1?0:3)/3),a=0===t||3===t?0:1,o.push(-i,0,s),h.push(0,1,0),l.push(n,a),e<3&&t<3&&(c.push(d+3+1,d+1,d),c.push(d+3+1,d+3+2,d+1)),d++;return te.createMesh(this._device,o,{normals:h,uvs:l,indices:c})},e.prototype._onSetFrames=function(e){this._updatingProperties?this._meshesDirty=!0:this._createMeshes()},e.prototype._onFrameChanged=function(e,t){var i=this._frameKeys.indexOf(e);i<0||(t?this.renderMode===te.SPRITE_RENDERMODE_SIMPLE&&(this._meshes[i]=this._createSimpleMesh(t)):this._meshes[i]=null,this.fire("set:meshes"))},e.prototype._onFrameRemoved=function(e){(e=this._frameKeys.indexOf(e))<0||(this._meshes[e]=null,this.fire("set:meshes"))},e.prototype.startUpdate=function(){this._updatingProperties=!0,this._meshesDirty=!1},e.prototype.endUpdate=function(){this._updatingProperties=!1,this._meshesDirty&&this._atlas&&this._frameKeys&&this._createMeshes(),this._meshesDirty=!1},e.prototype.destroy=function(){var e,t;for(e=0,t=this._meshes.length;e<t;e++){var i=this._meshes[e];if(i){i.vertexBuffer.destroy();for(var s=0,n=i.indexBuffer.length;s<n;s++)i.indexBuffer[s].destroy()}}this._meshes.length=0},Object.defineProperty(e.prototype,"frameKeys",{get:function(){return this._frameKeys},set:function(e){this._frameKeys=e,this._atlas&&this._frameKeys&&(this._updatingProperties?this._meshesDirty=!0:this._createMeshes()),this.fire("set:frameKeys",e)}}),Object.defineProperty(e.prototype,"atlas",{get:function(){return this._atlas},set:function(e){e!==this._atlas&&(this._atlas&&(this._atlas.off("set:frames",this._onSetFrames,this),this._atlas.off("set:frame",this._onFrameChanged,this),this._atlas.off("remove:frame",this._onFrameRemoved,this)),(this._atlas=e)&&this._frameKeys&&(this._atlas.on("set:frames",this._onSetFrames,this),this._atlas.on("set:frame",this._onFrameChanged,this),this._atlas.on("remove:frame",this._onFrameRemoved,this),this._updatingProperties?this._meshesDirty=!0:this._createMeshes()),this.fire("set:atlas",e))}}),Object.defineProperty(e.prototype,"pixelsPerUnit",{get:function(){return this._pixelsPerUnit},set:function(e){this._pixelsPerUnit!==e&&(this._pixelsPerUnit=e,this.fire("set:pixelsPerUnit",e),this._atlas&&this._frameKeys&&this.renderMode===te.SPRITE_RENDERMODE_SIMPLE&&(this._updatingProperties?this._meshesDirty=!0:this._createMeshes()))}}),Object.defineProperty(e.prototype,"renderMode",{get:function(){return this._renderMode},set:function(e){if(this._renderMode!==e){var t=this._renderMode;this._renderMode=e,this.fire("set:renderMode",e),(t===te.SPRITE_RENDERMODE_SIMPLE||e===te.SPRITE_RENDERMODE_SIMPLE)&&this._atlas&&this._frameKeys&&(this._updatingProperties?this._meshesDirty=!0:this._createMeshes())}}}),Object.defineProperty(e.prototype,"meshes",{get:function(){return this._meshes}}),{Sprite:e}}()),Object.assign(te,function(){var e=function(){this._index=[],this._values=[]};e.prototype.runSync=function(){for(var e=0,t=this._values.length;e<t;e++)this._values[e].syncHierarchy();this._values.length=0,this._index.length=0},e.prototype.erase=function(e){0<=(e=this._values.indexOf(e))&&(this._index.splice(e,1),this._values.splice(e,1))};var a=function(e,t,i,s){if(t===i)return t;var n=Math.floor((t+i)/2);return e[n]>s?a(e,t,n,s):e[n]<s?a(e,n+1,i,s):n};return e.prototype.push=function(e,t){var i=a(this._index,0,this._index.length,e);this._values.splice(i,0,t),this._index.splice(i,0,e)},{SyncQueue:e}}()),Object.assign(te,((Lt=function(){this._frames=this._texture=null,te.events.attach(this)}).prototype.setFrame=function(e,t){var i=this._frames[e];i?(i.rect.copy(t.rect),i.pivot.copy(t.pivot),i.border.copy(t.border)):(i={rect:t.rect.clone(),pivot:t.pivot.clone(),border:t.border.clone()},this._frames[e]=i),this.fire("set:frame",e.toString(),i)},Lt.prototype.removeFrame=function(e){var t=this._frames[e];t&&(delete this._frames[e],this.fire("remove:frame",e.toString(),t))},Lt.prototype.destroy=function(){this._texture&&this._texture.destroy()},Object.defineProperty(Lt.prototype,"texture",{get:function(){return this._texture},set:function(e){this._texture=e,this.fire("set:texture",e)}}),Object.defineProperty(Lt.prototype,"frames",{get:function(){return this._frames},set:function(e){this._frames=e,this.fire("set:frames",e)}}),{TextureAtlas:Lt})),Object.assign(te,((Dt=function(e){this.func=void 0===e.func?te.FUNC_ALWAYS:e.func,this.ref=e.ref||0,this.readMask=void 0===e.readMask?255:e.readMask,this.writeMask=void 0===e.writeMask?255:e.writeMask,this.fail=e.fail||te.STENCILOP_KEEP,this.zfail=e.zfail||te.STENCILOP_KEEP,this.zpass=e.zpass||te.STENCILOP_KEEP}).prototype.clone=function(){return new te.StencilParameters({func:this.func,ref:this.ref,readMask:this.readMask,writeMask:this.writeMask,fail:this.fail,zfail:this.zfail,zpass:this.zpass})},{StencilParameters:Dt})),Object.assign(te,((Nt=function(){this.name="",this.duration=0,this._nodes=[],this._nodeDict={}}).prototype.getDuration=function(){return this.duration},Nt.prototype.getName=function(){return this.name},Nt.prototype.getNode=function(e){return this._nodeDict[e]},Object.defineProperty(Nt.prototype,"nodes",{get:function(){return this._nodes}}),Nt.prototype.getNodes=function(){return this._nodes},Nt.prototype.setDuration=function(e){this.duration=e},Nt.prototype.setName=function(e){this.name=e},Nt.prototype.addNode=function(e){this._nodes.push(e),this._nodeDict[e._name]=e},{Animation:Nt,Key:function(e,t,i,s){this.time=e,this.position=t,this.rotation=i,this.scale=s},Node:function(){this._name="",this._keys=[]}})),Object.assign(te,function(){function n(){this._written=!1,this._name="",this._keyFrames=[],this._quat=new te.Quat,this._pos=new te.Vec3,this._scale=new te.Vec3,this._targetNode=null}Object.assign(n.prototype,{getTarget:function(){return this._targetNode},setTarget:function(e){this._targetNode=e}});var e=function(e){this._animation=null,this._time=0,this.looping=!0,this._interpolatedKeys=[],this._interpolatedKeyDict={},this._currKeyIndices={},this.graph=null;var s=this;!function e(t){var i=new n;for(i._name=t.name,s._interpolatedKeys.push(i),s._interpolatedKeyDict[t.name]=i,i=s._currKeyIndices[t.name]=0;i<t._children.length;i++)e(t._children[i])}(e)};return e.prototype.addTime=function(e){if(null!==this._animation){var t,i,s,n,a,r,o,h=this._animation._nodes;if(t=this._animation.duration,this._time!==t||this.looping){if(this._time+=e,this._time>t)for(this._time=this.looping?0:t,t=0;t<h.length;t++)s=(i=h[t])._name,this._currKeyIndices[s]=0;else if(this._time<0)for(this._time=this.looping?t:0,t=0;t<h.length;t++)s=(i=h[t])._name,this._currKeyIndices[s]=i._keys.length-2;for(e=0<=e?1:-1,t=0;t<h.length;t++)if(s=(i=h[t])._name,i=i._keys,void 0!==(n=this._interpolatedKeyDict[s])){if(o=!1,1!==i.length)for(var l=this._currKeyIndices[s];l<i.length-1&&0<=l;l+=e)if(a=i[l],r=i[l+1],a.time<=this._time&&r.time>=this._time){o=(this._time-a.time)/(r.time-a.time),n._pos.lerp(a.position,r.position,o),n._quat.slerp(a.rotation,r.rotation,o),n._scale.lerp(a.scale,r.scale,o),n._written=!0,this._currKeyIndices[s]=l,o=!0;break}(1===i.length||!o&&0===this._time&&this.looping)&&(n._pos.copy(i[0].position),n._quat.copy(i[0].rotation),n._scale.copy(i[0].scale),n._written=!0)}}}},e.prototype.blend=function(e,t,i){for(var s=this._interpolatedKeys.length,n=0;n<s;n++){var a=e._interpolatedKeys[n],r=t._interpolatedKeys[n],o=this._interpolatedKeys[n];a._written&&r._written?(o._quat.slerp(a._quat,t._interpolatedKeys[n]._quat,i),o._pos.lerp(a._pos,t._interpolatedKeys[n]._pos,i),o._scale.lerp(a._scale,r._scale,i),o._written=!0):a._written?(o._quat.copy(a._quat),o._pos.copy(a._pos),o._scale.copy(a._scale),o._written=!0):r._written&&(o._quat.copy(r._quat),o._pos.copy(r._pos),o._scale.copy(r._scale),o._written=!0)}},Object.defineProperty(e.prototype,"animation",{get:function(){return this._animation},set:function(e){this._animation=e,this.currentTime=0}}),e.prototype.getAnimation=function(){return this._animation},Object.defineProperty(e.prototype,"currentTime",{get:function(){return this._time},set:function(e){this._time=e,e=this._interpolatedKeys.length;for(var t=0;t<e;t++)this._currKeyIndices[this._interpolatedKeys[t]._name]=0;this.addTime(0),this.updateGraph()}}),e.prototype.getCurrentTime=function(){return this._time},e.prototype.setCurrentTime=function(e){this.currentTime=e},Object.defineProperty(e.prototype,"numNodes",{get:function(){return this._interpolatedKeys.length}}),e.prototype.getNumNodes=function(){return this._interpolatedKeys.length},e.prototype.setAnimation=function(e){this.animation=e},e.prototype.setGraph=function(e){var t;if(this.graph=e)for(t=0;t<this._interpolatedKeys.length;t++){var i=e.findByName(this._interpolatedKeys[t]._name);this._interpolatedKeys[t].setTarget(i)}else for(t=0;t<this._interpolatedKeys.length;t++)this._interpolatedKeys[t].setTarget(null)},e.prototype.updateGraph=function(){if(this.graph)for(var e=0;e<this._interpolatedKeys.length;e++){var t=this._interpolatedKeys[e];if(t._written){var i=t.getTarget();i.localPosition.copy(t._pos),i.localRotation.copy(t._quat),i.localScale.copy(t._scale),i._dirtyLocal||i._dirtifyLocal(),t._written=!1}}},e.prototype.setLooping=function(e){this.looping=e},e.prototype.getLooping=function(){return this.looping},{Skeleton:e}}()),Object.assign(te,function(){function t(){return"undefined"!=typeof Audio}function n(){return!("undefined"==typeof AudioContext&&"undefined"==typeof webkitAudioContext)}var e=function(e){if((n()||e.forceWebAudioApi)&&("undefined"!=typeof AudioContext?this.context=new AudioContext:"undefined"!=typeof webkitAudioContext&&(this.context=new webkitAudioContext),this.context)){var i=this.context;if(this.resumeContext=function(){this.context.resume(),window.removeEventListener("mousedown",this.resumeContext),window.removeEventListener("touchend",this.resumeContext)}.bind(this),window.addEventListener("mousedown",this.resumeContext),window.addEventListener("touchend",this.resumeContext),te.platform.ios){var s=function(){var e=i.createBuffer(1,1,44100),t=i.createBufferSource();t.buffer=e,t.connect(i.destination),t.start(0),t.disconnect(),window.removeEventListener("touchend",s)};window.addEventListener("touchend",s)}}t(),this.listener=new te.Listener(this),this._volume=1,this.suspended=!1,te.events.attach(this)};return e.hasAudio=t,e.hasAudioContext=n,Object.assign(e.prototype,{suspend:function(){this.suspended=!0,this.fire("suspend")},resume:function(){this.suspended=!1,this.fire("resume")},destroy:function(){window.removeEventListener("mousedown",this.resumeContext),window.removeEventListener("touchend",this.resumeContext),this.fire("destroy"),this.context&&this.context.close&&(this.context.close(),this.context=null)},getListener:function(){return this.listener},getVolume:function(){return this.volume},setVolume:function(e){this.volume=e},playSound:function(e,t){t=t||{};var i=null;return te.Channel&&(i=new te.Channel(this,e,t)).play(),i},playSound3d:function(e,t,i){i=i||{};var s=null;return te.Channel3d&&((s=new te.Channel3d(this,e,i)).setPosition(t),i.volume&&s.setVolume(i.volume),i.loop&&s.setLoop(i.loop),i.maxDistance&&s.setMaxDistance(i.maxDistance),i.minDistance&&s.setMinDistance(i.minDistance),i.rollOffFactor&&s.setRollOffFactor(i.rollOffFactor),i.distanceModel&&s.setDistanceModel(i.distanceModel),s.play()),s}}),Object.defineProperty(e.prototype,"volume",{get:function(){return this._volume},set:function(e){this._volume=e=te.math.clamp(e,0,1),this.fire("volumechange",e)}}),{SoundManager:te.AudioManager=e}}()),Object.assign(te,(Ft=function(e){e instanceof Audio?this.audio=e:this.buffer=e},Object.defineProperty(Ft.prototype,"duration",{get:function(){var e=0;return this.buffer?e=this.buffer.duration:this.audio&&(e=this.audio.duration),e||0}}),{Sound:Ft})),Object.assign(te,(Bt=function(e){this.position=new te.Vec3,this.velocity=new te.Vec3,this.orientation=new te.Mat4,te.AudioManager.hasAudioContext()&&(this.listener=e.context.listener)},Object.assign(Bt.prototype,{getPosition:function(){return this.position},setPosition:function(e){this.position.copy(e),this.listener&&this.listener.setPosition(e.x,e.y,e.z)},getVelocity:function(){return this.velocity},setVelocity:function(e){this.velocity.copy(e),this.listener&&this.listener.setPosition(e.x,e.y,e.z)},setOrientation:function(e){this.orientation.copy(e),this.listener&&this.listener.setOrientation(-e.data[8],-e.data[9],-e.data[10],e.data[4],e.data[5],e.data[6])},getOrientation:function(){return this.orientation}}),{Listener:Bt})),Object.assign(te,(te.SoundManager.hasAudioContext()?(kt=function(e,t,i){te.events.attach(this),i=i||{},this._volume=void 0!==i.volume?te.math.clamp(Number(i.volume)||0,0,1):1,this._pitch=void 0!==i.pitch?Math.max(.01,Number(i.pitch)||0):1,this._loop=!(void 0===i.loop||!i.loop),this._sound=t,this._state=2,this._suspendInstanceEvents=this._suspendEndEvent=this._suspended=!1,this._startTime=Math.max(0,Number(i.startTime)||0),this._duration=Math.max(0,Number(i.duration)||0),this._startedAt=0,this._startOffset=null,this._currentOffset=this._currentTime=0,this._playWhenLoaded=!0,this._manager=e,this._lastNode=this._firstNode=this._connectorNode=this._inputNode=null,this._initializeNodes(),this._onPlayCallback=i.onPlay,this._onPauseCallback=i.onPause,this._onResumeCallback=i.onResume,this._onStopCallback=i.onStop,this._onEndCallback=i.onEnd,this._endedHandler=this._onEnded.bind(this),this.source=null},Object.assign(kt.prototype,{_initializeNodes:function(){this._connectorNode=this._inputNode=this.gain=this._manager.context.createGain(),this._connectorNode.connect(this._manager.context.destination)},play:function(){2!==this._state&&this.stop(),this.source||this._createSource();var e=this._startOffset%this.duration||0;return e=(this._startTime+e)%this._sound.duration||0,this._startOffset=null,this._duration?this.source.start(0,e,this._duration):this.source.start(0,e),this._startedAt=this._manager.context.currentTime,this._currentTime=0,this._currentOffset=e,this._state=0,this._playWhenLoaded=!1,this.volume=this._volume,this.loop=this._loop,this.pitch=this._pitch,this._manager.on("volumechange",this._onManagerVolumeChange,this),this._manager.on("suspend",this._onManagerSuspend,this),this._manager.on("resume",this._onManagerResume,this),this._manager.on("destroy",this._onManagerDestroy,this),this._manager.suspended&&this._onManagerSuspend(),this._suspendInstanceEvents||this._onPlay(),!0},pause:function(){return!(0!==this._state||!this.source||(this._updateCurrentTime(),this._state=1,this._suspendEndEvent=!0,this.source.stop(0),this.source=null,this._playWhenLoaded=!1,this._startOffset=null,this._suspendInstanceEvents||this._onPause(),0))},resume:function(){if(1!==this._state)return!1;this.source||this._createSource();var e=this.currentTime;return null!==this._startOffset&&(e=this._startOffset%this.duration||0,e=(this._startTime+e)%this._sound.duration||0,this._startOffset=null),this._duration?this.source.start(0,e,this._duration):this.source.start(0,e),this._state=0,this._startedAt=this._manager.context.currentTime,this._currentOffset=e,this.volume=this._volume,this.loop=this._loop,this.pitch=this._pitch,this._playWhenLoaded=!1,this._suspendInstanceEvents||this._onResume(),!0},stop:function(){return!(2===this._state||!this.source||(this._manager.off("volumechange",this._onManagerVolumeChange,this),this._manager.off("suspend",this._onManagerSuspend,this),this._manager.off("resume",this._onManagerResume,this),this._manager.off("destroy",this._onManagerDestroy,this),this._currentOffset=this._currentTime=this._startedAt=0,this._startOffset=null,this._playWhenLoaded=!1,this._suspendEndEvent=!0,0===this._state&&this.source.stop(0),this.source=null,this._state=2,this._suspendInstanceEvents||this._onStop(),0))},setExternalNodes:function(e,t){if(e){t||(t=e);var i=this._manager.context.destination;this._firstNode!==e&&(this._firstNode?this._connectorNode.disconnect(this._firstNode):this._connectorNode.disconnect(i),this._firstNode=e,this._connectorNode.connect(e)),this._lastNode!==t&&(this._lastNode&&this._lastNode.disconnect(i),this._lastNode=t,this._lastNode.connect(i))}},clearExternalNodes:function(){var e=this._manager.context.destination;this._firstNode&&(this._connectorNode.disconnect(this._firstNode),this._firstNode=null),this._lastNode&&(this._lastNode.disconnect(e),this._lastNode=null),this._connectorNode.connect(e)},getExternalNodes:function(){return[this._firstNode,this._lastNode]},_createSource:function(){if(!this._sound)return null;var e=this._manager.context;return this._sound.buffer&&(this.source=e.createBufferSource(),this.source.buffer=this._sound.buffer,this.source.connect(this._inputNode),this.source.onended=this._endedHandler,this.source.loopStart=this._startTime%this.source.buffer.duration||0,this._duration&&(this.source.loopEnd=Math.max(this.source.loopStart,(this._startTime+this._duration)%this.source.buffer.duration||0))),this.source},_updateCurrentTime:function(){this._currentTime=((this._manager.context.currentTime-this._startedAt)*this._pitch+this._currentOffset)%this.duration||0},_onManagerDestroy:function(){this.source&&0===this._state&&(this.source.stop(0),this.source=null)}}),Object.defineProperty(kt.prototype,"volume",{get:function(){return this._volume},set:function(e){this._volume=e=te.math.clamp(e,0,1),this.gain&&(this.gain.gain.value=e*this._manager.volume)}}),Object.defineProperty(kt.prototype,"pitch",{get:function(){return this._pitch},set:function(e){this._currentOffset=this.currentTime,this._startedAt=this._manager.context.currentTime,this._pitch=Math.max(Number(e)||0,.01),this.source&&(this.source.playbackRate.value=this._pitch)}}),Object.defineProperty(kt.prototype,"loop",{get:function(){return this._loop},set:function(e){this._loop=!!e,this.source&&(this.source.loop=this._loop)}}),Object.defineProperty(kt.prototype,"sound",{get:function(){return this._sound},set:function(e){this._sound=e,2!==this._state?this.stop():this._createSource()}}),Object.defineProperty(kt.prototype,"currentTime",{get:function(){return null!==this._startOffset?this._startOffset:1===this._state?this._currentTime:2!==this._state&&this.source?(this._updateCurrentTime(),this._currentTime):0},set:function(e){if(!(e<0))if(0===this._state){this.stop();var t=this._suspendInstanceEvents;this._suspendInstanceEvents=!0,this._startOffset=e,this.play(),this._suspendInstanceEvents=t}else this._currentTime=this._startOffset=e}})):te.SoundManager.hasAudio()?(kt=function(e,t,i){te.events.attach(this),i=i||{},this._volume=void 0!==i.volume?te.math.clamp(Number(i.volume)||0,0,1):1,this._pitch=void 0!==i.pitch?Math.max(.01,Number(i.pitch)||0):1,this._loop=!(void 0===i.loop||!i.loop),this._sound=t,this._state=2,this._suspendInstanceEvents=this._suspendEndEvent=this._suspended=!1,this._playWhenLoaded=!0,this._startTime=Math.max(0,Number(i.startTime)||0),this._duration=Math.max(0,Number(i.duration)||0),this._startOffset=null,this._isReady=!1,this._manager=e,this._loadedMetadataHandler=this._onLoadedMetadata.bind(this),this._timeUpdateHandler=this._onTimeUpdate.bind(this),this._endedHandler=this._onEnded.bind(this),this._onPlayCallback=i.onPlay,this._onPauseCallback=i.onPause,this._onResumeCallback=i.onResume,this._onStopCallback=i.onStop,this._onEndCallback=i.onEnd,this.source=null,this._createSource()},Object.assign(kt.prototype,{play:function(){return 2!==this._state&&this.stop(),!(!this.source&&!this._createSource()||(this.volume=this._volume,this.pitch=this._pitch,this.loop=this._loop,this.source.play(),this._state=0,this._playWhenLoaded=!1,this._manager.on("volumechange",this._onManagerVolumeChange,this),this._manager.on("suspend",this._onManagerSuspend,this),this._manager.on("resume",this._onManagerResume,this),this._manager.on("destroy",this._onManagerDestroy,this),this._manager.suspended&&this._onManagerSuspend(),this._suspendInstanceEvents||this._onPlay(),0))},pause:function(){return!(!this.source||0!==this._state||(this._suspendEndEvent=!0,this.source.pause(),this._playWhenLoaded=!1,this._state=1,this._startOffset=null,this._suspendInstanceEvents||this._onPause(),0))},resume:function(){return!(!this.source||1!==this._state||(this._state=0,this._playWhenLoaded=!1,this.source.paused&&(this.source.play(),this._suspendInstanceEvents||this._onResume()),0))},stop:function(){return!(!this.source||2===this._state||(this._manager.off("volumechange",this._onManagerVolumeChange,this),this._manager.off("suspend",this._onManagerSuspend,this),this._manager.off("resume",this._onManagerResume,this),this._manager.off("destroy",this._onManagerDestroy,this),this._suspendEndEvent=!0,this.source.pause(),this._playWhenLoaded=!1,this._state=2,this._startOffset=null,this._suspendInstanceEvents||this._onStop(),0))},setExternalNodes:function(){},clearExternalNodes:function(){},getExternalNodes:function(){return[null,null]},_onLoadedMetadata:function(){this.source.removeEventListener("loadedmetadata",this._loadedMetadataHandler),this._isReady=!0;var e=this._startOffset%this.duration||0;e=(this._startTime+e)%this._sound.duration||0,this._startOffset=null,this.source.currentTime=e},_createSource:function(){return this._sound&&this._sound.audio&&(this._isReady=!1,this.source=this._sound.audio.cloneNode(!0),this.source.addEventListener("loadedmetadata",this._loadedMetadataHandler),this.source.addEventListener("timeupdate",this._timeUpdateHandler),this.source.onended=this._endedHandler),this.source},_onTimeUpdate:function(){this._duration&&this.source.currentTime>((this._startTime+this._duration)%this.source.duration||0)&&(this.loop?this.source.currentTime=this._startTime%this.source.duration||0:(this.source.removeEventListener("timeupdate",this._timeUpdateHandler),this.source.pause(),this._onEnded()))},_onManagerDestroy:function(){this.source&&this.source.pause()}}),Object.defineProperty(kt.prototype,"volume",{get:function(){return this._volume},set:function(e){this._volume=e=te.math.clamp(e,0,1),this.source&&(this.source.volume=e*this._manager.volume)}}),Object.defineProperty(kt.prototype,"pitch",{get:function(){return this._pitch},set:function(e){this._pitch=Math.max(Number(e)||0,.01),this.source&&(this.source.playbackRate=this._pitch)}}),Object.defineProperty(kt.prototype,"loop",{get:function(){return this._loop},set:function(e){this._loop=!!e,this.source&&(this.source.loop=this._loop)}}),Object.defineProperty(kt.prototype,"sound",{get:function(){return this._sound},set:function(e){this.stop(),this._sound=e}}),Object.defineProperty(kt.prototype,"currentTime",{get:function(){return null!==this._startOffset?this._startOffset:2!==this._state&&this.source?this.source.currentTime-this._startTime:0},set:function(e){e<0||(this._startOffset=e,this.source&&this._isReady&&(this.source.currentTime=(this._startTime+(e%this.duration||0))%this._sound.duration||0,this._startOffset=null))}})):kt=function(){},Object.assign(kt.prototype,{_onPlay:function(){this.fire("play"),this._onPlayCallback&&this._onPlayCallback(this)},_onPause:function(){this.fire("pause"),this._onPauseCallback&&this._onPauseCallback(this)},_onResume:function(){this.fire("resume"),this._onResumeCallback&&this._onResumeCallback(this)},_onStop:function(){this.fire("stop"),this._onStopCallback&&this._onStopCallback(this)},_onEnded:function(){this._suspendEndEvent?this._suspendEndEvent=!1:(this.fire("end"),this._onEndCallback&&this._onEndCallback(this),this.stop())},_onManagerVolumeChange:function(){this.volume=this._volume},_onManagerSuspend:function(){0!==this._state||this._suspended||(this._suspended=!0,this.pause())},_onManagerResume:function(){this._suspended&&(this._suspended=!1,this.resume())}}),Object.defineProperty(kt.prototype,"startTime",{get:function(){return this._startTime},set:function(e){this._startTime=Math.max(0,Number(e)||0),e=0===this._state,this.stop(),e&&this.play()}}),Object.defineProperty(kt.prototype,"duration",{get:function(){return this._sound?this._duration?this._duration%this._sound.duration||0:this._sound.duration:0},set:function(e){this._duration=Math.max(0,Number(e)||0),e=0===this._state,this.stop(),e&&this.play()}}),Object.defineProperty(kt.prototype,"isPlaying",{get:function(){return 0===this._state}}),Object.defineProperty(kt.prototype,"isPaused",{get:function(){return 1===this._state}}),Object.defineProperty(kt.prototype,"isStopped",{get:function(){return 2===this._state}}),Object.defineProperty(kt.prototype,"isSuspended",{get:function(){return this._suspended}}),{SoundInstance:kt})),Object.assign(te,function(){var e;if(te.SoundManager.hasAudioContext())(e=function(e,t,i){te.SoundInstance.call(this,e,t,i),i=i||{},this._position=new te.Vec3,i.position&&(this.position=i.position),this._velocity=new te.Vec3,i.velocity&&(this.velocity=i.velocity),this.maxDistance=void 0!==i.maxDistance?Number(i.maxDistance):1e4,this.refDistance=void 0!==i.refDistance?Number(i.refDistance):1,this.rollOffFactor=void 0!==i.rollOffFactor?Number(i.rollOffFactor):1,this.distanceModel=void 0!==i.distanceModel?i.distanceModel:te.DISTANCE_LINEAR}).prototype=Object.create(te.SoundInstance.prototype),e.prototype.constructor=e,Object.assign(e.prototype,{_initializeNodes:function(){this.gain=this._manager.context.createGain(),this.panner=this._manager.context.createPanner(),this.panner.connect(this.gain),this._inputNode=this.panner,this._connectorNode=this.gain,this._connectorNode.connect(this._manager.context.destination)}}),Object.defineProperty(e.prototype,"position",{get:function(){return this._position},set:function(e){this._position.copy(e),this.panner.setPosition(e.x,e.y,e.z)}}),Object.defineProperty(e.prototype,"velocity",{get:function(){return this._velocity},set:function(e){this._velocity.copy(e),this.panner.setVelocity(e.x,e.y,e.z)}}),Object.defineProperty(e.prototype,"maxDistance",{get:function(){return this.panner.maxDistance},set:function(e){this.panner.maxDistance=e}}),Object.defineProperty(e.prototype,"refDistance",{get:function(){return this.panner.refDistance},set:function(e){this.panner.refDistance=e}}),Object.defineProperty(e.prototype,"rollOffFactor",{get:function(){return this.panner.rolloffFactor},set:function(e){this.panner.rolloffFactor=e}}),Object.defineProperty(e.prototype,"distanceModel",{get:function(){return this.panner.distanceModel},set:function(e){this.panner.distanceModel=e}});else if(te.SoundManager.hasAudio()){var r=new te.Vec3;(e=function(e,t,i){te.SoundInstance.call(this,e,t,i),i=i||{},this._position=new te.Vec3,i.position&&(this.position=i.position),this._velocity=new te.Vec3,i.velocity&&(this.velocity=i.velocity),this._maxDistance=void 0!==i.maxDistance?Number(i.maxDistance):1e4,this._refDistance=void 0!==i.refDistance?Number(i.refDistance):1,this._rollOffFactor=void 0!==i.rollOffFactor?Number(i.rollOffFactor):1,this._distanceModel=void 0!==i.distanceModel?i.distanceModel:te.DISTANCE_LINEAR}).prototype=Object.create(te.SoundInstance.prototype),e.prototype.constructor=e,Object.defineProperty(e.prototype,"position",{get:function(){return this._position},set:function(e){if(this._position.copy(e),this.source){var t=this._manager.listener.getPosition();e=this.refDistance;var i=this.maxDistance,s=this.rollOffFactor,n=this.distanceModel;if((t=(r=r.sub2(t,this._position)).length())<e)e=1;else if(i<t)e=0;else{var a=0;n===te.DISTANCE_LINEAR?a=1-s*(t-e)/(i-e):n===te.DISTANCE_INVERSE?a=e/(e+s*(t-e)):n===te.DISTANCE_EXPONENTIAL&&(a=Math.pow(t/e,-s)),e=te.math.clamp(a,0,1)}this.source.volume=this.volume*e*this._manager.volume}}}),Object.defineProperty(e.prototype,"velocity",{get:function(){return this._velocity},set:function(e){this._velocity.copy(e)}}),Object.defineProperty(e.prototype,"maxDistance",{get:function(){return this._maxDistance},set:function(e){this._maxDistance=e}}),Object.defineProperty(e.prototype,"refDistance",{get:function(){return this._refDistance},set:function(e){this._refDistance=e}}),Object.defineProperty(e.prototype,"rollOffFactor",{get:function(){return this._rollOffFactor},set:function(e){this._rollOffFactor=e}}),Object.defineProperty(e.prototype,"distanceModel",{get:function(){return this._distanceModel},set:function(e){this._distanceModel=e}})}else e=function(){};return{SoundInstance3d:e}}()),Object.assign(te,(te.AudioManager.hasAudioContext()?(Vt=function(e,t,i){i=i||{},this.volume=void 0===i.volume?1:i.volume,this.loop=void 0!==i.loop&&i.loop,this.pitch=void 0===i.pitch?1:i.pitch,this.sound=t,this.suspended=this.paused=!1,this.startOffset=this.startTime=0,this.manager=e,this.source=null,this.gain=e.context.createGain()},Object.assign(Vt.prototype,{play:function(){if(this.source)throw Error("Call stop() before calling play()");this._createSource(),this.source&&(this.startTime=this.manager.context.currentTime,this.source.start(0,this.startOffset%this.source.buffer.duration),this.setVolume(this.volume),this.setLoop(this.loop),this.setPitch(this.pitch),this.manager.on("volumechange",this.onManagerVolumeChange,this),this.manager.on("suspend",this.onManagerSuspend,this),this.manager.on("resume",this.onManagerResume,this),this.manager.suspended)&&this.onManagerSuspend()},pause:function(){this.source&&(this.paused=!0,this.startOffset+=this.manager.context.currentTime-this.startTime,this.source.stop(0),this.source=null)},unpause:function(){this.source||!this.paused||(this._createSource(),this.source&&(this.startTime=this.manager.context.currentTime,this.source.start(0,this.startOffset%this.source.buffer.duration),this.setVolume(this.volume),this.setLoop(this.loop),this.setPitch(this.pitch),this.paused=!1))},stop:function(){this.source&&(this.source.stop(0),this.source=null),this.manager.off("volumechange",this.onManagerVolumeChange,this),this.manager.off("suspend",this.onManagerSuspend,this),this.manager.off("resume",this.onManagerResume,this)},setLoop:function(e){this.loop=e,this.source&&(this.source.loop=e)},setVolume:function(e){this.volume=e=te.math.clamp(e,0,1),this.gain&&(this.gain.gain.value=e*this.manager.volume)},setPitch:function(e){this.pitch=e,this.source&&(this.source.playbackRate.value=e)},isPlaying:function(){return!this.paused&&this.source.playbackState===this.source.PLAYING_STATE},getDuration:function(){return this.source?this.source.buffer.duration:0},_createSource:function(){var e=this.manager.context;this.sound.buffer&&(this.source=e.createBufferSource(),this.source.buffer=this.sound.buffer,this.source.connect(this.gain),this.gain.connect(e.destination),this.loop||(this.source.onended=this.pause.bind(this)))}})):te.AudioManager.hasAudio()?(Vt=function(e,t,i){this.volume=i.volume||1,this.loop=i.loop||!1,this.sound=t,this.pitch=void 0!==i.pitch?i.pitch:1,this.suspended=this.paused=!1,this.manager=e,t.audio&&(this.source=t.audio.cloneNode(!1),this.source.pause())},Object.assign(Vt.prototype,{play:function(){this.source&&(this.paused=!1,this.setVolume(this.volume),this.setLoop(this.loop),this.setPitch(this.pitch),this.source.play()),this.manager.on("volumechange",this.onManagerVolumeChange,this),this.manager.on("suspend",this.onManagerSuspend,this),this.manager.on("resume",this.onManagerResume,this),this.manager.suspended&&this.onManagerSuspend()},pause:function(){this.source&&(this.paused=!0,this.source.pause())},unpause:function(){this.source&&(this.paused=!1,this.source.play())},stop:function(){this.source&&this.source.pause(),this.manager.off("volumechange",this.onManagerVolumeChange,this),this.manager.off("suspend",this.onManagerSuspend,this),this.manager.off("resume",this.onManagerResume,this)},setVolume:function(e){this.volume=e=te.math.clamp(e,0,1),this.source&&(this.source.volume=e*this.manager.volume)},setLoop:function(e){this.loop=e,this.source&&(this.source.loop=e)},setPitch:function(e){this.pitch=e,this.source&&(this.source.playbackRate=e)},getDuration:function(){return this.source&&!isNaN(this.source.duration)?this.source.duration:0},isPlaying:function(){return!this.source.paused}})):Vt=function(){},Object.assign(Vt.prototype,{getVolume:function(){return this.volume},getLoop:function(){return this.loop},getPitch:function(){return this.pitch},onManagerVolumeChange:function(){this.setVolume(this.getVolume())},onManagerSuspend:function(){this.isPlaying()&&!this.suspended&&(this.suspended=!0,this.pause())},onManagerResume:function(){this.suspended&&(this.suspended=!1,this.unpause())}}),{Channel:Vt})),Object.assign(te,function(){var e;if(te.AudioManager.hasAudioContext())(e=function(e,t,i){te.Channel.call(this,e,t,i),this.position=new te.Vec3,this.velocity=new te.Vec3,this.panner=e.context.createPanner()}).prototype=Object.create(te.Channel.prototype),e.prototype.constructor=e,Object.assign(e.prototype,{getPosition:function(){return this.position},setPosition:function(e){this.position.copy(e),this.panner.setPosition(e.x,e.y,e.z)},getVelocity:function(){return this.velocity},setVelocity:function(e){this.velocity.copy(e),this.panner.setVelocity(e.x,e.y,e.z)},getMaxDistance:function(){return this.panner.maxDistance},setMaxDistance:function(e){this.panner.maxDistance=e},getMinDistance:function(){return this.panner.refDistance},setMinDistance:function(e){this.panner.refDistance=e},getRollOffFactor:function(){return this.panner.rolloffFactor},setRollOffFactor:function(e){this.panner.rolloffFactor=e},getDistanceModel:function(){return this.pannel.distanceModel},setDistanceModel:function(e){this.panner.distanceModel=e},_createSource:function(){var e=this.manager.context;this.source=e.createBufferSource(),this.source.buffer=this.sound.buffer,this.source.connect(this.panner),this.panner.connect(this.gain),this.gain.connect(e.destination),this.loop||(this.source.onended=this.pause.bind(this))}});else if(te.AudioManager.hasAudio()){var r=new te.Vec3;(e=function(e,t){te.Channel.call(this,e,t),this.position=new te.Vec3,this.velocity=new te.Vec3,this.maxDistance=1e4,this.rollOffFactor=this.minDistance=1,this.distanceModel=te.DISTANCE_INVERSE}).prototype=Object.create(te.Channel.prototype),e.prototype.constructor=e,Object.assign(e.prototype,{getPosition:function(){return this.position},setPosition:function(e){if(this.position.copy(e),this.source){var t=this.manager.listener.getPosition();e=this.minDistance;var i=this.maxDistance,s=this.rollOffFactor,n=this.distanceModel;if((t=(r=r.sub2(t,this.position)).length())<e)e=1;else if(i<t)e=0;else{var a=0;n===te.DISTANCE_LINEAR?a=1-s*(t-e)/(i-e):n===te.DISTANCE_INVERSE?a=e/(e+s*(t-e)):n===te.DISTANCE_EXPONENTIAL&&(a=Math.pow(t/e,-s)),e=te.math.clamp(a,0,1)}i=this.getVolume(),this.source.volume=i*e}},getVelocity:function(){return this.velocity},setVelocity:function(e){this.velocity.copy(e)},getMaxDistance:function(){return this.maxDistance},setMaxDistance:function(e){this.maxDistance=e},getMinDistance:function(){return this.minDistance},setMinDistance:function(e){this.minDistance=e},getRollOffFactor:function(){return this.rollOffFactor},setRollOffFactor:function(e){this.rollOffFactor=e},getDistanceModel:function(){return this.distanceModel},setDistanceModel:function(e){this.distanceModel=e}})}else e=function(){};return{Channel3d:e}}()),Ut={ACTION_MOUSE:"mouse",ACTION_KEYBOARD:"keyboard",ACTION_GAMEPAD:"gamepad",AXIS_MOUSE_X:"mousex",AXIS_MOUSE_Y:"mousey",AXIS_PAD_L_X:"padlx",AXIS_PAD_L_Y:"padly",AXIS_PAD_R_X:"padrx",AXIS_PAD_R_Y:"padry",AXIS_KEY:"key",EVENT_KEYDOWN:"keydown",EVENT_KEYUP:"keyup",EVENT_MOUSEDOWN:"mousedown",EVENT_MOUSEMOVE:"mousemove",EVENT_MOUSEUP:"mouseup",EVENT_MOUSEWHEEL:"mousewheel",EVENT_TOUCHSTART:"touchstart",EVENT_TOUCHEND:"touchend",EVENT_TOUCHMOVE:"touchmove",EVENT_TOUCHCANCEL:"touchcancel",KEY_BACKSPACE:8,KEY_TAB:9,KEY_RETURN:13,KEY_ENTER:13,KEY_SHIFT:16,KEY_CONTROL:17,KEY_ALT:18,KEY_PAUSE:19,KEY_CAPS_LOCK:20,KEY_ESCAPE:27,KEY_SPACE:32,KEY_PAGE_UP:33,KEY_PAGE_DOWN:34,KEY_END:35,KEY_HOME:36,KEY_LEFT:37,KEY_UP:38,KEY_RIGHT:39,KEY_DOWN:40,KEY_PRINT_SCREEN:44,KEY_INSERT:45,KEY_DELETE:46,KEY_0:48,KEY_1:49,KEY_2:50,KEY_3:51,KEY_4:52,KEY_5:53,KEY_6:54,KEY_7:55,KEY_8:56,KEY_9:57,KEY_SEMICOLON:59,KEY_EQUAL:61,KEY_A:65,KEY_B:66,KEY_C:67,KEY_D:68,KEY_E:69,KEY_F:70,KEY_G:71,KEY_H:72,KEY_I:73,KEY_J:74,KEY_K:75,KEY_L:76,KEY_M:77,KEY_N:78,KEY_O:79,KEY_P:80,KEY_Q:81,KEY_R:82,KEY_S:83,KEY_T:84,KEY_U:85,KEY_V:86,KEY_W:87,KEY_X:88,KEY_Y:89,KEY_Z:90,KEY_WINDOWS:91,KEY_CONTEXT_MENU:93,KEY_NUMPAD_0:96,KEY_NUMPAD_1:97,KEY_NUMPAD_2:98,KEY_NUMPAD_3:99,KEY_NUMPAD_4:100,KEY_NUMPAD_5:101,KEY_NUMPAD_6:102,KEY_NUMPAD_7:103,KEY_NUMPAD_8:104,KEY_NUMPAD_9:105,KEY_MULTIPLY:106,KEY_ADD:107,KEY_SEPARATOR:108,KEY_SUBTRACT:109,KEY_DECIMAL:110,KEY_DIVIDE:111,KEY_F1:112,KEY_F2:113,KEY_F3:114,KEY_F4:115,KEY_F5:116,KEY_F6:117,KEY_F7:118,KEY_F8:119,KEY_F9:120,KEY_F10:121,KEY_F11:122,KEY_F12:123,KEY_COMMA:188,KEY_PERIOD:190,KEY_SLASH:191,KEY_OPEN_BRACKET:219,KEY_BACK_SLASH:220,KEY_CLOSE_BRACKET:221,KEY_META:224,MOUSEBUTTON_NONE:-1,MOUSEBUTTON_LEFT:0,MOUSEBUTTON_MIDDLE:1,MOUSEBUTTON_RIGHT:2,PAD_1:0,PAD_2:1,PAD_3:2,PAD_4:3,PAD_FACE_1:0,PAD_FACE_2:1,PAD_FACE_3:2,PAD_FACE_4:3,PAD_L_SHOULDER_1:4,PAD_R_SHOULDER_1:5,PAD_L_SHOULDER_2:6,PAD_R_SHOULDER_2:7,PAD_SELECT:8,PAD_START:9,PAD_L_STICK_BUTTON:10,PAD_R_STICK_BUTTON:11,PAD_UP:12,PAD_DOWN:13,PAD_LEFT:14,PAD_RIGHT:15,PAD_VENDOR:16,PAD_L_STICK_X:0,PAD_L_STICK_Y:1,PAD_R_STICK_X:2,PAD_R_STICK_Y:3},Object.assign(te,Ut),te.input={},Object.assign(te.input,Ut),Object.assign(te,(zt=function(e,t){var i={x:0,y:0};if(t){if(t instanceof zt)throw Error("Expected MouseEvent");i=e._getTargetCoords(t)}else t={};if(i)this.x=i.x,this.y=i.y;else{if(!te.Mouse.isPointerLocked())return;this.y=this.x=0}this.wheel=t.detail?-1*t.detail:t.wheelDelta?t.wheelDelta/120:0,te.Mouse.isPointerLocked()?(this.dx=t.movementX||t.webkitMovementX||t.mozMovementX||0,this.dy=t.movementY||t.webkitMovementY||t.mozMovementY||0):(this.dx=this.x-e._lastX,this.dy=this.y-e._lastY),this.button="mousedown"===t.type||"mouseup"===t.type?t.button:te.MOUSEBUTTON_NONE,this.buttons=e._buttons.slice(0),this.element=t.target,this.ctrlKey=t.ctrlKey||!1,this.altKey=t.altKey||!1,this.shiftKey=t.shiftKey||!1,this.metaKey=t.metaKey||!1,this.event=t},(Ht=function(e){this._lastY=this._lastX=0,this._buttons=[!1,!1,!1],this._lastbuttons=[!1,!1,!1],this._upHandler=this._handleUp.bind(this),this._downHandler=this._handleDown.bind(this),this._moveHandler=this._handleMove.bind(this),this._wheelHandler=this._handleWheel.bind(this),this._contextMenuHandler=function(e){e.preventDefault()},this._target=null,this._attached=!1,this.attach(e),te.events.attach(this)}).isPointerLocked=function(){return!!(document.pointerLockElement||document.mozPointerLockElement||document.webkitPointerLockElement)},Object.assign(Ht.prototype,{attach:function(e){this._target=e,this._attached||(this._attached=!0,window.addEventListener("mouseup",this._upHandler,!1),window.addEventListener("mousedown",this._downHandler,!1),window.addEventListener("mousemove",this._moveHandler,!1),window.addEventListener("mousewheel",this._wheelHandler,!1),window.addEventListener("DOMMouseScroll",this._wheelHandler,!1))},detach:function(){this._attached&&(this._attached=!1,this._target=null,window.removeEventListener("mouseup",this._upHandler),window.removeEventListener("mousedown",this._downHandler),window.removeEventListener("mousemove",this._moveHandler),window.removeEventListener("mousewheel",this._wheelHandler),window.removeEventListener("DOMMouseScroll",this._wheelHandler))},disableContextMenu:function(){this._target&&this._target.addEventListener("contextmenu",this._contextMenuHandler)},enableContextMenu:function(){this._target&&this._target.removeEventListener("contextmenu",this._contextMenuHandler)},enablePointerLock:function(e,t){if(document.body.requestPointerLock){var i=function(){e(),document.removeEventListener("pointerlockchange",i)},s=function(){t(),document.removeEventListener("pointerlockerror",s)};e&&document.addEventListener("pointerlockchange",i,!1),t&&document.addEventListener("pointerlockerror",s,!1),document.body.requestPointerLock()}else t&&t()},disablePointerLock:function(e){if(document.exitPointerLock){var t=function(){e(),document.removeEventListener("pointerlockchange",t)};e&&document.addEventListener("pointerlockchange",t,!1),document.exitPointerLock()}},update:function(){this._lastbuttons[0]=this._buttons[0],this._lastbuttons[1]=this._buttons[1],this._lastbuttons[2]=this._buttons[2]},isPressed:function(e){return this._buttons[e]},wasPressed:function(e){return this._buttons[e]&&!this._lastbuttons[e]},wasReleased:function(e){return!this._buttons[e]&&this._lastbuttons[e]},_handleUp:function(e){this._buttons[e.button]=!1,(e=new zt(this,e)).event&&this.fire(te.EVENT_MOUSEUP,e)},_handleDown:function(e){this._buttons[e.button]=!0,(e=new zt(this,e)).event&&this.fire(te.EVENT_MOUSEDOWN,e)},_handleMove:function(e){(e=new zt(this,e)).event&&(this.fire(te.EVENT_MOUSEMOVE,e),this._lastX=e.x,this._lastY=e.y)},_handleWheel:function(e){(e=new zt(this,e)).event&&this.fire(te.EVENT_MOUSEWHEEL,e)},_getTargetCoords:function(e){var t=this._target.getBoundingClientRect(),i=Math.floor(t.left);return t=Math.floor(t.top),e.clientX<i||e.clientX>=i+this._target.clientWidth||e.clientY<t||e.clientY>=t+this._target.clientHeight?null:{x:e.clientX-i,y:e.clientY-t}}}),{Mouse:Ht,MouseEvent:zt})),Object.assign(te,function(){function i(e){return t.key=e.keyCode,t.element=e.target,t.event=e,t}function s(e){return"string"==typeof e?e.toUpperCase().charCodeAt(0):e}var e=function(e,t){t?(this.key=t.keyCode,this.element=t.target,this.event=t):this.event=this.element=this.key=null},t=new e,n={9:"Tab",13:"Enter",16:"Shift",17:"Control",18:"Alt",27:"Escape",37:"Left",38:"Up",39:"Right",40:"Down",46:"Delete",91:"Win"},a=function(e,t){t=t||{},this._element=null,this._keyDownHandler=this._handleKeyDown.bind(this),this._keyUpHandler=this._handleKeyUp.bind(this),this._keyPressHandler=this._handleKeyPress.bind(this),te.events.attach(this),this._keymap={},this._lastmap={},e&&this.attach(e),this.preventDefault=t.preventDefault||!1,this.stopPropagation=t.stopPropagation||!1};return a.prototype.attach=function(e){this._element&&this.detach(),this._element=e,this._element.addEventListener("keydown",this._keyDownHandler,!1),this._element.addEventListener("keypress",this._keyPressHandler,!1),this._element.addEventListener("keyup",this._keyUpHandler,!1)},a.prototype.detach=function(){this._element.removeEventListener("keydown",this._keyDownHandler),this._element.removeEventListener("keypress",this._keyPressHandler),this._element.removeEventListener("keyup",this._keyUpHandler),this._element=null},a.prototype.toKeyIdentifier=function(e){var t,i;if(e=s(e),t=n[e.toString()])return t;for(i=(t=e.toString(16).toUpperCase()).length,e=0;e<4-i;e++)t="0"+t;return"U+"+t},a.prototype._handleKeyDown=function(e){var t=e.keyCode||e.charCode;void 0!==t&&(t=this.toKeyIdentifier(t),this._keymap[t]=!0,this.fire("keydown",i(e)),this.preventDefault&&e.preventDefault(),this.stopPropagation&&e.stopPropagation())},a.prototype._handleKeyUp=function(e){var t=e.keyCode||e.charCode;void 0!==t&&(t=this.toKeyIdentifier(t),delete this._keymap[t],this.fire("keyup",i(e)),this.preventDefault&&e.preventDefault(),this.stopPropagation&&e.stopPropagation())},a.prototype._handleKeyPress=function(e){this.fire("keypress",i(e)),this.preventDefault&&e.preventDefault(),this.stopPropagation&&e.stopPropagation()},a.prototype.update=function(){for(var e in this._lastmap)delete this._lastmap[e];for(e in this._keymap)this._keymap.hasOwnProperty(e)&&(this._lastmap[e]=this._keymap[e])},a.prototype.isPressed=function(e){return e=s(e),e=this.toKeyIdentifier(e),!!this._keymap[e]},a.prototype.wasPressed=function(e){return e=s(e),e=this.toKeyIdentifier(e),!!this._keymap[e]&&!this._lastmap[e]},a.prototype.wasReleased=function(e){return e=s(e),e=this.toKeyIdentifier(e),!this._keymap[e]&&!!this._lastmap[e]},{Keyboard:a,KeyboardEvent:e}}()),Object.assign(te,(jt=function(){this.gamepadsSupported=!!navigator.getGamepads||!!navigator.webkitGetGamepads,this.current=[],this.previous=[],this.deadZone=.25},Gt={DEFAULT:{buttons:"PAD_FACE_1 PAD_FACE_2 PAD_FACE_3 PAD_FACE_4 PAD_L_SHOULDER_1 PAD_R_SHOULDER_1 PAD_L_SHOULDER_2 PAD_R_SHOULDER_2 PAD_SELECT PAD_START PAD_L_STICK_BUTTON PAD_R_STICK_BUTTON PAD_UP PAD_DOWN PAD_LEFT PAD_RIGHT PAD_VENDOR".split(" "),axes:["PAD_L_STICK_X","PAD_L_STICK_Y","PAD_R_STICK_X","PAD_R_STICK_Y"]},PS3:{buttons:"PAD_FACE_1 PAD_FACE_2 PAD_FACE_4 PAD_FACE_3 PAD_L_SHOULDER_1 PAD_R_SHOULDER_1 PAD_L_SHOULDER_2 PAD_R_SHOULDER_2 PAD_SELECT PAD_START PAD_L_STICK_BUTTON PAD_R_STICK_BUTTON PAD_UP PAD_DOWN PAD_LEFT PAD_RIGHT PAD_VENDOR".split(" "),axes:["PAD_L_STICK_X","PAD_L_STICK_Y","PAD_R_STICK_X","PAD_R_STICK_Y"]}},Wt={"Product: 0268":"PS3"},Object.assign(jt.prototype,{update:function(){var e,t,i,s,n;for(e=0,i=this.current.length;e<i;e++)for(n=(s=this.current[e].pad.buttons).length,t=0;t<n;t++)void 0===this.previous[e]&&(this.previous[e]=[]),this.previous[e][t]=s[t].pressed;for(e=0,i=(t=this.poll()).length;e<i;e++)this.current[e]=t[e]},poll:function(){var e=[];if(this.gamepadsSupported){var t,i=navigator.getGamepads?navigator.getGamepads():navigator.webkitGetGamepads(),s=i.length;for(t=0;t<s;t++)i[t]&&e.push({map:this.getMap(i[t]),pad:i[t]})}return e},getMap:function(e){for(var t in Wt)if(0<=e.id.indexOf(t))return Gt[Wt[t]];return Gt.DEFAULT},isPressed:function(e,t){return!!this.current[e]&&this.current[e].pad.buttons[te[this.current[e].map.buttons[t]]].pressed},wasPressed:function(e,t){if(!this.current[e])return!1;var i=te[this.current[e].map.buttons[t]];return this.current[e].pad.buttons[i].pressed&&!this.previous[e][i]},getAxis:function(e,t){if(!this.current[e])return!1;var i=this.current[e].pad.axes[te[this.current[e].map.axes[t]]];return Math.abs(i)<this.deadZone&&(i=0),i}}),{GamePads:jt})),Object.assign(te,function(){var n=function(e){var t=te.getTouchTargetCoords(e);this.id=e.identifier,this.x=t.x,this.y=t.y,this.target=e.target,this.touch=e},t=function(e,t){if(this.element=t.target,this.event=t,this.touches=[],this.changedTouches=[],t){var i,s=t.touches.length;for(i=0;i<s;i++)this.touches.push(new n(t.touches[i]));for(s=t.changedTouches.length,i=0;i<s;i++)this.changedTouches.push(new n(t.changedTouches[i]))}};Object.assign(t.prototype,{getTouchById:function(e,t){var i,s=t.length;for(i=0;i<s;i++)if(t[i].id===e)return t[i];return null}});var e=function(e){this._element=null,this._startHandler=this._handleTouchStart.bind(this),this._endHandler=this._handleTouchEnd.bind(this),this._moveHandler=this._handleTouchMove.bind(this),this._cancelHandler=this._handleTouchCancel.bind(this),this.attach(e),te.events.attach(this)};return Object.assign(e.prototype,{attach:function(e){this._element&&this.detach(),this._element=e,this._element.addEventListener("touchstart",this._startHandler,!1),this._element.addEventListener("touchend",this._endHandler,!1),this._element.addEventListener("touchmove",this._moveHandler,!1),this._element.addEventListener("touchcancel",this._cancelHandler,!1)},detach:function(){this._element&&(this._element.removeEventListener("touchstart",this._startHandler,!1),this._element.removeEventListener("touchend",this._endHandler,!1),this._element.removeEventListener("touchmove",this._moveHandler,!1),this._element.removeEventListener("touchcancel",this._cancelHandler,!1)),this._element=null},_handleTouchStart:function(e){this.fire("touchstart",new t(this,e))},_handleTouchEnd:function(e){this.fire("touchend",new t(this,e))},_handleTouchMove:function(e){e.preventDefault(),this.fire("touchmove",new t(this,e))},_handleTouchCancel:function(e){this.fire("touchcancel",new t(this,e))}}),{getTouchTargetCoords:function(e){for(var t=0,i=0,s=e.target;!(s instanceof HTMLElement);)s=s.parentNode;for(;t+=s.offsetLeft-s.scrollLeft,i+=s.offsetTop-s.scrollTop,s=s.offsetParent;);return{x:e.pageX-t,y:e.pageY-i}},TouchDevice:e,TouchEvent:t}}()),Object.assign(te,((Yt=function(e,t){t=t||{},this._keyboard=t.keyboard||null,this._mouse=t.mouse||null,this._gamepads=t.gamepads||null,this._element=null,this._actions={},this._axes={},this._axesValues={},e&&this.attach(e)}).prototype.attach=function(e){this._element=e,this._keyboard&&this._keyboard.attach(e),this._mouse&&this._mouse.attach(e)},Yt.prototype.detach=function(){this._keyboard&&this._keyboard.detach(),this._mouse&&this._mouse.detach(),this._element=null},Yt.prototype.disableContextMenu=function(){this._mouse||this._enableMouse(),this._mouse.disableContextMenu()},Yt.prototype.enableContextMenu=function(){this._mouse||this._enableMouse(),this._mouse.enableContextMenu()},Yt.prototype.update=function(e){for(var t in this._keyboard&&this._keyboard.update(e),this._mouse&&this._mouse.update(e),this._gamepads&&this._gamepads.update(e),this._axesValues={},this._axes)this._axesValues[t]=[]},Yt.prototype.registerKeys=function(e,t){if(this._keyboard||this._enableKeyboard(),this._actions[e])throw Error(te.string.format("Action: {0} already registered",e));if(void 0===t)throw Error("Invalid button");t.length||(t=[t]),this._actions[e]?this._actions[e].push({type:te.ACTION_KEYBOARD,keys:t}):this._actions[e]=[{type:te.ACTION_KEYBOARD,keys:t}]},Yt.prototype.registerMouse=function(e,t){if(this._mouse||this._enableMouse(),void 0===t)throw Error("Invalid button");this._actions[e]?this._actions[e].push({type:te.ACTION_MOUSE,button:t}):this._actions[e]=[{type:te.ACTION_MOUSE,button:-t}]},Yt.prototype.registerPadButton=function(e,t,i){if(void 0===i)throw Error("Invalid button");this._actions[e]?this._actions[e].push({type:te.ACTION_GAMEPAD,button:i,pad:t}):this._actions[e]=[{type:te.ACTION_GAMEPAD,button:i,pad:t}]},Yt.prototype.registerAxis=function(n){var a=n.name;this._axes[a]||(this._axes[a]=[]);var r=this._axes[a].push(a);(n=n||{}).pad=n.pad||te.PAD_1;var e=function(t,e,i,s){switch(e){case"mousex":t._mouse.on(te.EVENT_MOUSEMOVE,function(e){t._axesValues[a][r]=e.dx/10});break;case"mousey":t._mouse.on(te.EVENT_MOUSEMOVE,function(e){t._axesValues[a][r]=e.dy/10});break;case"key":t._axes[a].push(function(){return t._keyboard.isPressed(s)?i:0});break;case"padrx":t._axes[a].push(function(){return t._gamepads.getAxis(n.pad,te.PAD_R_STICK_X)});break;case"padry":t._axes[a].push(function(){return t._gamepads.getAxis(n.pad,te.PAD_R_STICK_Y)});break;case"padlx":t._axes[a].push(function(){return t._gamepads.getAxis(n.pad,te.PAD_L_STICK_X)});break;case"padly":t._axes[a].push(function(){return t._gamepads.getAxis(n.pad,te.PAD_L_STICK_Y)});break;default:throw Error("Unknown axis")}};e(this,n.positive,1,n.positiveKey),(n.negativeKey||n.negative!==n.positive)&&e(this,n.negative,-1,n.negativeKey)},Yt.prototype.isPressed=function(e){if(!this._actions[e])return!1;var t,i,s=this._actions[e].length;for(i=0;i<s;++i)switch(t=this._actions[e][i],t.type){case te.ACTION_KEYBOARD:if(this._keyboard){var n,a=t.keys.length;for(n=0;n<a;n++)if(this._keyboard.isPressed(t.keys[n]))return!0}break;case te.ACTION_MOUSE:if(this._mouse&&this._mouse.isPressed(t.button))return!0;break;case te.ACTION_GAMEPAD:if(this._gamepads&&this._gamepads.isPressed(t.pad,t.button))return!0}return!1},Yt.prototype.wasPressed=function(e){if(!this._actions[e])return!1;var t,i=this._actions[e].length;for(t=0;t<i;++t){var s=this._actions[e][t];switch(s.type){case te.ACTION_KEYBOARD:if(this._keyboard){var n,a=s.keys.length;for(n=0;n<a;n++)if(this._keyboard.wasPressed(s.keys[n]))return!0}break;case te.ACTION_MOUSE:if(this._mouse&&this._mouse.wasPressed(s.button))return!0;break;case te.ACTION_GAMEPAD:if(this._gamepads&&this._gamepads.wasPressed(s.pad,s.button))return!0}}return!1},Yt.prototype.getAxis=function(e){var t=0;if(this._axes[e]){var i,s=this._axes[e].length;for(i=0;i<s;i++)if("function"===te.type(this._axes[e][i])){var n=this._axes[e][i]();Math.abs(n)>Math.abs(t)&&(t=n)}else this._axesValues[e]&&Math.abs(this._axesValues[e][i])>Math.abs(t)&&(t=this._axesValues[e][i])}return t},Yt.prototype._enableMouse=function(){if(this._mouse=new te.Mouse,!this._element)throw Error("Controller must be attached to an Element");this._mouse.attach(this._element)},Yt.prototype._enableKeyboard=function(){if(this._keyboard=new te.Keyboard,!this._element)throw Error("Controller must be attached to an Element");this._keyboard.attach(this._element)},{Controller:Yt})),Object.assign(te,function(){var r,o,u=new te.Vec3,p=new te.Vec3,s=new te.Vec3,n=new te.Vec3,a=new te.Vec3,h=new te.Vec3,l=new te.Vec3,c=new te.Vec3,d=new te.Vec3,i=new te.Vec2,f=new te.Vec3,m=new te.Vec3,_=new te.Vec3,g=new te.Vec3,y=new te.Vec3,v=new te.Vec3,b=new te.Vec3,S=new te.Vec3,T=new te.Vec4,E=function(e,t,i){if(s.sub2(t,e),n.sub2(i[0],e),a.sub2(i[1],e),h.sub2(i[2],e),c.cross(h,s),0<=n.dot(c)){if(-a.dot(c)<0||d.cross(s,a).dot(n)<0)return!1}else if(l.sub2(i[3],e),l.dot(c)<0||d.cross(s,n).dot(l)<0)return!1;return!(s.sub2(i[0],i[2]).lengthSq()<1e-8||s.sub2(i[1],i[3]).lengthSq()<1e-8)},x=function(e,t,i){this.event=e,this.element=t,this.camera=i,this._stopPropagation=!1};Object.assign(x.prototype,{stopPropagation:function(){this._stopPropagation=!0,this.event.stopImmediatePropagation(),this.event.stopPropagation()}});var A=function(e,t,i,s,n,a,r){x.call(this,e,t,i),this.x=s,this.y=n,this.ctrlKey=e.ctrlKey||!1,this.altKey=e.altKey||!1,this.shiftKey=e.shiftKey||!1,this.metaKey=e.metaKey||!1,this.button=e.button,te.Mouse.isPointerLocked()?(this.dx=e.movementX||e.webkitMovementX||e.mozMovementX||0,this.dy=e.movementY||e.webkitMovementY||e.mozMovementY||0):(this.dx=s-a,this.dy=n-r),this.wheel=e.detail?-1*e.detail:e.wheelDelta?e.wheelDelta/120:0};(A.prototype=Object.create(x.prototype)).constructor=A;var M=function(e,t,i,s,n,a){x.call(this,e,t,i),this.touches=e.touches,this.changedTouches=e.changedTouches,this.x=s,this.y=n};(M.prototype=Object.create(x.prototype)).constructor=M;var e=function(e,t){this._app=null,this._attached=!1,this._target=null,this._enabled=!0,this._lastY=this._lastX=0,this._upHandler=this._handleUp.bind(this),this._downHandler=this._handleDown.bind(this),this._moveHandler=this._handleMove.bind(this),this._wheelHandler=this._handleWheel.bind(this),this._touchstartHandler=this._handleTouchStart.bind(this),this._touchcancelHandler=this._touchendHandler=this._handleTouchEnd.bind(this),this._touchmoveHandler=this._handleTouchMove.bind(this),this._sortHandler=this._sortElements.bind(this),this._elements=[],this._pressedElement=this._hoveredElement=null,this._touchedElements={},this._touchesForWhichTouchLeaveHasFired={},this._useMouse=!t||!1!==t.useMouse,this._useTouch=!t||!1!==t.useTouch,te.platform.touch&&(this._clickedEntities={}),this.attach(e,t)};return Object.assign(e.prototype,{attach:function(e){this._attached&&(this._attached=!1,this.detach()),this._target=e,this._attached=!0,this._useMouse&&(window.addEventListener("mouseup",this._upHandler,{passive:!0}),window.addEventListener("mousedown",this._downHandler,{passive:!0}),window.addEventListener("mousemove",this._moveHandler,{passive:!0}),window.addEventListener("mousewheel",this._wheelHandler,{passive:!0}),window.addEventListener("DOMMouseScroll",this._wheelHandler,{passive:!0})),this._useTouch&&te.platform.touch&&(this._target.addEventListener("touchstart",this._touchstartHandler,{passive:!0}),this._target.addEventListener("touchend",this._touchendHandler,!1),this._target.addEventListener("touchmove",this._touchmoveHandler,!1),this._target.addEventListener("touchcancel",this._touchcancelHandler,!1))},detach:function(){this._attached&&(this._attached=!1,this._useMouse&&(window.removeEventListener("mouseup",this._upHandler,!1),window.removeEventListener("mousedown",this._downHandler,!1),window.removeEventListener("mousemove",this._moveHandler,!1),window.removeEventListener("mousewheel",this._wheelHandler,!1),window.removeEventListener("DOMMouseScroll",this._wheelHandler,!1)),this._useTouch&&(this._target.removeEventListener("touchstart",this._touchstartHandler,!1),this._target.removeEventListener("touchend",this._touchendHandler,!1),this._target.removeEventListener("touchmove",this._touchmoveHandler,!1),this._target.removeEventListener("touchcancel",this._touchcancelHandler,!1)),this._target=null)},addElement:function(e){-1===this._elements.indexOf(e)&&this._elements.push(e)},removeElement:function(e){-1!==(e=this._elements.indexOf(e))&&this._elements.splice(e,1)},_handleUp:function(e){this._enabled&&!te.Mouse.isPointerLocked()&&(this._calcMouseCoords(e),null!==r&&this._onElementMouseEvent(e))},_handleDown:function(e){this._enabled&&!te.Mouse.isPointerLocked()&&(this._calcMouseCoords(e),null!==r&&this._onElementMouseEvent(e))},_handleMove:function(e){this._enabled&&(this._calcMouseCoords(e),null!==r&&(this._onElementMouseEvent(e),this._lastX=r,this._lastY=o))},_handleWheel:function(e){this._enabled&&(this._calcMouseCoords(e),null!==r&&this._onElementMouseEvent(e))},_determineTouchedElements:function(e){var t,i,s,n={},a=this.app.systems.camera.cameras;for(t=a.length-1;0<=t;t--){var r=a[t],o=0;for(i=0,s=e.changedTouches.length;i<s;i++)if(n[e.changedTouches[i].identifier])o++;else{var h=this._calcTouchCoords(e.changedTouches[i]),l=this._getTargetElement(r,h.x,h.y);l&&(o++,n[e.changedTouches[i].identifier]={element:l,camera:r,x:h.x,y:h.y})}if(o===s)break}return n},_handleTouchStart:function(e){if(this._enabled){for(var t=this._determineTouchedElements(e),i=0,s=e.changedTouches.length;i<s;i++){var n=e.changedTouches[i],a=t[n.identifier],r=this._touchedElements[n.identifier];!a||r&&a.element===r.element||(this._fireEvent(e.type,new M(e,a.element,a.camera,a.x,a.y,this)),this._touchesForWhichTouchLeaveHasFired[n.identifier]=!1)}for(var o in t)this._touchedElements[o]=t[o]}},_handleTouchEnd:function(e){if(this._enabled){var t,i=this.app.systems.camera.cameras;for(t in this._clickedEntities)delete this._clickedEntities[t];t=0;for(var s=e.changedTouches.length;t<s;t++){var n=e.changedTouches[t];if(h=this._touchedElements[n.identifier]){var a=h.element,r=h.camera,o=h.x,h=h.y;if(delete this._touchedElements[n.identifier],delete this._touchesForWhichTouchLeaveHasFired[n.identifier],this._fireEvent(e.type,new M(e,a,r,o,h,this)),0===e.touches.length){n=this._calcTouchCoords(n);for(var l=i.length-1;0<=l;l--)this._getTargetElement(i[l],n.x,n.y)!==a||this._clickedEntities[a.entity.getGuid()]||(this._fireEvent("click",new M(e,a,r,o,h,this)),this._clickedEntities[a.entity.getGuid()]=!0)}}}}},_handleTouchMove:function(e){if(e.preventDefault(),this._enabled)for(var t=this._determineTouchedElements(e),i=0,s=e.changedTouches.length;i<s;i++){var n=e.changedTouches[i],a=t[n.identifier],r=this._touchedElements[n.identifier];if(r){var o=this._calcTouchCoords(n);a&&a.element===r.element||this._touchesForWhichTouchLeaveHasFired[n.identifier]||(this._fireEvent("touchleave",new M(e,r.element,r.camera,o.x,o.y,this)),this._touchesForWhichTouchLeaveHasFired[n.identifier]=!0),this._fireEvent("touchmove",new M(e,r.element,r.camera,o.x,o.y,this))}}},_onElementMouseEvent:function(e){var t,i=this._hoveredElement;this._hoveredElement=null;for(var s,n=this.app.systems.camera.cameras,a=n.length-1;0<=a&&(s=n[a],!(t=this._getTargetElement(s,r,o)));a--);t&&(this._fireEvent(e.type,new A(e,t,s,r,o,this._lastX,this._lastY)),this._hoveredElement=t,e.type===te.EVENT_MOUSEDOWN&&(this._pressedElement=t)),i!==this._hoveredElement&&(i&&this._fireEvent("mouseleave",new A(e,i,s,r,o,this._lastX,this._lastY)),this._hoveredElement&&this._fireEvent("mouseenter",new A(e,this._hoveredElement,s,r,o,this._lastX,this._lastY))),e.type===te.EVENT_MOUSEUP&&this._pressedElement&&(this._pressedElement===this._hoveredElement?(this._pressedElement=null,this._clickedEntities&&this._clickedEntities[this._hoveredElement.entity.getGuid()]||this._fireEvent("click",new A(e,this._hoveredElement,s,r,o,this._lastX,this._lastY))):this._pressedElement=null)},_fireEvent:function(e,t){for(var i=t.element;(i.fire(e,t),!t._stopPropagation)&&i.entity.parent&&(i=i.entity.parent.element););},_calcMouseCoords:function(e){var t=this._target.getBoundingClientRect(),i=Math.floor(t.left);t=Math.floor(t.top);o=e.clientX<i||e.clientX>=i+this._target.clientWidth||e.clientY<t||e.clientY>=t+this._target.clientHeight?r=null:(r=e.clientX-i,e.clientY-t)},_calcTouchCoords:function(e){for(var t=0,i=0,s=e.target;!(s instanceof HTMLElement);)s=s.parentNode;for(;t+=s.offsetLeft-s.scrollLeft,i+=s.offsetTop-s.scrollTop,s=s.offsetParent;);return{x:e.pageX-t,y:e.pageY-i}},_sortElements:function(e,t){var i=this.app.scene.layers.sortTransparentLayers(e.layers,t.layers);return 0!==i?i:e.screen&&!t.screen?-1:!e.screen&&t.screen?1:e.screen||t.screen?e.screen.screen.screenSpace&&!t.screen.screen.screenSpace?-1:t.screen.screen.screenSpace&&!e.screen.screen.screenSpace?1:t.drawOrder-e.drawOrder:0},_getTargetElement:function(e,t,i){var s=null;this._elements.sort(this._sortHandler);for(var n=0,a=this._elements.length;n<a;n++){var r=this._elements[n];if(r.screen&&r.screen.screen.screenSpace){if(this._checkElement2d(t,i,r,e)){s=r;break}}else if(this._checkElement3d(t,i,r,e)){s=r;break}}return s},_buildHitCorners:function(e,t,i,s){if(e.entity&&e.entity.button){var n=e.entity.button.hitPadding||T;f.copy(e.entity.up),m.copy(f).scale(-1),g.copy(e.entity.right),_.copy(g).scale(-1),f.scale(n.w*s),m.scale(n.y*s),g.scale(n.z*i),_.scale(n.x*i),y.copy(t[0]).add(m).add(_),v.copy(t[1]).add(m).add(g),b.copy(t[2]).add(f).add(g),S.copy(t[3]).add(f).add(_),t=[y,v,b,S]}return t},_calculateScaleToScreen:function(e){var t=e.entity;for(e=e.screen.screen.scale,i.set(e,e);t&&!t.screen;)i.mul(t.getLocalScale()),t=t.parent;return i},_checkElement2d:function(e,t,i,s){if(i.maskedBy&&!this._checkElement2d(e,t,i.maskedBy.element,s))return!1;var n=this.app.graphicsDevice.width,a=this.app.graphicsDevice.height,r=s.rect.z*n,o=s.rect.w*a,h=s.rect.x*n,l=(s=(1-s.rect.y)*a)-o;return e=e*n/this._target.clientWidth,t=t*a/this._target.clientHeight,!!(h<=e&&e<=h+r&&t<=s&&l<=t&&(e=n*(e-h)/r,t=a-a*(t-l)/o,n=this._calculateScaleToScreen(i),i=this._buildHitCorners(i,i.screenCorners,n.x,n.y),u.set(e,t,1),p.set(e,t,-1),E(u,p,i)))},_checkElement3d:function(e,t,i,s){if(i.maskedBy&&!this._checkElement3d(e,t,i.maskedBy.element,s))return!1;var n=this._target.clientWidth,a=this._target.clientHeight,r=s.rect.z*n,o=s.rect.w*a,h=s.rect.x*n,l=(1-s.rect.y)*a,c=l-o,d=t;return!!(h<=e&&e<=h+r&&t<=l&&c<=d&&(e=n*(e-h)/r,d=a*(d-c)/o,a=i.entity.getWorldTransform().getScale(),i=this._buildHitCorners(i,i.worldCorners,a.x,a.y),s.screenToWorld(e,d,s.nearClip,u),s.screenToWorld(e,d,s.farClip,p),E(u,p,i)))}}),Object.defineProperty(e.prototype,"enabled",{get:function(){return this._enabled},set:function(e){this._enabled=e}}),Object.defineProperty(e.prototype,"app",{get:function(){return this._app||te.app},set:function(e){this._app=e}}),{ElementInput:e,ElementInputEvent:x,ElementMouseEvent:A,ElementTouchEvent:M}}()),Object.assign(te,((Xt=function(e){te.events.attach(this);var s=this;this.isSupported=Xt.isSupported,this.usesPolyfill=Xt.usesPolyfill,window.InitializeWebVRPolyfill&&window.InitializeWebVRPolyfill(),this._index={},this.displays=[],this.display=null,this._app=e,this._onDisplayConnect=this._onDisplayConnect.bind(this),this._onDisplayDisconnect=this._onDisplayDisconnect.bind(this),s._attach(),this._getDisplays(function(e,t){if(e)s.fire("error",e);else{for(var i=0;i<t.length;i++)s._addDisplay(t[i]);s.fire("ready",s.displays)}})}).isSupported=!!navigator.getVRDisplays,Xt.usesPolyfill=!!window.InitializeWebVRPolyfill,Object.assign(Xt.prototype,{_attach:function(){window.addEventListener("vrdisplayconnect",this._onDisplayConnect),window.addEventListener("vrdisplaydisconnect",this._onDisplayDisconnect)},_detach:function(){window.removeEventListener("vrdisplayconnect",this._onDisplayConnect),window.removeEventListener("vrdisplaydisconnect",this._onDisplayDisconnect)},destroy:function(){this._detach()},poll:function(){var e=this.displays.length;if(e)for(var t=0;t<e;t++)this.displays[t]._camera&&this.displays[t].poll()},_getDisplays:function(t){navigator.getVRDisplays?navigator.getVRDisplays().then(function(e){t&&t(null,e)}):t&&t(Error("WebVR not supported"))},_addDisplay:function(e){this._index[e.displayId]||(e=new te.VrDisplay(this._app,e),this._index[e.id]=e,this.displays.push(e),this.display||(this.display=e),this.fire("displayconnect",e))},_onDisplayConnect:function(e){e.detail&&e.detail.display?this._addDisplay(e.detail.display):this._addDisplay(e.display)},_onDisplayDisconnect:function(e){if(e=this._index[e.detail&&e.detail.display?e.detail.display.displayId:e.display.displayId]){e.destroy(),delete this._index[e.id];var t=this.displays.indexOf(e);this.displays.splice(t,1),this.display===e&&(this.display=this.displays.length?this.displays[0]:null),this.fire("displaydisconnect",e)}}}),{VrManager:Xt})),Object.assign(te,(qt=function(e,t){var i=this;this._app=e,this._device=e.graphicsDevice,this.id=t.displayId,this._frameData=null,window.VRFrameData&&(this._frameData=new window.VRFrameData),this.display=t,this._camera=null,this.sitToStandInv=new te.Mat4,this.leftView=new te.Mat4,this.leftProj=new te.Mat4,this.leftViewInv=new te.Mat4,this.leftPos=new te.Vec3,this.rightView=new te.Mat4,this.rightProj=new te.Mat4,this.rightViewInv=new te.Mat4,this.rightPos=new te.Vec3,this.combinedPos=new te.Vec3,this.combinedView=new te.Mat4,this.combinedProj=new te.Mat4,this.combinedViewInv=new te.Mat4,this.combinedAspect=this.combinedFov=0,this.presenting=!1,i._presentChange=function(e){if((e.display?e.display:e.detail&&e.detail.display?e.detail.display:e.detail&&e.detail.vrdisplay?e.detail.vrdisplay:i.display)===i.display){if(i.presenting=i.display&&i.display.isPresenting,i.presenting){e=i.display.getEyeParameters("left");var t=i.display.getEyeParameters("right");i._app.graphicsDevice.setResolution(2*Math.max(e.renderWidth,t.renderWidth),Math.max(e.renderHeight,t.renderHeight)),i._app._allowResize=!1}else i._app.setCanvasResolution(te.RESOLUTION_AUTO),i._app._allowResize=!0;i.fire("beforepresentchange",i),i.fire("presentchange",i)}},window.addEventListener("vrdisplaypresentchange",i._presentChange,!1),te.events.attach(this)},Object.assign(qt.prototype,{destroy:function(){window.removeEventListener("vrdisplaypresentchange",self._presentChange),this._camera&&(this._camera.vrDisplay=null),this._camera=null},poll:function(){if(this.display){this.display.getFrameData(this._frameData),this.leftProj.data=this._frameData.leftProjectionMatrix,this.rightProj.data=this._frameData.rightProjectionMatrix,(s=this.display.stageParameters)?(this.sitToStandInv.set(s.sittingToStandingTransform).invert(),this.combinedView.set(this._frameData.leftViewMatrix),this.leftView.mul2(this.combinedView,this.sitToStandInv),this.combinedView.set(this._frameData.rightViewMatrix),this.rightView.mul2(this.combinedView,this.sitToStandInv)):(this.leftView.set(this._frameData.leftViewMatrix),this.rightView.set(this._frameData.rightViewMatrix));var e=this.leftProj.data[3]+this.leftProj.data[0],t=this.leftProj.data[11]+this.leftProj.data[8],i=1/Math.sqrt(e*e+t*t),s=-Math.atan2(t*i,e*i);e=this.rightProj.data[3]+this.rightProj.data[0],t=this.rightProj.data[11]+this.rightProj.data[8],i=1/Math.sqrt(e*e+t*t),s=Math.max(s,-Math.atan2(t*i,e*i)),this.combinedFov=s*=2,this.combinedAspect=e=this.rightProj.data[5]/this.rightProj.data[0],(t=this.combinedView).copy(this.leftView),t.invert(),this.leftViewInv.copy(t),(i=this.combinedPos).x=this.leftPos.x=t.data[12],i.y=this.leftPos.y=t.data[13],i.z=this.leftPos.z=t.data[14],t.copy(this.rightView),t.invert(),this.rightViewInv.copy(t);var n=i.x-t.data[12],a=i.y-t.data[13],r=i.z-t.data[14];n=Math.sqrt(n*n+a*a+r*r),this.rightPos.x=t.data[12],this.rightPos.y=t.data[13],this.rightPos.z=t.data[14],i.x+=t.data[12],i.y+=t.data[13],i.z+=t.data[14],i.x*=.5,i.y*=.5,i.z*=.5,n=.5*n*Math.sin(Math.PI-(.5*Math.PI+.5*s)),a=t.data[9],r=t.data[10],t.data[12]=i.x+t.data[8]*n,t.data[13]=i.y+a*n,t.data[14]=i.z+r*n,this.combinedViewInv.copy(t),t.invert(),this.combinedProj.setPerspective(s*te.math.RAD_TO_DEG,e,this.display.depthNear+n,this.display.depthFar+n,!0)}},requestPresent:function(t){this.display?this.presenting?t&&t(Error("VrDisplay already presenting")):this.display.requestPresent([{source:this._device.canvas}]).then(function(){t&&t()},function(e){t&&t(e)}):t&&t(Error("No VrDisplay to requestPresent"))},exitPresent:function(e){this.display||e&&e(Error("No VrDisplay to exitPresent")),this.presenting?this.display.exitPresent().then(function(){e&&e()},function(){e&&e(Error("exitPresent failed"))}):e&&e(Error("VrDisplay not presenting"))},requestAnimationFrame:function(e){this.display&&this.display.requestAnimationFrame(e)},submitFrame:function(){this.display&&this.display.submitFrame()},reset:function(){this.display&&this.display.resetPose()},setClipPlanes:function(e,t){this.display&&(this.display.depthNear=e,this.display.depthFar=t)},getFrameData:function(){if(this.display)return this._frameData}}),Object.defineProperty(qt.prototype,"capabilities",{get:function(){return this.display?this.display.capabilities:{}}}),{VrDisplay:qt})),Object.assign(te,((Kt=function(){}).ContentType={FORM_URLENCODED:"application/x-www-form-urlencoded",GIF:"image/gif",JPEG:"image/jpeg",DDS:"image/dds",JSON:"application/json",PNG:"image/png",TEXT:"text/plain",XML:"application/xml",WAV:"audio/x-wav",OGG:"audio/ogg",MP3:"audio/mpeg",MP4:"audio/mp4",AAC:"audio/aac",BIN:"application/octet-stream"},Kt.ResponseType={TEXT:"text",ARRAY_BUFFER:"arraybuffer",BLOB:"blob",DOCUMENT:"document",JSON:"json"},Kt.binaryExtensions=".model .wav .ogg .mp3 .mp4 .m4a .aac .dds".split(" "),Kt.retryDelay=100,Object.assign(Kt.prototype,{ContentType:Kt.ContentType,ResponseType:Kt.ResponseType,binaryExtensions:Kt.binaryExtensions,get:function(e,t,i){return"function"==typeof t&&(i=t,t={}),this.request("GET",e,t,i)},post:function(e,t,i,s){return"function"==typeof i&&(s=i,i={}),i.postdata=t,this.request("POST",e,i,s)},put:function(e,t,i,s){return"function"==typeof i&&(s=i,i={}),i.postdata=t,this.request("PUT",e,i,s)},del:function(e,t,i){return"function"==typeof t&&(i=t,t={}),this.request("DELETE",e,t,i)},request:function(e,t,i,s){var n,a,r,o=!1;if("function"==typeof i&&(s=i,i={}),i.retry&&(i=Object.assign({retries:0,maxRetries:5},i)),i.callback=s,null==i.async&&(i.async=!0),null==i.headers&&(i.headers={}),null!=i.postdata)if(i.postdata instanceof Document)a=i.postdata;else if(i.postdata instanceof FormData)a=i.postdata;else if(i.postdata instanceof Object)switch(a=i.headers["Content-Type"],void 0===a&&(i.headers["Content-Type"]=Kt.ContentType.FORM_URLENCODED,a=i.headers["Content-Type"]),a){case Kt.ContentType.FORM_URLENCODED:for(n in s=!(a=""),i.postdata)i.postdata.hasOwnProperty(n)&&(s?s=!1:a+="&",a+=escape(n)+"="+escape(i.postdata[n]));break;default:case Kt.ContentType.JSON:null==a&&(i.headers["Content-Type"]=Kt.ContentType.JSON),a=JSON.stringify(i.postdata)}else a=i.postdata;for(var h in!1===i.cache&&(s=te.time.now(),(n=new te.URI(t)).query=n.query?n.query+"&ts="+s:"ts="+s,t=n.toString()),i.query&&(n=new te.URI(t),s=te.extend(n.getQuery(),i.query),n.setQuery(s),t=n.toString()),(r=new XMLHttpRequest).open(e,t,i.async),r.withCredentials=void 0!==i.withCredentials&&i.withCredentials,r.responseType=i.responseType||this._guessResponseType(t),i.headers)i.headers.hasOwnProperty(h)&&r.setRequestHeader(h,i.headers[h]);r.onreadystatechange=function(){this._onReadyStateChange(e,t,i,r)}.bind(this),r.onerror=function(){this._onError(e,t,i,r),o=!0}.bind(this);try{r.send(a)}catch(e){o||i.error(r.status,r,e)}return r},_guessResponseType:function(e){return e=new te.URI(e),e=te.path.getExtension(e.path),0<=Kt.binaryExtensions.indexOf(e)?Kt.ResponseType.ARRAY_BUFFER:".xml"===e?Kt.ResponseType.DOCUMENT:Kt.ResponseType.TEXT},_isBinaryContentType:function(e){return 0<=[Kt.ContentType.MP4,Kt.ContentType.WAV,Kt.ContentType.OGG,Kt.ContentType.MP3,Kt.ContentType.BIN,Kt.ContentType.DDS].indexOf(e)},_onReadyStateChange:function(e,t,i,s){if(4===s.readyState)switch(s.status){case 0:"/"!=t[0]?this._onSuccess(e,t,i,s):this._onError(e,t,i,s);break;case 200:case 201:case 206:case 304:this._onSuccess(e,t,i,s);break;default:this._onError(e,t,i,s)}},_onSuccess:function(e,t,i,s){var n,a;(e=s.getResponseHeader("Content-Type"))&&(a=(a=e.split(";"))[0].trim());try{n=a===this.ContentType.JSON||t.split("?")[0].endsWith(".json")?JSON.parse(s.responseText):this._isBinaryContentType(a)?s.response:(a&&Ie(te.string.format("responseType: {0} being served with Content-Type: {1}",s.responseType,a)),s.responseType===Kt.ResponseType.ARRAY_BUFFER?s.response:s.responseType===Kt.ResponseType.BLOB||s.responseType===Kt.ResponseType.JSON?s.response:s.responseType===Kt.ResponseType.DOCUMENT||a===this.ContentType.XML?s.responseXML:s.responseText),i.callback(null,n)}catch(e){i.callback(e)}},_onError:function(e,t,i,s){if(!i.retrying)if(i.retry&&i.retries<i.maxRetries){i.retries++,i.retrying=!0;var n=te.math.clamp(Math.pow(2,i.retries)*Kt.retryDelay,0,i.maxRetryDelay||5e3);setTimeout(function(){i.retrying=!1,this.request(e,t,i,i.callback)}.bind(this),n)}else i.callback(0===s.status?"Network error":s.status,null)}}),{Http:Kt,http:new Kt})),Object.assign(te,((Zt=function(e){te.events.attach(this),this.app=e,this._scripts={},this._list=[]}).prototype.destroy=function(){this.app=null,this.off()},Zt.prototype.add=function(a){var r=this;return this._scripts.hasOwnProperty(a.__name)?(setTimeout(function(){if(a.prototype.swap){var e=r._list.indexOf(r._scripts[a.__name]);r._list[e]=a,r._scripts[a.__name]=a,r.fire("swap",a.__name,a),r.fire("swap:"+a.__name,a)}}),!1):(this._scripts[a.__name]=a,this._list.push(a),this.fire("add",a.__name,a),this.fire("add:"+a.__name,a),setTimeout(function(){if(r._scripts.hasOwnProperty(a.__name)&&r.app&&r.app.systems&&r.app.systems.script){var e,t,i=r.app.systems.script._components,s=[],n=[];for(i.loopIndex=0;i.loopIndex<i.length;i.loopIndex++)(e=i.items[i.loopIndex])._scriptsIndex[a.__name]&&e._scriptsIndex[a.__name].awaiting&&(e._scriptsData&&e._scriptsData[a.__name]&&(t=e._scriptsData[a.__name].attributes),(e=e.create(a.__name,{preloading:!0,ind:e._scriptsIndex[a.__name].ind,attributes:t}))&&s.push(e));for(i=0;i<s.length;i++)s[i].__initializeAttributes();for(i=0;i<s.length;i++)s[i].enabled&&(s[i]._initialized=!0,n.push(s[i]),s[i].initialize&&s[i].initialize());for(i=0;i<n.length;i++)n[i].enabled&&!n[i]._postInitialized&&(n[i]._postInitialized=!0,n[i].postInitialize&&n[i].postInitialize())}}),!0)},Zt.prototype.remove=function(e){if("function"==typeof e&&(e=e.__name),!this._scripts.hasOwnProperty(e))return!1;var t=this._scripts[e];delete this._scripts[e];var i=this._list.indexOf(t);return this._list.splice(i,1),this.fire("remove",e,t),this.fire("remove:"+e,t),!0},Zt.prototype.get=function(e){return this._scripts[e]||null},Zt.prototype.has=function(e){return this._scripts.hasOwnProperty(e)},Zt.prototype.list=function(){return this._list},{ScriptRegistry:Zt})),Object.assign(te,function(){var n=["x","y","z","w"],r=function(e,t,i,s){switch(t.type){case"boolean":return!!i;case"number":if("number"==typeof i)break;return"string"==typeof i?(i=parseInt(i,10),isNaN(i)?null:i):"boolean"==typeof i?0+i:null;case"json":if("object"==typeof i)break;try{return JSON.parse(i)}catch(e){return null}case"asset":if(i instanceof te.Asset)break;return"number"==typeof i?e.assets.get(i)||null:"string"==typeof i&&e.assets.get(parseInt(i,10))||null;case"entity":if(i instanceof te.GraphNode)break;return"string"==typeof i?e.root.findByGuid(i):null;case"rgb":case"rgba":if(i instanceof te.Color)return s instanceof te.Color?(s.copy(i),s):i.clone();if(i instanceof Array&&3<=i.length&&i.length<=4){for(e=0;e<i.length;e++)if("number"!=typeof i[e])return null;return s||(s=new te.Color),s.r=i[0],s.g=i[1],s.b=i[2],s.a=3===i.length?1:i[3],s}return"string"==typeof i&&/#([0-9abcdef]{2}){3,4}/i.test(i)?(s||(s=new te.Color),s.fromString(i),s):null;case"vec2":case"vec3":case"vec4":if(t=parseInt(t.type.slice(3),10),i instanceof te["Vec"+t])return s instanceof te["Vec"+t]?(s.copy(i),s):i.clone();if(i instanceof Array&&i.length===t){for(e=0;e<i.length;e++)if("number"!=typeof i[e])return null;for(s||(s=new te["Vec"+t]),e=0;e<t;e++)s[n[e]]=i[e];return s}return null;case"curve":if(i)return i instanceof te.Curve||i instanceof te.CurveSet?s=i.clone():(s=new(i.keys[0]instanceof Array?te.CurveSet:te.Curve)(i.keys)).type=i.type,s}return i},s=function(e){this.scriptType=e,this.index={}};s.prototype.add=function(n,a){this.index[n]||te.createScript.reservedAttributes[n]||(this.index[n]=a,Object.defineProperty(this.scriptType.prototype,n,{get:function(){return this.__attributes[n]},set:function(e){var t,i,s=this.__attributes[n];if(a.array){if(this.__attributes[n]=[],e)for(t=0,i=e.length;t<i;t++)this.__attributes[n].push(r(this.app,a,e[t],s?s[t]:null))}else this.__attributes[n]=r(this.app,a,e,s);this.fire("attr",n,this.__attributes[n],s),this.fire("attr:"+n,this.__attributes[n],s)}}))},s.prototype.remove=function(e){return!!this.index[e]&&(delete this.index[e],delete this.scriptType.prototype[e],!0)},s.prototype.has=function(e){return!!this.index[e]},s.prototype.get=function(e){return this.index[e]||null};var a=function(e,t){if(te.script.legacy)return null;if(a.reservedScripts[e])throw Error("script name: '"+e+"' is reserved, please change script name");var i=function(e){te.events.attach(this),this.app=e.app,this.entity=e.entity,this._enabled="boolean"!=typeof e.enabled||e.enabled,this._enabledOld=this.enabled,this.__destroyed=!1,this.__attributes={},this.__attributesRaw=e.attributes||{},this.__scriptType=i,this.__executionOrder=-1};return i.__name=e,i.attributes=new s(i),i.prototype.__initializeAttributes=function(e){if(e||this.__attributesRaw){for(var t in i.attributes.index)this.__attributesRaw&&this.__attributesRaw.hasOwnProperty(t)?this[t]=this.__attributesRaw[t]:this.__attributes.hasOwnProperty(t)||(i.attributes.index[t].hasOwnProperty("default")?this[t]=i.attributes.index[t].default:this[t]=null);this.__attributesRaw=null}},i.extend=function(e){for(var t in e)e.hasOwnProperty(t)&&(i.prototype[t]=e[t])},Object.defineProperty(i.prototype,"enabled",{get:function(){return this._enabled&&!this._destroyed&&this.entity.script.enabled&&this.entity.enabled},set:function(e){this._enabled=!!e,this.enabled!==this._enabledOld&&(this._enabledOld=this.enabled,this.fire(this.enabled?"enable":"disable"),this.fire("state",this.enabled),!this._initialized&&this.enabled&&(this._initialized=!0,this.__initializeAttributes(!0),this.initialize&&this.entity.script._scriptMethod(this,te.ScriptComponent.scriptMethods.initialize)),this._initialized&&!this._postInitialized&&this.enabled&&!this.entity.script._beingEnabled&&(this._postInitialized=!0,this.postInitialize&&this.entity.script._scriptMethod(this,te.ScriptComponent.scriptMethods.postInitialize)))}}),(t?t.scripts:te.Application.getApplication().scripts).add(i),te.ScriptHandler._push(i),i};a.reservedScripts="system entity create destroy swap move scripts _scripts _scriptsIndex _scriptsData enabled _oldState onEnable onDisable onPostStateChange _onSetEnabled _checkState _onBeforeRemove _onInitializeAttributes _onInitialize _onPostInitialize _onUpdate _onPostUpdate _callbacks has on off fire once hasEvent".split(" ");var e,t={};for(e=0;e<a.reservedScripts.length;e++)t[a.reservedScripts[e]]=1;for(a.reservedScripts=t,a.reservedAttributes="app entity enabled _enabled _enabledOld _destroyed __attributes __attributesRaw __scriptType __executionOrder _callbacks has on off fire once hasEvent".split(" "),t={},e=0;e<a.reservedAttributes.length;e++)t[a.reservedAttributes[e]]=1;return a.reservedAttributes=t,{createScript:a}}()),Object.assign(te,((Qt=function(e){this._blobUrls={};for(var t=0,i=e.length;t<i;t++)e[t].url&&(this._blobUrls[e[t].name]=e[t].url)}).prototype.hasBlobUrl=function(e){return!!this._blobUrls[e]},Qt.prototype.getBlobUrl=function(e){return this._blobUrls[e]},Qt.prototype.destroy=function(){for(var e in this._blobUrls)URL.revokeObjectURL(this._blobUrls[e]);this._blobUrls=null},{Bundle:Qt})),Object.assign(te,($t=function(e){this._assets=e,this._bundleAssets={},this._assetsInBundles={},this._urlsInBundles={},this._fileRequests={},this._assets.on("add",this._onAssetAdded,this),this._assets.on("remove",this._onAssetRemoved,this)},Object.assign($t.prototype,{_onAssetAdded:function(e){if("bundle"===e.type){this._bundleAssets[e.id]=e,this._registerBundleEventListeners(e.id);for(var t=0,i=e.data.assets.length;t<i;t++)this._indexAssetInBundle(e.data.assets[t],e)}else this._assetsInBundles[e.id]&&this._indexAssetFileUrls(e)},_registerBundleEventListeners:function(e){this._assets.on("load:"+e,this._onBundleLoaded,this),this._assets.on("error:"+e,this._onBundleError,this)},_unregisterBundleEventListeners:function(e){this._assets.off("load:"+e,this._onBundleLoaded,this),this._assets.off("error:"+e,this._onBundleError,this)},_indexAssetInBundle:function(e,t){if(this._assetsInBundles[e]){var i=this._assetsInBundles[e];-1===i.indexOf(t)&&i.push(t)}else this._assetsInBundles[e]=[t];(i=this._assets.get(e))&&this._indexAssetFileUrls(i)},_indexAssetFileUrls:function(e){var t=this._getAssetFileUrls(e);if(t)for(var i=0,s=t.length;i<s;i++)this._urlsInBundles[t[i]]=this._assetsInBundles[e.id]},_getAssetFileUrls:function(e){if(!(t=e.getFileUrl()))return null;var t,i=[t=this._normalizeUrl(t)];if("font"===e.type){e=e.data.info.maps.length;for(var s=1;s<e;s++)i.push(t.replace(".png",s+".png"))}return i},_normalizeUrl:function(e){return e&&e.split("?")[0]},_onAssetRemoved:function(e){if("bundle"===e.type){var t,i;for(i in delete this._bundleAssets[e.id],this._unregisterBundleEventListeners(e.id),this._assetsInBundles){var s=this._assetsInBundles[i];if(-1!==(t=s.indexOf(e))&&(s.splice(t,1),!s.length))for(var n in delete this._assetsInBundles[i],this._urlsInBundles)this._urlsInBundles[n]===s&&delete this._urlsInBundles[n]}this._onBundleError("Bundle "+e.id+" was removed",e)}else if(this._assetsInBundles[e.id])for(delete this._assetsInBundles[e.id],t=0,i=(e=this._getAssetFileUrls(e)).length;t<i;t++)delete this._urlsInBundles[e[t]]},_onBundleLoaded:function(r){r.resource?requestAnimationFrame(function(){if(this._fileRequests)for(var e in this._fileRequests)if((t=this._urlsInBundles[e])&&-1!==t.indexOf(r)){var t=decodeURIComponent(e),i=null;r.resource.hasBlobUrl(t)||(i="Bundle "+r.id+" does not contain URL "+e);for(var s=this._fileRequests[e],n=0,a=s.length;n<a;n++)i?s[n](i):s[n](null,r.resource.getBlobUrl(t));delete this._fileRequests[e]}}.bind(this)):this._onBundleError("Bundle "+r.id+" failed to load",r)},_onBundleError:function(e,t){for(var i in this._fileRequests)if(!this._findLoadedOrLoadingBundleForUrl(i)){for(var s=this._fileRequests[i],n=0,a=s.length;n<a;n++)s[n](e);delete this._fileRequests[i]}},_findLoadedOrLoadingBundleForUrl:function(e){if(!(e=this._urlsInBundles[e]))return null;var t,i=e.length;for(t=0;t<i;t++)if(e[t].loaded&&e[t].resource)return e[t];for(t=0;t<i;t++)if(e[t].loading)return e[t];return null},listBundlesForAsset:function(e){return this._assetsInBundles[e.id]||null},list:function(){var e,t=[];for(e in this._bundleAssets)t.push(this._bundleAssets[e]);return t},hasUrl:function(e){return!!this._urlsInBundles[e]},canLoadUrl:function(e){return!!this._findLoadedOrLoadingBundleForUrl(e)},loadUrl:function(e,t){var i=this._findLoadedOrLoadingBundleForUrl(e);if(i)if(i.loaded){var s=decodeURIComponent(e);i.resource.hasBlobUrl(s)?t(null,i.resource.getBlobUrl(s)):t("Bundle "+i.id+" does not contain URL "+e)}else this._fileRequests.hasOwnProperty(e)?this._fileRequests[e].push(t):this._fileRequests[e]=[t];else t("URL "+e+" not found in any bundles")},destroy:function(){for(var e in this._assets.off("add",this._onAssetAdded,this),this._assets.off("remove",this._onAssetRemoved,this),this._bundleAssets)this._unregisterBundleEventListeners(e);this._fileRequests=this._urlsInBundles=this._assetsInBundles=this._bundleAssets=this._assets=null}}),{BundleRegistry:$t})),Object.assign(te,((Jt=function(){}).prototype._validate=function(e){if(!e.header)throw Error('pc.I18n#addData: Missing "header" field');if(!e.header.version)throw Error('pc.I18n#addData: Missing "header.version" field');if(1!==e.header.version)throw Error('pc.I18n#addData: Invalid "header.version" field');if(!e.data)throw Error('pc.I18n#addData: Missing "data" field');if(!Array.isArray(e.data))throw Error('pc.I18n#addData: "data" field must be an array');for(var t=0,i=e.data.length;t<i;t++){var s=e.data[t];if(!s.info)throw Error('pc.I18n#addData: missing "data['+t+'].info" field');if(!s.info.locale)throw Error('pc.I18n#addData: missing "data['+t+'].info.locale" field');if("string"!=typeof s.info.locale)throw Error('pc.I18n#addData: "data['+t+'].info.locale" must be a string');if(!s.messages)throw Error('pc.I18n#addData: missing "data['+t+'].messages" field')}},Jt.prototype.parse=function(e){return e.data},{I18nParser:Jt})),Object.assign(te,function(){var r={},h=function(e){var t=e.indexOf("-");return-1!==t?e.substring(0,t):e},n={en:"en-US",es:"en-ES",zh:"zh-CN",fr:"fr-FR",de:"de-DE",it:"it-IT",ru:"ru-RU",ja:"ja-JP"};(e=function(e,t){for(var i=0,s=e.length;i<s;i++)r[e[i]]=t})(["ja","ko","th","vi","zh"],function(e){return 0}),e(["fa","hi"],function(e){return 0<=e&&e<=1?0:1}),e(["fr"],function(e){return 0<=e&&e<2?0:1}),e("de en it el es tr".split(" "),function(e){return 1===e?0:1}),e(["ru","uk"],function(e){if(Number.isInteger(e)){var t=e%10;if(e%=100,1==t&&11!==e)return 0;if(2<=t&&t<=4&&(e<12||14<e))return 1;if(0==t||5<=t&&t<=9||11<=e&&e<=14)return 2}return 3}),e(["ar"],function(e){if(0===e)return 0;if(1===e)return 1;if(2===e)return 2;if(Number.isInteger(e)){if(3<=(e%=100)&&e<=10)return 3;if(11<=e&&e<=99)return 4}return 5});var e,o=r[h("en-US")];return(e=function(e){te.events.attach(this),this.locale="en-US",this._translations={},this._availableLangs={},this._app=e,this._assets=[],this._parser=new te.I18nParser}).findAvailableLocale=function(e,t){if(t[e])return e;var i=h(e),s=n[i];return t[s]?s:t[i]?i:"en-US"},e.prototype.getText=function(e,t){var i,s=e;t||(t=this._locale,i=this._lang);var n=this._translations[t];return n||(i||(i=h(t)),t=this._findFallbackLocale(i),n=this._translations[t]),n&&n.hasOwnProperty(e)&&(s=n[e],Array.isArray(s)&&(s=s[0]),null==s)&&(s=e),s},e.prototype.getPluralText=function(e,t,i){var s,n,a=e;return s=i?(n=h(i),r[n]||o):(i=this._locale,n=this._lang,this._pluralFn),(i=this._translations[i])||(i=this._findFallbackLocale(n),n=h(i),s=r[n]||o,i=this._translations[i]),i&&i[e]&&s&&(t=s(t),null==(a=i[e][t]))&&(a=e),a},e.prototype.addData=function(e){var t;try{t=this._parser.parse(e)}catch(e){return}e=0;for(var i=t.length;e<i;e++){var s=(n=t[e]).info.locale,n=n.messages;if(!this._translations[s]){this._translations[s]={};var a=h(s);this._availableLangs[a]||(this._availableLangs[a]=s)}Object.assign(this._translations[s],n),this.fire("data:add",s,n)}},e.prototype.removeData=function(e){var t,i;try{t=this._parser.parse(e)}catch(e){return}e=0;for(var s=t.length;e<s;e++){var n=t[e],a=n.info.locale,r=this._translations[a];if(r){for(i in n=n.messages)delete r[i];var o=!1;for(i in r){o=!0;break}o||(delete this._translations[a],delete this._availableLangs[h(a)]),this.fire("data:remove",a,n)}}},e.prototype.destroy=function(){this._parser=this._assets=this._availableLangs=this._translations=null,this.off()},Object.defineProperty(e.prototype,"locale",{get:function(){return this._locale},set:function(e){if(this._locale!==e){var t=this._locale;this._locale=e,this._lang=h(e),this._pluralFn=r[this._lang]||o,this.fire("set:locale",e,t)}}}),Object.defineProperty(e.prototype,"assets",{get:function(){return this._assets},set:function(e){var t,i,s,n={};for(t=0,i=e.length;t<i;t++)n[s=e[t]instanceof te.Asset?e[t].id:e[t]]=!0;for(t=this._assets.length;t--;)n[s=this._assets[t]]||(this._app.assets.off("add:"+s,this._onAssetAdd,this),(e=this._app.assets.get(s))&&this._onAssetRemove(e),this._assets.splice(t,1));for(s in n)s=parseInt(s,10),-1===this._assets.indexOf(s)&&(this._assets.push(s),(e=this._app.assets.get(s))?this._onAssetAdd(e):this._app.assets.once("add:"+s,this._onAssetAdd,this))}}),e.prototype._findFallbackLocale=function(e){var t=n[e];return t&&this._translations[t]?t:(t=this._availableLangs[e])&&this._translations[t]?t:"en-US"},e.prototype._onAssetAdd=function(e){e.on("load",this._onAssetLoad,this),e.on("change",this._onAssetChange,this),e.on("remove",this._onAssetRemove,this),e.on("unload",this._onAssetUnload,this),e.resource&&this._onAssetLoad(e)},e.prototype._onAssetLoad=function(e){this.addData(e.resource)},e.prototype._onAssetChange=function(e){e.resource&&this.addData(e.resource)},e.prototype._onAssetRemove=function(e){e.off("load",this._onAssetLoad,this),e.off("change",this._onAssetChange,this),e.off("remove",this._onAssetRemove,this),e.off("unload",this._onAssetUnload,this),e.resource&&this.removeData(e.resource),this._app.assets.once("add:"+e.id,this._onAssetAdd,this)},e.prototype._onAssetUnload=function(e){e.resource&&this.removeData(e.resource)},{I18n:e}}()),te.script=(ti=ei=!1,ii={app:null,create:function(e,t){if(ei){var i=t(te.script.app);i._pcScriptName=e,te.ScriptHandler._push(i),this.fire("created",e,t)}},attribute:function(e,t,i,s){},createLoadingScreen:function(e){ti||(ti=!0,e(te.Application.getApplication()))}},Object.defineProperty(ii,"legacy",{get:function(){return ei},set:function(e){ei=e}}),te.events.attach(ii),ii),Object.assign(te,function(){var a=function(e,t){t=t||{},te.log.open(),te.events.attach(this),a._applications[e.id]=this,a._currentApplication=this,(te.app=this)._time=0,this.timeScale=1,this.maxDeltaTime=.1,this.frame=0,this.autoRender=!0,this.renderNextFrame=!1,this.useLegacyScriptAttributeCloning=te.script.legacy,this._librariesLoaded=!1,this._fillMode=te.FILLMODE_KEEP_ASPECT,this._resolutionMode=te.RESOLUTION_FIXED,this._allowResize=!0,(this.context=this).graphicsDevice=new te.GraphicsDevice(e,t.graphicsDeviceOptions),this.stats=new te.ApplicationStats(this.graphicsDevice),this._audioManager=new te.SoundManager(t),this.loader=new te.ResourceLoader(this),this._entityIndex={},this.scene=new te.Scene,this.root=new te.Entity(this),this.root._enabledInHierarchy=!0,this._enableList=[],this._enableList.size=0,this.assets=new te.AssetRegistry(this.loader),t.assetPrefix&&(this.assets.prefix=t.assetPrefix),this.bundles=new te.BundleRegistry(this.assets),this.enableBundles="undefined"!=typeof TextDecoder,this.scriptsOrder=t.scriptsOrder||[],this.scripts=new te.ScriptRegistry(this),this.i18n=new te.I18n(this),this._sceneRegistry=new te.SceneRegistry(this);var p=this;this.defaultLayerWorld=new te.Layer({name:"World",id:te.LAYERID_WORLD}),this.graphicsDevice.webgl2?(this.defaultLayerDepth=new te.Layer({enabled:!1,name:"Depth",id:te.LAYERID_DEPTH,onEnable:function(){if(!this.renderTarget){var e=new te.Texture(p.graphicsDevice,{format:te.PIXELFORMAT_DEPTHSTENCIL,width:p.graphicsDevice.width,height:p.graphicsDevice.height});e.name="rt-depth2",e.minFilter=te.FILTER_NEAREST,e.magFilter=te.FILTER_NEAREST,e.addressU=te.ADDRESS_CLAMP_TO_EDGE,e.addressV=te.ADDRESS_CLAMP_TO_EDGE,this.renderTarget=new te.RenderTarget({colorBuffer:null,depthBuffer:e,autoResolve:!1}),p.graphicsDevice.scope.resolve("uDepthMap").setValue(e)}},onDisable:function(){this.renderTarget&&(this.renderTarget._depthBuffer.destroy(),this.renderTarget.destroy(),this.renderTarget=null)},onPreRenderOpaque:function(e){var t=p.graphicsDevice.gl;this.srcFbo=t.getParameter(t.FRAMEBUFFER_BINDING),this.renderTarget&&this.renderTarget.width===p.graphicsDevice.width&&this.renderTarget.height===p.graphicsDevice.height||(this.onDisable(),this.onEnable()),this.oldClear=this.cameras[e].camera._clearOptions,this.cameras[e].camera._clearOptions=this.depthClearOptions},onPostRenderOpaque:function(e){this.renderTarget&&(this.cameras[e].camera._clearOptions=this.oldClear,e=p.graphicsDevice.gl,p.graphicsDevice.setRenderTarget(this.renderTarget),p.graphicsDevice.updateBegin(),e.bindFramebuffer(e.READ_FRAMEBUFFER,this.srcFbo),e.bindFramebuffer(e.DRAW_FRAMEBUFFER,this.renderTarget._glFrameBuffer),e.blitFramebuffer(0,0,this.renderTarget.width,this.renderTarget.height,0,0,this.renderTarget.width,this.renderTarget.height,e.DEPTH_BUFFER_BIT,e.NEAREST))}}),this.defaultLayerDepth.depthClearOptions={flags:0}):(this.defaultLayerDepth=new te.Layer({enabled:!1,name:"Depth",id:te.LAYERID_DEPTH,shaderPass:te.SHADER_DEPTH,onEnable:function(){if(!this.renderTarget){var e=new te.Texture(p.graphicsDevice,{format:te.PIXELFORMAT_R8_G8_B8_A8,width:p.graphicsDevice.width,height:p.graphicsDevice.height});e.name="rt-depth1",e.minFilter=te.FILTER_NEAREST,e.magFilter=te.FILTER_NEAREST,e.addressU=te.ADDRESS_CLAMP_TO_EDGE,e.addressV=te.ADDRESS_CLAMP_TO_EDGE,this.renderTarget=new te.RenderTarget(p.graphicsDevice,e,{depth:!0,stencil:p.graphicsDevice.supportsStencil}),p.graphicsDevice.scope.resolve("uDepthMap").setValue(e)}},onDisable:function(){this.renderTarget&&(this.renderTarget._colorBuffer.destroy(),this.renderTarget.destroy(),this.renderTarget=null)},onPostCull:function(e){var t=this.instances.visibleOpaque[e],i=t.list,s=0,n=p.scene.layers.layerList,a=p.scene.layers.subLayerEnabled,r=p.scene.layers.subLayerList,o=p.defaultLayerWorld.renderTarget;e=this.cameras[e];for(var h,l,c,d,u=0;u<n.length&&(h=n[u])!==this;u++)if(h.renderTarget===o&&h.enabled&&a[u]&&!((l=h.cameras.indexOf(e))<0))for(c=(l=r[u]?h.instances.visibleTransparent[l]:h.instances.visibleOpaque[l]).length,l=l.list,h=0;h<c;h++)(d=l[h]).material&&d.material.depthWrite&&!d._noDepthDrawGl1&&(i[s]=d,s++);t.length=s},onPreRenderOpaque:function(e){this.renderTarget&&this.renderTarget.width===p.graphicsDevice.width&&this.renderTarget.height===p.graphicsDevice.height||(this.onDisable(),this.onEnable()),this.oldClear=this.cameras[e].camera._clearOptions,this.cameras[e].camera._clearOptions=this.rgbaDepthClearOptions},onDrawCall:function(){p.graphicsDevice.setColorWrite(!0,!0,!0,!0)},onPostRenderOpaque:function(e){this.renderTarget&&(this.cameras[e].camera._clearOptions=this.oldClear)}}),this.defaultLayerDepth.rgbaDepthClearOptions={color:[254/255,254/255,254/255,254/255],depth:1,flags:te.CLEARFLAG_COLOR|te.CLEARFLAG_DEPTH}),this.defaultLayerSkybox=new te.Layer({enabled:!1,name:"Skybox",id:te.LAYERID_SKYBOX,opaqueSortMode:te.SORTMODE_NONE}),this.defaultLayerUi=new te.Layer({enabled:!0,name:"UI",id:te.LAYERID_UI,transparentSortMode:te.SORTMODE_MANUAL,passThrough:!1}),this.defaultLayerImmediate=new te.Layer({enabled:!0,name:"Immediate",id:te.LAYERID_IMMEDIATE,opaqueSortMode:te.SORTMODE_NONE,passThrough:!0}),this.defaultLayerComposition=new te.LayerComposition,this.defaultLayerComposition.pushOpaque(this.defaultLayerWorld),this.defaultLayerComposition.pushOpaque(this.defaultLayerDepth),this.defaultLayerComposition.pushOpaque(this.defaultLayerSkybox),this.defaultLayerComposition.pushTransparent(this.defaultLayerWorld),this.defaultLayerComposition.pushOpaque(this.defaultLayerImmediate),this.defaultLayerComposition.pushTransparent(this.defaultLayerImmediate),this.defaultLayerComposition.pushTransparent(this.defaultLayerUi),this.scene.layers=this.defaultLayerComposition,this._immediateLayer=this.defaultLayerImmediate,this.scene.on("set:layers",function(e,t){for(var i,s=t.layerList,n=0;n<s.length;n++)switch(i=s[n],i.id){case te.LAYERID_DEPTH:i.onEnable=p.defaultLayerDepth.onEnable,i.onDisable=p.defaultLayerDepth.onDisable,i.onPreRenderOpaque=p.defaultLayerDepth.onPreRenderOpaque,i.onPostRenderOpaque=p.defaultLayerDepth.onPostRenderOpaque,i.depthClearOptions=p.defaultLayerDepth.depthClearOptions,i.rgbaDepthClearOptions=p.defaultLayerDepth.rgbaDepthClearOptions,i.shaderPass=p.defaultLayerDepth.shaderPass,i.onPostCull=p.defaultLayerDepth.onPostCull,i.onDrawCall=p.defaultLayerDepth.onDrawCall;break;case te.LAYERID_UI:i.passThrough=p.defaultLayerUi.passThrough;break;case te.LAYERID_IMMEDIATE:i.passThrough=p.defaultLayerImmediate.passThrough}}),this.renderer=new te.ForwardRenderer(this.graphicsDevice),this.renderer.scene=this.scene,this.lightmapper=new te.Lightmapper(this.graphicsDevice,this.root,this.scene,this.renderer,this.assets),this.once("prerender",this._firstBake,this),this.batcher=new te.BatchManager(this.graphicsDevice,this.root,this.scene),this.once("prerender",this._firstBatch,this),this.keyboard=t.keyboard||null,this.mouse=t.mouse||null,this.touch=t.touch||null,this.gamepads=t.gamepads||null,(this.elementInput=t.elementInput||null)&&(this.elementInput.app=this),this.vr=null,t.vr&&this._onVrChange(t.vr),this._inTools=!1,this._skyboxLast=0,this._scriptPrefix=t.scriptPrefix||"",this.enableBundles&&this.loader.addHandler("bundle",new te.BundleHandler(this.assets)),this.loader.addHandler("animation",new te.AnimationHandler),this.loader.addHandler("model",new te.ModelHandler(this.graphicsDevice,this.scene.defaultMaterial)),this.loader.addHandler("material",new te.MaterialHandler(this)),this.loader.addHandler("texture",new te.TextureHandler(this.graphicsDevice,this.assets,this.loader)),this.loader.addHandler("text",new te.TextHandler),this.loader.addHandler("json",new te.JsonHandler),this.loader.addHandler("audio",new te.AudioHandler(this._audioManager)),this.loader.addHandler("script",new te.ScriptHandler(this)),this.loader.addHandler("scene",new te.SceneHandler(this)),this.loader.addHandler("cubemap",new te.CubemapHandler(this.graphicsDevice,this.assets,this.loader)),this.loader.addHandler("html",new te.HtmlHandler),this.loader.addHandler("css",new te.CssHandler),this.loader.addHandler("shader",new te.ShaderHandler),this.loader.addHandler("hierarchy",new te.HierarchyHandler(this)),this.loader.addHandler("scenesettings",new te.SceneSettingsHandler(this)),this.loader.addHandler("folder",new te.FolderHandler),this.loader.addHandler("font",new te.FontHandler(this.loader)),this.loader.addHandler("binary",new te.BinaryHandler),this.loader.addHandler("textureatlas",new te.TextureAtlasHandler(this.loader)),this.loader.addHandler("sprite",new te.SpriteHandler(this.assets,this.graphicsDevice)),this.systems=new te.ComponentSystemRegistry,this.systems.add(new te.RigidBodyComponentSystem(this)),this.systems.add(new te.CollisionComponentSystem(this)),this.systems.add(new te.AnimationComponentSystem(this)),this.systems.add(new te.ModelComponentSystem(this)),this.systems.add(new te.CameraComponentSystem(this)),this.systems.add(new te.LightComponentSystem(this)),te.script.legacy?this.systems.add(new te.ScriptLegacyComponentSystem(this)):this.systems.add(new te.ScriptComponentSystem(this)),this.systems.add(new te.AudioSourceComponentSystem(this,this._audioManager)),this.systems.add(new te.SoundComponentSystem(this,this._audioManager)),this.systems.add(new te.AudioListenerComponentSystem(this,this._audioManager)),this.systems.add(new te.ParticleSystemComponentSystem(this)),this.systems.add(new te.ScreenComponentSystem(this)),this.systems.add(new te.ElementComponentSystem(this)),this.systems.add(new te.ButtonComponentSystem(this)),this.systems.add(new te.ScrollViewComponentSystem(this)),this.systems.add(new te.ScrollbarComponentSystem(this)),this.systems.add(new te.SpriteComponentSystem(this)),this.systems.add(new te.LayoutGroupComponentSystem(this)),this.systems.add(new te.LayoutChildComponentSystem(this)),this.systems.add(new te.ZoneComponentSystem(this)),this._visibilityChangeHandler=this.onVisibilityChange.bind(this),void 0!==document.hidden?(this._hiddenAttr="hidden",document.addEventListener("visibilitychange",this._visibilityChangeHandler,!1)):void 0!==document.mozHidden?(this._hiddenAttr="mozHidden",document.addEventListener("mozvisibilitychange",this._visibilityChangeHandler,!1)):void 0!==document.msHidden?(this._hiddenAttr="msHidden",document.addEventListener("msvisibilitychange",this._visibilityChangeHandler,!1)):void 0!==document.webkitHidden&&(this._hiddenAttr="webkitHidden",document.addEventListener("webkitvisibilitychange",this._visibilityChangeHandler,!1)),this.tick=i(this)};a._currentApplication=null,a._applications={},a.getApplication=function(e){return e?a._applications[e]:a._currentApplication};var c=function(e){this.length=e,this.count=0,this.inc=function(){this.count++},this.done=function(){return this.count===this.length}};Object.assign(a.prototype,{configure:function(e,a){var r=this;te.http.get(e,function(e,t){if(e)a(e);else{var i=t.application_properties,s=t.scenes,n=t.assets;r._parseApplicationProperties(i,function(e){r._onVrChange(i.vr),r._parseScenes(s),r._parseAssets(n),a(e||null)})}})},preload:function(e){var t,i,s=this;s.fire("preload:start");var n=this.assets.list({preload:!0}),a=new c(n.length),r=!1,o=function(){s.graphicsDevice&&!r&&a.done()&&(r=!0,s.fire("preload:end"),e())};if(i=n.length,a.length){var h=function(e){a.inc(),s.fire("preload:progress",a.count/i),a.done()&&o()},l=function(e,t){a.inc(),s.fire("preload:progress",a.count/i),a.done()&&o()};for(t=0;t<n.length;t++)n[t].loaded?(a.inc(),s.fire("preload:progress",a.count/i),a.done()&&o()):(n[t].once("load",h),n[t].once("error",l),this.assets.load(n[t]))}else o()},getSceneUrl:function(e){return(e=this._sceneRegistry.find(e))?e.url:null},loadSceneHierarchy:function(e,t){this._sceneRegistry.loadSceneHierarchy(e,t)},loadSceneSettings:function(e,t){this._sceneRegistry.loadSceneSettings(e,t)},loadScene:function(e,t){this._sceneRegistry.loadScene(e,t)},_preloadScripts:function(e,i){if(te.script.legacy){var s=this;s.systems.script.preloading=!0;var t,n=this._getScriptReferences(e),a=0,r=n.length,o=new c(r),h=/^http(s)?:\/\//;if(r){var l=function(e,t){o.inc(),o.done()&&(s.systems.script.preloading=!1,i())};for(a=0;a<r;a++)t=n[a],!h.test(t.toLowerCase())&&s._scriptPrefix&&(t=te.path.join(s._scriptPrefix,n[a])),this.loader.load(t,"script",l)}else s.systems.script.preloading=!1,i()}else i()},_parseApplicationProperties:function(e,t){var i,s;if(e.useDevicePixelRatio||(e.useDevicePixelRatio=e.use_device_pixel_ratio),e.resolutionMode||(e.resolutionMode=e.resolution_mode),e.fillMode||(e.fillMode=e.fill_mode),e.vrPolyfillUrl||(e.vrPolyfillUrl=e.vr_polyfill_url),this._width=e.width,this._height=e.height,e.useDevicePixelRatio&&(this.graphicsDevice.maxPixelRatio=window.devicePixelRatio),this.setCanvasResolution(e.resolutionMode,this._width,this._height),this.setCanvasFillMode(e.fillMode,this._width,this._height),e.vr&&e.vrPolyfillUrl&&(te.VrManager.isSupported&&!te.platform.android||e.libraries.push(e.vrPolyfillUrl)),e.layers&&e.layerOrder){var n=new te.LayerComposition,a={};for(i in e.layers)(s=e.layers[i]).id=parseInt(i,10),s.enabled=s.id!==te.LAYERID_DEPTH,a[i]=new te.Layer(s);for(i=0,s=e.layerOrder.length;i<s;i++){var r=e.layerOrder[i],o=a[r.layer];o&&(r.transparent?n.pushTransparent(o):n.pushOpaque(o),n.subLayerEnabled[i]=r.enabled)}this.scene.layers=n}if(e.batchGroups)for(i=0,s=e.batchGroups.length;i<s;i++)n=e.batchGroups[i],this.batcher.addGroup(n.name,n.dynamic,n.maxAabbSize,n.id,n.layers);e.i18nAssets&&(this.i18n.assets=e.i18nAssets),this._loadLibraries(e.libraries,t)},_loadLibraries:function(e,i){var t=e.length,s=t,n=this,a=/^http(s)?:\/\//;if(t)for(var r=function(e,t){s--,e?i(e):0===s&&(n.onLibrariesLoaded(),i(null))},o=0;o<t;++o){var h=e[o];!a.test(h.toLowerCase())&&n._scriptPrefix&&(h=te.path.join(n._scriptPrefix,h)),this.loader.load(h,"script",r)}else n.onLibrariesLoaded(),i(null)},_parseScenes:function(e){if(e)for(var t=0;t<e.length;t++)this._sceneRegistry.add(e[t].name,e[t].url)},_parseAssets:function(e){var t,i,s=[],n={},a={};if(te.script.legacy){if(this.enableBundles)for(i in e)"bundle"===e[i].type&&(a[i]=!0,s.push(e[i]));for(i in e)a[i]||s.push(e[i])}else{for(t=0;t<this.scriptsOrder.length;t++)e[i=this.scriptsOrder[t]]&&(n[i]=!0,s.push(e[i]));if(this.enableBundles)for(i in e)"bundle"===e[i].type&&(a[i]=!0,s.push(e[i]));for(i in e)n[i]||a[i]||s.push(e[i])}for(t=0;t<s.length;t++){if(e=s[t],(i=new te.Asset(e.name,e.type,e.file,e.data)).id=parseInt(e.id,10),i.preload=!!e.preload&&e.preload,i.loaded="script"===e.type&&e.data&&0<e.data.loadingType,i.tags.add(e.tags),e.i18n)for(var r in e.i18n)i.addLocalizedAssetId(r,e.i18n[r]);this.assets.add(i)}},_getScriptReferences:function(e){var t,i,s=[];e.settings.priority_scripts&&(s=e.settings.priority_scripts);var n=[],a={};for(t=0;t<s.length;t++)n.push(s[t]),a[s[t]]=!0;for(i in e=e.entities)if(e[i].components.script)for(s=e[i].components.script.scripts,t=0;t<s.length;t++)a[s[t].url]||(n.push(s[t].url),a[s[t].url]=!0);return n},start:function(){this.frame=0,this.fire("start",{timestamp:te.now(),target:this}),this._librariesLoaded||this.onLibrariesLoaded(),te.ComponentSystem.initialize(this.root),this.fire("initialize"),te.ComponentSystem.postInitialize(this.root),this.fire("postinitialize"),this.tick()},update:function(e){this.frame++,this.graphicsDevice.updateClientRect(),this.vr&&this.vr.poll(),te.script.legacy&&te.ComponentSystem.fixedUpdate(1/60,this._inTools),te.ComponentSystem.update(e,this._inTools),te.ComponentSystem.postUpdate(e,this._inTools),this.fire("update",e),this.controller&&this.controller.update(e),this.mouse&&this.mouse.update(e),this.keyboard&&this.keyboard.update(e),this.gamepads&&this.gamepads.update(e)},render:function(){this.fire("prerender"),this.root.syncHierarchy(),this.batcher.updateAll(),te._skipRenderCounter=0,this.renderer.renderComposition(this.scene.layers),this.fire("postrender")},_fillFrameStats:function(e,t,i){var s=this.stats.frame;for(s.dt=t,s.ms=i,e>s._timeToCountFrames?(s.fps=s._fpsAccum,s._fpsAccum=0,s._timeToCountFrames=e+1e3):s._fpsAccum++,s.cameras=this.renderer._camerasRendered,s.materials=this.renderer._materialSwitches,s.shaders=this.graphicsDevice._shaderSwitchesPerFrame,s.shadowMapUpdates=this.renderer._shadowMapUpdates,s.shadowMapTime=this.renderer._shadowMapTime,s.depthMapTime=this.renderer._depthMapTime,s.forwardTime=this.renderer._forwardTime,e=this.graphicsDevice._primsPerFrame,s.triangles=e[te.PRIMITIVE_TRIANGLES]/3+Math.max(e[te.PRIMITIVE_TRISTRIP]-2,0)+Math.max(e[te.PRIMITIVE_TRIFAN]-2,0),s.cullTime=this.renderer._cullTime,s.sortTime=this.renderer._sortTime,s.skinTime=this.renderer._skinTime,s.morphTime=this.renderer._morphTime,s.instancingTime=this.renderer._instancingTime,t=s.otherPrimitives=0;t<e.length;t++)t<te.PRIMITIVE_TRIANGLES&&(s.otherPrimitives+=e[t]),e[t]=0;this.renderer._camerasRendered=0,this.renderer._materialSwitches=0,this.renderer._shadowMapUpdates=0,this.graphicsDevice._shaderSwitchesPerFrame=0,this.renderer._cullTime=0,this.renderer._sortTime=0,this.renderer._skinTime=0,this.renderer._morphTime=0,this.renderer._instancingTime=0,this.renderer._shadowMapTime=0,this.renderer._depthMapTime=0,this.renderer._forwardTime=0,(s=this.stats.drawCalls).forward=this.renderer._forwardDrawCalls,s.culled=this.renderer._numDrawCallsCulled,s.depth=0,s.shadow=this.renderer._shadowDrawCalls,s.skinned=this.renderer._skinDrawCalls,s.immediate=0,s.instanced=0,s.removedByInstancing=0,s.total=this.graphicsDevice._drawCallsPerFrame,s.misc=s.total-(s.forward+s.shadow),this.renderer._depthDrawCalls=0,this.renderer._shadowDrawCalls=0,this.renderer._forwardDrawCalls=0,this.renderer._numDrawCallsCulled=0,this.renderer._skinDrawCalls=0,this.renderer._immediateRendered=0,this.renderer._instancedDrawCalls=0,this.renderer._removedByInstancing=0,this.graphicsDevice._drawCallsPerFrame=0,this.stats.misc.renderTargetCreationTime=this.graphicsDevice.renderTargetCreationTime,(s=this.stats.particles).updatesPerFrame=s._updatesPerFrame,s.frameTime=s._frameTime,s._updatesPerFrame=0,s._frameTime=0},setCanvasFillMode:function(e,t,i){this._fillMode=e,this.resizeCanvas(t,i)},setCanvasResolution:function(e,t,i){(this._resolutionMode=e)===te.RESOLUTION_AUTO&&void 0===t&&(t=this.graphicsDevice.canvas.clientWidth,i=this.graphicsDevice.canvas.clientHeight),this.graphicsDevice.resizeCanvas(t,i)},isHidden:function(){return document[this._hiddenAttr]},onVisibilityChange:function(){this.isHidden()?this._audioManager.suspend():this._audioManager.resume()},resizeCanvas:function(e,t){if(this._allowResize){var i=window.innerWidth,s=window.innerHeight;if(navigator.isCocoonJS)e=i,t=s,this.graphicsDevice.resizeCanvas(e,t);else{if(this._fillMode===te.FILLMODE_KEEP_ASPECT){var n=this.graphicsDevice.canvas.width/this.graphicsDevice.canvas.height;i/s<n?t=(e=i)/n:e=(t=s)*n}else this._fillMode===te.FILLMODE_FILL_WINDOW&&(e=i,t=s);this.graphicsDevice.canvas.style.width=e+"px",this.graphicsDevice.canvas.style.height=t+"px",this._resolutionMode===te.RESOLUTION_AUTO&&this.setCanvasResolution(te.RESOLUTION_AUTO)}return{width:e,height:t}}},onLibrariesLoaded:function(){this._librariesLoaded=!0,this.systems.rigidbody.onLibraryLoaded(),this.systems.collision.onLibraryLoaded()},applySceneSettings:function(e){var t;this.systems.rigidbody&&"undefined"!=typeof Ammo&&(t=e.physics.gravity,this.systems.rigidbody.gravity.set(t[0],t[1],t[2])),this.scene.applySettings(e),e.render.hasOwnProperty("skybox")&&(e.render.skybox?(t=this.assets.get(e.render.skybox))?this.setSkybox(t):this.assets.once("add:"+e.render.skybox,this.setSkybox,this):this.setSkybox(null))},setSkybox:function(e){e?this._skyboxLast===e.id?0!==this.scene.skyboxMip||e.loadFaces?this._onSkyboxChange(e):this._skyboxLoad(e):(this._skyboxLast&&(this.assets.off("add:"+this._skyboxLast,this.setSkybox,this),this.assets.off("load:"+this._skyboxLast,this._onSkyboxChange,this),this.assets.off("remove:"+this._skyboxLast,this._skyboxRemove,this)),this._skyboxLast=e.id,this.assets.on("load:"+e.id,this._onSkyboxChange,this),this.assets.once("remove:"+e.id,this._skyboxRemove,this),e.resource&&this.scene.setSkybox(e.resources),this._skyboxLoad(e)):this._skyboxLast&&this._skyboxRemove({id:this._skyboxLast})},_onVrChange:function(e){e?this.vr||(this.vr=new te.VrManager(this)):this.vr&&(this.vr.destroy(),this.vr=null)},_onSkyboxChange:function(e){this.scene.setSkybox(e.resources)},_skyboxLoad:function(e){0===this.scene.skyboxMip&&(e.loadFaces=!0),this.assets.load(e),this._onSkyboxChange(e)},_skyboxRemove:function(e){this._skyboxLast&&(this.assets.off("add:"+e.id,this.setSkybox,this),this.assets.off("load:"+e.id,this._onSkyboxChange,this),this.assets.off("remove:"+e.id,this._skyboxRemove,this),this.scene.setSkybox(null),this._skyboxLast=null)},_firstBake:function(){this.lightmapper.bake(null,this.scene.lightmapMode)},_firstBatch:function(){this.scene._needsStaticPrepare&&(this.renderer.prepareStaticMeshes(this.graphicsDevice,this.scene),this.scene._needsStaticPrepare=!1),this.batcher.generate()},_processTimestamp:function(e){return e},destroy:function(){var e,t,i=this.graphicsDevice.canvas.id;this.off("librariesloaded"),document.removeEventListener("visibilitychange",this._visibilityChangeHandler,!1),document.removeEventListener("mozvisibilitychange",this._visibilityChangeHandler,!1),document.removeEventListener("msvisibilitychange",this._visibilityChangeHandler,!1),document.removeEventListener("webkitvisibilitychange",this._visibilityChangeHandler,!1),this.onVisibilityChange=this._visibilityChangeHandler=null,this.root.destroy(),this.root=null,this.mouse&&(this.mouse.off(),this.mouse.detach(),this.mouse=null),this.keyboard&&(this.keyboard.off(),this.keyboard.detach(),this.keyboard=null),this.touch&&(this.touch.off(),this.touch.detach(),this.touch=null),this.elementInput&&(this.elementInput.detach(),this.elementInput=null),this.controller&&(this.controller=null);var s=this.systems.list;for(e=0,t=s.length;e<t;e++)s[e].destroy();for(te.ComponentSystem.destroy(),t=this.assets.list(),e=0;e<t.length;e++)t[e].unload(),t[e].off();for(var n in this.assets.off(),this.bundles.destroy(),this.bundles=null,this.i18n.destroy(),this.i18n=null,this.loader.getHandler("script")._cache)(t=(e=this.loader.getHandler("script")._cache[n]).parentNode)&&t.removeChild(e);this.loader.getHandler("script")._cache={},this.loader.destroy(),this.loader=null,this.scene.destroy(),this.scene=null,this.systems=[],this.context=null,this.scripts.destroy(),this.scripts=null,this._sceneRegistry.destroy(),this._sceneRegistry=null,this.lightmapper.destroy(),this.lightmapper=null,this.batcher.destroyManager(),this.batcher=null,this._entityIndex={},this.defaultLayerDepth.onPreRenderOpaque=null,this.defaultLayerDepth.onPostRenderOpaque=null,this.defaultLayerDepth.onDisable=null,this.defaultLayerWorld=this.defaultLayerDepth=this.defaultLayerDepth.onEnable=null,te.destroyPostEffectQuad(),this.graphicsDevice.destroy(),this.tick=this.renderer=this.graphicsDevice=null,this.off(),this._audioManager&&(this._audioManager.destroy(),this._audioManager=null),te.http=new te.Http,te.script.app=null,te.ParticleEmitter.DEFAULT_PARAM_TEXTURE=null,a._applications[i]=null,a._currentApplication===this&&(a._currentApplication=null)}});var s={},i=function(i){return function(e){var t;i.graphicsDevice&&(a._currentApplication=i,e=(te.app=i)._processTimestamp(e)||te.now(),t=te.math.clamp((e-(i._time||e))/1e3,0,i.maxDeltaTime),t*=i.timeScale,i._time=e,i.vr&&i.vr.display?i.vr.display.requestAnimationFrame(i.tick):window.requestAnimationFrame(i.tick),i.graphicsDevice.contextLost||(i.update(t),(i.autoRender||i.renderNextFrame)&&(i.render(),i.renderNextFrame=!1),s.timestamp=te.now(),(s.target=i).fire("frameend",s),i.fire("frameEnd",s),i.vr&&i.vr.display&&i.vr.display.presenting&&i.vr.display.submitFrame()))}};return{FILLMODE_NONE:"NONE",FILLMODE_FILL_WINDOW:"FILL_WINDOW",FILLMODE_KEEP_ASPECT:"KEEP_ASPECT",RESOLUTION_AUTO:"AUTO",RESOLUTION_FIXED:"FIXED",Application:a}}()),te.ApplicationStats=function(e){this.frame={fps:0,ms:0,dt:0,updateStart:0,updateTime:0,renderStart:0,renderTime:0,physicsStart:0,physicsTime:0,cullTime:0,sortTime:0,skinTime:0,morphTime:0,instancingTime:0,triangles:0,otherPrimitives:0,shaders:0,materials:0,cameras:0,shadowMapUpdates:0,shadowMapTime:0,depthMapTime:0,forwardTime:0,_timeToCountFrames:0,_fpsAccum:0},this.drawCalls={forward:0,depth:0,shadow:0,immediate:0,misc:0,total:0,skinned:0,instanced:0,removedByInstancing:0},this.misc={renderTargetCreationTime:0},this.particles={updatesPerFrame:0,_updatesPerFrame:0,frameTime:0,_frameTime:0},this.vram=e._vram,this.shaders=e._shaderStats,Object.defineProperty(this.vram,"totalUsed",{get:function(){return this.tex+this.vb+this.ib}}),Object.defineProperty(this,"scene",{get:function(){return te.Application._currentApplication.scene._stats}}),Object.defineProperty(this,"lightmapper",{get:function(){return te.Application._currentApplication.lightmapper._stats}}),Object.defineProperty(this,"batcher",{get:function(){return te.Application._currentApplication.batcher._stats}}),te.events.attach(this)},Object.assign(te,((si=function(e){this._app=e,this._list=[],this._index={},this._urlIndex={}}).prototype.destroy=function(){this._app=null},si.prototype.list=function(){return this._list},si.prototype.add=function(e,t){if(this._index.hasOwnProperty(e))return!1;var i=new te.SceneRegistryItem(e,t),s=this._list.push(i);return this._index[i.name]=s-1,this._urlIndex[i.url]=s-1,!0},si.prototype.find=function(e){return this._index.hasOwnProperty(e)?this._list[this._index[e]]:null},si.prototype.findByUrl=function(e){return this._urlIndex.hasOwnProperty(e)?this._list[this._urlIndex[e]]:null},si.prototype.remove=function(e){if(this._index.hasOwnProperty(e)){var t=this._index[e],i=this._list[t];for(delete this._urlIndex[i.url],delete this._index[e],this._list.splice(t,1),t=0;t<this._list.length;t++)i=this._list[t],this._index[i.name]=t,this._urlIndex[i.url]=t}},si.prototype.loadSceneHierarchy=function(s,n){var a=this,r=this._app.loader.getHandler("hierarchy");this._app.assets&&this._app.assets.prefix&&!te.ABSOLUTE_URL.test(s)&&(s=te.path.join(this._app.assets.prefix,s)),r.load(s,function(t,i){t?n&&n(t):a._app._preloadScripts(i,function(){a._app.systems.script.preloading=!0;var e=r.open(s,i);a._app.systems.script.preloading=!1,a._app.loader.clearCache(s,"hierarchy"),a._app.root.addChild(e),te.ComponentSystem.initialize(e),te.ComponentSystem.postInitialize(e),n&&n(t,e)})})},si.prototype.loadSceneSettings=function(e,i){var s=this;this._app.assets&&this._app.assets.prefix&&!te.ABSOLUTE_URL.test(e)&&(e=te.path.join(this._app.assets.prefix,e)),this._app.loader.load(e,"scenesettings",function(e,t){e?i&&i(e):(s._app.applySceneSettings(t),i&&i(null))})},si.prototype.loadScene=function(i,s){var n=this,a=this._app.loader.getHandler("scene");this._app.assets&&this._app.assets.prefix&&!te.ABSOLUTE_URL.test(i)&&(i=te.path.join(this._app.assets.prefix,i)),a.load(i,function(e,t){e?s&&s(e):n._app._preloadScripts(t,function(){n._app.systems.script.preloading=!0;var e=a.open(i,t);n._app.systems.script.preloading=!1,n._app.loader.clearCache(i,"scene"),n._app.loader.patch({resource:e,type:"scene"},n._app.assets),n._app.root.addChild(e.root),n._app.systems.rigidbody&&"undefined"!=typeof Ammo&&n._app.systems.rigidbody.gravity.set(e._gravity.x,e._gravity.y,e._gravity.z),s&&s(null,e)})})},{SceneRegistry:si,SceneRegistryItem:function(e,t){this.name=e,this.url=t}})),Object.assign(te,(ni=function(){this.list=[]},Object.assign(ni.prototype,{add:function(e){var t=e.id;if(this[t])throw Error(te.string.format("ComponentSystem name '{0}' already registered or not allowed",t));this[t]=e,this.list.push(e)},remove:function(e){if(!this[e=e.id])throw Error(te.string.format("No ComponentSystem named '{0}' registered",e));delete this[e],-1!==(e=this.list.indexOf(this[e]))&&this.list.splice(e,1)}}),{ComponentSystemRegistry:ni})),Object.assign(te,function(){function h(e,t){if(!e)return e;switch(t){case"rgb":return e instanceof te.Color?e.clone():new te.Color(e[0],e[1],e[2]);case"rgba":return e instanceof te.Color?e.clone():new te.Color(e[0],e[1],e[2],e[3]);case"vec2":return e instanceof te.Vec2?e.clone():new te.Vec2(e[0],e[1]);case"vec3":return e instanceof te.Vec3?e.clone():new te.Vec3(e[0],e[1],e[2]);case"vec4":return e instanceof te.Vec4?e.clone():new te.Vec4(e[0],e[1],e[2],e[3]);case"boolean":case"number":case"string":case"entity":return e;default:throw Error("Could not convert unhandled type: "+t)}}var e=function(e){this.app=e,this.store={},this.schema=[],te.events.attach(this)};return Object.assign(e,{_helper:function(e,t){for(var i=0,s=e.length;i<s;i++)e[i].f.call(e[i].s,t)},initialize:function(e){this._helper(this._init,e)},postInitialize:function(e){this._helper(this._postInit,e),this.fire("postinitialize",e)},update:function(e,t){this._helper(t?this._toolsUpdate:this._update,e)},fixedUpdate:function(e,t){this._helper(this._fixedUpdate,e)},postUpdate:function(e,t){this._helper(this._postUpdate,e)},_init:[],_postInit:[],_toolsUpdate:[],_update:[],_fixedUpdate:[],_postUpdate:[],bind:function(e,t,i){switch(e){case"initialize":this._init.push({f:t,s:i});break;case"postInitialize":this._postInit.push({f:t,s:i});break;case"update":this._update.push({f:t,s:i});break;case"postUpdate":this._postUpdate.push({f:t,s:i});break;case"fixedUpdate":this._fixedUpdate.push({f:t,s:i});break;case"toolsUpdate":this._toolsUpdate.push({f:t,s:i})}},_erase:function(e,t,i){for(var s=0;s<e.length;s++)e[s].f===t&&e[s].s===i&&e.splice(s--,1)},unbind:function(e,t,i){switch(e){case"initialize":this._erase(this._init,t,i);break;case"postInitialize":this._erase(this._postInit,t,i);break;case"update":this._erase(this._update,t,i);break;case"postUpdate":this._erase(this._postUpdate,t,i);break;case"fixedUpdate":this._erase(this._fixedUpdate,t,i);break;case"toolsUpdate":this._erase(this._toolsUpdate,t,i)}}}),e.prototype={addComponent:function(e,t){var i=new this.ComponentType(this,e),s=new this.DataType;return t=t||{},this.store[e.getGuid()]={entity:e,data:s},e[this.id]=i,e.c[this.id]=i,this.initializeComponentData(i,t,[]),this.fire("add",e,i),i},removeComponent:function(e){var t=this.store[e.getGuid()];this.fire("beforeremove",e,e.c[this.id]),delete this.store[e.getGuid()],delete e[this.id],delete e.c[this.id],this.fire("remove",e,t.data)},cloneComponent:function(e,t){var i=this.store[e.getGuid()];return this.addComponent(t,i.data)},initializeComponentData:function(e,t,i){t=t||{};for(var s,n,a,r=0,o=i.length;r<o;r++)s="object"==typeof(s=i[r])?(n=s.name,s.type):void(n=s),void 0!==(a=t[n])?(void 0!==s&&(a=h(a,s)),e[n]=a):e[n]=e.data[n];e.enabled&&e.entity.enabled&&e.onEnable()},getPropertiesOfType:function(t){var i=[];return(this.schema||[]).forEach(function(e){e&&"object"==typeof e&&e.type===t&&i.push(e)}),i},destroy:function(){this.off()}},te.events.attach(e),e.destroy=function(){e.off("initialize"),e.off("postInitialize"),e.off("toolsUpdate"),e.off("update"),e.off("fixedUpdate"),e.off("postUpdate")},{ComponentSystem:e}}()),Object.assign(te,((ai=function(e,t){this.system=e,this.entity=t,te.events.attach(this),this.system.schema&&!this._accessorsBuilt&&this.buildAccessors(this.system.schema),this.on("set",function(e,t,i){this.fire("set_"+e,e,t,i)}),this.on("set_enabled",this.onSetEnabled,this)})._buildAccessors=function(t,e){e.forEach(function(e){var s="object"==typeof e?e.name:e;Object.defineProperty(t,s,{get:function(){return this.data[s]},set:function(e){var t=this.data,i=t[s];t[s]=e,this.fire("set",s,i,e)},configurable:!0})}),t._accessorsBuilt=!0},ai.prototype={buildAccessors:function(e){ai._buildAccessors(this,e)},onSetEnabled:function(e,t,i){t!==i&&this.entity.enabled&&(i?this.onEnable():this.onDisable())},onEnable:function(){},onDisable:function(){},onPostStateChange:function(){}},Object.defineProperty(ai.prototype,"data",{get:function(){var e=this.system.store[this.entity.getGuid()];return e?e.data:null}}),{Component:ai})),Object.assign(te,{ComponentData:function(){}}),Object.assign(te,(((ri=function(e,t){te.Component.call(this,e,t),this.animationsIndex={},this.on("set_animations",this.onSetAnimations,this),this.on("set_assets",this.onSetAssets,this),this.on("set_loop",this.onSetLoop,this)}).prototype=Object.create(te.Component.prototype)).constructor=ri,Object.assign(ri.prototype,{play:function(e,t){if(this.data.animations[e]&&this.enabled&&this.entity.enabled){t=t||0;var i=this.data;i.prevAnim=i.currAnim,i.currAnim=e,i.model&&(i.blending=0<t&&i.prevAnim,i.blending?(i.blendTime=t,i.blendTimeRemaining=t,i.fromSkel.animation=i.animations[i.prevAnim],i.fromSkel.addTime(i.skeleton._time),i.toSkel.animation=i.animations[i.currAnim]):i.skeleton.animation=i.animations[i.currAnim]),i.playing=!0}},getAnimation:function(e){return this.data.animations[e]},setModel:function(e){var t=this.data;if(e){var i=e.getGraph();t.fromSkel=new te.Skeleton(i),t.toSkel=new te.Skeleton(i),t.skeleton=new te.Skeleton(i),t.skeleton.looping=t.loop,t.skeleton.setGraph(i)}t.model=e,t.animations&&t.currAnim&&t.animations[t.currAnim]&&this.play(t.currAnim)},loadAnimationAssets:function(e){if(e&&e.length){var t,i=this,s=this.system.app.assets,n=e.length,a=function(e){i.animations[e.name]=e.resource,i.animationsIndex[e.id]=e.name,i.animations=i.animations},r=function(e){e.off("change",i.onAssetChanged,i),e.on("change",i.onAssetChanged,i),e.off("remove",i.onAssetRemoved,i),e.on("remove",i.onAssetRemoved,i),e.resource?a(e):(e.once("load",a,i),i.enabled&&i.entity.enabled&&s.load(e))};for(t=0;t<n;t++){var o=s.get(e[t]);o?r(o):s.on("add:"+e[t],r)}}},onAssetChanged:function(e,t,i,s){"resource"===t&&(i?(this.animations[e.name]=i,this.animationsIndex[e.id]=e.name,this.data.currAnim===e.name&&this.data.playing&&this.data.enabled&&this.entity.enabled&&this.play(e.name,0)):(delete this.animations[e.name],delete this.animationsIndex[e.id]))},onAssetRemoved:function(e){e.off("remove",this.onAssetRemoved,this),this.animations&&this.animations[e.name]&&(delete this.animations[e.name],delete this.animationsIndex[e.id],this.data.currAnim===e.name&&this._stopCurrentAnimation())},_stopCurrentAnimation:function(){this.data.currAnim=null,this.data.playing=!1,this.data.skeleton&&(this.data.skeleton.currentTime=0,this.data.skeleton.animation=null)},onSetAnimations:function(e,t,i){if(e=this.data,(t=this.entity.model)&&(t=t.model)&&t!==e.model&&this.entity.animation.setModel(t),!e.currAnim&&e.activate&&e.enabled&&this.entity.enabled)for(var s in e.animations){this.play(s,0);break}},onSetAssets:function(e,t,i){if(t&&t.length)for(e=0;e<t.length;e++)if(t[e]){var s=this.system.app.assets.get(t[e]);if(s){s.off("change",this.onAssetChanged,this),s.off("remove",this.onAssetRemoved,this);var n=this.animationsIndex[s.id];this.data.currAnim===n&&this._stopCurrentAnimation(),delete this.animations[n],delete this.animationsIndex[s.id]}}t=i.map(function(e){return e instanceof te.Asset?e.id:e}),this.loadAnimationAssets(t)},onSetLoop:function(e,t,i){this.data.skeleton&&(this.data.skeleton.looping=this.data.loop)},onSetCurrentTime:function(e,t,i){this.data.skeleton.currentTime=i,this.data.skeleton.addTime(0),this.data.skeleton.updateGraph()},onEnable:function(){te.Component.prototype.onEnable.call(this);var e=this.data.assets,t=this.system.app.assets;if(e)for(var i=0,s=e.length;i<s;i++){var n=e[i];n instanceof te.Asset||(n=t.get(n)),n&&!n.resource&&t.load(n)}if(this.data.activate&&!this.data.currAnim)for(var a in this.data.animations){this.play(a,0);break}},onBeforeRemove:function(){for(var e=0;e<this.assets.length;e++){var t=this.system.app.assets.get(this.assets[e]);t&&(t.off("change",this.onAssetChanged,this),t.off("remove",this.onAssetRemoved,this))}delete this.data.animation,delete this.data.skeleton,delete this.data.fromSkel,delete this.data.toSkel}}),Object.defineProperties(ri.prototype,{currentTime:{get:function(){return this.data.skeleton._time},set:function(e){this.data.skeleton.currentTime=e,this.data.skeleton.addTime(0),this.data.skeleton.updateGraph()}},duration:{get:function(){return this.data.animations[this.data.currAnim].duration}}}),{AnimationComponent:ri})),Object.assign(te,(oi="enabled assets speed loop activate animations skeleton model prevAnim currAnim fromSkel toSkel blending blendTimeRemaining playing".split(" "),((hi=function(e){te.ComponentSystem.call(this,e),this.id="animation",this.description="Specifies the animation assets that can run on the model specified by the Entity's model Component.",this.ComponentType=te.AnimationComponent,this.DataType=te.AnimationComponentData,this.schema=oi,this.on("beforeremove",this.onBeforeRemove,this),this.on("update",this.onUpdate,this),te.ComponentSystem.bind("update",this.onUpdate,this)}).prototype=Object.create(te.ComponentSystem.prototype)).constructor=hi,te.Component._buildAccessors(te.AnimationComponent.prototype,oi),Object.assign(hi.prototype,{initializeComponentData:function(e,t,i){i=["activate","enabled","loop","speed","assets"],te.ComponentSystem.prototype.initializeComponentData.call(this,e,t,i)},cloneComponent:function(e,t){var i;this.addComponent(t,{}),t.animation.assets=e.animation.assets.slice(),t.animation.data.speed=e.animation.speed,t.animation.data.loop=e.animation.loop,t.animation.data.activate=e.animation.activate,t.animation.data.enabled=e.animation.enabled;var s={},n=e.animation.animations;for(i in n)n.hasOwnProperty(i)&&(s[i]=n[i]);for(i in t.animation.animations=s,s={},n=e.animation.animationsIndex)n.hasOwnProperty(i)&&(s[i]=n[i]);t.animation.animationsIndex=s},onBeforeRemove:function(e,t){t.onBeforeRemove()},onUpdate:function(e){var t,i=this.store;for(t in i)if(i.hasOwnProperty(t)){var s=i[t],n=s.data;n.enabled&&n.playing&&s.entity.enabled&&null!==(s=n.skeleton)&&null!==n.model&&(n.blending?(n.blendTimeRemaining-=e,n.blendTimeRemaining<0&&(n.blendTimeRemaining=0),s.blend(n.fromSkel,n.toSkel,1-n.blendTimeRemaining/n.blendTime)):(s.addTime(e*n.speed),s._time!==s._animation.duration||n.loop||(n.playing=!1)),n.blending&&0===n.blendTimeRemaining&&(n.blending=!1,s.animation=n.toSkel._animation),s.updateGraph())}}}),{AnimationComponentSystem:hi})),Object.assign(te,{AnimationComponentData:function(){this.assets=[],this.speed=1,this.enabled=this.activate=this.loop=!0,this.animations={},this.toSkel=this.fromSkel=this.currAnim=this.prevAnim=this.model=this.skeleton=null,this.blending=!1,this.blendTimeRemaining=this.blendTime=0,this.playing=!1}}),Object.assign(te,(((li=function(e,t){te.Component.call(this,e,t),this._type="asset",this._model=this._asset=null,this._mapping={},this._receiveShadows=this._castShadows=!0,this._materialAsset=null,this._material=e.defaultMaterial,this._castShadowsLightmap=!0,this._lightmapped=!1,this._lightmapSizeMultiplier=1,this._isStatic=!1,this._layers=[te.LAYERID_WORLD],this._batchGroupId=-1,this._area=null,this._assetOld=0,this._materialEvents=null,this._clonedModel=this._dirtyMaterialAsset=this._dirtyModelAsset=!1}).prototype=Object.create(te.Component.prototype)).constructor=li,Object.assign(li.prototype,{setVisible:function(e){this.enabled=e},addModelToLayers:function(){for(var e,t=this.system.app.scene.layers,i=0;i<this._layers.length;i++)(e=t.getLayerById(this._layers[i]))&&e.addMeshInstances(this.meshInstances)},removeModelFromLayers:function(e){for(var t,i=this.system.app.scene.layers,s=0;s<this._layers.length;s++)(t=i.getLayerById(this._layers[s]))&&t.removeMeshInstances(e.meshInstances)},onRemove:function(){"asset"===this.type?this.asset=null:this.model=null,this.materialAsset=null,this._unsetMaterialEvents()},onLayersChanged:function(e,t){this.addModelToLayers(),e.off("add",this.onLayerAdded,this),e.off("remove",this.onLayerRemoved,this),t.on("add",this.onLayerAdded,this),t.on("remove",this.onLayerRemoved,this)},onLayerAdded:function(e){this.layers.indexOf(e.id)<0||e.addMeshInstances(this.meshInstances)},onLayerRemoved:function(e){this.layers.indexOf(e.id)<0||e.removeMeshInstances(this.meshInstances)},_setMaterialEvent:function(e,t,i,s){t=t+":"+i,this.system.app.assets.on(t,s,this),this._materialEvents||(this._materialEvents=[]),this._materialEvents[e]||(this._materialEvents[e]={}),this._materialEvents[e][t]={id:i,handler:s}},_unsetMaterialEvents:function(){var e=this.system.app.assets,t=this._materialEvents;if(t){for(var i=0,s=t.length;i<s;i++)if(t[i]){var n,a=t[i];for(n in a)e.off(n,a[n].handler,this)}this._materialEvents=null}},_getAssetByIdOrPath:function(e){var t=null;return isNaN(parseInt(e,10))?this.asset&&(e=this._getMaterialAssetUrl(e))&&(t=this.system.app.assets.getByUrl(e)):t=this.system.app.assets.get(e),t},_getMaterialAssetUrl:function(e){if(!this.asset)return null;var t=this.system.app.assets.get(this.asset);return t?(t=t.getFileUrl(),t=te.path.getDirectory(t),te.path.join(t,e)):null},_loadAndSetMeshInstanceMaterial:function(t,i,s){var e=this.system.app.assets;t&&t&&(t.resource?(i.material=t.resource,this._setMaterialEvent(s,"remove",t.id,function(){i.material=this.system.defaultMaterial})):(this._setMaterialEvent(s,"load",t.id,function(e){i.material=e.resource,this._setMaterialEvent(s,"remove",t.id,function(){i.material=this.system.defaultMaterial})}),this.enabled&&this.entity.enabled&&e.load(t)))},onEnable:function(){var e=this.system.app;(i=e.scene).on("set:layers",this.onLayersChanged,this),i.layers&&(i.layers.on("add",this.onLayerAdded,this),i.layers.on("remove",this.onLayerRemoved,this));var t,i="asset"===this._type;if(this._model?this.addModelToLayers():i&&this._asset&&(t=e.assets.get(this._asset))&&t.resource!==this._model&&this._bindModelAsset(t),this._materialAsset&&(t=e.assets.get(this._materialAsset))&&t.resource!==this._material&&this._bindMaterialAsset(t),i&&this._mapping)for(var s in this._mapping)this._mapping[s]&&(t=this._getAssetByIdOrPath(this._mapping[s]))&&!t.resource&&e.assets.load(t);0<=this._batchGroupId&&e.batcher.insert(te.BatchGroup.MODEL,this.batchGroupId,this.entity)},onDisable:function(){var e=this.system.app,t=e.scene;t.off("set:layers",this.onLayersChanged,this),t.layers&&(t.layers.off("add",this.onLayerAdded,this),t.layers.off("remove",this.onLayerRemoved,this)),0<=this._batchGroupId&&e.batcher.remove(te.BatchGroup.MODEL,this.batchGroupId,this.entity),this._model&&this.removeModelFromLayers(this._model)},hide:function(){if(this._model){var e,t,i=this._model.meshInstances;for(e=0,t=i.length;e<t;e++)i[e].visible=!1}},show:function(){if(this._model){var e,t,i=this._model.meshInstances;for(e=0,t=i.length;e<t;e++)i[e].visible=!0}},_bindMaterialAsset:function(e){e.on("load",this._onMaterialAssetLoad,this),e.on("unload",this._onMaterialAssetUnload,this),e.on("remove",this._onMaterialAssetRemove,this),e.on("change",this._onMaterialAssetChange,this),e.resource?this._onMaterialAssetLoad(e):this.enabled&&this.entity.enabled&&this.system.app.assets.load(e)},_unbindMaterialAsset:function(e){e.off("load",this._onMaterialAssetLoad,this),e.off("unload",this._onMaterialAssetUnload,this),e.off("remove",this._onMaterialAssetRemove,this),e.off("change",this._onMaterialAssetChange,this)},_onMaterialAssetAdd:function(e){this.system.app.assets.off("add:"+e.id,this._onMaterialAssetAdd,this),this._materialAsset===e.id&&this._bindMaterialAsset(e)},_onMaterialAssetLoad:function(e){this.material=e.resource},_onMaterialAssetUnload:function(e){this.material=this.system.defaultMaterial},_onMaterialAssetRemove:function(e){this._onMaterialAssetUnload(e)},_onMaterialAssetChange:function(e){},_bindModelAsset:function(e){this._unbindModelAsset(e),e.on("load",this._onModelAssetLoad,this),e.on("unload",this._onModelAssetUnload,this),e.on("change",this._onModelAssetChange,this),e.on("remove",this._onModelAssetRemove,this),e.resource?this._onModelAssetLoad(e):this.enabled&&this.entity.enabled&&this.system.app.assets.load(e)},_unbindModelAsset:function(e){e.off("load",this._onModelAssetLoad,this),e.off("unload",this._onModelAssetUnload,this),e.off("change",this._onModelAssetChange,this),e.off("remove",this._onModelAssetRemove,this)},_onModelAssetAdded:function(e){this.system.app.assets.off("add:"+e.id,this._onModelAssetAdd,this),e.id===this._asset&&this._bindModelAsset(e)},_onModelAssetLoad:function(e){this.model=e.resource.clone(),this._clonedModel=!0},_onModelAssetUnload:function(e){this.model=null},_onModelAssetChange:function(e,t,i,s){"data"===t&&(this.mapping=this._mapping)},_onModelAssetRemove:function(e){this.model=null}}),Object.defineProperty(li.prototype,"meshInstances",{get:function(){return this._model?this._model.meshInstances:null},set:function(e){this._model&&(this._model.meshInstances=e)}}),Object.defineProperty(li.prototype,"type",{get:function(){return this._type},set:function(e){if(this._type!==e)if(this._area=null,"asset"===(this._type=e))null!==this._asset?this._bindModelAsset(this._asset):this.model=null;else{var t=this.system,i=t.app.graphicsDevice;switch(e){case"box":t.box||(t.box=te.createBox(i,{halfExtents:new te.Vec3(.5,.5,.5)})),e=t.box,this._area={x:2,y:2,z:2,uv:2/3};break;case"capsule":t.capsule||(t.capsule=te.createCapsule(i,{radius:.5,height:2})),e=t.capsule,this._area={x:2*Math.PI,y:Math.PI,z:2*Math.PI,uv:1/3+1/3/3*2};break;case"cone":t.cone||(t.cone=te.createCone(i,{baseRadius:.5,peakRadius:0,height:1})),e=t.cone,this._area={x:2.54,y:2.54,z:2.54,uv:1/3+1/3/3};break;case"cylinder":t.cylinder||(t.cylinder=te.createCylinder(i,{radius:.5,height:1})),e=t.cylinder,this._area={x:Math.PI,y:1.58,z:Math.PI,uv:1/3+1/3/3*2};break;case"plane":t.plane||(t.plane=te.createPlane(i,{halfExtents:new te.Vec2(.5,.5),widthSegments:1,lengthSegments:1})),e=t.plane,this._area={x:0,y:1,z:0,uv:1};break;case"sphere":t.sphere||(t.sphere=te.createSphere(i,{radius:.5})),e=t.sphere,this._area={x:Math.PI,y:Math.PI,z:Math.PI,uv:1};break;default:throw Error("Invalid model type: "+e)}i=new te.GraphNode;var s=new te.Model;s.graph=i,s.meshInstances=[new te.MeshInstance(i,e,this._material)],t._inTools&&s.generateWireframe(),this.model=s,this._asset=null}}}),Object.defineProperty(li.prototype,"asset",{get:function(){return this._asset},set:function(e){var t=this.system.app.assets,i=e;e instanceof te.Asset&&(i=e.id),this._asset!==i&&(this._asset&&(t.off("add:"+this._asset,this._onModelAssetAdded,this),(e=t.get(this._asset))&&this._unbindModelAsset(e)),(this._asset=i)?(i=t.get(this._asset))?this._bindModelAsset(i):(this.model=null,t.on("add:"+this._asset,this._onModelAssetAdded,this)):this.model=null)}}),Object.defineProperty(li.prototype,"model",{get:function(){return this._model},set:function(e){if(this._model!==e&&(this._model&&(this.removeModelFromLayers(this._model),this.entity.removeChild(this._model.getGraph()),delete this._model._entity,this._clonedModel&&(this._model.destroy(),this._clonedModel=!1)),this._model=e)){e=this._model.meshInstances;for(var t=0;t<e.length;t++)e[t].castShadow=this._castShadows,e[t].receiveShadow=this._receiveShadows,e[t].isStatic=this._isStatic;this.lightmapped=this._lightmapped,this.entity.addChild(this._model.graph),this.enabled&&this.entity.enabled&&this.addModelToLayers(),this._model._entity=this.entity,this.entity.animation&&this.entity.animation.setModel(this._model),"asset"===this.type?this.mapping=this._mapping:this._unsetMaterialEvents()}}}),Object.defineProperty(li.prototype,"lightmapped",{get:function(){return this._lightmapped},set:function(e){var t,i;if(e!==this._lightmapped&&(this._lightmapped=e,this._model)){var s=this._model.meshInstances;if(e)for(e=0;e<s.length;e++)i=(t=s[e]).mask,t.mask=(i|te.MASK_BAKED)&~(te.MASK_DYNAMIC|te.MASK_LIGHTMAP);else for(e=0;e<s.length;e++)(t=s[e]).deleteParameter("texture_lightMap"),t.deleteParameter("texture_dirLightMap"),t._shaderDefs&=~te.SHADERDEF_LM,i=t.mask,t.mask=(i|te.MASK_DYNAMIC)&~(te.MASK_BAKED|te.MASK_LIGHTMAP)}}}),Object.defineProperty(li.prototype,"castShadows",{get:function(){return this._castShadows},set:function(e){if(this._castShadows!==e){var t,i,s=this._model;if(s){var n=this.layers,a=this.system.app.scene;if(this._castShadows&&!e)for(i=0;i<n.length;i++)(t=this.system.app.scene.layers.getLayerById(this.layers[i]))&&t.removeShadowCasters(s.meshInstances);for(t=s.meshInstances,i=0;i<t.length;i++)t[i].castShadow=e;if(!this._castShadows&&e)for(i=0;i<n.length;i++)(t=a.layers.getLayerById(n[i]))&&t.addShadowCasters(s.meshInstances)}this._castShadows=e}}}),Object.defineProperty(li.prototype,"receiveShadows",{get:function(){return this._receiveShadows},set:function(e){if(this._receiveShadows!==e&&(this._receiveShadows=e,this._model))for(var t=this._model.meshInstances,i=0,s=t.length;i<s;i++)t[i].receiveShadow=e}}),Object.defineProperty(li.prototype,"castShadowsLightmap",{get:function(){return this._castShadowsLightmap},set:function(e){this._castShadowsLightmap=e}}),Object.defineProperty(li.prototype,"lightmapSizeMultiplier",{get:function(){return this._lightmapSizeMultiplier},set:function(e){this._lightmapSizeMultiplier=e}}),Object.defineProperty(li.prototype,"isStatic",{get:function(){return this._isStatic},set:function(e){var t;if(this._isStatic!==e&&(this._isStatic=e,this._model)){var i=this._model.meshInstances;for(t=0;t<i.length;t++)i[t].isStatic=e}}}),Object.defineProperty(li.prototype,"layers",{get:function(){return this._layers},set:function(e){var t,i,s=this.system.app.scene.layers;if(this.meshInstances)for(t=0;t<this._layers.length;t++)(i=s.getLayerById(this._layers[t]))&&i.removeMeshInstances(this.meshInstances);for(t=this._layers.length=0;t<e.length;t++)this._layers[t]=e[t];if(this.enabled&&this.entity.enabled&&this.meshInstances)for(t=0;t<this._layers.length;t++)(i=s.getLayerById(this._layers[t]))&&i.addMeshInstances(this.meshInstances)}}),Object.defineProperty(li.prototype,"batchGroupId",{get:function(){return this._batchGroupId},set:function(e){if(this._batchGroupId!==e){var t=this.system.app.batcher;this.entity.enabled&&0<=this._batchGroupId&&t.remove(te.BatchGroup.MODEL,this.batchGroupId,this.entity),this.entity.enabled&&0<=e&&t.insert(te.BatchGroup.MODEL,e,this.entity),e<0&&0<=this._batchGroupId&&this.enabled&&this.entity.enabled&&this.addModelToLayers(),this._batchGroupId=e}}}),Object.defineProperty(li.prototype,"materialAsset",{get:function(){return this._materialAsset},set:function(e){var t=e;if(e instanceof te.Asset&&(t=e.id),e=this.system.app.assets,t!==this._materialAsset){if(this._materialAsset){e.off("add:"+this._materialAsset,this._onMaterialAssetAdd,this);var i=e.get(this._materialAsset);i&&this._unbindMaterialAsset(i)}(this._materialAsset=t)?(t=e.get(this._materialAsset))?this._bindMaterialAsset(t):(this.material=this.system.defaultMaterial,e.on("add:"+this._materialAsset,this._onMaterialAssetAdd,this)):this.material=this.system.defaultMaterial}}}),Object.defineProperty(li.prototype,"material",{get:function(){return this._material},set:function(e){if(this._material!==e&&(this._material=e,(t=this._model)&&"asset"!==this._type))for(var t,i=0,s=(t=t.meshInstances).length;i<s;i++)t[i].material=e}}),Object.defineProperty(li.prototype,"mapping",{get:function(){return this._mapping},set:function(e){if("asset"===this._type&&(this._unsetMaterialEvents(),e||(e={}),this._mapping=e,this._model))for(var t=this._model.meshInstances,i=(i=this.asset?this.system.app.assets.get(this.asset):null)?i.data.mapping:null,s=null,n=0,a=t.length;n<a;n++)if(void 0!==e[n])e[n]?(s=this.system.app.assets.get(e[n]),this._loadAndSetMeshInstanceMaterial(s,t[n],n)):t[n].material=this.system.defaultMaterial;else if(i)if(i[n]&&(i[n].material||i[n].path)){if(void 0!==i[n].material)s=this.system.app.assets.get(i[n].material);else if(void 0!==i[n].path){var r=this._getMaterialAssetUrl(i[n].path);r&&(s=this.system.app.assets.getByUrl(r))}this._loadAndSetMeshInstanceMaterial(s,t[n],n)}else t[n].material=this.system.defaultMaterial}}),{ModelComponent:li})),Object.assign(te,(ci=["enabled"],((di=function(e){te.ComponentSystem.call(this,e),this.id="model",this.description="Renders a 3D model at the location of the Entity.",this.ComponentType=te.ModelComponent,this.DataType=te.ModelComponentData,this.schema=ci,this.sphere=this.plane=this.cylinder=this.cone=this.capsule=this.box=null,this.defaultMaterial=e.scene.defaultMaterial,this.on("beforeremove",this.onRemove,this)}).prototype=Object.create(te.ComponentSystem.prototype)).constructor=di,te.Component._buildAccessors(te.ModelComponent.prototype,ci),Object.assign(di.prototype,{initializeComponentData:function(e,t,i){i="material materialAsset asset castShadows receiveShadows castShadowsLightmap lightmapped lightmapSizeMultiplier type mapping layers isStatic batchGroupId".split(" "),null!==t.batchGroupId&&void 0!==t.batchGroupId||(t.batchGroupId=-1),t.layers&&t.layers.length&&(t.layers=t.layers.slice(0));for(var s=0;s<i.length;s++)t.hasOwnProperty(i[s])&&(e[i[s]]=t[i[s]]);te.ComponentSystem.prototype.initializeComponentData.call(this,e,t,["enabled"])},cloneComponent:function(e,t){var i={type:e.model.type,asset:e.model.asset,castShadows:e.model.castShadows,receiveShadows:e.model.receiveShadows,castShadowsLightmap:e.model.castShadowsLightmap,lightmapped:e.model.lightmapped,lightmapSizeMultiplier:e.model.lightmapSizeMultiplier,isStatic:e.model.isStatic,enabled:e.model.enabled,layers:e.model.layers,batchGroupId:e.model.batchGroupId,mapping:te.extend({},e.model.mapping)},s=e.model.materialAsset;s instanceof te.Asset||null==s||(s=this.app.assets.get(s));var n=e.model.material;if(n&&n!==this.defaultMaterial&&s&&n!==s.resource||(i.materialAsset=s),s=this.addComponent(t,i),e.model.model&&"asset"===e.model.type&&!e.model.asset&&(s.model=e.model.model.clone(),s._clonedModel=!0),i.materialAsset||(s.material=n),e.model.model)for(i=e.model.model.meshInstances,n=s.model.meshInstances,s=0;s<i.length;s++)n[s].mask=i[s].mask,n[s].material=i[s].material,n[s].layer=i[s].layer,n[s].receiveShadow=i[s].receiveShadow},onRemove:function(e,t){t.onRemove()}}),{ModelComponentSystem:di})),Object.assign(te,{ModelComponentData:function(){this.enabled=!0}}),Object.assign(te,(((ui=function(e,t){te.Component.call(this,e,t),this.on("set_aspectRatioMode",this.onSetAspectRatioMode,this),this.on("set_aspectRatio",this.onSetAspectRatio,this),this.on("set_camera",this.onSetCamera,this),this.on("set_clearColor",this.onSetClearColor,this),this.on("set_fov",this.onSetFov,this),this.on("set_orthoHeight",this.onSetOrthoHeight,this),this.on("set_nearClip",this.onSetNearClip,this),this.on("set_farClip",this.onSetFarClip,this),this.on("set_projection",this.onSetProjection,this),this.on("set_priority",this.onSetPriority,this),this.on("set_clearColorBuffer",this.updateClearFlags,this),this.on("set_clearDepthBuffer",this.updateClearFlags,this),this.on("set_clearStencilBuffer",this.updateClearFlags,this),this.on("set_renderTarget",this.onSetRenderTarget,this),this.on("set_rect",this.onSetRect,this),this.on("set_scissorRect",this.onSetScissorRect,this),this.on("set_horizontalFov",this.onSetHorizontalFov,this),this.on("set_frustumCulling",this.onSetFrustumCulling,this),this.on("set_calculateTransform",this.onSetCalculateTransform,this),this.on("set_calculateProjection",this.onSetCalculateProjection,this),this.on("set_cullFaces",this.onSetCullFaces,this),this.on("set_flipFaces",this.onSetFlipFaces,this),this.on("set_layers",this.onSetLayers,this)}).prototype=Object.create(te.Component.prototype)).constructor=ui,Object.defineProperty(ui.prototype,"projectionMatrix",{get:function(){return this.data.camera.getProjectionMatrix()}}),Object.defineProperty(ui.prototype,"viewMatrix",{get:function(){return this.data.camera.getViewMatrix()}}),Object.defineProperty(ui.prototype,"frustum",{get:function(){return this.data.camera.frustum}}),Object.defineProperty(ui.prototype,"vrDisplay",{get:function(){return this.data.camera.vrDisplay},set:function(e){(this.data.camera.vrDisplay=e)&&(e._camera=this.data.camera)}}),Object.defineProperty(ui.prototype,"node",{get:function(){return this.data.camera._node}}),Object.assign(ui.prototype,{screenToWorld:function(e,t,i,s){var n=this.system.app.graphicsDevice;return this.data.camera.screenToWorld(e,t,i,n.clientRect.width,n.clientRect.height,s)},onPrerender:function(){this.data.camera._viewMatDirty=!0,this.data.camera._viewProjMatDirty=!0},worldToScreen:function(e,t){var i=this.system.app.graphicsDevice;return this.data.camera.worldToScreen(e,i.clientRect.width,i.clientRect.height,t)},onSetAspectRatioMode:function(e,t,i){this.data.camera.aspectRatioMode=i},onSetAspectRatio:function(e,t,i){this.data.camera.aspectRatio=i},onSetCamera:function(e,t,i){t&&(t._node=null),i._node=this.entity},onSetClearColor:function(e,t,i){(e=this.data.camera.clearColor)[0]=i.r,e[1]=i.g,e[2]=i.b,e[3]=i.a},onSetFov:function(e,t,i){this.data.camera.fov=i},onSetOrthoHeight:function(e,t,i){this.data.camera.orthoHeight=i},onSetNearClip:function(e,t,i){this.data.camera.nearClip=i},onSetFarClip:function(e,t,i){this.data.camera.farClip=i},onSetHorizontalFov:function(e,t,i){this.data.camera.horizontalFov=i},onSetFrustumCulling:function(e,t,i){this.data.camera.frustumCulling=i},onSetCalculateTransform:function(e,t,i){this._calculateTransform=i,this.camera.overrideCalculateTransform=!!i},onSetCalculateProjection:function(e,t,i){this._calculateProjection=i,this.camera._projMatDirty=!0,this.camera.overrideCalculateProjection=!!i},onSetCullFaces:function(e,t,i){this.camera._cullFaces=i},onSetFlipFaces:function(e,t,i){this.camera._flipFaces=i},onSetProjection:function(e,t,i){this.data.camera.projection=i},onSetPriority:function(e,t,i){for(t=0;t<this.layers.length;t++)(e=this.system.app.scene.layers.getLayerById(this.layers[t]))&&e._sortCameras()},onSetLayers:function(e,t,i){var s;for(e=0;e<t.length;e++)(s=this.system.app.scene.layers.getLayerById(t[e]))&&s.removeCamera(this);if(this.enabled&&this.entity.enabled)for(e=0;e<i.length;e++)(s=this.system.app.scene.layers.getLayerById(i[e]))&&s.addCamera(this)},addCameraToLayers:function(){for(var e,t=0;t<this.layers.length;t++)(e=this.system.app.scene.layers.getLayerById(this.layers[t]))&&e.addCamera(this)},removeCameraFromLayers:function(){for(var e,t=0;t<this.layers.length;t++)(e=this.system.app.scene.layers.getLayerById(this.layers[t]))&&e.removeCamera(this)},onLayersChanged:function(e,t){this.addCameraToLayers(),e.off("add",this.onLayerAdded,this),e.off("remove",this.onLayerRemoved,this),t.on("add",this.onLayerAdded,this),t.on("remove",this.onLayerRemoved,this)},onLayerAdded:function(e){this.layers.indexOf(e.id)<0||e.addCamera(this)},onLayerRemoved:function(e){this.layers.indexOf(e.id)<0||e.removeCamera(this)},updateClearFlags:function(){var e=0;this.clearColorBuffer&&(e|=te.CLEARFLAG_COLOR),this.clearDepthBuffer&&(e|=te.CLEARFLAG_DEPTH),this.clearStencilBuffer&&(e|=te.CLEARFLAG_STENCIL),this.data.camera.clearFlags=e},onSetRenderTarget:function(e,t,i){this.data.camera.renderTarget=i},onSetRect:function(e,t,i){this.data.camera.setRect(i.x,i.y,i.z,i.w)},onSetScissorRect:function(e,t,i){this.data.camera.setScissorRect(i.x,i.y,i.z,i.w)},onEnable:function(){this.system.addCamera(this),this.system.app.scene.on("set:layers",this.onLayersChanged,this),this.system.app.scene.layers&&(this.system.app.scene.layers.on("add",this.onLayerAdded,this),this.system.app.scene.layers.on("remove",this.onLayerRemoved,this)),this.enabled&&this.entity.enabled&&this.addCameraToLayers(),this.postEffects.enable()},onDisable:function(){this.postEffects.disable(),this.removeCameraFromLayers(),this.system.app.scene.off("set:layers",this.onLayersChanged,this),this.system.app.scene.layers&&(this.system.app.scene.layers.off("add",this.onLayerAdded,this),this.system.app.scene.layers.off("remove",this.onLayerRemoved,this)),this.system.removeCamera(this)},onRemove:function(){this.off()},calculateAspectRatio:function(e){e=e||this.system.app.graphicsDevice;var t=this.rect;return e.width*t.z/(e.height*t.w)},frameBegin:function(e){this.aspectRatioMode===te.ASPECT_AUTO&&(this.aspectRatio=this.calculateAspectRatio(e)),this.data.isRendering=!0},frameEnd:function(){this.data.isRendering=!1},enterVr:function(t,i){if(t instanceof Function&&!i&&(i=t,t=null),this.system.app.vr)if(t||(t=this.system.app.vr.display),t){var s=this;t.capabilities.canPresent?t.requestPresent(function(e){e||(s.vrDisplay=t,s.vrDisplay.once("beforepresentchange",function(e){e.presenting||(s.vrDisplay=null)})),i(e)}):(s.vrDisplay=t,i())}else i("No pc.VrDisplay to present");else i("VrManager not created. Enable VR in project settings.")},exitVr:function(e){if(this.vrDisplay)if(this.vrDisplay.capabilities.canPresent){var t=this.vrDisplay;this.vrDisplay=null,t.exitPresent(e)}else this.vrDisplay=null,e();else e("Not presenting VR")}}),{CameraComponent:ui})),Object.assign(te,(pi="enabled clearColorBuffer clearColor clearDepthBuffer clearStencilBuffer frustumCulling projection fov orthoHeight nearClip farClip priority rect scissorRect camera aspectRatio aspectRatioMode horizontalFov model renderTarget calculateTransform calculateProjection cullFaces flipFaces layers".split(" "),((fi=function(e){te.ComponentSystem.call(this,e),this.id="camera",this.description="Renders the scene from the location of the Entity.",this.ComponentType=te.CameraComponent,this.DataType=te.CameraComponentData,this.schema=pi,this.cameras=[],this.on("beforeremove",this.onBeforeRemove,this),this.on("remove",this.onRemove,this),this.app.on("prerender",this.onPrerender,this),te.ComponentSystem.bind("update",this.onUpdate,this)}).prototype=Object.create(te.ComponentSystem.prototype)).constructor=fi,te.Component._buildAccessors(te.CameraComponent.prototype,pi),Object.assign(fi.prototype,{initializeComponentData:function(i,e,t){for(var s={},n=0,a=(t="postEffects enabled model camera aspectRatio aspectRatioMode horizontalFov renderTarget clearColor fov orthoHeight nearClip farClip projection priority clearColorBuffer clearDepthBuffer clearStencilBuffer frustumCulling rect scissorRect calculateTransform calculateProjection cullFaces flipFaces layers".split(" ")).length;n<a;n++){var r=t[n];s[r]=e[r]}s.layers&&"array"===te.type(s.layers)&&(s.layers=s.layers.slice(0)),s.clearColor&&"array"===te.type(s.clearColor)&&(e=s.clearColor,s.clearColor=new te.Color(e[0],e[1],e[2],e[3])),s.rect&&"array"===te.type(s.rect)&&(e=s.rect,s.rect=new te.Vec4(e[0],e[1],e[2],e[3])),s.scissorRect&&"array"===te.type(s.scissorRect)&&(e=s.scissorRect,s.scissorRect=new te.Vec4(e[0],e[1],e[2],e[3])),s.activate&&(s.enabled=s.activate),s.camera=new te.Camera,s._node=i.entity,s.camera._component=i,s.camera.calculateTransform=function(e,t){return i._calculateTransform?i._calculateTransform(e,t):null},s.camera.calculateProjection=function(e,t){return i._calculateProjection?i._calculateProjection(e,t):null},s.postEffects=new te.PostEffectQueue(this.app,i),te.ComponentSystem.prototype.initializeComponentData.call(this,i,s,t)},onBeforeRemove:function(e,t){this.removeCamera(t),t.onRemove()},onRemove:function(e,t){t.camera=null},onUpdate:function(e){var t,i,s,n;if(e=this.store,this.app.vr)for(var a in e)n=(s=(i=(t=e[a]).data).camera).vrDisplay,i.enabled&&t.entity.enabled&&n&&(n.setClipPlanes(s._nearClip,s._farClip),s._node&&(s._node.localTransform.copy(n.combinedViewInv),s._node._dirtyLocal=!1,s._node._dirtifyWorld()))},onPrerender:function(){for(var e=0,t=this.cameras.length;e<t;e++)this.cameras[e].onPrerender()},addCamera:function(e){this.cameras.push(e),this.sortCamerasByPriority()},removeCamera:function(e){0<=(e=this.cameras.indexOf(e))&&(this.cameras.splice(e,1),this.sortCamerasByPriority())},sortCamerasByPriority:function(){this.cameras.sort(function(e,t){return e.priority-t.priority})}}),{CameraComponentSystem:fi})),Object.assign(te,{CameraComponentData:function(){this.clearColor=new te.Color(.722,.722,.722,1),this.clearStencilBuffer=this.clearDepthBuffer=this.clearColorBuffer=!0,this.nearClip=.1,this.farClip=1e3,this.fov=45,this.orthoHeight=100,this.projection=te.PROJECTION_PERSPECTIVE,this.priority=0,this.rect=new te.Vec4(0,0,1,1),this.scissorRect=new te.Vec4(0,0,1,1),this.enabled=!0,this.frustumCulling=!1,this.cullFaces=!0,this.flipFaces=!1,this.layers=[te.LAYERID_WORLD,te.LAYERID_DEPTH,te.LAYERID_SKYBOX,te.LAYERID_UI,te.LAYERID_IMMEDIATE],this.camera=null,this.aspectRatio=16/9,this.aspectRatioMode=te.ASPECT_AUTO,this.postEffects=this.renderTarget=null,this.isRendering=!1,this.calculateProjection=this.calculateTransform=null}}),Object.assign(te,function(){function e(e,t){var i=this;this.app=e,this.camera=t,this.effects=[],this.enabled=!1,this.depthTarget=null,this.renderTargetScale=1,this.resizeTimeout=null,this.resizeLast=0,this._resizeTimeoutCallback=function(){i.resizeRenderTargets()},t.on("set_rect",this.onCameraRectChanged,this),this._origStencilColorBuffer=this._origDepthColorBuffer=this._origClearColorBuffer=this._origOverrideClear=!1}var t;return Object.assign(e.prototype,{_createOffscreenTarget:function(e,t){var i=this.camera.rect,s=Math.floor(i.z*this.app.graphicsDevice.width*this.renderTargetScale),n=Math.floor(i.w*this.app.graphicsDevice.height*this.renderTargetScale),a=this.app.graphicsDevice,r=t?a.getHdrFormat():te.PIXELFORMAT_R8_G8_B8_A8;i=this.app.graphicsDevice.supportsStencil;return(s=new te.Texture(a,{format:r,width:s,height:n})).name="posteffect #"+this.effects.length,s.minFilter=te.FILTER_NEAREST,s.magFilter=te.FILTER_NEAREST,s.addressU=te.ADDRESS_CLAMP_TO_EDGE,s.addressV=te.ADDRESS_CLAMP_TO_EDGE,new te.RenderTarget(this.app.graphicsDevice,s,{depth:e,stencil:i})},_resizeOffscreenTarget:function(e){var t=this.camera.rect,i=Math.floor(t.z*this.app.graphicsDevice.width*this.renderTargetScale),s=(t=Math.floor(t.w*this.app.graphicsDevice.height*this.renderTargetScale),this.app.graphicsDevice),n=e.colorBuffer.format;e._colorBuffer.destroy(),(i=new te.Texture(s,{format:n,width:i,height:t})).name="posteffect",i.minFilter=te.FILTER_NEAREST,i.magFilter=te.FILTER_NEAREST,i.addressU=te.ADDRESS_CLAMP_TO_EDGE,i.addressV=te.ADDRESS_CLAMP_TO_EDGE,e._colorBuffer=i,e.destroy()},_destroyOffscreenTarget:function(e){e._colorBuffer&&e._colorBuffer.destroy(),e._depthBuffer&&e._depthBuffer.destroy(),e.destroy()},setRenderTargetScale:function(e){this.renderTargetScale=e,this.resizeRenderTargets()},addEffect:function(e){var t=this.effects,i={effect:e,inputTarget:this._createOffscreenTarget(0===this.effects.length,e.hdr),outputTarget:null};if(!this.layer){this.layer=new te.Layer({opaqueSortMode:te.SORTMODE_NONE,transparentSortMode:te.SORTMODE_NONE,passThrough:!0,name:"PostEffectQueue",renderTarget:this.camera.renderTarget,clear:!1,onPostRender:function(){for(var e=0;e<this._commandList.length;e++)this._commandList[e]()}});var s,n=0,a=(r=this.app.scene.layers.layerList).length-1;for(s=a;0<=s;s--)if(r[s].id===te.LAYERID_UI){a=s-1,this._origOverrideClear=r[s].overrideClear,this._origClearColorBuffer=r[s].clearColorBuffer,this._origDepthColorBuffer=r[s].clearDepthBuffer,this._origStencilColorBuffer=r[s].clearStencilBuffer,r[s].overrideClear=!0,r[s].clearColorBuffer=!1,r[s].clearDepthBuffer=this.camera.clearDepthBuffer,r[s].clearStencilBuffer=this.camera.clearStencilBuffer;break}for(this._sourceLayers=[],s=0;s<this.camera.layers.length;s++){var r=this.camera.layers[s],o=this.app.scene.layers.getLayerById(r),h=this.app.scene.layers.layerList.indexOf(o);h<=a&&(r!=te.LAYERID_DEPTH&&(o.renderTarget=i.inputTarget,this._sourceLayers.push(o)),n<h&&(n=h))}this.app.scene.layers.insertOpaque(this.layer,n+1),this._sourceTarget=i.inputTarget,this.layer._commandList=[],this.layer.isPostEffect=!0}t.push(i),1<(n=t.length)&&(t[n-2].outputTarget=i.inputTarget),(this._newPostEffect=e).needsDepthBuffer&&this._requestDepthMap(),this.enable(),this._newPostEffect=void 0},removeEffect:function(e){var t,i,s=-1;for(t=0,i=this.effects.length;t<i;t++)if(this.effects[t].effect===e){s=t;break}if(0<=s){if(0<s)this.effects[s-1].outputTarget=s+1<this.effects.length?this.effects[s+1].inputTarget:null;else if(1<this.effects.length)for(this.effects[1].inputTarget._depth||(this._destroyOffscreenTarget(this.effects[1].inputTarget),this.effects[1].inputTarget=this._createOffscreenTarget(!0,this.effects[1].hdr),this._sourceTarget=this.effects[1].inputTarget),t=0;t<this._sourceLayers.length;t++)this._sourceLayers[t].renderTarget=this.effects[1].inputTarget;this._destroyOffscreenTarget(this.effects[s].inputTarget),this.effects.splice(s,1)}this.enabled&&e.needsDepthBuffer&&this._releaseDepthMap(),0===this.effects.length&&this.disable()},_requestDepthMaps:function(){for(var e=0,t=this.effects.length;e<t;e++){var i=this.effects[e].effect;this._newPostEffect!==i&&i.needsDepthBuffer&&this._requestDepthMap()}},_releaseDepthMaps:function(){for(var e=0,t=this.effects.length;e<t;e++)this.effects[e].effect.needsDepthBuffer&&this._releaseDepthMap()},_requestDepthMap:function(){t||(t=this.app.scene.layers.getLayerById(te.LAYERID_DEPTH)),t&&t.incrementCounter()},_releaseDepthMap:function(){t&&t.decrementCounter()},destroy:function(){for(var e=0,t=this.effects.length;e<t;e++)this.effects[e].inputTarget.destroy();this.effects.length=0,this.disable()},enable:function(){if(!this.enabled&&this.effects.length){this.enabled=!0;var n=this;this._requestDepthMaps(),this.app.graphicsDevice.on("resizecanvas",this._onCanvasResized,this),this.command=function(){if(n.enabled){var e=null,t=n.effects.length;if(t){n.layer.renderTarget=n.effects[0].inputTarget;for(var i=0;i<t;i++){var s=n.effects[i];i===t-1&&(e=n.camera.rect),s.effect.render(s.inputTarget,s.outputTarget,e)}}}},this.layer._commandList.push(this.command)}},disable:function(){if(this.enabled){this.enabled=!1,this.app.graphicsDevice.off("resizecanvas",this._onCanvasResized,this),this._releaseDepthMaps(),this._destroyOffscreenTarget(this._sourceTarget),0<=(i=this.layer._commandList.indexOf(this.command))&&this.layer._commandList.splice(i,1);for(var e=this.app.scene.layers.layerList,t=e.length-1,i=0;i<=e.length;i++)if(e[i].id===te.LAYERID_UI){t=i-1,e[i].overrideClear=this._origOverrideClear,e[i].clearColorBuffer=this._origClearColorBuffer,e[i].clearDepthBuffer=this._origDepthColorBuffer,e[i].clearStencilBuffer=this._origStencilColorBuffer;break}for(i=t;0<=i;i--)0<=e[i].cameras.indexOf(this.camera)&&(e[i].renderTarget=void 0);this.app.scene.layers.removeOpaque(this.layer),this.layer=null}},_onCanvasResized:function(e,t){var i=this.camera.rect,s=this.app.graphicsDevice;this.camera.camera.aspectRatio=s.width*i.z/(s.height*i.w),this.resizeTimeout||(100<te.now()-this.resizeLast?this.resizeRenderTargets():this.resizeTimeout=setTimeout(this._resizeTimeoutCallback,100))},resizeRenderTargets:function(){this.resizeTimeout&&(clearTimeout(this.resizeTimeout),this.resizeTimeout=null),this.resizeLast=te.now();for(var e=this.camera.rect,t=Math.floor(e.z*this.app.graphicsDevice.width*this.renderTargetScale),i=(e=Math.floor(e.w*this.app.graphicsDevice.height*this.renderTargetScale),this.effects),s=0,n=i.length;s<n;s++){var a=i[s];a.inputTarget.width===t&&a.inputTarget.height===e||this._resizeOffscreenTarget(a.inputTarget)}},onCameraRectChanged:function(e,t,i){this.enabled&&this.resizeRenderTargets()}}),{PostEffectQueue:e}}()),Object.assign(te,function(){function e(S,e){this.app=S,this.srcRenderTarget=e.srcRenderTarget,this.hdr=e.hdr,this.blending=e.blending,this.shader=e.shader,this.setup=e.setup;var i=this,T=S.graphicsDevice;if(this.layer=new te.Layer({opaqueSortMode:te.SORTMODE_NONE,transparentSortMode:te.SORTMODE_NONE,passThrough:!0,name:e.name,onPostRender:function(){if(i.srcRenderTarget?(r.x=i.srcRenderTarget.width,r.y=i.srcRenderTarget.height,r.z=1/i.srcRenderTarget.width,r.w=1/i.srcRenderTarget.height):(r.x=T.width,r.y=T.height,r.z=1/T.width,r.w=1/T.height),o[0]=r.x,o[1]=r.y,o[2]=r.z,o[3]=r.w,n.setValue(o),this._postEffectCombined&&this._postEffectCombined<0)i.setup&&i.setup(T,i,r,null,this.renderTarget);else{var e;1<(e=this._postEffectCombinedSrc?this._postEffectCombinedSrc:i.srcRenderTarget?i.srcRenderTarget:E[this._backbufferRtId])._samples&&e.resolve(!0,!1);var t=e._colorBuffer;if(t.magFilter=(this._postEffectCombinedShader?this._postEffectCombinedBilinear:this.postEffectBilinear)?te.FILTER_LINEAR:te.FILTER_NEAREST,a.setValue(t),i.setup&&i.setup(T,i,r,e,this.renderTarget),(e=this._postEffectCombinedShader?this._postEffectCombinedShader:this.shader)&&te.drawQuadWithShader(T,this.renderTarget,e,null,null,i.blending),!i.srcRenderTarget)for(e=S.scene.layers.layerList,t=0;t<e.length&&e[t]!==i.layer;t++)e[t].renderTarget!==E[0]&&e[t].renderTarget!==E[1]||(e[t].renderTarget=null)}}}),this.layer._generateCameraHash(),this.layer.isPostEffect=!0,this.layer.unmodifiedUvs=e.unmodifiedUvs,this.layer.postEffectBilinear=e.bilinear,(this.layer.postEffect=this).layer.shader=e.shader,this.layer.renderTarget=e.destRenderTarget,!a){a=T.scope.resolve("uColorBuffer"),n=T.scope.resolve("uScreenSize");for(var t=T.supportsMsaa?4:1,s=0;s<2;s++)E[s]=new te.RenderTarget({depth:!0,stencil:T.supportsStencil,samples:t,autoResolve:!1}),E[s].name="backbuffer"+s;S.on("prerender",function(){var e,t,i=S.scene.layers.layerList,s=0,n=0;C=M=A=!1;var a=te.PIXELFORMAT_R8_G8_B8_A8;if(S.scene.layers._dirty){var r,o,h=0;for(e=0;e<i.length;e++){var l;if(t=!1,(l=i[e].isPostEffect)&&!(l=0===h)&&(l=i[e].unmodifiedUvs&&i[e].shader)){e:{var c,d,u,p;o=x;var f=h;if(0!==(y=z((r=i)[e].shader.definition.fshader)).length)for(p=0;p<f;p++)for(u=0;u<y.length;u++)for(l=y[u],c=z(r[o[p]].shader.definition.fshader),d=0;d<c.length;d++)if(c[d]===l){l=!0;break e}l=!1}l=!l}if(l?(x[h]=e,h++,e===i.length-1&&(t=!0)):0<h&&(t=!0),t){if(1<h){for(l="post_",t=0;t<h;t++)l+=(c=i[x[t]]).name?c.name:c.id,t<h-1&&(l+="_");if(!(c=T.programLib._cache[l])){for(d="vec4 shaderOutput;\n",u="void main() {\n",p=[],t=0;t<h;t++){var m,_,g,y;c=(c=i[x[t]].shader.definition.fshader+"\n").replace(R,"//").replace(L,"//").replace(D,"//").replace(N,"shaderOutput"),0<t&&(c=c.replace(F,"//").replace(B,"//").replace(k,"shaderOutput;//")),o=p,_=(y=c=c.replace(V,"void main"+t)).length;var v=0,b=m=0;f="";for(r=0;r<_;r++)"{"===(g=y.charAt(r))?(0===m&&(v=r),m++):"}"===g&&(1===m&&(g=r,f+=y.substr(b,v-b+1),b=g),m--);for(v=null,b=(f+=y.substr(b,y.length-b+1)).match(P)||[],r=0;r<b.length;r++)for(y=b[r].split(","),_=0;_<y.length;_++)m=y[_].replace(I,"").trim(),0<=o.indexOf(m)?(v||(v=[]),v.push(m)):o.push(m);for(f=f.match(w)||[],r=0;r<f.length;r++)for(y=f[r].split(","),_=0;_<y.length;_++)m=y[_].replace(O,"").trim(),0<=(m=o.indexOf(m))&&o.splice(m,1);if(r=v)for(o=0;o<r.length;o++)c=c.replace(new RegExp("\\b"+r[o]+"\\b","g"),r[o]+"NNNN"+t);d+=c,u+="main"+t+"();\n"}u+="gl_FragColor = shaderOutput;\n}\n",c=te.shaderChunks.createShaderFromCode(T,te.shaderChunks.fullscreenQuadVS,d+u,l)}for(t=0;t<h;t++)i[x[t]]._postEffectCombined=t===h-1?1:-1;i[x[h-1]]._postEffectCombinedShader=c,i[x[h-1]]._postEffectCombinedBilinear=i[x[0]].postEffectBilinear,i[x[h-1]]._postEffectCombinedSrc=i[x[0]].postEffect.srcRenderTarget}x[0]=e,h=1}}}for(e=0;e<i.length;e++){if(i[e].isPostEffect&&(!i[e].postEffect.srcRenderTarget&&!i[e]._postEffectCombined||!i[e].postEffect._postEffectCombinedSrc&&0<=i[e]._postEffectCombined)){for(t=e-1;s<=t;t--)i[t].renderTarget||(i[t].renderTarget=E[n]);i[e]._backbufferRtId=n,A=!0,1===n&&(M=!0),i[s=e].postEffect.hdr&&(a=T.webgl2&&T.textureFloatRenderable?te.PIXELFORMAT_111110F:T.extTextureHalfFloatLinear&&T.textureHalfFloatRenderable?te.PIXELFORMAT_RGBA16F:te.PIXELFORMAT_R8_G8_B8_A8),i[e].postEffect.shader&&!i[e].renderTarget&&(n=1-n)}else i[e].isPostEffect||i[e].renderTarget||!A||(i[e].renderTarget=E[n]);i[e].isPostEffect&&!i[e].renderTarget&&(C=!0)}A&&(E[0].colorBuffer?E[0].width===T.width&&E[0].height===T.height&&E[0]._colorBuffer._format===a||(E[0].colorBuffer.destroy(),E[0].destroy(),U(0,T,a)):U(0,T,a)),M&&(E[1].colorBuffer?E[1].width===T.width&&E[1].height===T.height&&E[1]._colorBuffer._format===a||(E[1].colorBuffer.destroy(),E[1].destroy(),U(1,T,a)):U(1,T,a))},this),S.on("postrender",function(){var e=S.graphicsDevice;if(A&&!C){for(var t,i=S.scene.layers.layerList,s=i.length-1;0<=s&&((t=i[s].renderTarget)!==E[0]&&t!==E[1]);s--);t&&(1<t._samples&&t.resolve(!0,!1),e.copyRenderTarget(t,null,!0,!1))}},this)}}var n,E=[null,null],a=null,r=new te.Vec4,o=new Float32Array(4),x=[],A=!1,M=!1,C=!1,h=/uniform[ \t\n\r]+\S+[ \t\n\r]+\S+[ \t\n\r]*\;/g,l=/\S+[ \t\n\r]*\;/,c=/[ \t\n\r]*\;/,P=/(float|int|bool|vec2|vec3|vec4|struct)([ \t\n\r]+[^\;]+[ \t\n\r]*\,*)+\;/g,I=/(float|int|bool|vec2|vec3|vec4|struct|\,|\;|\{|\})/g,w=/(uniform|varying|in|out)[ \t\n\r]+(float|int|bool|vec2|vec3|vec4|struct)([ \t\n\r]+[^\;]+[ \t\n\r]*\,*)+\;/g,O=/(float|int|bool|vec2|vec3|vec4|struct|uniform|varying|in|out|\,|\;|\{|\})/g,R=/#version/g,L=/out highp vec4 pc_fragColor;/g,D=/#define gl_FragColor/g,N=/gl_FragColor/g,F=/uniform[ \t\n\r]+sampler2D[ \t\n\r]+uColorBuffer;/g,B=/(varying|in)[ \t\n\r]+vec2[ \t\n\r]+vUv0;/g,k=/(texture2D|texture)[ \t\n\r]*\([ \t\n\r]*uColorBuffer/g,V=/void[ \t\n\r]+main/g,U=function(e,t,i){(t=new te.Texture(t,{format:i,width:t.width,height:t.height})).name="posteffect-pass",t.minFilter=te.FILTER_NEAREST,t.magFilter=te.FILTER_NEAREST,t.addressU=te.ADDRESS_CLAMP_TO_EDGE,t.addressV=te.ADDRESS_CLAMP_TO_EDGE,E[e]._colorBuffer=t},z=function(e){e=e.match(h)||[];for(var t,i,s=[],n=0;n<e.length;n++)t=e[n].search(l),i=e[n].search(c),"uColorBuffer"!==(t=e[n].substr(t,i-t))&&s.push(t);return s};return e.prototype.addToComposition=function(e){this.app.scene.layers.insertTransparent(this.layer,e)},{PostEffectPass:e}}()),Object.assign(te,function(){var i=function(e,t){te.Component.call(this,e,t),this._cookieAssetId=this._cookieAsset=null,this._cookieAssetAdd=!1,this._cookieMatrix=null};(i.prototype=Object.create(te.Component.prototype)).constructor=i;var r=[],o=[],e=function(s,e,n,a){var t=i.prototype;r.push(s),o.push(e),Object.defineProperty(t,s,{get:function(){return this.data[s]},set:function(e){var t=this.data,i=t[s];(a||i!==e)&&(t[s]=e,n&&n.call(this,e,i))},configurable:!0})};return e("enabled",!0,function(e,t){this.onSetEnabled(null,t,e)}),e("light",null),e("type","directional",function(e,t){this.system.changeType(this,t,e),this.refreshProperties()}),e("color",new te.Color(1,1,1),function(e,t){this.light.setColor(e)},!0),e("intensity",1,function(e,t){this.light.intensity=e}),e("castShadows",!1,function(e,t){this.light.castShadows=e}),e("shadowDistance",40,function(e,t){this.light.shadowDistance=e}),e("shadowResolution",1024,function(e,t){this.light.shadowResolution=e}),e("shadowBias",.05,function(e,t){this.light.shadowBias=-.01*e}),e("normalOffsetBias",0,function(e,t){this.light.normalOffsetBias=e}),e("range",10,function(e,t){this.light.attenuationEnd=e}),e("innerConeAngle",40,function(e,t){this.light.innerConeAngle=e}),e("outerConeAngle",45,function(e,t){this.light.outerConeAngle=e}),e("falloffMode",te.LIGHTFALLOFF_LINEAR,function(e,t){this.light.falloffMode=e}),e("shadowType",te.SHADOW_PCF3,function(e,t){this.light.shadowType=e}),e("vsmBlurSize",11,function(e,t){this.light.vsmBlurSize=e}),e("vsmBlurMode",te.BLUR_GAUSSIAN,function(e,t){this.light.vsmBlurMode=e}),e("vsmBias",.0025,function(e,t){this.light.vsmBias=e}),e("cookieAsset",null,function(e,t){if(!this._cookieAssetId||!(e instanceof te.Asset&&e.id===this._cookieAssetId||e===this._cookieAssetId))if(this.onCookieAssetRemove(),this._cookieAssetId=null,e instanceof te.Asset)this._cookieAssetId=this.data.cookieAsset=e.id,this.onCookieAssetAdd(e);else if("number"==typeof e){this._cookieAssetId=e;var i=this.system.app.assets.get(e);i?this.onCookieAssetAdd(i):(this._cookieAssetAdd=!0,this.system.app.assets.on("add:"+this._cookieAssetId,this.onCookieAssetAdd,this))}}),e("cookie",null,function(e,t){this.light.cookie=e}),e("cookieIntensity",1,function(e,t){this.light.cookieIntensity=e}),e("cookieFalloff",!0,function(e,t){this.light.cookieFalloff=e}),e("cookieChannel","rgb",function(e,t){this.light.cookieChannel=e}),e("cookieAngle",0,function(e,t){if(0!==e||null!==this.cookieScale){this._cookieMatrix||(this._cookieMatrix=new te.Vec4);var i=1,s=1;this.cookieScale&&(i=this.cookieScale.x,s=this.cookieScale.y);var n=Math.cos(e*te.math.DEG_TO_RAD),a=Math.sin(e*te.math.DEG_TO_RAD);this._cookieMatrix.set(n/i,-a/i,a/s,n/s),this.light.cookieTransform=this._cookieMatrix}else this.light.cookieTransform=null}),e("cookieScale",null,function(e,t){if(null!==e||0!==this.cookieAngle){this._cookieMatrix||(this._cookieMatrix=new te.Vec4);var i=e.x,s=e.y,n=Math.cos(this.cookieAngle*te.math.DEG_TO_RAD),a=Math.sin(this.cookieAngle*te.math.DEG_TO_RAD);this._cookieMatrix.set(n/i,-a/i,a/s,n/s),this.light.cookieTransform=this._cookieMatrix}else this.light.cookieTransform=null},!0),e("cookieOffset",null,function(e,t){this.light.cookieOffset=e},!0),e("shadowUpdateMode",te.SHADOWUPDATE_REALTIME,function(e,t){this.light.shadowUpdateMode=e}),e("mask",1,function(e,t){this.light.mask=e}),e("affectDynamic",!0,function(e,t){this.light.mask=e?this.light.mask|te.MASK_DYNAMIC:this.light.mask&~te.MASK_DYNAMIC,this.light.mask=this.light._mask}),e("affectLightmapped",!1,function(e,t){e?(this.light.mask|=te.MASK_BAKED,this.bake&&(this.light.mask&=~te.MASK_LIGHTMAP)):(this.light.mask&=~te.MASK_BAKED,this.bake&&(this.light.mask|=te.MASK_LIGHTMAP)),this.light.mask=this.light._mask}),e("bake",!1,function(e,t){e?(this.light.mask|=te.MASK_LIGHTMAP,this.affectLightmapped&&(this.light.mask&=~te.MASK_BAKED)):(this.light.mask&=~te.MASK_LIGHTMAP,this.affectLightmapped&&(this.light.mask|=te.MASK_BAKED)),this.light.mask=this.light._mask}),e("bakeDir",!0,function(e,t){this.light.bakeDir=e}),e("isStatic",!1,function(e,t){this.light.isStatic=e}),e("layers",[te.LAYERID_WORLD],function(e,t){var i,s;for(i=0;i<t.length;i++)(s=this.system.app.scene.layers.getLayerById(t[i]))&&s.removeLight(this);for(i=0;i<e.length;i++)(s=this.system.app.scene.layers.getLayerById(e[i]))&&this.enabled&&this.entity.enabled&&s.addLight(this)}),Object.defineProperty(i.prototype,"enable",{get:function(){return this.enabled},set:function(e){this.enabled=e}}),Object.assign(i.prototype,{addLightToLayers:function(){for(var e,t=0;t<this.layers.length;t++)(e=this.system.app.scene.layers.getLayerById(this.layers[t]))&&e.addLight(this)},removeLightFromLayers:function(){for(var e,t=0;t<this.layers.length;t++)(e=this.system.app.scene.layers.getLayerById(this.layers[t]))&&e.removeLight(this)},onLayersChanged:function(e,t){this.enabled&&this.entity.enabled&&this.addLightToLayers(),e.off("add",this.onLayerAdded,this),e.off("remove",this.onLayerRemoved,this),t.on("add",this.onLayerAdded,this),t.on("remove",this.onLayerRemoved,this)},onLayerAdded:function(e){this.layers.indexOf(e.id)<0||this.enabled&&this.entity.enabled&&e.addLight(this)},onLayerRemoved:function(e){this.layers.indexOf(e.id)<0||e.removeLight(this)},refreshProperties:function(){for(var e,t=0;t<r.length;t++)this[e=r[t]]=this[e];this.enabled&&this.entity.enabled&&this.onEnable()},updateShadow:function(){this.light.updateShadow()},onCookieAssetSet:function(){var e=!1;"cubemap"!==this._cookieAsset.type||this._cookieAsset.loadFaces||(e=this._cookieAsset.loadFaces=!0),this._cookieAsset.resource&&!e||this.system.app.assets.load(this._cookieAsset),this._cookieAsset.resource&&this.onCookieAssetLoad()},onCookieAssetAdd:function(e){this._cookieAssetId===e.id&&(this._cookieAsset=e,this.light._enabled&&this.onCookieAssetSet(),this._cookieAsset.on("load",this.onCookieAssetLoad,this),this._cookieAsset.on("remove",this.onCookieAssetRemove,this))},onCookieAssetLoad:function(){this._cookieAsset&&this._cookieAsset.resource&&(this.cookie=this._cookieAsset.resource)},onCookieAssetRemove:function(){this._cookieAssetId&&(this._cookieAssetAdd&&(this.system.app.assets.off("add:"+this._cookieAssetId,this.onCookieAssetAdd,this),this._cookieAssetAdd=!1),this._cookieAsset&&(this._cookieAsset.off("load",this.onCookieAssetLoad,this),this._cookieAsset.off("remove",this.onCookieAssetRemove,this),this._cookieAsset=null),this.cookie=null)},onEnable:function(){this.light.enabled=!0,this.system.app.scene.on("set:layers",this.onLayersChanged,this),this.system.app.scene.layers&&(this.system.app.scene.layers.on("add",this.onLayerAdded,this),this.system.app.scene.layers.on("remove",this.onLayerRemoved,this)),this.enabled&&this.entity.enabled&&this.addLightToLayers(),this._cookieAsset&&!this.cookie&&this.onCookieAssetSet()},onDisable:function(){this.light.enabled=!1,this.system.app.scene.off("set:layers",this.onLayersChanged,this),this.system.app.scene.layers&&(this.system.app.scene.layers.off("add",this.onLayerAdded,this),this.system.app.scene.layers.off("remove",this.onLayerRemoved,this)),this.removeLightFromLayers()}}),{LightComponent:i,_lightProps:r,_lightPropsDefault:o}}()),Object.assign(te,(mi={directional:te.LIGHTTYPE_DIRECTIONAL,point:te.LIGHTTYPE_POINT,spot:te.LIGHTTYPE_SPOT},((_i=function(e){te.ComponentSystem.call(this,e),this.id="light",this.description="Enables the Entity to emit light.",this.ComponentType=te.LightComponent,this.DataType=te.LightComponentData}).prototype=Object.create(te.ComponentSystem.prototype)).constructor=_i,Object.assign(_i.prototype,{initializeComponentData:function(e,t){for(var i=te._lightProps,s={},n=0,a=i.length;n<a;n++){var r=i[n];s[r]=t[r]}s.type||(s.type=e.data.type),e.data.type=s.type,s.layers&&"array"===te.type(s.layers)&&(s.layers=s.layers.slice(0)),s.color&&"array"===te.type(s.color)&&(s.color=new te.Color(s.color[0],s.color[1],s.color[2])),s.cookieOffset&&s.cookieOffset instanceof Array&&(s.cookieOffset=new te.Vec2(s.cookieOffset[0],s.cookieOffset[1])),s.cookieScale&&s.cookieScale instanceof Array&&(s.cookieScale=new te.Vec2(s.cookieScale[0],s.cookieScale[1])),s.enable&&(s.enabled=s.enable),(n=new te.Light).type=mi[s.type],n._node=e.entity,n._scene=this.app.scene,e.data.light=n,te.ComponentSystem.prototype.initializeComponentData.call(this,e,s,i)},removeComponent:function(e){e.light.data.light.destroy(),te.ComponentSystem.prototype.removeComponent.call(this,e)},cloneComponent:function(e,t){for(var i,s=e.light,n=[],a=te._lightProps,r=0;r<a.length;r++)"light"!==(i=a[r])&&(n[i]=s[i]&&s[i].clone?s[i].clone():s[i]);this.addComponent(t,n)},changeType:function(e,t,i){t!==i&&(e.light.type=mi[i])}}),{LightComponentSystem:_i})),Object.assign(te,{LightComponentData:function(){for(var e,t=te._lightProps,i=te._lightPropsDefault,s=0;s<t.length;s++)e=i[s],this[t[s]]=e&&e.clone?e.clone():e}}),Object.assign(te,((((gi=function(e,t){te.Component.call(this,e,t),this._scripts=[],this._updateList=new te.SortedLoopArray({sortBy:"__executionOrder"}),this._postUpdateList=new te.SortedLoopArray({sortBy:"__executionOrder"}),this._scriptsIndex={},this._destroyedScripts=[],this._destroyed=!1,this._scriptsData=null,this._enabled=this._oldState=!0,this._isLoopingThroughScripts=this._beingEnabled=!1,this._executionOrder=-1,this.on("set_enabled",this._onSetEnabled,this)}).prototype=Object.create(te.Component.prototype)).constructor=gi).scriptMethods={initialize:"initialize",postInitialize:"postInitialize",update:"update",postUpdate:"postUpdate",swap:"swap"},Object.assign(gi.prototype,{onEnable:function(){this._beingEnabled=!0,this._checkState(),this.entity._beingEnabled||this.onPostStateChange(),this._beingEnabled=!1},onDisable:function(){this._checkState()},onPostStateChange:function(){for(var e,t=this._beginLooping(),i=0,s=this.scripts.length;i<s;i++)(e=this.scripts[i])._initialized&&!e._postInitialized&&e.enabled&&(e._postInitialized=!0,e.postInitialize&&this._scriptMethod(e,gi.scriptMethods.postInitialize));this._endLooping(t)},_beginLooping:function(){var e=this._isLoopingThroughScripts;return this._isLoopingThroughScripts=!0,e},_endLooping:function(e){(this._isLoopingThroughScripts=e)||this._removeDestroyedScripts()},_onSetEnabled:function(e,t,i){this._beingEnabled=!0,this._checkState(),this._beingEnabled=!1},_checkState:function(){if((t=this.enabled&&this.entity.enabled)!==this._oldState){this._oldState=t,this.fire(t?"enable":"disable"),this.fire("state",t),t?this.system._addComponentToEnabled(this):this.system._removeComponentFromEnabled(this);for(var e,t=this._beginLooping(),i=0,s=this.scripts.length;i<s;i++)(e=this.scripts[i]).enabled=e._enabled;this._endLooping(t)}},_onBeforeRemove:function(){this.fire("remove");for(var e=this._beginLooping(),t=0;t<this.scripts.length;t++){var i=this.scripts[t];i&&this.destroy(i.__scriptType.__name)}this._endLooping(e)},_removeDestroyedScripts:function(){var e=this._destroyedScripts.length;if(e){var t;for(t=0;t<e;t++)this._removeScriptInstance(this._destroyedScripts[t]);this._destroyedScripts.length=0,this._resetExecutionOrder(0,this._scripts.length)}},_onInitializeAttributes:function(){for(var e=0,t=this.scripts.length;e<t;e++)this.scripts[e].__initializeAttributes()},_scriptMethod:function(e,t,i){e[t](i)},_onInitialize:function(){for(var e,t=this._scripts,i=this._beginLooping(),s=0,n=t.length;s<n;s++)!(e=t[s])._initialized&&e.enabled&&(e._initialized=!0,e.initialize&&this._scriptMethod(e,gi.scriptMethods.initialize));this._endLooping(i)},_onPostInitialize:function(){this.onPostStateChange()},_onUpdate:function(e){var t=this._updateList;if(t.length){var i,s=this._beginLooping();for(t.loopIndex=0;t.loopIndex<t.length;t.loopIndex++)(i=t.items[t.loopIndex]).enabled&&this._scriptMethod(i,gi.scriptMethods.update,e);this._endLooping(s)}},_onPostUpdate:function(e){var t=this._postUpdateList;if(t.length){var i,s=this._beginLooping();for(t.loopIndex=0;t.loopIndex<t.length;t.loopIndex++)(i=t.items[t.loopIndex]).enabled&&this._scriptMethod(i,gi.scriptMethods.postUpdate,e);this._endLooping(s)}},_insertScriptInstance:function(e,t,i){-1===t?(this._scripts.push(e),e.__executionOrder=i,e.update&&this._updateList.append(e),e.postUpdate&&this._postUpdateList.append(e)):(this._scripts.splice(t,0,e),e.__executionOrder=t,this._resetExecutionOrder(t+1,i+1),e.update&&this._updateList.insert(e),e.postUpdate&&this._postUpdateList.insert(e))},_removeScriptInstance:function(e){var t=this._scripts.indexOf(e);return-1===t||(this._scripts.splice(t,1),e.update&&this._updateList.remove(e),e.postUpdate&&this._postUpdateList.remove(e)),t},_resetExecutionOrder:function(e,t){for(var i=e;i<t;i++)this._scripts[i].__executionOrder=i},has:function(e){return"string"==typeof e&&(e=this.system.app.scripts.get(e)),!!this._scriptsIndex[e.__name]},create:function(e,t){var i=this;t=t||{};var s=e,n=e;if("string"==typeof s?s=this.system.app.scripts.get(s):s&&(n=s.__name),s){if(!this._scriptsIndex[s.__name]||!this._scriptsIndex[s.__name].instance){n=new s({app:this.system.app,entity:this.entity,enabled:!t.hasOwnProperty("enabled")||t.enabled,attributes:t.attributes});var a=this._scripts.length,r=-1;return"number"==typeof t.ind&&-1!==t.ind&&a>t.ind&&(r=t.ind),this._insertScriptInstance(n,r,a),this._scriptsIndex[s.__name]={instance:n,onSwap:function(){i.swap(s.__name)}},this[s.__name]=n,t.preloading||n.__initializeAttributes(),this.fire("create",s.__name,n),this.fire("create:"+s.__name,n),this.system.app.scripts.on("swap:"+s.__name,this._scriptsIndex[s.__name].onSwap),t.preloading||(n.enabled&&!n._initialized&&(n._initialized=!0,n.initialize&&this._scriptMethod(n,gi.scriptMethods.initialize)),n.enabled&&!n._postInitialized&&(n._postInitialized=!0,n.postInitialize&&this._scriptMethod(n,gi.scriptMethods.postInitialize))),n}}else this._scriptsIndex[n]={awaiting:!0,ind:this._scripts.length};return null},destroy:function(e){var t=e;if("string"==typeof e&&(e=this.system.app.scripts.get(e))&&(t=e.__name),e=this._scriptsIndex[t],delete this._scriptsIndex[t],!e)return!1;if(e.instance&&!e.instance._destroyed)if(e.instance.enabled=!1,e.instance._destroyed=!0,this._isLoopingThroughScripts)this._destroyedScripts.push(e.instance);else{var i=this._removeScriptInstance(e.instance);0<=i&&this._resetExecutionOrder(i,this._scripts.length)}return this.system.app.scripts.off("swap:"+t,e.onSwap),delete this[t],this.fire("destroy",t,e.instance||null),this.fire("destroy:"+t,e.instance||null),e.instance&&e.instance.fire("destroy"),!0},swap:function(e){if("string"==typeof e&&(e=this.system.app.scripts.get(e)),!(t=this._scriptsIndex[e.__name])||!t.instance)return!1;var t=t.instance,i=this._scripts.indexOf(t),s=new e({app:this.system.app,entity:this.entity,enabled:t.enabled,attributes:t.__attributes});return!!s.swap&&(s.__initializeAttributes(),this._scripts[i]=s,this._scriptsIndex[e.__name].instance=s,(this[e.__name]=s).__executionOrder=i,t.update&&this._updateList.remove(t),t.postUpdate&&this._postUpdateList.remove(t),s.update&&this._updateList.insert(s),s.postUpdate&&this._postUpdateList.insert(s),this._scriptMethod(s,gi.scriptMethods.swap,t),this.fire("swap",e.__name,s),this.fire("swap:"+e.__name,s),!0)},resolveDuplicatedEntityReferenceProperties:function(e,t){var i,s=this.entity.script;for(i in e._scriptsIndex){var n=this.system.app.scripts.get(i);if(n&&(h=e._scriptsIndex[i])&&h.instance){var a=s[i].__attributesRaw,r=s[i].__attributes;if(a||r){var o,h=h.instance.__attributes;for(o in h)if(h[o]){var l=n.attributes.get(o);if(l&&"entity"===l.type)if(l.array){if(l=(c=h[o]).length){for(var c=c.slice(),d=0;d<l;d++){var u=c[d]instanceof te.Entity?c[d].getGuid():c[d];t[u]&&(c[d]=a?t[u].getGuid():t[u])}a?a[o]=c:r[o]=c}}else{if((l=h[o])instanceof te.Entity)l=l.getGuid();else if("string"!=typeof l)continue;t[l]&&(a?a[o]=t[l].getGuid():r[o]=t[l])}}}}}},move:function(e,t){var i=this._scripts.length;if(i<=t||t<0)return!1;var s=e;"string"!=typeof s&&(s=e.__name);var n=this._scriptsIndex[s];if(!n||!n.instance)return!1;var a=this._scripts.indexOf(n.instance);return-1!==a&&a!==t&&(this._scripts.splice(t,0,this._scripts.splice(a,1)[0]),this._resetExecutionOrder(0,i),this._updateList.sort(),this._postUpdateList.sort(),this.fire("move",s,n.instance,t,a),this.fire("move:"+s,n.instance,t,a),!0)}}),Object.defineProperty(gi.prototype,"enabled",{get:function(){return this._enabled},set:function(e){var t=this._enabled;this._enabled=e,this.fire("set","enabled",t,e)}}),Object.defineProperty(gi.prototype,"scripts",{get:function(){return this._scripts},set:function(e){for(var t in this._scriptsData=e)if(e.hasOwnProperty(t)){var i=this._scriptsIndex[t];if(i&&("boolean"==typeof e[t].enabled&&(i.enabled=!!e[t].enabled),"object"==typeof e[t].attributes))for(var s in e[t].attributes)if(!te.createScript.reservedAttributes[s]){if(!i.__attributes.hasOwnProperty(s)){var n=this.system.app.scripts.get(t);n&&n.attributes.add(s,{})}i[s]=e[t].attributes[s]}}}}),{ScriptComponent:gi})),Object.assign(te,(yi=0,((vi=function(e){te.ComponentSystem.call(this,e),this.id="script",this.app=e,this.ComponentType=te.ScriptComponent,this.DataType=te.ScriptComponentData,this._components=new te.SortedLoopArray({sortBy:"_executionOrder"}),this._enabledComponents=new te.SortedLoopArray({sortBy:"_executionOrder"}),this.preloading=!0,this.on("beforeremove",this._onBeforeRemove,this),te.ComponentSystem.bind("initialize",this._onInitialize,this),te.ComponentSystem.bind("postInitialize",this._onPostInitialize,this),te.ComponentSystem.bind("update",this._onUpdate,this),te.ComponentSystem.bind("postUpdate",this._onPostUpdate,this)}).prototype=Object.create(te.ComponentSystem.prototype)).constructor=vi,Object.assign(vi.prototype,{initializeComponentData:function(e,t){if(e._executionOrder=yi++,this._components.append(e),yi>Number.MAX_SAFE_INTEGER&&this._resetExecutionOrder(),e.enabled=!t.hasOwnProperty("enabled")||!!t.enabled,e.enabled&&e.entity.enabled&&this._enabledComponents.append(e),t.hasOwnProperty("order")&&t.hasOwnProperty("scripts")){e._scriptsData=t.scripts;for(var i=0;i<t.order.length;i++)e.create(t.order[i],{enabled:t.scripts[t.order[i]].enabled,attributes:t.scripts[t.order[i]].attributes,preloading:this.preloading})}},cloneComponent:function(e,t){var i,s,n=[],a={};for(i=0;i<e.script._scripts.length;i++){var r=e.script._scripts[i],o=r.__scriptType.__name;n.push(o);var h={};for(s in r.__attributes)h[s]=r.__attributes[s];a[o]={enabled:r._enabled,attributes:h}}for(s in e.script._scriptsIndex)s.awaiting&&n.splice(s.ind,0,s);return this.addComponent(t,{enabled:e.script.enabled,order:n,scripts:a})},_resetExecutionOrder:function(){for(var e=yi=0,t=this._components.length;e<t;e++)this._components.items[e]._executionOrder=yi++},_callComponentMethod:function(e,t,i){for(e.loopIndex=0;e.loopIndex<e.length;e.loopIndex++)e.items[e.loopIndex][t](i)},_onInitialize:function(){this.preloading=!1,this._callComponentMethod(this._components,"_onInitializeAttributes"),this._callComponentMethod(this._enabledComponents,"_onInitialize")},_onPostInitialize:function(){this._callComponentMethod(this._enabledComponents,"_onPostInitialize")},_onUpdate:function(e){this._callComponentMethod(this._enabledComponents,"_onUpdate",e)},_onPostUpdate:function(e){this._callComponentMethod(this._enabledComponents,"_onPostUpdate",e)},_addComponentToEnabled:function(e){this._enabledComponents.insert(e)},_removeComponentFromEnabled:function(e){this._enabledComponents.remove(e)},_onBeforeRemove:function(e,t){0<=this._components.items.indexOf(t)&&t._onBeforeRemove(),this._removeComponentFromEnabled(t),this._components.remove(t)}}),{ScriptComponentSystem:vi})),Object.assign(te,{ScriptComponentData:function(){this.enabled=!0}}),Object.assign(te,(((bi=function(e,t){te.Component.call(this,e,t),this.on("set_scripts",this.onSetScripts,this)}).prototype=Object.create(te.Component.prototype)).constructor=bi,Object.assign(bi.prototype,{send:function(e,t){var i,s=te.makeArray(arguments).slice(2),n=this.entity.script.instances;if(n&&n[e]&&(i=n[e].instance[t]))return i.apply(n[e].instance,s)},onEnable:function(){this.data.areScriptsLoaded&&!this.system.preloading&&(this.data.initialized?this.system._enableScriptComponent(this):this.system._initializeScriptComponent(this),this.data.postInitialized||this.system._postInitializeScriptComponent(this))},onDisable:function(){this.system._disableScriptComponent(this)},onSetScripts:function(e,t,i){this.system._inTools&&!this.runInTools||this._updateScriptAttributes(t,i)||(this.enabled&&this.system._disableScriptComponent(this),this.system._destroyScriptComponent(this),this.data.areScriptsLoaded=!1,e=i.map(function(e){return e.url}),this._loadFromCache(e)||this._loadScripts(e))},_updateScriptAttributes:function(e,t){var i=!0;if(e.length!==t.length)i=!1;else{var s,n=t.length;for(s=0;s<n;s++)if(e[s].url!==t[s].url){i=!1;break}}if(i)for(var a in this.instances)this.instances.hasOwnProperty(a)&&this.system._updateAccessors(this.entity,this.instances[a]);return i},_loadFromCache:function(e){var t,i,s=[],n=this.system.app._scriptPrefix||"",a=/^http(s)?:\/\//i;for(t=0,i=e.length;t<i;t++){var r=e[t];if(a.test(r)||(r=te.path.join(n,r)),!(r=this.system.app.loader.getFromCache(r,"script")))return!1;s.push(r)}for(t=0,i=s.length;t<i;t++)!0!==(n=s[t])&&n&&this.entity.script&&!this.entity.script.instances[n._pcScriptName]&&(a=new n(this.entity),this.system._preRegisterInstance(this.entity,e[t],n._pcScriptName,a));return this.data&&(this.data.areScriptsLoaded=!0),this.system.preloading||(this.system.onInitialize(this.entity),this.system.onPostInitialize(this.entity)),!0},_loadScripts:function(e){var n=e.length,i=this.system.app._scriptPrefix||"";e.forEach(function(e){var t=null,s=null;t=e.toLowerCase().startsWith("http://")||e.toLowerCase().startsWith("https://")?s=e:(s=e,te.path.join(i,e)),this.system.app.loader.load(t,"script",function(e,t){if(n--,e);else if(t&&this.entity.script&&!this.entity.script.instances[t._pcScriptName]){var i=new t(this.entity);this.system._preRegisterInstance(this.entity,s,t._pcScriptName,i)}0===n&&(this.data.areScriptsLoaded=!0,this.system.preloading||(this.system.onInitialize(this.entity),this.system.onPostInitialize(this.entity)))}.bind(this))}.bind(this))}}),{ScriptLegacyComponent:bi})),Object.assign(te,(Si=["enabled","scripts","instances","runInTools"],((Ti=function(e){te.ComponentSystem.call(this,e),this.id="script",this.description="Allows the Entity to run JavaScript fragments to implement custom behavior.",this.ComponentType=te.ScriptLegacyComponent,this.DataType=te.ScriptLegacyComponentData,this.schema=Si,this.preloading=!1,this.instancesWithUpdate=[],this.instancesWithFixedUpdate=[],this.instancesWithPostUpdate=[],this.instancesWithToolsUpdate=[],this.on("beforeremove",this.onBeforeRemove,this),te.ComponentSystem.bind("initialize",this.onInitialize,this),te.ComponentSystem.bind("postInitialize",this.onPostInitialize,this),te.ComponentSystem.bind("update",this.onUpdate,this),te.ComponentSystem.bind("fixedUpdate",this.onFixedUpdate,this),te.ComponentSystem.bind("postUpdate",this.onPostUpdate,this),te.ComponentSystem.bind("toolsUpdate",this.onToolsUpdate,this)}).prototype=Object.create(te.ComponentSystem.prototype)).constructor=Ti,te.Component._buildAccessors(te.ScriptLegacyComponent.prototype,Si),Object.assign(Ti.prototype,{initializeComponentData:function(e,t,i){i=["runInTools","enabled","scripts"],t.scripts&&t.scripts.length&&t.scripts.forEach(function(e){if(e.attributes&&"array"===te.type(e.attributes)){for(var t={},i=0;i<e.attributes.length;i++)t[e.attributes[i].name]=e.attributes[i];e.attributes=t}}),te.ComponentSystem.prototype.initializeComponentData.call(this,e,t,i)},cloneComponent:function(e,t){for(var i,s={runInTools:(i=this.store[e.getGuid()]).data.runInTools,scripts:[],enabled:i.data.enabled},n=0,a=(i=i.data.scripts).length;n<a;n++){var r=i[n].attributes;r&&delete i[n].attributes,s.scripts.push(te.extend({},i[n])),r&&(s.scripts[n].attributes=this._cloneAttributes(r),i[n].attributes=r)}return this.addComponent(t,s)},onBeforeRemove:function(e,t){t.enabled&&this._disableScriptComponent(t),this._destroyScriptComponent(t)},onInitialize:function(e){if(this._registerInstances(e),e.enabled){e.script&&e.script.enabled&&this._initializeScriptComponent(e.script);var t,i=(e=e._children).length;for(t=0;t<i;t++)e[t]instanceof te.Entity&&this.onInitialize(e[t])}},onPostInitialize:function(e){if(e.enabled){e.script&&e.script.enabled&&this._postInitializeScriptComponent(e.script);var t,i=(e=e._children).length;for(t=0;t<i;t++)e[t]instanceof te.Entity&&this.onPostInitialize(e[t])}},_callInstancesMethod:function(e,t){var i,s=e.data.instances;for(i in s)if(s.hasOwnProperty(i)){var n=s[i].instance;n[t]&&n[t]()}},_initializeScriptComponent:function(e){this._callInstancesMethod(e,"initialize"),e.data.initialized=!0,e.enabled&&e.entity.enabled&&this._enableScriptComponent(e)},_enableScriptComponent:function(e){this._callInstancesMethod(e,"onEnable")},_disableScriptComponent:function(e){this._callInstancesMethod(e,"onDisable")},_destroyScriptComponent:function(e){var t,i,s=e.data.instances;for(i in s)if(s.hasOwnProperty(i)){var n=s[i].instance;n.destroy&&n.destroy(),n.update&&0<=(t=this.instancesWithUpdate.indexOf(n))&&this.instancesWithUpdate.splice(t,1),n.fixedUpdate&&0<=(t=this.instancesWithFixedUpdate.indexOf(n))&&this.instancesWithFixedUpdate.splice(t,1),n.postUpdate&&0<=(t=this.instancesWithPostUpdate.indexOf(n))&&this.instancesWithPostUpdate.splice(t,1),n.toolsUpdate&&0<=(t=this.instancesWithToolsUpdate.indexOf(n))&&this.instancesWithToolsUpdate.splice(t,1),e.instances[i].instance===e[i]&&delete e[i],delete e.instances[i]}},_postInitializeScriptComponent:function(e){this._callInstancesMethod(e,"postInitialize"),e.data.postInitialized=!0},_updateInstances:function(e,t,i){for(var s,n=0,a=t.length;n<a;n++)(s=t[n])&&s.entity&&s.entity.enabled&&s.entity.script.enabled&&s[e](i)},onUpdate:function(e){this._updateInstances("update",this.instancesWithUpdate,e)},onFixedUpdate:function(e){this._updateInstances("fixedUpdate",this.instancesWithFixedUpdate,e)},onPostUpdate:function(e){this._updateInstances("postUpdate",this.instancesWithPostUpdate,e)},onToolsUpdate:function(e){this._updateInstances("toolsUpdate",this.instancesWithToolsUpdate,e)},broadcast:function(e,t){var i,s,n,a=te.makeArray(arguments).slice(2),r=this.store;for(i in r)r.hasOwnProperty(i)&&(s=r[i].data).instances[e]&&(n=s.instances[e].instance[t])&&n.apply(s.instances[e].instance,a)},_preRegisterInstance:function(e,t,i,s){if(e.script){if(e.script.data._instances=e.script.data._instances||{},e.script.data._instances[i])throw Error(te.string.format("Script name collision '{0}'. Scripts from '{1}' and '{2}' {{3}}",i,t,e.script.data._instances[i].url,e.getGuid()));e.script.data._instances[i]={url:t,name:i,instance:s}}},_registerInstances:function(e){var t,i,s;if(e.script&&e.script.data._instances){for(s in e.script.instances=e.script.data._instances,e.script.instances){if(i=(t=e.script.instances[s]).instance,te.events.attach(i),i.update&&this.instancesWithUpdate.push(i),i.fixedUpdate&&this.instancesWithFixedUpdate.push(i),i.postUpdate&&this.instancesWithPostUpdate.push(i),i.toolsUpdate&&this.instancesWithToolsUpdate.push(i),e.script.scripts&&this._createAccessors(e,t),e.script[s])throw Error(te.string.format("Script with name '{0}' is already attached to Script Component",s));e.script[s]=i}delete e.script.data._instances}for(i=(e=e._children).length,t=0;t<i;t++)e[t]instanceof te.Entity&&this._registerInstances(e[t])},_cloneAttributes:function(e){var t,i={};for(t in e)if(e.hasOwnProperty(t))if("entity"!==e[t].type)i[t]=te.extend({},e[t]);else{var s=e[t].value;delete e[t].value,i[t]=te.extend({},e[t]),i[t].value=s,e[t].value=s}return i},_createAccessors:function(e,t){var i,s=e.script.scripts.length,n=t.url;for(i=0;i<s;i++){var a=e.script.scripts[i];if(a.url===n){if(i=a.attributes,a.name&&i){for(var r in i)i.hasOwnProperty(r)&&this._createAccessor(i[r],t);e.script.data.attributes[a.name]=this._cloneAttributes(i)}break}}},_createAccessor:function(i,s){var n=this;i={name:i.name,value:i.value,type:i.type},n._convertAttributeValue(i),Object.defineProperty(s.instance,i.name,{get:function(){return i.value},set:function(e){var t=i.value;i.value=e,n._convertAttributeValue(i),s.instance.fire("set",i.name,t,i.value)},configurable:!0})},_updateAccessors:function(e,t){var i,s,n,a,r=e.script.scripts.length,o=t.url;for(i=0;i<r;i++)if((a=(n=e.script).scripts[i]).url===o){if(i=a.name,a=a.attributes,i){if(a)for(s in a)a.hasOwnProperty(s)&&this._createAccessor(a[s],t);if(r=n.data.attributes[i])for(s in r)o=r[s],s in a?a[s].value!==o.value&&t.instance.onAttributeChanged&&t.instance.onAttributeChanged(o.name,o.value,a[s].value):delete t.instance[o.name];a?n.data.attributes[i]=this._cloneAttributes(a):delete n.data.attributes[i]}break}},_convertAttributeValue:function(e){"rgb"===e.type||"rgba"===e.type?"array"===te.type(e.value)&&(e.value=3===e.value.length?new te.Color(e.value[0],e.value[1],e.value[2]):new te.Color(e.value[0],e.value[1],e.value[2],e.value[3])):"vec2"===e.type?"array"===te.type(e.value)&&(e.value=new te.Vec2(e.value[0],e.value[1])):"vec3"===e.type||"vector"===e.type?"array"===te.type(e.value)&&(e.value=new te.Vec3(e.value[0],e.value[1],e.value[2])):"vec4"===e.type?"array"===te.type(e.value)&&(e.value=new te.Vec4(e.value[0],e.value[1],e.value[2],e.value[3])):"entity"===e.type?null!==e.value&&"string"==typeof e.value&&(e.value=this.app.root.findByGuid(e.value)):"curve"!==e.type&&"colorcurve"!==e.type||(e.value=new(e.value.keys[0]instanceof Array?te.CurveSet:te.Curve)(e.value.keys),e.value.type=e.value.type)}}),{ScriptLegacyComponentSystem:Ti})),Object.assign(te,{ScriptLegacyComponentData:function(){this.scripts=[],this.enabled=!0,this.instances={},this._instances={},this.runInTools=!1,this.attributes={},this.areScriptsLoaded=this.postInitialized=this.initialized=!1}}),Object.assign(te,{DISTANCE_LINEAR:"linear",DISTANCE_INVERSE:"inverse",DISTANCE_EXPONENTIAL:"exponential"}),Object.assign(te,(Ei={volume:0,pitch:0,loop:!1,startTime:0,duration:0,position:new te.Vec3,maxDistance:0,refDistance:0,rollOffFactor:0,distanceModel:0,onPlay:null,onPause:null,onResume:null,onStop:null,onEnd:null},xi=function(e,t,i){i=i||{},this._component=e,this._assets=e.system.app.assets,this._manager=e.system.manager,this._name=t||"Untitled",this._volume=void 0!==i.volume?te.math.clamp(Number(i.volume)||0,0,1):1,this._pitch=void 0!==i.pitch?Math.max(.01,Number(i.pitch)||0):1,this._loop=!(void 0===i.loop||!i.loop),this._duration=0<i.duration?i.duration:null,this._startTime=Math.max(0,Number(i.startTime)||0),this._overlap=!!i.overlap,this._autoPlay=!!i.autoPlay,this._lastNode=this._firstNode=null,this._asset=i.asset,this._asset instanceof te.Asset&&(this._asset=this._asset.id),this._onInstancePlayHandler=this._onInstancePlay.bind(this),this._onInstancePauseHandler=this._onInstancePause.bind(this),this._onInstanceResumeHandler=this._onInstanceResume.bind(this),this._onInstanceStopHandler=this._onInstanceStop.bind(this),this._onInstanceEndHandler=this._onInstanceEnd.bind(this),this.instances=[],te.events.attach(this)},Object.assign(xi.prototype,{play:function(){this.overlap||!this.isPlaying&&!this.isPaused||this.stop();var i=this._createInstance();if(this.instances.push(i),this.isLoaded)i.play();else{var e=function(e){var t=i._playWhenLoaded;i.sound=e,t&&i.play()};this.off("load",e),this.once("load",e),this.load()}return i},pause:function(){for(var e=!1,t=this.instances,i=0,s=t.length;i<s;i++)t[i].pause()&&(e=!0);return e},resume:function(){for(var e=!1,t=this.instances,i=0,s=t.length;i<s;i++)t[i].resume()&&(e=!0);return e},stop:function(){for(var e=!1,t=this.instances,i=0,s=t.length;i<s;i++)t[i].stop()&&(e=!0);return t.length=0,e},load:function(){if(this._hasAsset()){var e=this._assets.get(this._asset);e?(e.off("remove",this._onAssetRemoved,this),e.on("remove",this._onAssetRemoved,this),e.resource?this.fire("load",e.resource):(e.off("load",this._onAssetLoad,this),e.once("load",this._onAssetLoad,this),this._assets.load(e))):(this._assets.off("add:"+this._asset,this._onAssetAdd,this),this._assets.once("add:"+this._asset,this._onAssetAdd,this))}},setExternalNodes:function(e,t){if(e&&(t||(t=e),this._firstNode=e,this._lastNode=t,!this._overlap))for(var i=this.instances,s=0,n=i.length;s<n;s++)i[s].setExternalNodes(e,t)},clearExternalNodes:function(){if(this._lastNode=this._firstNode=null,!this._overlap)for(var e=this.instances,t=0,i=e.length;t<i;t++)e[t].clearExternalNodes()},getExternalNodes:function(){return[this._firstNode,this._lastNode]},_hasAsset:function(){return null!=this._asset},_createInstance:function(){var e;e=this._component;var t=null;if(this._hasAsset()){var i=this._assets.get(this._asset);i&&(t=i.resource)}return Ei.volume=this._volume*e.volume,Ei.pitch=this._pitch*e.pitch,Ei.loop=this._loop,Ei.startTime=this._startTime,Ei.duration=this._duration,Ei.onPlay=this._onInstancePlayHandler,Ei.onPause=this._onInstancePauseHandler,Ei.onResume=this._onInstanceResumeHandler,Ei.onStop=this._onInstanceStopHandler,Ei.onEnd=this._onInstanceEndHandler,e=e.positional?(Ei.position.copy(e.entity.getPosition()),Ei.maxDistance=e.maxDistance,Ei.refDistance=e.refDistance,Ei.rollOffFactor=e.rollOffFactor,Ei.distanceModel=e.distanceModel,new te.SoundInstance3d(this._manager,t,Ei)):new te.SoundInstance(this._manager,t,Ei),this._firstNode&&e.setExternalNodes(this._firstNode,this._lastNode),e},_onInstancePlay:function(e){this.fire("play",e),this._component.fire("play",this,e)},_onInstancePause:function(e){this.fire("pause",e),this._component.fire("pause",this,e)},_onInstanceResume:function(e){this.fire("resume",e),this._component.fire("resume",this,e)},_onInstanceStop:function(e){this.fire("stop",e),this._component.fire("stop",this,e)},_onInstanceEnd:function(e){var t=this.instances.indexOf(e);-1!==t&&this.instances.splice(t,1),this.fire("end",e),this._component.fire("end",this,e)},_onAssetAdd:function(e){this.load()},_onAssetLoad:function(e){this.load()},_onAssetRemoved:function(e){e.off("remove",this._onAssetRemoved,this),this._assets.off("add:"+e.id,this._onAssetAdd,this),this.stop()},updatePosition:function(e){for(var t=this.instances,i=0,s=t.length;i<s;i++)t[i].position=e}}),Object.defineProperty(xi.prototype,"name",{get:function(){return this._name},set:function(e){this._name=e}}),Object.defineProperty(xi.prototype,"volume",{get:function(){return this._volume},set:function(e){if(this._volume=te.math.clamp(Number(e)||0,0,1),!this._overlap)for(var t=0,i=(e=this.instances).length;t<i;t++)e[t].volume=this._volume*this._component.volume}}),Object.defineProperty(xi.prototype,"pitch",{get:function(){return this._pitch},set:function(e){if(this._pitch=Math.max(Number(e)||0,.01),!this._overlap)for(var t=0,i=(e=this.instances).length;t<i;t++)e[t].pitch=this.pitch*this._component.pitch}}),Object.defineProperty(xi.prototype,"loop",{get:function(){return this._loop},set:function(e){this._loop=!!e;for(var t=0,i=(e=this.instances).length;t<i;t++)e[t].loop=this._loop}}),Object.defineProperty(xi.prototype,"autoPlay",{get:function(){return this._autoPlay},set:function(e){this._autoPlay=!!e}}),Object.defineProperty(xi.prototype,"overlap",{get:function(){return this._overlap},set:function(e){this._overlap=!!e}}),Object.defineProperty(xi.prototype,"startTime",{get:function(){return this._startTime},set:function(e){if(this._startTime=Math.max(0,Number(e)||0),!this._overlap)for(var t=0,i=(e=this.instances).length;t<i;t++)e[t].startTime=this._startTime}}),Object.defineProperty(xi.prototype,"duration",{get:function(){var e=0;return this._hasAsset()&&(e=(e=this._assets.get(this._asset)).resource?e.resource.duration:0),null!=this._duration?this._duration%(e||1):e},set:function(e){if(this._duration=Math.max(0,Number(e)||0)||null,!this._overlap)for(var t=0,i=(e=this.instances).length;t<i;t++)e[t].duration=this._duration}}),Object.defineProperty(xi.prototype,"asset",{get:function(){return this._asset},set:function(e){var t=this._asset;t&&(this._assets.off("add:"+t,this._onAssetAdd,this),(t=this._assets.get(t))&&t.off("remove",this._onAssetRemoved,this)),this._asset=e,this._asset instanceof te.Asset&&(this._asset=this._asset.id),this._hasAsset()&&this._component.enabled&&this._component.entity.enabled&&this.load()}}),Object.defineProperty(xi.prototype,"isLoaded",{get:function(){if(this._hasAsset()){var e=this._assets.get(this._asset);if(e)return!!e.resource}return!1}}),Object.defineProperty(xi.prototype,"isPlaying",{get:function(){for(var e=this.instances,t=0,i=e.length;t<i;t++)if(e[t].isPlaying)return!0;return!1}}),Object.defineProperty(xi.prototype,"isPaused",{get:function(){var e=this.instances,t=e.length;if(0===t)return!1;for(var i=0;i<t;i++)if(!e[i].isPaused)return!1;return!0}}),Object.defineProperty(xi.prototype,"isStopped",{get:function(){for(var e=this.instances,t=0,i=e.length;t<i;t++)if(!e[t].isStopped)return!1;return!0}}),{SoundSlot:xi})),Object.assign(te,(((Ai=function(e,t){te.Component.call(this,e,t),this.on("set_slots",this.onSetSlots,this),this.on("set_volume",this.onSetVolume,this),this.on("set_pitch",this.onSetPitch,this),this.on("set_refDistance",this.onSetRefDistance,this),this.on("set_maxDistance",this.onSetMaxDistance,this),this.on("set_rollOffFactor",this.onSetRollOffFactor,this),this.on("set_distanceModel",this.onSetDistanceModel,this),this.on("set_positional",this.onSetPositional,this)}).prototype=Object.create(te.Component.prototype)).constructor=Ai,Object.assign(Ai.prototype,{onSetSlots:function(e,t,i){var s;if(t)for(s in t)t[s].stop();for(s in e={},i)i[s]instanceof te.SoundSlot?e[i[s].name]=i[s]:i[s].name&&(e[i[s].name]=new te.SoundSlot(this,i[s].name,i[s]));this.data.slots=e,this.enabled&&this.entity.enabled&&this.onEnable()},onSetVolume:function(e,t,i){for(var s in e=this.data.slots)if(!(t=e[s]).overlap)for(var n=t.instances,a=0,r=n.length;a<r;a++)n[a].volume=t.volume*i},onSetPitch:function(e,t,i){for(var s in e=this.data.slots)if(!(t=e[s]).overlap)for(var n=t.instances,a=0,r=n.length;a<r;a++)n[a].pitch=t.pitch*i},onSetRefDistance:function(e,t,i){for(var s in e=this.data.slots)if(!(t=e[s]).overlap)for(var n=0,a=(t=t.instances).length;n<a;n++)t[n].refDistance=i},onSetMaxDistance:function(e,t,i){for(var s in e=this.data.slots)if(!(t=e[s]).overlap)for(var n=0,a=(t=t.instances).length;n<a;n++)t[n].maxDistance=i},onSetRollOffFactor:function(e,t,i){for(var s in e=this.data.slots)if(!(t=e[s]).overlap)for(var n=0,a=(t=t.instances).length;n<a;n++)t[n].rollOffFactor=i},onSetDistanceModel:function(e,t,i){for(var s in e=this.data.slots)if(!(t=e[s]).overlap)for(var n=0,a=(t=t.instances).length;n<a;n++)t[n].distanceModel=i},onSetPositional:function(e,t,i){for(var s in e=this.data.slots)if(!(t=e[s]).overlap)for(var n=0,a=(i=t.instances).length;n<a;n++){var r=i[n].isPlaying||i[n].isSuspended,o=i[n].currentTime;r&&i[n].stop(),i[n]=t._createInstance(),r&&(i[n].play(),i[n].currentTime=o)}},onEnable:function(){if(!this.system._inTools){var e,t=this.data.slots,i=this.data.playingBeforeDisable;for(e in t){var s=t[e];s.autoPlay&&s.isStopped?s.play():i[e]?s.resume():s.isLoaded||s.load()}}},onDisable:function(){var e,t=this.data.slots,i={};for(e in t)!t[e].overlap&&t[e].isPlaying&&(t[e].pause(),i[e]=!0);this.data.playingBeforeDisable=i},onRemove:function(){this.off()},addSlot:function(e,t){var i=this.data.slots;if(i[e])return Ie("A sound slot with name "+e+" already exists on Entity "+this.entity.path),null;var s=new te.SoundSlot(this,e,t);return(i[e]=s).autoPlay&&this.enabled&&this.entity.enabled&&s.play(),s},removeSlot:function(e){var t=this.data.slots;t[e]&&(t[e].stop(),delete t[e])},slot:function(e){return this.data.slots[e]},play:function(e){if(!this.enabled||!this.entity.enabled)return null;var t=this.slots[e];return t?t.play():(Ie("Trying to play sound slot with name "+e+" which does not exist"),null)},pause:function(e){var t;if(t=this.data.slots,e)(t=t[e])?t.pause():Ie("Trying to pause sound slot with name "+e+" which does not exist");else for(var i in t)t[i].pause()},resume:function(e){var t;if(t=this.data.slots,e)(t=t[e])?t.isPaused&&t.resume():Ie("Trying to resume sound slot with name "+e+" which does not exist");else for(var i in t)t[i].resume()},stop:function(e){var t;if(t=this.data.slots,e)(t=t[e])?t.stop():Ie("Trying to stop sound slot with name "+e+" which does not exist");else for(var i in t)t[i].stop()}}),{SoundComponent:Ai})),Object.assign(te,(Mi="enabled volume pitch positional refDistance maxDistance rollOffFactor distanceModel slots".split(" "),((Ci=function(e,t){te.ComponentSystem.call(this,e),this.id="sound",this.description="Allows an Entity to play sounds",this.ComponentType=te.SoundComponent,this.DataType=te.SoundComponentData,this.schema=Mi,this.manager=t,te.ComponentSystem.bind("update",this.onUpdate,this),this.on("beforeremove",this.onBeforeRemove,this)}).prototype=Object.create(te.ComponentSystem.prototype)).constructor=Ci,te.Component._buildAccessors(te.SoundComponent.prototype,Mi),Object.assign(Ci.prototype,{initializeComponentData:function(e,t,i){i="volume pitch positional refDistance maxDistance rollOffFactor distanceModel slots enabled".split(" "),te.ComponentSystem.prototype.initializeComponentData.call(this,e,t,i)},cloneComponent:function(e,t){var i,s=e.sound.data,n={};for(i in s)s.hasOwnProperty(i)&&(n[i]=s[i]);for(i in n.slots={},s.slots){var a=s.slots[i];n.slots[i]=a instanceof te.SoundSlot?{name:a.name,volume:a.volume,pitch:a.pitch,loop:a.loop,duration:a.duration,startTime:a.startTime,overlap:a.overlap,autoPlay:a.autoPlay,asset:a.asset}:a}return n.playingBeforeDisable={},this.addComponent(t,n)},onUpdate:function(e){for(var t in e=this.store)if(e.hasOwnProperty(t)){var i=(n=e[t]).entity;if((n=n.data).enabled&&i.enabled&&n.positional){i=i.getPosition();var s,n=n.slots;for(s in n)n[s].updatePosition(i)}}},onBeforeRemove:function(e,t){var i,s=t.slots;for(i in s)s[i].overlap||s[i].stop();t.onRemove()}}),Object.defineProperty(Ci.prototype,"volume",{get:function(){return this.manager.volume},set:function(e){this.manager.volume=e}}),Object.defineProperty(Ci.prototype,"context",{get:function(){return te.SoundManager.hasAudioContext()?this.manager.context:null}}),{SoundComponentSystem:Ci})),te.SoundComponentData=function(){this.enabled=!0,this.pitch=this.volume=1,this.positional=!0,this.refDistance=1,this.maxDistance=1e4,this.rollOffFactor=1,this.distanceModel=te.DISTANCE_LINEAR,this.slots={},this.playingBeforeDisable={}},Object.assign(te,(((Pi=function(e,t){te.Component.call(this,e,t),this.on("set_assets",this.onSetAssets,this),this.on("set_loop",this.onSetLoop,this),this.on("set_volume",this.onSetVolume,this),this.on("set_pitch",this.onSetPitch,this),this.on("set_minDistance",this.onSetMinDistance,this),this.on("set_maxDistance",this.onSetMaxDistance,this),this.on("set_rollOffFactor",this.onSetRollOffFactor,this),this.on("set_distanceModel",this.onSetDistanceModel,this),this.on("set_3d",this.onSet3d,this)}).prototype=Object.create(te.Component.prototype)).constructor=Pi,Object.assign(Pi.prototype,{play:function(e){if(this.enabled&&this.entity.enabled){this.channel&&this.stop();var t,i=this.data;i.sources[e]&&(t=i["3d"]?(t=this.entity.getPosition(),this.system.manager.playSound3d(i.sources[e],t,i)):this.system.manager.playSound(i.sources[e],i),i.currentSource=e,i.channel=t)}},pause:function(){this.channel&&this.channel.pause()},unpause:function(){this.channel&&this.channel.paused&&this.channel.unpause()},stop:function(){this.channel&&(this.channel.stop(),this.channel=null)},onSetAssets:function(e,t,i){e=[];var s,n=i.length;if(t&&t.length)for(s=0;s<t.length;s++)if(t[s]){var a=this.system.app.assets.get(t[s]);a&&(a.off("change",this.onAssetChanged,this),a.off("remove",this.onAssetRemoved,this),this.currentSource===a.name&&this.stop())}if(n)for(s=0;s<n;s++)t.indexOf(i[s])<0&&(i[s]instanceof te.Asset?e.push(i[s].id):e.push(i[s]));!this.system._inTools&&e.length&&this.loadAudioSourceAssets(e)},onAssetChanged:function(e,t,i,s){"resource"===t&&this.data.sources&&(this.data.sources[e.name]=i,this.data.currentSource===e.name&&this.channel&&(this.channel.paused?(this.play(e.name),this.pause()):this.play(e.name)))},onAssetRemoved:function(e){e.off("remove",this.onAssetRemoved,this),this.data.sources[e.name]&&(delete this.data.sources[e.name],this.data.currentSource===e.name&&(this.stop(),this.data.currentSource=null))},onSetLoop:function(e,t,i){t!=i&&this.channel&&this.channel.setLoop(i)},onSetVolume:function(e,t,i){t!=i&&this.channel&&this.channel.setVolume(i)},onSetPitch:function(e,t,i){t!=i&&this.channel&&this.channel.setPitch(i)},onSetMaxDistance:function(e,t,i){t!=i&&this.channel instanceof te.Channel3d&&this.channel.setMaxDistance(i)},onSetMinDistance:function(e,t,i){t!=i&&this.channel instanceof te.Channel3d&&this.channel.setMinDistance(i)},onSetRollOffFactor:function(e,t,i){t!=i&&this.channel instanceof te.Channel3d&&this.channel.setRollOffFactor(i)},onSetDistanceModel:function(e,t,i){t!==i&&this.channel instanceof te.Channel3d&&this.channel.setDistanceModel(i)},onSet3d:function(e,t,i){t!==i&&this.system.initialized&&this.currentSource&&(t=e=!1,this.channel&&(e=this.channel.paused,t=this.channel.suspended),this.play(this.currentSource),this.channel&&(this.channel.paused=e,this.channel.suspended=t))},onEnable:function(){var e=this.data.assets;if(e)for(var t=this.system.app.assets,i=0,s=e.length;i<s;i++){var n=e[i];n instanceof te.Asset||(n=t.get(n)),n&&!n.resource&&t.load(n)}this.system.initialized&&(this.data.activate&&!this.channel?this.play(this.currentSource):this.unpause())},onDisable:function(){this.pause()},loadAudioSourceAssets:function(i){var s=this,e=i.map(function(e){return this.system.app.assets.get(e)},this),n={},a=null,r=e.length,o=function(e){r--},h=function(){this.data.sources=n,this.data.currentSource=a,this.enabled&&this.activate&&a&&this.onEnable()}.bind(this);e.forEach(function(e,t){e?(a=a||e.name,e.off("change",this.onAssetChanged,this),e.on("change",this.onAssetChanged,this),e.off("remove",this.onAssetRemoved,this),e.on("remove",this.onAssetRemoved,this),e.off("error",o,this),e.on("error",o,this),e.ready(function(e){n[e.name]=e.resource,0==--r&&h()}),!e.resource&&s.enabled&&s.entity.enabled&&this.system.app.assets.load(e)):(0==--r&&h(),this.system.app.assets.on("add:"+i[t],function(e){e.ready(function(e){s.data.sources[e.name]=e.resource}),e.resource||s.system.app.assets.load(e)}))},this)}}),{AudioSourceComponent:Pi})),Object.assign(te,(Ii="enabled assets volume pitch loop activate 3d minDistance maxDistance rollOffFactor distanceModel sources currentSource channel".split(" "),((wi=function(e,t){te.ComponentSystem.call(this,e),this.id="audiosource",this.description="Specifies audio assets that can be played at the position of the Entity.",this.ComponentType=te.AudioSourceComponent,this.DataType=te.AudioSourceComponentData,this.schema=Ii,this.manager=t,this.initialized=!1,te.ComponentSystem.bind("initialize",this.onInitialize,this),te.ComponentSystem.bind("update",this.onUpdate,this),this.on("remove",this.onRemove,this)}).prototype=Object.create(te.ComponentSystem.prototype)).constructor=wi,te.Component._buildAccessors(te.AudioSourceComponent.prototype,Ii),Object.assign(wi.prototype,{initializeComponentData:function(e,t,i){i="activate volume pitch loop 3d minDistance maxDistance rollOffFactor distanceModel enabled assets".split(" "),te.ComponentSystem.prototype.initializeComponentData.call(this,e,t,i),e.paused=!(e.enabled&&e.activate)},onInitialize:function(e){e.audiosource&&e.enabled&&e.audiosource.enabled&&e.audiosource.activate&&e.audiosource.play(e.audiosource.currentSource);var t,i=(e=e._children).length;for(t=0;t<i;t++)e[t]instanceof te.Entity&&this.onInitialize(e[t]);this.initialized=!0},onUpdate:function(e){for(var t in e=this.store)if(e.hasOwnProperty(t)){var i,s=(i=e[t]).entity;(i=i.data).enabled&&s.enabled&&i.channel instanceof te.Channel3d&&(s=s.getPosition(),i.channel.setPosition(s))}},onRemove:function(e,t){t.channel&&(t.channel.stop(),t.channel=null)},setVolume:function(e){this.manager.setVolume(e)}}),{AudioSourceComponentSystem:wi})),te.AudioSourceComponentData=function(){this.enabled=!0,this.assets=[],this.activate=!0,this.pitch=this.volume=1,this.loop=!1,this["3d"]=!0,this.minDistance=1,this.maxDistance=1e4,this.rollOffFactor=1,this.distanceModel=te.DISTANCE_INVERSE,this.paused=!0,this.sources={},this.channel=this.currentSource=null},Object.assign(te,(((Oi=function(e,t){te.Component.call(this,e,t)}).prototype=Object.create(te.Component.prototype)).constructor=Oi,Object.assign(Oi.prototype,{setCurrentListener:function(){if(this.enabled&&this.entity.audiolistener&&this.entity.enabled){this.system.current=this.entity;var e=this.system.current.getPosition();this.system.manager.listener.setPosition(e)}},onEnable:function(){this.setCurrentListener()},onDisable:function(){this.system.current===this.entity&&(this.system.current=null)}}),{AudioListenerComponent:Oi})),Object.assign(te,(Ri=["enabled"],((Li=function(e,t){te.ComponentSystem.call(this,e),this.id="audiolistener",this.description="Specifies the location of the listener for 3D audio playback.",this.ComponentType=te.AudioListenerComponent,this.DataType=te.AudioListenerComponentData,this.schema=Ri,this.manager=t,this.current=null,te.ComponentSystem.bind("update",this.onUpdate,this)}).prototype=Object.create(te.ComponentSystem.prototype)).constructor=Li,te.Component._buildAccessors(te.AudioListenerComponent.prototype,Ri),Object.assign(Li.prototype,{initializeComponentData:function(e,t,i){i=["enabled"],te.ComponentSystem.prototype.initializeComponentData.call(this,e,t,i)},onUpdate:function(e){this.current&&(e=this.current.getPosition(),this.manager.listener.setPosition(e),e=this.current.getWorldTransform(),this.manager.listener.setOrientation(e))}}),{AudioListenerComponentSystem:Li})),Object.assign(te,{AudioListenerComponentData:function(){this.enabled=!0}}),Object.assign(te,{BODYTYPE_STATIC:"static",BODYTYPE_DYNAMIC:"dynamic",BODYTYPE_KINEMATIC:"kinematic",BODYFLAG_STATIC_OBJECT:1,BODYFLAG_KINEMATIC_OBJECT:2,BODYFLAG_NORESPONSE_OBJECT:4,BODYSTATE_ACTIVE_TAG:1,BODYSTATE_ISLAND_SLEEPING:2,BODYSTATE_WANTS_DEACTIVATION:3,BODYSTATE_DISABLE_DEACTIVATION:4,BODYSTATE_DISABLE_SIMULATION:5,BODYGROUP_NONE:0,BODYGROUP_DEFAULT:1,BODYGROUP_DYNAMIC:1,BODYGROUP_STATIC:2,BODYGROUP_KINEMATIC:4,BODYGROUP_ENGINE_1:8,BODYGROUP_TRIGGER:16,BODYGROUP_ENGINE_2:32,BODYGROUP_ENGINE_3:64,BODYGROUP_USER_1:128,BODYGROUP_USER_2:256,BODYGROUP_USER_3:512,BODYGROUP_USER_4:1024,BODYGROUP_USER_5:2048,BODYGROUP_USER_6:4096,BODYGROUP_USER_7:8192,BODYGROUP_USER_8:16384,BODYMASK_NONE:0,BODYMASK_ALL:65535,BODYMASK_STATIC:2,BODYMASK_NOT_STATIC:65533,BODYMASK_NOT_STATIC_KINEMATIC:65529}),Object.assign(te,(((Vi=function(e,t){te.Component.call(this,e,t),"undefined"==typeof Ammo||Di||(Di=new Ammo.btTransform,Ni=new Ammo.btVector3,Fi=new Ammo.btVector3,Bi=new Ammo.btQuaternion,ki=new Ammo.btVector3(0,0,0)),this.on("set_mass",this.onSetMass,this),this.on("set_linearDamping",this.onSetLinearDamping,this),this.on("set_angularDamping",this.onSetAngularDamping,this),this.on("set_linearFactor",this.onSetLinearFactor,this),this.on("set_angularFactor",this.onSetAngularFactor,this),this.on("set_friction",this.onSetFriction,this),this.on("set_restitution",this.onSetRestitution,this),this.on("set_type",this.onSetType,this),this.on("set_group",this.onSetGroupOrMask,this),this.on("set_mask",this.onSetGroupOrMask,this),this.on("set_body",this.onSetBody,this),this._displacement=new te.Vec3(0,0,0),this._linearVelocity=new te.Vec3(0,0,0),this._angularVelocity=new te.Vec3(0,0,0)}).prototype=Object.create(te.Component.prototype)).constructor=Vi,Object.defineProperty(Vi.prototype,"bodyType",{get:function(){return this.type},set:function(e){this.type=e}}),Object.defineProperty(Vi.prototype,"linearVelocity",{get:function(){if(!this.isKinematic()&&this.body){var e=this.body.getLinearVelocity();this._linearVelocity.set(e.x(),e.y(),e.z())}return this._linearVelocity},set:function(e){this.activate(),!this.isKinematic()&&this.body&&(Ni.setValue(e.x,e.y,e.z),this.body.setLinearVelocity(Ni)),this._linearVelocity.copy(e)}}),Object.defineProperty(Vi.prototype,"angularVelocity",{get:function(){if(!this.isKinematic()&&this.body){var e=this.body.getAngularVelocity();this._angularVelocity.set(e.x(),e.y(),e.z())}return this._angularVelocity},set:function(e){this.activate(),!this.isKinematic()&&this.body&&(Ni.setValue(e.x,e.y,e.z),this.body.setAngularVelocity(Ni)),this._angularVelocity.copy(e)}}),Object.assign(Vi.prototype,{createBody:function(){var e,t=this.entity;if(t.collision&&(e=t.collision.shape,t.trigger&&(t.trigger.destroy(),delete t.trigger)),e){this.body&&(this.system.removeBody(this.body),Ammo.destroy(this.body));var i=(n=this.isStaticOrKinematic())?0:this.mass,s=new Ammo.btVector3(0,0,0);n||e.calculateLocalInertia(i,s);var n=t.getPosition(),a=t.getRotation();Bi.setValue(a.x,a.y,a.z,a.w),(a=new Ammo.btTransform).setIdentity(),a.getOrigin().setValue(n.x,n.y,n.z),a.setRotation(Bi),n=new Ammo.btDefaultMotionState(a),e=new Ammo.btRigidBodyConstructionInfo(i,n,e,s),(e=new Ammo.btRigidBody(e)).setRestitution(this.restitution),e.setFriction(this.friction),e.setDamping(this.linearDamping,this.angularDamping),i=this.linearFactor,Ni.setValue(i.x,i.y,i.z),e.setLinearFactor(Ni),i=this.angularFactor,Ni.setValue(i.x,i.y,i.z),e.setAngularFactor(Ni),e.entity=t,this.isKinematic()&&(e.setCollisionFlags(e.getCollisionFlags()|te.BODYFLAG_KINEMATIC_OBJECT),e.setActivationState(te.BODYSTATE_DISABLE_DEACTIVATION)),t.rigidbody.body=e,this.enabled&&this.entity.enabled&&this.enableSimulation()}},isActive:function(){return!!this.body&&this.body.isActive()},activate:function(){this.body&&this.body.activate()},enableSimulation:function(){if(this.entity.collision&&this.entity.collision.enabled&&!this.data.simulationEnabled){var e=this.body;e&&(this.system.addBody(e,this.group,this.mask),this.isKinematic()?(e.forceActivationState(te.BODYSTATE_DISABLE_DEACTIVATION),e.activate()):(e.forceActivationState(te.BODYFLAG_ACTIVE_TAG),this.syncEntityToBody()),this.data.simulationEnabled=!0)}},disableSimulation:function(){var e=this.body;e&&this.data.simulationEnabled&&(this.system.removeBody(e),e.forceActivationState(te.BODYSTATE_DISABLE_SIMULATION),this.data.simulationEnabled=!1)},applyForce:function(){var e,t,i,s,n,a;switch(arguments.length){case 1:e=arguments[0].x,t=arguments[0].y,i=arguments[0].z;break;case 2:e=arguments[0].x,t=arguments[0].y,i=arguments[0].z,s=arguments[1].x,n=arguments[1].y,a=arguments[1].z;break;case 3:e=arguments[0],t=arguments[1],i=arguments[2];break;case 6:e=arguments[0],t=arguments[1],i=arguments[2],s=arguments[3],n=arguments[4],a=arguments[5]}var r=this.body;r&&(r.activate(),Ni.setValue(e,t,i),void 0!==s?(Fi.setValue(s,n,a),r.applyForce(Ni,Fi)):r.applyForce(Ni,ki))},applyTorque:function(){var e,t,i;switch(arguments.length){case 1:e=arguments[0].x,t=arguments[0].y,i=arguments[0].z;break;case 3:e=arguments[0],t=arguments[1],i=arguments[2];break;default:return}var s=this.body;s&&(s.activate(),Ni.setValue(e,t,i),s.applyTorque(Ni))},applyImpulse:function(){var e,t,i,s,n,a;switch(arguments.length){case 1:e=arguments[0].x,t=arguments[0].y,i=arguments[0].z;break;case 2:e=arguments[0].x,t=arguments[0].y,i=arguments[0].z,s=arguments[1].x,n=arguments[1].y,a=arguments[1].z;break;case 3:e=arguments[0],t=arguments[1],i=arguments[2];break;case 6:e=arguments[0],t=arguments[1],i=arguments[2],s=arguments[3],n=arguments[4],a=arguments[5];break;default:return}var r=this.body;r&&(r.activate(),Ni.setValue(e,t,i),void 0!==s?(Fi.setValue(s,n,a),r.applyImpulse(Ni,Fi)):r.applyImpulse(Ni,ki))},applyTorqueImpulse:function(){var e,t,i;switch(arguments.length){case 1:e=arguments[0].x,t=arguments[0].y,i=arguments[0].z;break;case 3:e=arguments[0],t=arguments[1],i=arguments[2];break;default:return}var s=this.body;s&&(s.activate(),Ni.setValue(e,t,i),s.applyTorqueImpulse(Ni))},isStatic:function(){return this.type===te.BODYTYPE_STATIC},isStaticOrKinematic:function(){return this.type===te.BODYTYPE_STATIC||this.type===te.BODYTYPE_KINEMATIC},isKinematic:function(){return this.type===te.BODYTYPE_KINEMATIC},syncEntityToBody:function(){var e=this.body;if(e){var t=this.entity.getPosition(),i=this.entity.getRotation(),s=e.getWorldTransform();s.getOrigin().setValue(t.x,t.y,t.z),Bi.setValue(i.x,i.y,i.z,i.w),s.setRotation(Bi),this.isKinematic()&&(t=this.body.getMotionState())&&t.setWorldTransform(s),e.activate()}},syncBodyToEntity:function(){if((e=this.body).isActive()&&(e=e.getMotionState())){e.getWorldTransform(Di);var e=Di.getOrigin(),t=Di.getRotation();this.entity.setPosition(e.x(),e.y(),e.z()),this.entity.setRotation(t.x(),t.y(),t.z(),t.w())}},teleport:function(){arguments.length<3?(arguments[0]&&this.entity.setPosition(arguments[0]),arguments[1]&&(arguments[1]instanceof te.Quat?this.entity.setRotation(arguments[1]):this.entity.setEulerAngles(arguments[1]))):(6===arguments.length&&this.entity.setEulerAngles(arguments[3],arguments[4],arguments[5]),this.entity.setPosition(arguments[0],arguments[1],arguments[2])),this.syncEntityToBody()},_updateKinematic:function(e){if(this._displacement.copy(this._linearVelocity).scale(e),this.entity.translate(this._displacement),this._displacement.copy(this._angularVelocity).scale(e),this.entity.rotate(this._displacement.x,this._displacement.y,this._displacement.z),this.body.getMotionState()){e=this.entity.getPosition();var t=this.entity.getRotation();Di.getOrigin().setValue(e.x,e.y,e.z),Bi.setValue(t.x,t.y,t.z,t.w),Di.setRotation(Bi),this.body.getMotionState().setWorldTransform(Di)}},onEnable:function(){this.body||this.createBody(),this.enableSimulation()},onDisable:function(){this.disableSimulation()},onSetMass:function(e,t,i){if(e=this.data.body){(t=this.enabled&&this.entity.enabled)&&this.disableSimulation();var s=new Ammo.btVector3(0,0,0);e.getCollisionShape().calculateLocalInertia(i,s),e.setMassProps(i,s),e.updateInertiaTensor(),t&&this.enableSimulation()}},onSetLinearDamping:function(e,t,i){(e=this.data.body)&&e.setDamping(i,this.data.angularDamping)},onSetAngularDamping:function(e,t,i){(e=this.data.body)&&e.setDamping(this.data.linearDamping,i)},onSetLinearFactor:function(e,t,i){(e=this.data.body)&&(Ni.setValue(i.x,i.y,i.z),e.setLinearFactor(Ni))},onSetAngularFactor:function(e,t,i){(e=this.data.body)&&(Ni.setValue(i.x,i.y,i.z),e.setAngularFactor(Ni))},onSetFriction:function(e,t,i){(e=this.data.body)&&e.setFriction(i)},onSetRestitution:function(e,t,i){(e=this.data.body)&&e.setRestitution(i)},onSetType:function(e,t,i){i!==t&&(this.disableSimulation(),i===te.BODYTYPE_DYNAMIC?(this.data.group=te.BODYGROUP_DYNAMIC,this.data.mask=te.BODYMASK_ALL):i===te.BODYTYPE_KINEMATIC?(this.data.group=te.BODYGROUP_KINEMATIC,this.data.mask=te.BODYMASK_ALL):(this.data.group=te.BODYGROUP_STATIC,this.data.mask=te.BODYMASK_NOT_STATIC),this.createBody())},onSetGroupOrMask:function(e,t,i){i!==t&&this.enabled&&this.entity.enabled&&(this.disableSimulation(),this.enableSimulation())},onSetBody:function(e,t,i){this.body&&this.data.simulationEnabled&&this.body.activate()}}),{RigidBodyComponent:Vi})),Object.assign(te,(Hi={},Gi=!(ji={}),Wi=function(e,t,i){this.entity=e,this.point=t,this.normal=i},Yi=function(e,t,i){0===arguments.length?(this.b=this.a=null,this.localPointA=new te.Vec3,this.localPointB=new te.Vec3,this.pointA=new te.Vec3,this.pointB=new te.Vec3,this.normal=new te.Vec3):(this.a=e,this.b=t,this.localPointA=i.localPoint,this.localPointB=i.localPointOther,this.pointA=i.point,this.pointB=i.pointOther,this.normal=i.normal)},Xi=function(e,t,i,s,n){0===arguments.length?(this.localPoint=new te.Vec3,this.localPointOther=new te.Vec3,this.point=new te.Vec3,this.pointOther=new te.Vec3,this.normal=new te.Vec3):(this.localPoint=e,this.localPointOther=t,this.point=i,this.pointOther=s,this.normal=n)},qi=function(e,t){this.other=e,this.contacts=t},Ki="enabled type mass linearDamping angularDamping linearFactor angularFactor friction restitution group mask body".split(" "),((Zi=function(e){te.ComponentSystem.call(this,e),this.id="rigidbody",this.description="Adds the entity to the scene's physical simulation.",this._stats=e.stats.frame,this.ComponentType=te.RigidBodyComponent,this.DataType=te.RigidBodyComponentData,this.contactPointPool=new te.AllocatePool(Xi,1),this.contactResultPool=new te.AllocatePool(qi,1),this.singleContactResultPool=new te.AllocatePool(Yi,1),this.schema=Ki,this.maxSubSteps=10,this.fixedTimeStep=1/60,this.gravity=new te.Vec3(0,-9.81,0),this.on("remove",this.onRemove,this)}).prototype=Object.create(te.ComponentSystem.prototype)).constructor=Zi,te.Component._buildAccessors(te.RigidBodyComponent.prototype,Ki),Object.assign(Zi.prototype,{onLibraryLoaded:function(){if("undefined"!=typeof Ammo){var e=new Ammo.btDefaultCollisionConfiguration,t=new Ammo.btCollisionDispatcher(e),i=new Ammo.btDbvtBroadphase,s=new Ammo.btSequentialImpulseConstraintSolver;this.dynamicsWorld=new Ammo.btDiscreteDynamicsWorld(t,i,s,e),Ui=new Ammo.btVector3,zi=new Ammo.btVector3,te.ComponentSystem.bind("update",this.onUpdate,this)}else te.ComponentSystem.unbind("update",this.onUpdate,this)},initializeComponentData:function(e,t,i){for(var s={},n=0,a=(i="enabled mass linearDamping angularDamping linearFactor angularFactor friction restitution type group mask".split(" ")).length;n<a;n++){var r=i[n];s[r]=t[r]}t.bodyType&&(s.type=t.bodyType),s.linearFactor&&"array"===te.type(s.linearFactor)&&(s.linearFactor=new te.Vec3(s.linearFactor[0],s.linearFactor[1],s.linearFactor[2])),s.angularFactor&&"array"===te.type(s.angularFactor)&&(s.angularFactor=new te.Vec3(s.angularFactor[0],s.angularFactor[1],s.angularFactor[2])),te.ComponentSystem.prototype.initializeComponentData.call(this,e,s,i)},cloneComponent:function(e,t){this.addComponent(t,{enabled:e.rigidbody.enabled,mass:e.rigidbody.mass,linearDamping:e.rigidbody.linearDamping,angularDamping:e.rigidbody.angularDamping,linearFactor:[e.rigidbody.linearFactor.x,e.rigidbody.linearFactor.y,e.rigidbody.linearFactor.z],angularFactor:[e.rigidbody.angularFactor.x,e.rigidbody.angularFactor.y,e.rigidbody.angularFactor.z],friction:e.rigidbody.friction,restitution:e.rigidbody.restitution,type:e.rigidbody.type,group:e.rigidbody.group,mask:e.rigidbody.mask})},onRemove:function(e,t){t.body&&(this.removeBody(t.body),Ammo.destroy(t.body)),t.body=null},addBody:function(e,t,i){return void 0!==t&&void 0!==i?this.dynamicsWorld.addRigidBody(e,t,i):this.dynamicsWorld.addRigidBody(e),e},removeBody:function(e){this.dynamicsWorld.removeRigidBody(e)},addConstraint:function(e){return this.dynamicsWorld.addConstraint(e),e},removeConstraint:function(e){this.dynamicsWorld.removeConstraint(e)},raycastFirst:function(e,t){var i=null;Ui.setValue(e.x,e.y,e.z),zi.setValue(t.x,t.y,t.z);var s=new Ammo.ClosestRayResultCallback(Ui,zi);if(this.dynamicsWorld.rayTest(Ui,zi,s),s.hasHit()){var n=s.get_m_collisionObject();if(n=Ammo.castObject(n,Ammo.btRigidBody)){i=s.get_m_hitPointWorld();var a=s.get_m_hitNormalWorld();i=new Wi(n.entity,new te.Vec3(i.x(),i.y(),i.z()),new te.Vec3(a.x(),a.y(),a.z())),2<arguments.length&&((0,arguments[2])(i),Gi||(Gi=!0))}}return Ammo.destroy(s),i},_storeCollision:function(e,t){var i=!1,s=e.getGuid();return Hi[s]=Hi[s]||{others:[],entity:e},Hi[s].others.indexOf(t)<0&&(Hi[s].others.push(t),i=!0),ji[s]=ji[s]||{others:[],entity:e},ji[s].others.push(t),i},_createContactPointFromAmmo:function(e){var t=this.contactPointPool.allocate();return t.localPoint.set(e.get_m_localPointA().x(),e.get_m_localPointA().y(),e.get_m_localPointA().z()),t.localPointOther.set(e.get_m_localPointB().x(),e.get_m_localPointB().y(),e.get_m_localPointB().z()),t.point.set(e.getPositionWorldOnA().x(),e.getPositionWorldOnA().y(),e.getPositionWorldOnA().z()),t.pointOther.set(e.getPositionWorldOnB().x(),e.getPositionWorldOnB().y(),e.getPositionWorldOnB().z()),t.normal.set(e.get_m_normalWorldOnB().x(),e.get_m_normalWorldOnB().y(),e.get_m_normalWorldOnB().z()),t},_createReverseContactPointFromAmmo:function(e){var t=this.contactPointPool.allocate();return t.localPointOther.set(e.get_m_localPointA().x(),e.get_m_localPointA().y(),e.get_m_localPointA().z()),t.localPoint.set(e.get_m_localPointB().x(),e.get_m_localPointB().y(),e.get_m_localPointB().z()),t.pointOther.set(e.getPositionWorldOnA().x(),e.getPositionWorldOnA().y(),e.getPositionWorldOnA().z()),t.point.set(e.getPositionWorldOnB().x(),e.getPositionWorldOnB().y(),e.getPositionWorldOnB().z()),t.normal.set(e.get_m_normalWorldOnB().x(),e.get_m_normalWorldOnB().y(),e.get_m_normalWorldOnB().z()),t},_createSingleContactResult:function(e,t,i){var s=this.singleContactResultPool.allocate();return s.a=e,s.b=t,s.localPointA=i.localPoint,s.localPointB=i.localPointOther,s.pointA=i.point,s.pointB=i.pointOther,s.normal=i.normal,s},_createContactResult:function(e,t){var i=this.contactResultPool.allocate();return i.other=e,i.contacts=t,i},_cleanOldCollisions:function(){for(var e in Hi)if(Hi.hasOwnProperty(e)){for(var t=Hi[e].entity,i=t.collision,s=Hi[e].others,n=s.length;n--;){var a=s[n];(!ji[e]||ji[e].others.indexOf(a)<0)&&(s.splice(n,1),i&&a.collision&&(t.rigidbody&&a.rigidbody?i.fire("collisionend",a):t.trigger&&i.fire("triggerleave",a)))}0===s.length&&delete Hi[e]}},onUpdate:function(e){(s=this.dynamicsWorld.getGravity()).x()===this.gravity.x&&s.y()===this.gravity.y&&s.z()===this.gravity.z||(s.setValue(this.gravity.x,this.gravity.y,this.gravity.z),this.dynamicsWorld.setGravity(s)),this.dynamicsWorld.stepSimulation(e,this.maxSubSteps,this.fixedTimeStep);var t,i,s=this.store;for(t in s)if(s.hasOwnProperty(t)){var n=s[t].entity;(h=s[t].data).body&&h.body.isActive()&&h.enabled&&n.enabled&&(h.type===te.BODYTYPE_DYNAMIC?n.rigidbody.syncBodyToEntity():h.type===te.BODYTYPE_KINEMATIC&&n.rigidbody._updateKinematic(e))}for(t=(e=this.dynamicsWorld.getDispatcher()).getNumManifolds(),ji={},s=0;s<t;s++){var a=e.getManifoldByIndexInternal(s),r=a.getBody0(),o=a.getBody1(),h=(n=Ammo.castObject(r,Ammo.btRigidBody),Ammo.castObject(o,Ammo.btRigidBody));if(n=n.entity,h=h.entity,n&&h){i=r.getCollisionFlags();var l,c=o.getCollisionFlags(),d=a.getNumContacts(),u=[];if(o=[],0<d)if(i&te.BODYFLAG_NORESPONSE_OBJECT||c&te.BODYFLAG_NORESPONSE_OBJECT)l=!!n.collision&&(n.collision.hasEvent("triggerenter")||n.collision.hasEvent("triggerleave")),r=!!h.collision&&(h.collision.hasEvent("triggerenter")||h.collision.hasEvent("triggerleave")),l&&(a=this._storeCollision(n,h))&&(!n.collision||c&te.BODYFLAG_NORESPONSE_OBJECT||n.collision.fire("triggerenter",h)),r&&(a=this._storeCollision(h,n))&&(!h.collision||i&te.BODYFLAG_NORESPONSE_OBJECT||h.collision.fire("triggerenter",n));else if(l=!!n.collision&&(n.collision.hasEvent("collisionstart")||n.collision.hasEvent("collisionend")||n.collision.hasEvent("contact")),r=!!h.collision&&(h.collision.hasEvent("collisionstart")||h.collision.hasEvent("collisionend")||h.collision.hasEvent("contact")),(c=this.hasEvent("contact"))||l||r){for(i=0;i<d;i++){var p=a.getContactPoint(i),f=this._createContactPointFromAmmo(p);(l||r)&&(p=this._createReverseContactPointFromAmmo(p),u.push(f),o.push(p)),c&&(f=this._createSingleContactResult(n,h,f),this.fire("contact",f))}l&&(d=this._createContactResult(h,u),n.collision&&n.collision.fire("contact",d),(a=this._storeCollision(n,h))&&n.collision&&n.collision.fire("collisionstart",d)),r&&(o=this._createContactResult(n,o),h.collision&&h.collision.fire("contact",o),(a=this._storeCollision(h,n))&&h.collision&&h.collision.fire("collisionstart",o))}}}this._cleanOldCollisions(),this.contactPointPool.freeAll(),this.contactResultPool.freeAll(),this.singleContactResultPool.freeAll()}}),{RIGIDBODY_TYPE_STATIC:"static",RIGIDBODY_TYPE_DYNAMIC:"dynamic",RIGIDBODY_TYPE_KINEMATIC:"kinematic",RIGIDBODY_CF_STATIC_OBJECT:1,RIGIDBODY_CF_KINEMATIC_OBJECT:2,RIGIDBODY_CF_NORESPONSE_OBJECT:4,RIGIDBODY_ACTIVE_TAG:1,RIGIDBODY_ISLAND_SLEEPING:2,RIGIDBODY_WANTS_DEACTIVATION:3,RIGIDBODY_DISABLE_DEACTIVATION:4,RIGIDBODY_DISABLE_SIMULATION:5,RigidBodyComponentSystem:Zi})),Object.assign(te,{RigidBodyComponentData:function(){this.enabled=!0,this.mass=1,this.angularDamping=this.linearDamping=0,this.linearFactor=new te.Vec3(1,1,1),this.angularFactor=new te.Vec3(1,1,1),this.friction=.5,this.restitution=0,this.type=te.BODYTYPE_STATIC,this.group=te.BODYGROUP_STATIC,this.mask=te.BODYMASK_NOT_STATIC,this.body=null,this.simulationEnabled=!1}}),Object.assign(te,(Ji=function(e,t,i){this.entity=t.entity,this.component=t,this.app=e,"undefined"!=typeof Ammo&&(Qi=new Ammo.btVector3,$i=new Ammo.btQuaternion),this.initialize(i)},Object.assign(Ji.prototype,{initialize:function(e){var t=this.entity;if((e=e.shape)&&"undefined"!=typeof Ammo){t.trigger&&t.trigger.destroy();var i=new Ammo.btVector3(0,0,0);e.calculateLocalInertia(1,i);var s=t.getPosition(),n=t.getRotation();$i.setValue(n.x,n.y,n.z,n.w),(n=new Ammo.btTransform).setIdentity(),n.getOrigin().setValue(s.x,s.y,s.z),n.setRotation($i),s=new Ammo.btDefaultMotionState(n),e=new Ammo.btRigidBodyConstructionInfo(1,s,e,i),this.body=e=new Ammo.btRigidBody(e),e.setRestitution(0),e.setFriction(0),e.setDamping(0,0),Qi.setValue(0,0,0),e.setLinearFactor(Qi),e.setAngularFactor(Qi),e.setCollisionFlags(e.getCollisionFlags()|te.BODYFLAG_NORESPONSE_OBJECT),e.entity=t,this.component.enabled&&t.enabled&&this.enable()}},destroy:function(){this.body&&this.app.systems.rigidbody.removeBody(this.body)},syncEntityToBody:function(){var e=this.body;if(e){var t=this.entity.getPosition(),i=this.entity.getRotation(),s=e.getWorldTransform();s.getOrigin().setValue(t.x,t.y,t.z),$i.setValue(i.x,i.y,i.z,i.w),s.setRotation($i),e.activate()}},enable:function(){var e=this.body;e&&(this.app.systems.rigidbody.addBody(e,te.BODYGROUP_TRIGGER,te.BODYMASK_NOT_STATIC^te.BODYGROUP_TRIGGER),e.forceActivationState(te.BODYSTATE_ACTIVE_TAG),e.activate(),this.syncEntityToBody())},disable:function(){var e=this.body;e&&(this.app.systems.rigidbody.removeBody(e),e.forceActivationState(te.BODYSTATE_DISABLE_SIMULATION))}}),{Trigger:Ji})),Object.assign(te,(((es=function(e,t){te.Component.call(this,e,t),this.on("set_type",this.onSetType,this),this.on("set_halfExtents",this.onSetHalfExtents,this),this.on("set_radius",this.onSetRadius,this),this.on("set_height",this.onSetHeight,this),this.on("set_axis",this.onSetAxis,this),this.on("set_asset",this.onSetAsset,this),this.on("set_model",this.onSetModel,this)}).prototype=Object.create(te.Component.prototype)).constructor=es,Object.assign(es.prototype,{onSetType:function(e,t,i){t!==i&&this.system.changeType(this,t,i)},onSetHalfExtents:function(e,t,i){this.data.initialized&&"box"===this.data.type&&this.system.recreatePhysicalShapes(this)},onSetRadius:function(e,t,i){!this.data.initialized||"sphere"!==this.data.type&&"capsule"!==this.data.type&&"cylinder"!==this.data.type||this.system.recreatePhysicalShapes(this)},onSetHeight:function(e,t,i){!this.data.initialized||"capsule"!==this.data.type&&"cylinder"!==this.data.type||this.system.recreatePhysicalShapes(this)},onSetAxis:function(e,t,i){!this.data.initialized||"capsule"!==this.data.type&&"cylinder"!==this.data.type||this.system.recreatePhysicalShapes(this)},onSetAsset:function(e,t,i){e=this.system.app.assets,t&&(t=e.get(t))&&t.off("remove",this.onAssetRemoved,this),i&&(i instanceof te.Asset&&(this.data.asset=i.id),t=e.get(this.data.asset))&&(t.off("remove",this.onAssetRemoved,this),t.on("remove",this.onAssetRemoved,this)),this.data.initialized&&"mesh"===this.data.type&&(i||(this.data.model=null),this.system.recreatePhysicalShapes(this))},onSetModel:function(e,t,i){this.data.initialized&&"mesh"===this.data.type&&this.system.implementations.mesh.doRecreatePhysicalShape(this)},onAssetRemoved:function(e){e.off("remove",this.onAssetRemoved,this),this.data.asset===e.id&&(this.asset=null)},onEnable:function(){if("mesh"===this.data.type&&this.data.asset&&this.data.initialized){var e=this.system.app.assets.get(this.data.asset);if(e&&(!e.resource||!this.data.shape))return void this.system.recreatePhysicalShapes(this)}this.entity.trigger?this.entity.trigger.enable():this.entity.rigidbody&&this.entity.rigidbody.enabled&&this.entity.rigidbody.enableSimulation()},onDisable:function(){this.entity.trigger?this.entity.trigger.disable():this.entity.rigidbody&&this.entity.rigidbody.disableSimulation()}}),{CollisionComponent:es})),Object.assign(te,function(){var t="enabled type halfExtents radius axis height asset shape model".split(" "),e=function(e){this.system=e};Object.assign(e.prototype,{beforeInitialize:function(e,t){t.shape=this.createPhysicalShape(e.entity,t),t.model=new te.Model,t.model.graph=new te.GraphNode},afterInitialize:function(e,t){this.recreatePhysicalShapes(e),e.data.initialized=!0},reset:function(e,t){this.beforeInitialize(e,t),this.afterInitialize(e,t)},recreatePhysicalShapes:function(e){var t=e.entity,i=e.data;"undefined"!=typeof Ammo&&(i.shape=this.createPhysicalShape(e.entity,i),t.rigidbody?(t.rigidbody.disableSimulation(),t.rigidbody.createBody()):t.trigger?t.trigger.initialize(i):t.trigger=new te.Trigger(this.system.app,e,i))},createPhysicalShape:function(e,t){},updateTransform:function(e,t,i,s){e.entity.trigger&&e.entity.trigger.syncEntityToBody()},remove:function(e,t){var i=this.system.app;e.rigidbody&&e.rigidbody.body&&(i.systems.rigidbody.removeBody(e.rigidbody.body),e.rigidbody.disableSimulation()),e.trigger&&(e.trigger.destroy(),delete e.trigger),i.scene.containsModel(t.model)&&(i.root.removeChild(t.model.graph),i.scene.removeModel(t.model))},clone:function(e,t){var i=this.system.store[e.getGuid()];return this.system.addComponent(t,{enabled:i.data.enabled,type:i.data.type,halfExtents:[i.data.halfExtents.x,i.data.halfExtents.y,i.data.halfExtents.z],radius:i.data.radius,axis:i.data.axis,height:i.data.height,asset:i.data.asset,model:i.data.model})}});var i=function(e){this.system=e};(i.prototype=Object.create(e.prototype)).constructor=i,Object.assign(i.prototype,{createPhysicalShape:function(e,t){if("undefined"!=typeof Ammo){var i=t.halfExtents;i=new Ammo.btVector3(i?i.x:.5,i?i.y:.5,i?i.z:.5);return new Ammo.btBoxShape(i)}}});var s=function(e){this.system=e};(s.prototype=Object.create(e.prototype)).constructor=s,Object.assign(s.prototype,{createPhysicalShape:function(e,t){if("undefined"!=typeof Ammo)return new Ammo.btSphereShape(t.radius)}});var n=function(e){this.system=e};(n.prototype=Object.create(e.prototype)).constructor=n,Object.assign(n.prototype,{createPhysicalShape:function(e,t){var i=null,s=void 0!==t.axis?t.axis:1,n=t.radius||.5,a=Math.max((t.height||2)-2*n,0);if("undefined"!=typeof Ammo)switch(s){case 0:i=new Ammo.btCapsuleShapeX(n,a);break;case 1:i=new Ammo.btCapsuleShape(n,a);break;case 2:i=new Ammo.btCapsuleShapeZ(n,a)}return i}});var a=function(e){this.system=e};(a.prototype=Object.create(e.prototype)).constructor=a,Object.assign(a.prototype,{createPhysicalShape:function(e,t){var i;i=null;var s=void 0!==t.axis?t.axis:1,n=void 0!==t.radius?t.radius:.5,a=void 0!==t.height?t.height:1;if("undefined"!=typeof Ammo)switch(s){case 0:i=new Ammo.btVector3(.5*a,n,n),i=new Ammo.btCylinderShapeX(i);break;case 1:i=new Ammo.btVector3(n,.5*a,n),i=new Ammo.btCylinderShape(i);break;case 2:i=new Ammo.btVector3(n,n,.5*a),i=new Ammo.btCylinderShapeZ(i)}return i}});var r=function(e){this.system=e};return(r.prototype=Object.create(e.prototype)).constructor=r,Object.assign(r.prototype,{beforeInitialize:function(e,t){},createPhysicalShape:function(e,t){if("undefined"!=typeof Ammo&&t.model){var i,s,n=t.model,a=new Ammo.btCompoundShape;for(i=0;i<n.meshInstances.length;i++){var r,o=n.meshInstances[i],h=o.mesh,l=h.indexBuffer[te.RENDERSTYLE_SOLID],c=(f=(p=h.vertexBuffer).getFormat()).size/4;for(s=0;s<f.elements.length;s++){(m=f.elements[s]).name===te.SEMANTIC_POSITION&&(r=new Float32Array(p.lock(),m.offset))}l=new Uint16Array(l.lock());var d,u,p=h.primitive[0].count/3,f=new Ammo.btVector3,m=new Ammo.btVector3,_=new Ammo.btVector3,g=h.primitive[0].base,y=new Ammo.btTriangleMesh;for(s=0;s<p;s++)h=l[g+3*s]*c,d=l[g+3*s+1]*c,u=l[g+3*s+2]*c,f.setValue(r[h],r[h+1],r[h+2]),m.setValue(r[d],r[1+d],r[2+d]),_.setValue(r[u],r[1+u],r[2+u]),y.addTriangle(f,m,_,!0);s=new Ammo.btBvhTriangleMeshShape(y,!0),c=o.node.getWorldTransform().getScale(),s.setLocalScaling(new Ammo.btVector3(c.x,c.y,c.z)),c=o.node.getPosition(),o=o.node.getRotation(),(l=new Ammo.btTransform).setIdentity(),l.getOrigin().setValue(c.x,c.y,c.z),(c=new Ammo.btQuaternion).setValue(o.x,o.y,o.z,o.w),l.setRotation(c),a.addChildShape(l,s)}return n=e.getWorldTransform().getScale(),(i=new Ammo.btVector3).setValue(n.x,n.y,n.z),a.setLocalScaling(i),a}},recreatePhysicalShapes:function(e){null!==e.data.asset&&e.enabled&&e.entity.enabled?this.loadModelAsset(e):this.doRecreatePhysicalShape(e)},loadModelAsset:function(t){var i=this,e=t.data.asset,s=t.data,n=this.system.app.assets,a=n.get(e);a?(a.ready(function(e){s.model=e.resource,i.doRecreatePhysicalShape(t)}),n.load(a)):n.once("add:"+e,function(e){e.ready(function(e){s.model=e.resource,i.doRecreatePhysicalShape(t)}),n.load(e)})},doRecreatePhysicalShape:function(e){var t=e.entity,i=e.data;i.model?(i.shape&&Ammo.destroy(i.shape),i.shape=this.createPhysicalShape(t,i),t.rigidbody?t.rigidbody.createBody():t.trigger?t.trigger.initialize(i):t.trigger=new te.Trigger(this.system.app,e,i)):this.remove(t,i)},updateTransform:function(e,t,i,s){if(e.shape){var n=e.entity.getWorldTransform().getScale(),a=e.shape.getLocalScaling();n.x===a.x()&&n.y===a.y()&&n.z===a.z()||this.doRecreatePhysicalShape(e)}te.CollisionSystemImpl.prototype.updateTransform.call(this,e,t,i,s)}}),(e=function(e){te.ComponentSystem.call(this,e),this.id="collision",this.description="Specifies a collision volume.",this.ComponentType=te.CollisionComponent,this.DataType=te.CollisionComponentData,this.schema=t,this.implementations={},this.on("remove",this.onRemove,this),te.ComponentSystem.bind("update",this.onUpdate,this)}).prototype=Object.create(te.ComponentSystem.prototype),e.prototype.constructor=e,te.Component._buildAccessors(te.CollisionComponent.prototype,t),Object.assign(e.prototype,{onLibraryLoaded:function(){"undefined"==typeof Ammo&&te.ComponentSystem.unbind("update",this.onUpdate,this)},initializeComponentData:function(e,t,i){for(var s={},n=0,a=(i="type halfExtents radius axis height shape model asset enabled".split(" ")).length;n<a;n++){var r=i[n];s[r]=t[r]}t.hasOwnProperty("asset")?-1!==(t=i.indexOf("model"))&&i.splice(t,1):t.hasOwnProperty("model")&&(-1!==(t=i.indexOf("asset"))&&i.splice(t,1)),s.type||(s.type=e.data.type),e.data.type=s.type,s.halfExtents&&"array"===te.type(s.halfExtents)&&(s.halfExtents=new te.Vec3(s.halfExtents[0],s.halfExtents[1],s.halfExtents[2])),(t=this._createImplementation(s.type)).beforeInitialize(e,s),te.ComponentSystem.prototype.initializeComponentData.call(this.system,e,s,i),t.afterInitialize(e,s)},_createImplementation:function(e){if(void 0===this.implementations[e]){var t;switch(e){case"box":t=new i(this);break;case"sphere":t=new s(this);break;case"capsule":t=new n(this);break;case"cylinder":t=new a(this);break;case"mesh":t=new r(this)}this.implementations[e]=t}return this.implementations[e]},_getImplementation:function(e){return this.implementations[e.collision.data.type]},cloneComponent:function(e,t){return this._getImplementation(e).clone(e,t)},onRemove:function(e,t){this.implementations[t.type].remove(e,t)},onUpdate:function(e){var t,i=this.store;for(t in i)e=i[t].entity,i[t].data.enabled&&e.enabled&&!e.rigidbody&&e.trigger&&e.trigger.syncEntityToBody()},onTransformChanged:function(e,t,i,s){this.implementations[e.data.type].updateTransform(e,t,i,s)},changeType:function(e,t,i){this.implementations[t].remove(e.entity,e.data),this._createImplementation(i).reset(e,e.data)},recreatePhysicalShapes:function(e){this.implementations[e.data.type].recreatePhysicalShapes(e)}}),{CollisionComponentSystem:e}}()),Object.assign(te,{CollisionComponentData:function(){this.enabled=!0,this.type="box",this.halfExtents=new te.Vec3(.5,.5,.5),this.radius=.5,this.axis=1,this.height=2,this.model=this.shape=this.asset=null,this.initialized=!1}}),Object.assign(te,(is="emitterExtents emitterRadius emitterExtentsInner emitterRadiusInner loop initialVelocity animSpeed normalMap particleNormal".split(" "),ss="numParticles lifetime rate rate2 startAngle startAngle2 lighting halfLambert intensity wrap wrapBounds depthWrite noFog sort stretch alignToMotion preWarm emitterShape animTilesX animTilesY animNumFrames animLoop colorMap localSpace orientation".split(" "),ns="scaleGraph scaleGraph2 colorGraph colorGraph2 alphaGraph alphaGraph2 velocityGraph velocityGraph2 localVelocityGraph localVelocityGraph2 rotationSpeedGraph rotationSpeedGraph2 radialSpeedGraph radialSpeedGraph2".split(" "),as=["colorMapAsset","normalMapAsset","meshAsset"],((rs=function(e,t){te.Component.call(this,e,t),this.on("set_colorMapAsset",this.onSetColorMapAsset,this),this.on("set_normalMapAsset",this.onSetNormalMapAsset,this),this.on("set_meshAsset",this.onSetMeshAsset,this),this.on("set_mesh",this.onSetMesh,this),this.on("set_loop",this.onSetLoop,this),this.on("set_blendType",this.onSetBlendType,this),this.on("set_depthSoftening",this.onSetDepthSoftening,this),this.on("set_layers",this.onSetLayers,this),is.forEach(function(e){this.on("set_"+e,this.onSetSimpleProperty,this)}.bind(this)),ss.forEach(function(e){this.on("set_"+e,this.onSetComplexProperty,this)}.bind(this)),ns.forEach(function(e){this.on("set_"+e,this.onSetGraphProperty,this)}.bind(this)),this._requestedDepth=!1}).prototype=Object.create(te.Component.prototype)).constructor=rs,Object.assign(rs.prototype,{addModelToLayers:function(){if(this.data.model)for(var e,t=0;t<this.layers.length;t++)(e=this.system.app.scene.layers.getLayerById(this.layers[t]))&&(e.addMeshInstances(this.data.model.meshInstances),this.emitter._layer=e)},removeModelFromLayers:function(e){if(this.data.model)for(var t=0;t<this.layers.length;t++)(e=this.system.app.scene.layers.getLayerById(this.layers[t]))&&e.removeMeshInstances(this.data.model.meshInstances)},onSetLayers:function(e,t,i){if(this.data.model){var s;for(e=0;e<t.length;e++)(s=this.system.app.scene.layers.getLayerById(t[e]))&&s.removeMeshInstances(this.data.model.meshInstances);if(this.enabled&&this.entity.enabled)for(e=0;e<i.length;e++)(s=this.system.app.scene.layers.getLayerById(i[e]))&&s.addMeshInstances(this.data.model.meshInstances)}},onLayersChanged:function(e,t){this.addModelToLayers(),e.off("add",this.onLayerAdded,this),e.off("remove",this.onLayerRemoved,this),t.on("add",this.onLayerAdded,this),t.on("remove",this.onLayerRemoved,this)},onLayerAdded:function(e){this.data.model&&(this.layers.indexOf(e.id)<0||e.addMeshInstances(this.data.model.meshInstances))},onLayerRemoved:function(e){this.data.model&&(this.layers.indexOf(e.id)<0||e.removeMeshInstances(this.data.model.meshInstances))},_bindColorMapAsset:function(e){e.on("load",this._onColorMapAssetLoad,this),e.on("unload",this._onColorMapAssetUnload,this),e.on("remove",this._onColorMapAssetRemove,this),e.on("change",this._onColorMapAssetChange,this),e.resource?this._onColorMapAssetLoad(e):this.enabled&&this.entity.enabled&&this.system.app.assets.load(e)},_unbindColorMapAsset:function(e){e.off("load",this._onColorMapAssetLoad,this),e.off("unload",this._onColorMapAssetUnload,this),e.off("remove",this._onColorMapAssetRemove,this),e.off("change",this._onColorMapAssetChange,this)},_onColorMapAssetLoad:function(e){this.colorMap=e.resource},_onColorMapAssetUnload:function(e){this.colorMap=null},_onColorMapAssetRemove:function(e){this._onColorMapAssetUnload(e)},_onColorMapAssetChange:function(e){},onSetColorMapAsset:function(e,t,i){var s=this;e=this.system.app.assets,t&&(t=e.get(t))&&this._unbindColorMapAsset(t),i?(i instanceof te.Asset&&(i=this.data.colorMapAsset=i.id),(t=e.get(i))?s._bindColorMapAsset(t):e.once("add:"+i,function(e){s._bindColorMapAsset(e)})):this.colorMap=null},_bindNormalMapAsset:function(e){e.on("load",this._onNormalMapAssetLoad,this),e.on("unload",this._onNormalMapAssetUnload,this),e.on("remove",this._onNormalMapAssetRemove,this),e.on("change",this._onNormalMapAssetChange,this),e.resource?this._onNormalMapAssetLoad(e):this.enabled&&this.entity.enabled&&this.system.app.assets.load(e)},_unbindNormalMapAsset:function(e){e.off("load",this._onNormalMapAssetLoad,this),e.off("unload",this._onNormalMapAssetUnload,this),e.off("remove",this._onNormalMapAssetRemove,this),e.off("change",this._onNormalMapAssetChange,this)},_onNormalMapAssetLoad:function(e){this.normalMap=e.resource},_onNormalMapAssetUnload:function(e){this.normalMap=null},_onNormalMapAssetRemove:function(e){this._onNormalMapAssetUnload(e)},_onNormalMapAssetChange:function(e){},onSetNormalMapAsset:function(e,t,i){var s=this;e=this.system.app.assets,t&&(t=e.get(t))&&this._unbindNormalMapAsset(t),i?(i instanceof te.Asset&&(i=this.data.normalMapAsset=i.id),(t=e.get(i))?s._bindNormalMapAsset(t):e.once("add:"+i,function(e){s._bindNormalMapAsset(e)})):this.normalMap=null},_bindMeshAsset:function(e){e.on("load",this._onMeshAssetLoad,this),e.on("unload",this._onMeshAssetUnload,this),e.on("remove",this._onMeshAssetRemove,this),e.on("change",this._onMeshAssetChange,this),e.resource?this._onMeshAssetLoad(e):this.enabled&&this.entity.enabled&&this.system.app.assets.load(e)},_unbindMeshAsset:function(e){e.off("load",this._onMeshAssetLoad,this),e.off("unload",this._onMeshAssetUnload,this),e.off("remove",this._onMeshAssetRemove,this),e.off("change",this._onMeshAssetChange,this)},_onMeshAssetLoad:function(e){this._onMeshChanged(e.resource)},_onMeshAssetUnload:function(e){this.mesh=null},_onMeshAssetRemove:function(e){this._onMeshAssetUnload(e)},_onMeshAssetChange:function(e){},onSetMeshAsset:function(e,t,i){e=this.system.app.assets,t&&(t=e.get(t))&&this._unbindMeshAsset(t),i?(i instanceof te.Asset&&(i=this.data.meshAsset=i.id),(t=e.get(i))&&(this._bindMeshAsset(t),t.resource?this._onMeshChanged(t.resource):e.load(t))):this._onMeshChanged(null)},onSetMesh:function(e,t,i){!i||i instanceof te.Asset||"number"==typeof i?this.meshAsset=i:this._onMeshChanged(i)},_onMeshChanged:function(e){!e||e instanceof te.Mesh||(e=e.meshInstances[0]?e.meshInstances[0].mesh:null),this.data.mesh=e,this.emitter&&(this.emitter.mesh=e,this.emitter.resetMaterial(),this.rebuild())},onSetLoop:function(e,t,i){this.emitter&&(this.emitter[e]=i,this.emitter.resetTime())},onSetBlendType:function(e,t,i){this.emitter&&(this.emitter[e]=i,this.emitter.material.blendType=i,this.emitter.resetMaterial(),this.rebuild())},_requestDepth:function(){this._requestedDepth||(ts||(ts=this.system.app.scene.layers.getLayerById(te.LAYERID_DEPTH)),ts&&(ts.incrementCounter(),this._requestedDepth=!0))},_releaseDepth:function(){this._requestedDepth&&ts&&(ts.decrementCounter(),this._requestedDepth=!1)},onSetDepthSoftening:function(e,t,i){t!==i&&(i?this.enabled&&this.entity.enabled&&this._requestDepth():this.enabled&&this.entity.enabled&&this._releaseDepth(),this.emitter&&(this.emitter[e]=i),this.emitter&&(this.reset(),this.emitter.resetMaterial(),this.rebuild()))},onSetSimpleProperty:function(e,t,i){this.emitter&&(this.emitter[e]=i,this.emitter.resetMaterial())},onSetComplexProperty:function(e,t,i){this.emitter&&(this.emitter[e]=i,this.reset(),this.emitter.resetMaterial(),this.rebuild())},onSetGraphProperty:function(e,t,i){this.emitter&&(this.emitter[e]=i,this.emitter.rebuildGraphs(),this.emitter.resetMaterial())},onEnable:function(){for(var e=this.data,t=0,i=as.length;t<i;t++){var s=e[as[t]];if(s){if(!(s instanceof te.Asset)){if(!(0<=parseInt(s,10)))continue;s=this.system.app.assets.get(s)}s&&!s.resource&&this.system.app.assets.load(s)}}this.emitter||((t=e.mesh)instanceof te.Mesh||(t=null),this.emitter=new te.ParticleEmitter(this.system.app.graphicsDevice,{numParticles:e.numParticles,emitterExtents:e.emitterExtents,emitterExtentsInner:e.emitterExtentsInner,emitterRadius:e.emitterRadius,emitterRadiusInner:e.emitterRadiusInner,emitterShape:e.emitterShape,initialVelocity:e.initialVelocity,wrap:e.wrap,localSpace:e.localSpace,wrapBounds:e.wrapBounds,lifetime:e.lifetime,rate:e.rate,rate2:e.rate2,orientation:e.orientation,particleNormal:e.particleNormal,animTilesX:e.animTilesX,animTilesY:e.animTilesY,animNumFrames:e.animNumFrames,animSpeed:e.animSpeed,animLoop:e.animLoop,startAngle:e.startAngle,startAngle2:e.startAngle2,scaleGraph:e.scaleGraph,scaleGraph2:e.scaleGraph2,colorGraph:e.colorGraph,colorGraph2:e.colorGraph2,alphaGraph:e.alphaGraph,alphaGraph2:e.alphaGraph2,localVelocityGraph:e.localVelocityGraph,localVelocityGraph2:e.localVelocityGraph2,velocityGraph:e.velocityGraph,velocityGraph2:e.velocityGraph2,rotationSpeedGraph:e.rotationSpeedGraph,rotationSpeedGraph2:e.rotationSpeedGraph2,radialSpeedGraph:e.radialSpeedGraph,radialSpeedGraph2:e.radialSpeedGraph2,colorMap:e.colorMap,normalMap:e.normalMap,loop:e.loop,preWarm:e.preWarm,sort:e.sort,stretch:e.stretch,alignToMotion:e.alignToMotion,lighting:e.lighting,halfLambert:e.halfLambert,intensity:e.intensity,depthSoftening:e.depthSoftening,scene:this.system.app.scene,mesh:t,depthWrite:e.depthWrite,noFog:e.noFog,node:this.entity,blendType:e.blendType}),this.emitter.meshInstance.node=this.entity,this.psys=new te.Model,this.psys.graph=this.entity,this.psys.emitter=this.emitter,this.psys.meshInstances=[this.emitter.meshInstance],e.model=this.psys,this.emitter.psys=this.psys,e.autoPlay||(this.pause(),this.emitter.meshInstance.visible=!1)),e.model&&this.emitter.colorMap&&this.addModelToLayers(),this.system.app.scene.on("set:layers",this.onLayersChanged,this),this.system.app.scene.layers&&(this.system.app.scene.layers.on("add",this.onLayerAdded,this),this.system.app.scene.layers.on("remove",this.onLayerRemoved,this)),this.enabled&&this.entity.enabled&&e.depthSoftening&&this._requestDepth()},onDisable:function(){this.system.app.scene.off("set:layers",this.onLayersChanged,this),this.system.app.scene.layers&&(this.system.app.scene.layers.off("add",this.onLayerAdded,this),this.system.app.scene.layers.off("remove",this.onLayerRemoved,this)),this.data.model&&(this.removeModelFromLayers(),this.data.depthSoftening&&this._releaseDepth()),this.emitter&&(this.emitter.camera=null)},reset:function(){this.emitter&&this.emitter.reset()},stop:function(){this.emitter&&(this.emitter.loop=!1,this.emitter.resetTime(),this.emitter.addTime(0,!0))},pause:function(){this.data.paused=!0},unpause:function(){this.data.paused=!1},play:function(){this.data.paused=!1,this.emitter&&(this.emitter.meshInstance.visible=!0,this.emitter.loop=this.data.loop,this.emitter.resetTime())},isPlaying:function(){return!this.data.paused&&(!(!this.emitter||!this.emitter.loop)||Date.now()<=this.emitter.endTime)},rebuild:function(){var e=this.enabled;this.enabled=!1,this.emitter&&(this.emitter.rebuild(),this.emitter.meshInstance.node=this.entity,this.data.model.meshInstances=[this.emitter.meshInstance]),this.enabled=e},onRemove:function(){var e=this.data;e.model&&(this.entity.removeChild(e.model.getGraph()),e.model.destroy(),e.model=null),this.emitter&&(this.emitter.destroy(),this.emitter=null);for(var t=0;t<as.length;t++){var i=as[t];e[i]&&(this[i]=null)}this.off()}}),{ParticleSystemComponent:rs})),Object.assign(te,(os="enabled autoPlay numParticles lifetime rate rate2 startAngle startAngle2 loop preWarm lighting halfLambert intensity depthWrite noFog depthSoftening sort blendType stretch alignToMotion emitterShape emitterExtents emitterExtentsInner emitterRadius emitterRadiusInner initialVelocity wrap wrapBounds localSpace colorMapAsset normalMapAsset mesh meshAsset orientation particleNormal localVelocityGraph localVelocityGraph2 velocityGraph velocityGraph2 rotationSpeedGraph rotationSpeedGraph2 radialSpeedGraph radialSpeedGraph2 scaleGraph scaleGraph2 colorGraph colorGraph2 alphaGraph alphaGraph2 colorMap normalMap animTilesX animTilesY animNumFrames animSpeed animLoop layers".split(" "),((hs=function(e){te.ComponentSystem.call(this,e),this.id="particlesystem",this.description="Updates and renders particle system in the scene.",this.ComponentType=te.ParticleSystemComponent,this.DataType=te.ParticleSystemComponentData,this.schema=os,this.propertyTypes={emitterExtents:"vec3",emitterExtentsInner:"vec3",particleNormal:"vec3",wrapBounds:"vec3",localVelocityGraph:"curveset",localVelocityGraph2:"curveset",velocityGraph:"curveset",velocityGraph2:"curveset",colorGraph:"curveset",colorGraph2:"curveset",alphaGraph:"curve",alphaGraph2:"curve",rotationSpeedGraph:"curve",rotationSpeedGraph2:"curve",radialSpeedGraph:"curve",radialSpeedGraph2:"curve",scaleGraph:"curve",scaleGraph2:"curve"},this.on("beforeremove",this.onRemove,this),te.ComponentSystem.bind("update",this.onUpdate,this)}).prototype=Object.create(te.ComponentSystem.prototype)).constructor=hs,te.Component._buildAccessors(te.ParticleSystemComponent.prototype,os),Object.assign(hs.prototype,{initializeComponentData:function(e,t,i){var s={};i=[];var n,a=this.propertyTypes;for(var r in(t.mesh instanceof te.Asset||"number"==typeof t.mesh)&&(t.meshAsset=t.mesh,delete t.mesh),t)t.hasOwnProperty(r)&&(i.push(r),s[r]=t[r]),"vec3"===a[r]?"array"===te.type(s[r])&&(s[r]=new te.Vec3(s[r][0],s[r][1],s[r][2])):"curve"===a[r]?s[r]instanceof te.Curve||(n=s[r].type,s[r]=new te.Curve(s[r].keys),s[r].type=n):"curveset"!==a[r]||s[r]instanceof te.CurveSet||(n=s[r].type,s[r]=new te.CurveSet(s[r].keys),s[r].type=n),s.layers&&"array"===te.type(s.layers)&&(s.layers=s.layers.slice(0));te.ComponentSystem.prototype.initializeComponentData.call(this,e,s,i)},cloneComponent:function(e,t){for(var i=e.particlesystem.data,s=this.schema,n={},a=0,r=s.length;a<r;a++){var o=s[a],h=i[o];h instanceof te.Vec3||h instanceof te.Curve||h instanceof te.CurveSet?(h=h.clone(),n[o]=h):"layers"===o?n.layers=i.layers.slice(0):null!=h&&(n[o]=h)}return this.addComponent(t,n)},onUpdate:function(e){var t,i,s,n,a,r=this.store,o=this.app.stats.particles;for(a in r)if(r.hasOwnProperty(a)){i=(n=r[a]).entity;var h=n.data;if(h.enabled&&i.enabled){var l=h.model.emitter;if(l.meshInstance.visible){if(l.lighting){var c,d=h.layers;for(i=0;i<d.length;i++)if(n=this.app.scene.layers.getLayerById(d[i])){for(n._lightCube||(n._lightCube=new Float32Array(18)),c=n._lightCube,i=0;i<6;i++)c[3*i]=this.app.scene.ambientLight.r,c[3*i+1]=this.app.scene.ambientLight.g,c[3*i+2]=this.app.scene.ambientLight.b;var u=n._sortedLights[te.LIGHTTYPE_DIRECTIONAL];for(s=0;s<u.length;s++)for(n=0;n<6;n++){var p=Math.max(l.lightCubeDir[n].dot(u[s]._direction),0)*u[s]._intensity;c[3*n]+=u[s]._color.r*p,c[3*n+1]+=u[s]._color.g*p,c[3*n+2]+=u[s]._color.b*p}}l.constantLightCube.setValue(c)}if(!h.paused){if(l.simTime+=e,l.simTime>l.fixedTimeStep&&(t=Math.floor(l.simTime/l.fixedTimeStep),l.simTime-=t*l.fixedTimeStep),t){for(t=Math.min(t,l.maxSubSteps),i=0;i<t;i++)l.addTime(l.fixedTimeStep,!1);o._updatesPerFrame+=t,o._frameTime+=l._addTimeTime,l._addTimeTime=0}l.finishFrame()}}}}},onRemove:function(e,t){t.onRemove()}}),{ParticleSystemComponentSystem:hs})),Object.assign(te,{ParticleSystemComponentData:function(){this.rate=this.numParticles=1,this.rate2=null,this.startAngle=0,this.startAngle2=null,this.lifetime=50,this.emitterExtents=new te.Vec3,this.emitterExtentsInner=new te.Vec3,this.emitterRadiusInner=this.emitterRadius=0,this.emitterShape=te.EMITTERSHAPE_BOX,this.initialVelocity=0,this.wrapBounds=new te.Vec3,this.localSpace=!1,this.normalMapAsset=this.normalMap=this.colorMapAsset=this.colorMap=null,this.loop=!0,this.preWarm=!1,this.sort=0,this.mode=te.PARTICLEMODE_GPU,this.scene=null,this.halfLambert=this.lighting=!1,this.intensity=1,this.stretch=0,this.alignToMotion=!1,this.depthSoftening=0,this.mesh=this.meshAsset=null,this.noFog=this.depthWrite=!1,this.orientation=te.PARTICLEORIENTATION_SCREEN,this.particleNormal=new te.Vec3(0,1,0),this.animSpeed=this.animNumFrames=this.animTilesY=this.animTilesX=1,this.animLoop=!0,this.radialSpeedGraph2=this.radialSpeedGraph=this.rotationSpeedGraph2=this.rotationSpeedGraph=this.velocityGraph2=this.velocityGraph=this.localVelocityGraph2=this.localVelocityGraph=this.alphaGraph2=this.alphaGraph=this.colorGraph2=this.colorGraph=this.scaleGraph2=this.scaleGraph=null,this.blendType=te.BLEND_NORMAL,this.model=null,this.enabled=!0,this.paused=!1,this.autoPlay=!0,this.layers=[te.LAYERID_WORLD]}}),Object.assign(te,(ls=function(e,t){this._component=e,this._frame=0,this._spriteAsset=this._sprite=null,this.spriteAsset=t.spriteAsset,this.name=t.name,this.fps=t.fps||0,this.loop=t.loop||!1,this._paused=this._playing=!1,this._time=0,te.events.attach(this)},Object.assign(ls.prototype,{_onSpriteAssetAdded:function(e){this._component.system.app.assets.off("add:"+e.id,this._onSpriteAssetAdded,this),this._spriteAsset===e.id&&this._bindSpriteAsset(e)},_bindSpriteAsset:function(e){e.on("load",this._onSpriteAssetLoad,this),e.on("remove",this._onSpriteAssetRemove,this),e.resource?this._onSpriteAssetLoad(e):this._component.system.app.assets.load(e)},_unbindSpriteAsset:function(e){e.off("load",this._onSpriteAssetLoad,this),e.off("remove",this._onSpriteAssetRemove,this),e.resource&&e.resource.atlas&&this._component.system.app.assets.off("load:"+e.data.textureAtlasAsset,this._onTextureAtlasLoad,this)},_onSpriteAssetLoad:function(e){if(e.resource)if(e.resource.atlas)this.sprite=e.resource;else{e=e.data.textureAtlasAsset;var t=this._component.system.app.assets;t.off("load:"+e,this._onTextureAtlasLoad,this),t.once("load:"+e,this._onTextureAtlasLoad,this)}else this.sprite=null},_onTextureAtlasLoad:function(e){(e=this._spriteAsset)instanceof te.Asset?this._onSpriteAssetLoad(e):this._onSpriteAssetLoad(this._component.system.app.assets.get(e))},_onSpriteAssetRemove:function(e){this.sprite=null},_onSpriteMeshesChange:function(){this._component.currentClip===this&&this._component._showFrame(this.frame)},_onSpritePpuChanged:function(){this._component.currentClip===this&&this.sprite.renderMode!==te.SPRITE_RENDERMODE_SIMPLE&&this._component._showFrame(this.frame)},_update:function(e){if(0!==this.fps&&this._playing&&!this._paused&&this._sprite){var t=this._time+e*this._component.speed*(this.fps<0?-1:1),i=this.duration;e=i<t||t<0,this._setTime(t),(t=this._sprite?Math.floor(this._sprite.frameKeys.length*this._time/i):0)!==this._frame&&this._setFrame(t),e&&(this.loop?(this.fire("loop"),this._component.fire("loop",this)):(this._paused=this._playing=!1,this.fire("end"),this._component.fire("end",this)))}},_setTime:function(e){this._time=e,e=this.duration,this._time<0?this._time=this.loop?this._time%e+e:0:this._time>e&&(this._time=this.loop?this._time%e:e)},_setFrame:function(e){this._frame=this._sprite?te.math.clamp(e,0,this._sprite.frameKeys.length-1):e,this._component.currentClip===this&&this._component._showFrame(this._frame)},_destroy:function(){this._sprite&&(this.sprite=null),this._spriteAsset&&(this.spriteAsset=null)},play:function(){this._playing||(this._playing=!0,this._paused=!1,this.frame=0,this.fire("play"),this._component.fire("play",this))},pause:function(){this._playing&&!this._paused&&(this._paused=!0,this.fire("pause"),this._component.fire("pause",this))},resume:function(){this._paused&&(this._paused=!1,this.fire("resume"),this._component.fire("resume",this))},stop:function(){this._playing&&(this._paused=this._playing=!1,this.frame=this._time=0,this.fire("stop"),this._component.fire("stop",this))}}),Object.defineProperty(ls.prototype,"spriteAsset",{get:function(){return this._spriteAsset},set:function(e){var t=this._component.system.app.assets,i=e;e instanceof te.Asset&&(i=e.id),this._spriteAsset!==i&&(this._spriteAsset&&(e=t.get(this._spriteAsset))&&this._unbindSpriteAsset(e),(this._spriteAsset=i)?(i=t.get(this._spriteAsset))?this._bindSpriteAsset(i):(this.sprite=null,t.on("add:"+this._spriteAsset,this._onSpriteAssetAdded,this)):this.sprite=null)}}),Object.defineProperty(ls.prototype,"sprite",{get:function(){return this._sprite},set:function(e){var t;this._sprite&&(this._sprite.off("set:meshes",this._onSpriteMeshesChange,this),this._sprite.off("set:pixelsPerUnit",this._onSpritePpuChanged,this),this._sprite.off("set:atlas",this._onSpriteMeshesChange,this),this._sprite.atlas&&this._sprite.atlas.off("set:texture",this._onSpriteMeshesChange,this)),(this._sprite=e)&&(this._sprite.on("set:meshes",this._onSpriteMeshesChange,this),this._sprite.on("set:pixelsPerUnit",this._onSpritePpuChanged,this),this._sprite.on("set:atlas",this._onSpriteMeshesChange,this),this._sprite.atlas&&this._sprite.atlas.on("set:texture",this._onSpriteMeshesChange,this)),this._component.currentClip===this&&(e&&e.atlas?(e.atlas.texture&&((t=this._component._meshInstance)&&(t.setParameter("texture_emissiveMap",e.atlas.texture),t.setParameter("texture_opacityMap",e.atlas.texture)),this._component.enabled&&this._component.entity.enabled&&this._component._showModel()),this.time&&this.fps?this.time=this.time:this.frame=this.frame):((t=this._component._meshInstance)&&(t.deleteParameter("texture_emissiveMap"),t.deleteParameter("texture_opacityMap")),this._component._hideModel()))}}),Object.defineProperty(ls.prototype,"frame",{get:function(){return this._frame},set:function(e){this._setFrame(e),this._setTime(this._frame/(this.fps||Number.MIN_VALUE))}}),Object.defineProperty(ls.prototype,"isPlaying",{get:function(){return this._playing}}),Object.defineProperty(ls.prototype,"isPaused",{get:function(){return this._paused}}),Object.defineProperty(ls.prototype,"duration",{get:function(){return this._sprite?this._sprite.frameKeys.length/Math.abs(this.fps||Number.MIN_VALUE):0}}),Object.defineProperty(ls.prototype,"time",{get:function(){return this._time},set:function(e){this._setTime(e),this.frame=this._sprite?Math.min(this._sprite.frameKeys.length-1,Math.floor(this._time*Math.abs(this.fps))):0}}),{SpriteAnimationClip:ls})),Object.assign(te,function(){te.SPRITETYPE_SIMPLE="simple",te.SPRITETYPE_ANIMATED="animated";var e=function(e,t){te.Component.call(this,e,t),this._type=te.SPRITETYPE_SIMPLE,this._material=e.defaultMaterial,this._color=new te.Color(1,1,1,1),this._colorUniform=new Float32Array(3),this._speed=1,this._flipY=this._flipX=!1,this._height=this._width=1,this._drawOrder=0,this._layers=[te.LAYERID_WORLD],this._outerScale=new te.Vec2(1,1),this._outerScaleUniform=new Float32Array(2),this._innerOffset=new te.Vec4,this._innerOffsetUniform=new Float32Array(4),this._atlasRect=new te.Vec4,this._atlasRectUniform=new Float32Array(4),this._batchGroupId=-1,this._batchGroup=null,this._node=new te.GraphNode,this._model=new te.Model,this._model.graph=this._node,this._meshInstance=null,t.addChild(this._model.graph),this._model._entity=t,this._updateAabbFunc=this._updateAabb.bind(this),this._addedModel=!1,this._autoPlayClip=null,this._clips={},this._currentClip=this._defaultClip=new te.SpriteAnimationClip(this,{name:this.entity.name,fps:0,loop:!1,spriteAsset:null})};return(e.prototype=Object.create(te.Component.prototype)).constructor=e,Object.assign(e.prototype,{onEnable:function(){var e=this.system.app,t=e.scene;t.on("set:layers",this._onLayersChanged,this),t.layers&&(t.layers.on("add",this._onLayerAdded,this),t.layers.on("remove",this._onLayerRemoved,this)),this._showModel(),this._autoPlayClip&&this._tryAutoPlay(),0<=this._batchGroupId&&e.batcher.insert(te.BatchGroup.SPRITE,this._batchGroupId,this.entity)},onDisable:function(){var e=this.system.app,t=e.scene;t.off("set:layers",this._onLayersChanged,this),t.layers&&(t.layers.off("add",this._onLayerAdded,this),t.layers.off("remove",this._onLayerRemoved,this)),this.stop(),this._hideModel(),0<=this._batchGroupId&&e.batcher.remove(te.BatchGroup.SPRITE,this._batchGroupId,this.entity)},onDestroy:function(){for(var e in this._currentClip=null,this._defaultClip&&(this._defaultClip._destroy(),this._defaultClip=null),this._clips)this._clips[e]._destroy();this._clips=null,this._hideModel(),this._model=null,this._node&&(this._node.parent&&this._node.parent.removeChild(this._node),this._node=null),this._meshInstance&&(this._meshInstance.material=null,this._meshInstance=this._meshInstance.mesh=null)},_showModel:function(){if(!this._addedModel&&this._meshInstance){var e,t,i=[this._meshInstance];for(e=0,t=this._layers.length;e<t;e++){var s=this.system.app.scene.layers.getLayerById(this._layers[e]);s&&s.addMeshInstances(i)}this._addedModel=!0}},_hideModel:function(){if(this._addedModel&&this._meshInstance){var e,t,i=[this._meshInstance];for(e=0,t=this._layers.length;e<t;e++){var s=this.system.app.scene.layers.getLayerById(this._layers[e]);s&&s.removeMeshInstances(i)}this._addedModel=!1}},_showFrame:function(e){if(this.sprite){var t=this.sprite.meshes[e];if(t){var i=this.system.defaultMaterial;this.sprite.renderMode===te.SPRITE_RENDERMODE_SLICED?i=this.system.default9SlicedMaterialSlicedMode:this.sprite.renderMode===te.SPRITE_RENDERMODE_TILED&&(i=this.system.default9SlicedMaterialTiledMode),this._meshInstance||(this._meshInstance=new te.MeshInstance(this._node,t,this._material),this._meshInstance.castShadow=!1,this._meshInstance.receiveShadow=!1,this._meshInstance.drawOrder=this._drawOrder,this._model.meshInstances.push(this._meshInstance),this._colorUniform[0]=this._color.r,this._colorUniform[1]=this._color.g,this._colorUniform[2]=this._color.b,this._meshInstance.setParameter("material_emissive",this._colorUniform),this._meshInstance.setParameter("material_opacity",this._color.a),this.enabled&&this.entity.enabled&&this._showModel()),this._meshInstance.material!==i&&(this._meshInstance.material=i),this._meshInstance.mesh!==t&&(this._meshInstance.mesh=t,this._meshInstance.visible=!0,this._meshInstance._aabbVer=-1),this.sprite.atlas&&this.sprite.atlas.texture?(this._meshInstance.setParameter("texture_emissiveMap",this.sprite.atlas.texture),this._meshInstance.setParameter("texture_opacityMap",this.sprite.atlas.texture)):(this._meshInstance.deleteParameter("texture_emissiveMap"),this._meshInstance.deleteParameter("texture_opacityMap")),!this.sprite.atlas||this.sprite.renderMode!==te.SPRITE_RENDERMODE_SLICED&&this.sprite.renderMode!==te.SPRITE_RENDERMODE_TILED?this._meshInstance._updateAabbFunc=null:(this._meshInstance._updateAabbFunc=this._updateAabbFunc,(e=this.sprite.atlas.frames[this.sprite.frameKeys[e]])?(t=2/e.rect.z,i=2/e.rect.w,this._innerOffset.set(e.border.x*t,e.border.y*i,e.border.z*t,e.border.w*i),t=this.sprite.atlas.texture,this._atlasRect.set(e.rect.x/t.width,e.rect.y/t.height,e.rect.z/t.width,e.rect.w/t.height)):this._innerOffset.set(0,0,0,0),this._innerOffsetUniform[0]=this._innerOffset.x,this._innerOffsetUniform[1]=this._innerOffset.y,this._innerOffsetUniform[2]=this._innerOffset.z,this._innerOffsetUniform[3]=this._innerOffset.w,this._meshInstance.setParameter("innerOffset",this._innerOffsetUniform),this._atlasRectUniform[0]=this._atlasRect.x,this._atlasRectUniform[1]=this._atlasRect.y,this._atlasRectUniform[2]=this._atlasRect.z,this._atlasRectUniform[3]=this._atlasRect.w,this._meshInstance.setParameter("atlasRect",this._atlasRectUniform)),this._updateTransform()}else this._meshInstance&&(this._meshInstance.mesh=null,this._meshInstance.visible=!1)}},_updateTransform:function(){var e=this.flipX?-1:1,t=this.flipY?-1:1,i=0,s=0;if(this.sprite&&(this.sprite.renderMode===te.SPRITE_RENDERMODE_SLICED||this.sprite.renderMode===te.SPRITE_RENDERMODE_TILED)){var n=1,a=1;if(this.sprite.atlas){var r=this.sprite.atlas.frames[this.sprite.frameKeys[this.frame]];r&&(n=r.rect.z,a=r.rect.w,i=(.5-r.pivot.x)*this._width,s=(.5-r.pivot.y)*this._height)}n/=this.sprite.pixelsPerUnit,a/=this.sprite.pixelsPerUnit,this._outerScale.set(Math.max(this._width,this._innerOffset.x*n),Math.max(this._height,this._innerOffset.y*a)),t*=a,this._outerScale.x/=n,this._outerScale.y/=a,e=e*n*te.math.clamp(this._width/(this._innerOffset.x*n),1e-4,1),t*=te.math.clamp(this._height/(this._innerOffset.y*a),1e-4,1),this._meshInstance&&(this._outerScaleUniform[0]=this._outerScale.x,this._outerScaleUniform[1]=this._outerScale.y,this._meshInstance.setParameter("outerScale",this._outerScaleUniform,4294967295))}this._node.setLocalScale(e,t,1),this._node.setLocalPosition(i,s,0)},_updateAabb:function(e){return e.center.set(0,0,0),e.halfExtents.set(.5*this._outerScale.x,.5*this._outerScale.y,.001),e.setFromTransformedAabb(e,this._node.getWorldTransform()),e},_tryAutoPlay:function(){if(this._autoPlayClip&&this.type===te.SPRITETYPE_ANIMATED){var e=this._clips[this._autoPlayClip];!e||e.isPlaying||this._currentClip&&this._currentClip.isPlaying||this.enabled&&this.entity.enabled&&this.play(e.name)}},_onLayersChanged:function(e,t){e.off("add",this.onLayerAdded,this),e.off("remove",this.onLayerRemoved,this),t.on("add",this.onLayerAdded,this),t.on("remove",this.onLayerRemoved,this),this.enabled&&this.entity.enabled&&this._showModel()},_onLayerAdded:function(e){this.layers.indexOf(e.id)<0||this._addedModel&&this.enabled&&this.entity.enabled&&this._meshInstance&&e.addMeshInstances([this._meshInstance])},_onLayerRemoved:function(e){this._meshInstance&&(this.layers.indexOf(e.id)<0||e.removeMeshInstances([this._meshInstance]))},removeModelFromLayers:function(){for(var e,t=0;t<this.layers.length;t++)(e=this.system.app.scene.layers.getLayerById(this.layers[t]))&&e.removeMeshInstances([this._meshInstance])},addClip:function(e){var t=new te.SpriteAnimationClip(this,{name:e.name,fps:e.fps,loop:e.loop,spriteAsset:e.spriteAsset});return(this._clips[e.name]=t).name&&t.name===this._autoPlayClip&&this._tryAutoPlay(),t},removeClip:function(e){delete this._clips[e]},clip:function(e){return this._clips[e]},play:function(e){var t=this._clips[e],i=this._currentClip;return i&&i!==t&&(i._playing=!1),(this._currentClip=t)?(this._currentClip=t,this._currentClip.play()):Ie("Trying to play sprite animation "+e+" which does not exist."),t},pause:function(){this._currentClip!==this._defaultClip&&this._currentClip.isPlaying&&this._currentClip.pause()},resume:function(){this._currentClip!==this._defaultClip&&this._currentClip.isPaused&&this._currentClip.resume()},stop:function(){this._currentClip!==this._defaultClip&&this._currentClip.stop()}}),Object.defineProperty(e.prototype,"type",{get:function(){return this._type},set:function(e){this._type!==e&&(this._type=e,this._type===te.SPRITETYPE_SIMPLE?(this.stop(),this._currentClip=this._defaultClip,this.enabled&&this.entity.enabled&&(this._currentClip.frame=this.frame,this._currentClip.sprite?this._showModel():this._hideModel())):this._type===te.SPRITETYPE_ANIMATED&&(this.stop(),this._autoPlayClip&&this._tryAutoPlay(),this._currentClip&&this._currentClip.isPlaying&&this.enabled&&this.entity.enabled?this._showModel():this._hideModel()))}}),Object.defineProperty(e.prototype,"frame",{get:function(){return this._currentClip.frame},set:function(e){this._currentClip.frame=e}}),Object.defineProperty(e.prototype,"spriteAsset",{get:function(){return this._defaultClip._spriteAsset},set:function(e){this._defaultClip.spriteAsset=e}}),Object.defineProperty(e.prototype,"sprite",{get:function(){return this._currentClip.sprite},set:function(e){this._currentClip.sprite=e}}),Object.defineProperty(e.prototype,"material",{get:function(){return this._material},set:function(e){this._material=e,this._meshInstance&&(this._meshInstance.material=e)}}),Object.defineProperty(e.prototype,"color",{get:function(){return this._color},set:function(e){this._color.r=e.r,this._color.g=e.g,this._color.b=e.b,this._meshInstance&&(this._colorUniform[0]=this._color.r,this._colorUniform[1]=this._color.g,this._colorUniform[2]=this._color.b,this._meshInstance.setParameter("material_emissive",this._colorUniform))}}),Object.defineProperty(e.prototype,"opacity",{get:function(){return this._color.a},set:function(e){this._color.a=e,this._meshInstance&&this._meshInstance.setParameter("material_opacity",e)}}),Object.defineProperty(e.prototype,"clips",{get:function(){return this._clips},set:function(e){var t,i;if(e){for(t in this._clips){var s=!1;for(i in e)if(e[i].name===t){s=!0,this._clips[t].fps=e[i].fps,this._clips[t].loop=e[i].loop,e[i].hasOwnProperty("sprite")?this._clips[t].sprite=e[i].sprite:e[i].hasOwnProperty("spriteAsset")&&(this._clips[t].spriteAsset=e[i].spriteAsset);break}s||this.removeClip(t)}for(i in e)this._clips[e[i].name]||this.addClip(e[i]);this._autoPlayClip&&this._tryAutoPlay(),this._currentClip&&this._currentClip.sprite||this._hideModel()}else for(t in this._clips)this.removeClip(t)}}),Object.defineProperty(e.prototype,"currentClip",{get:function(){return this._currentClip}}),Object.defineProperty(e.prototype,"speed",{get:function(){return this._speed},set:function(e){this._speed=e}}),Object.defineProperty(e.prototype,"flipX",{get:function(){return this._flipX},set:function(e){this._flipX!==e&&(this._flipX=e,this._updateTransform())}}),Object.defineProperty(e.prototype,"flipY",{get:function(){return this._flipY},set:function(e){this._flipY!==e&&(this._flipY=e,this._updateTransform())}}),Object.defineProperty(e.prototype,"width",{get:function(){return this._width},set:function(e){e!==this._width&&(this._width=e,this._outerScale.x=this._width,!this.sprite||this.sprite.renderMode!==te.SPRITE_RENDERMODE_TILED&&this.sprite.renderMode!==te.SPRITE_RENDERMODE_SLICED||this._updateTransform())}}),Object.defineProperty(e.prototype,"height",{get:function(){return this._height},set:function(e){e!==this._height&&(this._height=e,this._outerScale.y=this.height,!this.sprite||this.sprite.renderMode!==te.SPRITE_RENDERMODE_TILED&&this.sprite.renderMode!==te.SPRITE_RENDERMODE_SLICED||this._updateTransform())}}),Object.defineProperty(e.prototype,"batchGroupId",{get:function(){return this._batchGroupId},set:function(e){if(this._batchGroupId!==e){var t=this._batchGroupId;this._batchGroupId=e,this.entity.enabled&&0<=t&&this.system.app.batcher.remove(te.BatchGroup.SPRITE,t,this.entity),this.entity.enabled&&0<=e?this.system.app.batcher.insert(te.BatchGroup.SPRITE,e,this.entity):0<=t&&this._currentClip&&this._currentClip.sprite&&this.enabled&&this.entity.enabled&&this._showModel()}}}),Object.defineProperty(e.prototype,"autoPlayClip",{get:function(){return this._autoPlayClip},set:function(e){this._autoPlayClip=e instanceof te.SpriteAnimationClip?e.name:e,this._tryAutoPlay()}}),Object.defineProperty(e.prototype,"drawOrder",{get:function(){return this._drawOrder},set:function(e){this._drawOrder=e,this._meshInstance&&(this._meshInstance.drawOrder=e)}}),Object.defineProperty(e.prototype,"layers",{get:function(){return this._layers},set:function(e){this._addedModel&&this._hideModel(),this._layers=e,this._meshInstance&&this.enabled&&this.entity.enabled&&this._showModel()}}),Object.defineProperty(e.prototype,"aabb",{get:function(){return this._meshInstance?this._meshInstance.aabb:null}}),{SpriteComponent:e}}()),Object.assign(te,(cs=["enabled"],((ds=function(e){te.ComponentSystem.call(this,e),this.id="sprite",this.app=e,this.ComponentType=te.SpriteComponent,this.DataType=te.SpriteComponentData,this.schema=cs,this._defaultTexture=new te.Texture(e.graphicsDevice,{width:1,height:1,format:te.PIXELFORMAT_R8_G8_B8_A8}),e=this._defaultTexture.lock();var t=new Uint8Array(4);t[0]=255,t[1]=255,t[2]=255,t[3]=255,e.set(t),this._defaultTexture.name="sprite",this._defaultTexture.unlock(),this.defaultMaterial=new te.StandardMaterial,this.defaultMaterial.diffuse=new te.Color(0,0,0,1),this.defaultMaterial.emissive=new te.Color(.5,.5,.5,1),this.defaultMaterial.emissiveMap=this._defaultTexture,this.defaultMaterial.emissiveMapTint=!0,this.defaultMaterial.opacityMap=this._defaultTexture,this.defaultMaterial.opacityMapChannel="a",this.defaultMaterial.opacityTint=!0,this.defaultMaterial.opacity=0,this.defaultMaterial.useLighting=!1,this.defaultMaterial.useGammaTonemap=!1,this.defaultMaterial.useFog=!1,this.defaultMaterial.useSkybox=!1,this.defaultMaterial.blendType=te.BLEND_PREMULTIPLIED,this.defaultMaterial.depthWrite=!1,this.defaultMaterial.pixelSnap=!1,this.defaultMaterial.cull=te.CULLFACE_NONE,this.defaultMaterial.update(),this.default9SlicedMaterialSlicedMode=this.defaultMaterial.clone(),this.default9SlicedMaterialSlicedMode.nineSlicedMode=te.SPRITE_RENDERMODE_SLICED,this.default9SlicedMaterialSlicedMode.update(),this.default9SlicedMaterialTiledMode=this.defaultMaterial.clone(),this.default9SlicedMaterialTiledMode.nineSlicedMode=te.SPRITE_RENDERMODE_TILED,this.default9SlicedMaterialTiledMode.update(),te.ComponentSystem.bind("update",this.onUpdate,this),this.on("beforeremove",this.onBeforeRemove,this)}).prototype=Object.create(te.ComponentSystem.prototype)).constructor=ds,te.Component._buildAccessors(te.SpriteComponent.prototype,cs),Object.assign(ds.prototype,{destroy:function(){this._defaultTexture.destroy(),this._defaultTexture=null},initializeComponentData:function(e,t,i){if(void 0!==t.enabled&&(e.enabled=t.enabled),e.type=t.type,t.layers&&"array"===te.type(t.layers)&&(e.layers=t.layers.slice(0)),void 0!==t.drawOrder&&(e.drawOrder=t.drawOrder),void 0!==t.color&&(t.color instanceof te.Color?e.color.set(t.color.r,t.color.g,t.color.b,void 0!==t.opacity?t.opacity:1):e.color.set(t.color[0],t.color[1],t.color[2],void 0!==t.opacity?t.opacity:1),e.color=e.color),void 0!==t.opacity&&(e.opacity=t.opacity),void 0!==t.flipX&&(e.flipX=t.flipX),void 0!==t.flipY&&(e.flipY=t.flipY),void 0!==t.width&&(e.width=t.width),void 0!==t.height&&(e.height=t.height),void 0!==t.spriteAsset&&(e.spriteAsset=t.spriteAsset),t.sprite&&(e.sprite=t.sprite),void 0!==t.frame&&(e.frame=t.frame),t.clips)for(var s in t.clips)e.addClip(t.clips[s]);void 0!==t.speed&&(e.speed=t.speed),t.autoPlayClip&&(e.autoPlayClip=t.autoPlayClip),e.batchGroupId=void 0===t.batchGroupId||null===t.batchGroupId?-1:t.batchGroupId,te.ComponentSystem.prototype.initializeComponentData.call(this,e,t,i)},cloneComponent:function(e,t){var i=e.sprite;return this.addComponent(t,{enabled:i.enabled,type:i.type,spriteAsset:i.spriteAsset,sprite:i.sprite,frame:i.frame,color:i.color.clone(),opacity:i.opacity,flipX:i.flipX,flipY:i.flipY,speed:i.speed,clips:i.clips,autoPlayClip:i.autoPlayClip,batchGroupId:i.batchGroupId,drawOrder:i.drawOrder,layers:i.layers.slice(0)})},onUpdate:function(e){var t,i=this.store;for(t in i)if(i.hasOwnProperty(t)){var s=i[t];s.data.enabled&&s.entity.enabled&&(s=s.entity.sprite)._currentClip&&s._currentClip._update(e)}},onBeforeRemove:function(e,t){t.onDestroy()}}),{SpriteComponentSystem:ds})),Object.assign(te,{SpriteComponentData:function(){this.enabled=!0}}),Object.assign(te,function(){te.SCALEMODE_NONE="none",te.SCALEMODE_BLEND="blend";var e=function(e,t){te.Component.call(this,e,t),this._resolution=new te.Vec2(640,320),this._referenceResolution=new te.Vec2(640,320),this._scaleMode=te.SCALEMODE_NONE,this.scale=1,this._scaleBlend=.5,this._priority=0,this.cull=this._screenSpace=!1,this._screenMatrix=new te.Mat4,e.app.graphicsDevice.on("resizecanvas",this._onResize,this)};(e.prototype=Object.create(te.Component.prototype)).constructor=e;var i=new te.Mat4;return Object.assign(e.prototype,{syncDrawOrder:function(){this.system.queueDrawOrderSync(this.entity.getGuid(),this._processDrawOrderSync,this)},_recurseDrawOrderSync:function(e,t){if(!(e instanceof te.Entity))return t;if(e.element){var i=e.element.drawOrder;e.element.drawOrder=t++,0<=e.element._batchGroupId&&i!=e.element.drawOrder&&this.system.app.batcher.markGroupDirty(e.element._batchGroupId)}i=e.children;for(var s=0;s<i.length;s++)t=this._recurseDrawOrderSync(i[s],t);return t},_processDrawOrderSync:function(){this._recurseDrawOrderSync(this.entity,1),this.fire("syncdraworder")},_calcProjectionMatrix:function(){var e=this._resolution.x/this.scale,t=this._resolution.y/this.scale;this._screenMatrix.setOrtho(0,e,-t,0,1,-1),this._screenSpace||(i.setScale(.5*e,.5*t,1),this._screenMatrix.mul2(i,this._screenMatrix))},_updateScale:function(){this.scale=this._calcScale(this._resolution,this.referenceResolution)},_calcScale:function(e,t){return Math.pow(2,Math.log2(e.x/t.x)*(1-this._scaleBlend)+Math.log2(e.y/t.y)*this._scaleBlend)},_onResize:function(e,t){this._screenSpace&&(this._resolution.set(e,t),this.resolution=this._resolution)},onRemove:function(){this.system.app.graphicsDevice.off("resizecanvas",this._onResize,this),this.fire("remove"),this.off()}}),Object.defineProperty(e.prototype,"resolution",{set:function(e){this._screenSpace?this._resolution.set(this.system.app.graphicsDevice.width,this.system.app.graphicsDevice.height):this._resolution.set(e.x,e.y),this._updateScale(),this._calcProjectionMatrix(),this.entity._dirtyLocal||this.entity._dirtifyLocal(),this.fire("set:resolution",this._resolution)},get:function(){return this._resolution}}),Object.defineProperty(e.prototype,"referenceResolution",{set:function(e){this._referenceResolution.set(e.x,e.y),this._updateScale(),this._calcProjectionMatrix(),this.entity._dirtyLocal||this.entity._dirtifyLocal(),this.fire("set:referenceresolution",this._resolution)},get:function(){return this._scaleMode===te.SCALEMODE_NONE?this._resolution:this._referenceResolution}}),Object.defineProperty(e.prototype,"screenSpace",{set:function(e){(this._screenSpace=e)&&this._resolution.set(this.system.app.graphicsDevice.width,this.system.app.graphicsDevice.height),this.resolution=this._resolution,this.entity._dirtyLocal||this.entity._dirtifyLocal(),this.fire("set:screenspace",this._screenSpace)},get:function(){return this._screenSpace}}),Object.defineProperty(e.prototype,"scaleMode",{set:function(e){e!==te.SCALEMODE_NONE&&e!==te.SCALEMODE_BLEND&&(e=te.SCALEMODE_NONE),this._screenSpace||e===te.SCALEMODE_NONE||(e=te.SCALEMODE_NONE),this._scaleMode=e,this.resolution=this._resolution,this.fire("set:scalemode",this._scaleMode)},get:function(){return this._scaleMode}}),Object.defineProperty(e.prototype,"scaleBlend",{set:function(e){this._scaleBlend=e,this._updateScale(),this._calcProjectionMatrix(),this.entity._dirtyLocal||this.entity._dirtifyLocal(),this.fire("set:scaleblend",this._scaleBlend)},get:function(){return this._scaleBlend}}),Object.defineProperty(e.prototype,"priority",{get:function(){return this._priority},set:function(e){255<e&&(e=255),this._priority=e}}),{ScreenComponent:e}}()),Object.assign(te,(us=["enabled"],((ps=function(e){te.ComponentSystem.call(this,e),this.id="screen",this.app=e,this.ComponentType=te.ScreenComponent,this.DataType=te.ScreenComponentData,this.schema=us,this.windowResolution=new te.Vec2,this._drawOrderSyncQueue=new te.IndexedList,this.app.graphicsDevice.on("resizecanvas",this._onResize,this),te.ComponentSystem.bind("update",this._onUpdate,this),this.on("beforeremove",this.onRemoveComponent,this)}).prototype=Object.create(te.ComponentSystem.prototype)).constructor=ps,te.Component._buildAccessors(te.ScreenComponent.prototype,us),Object.assign(ps.prototype,{initializeComponentData:function(e,t,i){void 0!==t.priority&&(e.priority=t.priority),void 0!==t.screenSpace&&(e.screenSpace=t.screenSpace),e.cull=e.screenSpace,void 0!==t.scaleMode&&(e.scaleMode=t.scaleMode),void 0!==t.scaleBlend&&(e.scaleBlend=t.scaleBlend),void 0!==t.resolution&&(t.resolution instanceof te.Vec2?e._resolution.copy(t.resolution):e._resolution.set(t.resolution[0],t.resolution[1]),e.resolution=e._resolution),void 0!==t.referenceResolution&&(t.referenceResolution instanceof te.Vec2?e._referenceResolution.copy(t.referenceResolution):e._referenceResolution.set(t.referenceResolution[0],t.referenceResolution[1]),e.referenceResolution=e._referenceResolution),e.syncDrawOrder(),te.ComponentSystem.prototype.initializeComponentData.call(this,e,t,i)},destroy:function(){this.off(),this.app.graphicsDevice.off("resizecanvas",this._onResize,this)},_onUpdate:function(e){var t,i=this.store;for(t in i)i[t].entity.screen.update&&i[t].entity.screen.update(e)},_onResize:function(e,t){this.windowResolution.x=e,this.windowResolution.y=t},cloneComponent:function(e,t){var i=e.screen;return this.addComponent(t,{enabled:i.enabled,screenSpace:i.screenSpace,scaleMode:i.scaleMode,resolution:i.resolution.clone(),referenceResolution:i.referenceResolution.clone()})},onRemoveComponent:function(e,t){t.onRemove()},processDrawOrderSyncQueue:function(){for(var e=this._drawOrderSyncQueue.list(),t=0;t<e.length;t++){var i=e[t];i.callback.call(i.scope)}this._drawOrderSyncQueue.clear()},queueDrawOrderSync:function(e,t,i){this._drawOrderSyncQueue.list().length||this.app.once("prerender",this.processDrawOrderSyncQueue,this),this._drawOrderSyncQueue.has(e)||this._drawOrderSyncQueue.push(e,{callback:t,scope:i})}}),{ScreenComponentSystem:ps})),Object.assign(te,{ScreenComponentData:function(){this.enabled=!0}}),Object.assign(te,function(){te.ELEMENTTYPE_GROUP="group",te.ELEMENTTYPE_IMAGE="image",te.ELEMENTTYPE_TEXT="text";var s,n,r=new te.Vec3,o=new te.Vec3,h=new te.Mat4,l=new te.Mat4,c=new te.Mat4,i=new te.Mat4,e=function(e,t){te.Component.call(this,e,t),this._beingInitialized=!1,this._anchor=new te.Vec4,this._localAnchor=new te.Vec4,this._pivot=new te.Vec2,this._height=this._calculatedHeight=this._width=this._calculatedWidth=32,this._margin=new te.Vec4(0,0,-32,-32),this._modelTransform=new te.Mat4,this._screenToWorld=new te.Mat4,this._anchorTransform=new te.Mat4,this._anchorDirty=!0,this._parentWorldTransform=new te.Mat4,this._screenTransform=new te.Mat4,this._screenCorners=[new te.Vec3,new te.Vec3,new te.Vec3,new te.Vec3],this._canvasCorners=[new te.Vec2,new te.Vec2,new te.Vec2,new te.Vec2],this._worldCorners=[new te.Vec3,new te.Vec3,new te.Vec3,new te.Vec3],this._worldCornersDirty=this._canvasCornersDirty=this._cornersDirty=!0,this.entity.on("insert",this._onInsert,this),this._patch(),this.screen=null,this._type=te.ELEMENTTYPE_GROUP,this._group=this._text=this._image=null,this._drawOrder=0,this._useInput=!1,this._layers=[te.LAYERID_UI],this._addedModels=[],this._batchGroupId=-1,this._offsetReadAt=0,this._maskOffset=.5,this._maskedBy=null};(e.prototype=Object.create(te.Component.prototype)).constructor=e,Object.assign(e.prototype,{_patch:function(){this.entity._sync=this._sync,this.entity.setPosition=this._setPosition,this.entity.setLocalPosition=this._setLocalPosition},_unpatch:function(){this.entity._sync=te.Entity.prototype._sync,this.entity.setPosition=te.Entity.prototype.setPosition,this.entity.setLocalPosition=te.Entity.prototype.setLocalPosition},_setPosition:(s=new te.Vec3,n=new te.Mat4,function(e,t,i){if(!this.element.screen)return te.Entity.prototype.setPosition.call(this,e,t,i);e instanceof te.Vec3?s.copy(e):s.set(e,t,i),this.getWorldTransform(),n.copy(this.element._screenToWorld).invert(),n.transformPoint(s,this.localPosition),this._dirtyLocal||this._dirtifyLocal()}),_setLocalPosition:function(e,t,i){e instanceof te.Vec3?this.localPosition.copy(e):this.localPosition.set(e,t,i),e=this.element,t=this.localPosition,i=e._pivot,e._margin.x=t.x-e._calculatedWidth*i.x,e._margin.z=e._localAnchor.z-e._localAnchor.x-e._calculatedWidth-e._margin.x,e._margin.y=t.y-e._calculatedHeight*i.y,e._margin.w=e._localAnchor.w-e._localAnchor.y-e._calculatedHeight-e._margin.y,this._dirtyLocal||this._dirtifyLocal()},_sync:function(){var e=this.element,t=e.screen;if(t){if(e._anchorDirty){var i,s,n=0,a=1;this._parent&&this._parent.element?(i=this._parent.element.calculatedWidth,s=this._parent.element.calculatedHeight,n=this._parent.element.pivot.x,a=this._parent.element.pivot.y):(i=(s=t.screen.resolution).x/t.screen.scale,s=s.y/t.screen.scale),e._anchorTransform.setTranslate(i*(e.anchor.x-n),-s*(a-e.anchor.y),0),e._anchorDirty=!1,e._calculateLocalAnchors()}e._sizeDirty&&e._calculateSize(!1,!1)}if(this._dirtyLocal&&(this.localTransform.setTRS(this.localPosition,this.localRotation,this.localScale),i=this.localPosition,n=e._pivot,e._margin.x=i.x-e._calculatedWidth*n.x,e._margin.z=e._localAnchor.z-e._localAnchor.x-e._calculatedWidth-e._margin.x,e._margin.y=i.y-e._calculatedHeight*n.y,e._margin.w=e._localAnchor.w-e._localAnchor.y-e._calculatedHeight-e._margin.y,this._dirtyLocal=!1),!t)return this._dirtyWorld&&(e._cornersDirty=!0,e._canvasCornersDirty=!0,e._worldCornersDirty=!0),te.Entity.prototype._sync.call(this);this._dirtyWorld&&(null===this._parent?this.worldTransform.copy(this.localTransform):(this._parent.element?e._screenToWorld.mul2(this._parent.element._modelTransform,e._anchorTransform):e._screenToWorld.copy(e._anchorTransform),e._modelTransform.mul2(e._screenToWorld,this.localTransform),t?(e._screenToWorld.mul2(t.screen._screenMatrix,e._screenToWorld),t.screen.screenSpace||e._screenToWorld.mul2(t.worldTransform,e._screenToWorld),this.worldTransform.mul2(e._screenToWorld,this.localTransform),(i=e._parentWorldTransform).setIdentity(),(n=this._parent)&&n.element&&n!==t&&(h.setTRS(te.Vec3.ZERO,n.getLocalRotation(),n.getLocalScale()),i.mul2(n.element._parentWorldTransform,h)),r.set(0,0,this.localPosition.z),o.set(e._absLeft+e._pivot.x*e.calculatedWidth,e._absBottom+e._pivot.y*e.calculatedHeight,0),h.setTranslate(-o.x,-o.y,-o.z),l.setTRS(r,this.getLocalRotation(),this.getLocalScale()),c.setTranslate(o.x,o.y,o.z),e._screenTransform.mul2(e._parentWorldTransform,c).mul(l).mul(h),e._cornersDirty=!0,e._canvasCornersDirty=!0,e._worldCornersDirty=!0):this.worldTransform.copy(e._modelTransform)),this._dirtyWorld=!1)},_onInsert:function(e){e=this._parseUpToScreen(),this.entity._dirtifyWorld(),this._updateScreen(e.screen),this._dirtifyMask()},_dirtifyMask:function(){for(var e=this.entity;e;){var t=e.parent;if((null===t||t.screen)&&e.element){this.system._prerender&&this.system._prerender.length||(this.system._prerender=[],this.system.app.once("prerender",this._onPrerender,this));var i=this.system._prerender.indexOf(this.entity);0<=i&&this.system._prerender.splice(i,1),this.system._prerender.indexOf(e)<0&&this.system._prerender.push(e)}e=t}},_onPrerender:function(){for(var e=0;e<this.system._prerender.length;e++){var t=this.system._prerender[e];t.element&&t.element.syncMask(1)}this.system._prerender.length=0},_bindScreen:function(e){e.on("set:resolution",this._onScreenResize,this),e.on("set:referenceresolution",this._onScreenResize,this),e.on("set:scaleblend",this._onScreenResize,this),e.on("set:screenspace",this._onScreenSpaceChange,this),e.on("remove",this._onScreenRemove,this)},_unbindScreen:function(e){e.off("set:resolution",this._onScreenResize,this),e.off("set:referenceresolution",this._onScreenResize,this),e.off("set:scaleblend",this._onScreenResize,this),e.off("set:screenspace",this._onScreenSpaceChange,this),e.off("remove",this._onScreenRemove,this)},_updateScreen:function(e){this.screen&&this.screen!==e&&this._unbindScreen(this.screen.screen);var t=this.screen;(this.screen=e)&&this._bindScreen(this.screen.screen),this._calculateSize(this._hasSplitAnchorsX,this._hasSplitAnchorsY),this.fire("set:screen",this.screen,t),this._anchorDirty=!0;for(var i=0,s=(t=this.entity.children).length;i<s;i++)t[i].element&&t[i].element._updateScreen(e);this.screen&&this.screen.screen.syncDrawOrder()},syncMask:function(e){var t=this._parseUpToScreen();this._updateMask(t.mask,e)},_setMaskedBy:function(e){var t=this._image||this._text;if(e){var i=new te.StencilParameters({ref:e.element._image._maskRef,func:te.FUNC_EQUAL});t&&t._setStencil&&t._setStencil(i),this._maskedBy=e}else t&&t._setStencil&&t._setStencil(null),this._maskedBy=null},_updateMask:function(e,t){var i,s,n;for(e?(this._setMaskedBy(e),this.mask&&(i=new te.StencilParameters({ref:e.element._image._maskRef,func:te.FUNC_EQUAL,zpass:te.STENCILOP_INCREMENT}),this._image._setStencil(i),this._image._maskRef=t,t++,e=this.entity)):(this._setMaskedBy(null),this.mask&&(i=new te.StencilParameters({ref:t,func:te.FUNC_ALWAYS,zpass:te.STENCILOP_REPLACE}),this._image._setStencil(i),this._image._maskRef=t,t++,e=this.entity)),i=0,s=(n=this.entity.children).length;i<s;i++)n[i].element&&n[i].element._updateMask(e,t)},_parseUpToScreen:function(){for(var e={screen:null,mask:null},t=this.entity._parent;t&&!t.screen;)t.element&&t.element.mask&&!e.mask&&(e.mask=t),t=t.parent;return t&&t.screen&&(e.screen=t),e},_onScreenResize:function(e){this._worldCornersDirty=this._cornersDirty=this._anchorDirty=!0,this._calculateSize(this._hasSplitAnchorsX,this._hasSplitAnchorsY),this.fire("screen:set:resolution",e)},_onScreenSpaceChange:function(){this.fire("screen:set:screenspace",this.screen.screen.screenSpace)},_onScreenRemove:function(){this.screen&&!this.screen._destroying&&this._updateScreen(null)},_calculateLocalAnchors:function(){var e=1e3,t=1e3,i=this.entity._parent;i&&i.element?(e=i.element.calculatedWidth,t=i.element.calculatedHeight):this.screen&&(t=this.screen.screen.resolution,i=this.screen.screen.scale,e=t.x/i,t=t.y/i),this._localAnchor.set(this._anchor.x*e,this._anchor.y*t,this._anchor.z*e,this._anchor.w*t)},getOffsetPosition:function(e,t){var i=this.entity.getLocalPosition().clone();return i.x+=e,i.y+=t,this._screenToWorld.transformPoint(i,i),i},onLayersChanged:function(e,t){this.addModelToLayers(this._image?this._image._model:this._text._model),e.off("add",this.onLayerAdded,this),e.off("remove",this.onLayerRemoved,this),t.on("add",this.onLayerAdded,this),t.on("remove",this.onLayerRemoved,this)},onLayerAdded:function(e){this.layers.indexOf(e.id)<0||(this._image?e.addMeshInstances(this._image._model.meshInstances):this._text&&e.addMeshInstances(this._text._model.meshInstances))},onLayerRemoved:function(e){this.layers.indexOf(e.id)<0||(this._image?e.removeMeshInstances(this._image._model.meshInstances):this._text&&e.removeMeshInstances(this._text._model.meshInstances))},onEnable:function(){this._image&&this._image.onEnable(),this._text&&this._text.onEnable(),this._group&&this._group.onEnable(),this.useInput&&this.system.app.elementInput&&this.system.app.elementInput.addElement(this),this.system.app.scene.on("set:layers",this.onLayersChanged,this),this.system.app.scene.layers&&(this.system.app.scene.layers.on("add",this.onLayerAdded,this),this.system.app.scene.layers.on("remove",this.onLayerRemoved,this)),0<=this._batchGroupId&&this.system.app.batcher.insert(te.BatchGroup.ELEMENT,this.batchGroupId,this.entity),this.fire("enableelement")},onDisable:function(){this.system.app.scene.off("set:layers",this.onLayersChanged,this),this.system.app.scene.layers&&(this.system.app.scene.layers.off("add",this.onLayerAdded,this),this.system.app.scene.layers.off("remove",this.onLayerRemoved,this)),this._image&&this._image.onDisable(),this._text&&this._text.onDisable(),this._group&&this._group.onDisable(),this.system.app.elementInput&&this.useInput&&this.system.app.elementInput.removeElement(this),0<=this._batchGroupId&&this.system.app.batcher.remove(te.BatchGroup.ELEMENT,this.batchGroupId,this.entity),this.fire("disableelement")},onRemove:function(){this.entity.off("insert",this._onInsert,this),this._unpatch(),this._image&&this._image.destroy(),this._text&&this._text.destroy(),this.system.app.elementInput&&this.useInput&&this.system.app.elementInput.removeElement(this),this.screen&&this.screen.screen&&(this._unbindScreen(this.screen.screen),this.screen.screen.syncDrawOrder()),this.off()},_calculateSize:function(e,t){if(this.entity._parent||this.screen){this._calculateLocalAnchors();var i=this._absRight-this._absLeft,s=this._absTop-this._absBottom;e?this._setWidth(i):this._setCalculatedWidth(i,!1),t?this._setHeight(s):this._setCalculatedHeight(s,!1),(i=this.entity.getLocalPosition()).x=this._margin.x+this._calculatedWidth*this._pivot.x,i.y=this._margin.y+this._calculatedHeight*this._pivot.y,this.entity.setLocalPosition(i),this._sizeDirty=!1}},_setWidth:function(e){this._width=e,this._setCalculatedWidth(e,!1),this.fire("set:width",this._width)},_setHeight:function(e){this._height=e,this._setCalculatedHeight(e,!1),this.fire("set:height",this._height)},_setCalculatedWidth:function(e,t){if(!(Math.abs(e-this._calculatedWidth)<=1e-4)){if(this._calculatedWidth=e,this.entity._dirtifyLocal(),t){var i=this.entity.getLocalPosition();this._margin.x=i.x-this._calculatedWidth*this._pivot.x,this._margin.z=this._localAnchor.z-this._localAnchor.x-this._calculatedWidth-this._margin.x}this._flagChildrenAsDirty(),this.fire("set:calculatedWidth",this._calculatedWidth),this.fire("resize",this._calculatedWidth,this._calculatedHeight)}},_setCalculatedHeight:function(e,t){if(!(Math.abs(e-this._calculatedHeight)<=1e-4)){if(this._calculatedHeight=e,this.entity._dirtifyLocal(),t){var i=this.entity.getLocalPosition();this._margin.y=i.y-this._calculatedHeight*this._pivot.y,this._margin.w=this._localAnchor.w-this._localAnchor.y-this._calculatedHeight-this._margin.y}this._flagChildrenAsDirty(),this.fire("set:calculatedHeight",this._calculatedHeight),this.fire("resize",this._calculatedWidth,this._calculatedHeight)}},_flagChildrenAsDirty:function(){var e,t,i=this.entity._children;for(e=0,t=i.length;e<t;e++)i[e].element&&(i[e].element._anchorDirty=!0,i[e].element._sizeDirty=!0)},addModelToLayers:function(e){var t;this._addedModels.push(e);for(var i=0;i<this.layers.length;i++)(t=this.system.app.scene.layers.getLayerById(this.layers[i]))&&t.addMeshInstances(e.meshInstances)},removeModelFromLayers:function(e){var t;0<=(t=this._addedModels.indexOf(e))&&this._addedModels.splice(t,1);for(var i=0;i<this.layers.length;i++)(t=this.system.app.scene.layers.getLayerById(this.layers[i]))&&t.removeMeshInstances(e.meshInstances)},getMaskOffset:function(){var e=this.system.app.frame;return this._offsetReadAt!==e&&(this._maskOffset=.5,this._offsetReadAt=e),e=this._maskOffset,this._maskOffset-=.001,e},isVisibleForCamera:function(e){var t,i,s;if(this.maskedBy)e=this.maskedBy.element.screenCorners,t=Math.min(Math.min(e[0].x,e[1].x),Math.min(e[2].x,e[3].x)),i=Math.max(Math.max(e[0].x,e[1].x),Math.max(e[2].x,e[3].x)),s=Math.min(Math.min(e[0].y,e[1].y),Math.min(e[2].y,e[3].y)),e=Math.max(Math.max(e[0].y,e[1].y),Math.max(e[2].y,e[3].y));else{t=this.system.app.graphicsDevice.width;var n=this.system.app.graphicsDevice.height;i=e._rect.width*t,s=e._rect.height*n,i=(t*=e._rect.x)+i,s=(e=(1-e._rect.y)*n)-s}n=this.screenCorners;var a=Math.min(Math.min(n[0].x,n[1].x),Math.min(n[2].x,n[3].x)),r=Math.min(Math.min(n[0].y,n[1].y),Math.min(n[2].y,n[3].y)),o=Math.max(Math.max(n[0].y,n[1].y),Math.max(n[2].y,n[3].y));return!(Math.max(Math.max(n[0].x,n[1].x),Math.max(n[2].x,n[3].x))<t||i<a||e<r||o<s)},_isScreenSpace:function(){return!(!this.screen||!this.screen.screen)&&this.screen.screen.screenSpace},_isScreenCulled:function(){return!(!this.screen||!this.screen.screen)&&this.screen.screen.cull}}),Object.defineProperty(e.prototype,"type",{get:function(){return this._type},set:function(e){e!==this._type&&(this._type=e,this._image&&(this._image.destroy(),this._image=null),this._text&&(this._text.destroy(),this._text=null),e===te.ELEMENTTYPE_IMAGE?this._image=new te.ImageElement(this):e===te.ELEMENTTYPE_TEXT&&(this._text=new te.TextElement(this)))}}),Object.defineProperty(e.prototype,"layers",{get:function(){return this._layers},set:function(e){var t,i,s;if(this._addedModels.length)for(t=0;t<this._layers.length;t++)if(s=this.system.app.scene.layers.getLayerById(this._layers[t]))for(i=0;i<this._addedModels.length;i++)s.removeMeshInstances(this._addedModels[i].meshInstances);if(this._layers=e,this.enabled&&this.entity.enabled&&this._addedModels.length)for(t=0;t<this._layers.length;t++)if(s=this.system.app.scene.layers.getLayerById(this._layers[t]))for(i=0;i<this._addedModels.length;i++)s.addMeshInstances(this._addedModels[i].meshInstances)}}),Object.defineProperty(e.prototype,"drawOrder",{get:function(){return this._drawOrder},set:function(e){var t=0;this.screen&&(t=this.screen.screen.priority),16777215<e&&(e=16777215),this._drawOrder=(t<<24)+e,this.fire("set:draworder",this._drawOrder)}}),Object.defineProperty(e.prototype,"_absLeft",{get:function(){return this._localAnchor.x+this._margin.x}}),Object.defineProperty(e.prototype,"_absRight",{get:function(){return this._localAnchor.z-this._margin.z}}),Object.defineProperty(e.prototype,"_absTop",{get:function(){return this._localAnchor.w-this._margin.w}}),Object.defineProperty(e.prototype,"_absBottom",{get:function(){return this._localAnchor.y+this._margin.y}}),Object.defineProperty(e.prototype,"margin",{get:function(){return this._margin},set:function(e){this._margin.copy(e),this._calculateSize(!0,!0),this.fire("set:margin",this._margin)}}),Object.defineProperty(e.prototype,"left",{get:function(){return this._margin.x},set:function(e){this._margin.x=e;var t=this.entity.getLocalPosition();this._setWidth(this._absRight-(this._localAnchor.x+e)),t.x=e+this._calculatedWidth*this._pivot.x,this.entity.setLocalPosition(t)}}),Object.defineProperty(e.prototype,"right",{get:function(){return this._margin.z},set:function(e){this._margin.z=e;var t=this.entity.getLocalPosition();this._setWidth(this._localAnchor.z-e-this._absLeft),t.x=this._localAnchor.z-this._localAnchor.x-e-this._calculatedWidth*(1-this._pivot.x),this.entity.setLocalPosition(t)}}),Object.defineProperty(e.prototype,"top",{get:function(){return this._margin.w},set:function(e){this._margin.w=e;var t=this.entity.getLocalPosition();this._setHeight(this._localAnchor.w-e-this._absBottom),t.y=this._localAnchor.w-this._localAnchor.y-e-this._calculatedHeight*(1-this._pivot.y),this.entity.setLocalPosition(t)}}),Object.defineProperty(e.prototype,"bottom",{get:function(){return this._margin.y},set:function(e){this._margin.y=e;var t=this.entity.getLocalPosition();this._setHeight(this._absTop-(this._localAnchor.y+e)),t.y=e+this._calculatedHeight*this._pivot.y,this.entity.setLocalPosition(t)}}),Object.defineProperty(e.prototype,"width",{get:function(){return this._width},set:function(e){this._width=e,this._hasSplitAnchorsX||this._setCalculatedWidth(e,!0),this.fire("set:width",this._width)}}),Object.defineProperty(e.prototype,"height",{get:function(){return this._height},set:function(e){this._height=e,this._hasSplitAnchorsY||this._setCalculatedHeight(e,!0),this.fire("set:height",this._height)}}),Object.defineProperty(e.prototype,"calculatedWidth",{get:function(){return this._calculatedWidth},set:function(e){this._setCalculatedWidth(e,!0)}}),Object.defineProperty(e.prototype,"calculatedHeight",{get:function(){return this._calculatedHeight},set:function(e){this._setCalculatedHeight(e,!0)}}),Object.defineProperty(e.prototype,"pivot",{get:function(){return this._pivot},set:function(e){var t=this._pivot.x,i=this._pivot.y;e instanceof te.Vec2?this._pivot.set(e.x,e.y):this._pivot.set(e[0],e[1]),e=this._margin.x+this._margin.z,t=this._pivot.x-t,this._margin.x+=e*t,this._margin.z-=e*t,t=this._margin.y+this._margin.w,i=this._pivot.y-i,this._margin.y+=t*i,this._margin.w-=t*i,this._worldCornersDirty=this._cornersDirty=this._anchorDirty=!0,this._calculateSize(!1,!1),this.fire("set:pivot",this._pivot)}}),Object.defineProperty(e.prototype,"anchor",{get:function(){return this._anchor},set:function(e){e instanceof te.Vec4?this._anchor.set(e.x,e.y,e.z,e.w):this._anchor.set(e[0],e[1],e[2],e[3]),this.entity._parent||this.screen?this._calculateSize(this._hasSplitAnchorsX,this._hasSplitAnchorsY):this._calculateLocalAnchors(),this._anchorDirty=!0,this.entity._dirtyLocal||this.entity._dirtifyLocal(),this.fire("set:anchor",this._anchor)}}),Object.defineProperty(e.prototype,"_hasSplitAnchorsX",{get:function(){return.001<Math.abs(this._anchor.x-this._anchor.z)}}),Object.defineProperty(e.prototype,"_hasSplitAnchorsY",{get:function(){return.001<Math.abs(this._anchor.y-this._anchor.w)}}),Object.defineProperty(e.prototype,"aabb",{get:function(){return this._image?this._image.aabb:this._text?this._text.aabb:null}}),Object.defineProperty(e.prototype,"screenCorners",{get:function(){if(!this._cornersDirty||!this.screen)return this._screenCorners;var e=this.entity.parent&&this.entity.parent.element&&this.entity.parent.element.screenCorners[0];this._screenCorners[0].set(this._absLeft,this._absBottom,0),this._screenCorners[1].set(this._absRight,this._absBottom,0),this._screenCorners[2].set(this._absRight,this._absTop,0),this._screenCorners[3].set(this._absLeft,this._absTop,0);for(var t=this.screen.screen.screenSpace,i=0;i<4;i++)this._screenTransform.transformPoint(this._screenCorners[i],this._screenCorners[i]),t&&this._screenCorners[i].scale(this.screen.screen.scale),e&&this._screenCorners[i].add(e);return this._cornersDirty=!1,this._worldCornersDirty=this._canvasCornersDirty=!0,this._screenCorners}}),Object.defineProperty(e.prototype,"canvasCorners",{get:function(){if(!this._canvasCornersDirty||!this.screen||!this.screen.screen.screenSpace)return this._canvasCorners;for(var e=this.system.app.graphicsDevice,t=this.screenCorners,i=e.canvas.clientWidth/e.width,s=e.canvas.clientHeight/e.height,n=0;n<4;n++)this._canvasCorners[n].set(t[n].x*i,(e.height-t[n].y)*s);return this._canvasCornersDirty=!1,this._canvasCorners}}),Object.defineProperty(e.prototype,"worldCorners",{get:function(){if(!this._worldCornersDirty)return this._worldCorners;if(this.screen){var e=this.screenCorners;if(!this.screen.screen.screenSpace){h.copy(this.screen.screen._screenMatrix),h.data[13]=-h.data[13],h.mul2(this.screen.getWorldTransform(),h);for(var t=0;t<4;t++)h.transformPoint(e[t],this._worldCorners[t])}}else e=this.entity.getLocalPosition(),h.setTranslate(-e.x,-e.y,-e.z),l.setTRS(te.Vec3.ZERO,this.entity.getLocalRotation(),this.entity.getLocalScale()),c.setTranslate(e.x,e.y,e.z),i.copy(this.entity.parent.getWorldTransform()),i.mul(c).mul(l).mul(h),r.set(e.x-this.pivot.x*this.calculatedWidth,e.y-this.pivot.y*this.calculatedHeight,e.z),i.transformPoint(r,this._worldCorners[0]),r.set(e.x+(1-this.pivot.x)*this.calculatedWidth,e.y-this.pivot.y*this.calculatedHeight,e.z),i.transformPoint(r,this._worldCorners[1]),r.set(e.x+(1-this.pivot.x)*this.calculatedWidth,e.y+(1-this.pivot.y)*this.calculatedHeight,e.z),i.transformPoint(r,this._worldCorners[2]),r.set(e.x-this.pivot.x*this.calculatedWidth,e.y+(1-this.pivot.y)*this.calculatedHeight,e.z),i.transformPoint(r,this._worldCorners[3]);return this._worldCornersDirty=!1,this._worldCorners}}),Object.defineProperty(e.prototype,"textWidth",{get:function(){return this._text?this._text.width:0}}),Object.defineProperty(e.prototype,"textHeight",{get:function(){return this._text?this._text.height:0}}),Object.defineProperty(e.prototype,"useInput",{get:function(){return this._useInput},set:function(e){this._useInput!==e&&(this._useInput=e,this.system.app.elementInput&&(e?this.enabled&&this.entity.enabled&&this.system.app.elementInput.addElement(this):this.system.app.elementInput.removeElement(this)),this.fire("set:useInput",e))}}),Object.defineProperty(e.prototype,"batchGroupId",{get:function(){return this._batchGroupId},set:function(e){this._batchGroupId!==e&&(this.entity.enabled&&0<=this._batchGroupId&&this.system.app.batcher.remove(te.BatchGroup.ELEMENT,this.batchGroupId,this.entity),this.entity.enabled&&0<=e&&this.system.app.batcher.insert(te.BatchGroup.ELEMENT,e,this.entity),e<0&&0<=this._batchGroupId&&this.enabled&&this.entity.enabled&&(this._image&&this._image._renderable.model?this.addModelToLayers(this._image._renderable.model):this._text&&this._text._model&&this.addModelToLayers(this._text._model)),this._batchGroupId=e)}}),Object.defineProperty(e.prototype,"maskedBy",{get:function(){return this._maskedBy}});var t=function(t){Object.defineProperty(e.prototype,t,{get:function(){return this._text?this._text[t]:this._image?this._image[t]:null},set:function(e){this._text?this._text[t]=e:this._image&&(this._image[t]=e)}})};return t("fontSize"),t("minFontSize"),t("maxFontSize"),t("maxLines"),t("autoFitWidth"),t("autoFitHeight"),t("color"),t("font"),t("fontAsset"),t("spacing"),t("lineHeight"),t("wrapLines"),t("lines"),t("alignment"),t("autoWidth"),t("autoHeight"),t("rtlReorder"),t("unicodeConverter"),t("text"),t("key"),t("texture"),t("textureAsset"),t("material"),t("materialAsset"),t("sprite"),t("spriteAsset"),t("spriteFrame"),t("pixelsPerUnit"),t("opacity"),t("rect"),t("mask"),t("outlineColor"),t("outlineThickness"),t("shadowColor"),t("shadowOffset"),t("enableMarkup"),t("rangeStart"),t("rangeEnd"),{ElementComponent:e}}()),Object.assign(te,(fs=["enabled"],((ms=function(e){te.ComponentSystem.call(this,e),this.id="element",this.app=e,this.ComponentType=te.ElementComponent,this.DataType=te.ElementComponentData,this.schema=fs,this._rtlReorder=this._unicodeConverter=null,this._defaultTexture=new te.Texture(e.graphicsDevice,{width:1,height:1,format:te.PIXELFORMAT_R8_G8_B8_A8}),this._defaultTexture.name="element-system",e=this._defaultTexture.lock();var t=new Uint8Array(4);t[0]=255,t[1]=255,t[2]=255,t[3]=255,e.set(t),this._defaultTexture.unlock(),this.defaultScreenSpaceBitmapTextMaterial=this.defaultScreenSpaceTextMaterial=this.defaultBitmapTextMaterial=this.defaultTextMaterial=this.defaultScreenSpaceImageMaskMaterial=this.defaultScreenSpaceImageMask9TiledMaterial=this.defaultScreenSpaceImageMask9SlicedMaterial=this.defaultScreenSpaceImage9TiledMaterial=this.defaultScreenSpaceImage9SlicedMaterial=this.defaultScreenSpaceImageMaterial=this.defaultImage9TiledMaskMaterial=this.defaultImage9SlicedMaskMaterial=this.defaultImageMaskMaterial=this.defaultImage9TiledMaterial=this.defaultImage9SlicedMaterial=this.defaultImageMaterial=null,this.defaultImageMaterials=[],this.on("beforeremove",this.onRemoveComponent,this)}).prototype=Object.create(te.ComponentSystem.prototype)).constructor=ms,te.Component._buildAccessors(te.ElementComponent.prototype,fs),Object.assign(ms.prototype,{destroy:function(){this._defaultTexture.destroy()},initializeComponentData:function(e,t,i){e._beingInitialized=!0,void 0!==t.anchor&&(t.anchor instanceof te.Vec4?e.anchor.copy(t.anchor):e.anchor.set(t.anchor[0],t.anchor[1],t.anchor[2],t.anchor[3])),void 0!==t.pivot&&(t.pivot instanceof te.Vec2?e.pivot.copy(t.pivot):e.pivot.set(t.pivot[0],t.pivot[1]));var s=.001<Math.abs(e.anchor.x-e.anchor.z),n=.001<Math.abs(e.anchor.y-e.anchor.w),a=!1;void 0!==t.margin&&(t.margin instanceof te.Vec4?e.margin.copy(t.margin):e._margin.set(t.margin[0],t.margin[1],t.margin[2],t.margin[3]),a=!0),void 0!==t.left&&(e._margin.x=t.left,a=!0),void 0!==t.bottom&&(e._margin.y=t.bottom,a=!0),void 0!==t.right&&(e._margin.z=t.right,a=!0),void 0!==t.top&&(e._margin.w=t.top,a=!0),a&&(e.margin=e._margin),a=!1,void 0===t.width||s?s&&(a=!0):e.width=t.width,void 0===t.height||n?n&&(a=!0):e.height=t.height,a&&(e.anchor=e.anchor),void 0!==t.enabled&&(e.enabled=t.enabled),void 0!==t.useInput&&(e.useInput=t.useInput),e.batchGroupId=void 0===t.batchGroupId||null===t.batchGroupId?-1:t.batchGroupId,t.layers&&"array"===te.type(t.layers)&&(e.layers=t.layers.slice(0)),e.type=t.type,e.type===te.ELEMENTTYPE_IMAGE?(void 0!==t.rect&&(e.rect=t.rect),void 0!==t.color&&((s=t.color)instanceof te.Color||(s=new te.Color(t.color[0],t.color[1],t.color[2])),e.color=s),void 0!==t.opacity&&(e.opacity=t.opacity),void 0!==t.textureAsset&&(e.textureAsset=t.textureAsset),t.texture&&(e.texture=t.texture),void 0!==t.spriteAsset&&(e.spriteAsset=t.spriteAsset),t.sprite&&(e.sprite=t.sprite),void 0!==t.spriteFrame&&(e.spriteFrame=t.spriteFrame),void 0!==t.pixelsPerUnit&&null!==t.pixelsPerUnit&&(e.pixelsPerUnit=t.pixelsPerUnit),void 0!==t.materialAsset&&(e.materialAsset=t.materialAsset),t.material&&(e.material=t.material),void 0!==t.mask&&(e.mask=t.mask)):e.type===te.ELEMENTTYPE_TEXT&&(void 0!==t.autoWidth&&(e.autoWidth=t.autoWidth),void 0!==t.autoHeight&&(e.autoHeight=t.autoHeight),void 0!==t.rtlReorder&&(e.rtlReorder=t.rtlReorder),void 0!==t.unicodeConverter&&(e.unicodeConverter=t.unicodeConverter),null!==t.text&&void 0!==t.text?e.text=t.text:null!==t.key&&void 0!==t.key&&(e.key=t.key),void 0!==t.color&&((s=t.color)instanceof te.Color||(s=new te.Color(s[0],s[1],s[2])),e.color=s),void 0!==t.opacity&&(e.opacity=t.opacity),void 0!==t.spacing&&(e.spacing=t.spacing),void 0!==t.fontSize&&(e.fontSize=t.fontSize,t.lineHeight||(e.lineHeight=t.fontSize)),void 0!==t.lineHeight&&(e.lineHeight=t.lineHeight),void 0!==t.maxLines&&(e.maxLines=t.maxLines),void 0!==t.wrapLines&&(e.wrapLines=t.wrapLines),void 0!==t.minFontSize&&(e.minFontSize=t.minFontSize),void 0!==t.maxFontSize&&(e.maxFontSize=t.maxFontSize),t.autoFitWidth&&(e.autoFitWidth=t.autoFitWidth),t.autoFitHeight&&(e.autoFitHeight=t.autoFitHeight),void 0!==t.fontAsset&&(e.fontAsset=t.fontAsset),void 0!==t.font&&(e.font=t.font),void 0!==t.alignment&&(e.alignment=t.alignment),void 0!==t.outlineColor&&(e.outlineColor=t.outlineColor),void 0!==t.outlineThickness&&(e.outlineThickness=t.outlineThickness),void 0!==t.shadowColor&&(e.shadowColor=t.shadowColor),void 0!==t.shadowOffset&&(e.shadowOffset=t.shadowOffset),void 0!==t.enableMarkup&&(e.enableMarkup=t.enableMarkup)),(s=e._parseUpToScreen()).screen&&e._updateScreen(s.screen),te.ComponentSystem.prototype.initializeComponentData.call(this,e,t,i),e._beingInitialized=!1,e.type===te.ELEMENTTYPE_IMAGE&&e._image._meshDirty&&e._image._updateMesh(e._image.mesh)},onRemoveComponent:function(e,t){t.onRemove()},cloneComponent:function(e,t){var i=e.element,s={enabled:i.enabled,width:i.width,height:i.height,anchor:i.anchor.clone(),pivot:i.pivot.clone(),margin:i.margin.clone(),alignment:i.alignment&&i.alignment.clone()||i.alignment,autoWidth:i.autoWidth,autoHeight:i.autoHeight,type:i.type,rect:i.rect&&i.rect.clone()||i.rect,rtlReorder:i.rtlReorder,unicodeConverter:i.unicodeConverter,materialAsset:i.materialAsset,material:i.material,color:i.color&&i.color.clone()||i.color,opacity:i.opacity,textureAsset:i.textureAsset,texture:i.texture,spriteAsset:i.spriteAsset,sprite:i.sprite,spriteFrame:i.spriteFrame,pixelsPerUnit:i.pixelsPerUnit,spacing:i.spacing,lineHeight:i.lineHeight,wrapLines:i.wrapLines,layers:i.layers,fontSize:i.fontSize,minFontSize:i.minFontSize,maxFontSize:i.maxFontSize,autoFitWidth:i.autoFitWidth,autoFitHeight:i.autoFitHeight,maxLines:i.maxLines,fontAsset:i.fontAsset,font:i.font,useInput:i.useInput,batchGroupId:i.batchGroupId,mask:i.mask,outlineColor:i.outlineColor&&i.outlineColor.clone()||i.outlineColor,outlineThickness:i.outlineThickness,shadowColor:i.shadowColor&&i.shadowColor.clone()||i.shadowColor,shadowOffset:i.shadowOffset&&i.shadowOffset.clone()||i.shadowOffset,enableMarkup:i.enableMarkup};return void 0!==i.key&&null!==i.key?s.key=i.key:s.text=i.text,this.addComponent(t,s)},getTextElementMaterial:function(e,t){return e?t?(this.defaultScreenSpaceTextMaterial||(this.defaultScreenSpaceTextMaterial=new te.StandardMaterial,this.defaultScreenSpaceTextMaterial.name="defaultScreenSpaceTextMaterial",this.defaultScreenSpaceTextMaterial.msdfMap=this._defaultTexture,this.defaultScreenSpaceTextMaterial.useLighting=!1,this.defaultScreenSpaceTextMaterial.useGammaTonemap=!1,this.defaultScreenSpaceTextMaterial.useFog=!1,this.defaultScreenSpaceTextMaterial.useSkybox=!1,this.defaultScreenSpaceTextMaterial.diffuse.set(0,0,0),this.defaultScreenSpaceTextMaterial.emissive.set(1,1,1),this.defaultScreenSpaceTextMaterial.opacity=.5,this.defaultScreenSpaceTextMaterial.blendType=te.BLEND_PREMULTIPLIED,this.defaultScreenSpaceTextMaterial.depthWrite=!1,this.defaultScreenSpaceTextMaterial.depthTest=!1,this.defaultScreenSpaceTextMaterial.emissiveVertexColor=!0,this.defaultScreenSpaceTextMaterial.update()),this.defaultScreenSpaceTextMaterial):(this.defaultScreenSpaceBitmapTextMaterial||(this.defaultScreenSpaceBitmapTextMaterial=new te.StandardMaterial,this.defaultScreenSpaceBitmapTextMaterial.name="defaultScreenSpaceBitmapTextMaterial",this.defaultScreenSpaceBitmapTextMaterial.emissive.set(.5,.5,.5),this.defaultScreenSpaceBitmapTextMaterial.emissiveMap=this._defaultTexture,this.defaultScreenSpaceBitmapTextMaterial.emissiveTint=!0,this.defaultScreenSpaceBitmapTextMaterial.opacity=.5,this.defaultScreenSpaceBitmapTextMaterial.opacityMap=this._defaultTexture,this.defaultScreenSpaceBitmapTextMaterial.opacityMapChannel="a",this.defaultScreenSpaceBitmapTextMaterial.useLighting=!1,this.defaultScreenSpaceBitmapTextMaterial.useGammaTonemap=!1,this.defaultScreenSpaceBitmapTextMaterial.useFog=!1,this.defaultScreenSpaceBitmapTextMaterial.useSkybox=!1,this.defaultScreenSpaceBitmapTextMaterial.diffuse.set(0,0,0),this.defaultScreenSpaceBitmapTextMaterial.blendType=te.BLEND_PREMULTIPLIED,this.defaultScreenSpaceBitmapTextMaterial.depthWrite=!1,this.defaultScreenSpaceBitmapTextMaterial.depthTest=!1,this.defaultScreenSpaceBitmapTextMaterial.emissiveVertexColor=!0,this.defaultScreenSpaceBitmapTextMaterial.update()),this.defaultScreenSpaceBitmapTextMaterial):t?(this.defaultTextMaterial||(this.defaultTextMaterial=new te.StandardMaterial,this.defaultTextMaterial.name="defaultTextMaterial",this.defaultTextMaterial.msdfMap=this._defaultTexture,this.defaultTextMaterial.useLighting=!1,this.defaultTextMaterial.useGammaTonemap=!1,this.defaultTextMaterial.useFog=!1,this.defaultTextMaterial.useSkybox=!1,this.defaultTextMaterial.diffuse.set(0,0,0),this.defaultTextMaterial.emissive.set(1,1,1),this.defaultTextMaterial.opacity=.5,this.defaultTextMaterial.blendType=te.BLEND_PREMULTIPLIED,this.defaultTextMaterial.depthWrite=!1,this.defaultTextMaterial.emissiveVertexColor=!0,this.defaultTextMaterial.update()),this.defaultTextMaterial):(this.defaultBitmapTextMaterial||(this.defaultBitmapTextMaterial=new te.StandardMaterial,this.defaultBitmapTextMaterial.name="defaultBitmapTextMaterial",this.defaultBitmapTextMaterial.emissive.set(.5,.5,.5),this.defaultBitmapTextMaterial.emissiveTint=!0,this.defaultBitmapTextMaterial.emissiveMap=this._defaultTexture,this.defaultBitmapTextMaterial.opacity=.5,this.defaultBitmapTextMaterial.opacityMap=this._defaultTexture,this.defaultBitmapTextMaterial.opacityMapChannel="a",this.defaultBitmapTextMaterial.useLighting=!1,this.defaultBitmapTextMaterial.useGammaTonemap=!1,this.defaultBitmapTextMaterial.useFog=!1,this.defaultBitmapTextMaterial.useSkybox=!1,this.defaultBitmapTextMaterial.diffuse.set(0,0,0),this.defaultBitmapTextMaterial.blendType=te.BLEND_PREMULTIPLIED,this.defaultBitmapTextMaterial.depthWrite=!1,this.defaultBitmapTextMaterial.emissiveVertexColor=!0,this.defaultBitmapTextMaterial.update()),this.defaultBitmapTextMaterial)},_createBaseImageMaterial:function(){var e=new te.StandardMaterial;return e.diffuse.set(0,0,0),e.emissive.set(.5,.5,.5),e.emissiveMap=this._defaultTexture,e.emissiveTint=!0,e.opacityMap=this._defaultTexture,e.opacityMapChannel="a",e.opacityTint=!0,e.opacity=0,e.useLighting=!1,e.useGammaTonemap=!1,e.useFog=!1,e.useSkybox=!1,e.blendType=te.BLEND_PREMULTIPLIED,e.depthWrite=!1,e},getImageElementMaterial:function(e,t,i,s){return e?t?i?(this.defaultScreenSpaceImageMask9SlicedMaterial||(this.defaultScreenSpaceImageMask9SlicedMaterial=this._createBaseImageMaterial(),this.defaultScreenSpaceImageMask9SlicedMaterial.name="defaultScreenSpaceImageMask9SlicedMaterial",this.defaultScreenSpaceImageMask9SlicedMaterial.nineSlicedMode=te.SPRITE_RENDERMODE_SLICED,this.defaultScreenSpaceImageMask9SlicedMaterial.depthTest=!1,this.defaultScreenSpaceImageMask9SlicedMaterial.alphaTest=1,this.defaultScreenSpaceImageMask9SlicedMaterial.redWrite=!1,this.defaultScreenSpaceImageMask9SlicedMaterial.greenWrite=!1,this.defaultScreenSpaceImageMask9SlicedMaterial.blueWrite=!1,this.defaultScreenSpaceImageMask9SlicedMaterial.alphaWrite=!1,this.defaultScreenSpaceImageMask9SlicedMaterial.update(),this.defaultImageMaterials.push(this.defaultScreenSpaceImageMask9SlicedMaterial)),this.defaultScreenSpaceImageMask9SlicedMaterial):s?(this.defaultScreenSpaceImageMask9TiledMaterial||(this.defaultScreenSpaceImageMask9TiledMaterial=this.defaultScreenSpaceImage9TiledMaterial.clone(),this.defaultScreenSpaceImageMask9TiledMaterial.name="defaultScreenSpaceImageMask9TiledMaterial",this.defaultScreenSpaceImageMask9TiledMaterial.nineSlicedMode=te.SPRITE_RENDERMODE_TILED,this.defaultScreenSpaceImageMask9TiledMaterial.depthTest=!1,this.defaultScreenSpaceImageMask9TiledMaterial.alphaTest=1,this.defaultScreenSpaceImageMask9TiledMaterial.redWrite=!1,this.defaultScreenSpaceImageMask9TiledMaterial.greenWrite=!1,this.defaultScreenSpaceImageMask9TiledMaterial.blueWrite=!1,this.defaultScreenSpaceImageMask9TiledMaterial.alphaWrite=!1,this.defaultScreenSpaceImageMask9TiledMaterial.update(),this.defaultImageMaterials.push(this.defaultScreenSpaceImageMask9TiledMaterial)),this.defaultScreenSpaceImageMask9TiledMaterial):(this.defaultScreenSpaceImageMaskMaterial||(this.defaultScreenSpaceImageMaskMaterial=this._createBaseImageMaterial(),this.defaultScreenSpaceImageMaskMaterial.name="defaultScreenSpaceImageMaskMaterial",this.defaultScreenSpaceImageMaskMaterial.depthTest=!1,this.defaultScreenSpaceImageMaskMaterial.alphaTest=1,this.defaultScreenSpaceImageMaskMaterial.redWrite=!1,this.defaultScreenSpaceImageMaskMaterial.greenWrite=!1,this.defaultScreenSpaceImageMaskMaterial.blueWrite=!1,this.defaultScreenSpaceImageMaskMaterial.alphaWrite=!1,this.defaultScreenSpaceImageMaskMaterial.update(),this.defaultImageMaterials.push(this.defaultScreenSpaceImageMaskMaterial)),this.defaultScreenSpaceImageMaskMaterial):i?(this.defaultScreenSpaceImage9SlicedMaterial||(this.defaultScreenSpaceImage9SlicedMaterial=this._createBaseImageMaterial(),this.defaultScreenSpaceImage9SlicedMaterial.name="defaultScreenSpaceImage9SlicedMaterial",this.defaultScreenSpaceImage9SlicedMaterial.nineSlicedMode=te.SPRITE_RENDERMODE_SLICED,this.defaultScreenSpaceImage9SlicedMaterial.depthTest=!1,this.defaultScreenSpaceImage9SlicedMaterial.update(),this.defaultImageMaterials.push(this.defaultScreenSpaceImage9SlicedMaterial)),this.defaultScreenSpaceImage9SlicedMaterial):s?(this.defaultScreenSpaceImage9TiledMaterial||(this.defaultScreenSpaceImage9TiledMaterial=this._createBaseImageMaterial(),this.defaultScreenSpaceImage9TiledMaterial.name="defaultScreenSpaceImage9TiledMaterial",this.defaultScreenSpaceImage9TiledMaterial.nineSlicedMode=te.SPRITE_RENDERMODE_TILED,this.defaultScreenSpaceImage9TiledMaterial.depthTest=!1,this.defaultScreenSpaceImage9TiledMaterial.update(),this.defaultImageMaterials.push(this.defaultScreenSpaceImage9TiledMaterial)),this.defaultScreenSpaceImage9TiledMaterial):(this.defaultScreenSpaceImageMaterial||(this.defaultScreenSpaceImageMaterial=this._createBaseImageMaterial(),this.defaultScreenSpaceImageMaterial.name="defaultScreenSpaceImageMaterial",this.defaultScreenSpaceImageMaterial.depthTest=!1,this.defaultScreenSpaceImageMaterial.update(),this.defaultImageMaterials.push(this.defaultScreenSpaceImageMaterial)),this.defaultScreenSpaceImageMaterial):t?i?(this.defaultImage9SlicedMaskMaterial||(this.defaultImage9SlicedMaskMaterial=this._createBaseImageMaterial(),this.defaultImage9SlicedMaskMaterial.name="defaultImage9SlicedMaskMaterial",this.defaultImage9SlicedMaskMaterial.nineSlicedMode=te.SPRITE_RENDERMODE_SLICED,this.defaultImage9SlicedMaskMaterial.alphaTest=1,this.defaultImage9SlicedMaskMaterial.redWrite=!1,this.defaultImage9SlicedMaskMaterial.greenWrite=!1,this.defaultImage9SlicedMaskMaterial.blueWrite=!1,this.defaultImage9SlicedMaskMaterial.alphaWrite=!1,this.defaultImage9SlicedMaskMaterial.update(),this.defaultImageMaterials.push(this.defaultImage9SlicedMaskMaterial)),this.defaultImage9SlicedMaskMaterial):s?(this.defaultImage9TiledMaskMaterial||(this.defaultImage9TiledMaskMaterial=this._createBaseImageMaterial(),this.defaultImage9TiledMaskMaterial.name="defaultImage9TiledMaskMaterial",this.defaultImage9TiledMaskMaterial.nineSlicedMode=te.SPRITE_RENDERMODE_TILED,this.defaultImage9TiledMaskMaterial.alphaTest=1,this.defaultImage9TiledMaskMaterial.redWrite=!1,this.defaultImage9TiledMaskMaterial.greenWrite=!1,this.defaultImage9TiledMaskMaterial.blueWrite=!1,this.defaultImage9TiledMaskMaterial.alphaWrite=!1,this.defaultImage9TiledMaskMaterial.update(),this.defaultImageMaterials.push(this.defaultImage9TiledMaskMaterial)),this.defaultImage9TiledMaskMaterial):(this.defaultImageMaskMaterial||(this.defaultImageMaskMaterial=this._createBaseImageMaterial(),this.defaultImageMaskMaterial.name="defaultImageMaskMaterial",this.defaultImageMaskMaterial.alphaTest=1,this.defaultImageMaskMaterial.redWrite=!1,this.defaultImageMaskMaterial.greenWrite=!1,this.defaultImageMaskMaterial.blueWrite=!1,this.defaultImageMaskMaterial.alphaWrite=!1,this.defaultImageMaskMaterial.update(),this.defaultImageMaterials.push(this.defaultImageMaskMaterial)),this.defaultImageMaskMaterial):i?(this.defaultImage9SlicedMaterial||(this.defaultImage9SlicedMaterial=this._createBaseImageMaterial(),this.defaultImage9SlicedMaterial.name="defaultImage9SlicedMaterial",this.defaultImage9SlicedMaterial.nineSlicedMode=te.SPRITE_RENDERMODE_SLICED,this.defaultImage9SlicedMaterial.update(),this.defaultImageMaterials.push(this.defaultImage9SlicedMaterial)),this.defaultImage9SlicedMaterial):s?(this.defaultImage9TiledMaterial||(this.defaultImage9TiledMaterial=this._createBaseImageMaterial(),this.defaultImage9TiledMaterial.name="defaultImage9TiledMaterial",this.defaultImage9TiledMaterial.nineSlicedMode=te.SPRITE_RENDERMODE_TILED,this.defaultImage9TiledMaterial.update(),this.defaultImageMaterials.push(this.defaultImage9TiledMaterial)),this.defaultImage9TiledMaterial):(this.defaultImageMaterial||(this.defaultImageMaterial=this._createBaseImageMaterial(),this.defaultImageMaterial.name="defaultImageMaterial",this.defaultImageMaterial.update(),this.defaultImageMaterials.push(this.defaultImageMaterial)),this.defaultImageMaterial)},registerUnicodeConverter:function(e){this._unicodeConverter=e},registerRtlReorder:function(e){this._rtlReorder=e},getUnicodeConverter:function(){return this._unicodeConverter},getRtlReorder:function(){return this._rtlReorder}}),{ElementComponentSystem:ms})),Object.assign(te,{ElementComponentData:function(){this.enabled=!0}}),Object.assign(te,function(){var t=function(e,t,i){this._entity=e,this._element=e.element,this.model=new te.Model,this.node=new te.GraphNode,this.model.graph=this.node,this.mesh=t,this.meshInstance=new te.MeshInstance(this.node,this.mesh,i),this.meshInstance.name="ImageElement: "+e.name,this.meshInstance.castShadow=!1,this._meshDirty=this.meshInstance.receiveShadow=!1,this.model.meshInstances.push(this.meshInstance),this._entity.addChild(this.model.graph),this.model._entity=this._entity,this.unmaskMeshInstance=null};t.prototype.destroy=function(){this.setMaterial(null),this._element.removeModelFromLayers(this.model),this.model.destroy(),this._element=this._entity=this.meshInstance=this.mesh=this.node=this.model=null},t.prototype.setMesh=function(e){this.meshInstance&&(this.mesh=e,this.meshInstance.mesh=e,this.meshInstance.visible=!!e,this.unmaskMeshInstance&&(this.unmaskMeshInstance.mesh=e),this.forceUpdateAabb())},t.prototype.setMask=function(e){if(this.meshInstance){if(e)for(var t in this.unmaskMeshInstance=new te.MeshInstance(this.node,this.mesh,this.meshInstance.material),this.unmaskMeshInstance.name="Unmask: "+this._entity.name,this.unmaskMeshInstance.castShadow=!1,this.unmaskMeshInstance.receiveShadow=!1,this.unmaskMeshInstance.pick=!1,this.model.meshInstances.push(this.unmaskMeshInstance),this.meshInstance.parameters)this.unmaskMeshInstance.setParameter(t,this.meshInstance.parameters[t].data);else 0<=(e=this.model.meshInstances.indexOf(this.unmaskMeshInstance))&&this.model.meshInstances.splice(e,1),this.unmaskMeshInstance=null;this._entity.enabled&&this._element.enabled&&(this._element.removeModelFromLayers(this.model),this._element.addModelToLayers(this.model))}},t.prototype.setMaterial=function(e){this.meshInstance&&(this.meshInstance.material=e,this.unmaskMeshInstance&&(this.unmaskMeshInstance.material=e))},t.prototype.setParameter=function(e,t){this.meshInstance&&(this.meshInstance.setParameter(e,t),this.unmaskMeshInstance&&this.unmaskMeshInstance.setParameter(e,t))},t.prototype.deleteParameter=function(e){this.meshInstance&&(this.meshInstance.deleteParameter(e),this.unmaskMeshInstance&&this.unmaskMeshInstance.deleteParameter(e))},t.prototype.setUnmaskDrawOrder=function(){if(this.meshInstance){var n=function(e){var t,i=(e=e.children).length;if(i){for(var s=0;s<i;s++)e[s].element&&(t=e[s]);return t?(e=n(t))?e:t:null}return null};if(this.unmaskMeshInstance){var e=n(this._entity);this.unmaskMeshInstance.drawOrder=e&&e.element?e.element.drawOrder+e.element.getMaskOffset():this.meshInstance.drawOrder+this._element.getMaskOffset()}}},t.prototype.setDrawOrder=function(e){this.meshInstance&&(this.meshInstance.drawOrder=e)},t.prototype.setCull=function(e){if(this.meshInstance){var t=this._element,i=null;e&&t._isScreenCulled()&&(i=function(e){return t.isVisibleForCamera(e)}),this.meshInstance.cull=e,this.meshInstance.isVisibleFunc=i,this.unmaskMeshInstance&&(this.unmaskMeshInstance.cull=e,this.unmaskMeshInstance.isVisibleFunc=i)}},t.prototype.setScreenSpace=function(e){this.meshInstance&&(this.meshInstance.screenSpace=e,this.unmaskMeshInstance&&(this.unmaskMeshInstance.screenSpace=e))},t.prototype.setLayer=function(e){this.meshInstance&&(this.meshInstance.layer=e,this.unmaskMeshInstance&&(this.unmaskMeshInstance.layer=e))},t.prototype.forceUpdateAabb=function(e){this.meshInstance&&(this.meshInstance._aabbVer=-1,this.unmaskMeshInstance&&(this.unmaskMeshInstance._aabbVer=-1))},t.prototype.setAabbFunc=function(e){this.meshInstance&&(this.meshInstance._updateAabbFunc=e,this.unmaskMeshInstance&&(this.unmaskMeshInstance._updateAabbFunc=e))};var e=function(e){this._element=e,this._entity=e.entity,this._system=e.system,this._sprite=this._spriteAsset=this._material=this._materialAsset=this._texture=this._textureAsset=null,this._spriteFrame=0,this._pixelsPerUnit=null,this._rect=new te.Vec4(0,0,1,1),this._mask=!1,this._maskRef=0,this._outerScale=new te.Vec2,this._outerScaleUniform=new Float32Array(2),this._innerOffset=new te.Vec4,this._innerOffsetUniform=new Float32Array(4),this._atlasRect=new te.Vec4,this._atlasRectUniform=new Float32Array(4),this._defaultMesh=this._createMesh(),this._renderable=new t(this._entity,this._defaultMesh,this._material),this._color=new te.Color(1,1,1,1),this._colorUniform=new Float32Array([1,1,1]),this._renderable.setParameter("material_emissive",this._colorUniform),this._renderable.setParameter("material_opacity",1),this._updateAabbFunc=this._updateAabb.bind(this),this._onScreenChange(this._element.screen),this._element.on("resize",this._onParentResizeOrPivotChange,this),this._element.on("set:pivot",this._onParentResizeOrPivotChange,this),this._element.on("screen:set:screenspace",this._onScreenSpaceChange,this),this._element.on("set:screen",this._onScreenChange,this),this._element.on("set:draworder",this._onDrawOrderChange,this),this._element.on("screen:set:resolution",this._onResolutionChange,this)};return Object.assign(e.prototype,{destroy:function(){this.materialAsset=this.spriteAsset=this.textureAsset=null,this._renderable.setMesh(this._defaultMesh),this._renderable.destroy(),this._defaultMesh=null,this._element.off("resize",this._onParentResizeOrPivotChange,this),this._element.off("set:pivot",this._onParentResizeOrPivotChange,this),this._element.off("screen:set:screenspace",this._onScreenSpaceChange,this),this._element.off("set:screen",this._onScreenChange,this),this._element.off("set:draworder",this._onDrawOrderChange,this),this._element.off("screen:set:resolution",this._onResolutionChange,this)},_onResolutionChange:function(e){},_onParentResizeOrPivotChange:function(){this._renderable.mesh&&this._updateMesh(this._renderable.mesh)},_onScreenSpaceChange:function(e){this._updateMaterial(e)},_onScreenChange:function(e,t){e?this._updateMaterial(e.screen.screenSpace):this._updateMaterial(!1)},_onDrawOrderChange:function(e){this._renderable.setDrawOrder(e),this.mask&&this._element.screen&&this._element.screen.screen.once("syncdraworder",function(){this._renderable.setUnmaskDrawOrder()},this)},_hasUserMaterial:function(){return!!this._materialAsset||!!this._material&&-1===this._system.defaultImageMaterials.indexOf(this._material)},_use9Slicing:function(){return this.sprite&&(this.sprite.renderMode===te.SPRITE_RENDERMODE_SLICED||this.sprite.renderMode===te.SPRITE_RENDERMODE_TILED)},_updateMaterial:function(e){var t=!!this._mask,i=!(!this.sprite||this.sprite.renderMode!==te.SPRITE_RENDERMODE_SLICED),s=!(!this.sprite||this.sprite.renderMode!==te.SPRITE_RENDERMODE_TILED);this._hasUserMaterial()||(this._material=this._system.getImageElementMaterial(e,t,i,s)),this._renderable&&(this._renderable.setCull(!0),this._renderable.setMaterial(this._material),this._renderable.setScreenSpace(e),this._renderable.setLayer(e?te.LAYER_HUD:te.LAYER_WORLD))},_createMesh:function(){var e=(t=this._element).calculatedWidth,t=t.calculatedHeight,i=this._rect,s=new ArrayBuffer(128),n=new Float32Array(s);return n[5]=1,n[6]=i.x,n[7]=i.y,n[8]=e,n[13]=1,n[14]=i.x+i.z,n[15]=i.y,n[16]=e,n[17]=t,n[21]=1,n[22]=i.x+i.z,n[23]=i.y+i.w,n[25]=t,n[29]=1,n[30]=i.x,n[31]=i.y+i.w,i=this._system.app.graphicsDevice,n=new te.VertexFormat(i,[{semantic:te.SEMANTIC_POSITION,components:3,type:te.TYPE_FLOAT32},{semantic:te.SEMANTIC_NORMAL,components:3,type:te.TYPE_FLOAT32},{semantic:te.SEMANTIC_TEXCOORD0,components:2,type:te.TYPE_FLOAT32}]),s=new te.VertexBuffer(i,n,4,te.BUFFER_STATIC,s),(i=new te.Mesh).vertexBuffer=s,i.primitive[0].type=te.PRIMITIVE_TRIFAN,i.primitive[0].base=0,i.primitive[0].count=4,i.primitive[0].indexed=!1,i.aabb.setMinMax(te.Vec3.ZERO,new te.Vec3(e,t,0)),this._updateMesh(i),i},_updateMesh:function(e){var t=(r=this._element).calculatedWidth,i=r.calculatedHeight,s=r._isScreenSpace();if(this._updateMaterial(s),this._renderable&&this._renderable.forceUpdateAabb(),!this.sprite||this.sprite.renderMode!==te.SPRITE_RENDERMODE_SLICED&&this.sprite.renderMode!==te.SPRITE_RENDERMODE_TILED){var n=e.vertexBuffer,a=new Float32Array(n.lock()),r=(s=r.pivot.x,r.pivot.y);a[0]=0-s*t,a[1]=0-r*i,a[8]=t-s*t,a[9]=0-r*i,a[16]=t-s*t,a[17]=i-r*i,a[24]=0-s*t,a[25]=i-r*i;var o=1,h=1,l=this._rect;if(this._sprite&&this._sprite.frameKeys[this._spriteFrame]&&this._sprite.atlas){var c=this._sprite.atlas.frames[this._sprite.frameKeys[this._spriteFrame]];c&&(l=c.rect,o=this._sprite.atlas.texture.width,h=this._sprite.atlas.texture.height)}a[6]=l.x/o,a[7]=l.y/h,a[14]=(l.x+l.z)/o,a[15]=l.y/h,a[22]=(l.x+l.z)/o,a[23]=(l.y+l.w)/h,a[30]=l.x/o,a[31]=(l.y+l.w)/h,n.unlock(),n=new te.Vec3(0-s*t,0-r*i,0),t=new te.Vec3(t-s*t,i-r*i,0),e.aabb.setMinMax(n,t),this._renderable&&(this._renderable.node.setLocalScale(1,1,1),this._renderable.node.setLocalPosition(0,0,0),this._renderable.setAabbFunc(null))}else s=2/(e=this._sprite.atlas.frames[this._sprite.frameKeys[this._spriteFrame]]).rect.z,n=2/e.rect.w,this._innerOffset.set(e.border.x*s,e.border.y*n,e.border.z*s,e.border.w*n),s=this.sprite.atlas.texture,this._atlasRect.set(e.rect.x/s.width,e.rect.y/s.height,e.rect.z/s.width,e.rect.w/s.height),n=null!==this._pixelsPerUnit?this._pixelsPerUnit:this.sprite.pixelsPerUnit,s=e.rect.z/n,e=e.rect.w/n,this._outerScale.set(Math.max(t,this._innerOffset.x*s),Math.max(i,this._innerOffset.y*e)),n=e,this._outerScale.x/=s,this._outerScale.y/=e,s*=te.math.clamp(t/(this._innerOffset.x*s),1e-4,1),n*=te.math.clamp(i/(this._innerOffset.y*e),1e-4,1),this._renderable&&(this._innerOffsetUniform[0]=this._innerOffset.x,this._innerOffsetUniform[1]=this._innerOffset.y,this._innerOffsetUniform[2]=this._innerOffset.z,this._innerOffsetUniform[3]=this._innerOffset.w,this._renderable.setParameter("innerOffset",this._innerOffsetUniform),this._atlasRectUniform[0]=this._atlasRect.x,this._atlasRectUniform[1]=this._atlasRect.y,this._atlasRectUniform[2]=this._atlasRect.z,this._atlasRectUniform[3]=this._atlasRect.w,this._renderable.setParameter("atlasRect",this._atlasRectUniform),this._outerScaleUniform[0]=this._outerScale.x,this._outerScaleUniform[1]=this._outerScale.y,this._renderable.setParameter("outerScale",this._outerScaleUniform),this._renderable.setAabbFunc(this._updateAabbFunc),this._renderable.node.setLocalScale(s,n,1),this._renderable.node.setLocalPosition((.5-r.pivot.x)*t,(.5-r.pivot.y)*i,0));this._meshDirty=!1},_updateSprite:function(){var e=!1,t=null;this._sprite&&this._sprite.atlas&&(t=this._sprite.meshes[this.spriteFrame],e=this._sprite.renderMode===te.SPRITE_RENDERMODE_SLICED||this._sprite.renderMode===te.SPRITE_RENDERMODE_TILED),(this.mesh=e?t:this._defaultMesh)&&(this._element._beingInitialized?this._meshDirty=!0:this._updateMesh(this.mesh))},_updateAabb:function(e){return e.center.set(0,0,0),e.halfExtents.set(.5*this._outerScale.x,.5*this._outerScale.y,.001),e.setFromTransformedAabb(e,this._renderable.node.getWorldTransform()),e},_toggleMask:function(){this._element._dirtifyMask();var e=this._element._isScreenSpace();this._updateMaterial(e),this._renderable.setMask(!!this._mask)},_onMaterialLoad:function(e){this.material=e.resource},_onMaterialAdded:function(e){this._system.app.assets.off("add:"+e.id,this._onMaterialAdded,this),this._materialAsset===e.id&&this._bindMaterialAsset(e)},_bindMaterialAsset:function(e){this._entity.enabled&&(e.on("load",this._onMaterialLoad,this),e.on("change",this._onMaterialChange,this),e.on("remove",this._onMaterialRemove,this),e.resource?this._onMaterialLoad(e):this._system.app.assets.load(e))},_unbindMaterialAsset:function(e){e.off("load",this._onMaterialLoad,this),e.off("change",this._onMaterialChange,this),e.off("remove",this._onMaterialRemove,this)},_onMaterialChange:function(){},_onMaterialRemove:function(){},_onTextureAdded:function(e){this._system.app.assets.off("add:"+e.id,this._onTextureAdded,this),this._textureAsset===e.id&&this._bindTextureAsset(e)},_bindTextureAsset:function(e){this._entity.enabled&&(e.on("load",this._onTextureLoad,this),e.on("change",this._onTextureChange,this),e.on("remove",this._onTextureRemove,this),e.resource?this._onTextureLoad(e):this._system.app.assets.load(e))},_unbindTextureAsset:function(e){e.off("load",this._onTextureLoad,this),e.off("change",this._onTextureChange,this),e.off("remove",this._onTextureRemove,this)},_onTextureLoad:function(e){this.texture=e.resource},_onTextureChange:function(e){},_onTextureRemove:function(e){},_onSpriteAssetAdded:function(e){this._system.app.assets.off("add:"+e.id,this._onSpriteAssetAdded,this),this._spriteAsset===e.id&&this._bindSpriteAsset(e)},_bindSpriteAsset:function(e){this._entity.enabled&&(e.on("load",this._onSpriteAssetLoad,this),e.on("change",this._onSpriteAssetChange,this),e.on("remove",this._onSpriteAssetRemove,this),e.resource?this._onSpriteAssetLoad(e):this._system.app.assets.load(e))},_unbindSpriteAsset:function(e){e.off("load",this._onSpriteAssetLoad,this),e.off("change",this._onSpriteAssetChange,this),e.off("remove",this._onSpriteAssetRemove,this),e.data.textureAtlasAsset&&this._system.app.assets.off("load:"+e.data.textureAtlasAsset,this._onTextureAtlasLoad,this)},_onSpriteAssetLoad:function(e){if(e&&e.resource){if(e.resource.atlas)this.sprite=e.resource;else if(e=e.data.textureAtlasAsset){var t=this._system.app.assets;t.off("load:"+e,this._onTextureAtlasLoad,this),t.once("load:"+e,this._onTextureAtlasLoad,this)}}else this.sprite=null},_onSpriteAssetChange:function(e){this._onSpriteAssetLoad(e)},_onSpriteAssetRemove:function(e){},_bindSprite:function(e){e.on("set:meshes",this._onSpriteMeshesChange,this),e.on("set:pixelsPerUnit",this._onSpritePpuChange,this),e.on("set:atlas",this._onAtlasTextureChange,this),e.atlas&&e.atlas.on("set:texture",this._onAtlasTextureChange,this)},_unbindSprite:function(e){e.off("set:meshes",this._onSpriteMeshesChange,this),e.off("set:pixelsPerUnit",this._onSpritePpuChange,this),e.off("set:atlas",this._onAtlasTextureChange,this),e.atlas&&e.atlas.off("set:texture",this._onAtlasTextureChange,this)},_onSpriteMeshesChange:function(){this._sprite&&(this._spriteFrame=te.math.clamp(this._spriteFrame,0,this._sprite.frameKeys.length-1)),this._updateSprite()},_onSpritePpuChange:function(){this.sprite.renderMode!==te.SPRITE_RENDERMODE_SIMPLE&&null===this._pixelsPerUnit&&this._updateSprite()},_onAtlasTextureChange:function(){this.sprite&&this.sprite.atlas&&this.sprite.atlas.texture?(this._renderable.setParameter("texture_emissiveMap",this._sprite.atlas.texture),this._renderable.setParameter("texture_opacityMap",this._sprite.atlas.texture)):(this._renderable.deleteParameter("texture_emissiveMap"),this._renderable.deleteParameter("texture_opacityMap"))},_onTextureAtlasLoad:function(e){(e=this._spriteAsset)instanceof te.Asset?this._onSpriteAssetLoad(e):this._onSpriteAssetLoad(this._system.app.assets.get(e))},onEnable:function(){var e;this._materialAsset&&(e=this._system.app.assets.get(this._materialAsset))&&e.resource!==this._material&&this._bindMaterialAsset(e),this._textureAsset&&(e=this._system.app.assets.get(this._textureAsset))&&e.resource!==this._texture&&this._bindTextureAsset(e),this._spriteAsset&&(e=this._system.app.assets.get(this._spriteAsset))&&e.resource!==this._sprite&&this._bindSpriteAsset(e),this._element.addModelToLayers(this._renderable.model)},onDisable:function(){this._element.removeModelFromLayers(this._renderable.model)},_setStencil:function(e){this._renderable.meshInstance.stencilFront=e,this._renderable.meshInstance.stencilBack=e,e=0,this._element.maskedBy&&(e=this._element.maskedBy.element._image._maskRef),this._renderable.unmaskMeshInstance&&(e=new te.StencilParameters({ref:e+1,func:te.FUNC_EQUAL,zpass:te.STENCILOP_DECREMENT}),this._renderable.unmaskMeshInstance.stencilFront=e,this._renderable.unmaskMeshInstance.stencilBack=e)}}),Object.defineProperty(e.prototype,"color",{get:function(){return this._color},set:function(e){var t=e.r,i=e.g;e=e.b,this._color.r===t&&this._color.g===i&&this._color.b===e||(this._color.r=t,this._color.g=i,this._color.b=e,this._colorUniform[0]=t,this._colorUniform[1]=i,this._colorUniform[2]=e,this._renderable.setParameter("material_emissive",this._colorUniform),this._element&&this._element.fire("set:color",this._color))}}),Object.defineProperty(e.prototype,"opacity",{get:function(){return this._color.a},set:function(e){e!==this._color.a&&(this._color.a=e,this._renderable.setParameter("material_opacity",e),this._element&&this._element.fire("set:opacity",e))}}),Object.defineProperty(e.prototype,"rect",{get:function(){return this._rect},set:function(e){var t,i,s;e=e instanceof te.Vec4?(t=e.x,i=e.y,s=e.z,e.w):(t=e[0],i=e[1],s=e[2],e[3]),t===this._rect.x&&i===this._rect.y&&s===this._rect.z&&e===this._rect.w||(this._rect.set(t,i,s,e),this._renderable.mesh&&(this._element._beingInitialized?this._meshDirty=!0:this._updateMesh(this._renderable.mesh)))}}),Object.defineProperty(e.prototype,"material",{get:function(){return this._material},set:function(e){this._material!==e&&(e||(e=this._element._isScreenSpace(),e=this.mask?e?this._system.defaultScreenSpaceImageMaskMaterial:this._system.defaultImageMaskMaterial:e?this._system.defaultScreenSpaceImageMaterial:this._system.defaultImageMaterial),this._material=e)&&(this._renderable.setMaterial(e),this._hasUserMaterial()?(this._renderable.deleteParameter("material_opacity"),this._renderable.deleteParameter("material_emissive")):(this._colorUniform[0]=this._color.r,this._colorUniform[1]=this._color.g,this._colorUniform[2]=this._color.b,this._renderable.setParameter("material_emissive",this._colorUniform),this._renderable.setParameter("material_opacity",this._color.a)))}}),Object.defineProperty(e.prototype,"materialAsset",{get:function(){return this._materialAsset},set:function(e){var t=this._system.app.assets,i=e;e instanceof te.Asset&&(i=e.id),this._materialAsset!==i&&(this._materialAsset&&(t.off("add:"+this._materialAsset,this._onMaterialAdded,this),e=t.get(this._materialAsset))&&(e.off("load",this._onMaterialLoad,this),e.off("change",this._onMaterialChange,this),e.off("remove",this._onMaterialRemove,this)),(this._materialAsset=i)?(i=t.get(this._materialAsset))?this._bindMaterialAsset(i):(this.material=null,t.on("add:"+this._materialAsset,this._onMaterialAdded,this)):this.material=null)}}),Object.defineProperty(e.prototype,"texture",{get:function(){return this._texture},set:function(e){if(this._texture!==e){if(this._textureAsset){var t=this._system.app.assets.get(this._textureAsset);t&&t.resource!==e&&(this.textureAsset=null)}(this._texture=e)?(this._spriteAsset&&(this.spriteAsset=null),this._renderable.setParameter("texture_emissiveMap",this._texture),this._renderable.setParameter("texture_opacityMap",this._texture),this._colorUniform[0]=this._color.r,this._colorUniform[1]=this._color.g,this._colorUniform[2]=this._color.b,this._renderable.setParameter("material_emissive",this._colorUniform),this._renderable.setParameter("material_opacity",this._color.a)):(this._renderable.deleteParameter("texture_emissiveMap"),this._renderable.deleteParameter("texture_opacityMap"))}}}),Object.defineProperty(e.prototype,"textureAsset",{get:function(){return this._textureAsset},set:function(e){var t=this._system.app.assets,i=e;e instanceof te.Asset&&(i=e.id),this._textureAsset!==i&&(this._textureAsset&&(t.off("add:"+this._textureAsset,this._onTextureAdded,this),e=t.get(this._textureAsset))&&(e.off("load",this._onTextureLoad,this),e.off("change",this._onTextureChange,this),e.off("remove",this._onTextureRemove,this)),(this._textureAsset=i)?(i=t.get(this._textureAsset))?this._bindTextureAsset(i):(this.texture=null,t.on("add:"+this._textureAsset,this._onTextureAdded,this)):this.texture=null)}}),Object.defineProperty(e.prototype,"spriteAsset",{get:function(){return this._spriteAsset},set:function(e){var t=this._system.app.assets,i=e;e instanceof te.Asset&&(i=e.id),this._spriteAsset!==i&&(this._spriteAsset&&(t.off("add:"+this._spriteAsset,this._onSpriteAssetAdded,this),(e=t.get(this._spriteAsset))&&this._unbindSpriteAsset(e)),(this._spriteAsset=i)?(e=t.get(this._spriteAsset))?this._bindSpriteAsset(e):(this.sprite=null,t.on("add:"+this._spriteAsset,this._onSpriteAssetAdded,this)):this.sprite=null,this._element&&this._element.fire("set:spriteAsset",i))}}),Object.defineProperty(e.prototype,"sprite",{get:function(){return this._sprite},set:function(e){if(this._sprite!==e){if(this._sprite&&this._unbindSprite(this._sprite),this._spriteAsset){var t=this._system.app.assets.get(this._spriteAsset);t&&t.resource!==e&&(this.spriteAsset=null)}(this._sprite=e)&&(this._bindSprite(this._sprite),this._textureAsset&&(this.textureAsset=null)),this._sprite&&this._sprite.atlas&&this._sprite.atlas.texture?(this._renderable.setParameter("texture_emissiveMap",this._sprite.atlas.texture),this._renderable.setParameter("texture_opacityMap",this._sprite.atlas.texture)):(this._renderable.deleteParameter("texture_emissiveMap"),this._renderable.deleteParameter("texture_opacityMap")),this._sprite&&(this._spriteFrame=te.math.clamp(this._spriteFrame,0,this._sprite.frameKeys.length-1)),this._updateSprite()}}}),Object.defineProperty(e.prototype,"spriteFrame",{get:function(){return this._spriteFrame},set:function(e){var t=this._spriteFrame;this._spriteFrame=this._sprite?te.math.clamp(e,0,this._sprite.frameKeys.length-1):e,this._spriteFrame!==t&&(this._updateSprite(),this._element&&this._element.fire("set:spriteFrame",e))}}),Object.defineProperty(e.prototype,"mesh",{get:function(){return this._renderable.mesh},set:function(e){this._renderable.setMesh(e),this._defaultMesh===e?this._renderable.setAabbFunc(null):this._renderable.setAabbFunc(this._updateAabbFunc)}}),Object.defineProperty(e.prototype,"mask",{get:function(){return this._mask},set:function(e){this._mask!==e&&(this._mask=e,this._toggleMask())}}),Object.defineProperty(e.prototype,"pixelsPerUnit",{get:function(){return this._pixelsPerUnit},set:function(e){this._pixelsPerUnit!==e&&(this._pixelsPerUnit=e,!this._sprite||this._sprite.renderMode!==te.SPRITE_RENDERMODE_SLICED&&this._sprite.renderMode!==te.SPRITE_RENDERMODE_TILED||this._updateSprite())}}),Object.defineProperty(e.prototype,"aabb",{get:function(){return this._renderable.meshInstance?this._renderable.meshInstance.aabb:null}}),{ImageElement:e}}()),Object.assign(te,(_s=function(){this.quad=this.count=0,this.lines={},this.positions=[],this.normals=[],this.uvs=[],this.colors=[],this.indices=[],this.meshInstance=null},gs=function(e){this._element=e,this._system=e.system,this._entity=e.entity,this._text="",this._symbols=[],this._colorPalette=[],this._i18nKey=this._symbolColors=null,this._fontAsset=new te.LocalizedAsset(this._system.app),this._fontAsset.disableLocalization=!0,this._fontAsset.on("load",this._onFontLoad,this),this._fontAsset.on("change",this._onFontChange,this),this._fontAsset.on("remove",this._onFontRemove,this),this._font=null,this._color=new te.Color(1,1,1,1),this._colorUniform=new Float32Array(3),this._spacing=1,this._fontSize=32,this._fontMaxY=this._fontMinY=0,this._maxFontSize=this._originalFontSize=32,this._minFontSize=8,this._autoFitHeight=this._autoFitWidth=!1,this._maxLines=-1,this._scaledLineHeight=this._lineHeight=32,this._wrapLines=!1,this._drawOrder=0,this._alignment=new te.Vec2(.5,.5),this._autoHeight=this._autoWidth=!0,this.height=this.width=0,this._node=new te.GraphNode,this._model=new te.Model,this._model.graph=this._node,this._entity.addChild(this._node),this._meshInfo=[],this._material=null,this._aabbDirty=!0,this._aabb=new te.BoundingBox,this._noResize=!1,this._maskedMaterialSrc=this._currentMaterialType=null,this._rtl=this._unicodeConverter=this._rtlReorder=!1,this._outlineColor=new te.Color(0,0,0,1),this._outlineColorUniform=new Float32Array(4),this._outlineThicknessScale=.2,this._outlineThickness=0,this._shadowColor=new te.Color(0,0,0,1),this._shadowColorUniform=new Float32Array(4),this._shadowOffsetScale=.005,this._shadowOffset=new te.Vec2(0,0),this._shadowOffsetUniform=new Float32Array(2),this._enableMarkup=!1,this._onScreenChange(this._element.screen),e.on("resize",this._onParentResize,this),e.on("set:screen",this._onScreenChange,this),e.on("screen:set:screenspace",this._onScreenSpaceChange,this),e.on("set:draworder",this._onDrawOrderChange,this),e.on("set:pivot",this._onPivotChange,this),this._system.app.i18n.on("set:locale",this._onLocaleSet,this),this._system.app.i18n.on("data:add",this._onLocalizationData,this),this._system.app.i18n.on("data:remove",this._onLocalizationData,this),this._rangeEnd=this._rangeStart=0},ys=/^[\r\n]$/,vs=/^[ \t]$/,bs=/^[ \t\-]$/,Object.assign(gs.prototype,{destroy:function(){this._setMaterial(null),this._model&&(this._element.removeModelFromLayers(this._model),this._model.destroy(),this._model=null),this._fontAsset.destroy(),this.font=null,this._element.off("resize",this._onParentResize,this),this._element.off("set:screen",this._onScreenChange,this),this._element.off("screen:set:screenspace",this._onScreenSpaceChange,this),this._element.off("set:draworder",this._onDrawOrderChange,this),this._element.off("set:pivot",this._onPivotChange,this),this._system.app.i18n.off("set:locale",this._onLocaleSet,this),this._system.app.i18n.off("data:add",this._onLocalizationData,this),this._system.app.i18n.off("data:remove",this._onLocalizationData,this)},_onParentResize:function(e,t){this._noResize||this._font&&this._updateText()},_onScreenChange:function(e){e?this._updateMaterial(e.screen.screenSpace):this._updateMaterial(!1)},_onScreenSpaceChange:function(e){this._updateMaterial(e)},_onDrawOrderChange:function(e){var t,i;if(this._drawOrder=e,this._model)for(t=0,i=this._model.meshInstances.length;t<i;t++)this._model.meshInstances[t].drawOrder=e},_onPivotChange:function(e){this._font&&this._updateText()},_onLocaleSet:function(e){this._i18nKey&&(this.fontAsset&&((e=this._system.app.assets.get(this.fontAsset))&&e.resource&&e.resource===this._font||(this.font=null)),this._resetLocalizedText())},_onLocalizationData:function(e,t){this._i18nKey&&t[this._i18nKey]&&this._resetLocalizedText()},_resetLocalizedText:function(){this._setText(this._system.app.i18n.getText(this._i18nKey))},_setText:function(e){if(this.unicodeConverter){var t=this._system.getUnicodeConverter();t&&(e=t(e))}this._text!==e&&(this._font&&this._updateText(e),this._text=e)},_updateText:function(e){var t,i;if(void 0===e&&(e=this._text),this._symbols=te.string.getSymbols(e),0===this._symbols.length&&(this._symbols=[" "]),this._enableMarkup&&(e=te.Markup.evaluate(this._symbols),this._symbols=e.symbols,i=e.tags),this._rtlReorder?(e=this._system.app.systems.element.getRtlReorder())&&(e=e(this._symbols),this._rtl=e.rtl,this._symbols=e.mapping.map(function(e){return this._symbols[e]},this),i&&(i=e.mapping.map(function(e){return i[e]}))):this._rtl=!1,i){var s={};for(this._colorPalette=[Math.round(255*this._color.r),Math.round(255*this._color.g),Math.round(255*this._color.b)],this._symbolColors=[],e=s[this._color.toString(!1).toLowerCase()]=0,t=this._symbols.length;e<t;++e){var n=0;(r=i[e])&&r.color&&r.color.value&&7===(r=r.color.value).length&&"#"===r[0]&&(r=r.substring(1).toLowerCase(),s.hasOwnProperty(r)?n=s[r]:/^([0-9a-f]{2}){3}$/.test(r)&&(n=this._colorPalette.length/3,s[r]=n,this._colorPalette.push(parseInt(r.substring(0,2),16)),this._colorPalette.push(parseInt(r.substring(2,4),16)),this._colorPalette.push(parseInt(r.substring(4,6),16)))),this._symbolColors.push(n)}}else this._colorPalette=[],this._symbolColors=null;s=this._calculateCharsPerTexture(),n=!1;var a=this._element,r=a._isScreenSpace(),o=a._isScreenCulled(),h=function(e){return a.isVisibleForCamera(e)};for(e=0,t=this._meshInfo.length;e<t;e++){var l=s[e]||0,c=this._meshInfo[e];if(c.count!==l)if(n||(a.removeModelFromLayers(this._model),n=!0),c.count=l,c.positions.length=c.normals.length=12*l,c.indices.length=6*l,c.uvs.length=8*l,c.colors.length=16*l,c.meshInstance&&(this._removeMeshInstance(c.meshInstance),c.meshInstance.material=null),0===l)c.meshInstance=null;else{for(var d=0;d<l;d++)c.indices[6*d+0]=4*d,c.indices[6*d+1]=4*d+1,c.indices[6*d+2]=4*d+3,c.indices[6*d+3]=4*d+2,c.indices[6*d+4]=4*d+3,c.indices[6*d+5]=4*d+1,c.normals[12*d+0]=0,c.normals[12*d+1]=0,c.normals[12*d+2]=-1,c.normals[12*d+3]=0,c.normals[12*d+4]=0,c.normals[12*d+5]=-1,c.normals[12*d+6]=0,c.normals[12*d+7]=0,c.normals[12*d+8]=-1,c.normals[12*d+9]=0,c.normals[12*d+10]=0,c.normals[12*d+11]=-1;l=te.createMesh(this._system.app.graphicsDevice,c.positions,{uvs:c.uvs,normals:c.normals,colors:c.colors,indices:c.indices}),(l=new te.MeshInstance(this._node,l,this._material)).name="Text Element: "+this._entity.name,l.castShadow=!1,l.receiveShadow=!1,l.cull=!r,l.screenSpace=r,l.drawOrder=this._drawOrder,o&&(l.cull=!0,l.isVisibleFunc=h),this._setTextureParams(l,this._font.textures[e]),this._symbolColors?(this._colorUniform[0]=1,this._colorUniform[1]=1,this._colorUniform[2]=1):(this._colorUniform[0]=this._color.r,this._colorUniform[1]=this._color.g,this._colorUniform[2]=this._color.b),l.setParameter("material_emissive",this._colorUniform),l.setParameter("material_opacity",this._color.a),l.setParameter("font_sdfIntensity",this._font.intensity),l.setParameter("font_pxrange",this._getPxRange(this._font)),l.setParameter("font_textureWidth",this._font.data.info.maps[e].width),this._outlineColorUniform[0]=this._outlineColor.r,this._outlineColorUniform[1]=this._outlineColor.g,this._outlineColorUniform[2]=this._outlineColor.b,this._outlineColorUniform[3]=this._outlineColor.a,l.setParameter("outline_color",this._outlineColorUniform),l.setParameter("outline_thickness",this._outlineThicknessScale*this._outlineThickness),this._shadowColorUniform[0]=this._shadowColor.r,this._shadowColorUniform[1]=this._shadowColor.g,this._shadowColorUniform[2]=this._shadowColor.b,this._shadowColorUniform[3]=this._shadowColor.a,l.setParameter("shadow_color",this._shadowColorUniform),d=this._font.data.info.maps[e].width/this._font.data.info.maps[e].height,this._shadowOffsetUniform[0]=this._shadowOffsetScale*this._shadowOffset.x,this._shadowOffsetUniform[1]=d*this._shadowOffsetScale*this._shadowOffset.y,l.setParameter("shadow_offset",this._shadowOffsetUniform),c.meshInstance=l,this._model.meshInstances.push(l)}}this._element.maskedBy&&this._element._setMaskedBy(this._element.maskedBy),n&&this._element.enabled&&this._entity.enabled&&this._element.addModelToLayers(this._model),this._updateMeshes(),this._rangeStart=0,this._rangeEnd=this._symbols.length,this._updateRenderRange()},_removeMeshInstance:function(e){var t,i,s=e.mesh;if(s&&(s.vertexBuffer&&s.vertexBuffer.destroy(),s.indexBuffer))for(t=0,i=s.indexBuffer.length;t<i;t++)s.indexBuffer[t].destroy();-1!==(e=this._model.meshInstances.indexOf(e))&&this._model.meshInstances.splice(e,1)},_setMaterial:function(e){var t,i;if(this._material=e,this._model)for(t=0,i=this._model.meshInstances.length;t<i;t++)this._model.meshInstances[t].material=e},_updateMaterial:function(e){var t=this._element,i=t._isScreenCulled(),s=function(e){return t.isVisibleForCamera(e)};if(this._material=this._system.getTextElementMaterial(e,this._font&&this._font.type===te.FONT_MSDF),this._model)for(var n=0,a=this._model.meshInstances.length;n<a;n++){var r=this._model.meshInstances[n];r.cull=!e,r.material=this._material,r.screenSpace=e,i?(r.cull=!0,r.isVisibleFunc=s):r.isVisibleFunc=null}},_updateMeshes:function(){function e(e,t,i){if(s._lineWidths.push(Math.abs(i)),e=e.slice(t<f?t+1:f,t<f?f+1:t),g)for(i=e.length;i--&&0<g;)ys.test(e[i])&&(e.splice(i,1),g--);s._lineContents.push(e.join("")),o=0,h-=s._scaledLineHeight,d++,u=g=_=m=0,f=t}var t=this._font.data,s=this,i=Math.min(this._minFontSize,this._maxFontSize),n=this._maxFontSize,a=this._shouldAutoFit();a&&(this._fontSize=this._maxFontSize);var r=this._symbols.length,o=0,h=0,l=0,c=0,d=1,u=0,p=0,f=0,m=0,_=0,g=0,y=1e-4<=Math.abs(this._element.anchor.x-this._element.anchor.z),v=this._element.calculatedWidth;(this.autoWidth&&!y||!this._wrapLines)&&(v=Number.POSITIVE_INFINITY);for(var b,S,T,E=0,x=(y=0,1),A=!0;A;){for(A=!1,this._scaledLineHeight=a?this._lineHeight*this._fontSize/(this._maxFontSize||1e-4):this._lineHeight,this.height=this.width=0,this._lineWidths=[],this._lineContents=[],c=l=h=o=0,d=1,g=_=m=f=p=u=0,x=this._fontSize/32,E=this._fontMinY*x,y=this._fontMaxY*x,T=0;T<this._meshInfo.length;T++)this._meshInfo[T].quad=0,this._meshInfo[T].lines={};var M=255,C=255,P=255;for(T=0;T<r;T++){b=this._symbols[T];var I,w=0,O=0,R=0,L=1;if(!(S=t.chars[b]))if(t.chars[" "])S=t.chars[" "];else for(var D in t.chars){S=t.chars[D];break}if(S){var N=0;0<_&&(R=this._font.data.kerning)&&(R=R[te.string.getCodePoint(this._symbols[T-1])||0])&&(N=R[te.string.getCodePoint(this._symbols[T])||0]||0),R=S.scale||1,L=x*(I=(S.width+S.height)/2)/R,R=(S.xadvance+N)*x,w=(S.xoffset-N)*x,O=S.yoffset*x}if(I=ys.test(b))g++,(this._maxLines<0||d<this._maxLines)&&(e(this._symbols,T,c),f=p=T+1);else{var F=vs.test(b),B=(N=this._meshInfo[S&&S.map||0],o+this._spacing*R);if(v<B&&0<_&&!F&&(this._maxLines<0||d<this._maxLines)){if(0!==m){if(S=Math.max(T-p,0),this._meshInfo.length<=1)N.lines[d-1]-=S,N.quad-=S;else for(N=T,b=p;b<N;b++)R=t.chars[this._symbols[b]],--(R=this._meshInfo[R&&R.map||0]).lines[d-1],--R.quad;T-=S+1,e(this._symbols,p,u);continue}p=T,e(this._symbols,T,c)}S=N.quad,N.lines[d-1]=S;var k=(w=o-w)+L;if(L=(O=h-O)+L,N.positions[12*S+0]=w,N.positions[12*S+1]=O,N.positions[12*S+2]=l,N.positions[12*S+3]=k,N.positions[12*S+4]=O,N.positions[12*S+5]=l,N.positions[12*S+6]=k,N.positions[12*S+7]=L,N.positions[12*S+8]=l,N.positions[12*S+9]=w,N.positions[12*S+10]=L,N.positions[12*S+11]=l,this.width=Math.max(this.width,B),this._shouldAutoFitWidth()&&this.width>this._element.calculatedWidth&&(L=Math.floor(this._element.fontSize*this._element.calculatedWidth/(this.width||1e-4)),(L=te.math.clamp(L,i,n))!==this._element.fontSize)){this._fontSize=L,A=!0;break}if(this.height=Math.max(this.height,y-(h+E)),this._shouldAutoFitHeight()&&this.height>this._element.calculatedHeight&&(L=te.math.clamp(this._fontSize-1,i,n))!==this._element.fontSize){this._fontSize=L,A=!0;break}o+=this._spacing*R,F||I||(c=o),bs.test(b)&&(m++,u=c,p=T+1),_++,b=this._getUv(b),N.uvs[8*S+0]=b[0],N.uvs[8*S+1]=b[1],N.uvs[8*S+2]=b[2],N.uvs[8*S+3]=b[1],N.uvs[8*S+4]=b[2],N.uvs[8*S+5]=b[3],N.uvs[8*S+6]=b[0],N.uvs[8*S+7]=b[3],this._symbolColors&&(P=3*this._symbolColors[T],M=this._colorPalette[P],C=this._colorPalette[P+1],P=this._colorPalette[P+2]),N.colors[16*S+0]=M,N.colors[16*S+1]=C,N.colors[16*S+2]=P,N.colors[16*S+3]=255,N.colors[16*S+4]=M,N.colors[16*S+5]=C,N.colors[16*S+6]=P,N.colors[16*S+7]=255,N.colors[16*S+8]=M,N.colors[16*S+9]=C,N.colors[16*S+10]=P,N.colors[16*S+11]=255,N.colors[16*S+12]=M,N.colors[16*S+13]=C,N.colors[16*S+14]=P,N.colors[16*S+15]=255,N.quad++}}A||f<r&&e(this._symbols,r,o)}for(this._noResize=!0,this.autoWidth=this._autoWidth,this.autoHeight=this._autoHeight,this._noResize=!1,t=this._element.pivot.x,i=this._element.pivot.y,n=this._alignment.x,a=this._alignment.y,T=0;T<this._meshInfo.length;T++)if(0!==this._meshInfo[T].count){var V;for(V in v=0,this._meshInfo[T].lines){for(r=this._meshInfo[T].lines[V],S=this._lineWidths[parseInt(V,10)],D=-t*this._element.calculatedWidth+n*(this._element.calculatedWidth-S),l=(1-i)*this._element.calculatedHeight-y-(1-a)*(this._element.calculatedHeight-this.height),S=v;S<=r;S++)this._meshInfo[T].positions[12*S]+=D,this._meshInfo[T].positions[12*S+3]+=D,this._meshInfo[T].positions[12*S+6]+=D,this._meshInfo[T].positions[12*S+9]+=D,this._meshInfo[T].positions[12*S+1]+=l,this._meshInfo[T].positions[12*S+4]+=l,this._meshInfo[T].positions[12*S+7]+=l,this._meshInfo[T].positions[12*S+10]+=l;if(this._rtl)for(S=v;S<=r;S++){for(v=12*S,D=0;D<4;++D)this._meshInfo[T].positions[v+3*D]=-(this._element.calculatedWidth+this._meshInfo[T].positions[v+3*D]);D=this._meshInfo[T].positions[v+3],l=this._meshInfo[T].positions[v+6],this._meshInfo[T].positions[v+3]=this._meshInfo[T].positions[v+0],this._meshInfo[T].positions[v+6]=this._meshInfo[T].positions[v+9],this._meshInfo[T].positions[v+0]=D,this._meshInfo[T].positions[v+9]=l}v=r+1}for(r=4*this._meshInfo[T].count,v=4*this._meshInfo[T].quad,S=new te.VertexIterator(this._meshInfo[T].meshInstance.mesh.vertexBuffer),D=0;D<r;D++)v<=D?(S.element[te.SEMANTIC_POSITION].set(0,0,0),S.element[te.SEMANTIC_TEXCOORD0].set(0,0),S.element[te.SEMANTIC_COLOR].set(0,0,0,0)):(S.element[te.SEMANTIC_POSITION].set(this._meshInfo[T].positions[3*D+0],this._meshInfo[T].positions[3*D+1],this._meshInfo[T].positions[3*D+2]),S.element[te.SEMANTIC_TEXCOORD0].set(this._meshInfo[T].uvs[2*D+0],this._meshInfo[T].uvs[2*D+1]),S.element[te.SEMANTIC_COLOR].set(this._meshInfo[T].colors[4*D+0],this._meshInfo[T].colors[4*D+1],this._meshInfo[T].colors[4*D+2],this._meshInfo[T].colors[4*D+3])),S.next();S.end(),this._meshInfo[T].meshInstance.mesh.aabb.compute(this._meshInfo[T].positions),this._meshInfo[T].meshInstance._aabbVer=-1}this._aabbDirty=!0},_onFontRender:function(){this.font=this._font},_onFontLoad:function(e){this.font!==e.resource&&(this.font=e.resource)},_onFontChange:function(e,t,i,s){if("data"===t)for(this._font.data=i,e=this._font.data.info.maps.length,t=0;t<e;t++)this._meshInfo[t]&&(i=this._meshInfo[t].meshInstance)&&(i.setParameter("font_sdfIntensity",this._font.intensity),i.setParameter("font_pxrange",this._getPxRange(this._font)),i.setParameter("font_textureWidth",this._font.data.info.maps[t].width))},_onFontRemove:function(e){},_setTextureParams:function(e,t){this._font&&(this._font.type===te.FONT_MSDF?(e.deleteParameter("texture_emissiveMap"),e.deleteParameter("texture_opacityMap"),e.setParameter("texture_msdfMap",t)):this._font.type===te.FONT_BITMAP&&(e.deleteParameter("texture_msdfMap"),e.setParameter("texture_emissiveMap",t),e.setParameter("texture_opacityMap",t)))},_getPxRange:function(e){e=Object.keys(this._font.data.chars);for(var t=0;t<e.length;t++){var i=this._font.data.chars[e[t]];if(i.range)return(i.scale||1)*i.range}return 2},_getUv:function(e){var t=this._font.data;if(!t.chars[e])return t.chars[" "]?this._getUv(" "):[0,0,0,0];var i=t.chars[e].map,s=t.info.maps[i].width,n=(i=t.info.maps[i].height,t.chars[e].x),a=t.chars[e].y,r=1-t.chars[e].height/i;return[n/s,r-a/i,(n+t.chars[e].width)/s,r-(a-t.chars[e].height)/i]},onEnable:function(){this._fontAsset.autoLoad=!0,this._model&&this._element.addModelToLayers(this._model)},onDisable:function(){this._fontAsset.autoLoad=!1,this._model&&this._element.removeModelFromLayers(this._model)},_setStencil:function(e){if(this._model)for(var t=this._model.meshInstances,i=0;i<t.length;i++)t[i].stencilFront=e,t[i].stencilBack=e},_shouldAutoFitWidth:function(){return this._autoFitWidth&&!this._autoWidth},_shouldAutoFitHeight:function(){return this._autoFitHeight&&!this._autoHeight},_shouldAutoFit:function(){return this._autoFitWidth&&!this._autoWidth||this._autoFitHeight&&!this._autoHeight},_calculateCharsPerTexture:function(e){var t,i,s={};for(void 0===e&&(e=this._symbols.length),t=0;t<e;t++)i=this._symbols[t],(i=this._font.data.chars[i])||(i=this._font.data.chars[" "])||(i=this._font.data.chars[Object.keys(this._font.data.chars)[0]]),s[i=i.map]?s[i]++:s[i]=1;return s},_updateRenderRange:function(){var e,t,i=0===this._rangeStart?0:this._calculateCharsPerTexture(this._rangeStart),s=0===this._rangeEnd?0:this._calculateCharsPerTexture(this._rangeEnd);for(e=0,t=this._meshInfo.length;e<t;e++){var n=i[e]||0,a=s[e]||0,r=this._meshInfo[e].meshInstance;r&&(r=r.mesh)&&(r.primitive[0].base=6*n,r.primitive[0].count=6*(a-n))}}}),Object.defineProperty(gs.prototype,"text",{get:function(){return this._text},set:function(e){this._i18nKey=null,this._setText(e&&e.toString()||"")}}),Object.defineProperty(gs.prototype,"key",{get:function(){return this._i18nKey},set:function(e){e=null!==e?e.toString():null,this._i18nKey!==e&&((this._i18nKey=e)?(this._fontAsset.disableLocalization=!1,this._resetLocalizedText()):this._fontAsset.disableLocalization=!0)}}),Object.defineProperty(gs.prototype,"color",{get:function(){return this._color},set:function(e){var t=e.r,i=e.g;if(e=e.b,this._color.r!==t||this._color.g!==i||this._color.b!==e)if(this._color.r=t,this._color.g=i,this._color.b=e,this._symbolColors)this._font&&this._updateText();else for(this._colorUniform[0]=this._color.r,this._colorUniform[1]=this._color.g,this._colorUniform[2]=this._color.b,t=0,i=this._model.meshInstances.length;t<i;t++)this._model.meshInstances[t].setParameter("material_emissive",this._colorUniform)}}),Object.defineProperty(gs.prototype,"opacity",{get:function(){return this._color.a},set:function(e){if(this._color.a!==e&&(this._color.a=e,this._model))for(var t=0,i=this._model.meshInstances.length;t<i;t++)this._model.meshInstances[t].setParameter("material_opacity",e)}}),Object.defineProperty(gs.prototype,"lineHeight",{get:function(){return this._lineHeight},set:function(e){var t=this._lineHeight;this._scaledLineHeight=this._lineHeight=e,t!==e&&this._font&&this._updateText()}}),Object.defineProperty(gs.prototype,"wrapLines",{get:function(){return this._wrapLines},set:function(e){this._wrapLines!==(this._wrapLines=e)&&this._font&&this._updateText()}}),Object.defineProperty(gs.prototype,"lines",{get:function(){return this._lineContents}}),Object.defineProperty(gs.prototype,"spacing",{get:function(){return this._spacing},set:function(e){this._spacing!==(this._spacing=e)&&this._font&&this._updateText()}}),Object.defineProperty(gs.prototype,"fontSize",{get:function(){return this._fontSize},set:function(e){var t=this._fontSize;this._originalFontSize=this._fontSize=e,t!==e&&this._font&&this._updateText()}}),Object.defineProperty(gs.prototype,"fontAsset",{get:function(){return this._fontAsset.localizedAsset},set:function(e){this._fontAsset.defaultAsset=e}}),Object.defineProperty(gs.prototype,"font",{get:function(){return this._font},set:function(e){var t;if(this._font&&(t=this._font.type,this._font.off&&this._font.off("render",this._onFontRender,this)),this._font=e,this._fontMaxY=this._fontMinY=0,e){var i,s=this._font.data;for(i in s.chars){var n=s.chars[i];n.bounds&&(this._fontMinY=Math.min(this._fontMinY,n.bounds[1]),this._fontMaxY=Math.max(this._fontMaxY,n.bounds[3]))}for(this._font.on&&this._font.on("render",this._onFontRender,this),this._fontAsset.localizedAsset&&this._system.app.assets.get(this._fontAsset.localizedAsset).resource!==this._font&&(this._fontAsset.defaultAsset=null),e.type!==t&&(e=this._element._isScreenSpace(),this._updateMaterial(e)),e=0,t=this._font.textures.length;e<t;e++)this._meshInfo[e]?(s=this._meshInfo[e].meshInstance)&&(s.setParameter("font_sdfIntensity",this._font.intensity),s.setParameter("font_pxrange",this._getPxRange(this._font)),s.setParameter("font_textureWidth",this._font.data.info.maps[e].width),this._setTextureParams(s,this._font.textures[e])):this._meshInfo[e]=new _s;for(t=!1,e=this._font.textures.length;e<this._meshInfo.length;e++)this._meshInfo[e].meshInstance&&(t||(this._element.removeModelFromLayers(this._model),t=!0),this._removeMeshInstance(this._meshInfo[e].meshInstance));this._meshInfo.length>this._font.textures.length&&(this._meshInfo.length=this._font.textures.length),this._updateText()}}}),Object.defineProperty(gs.prototype,"alignment",{get:function(){return this._alignment},set:function(e){e instanceof te.Vec2?this._alignment.set(e.x,e.y):this._alignment.set(e[0],e[1]),this._font&&this._updateText()}}),Object.defineProperty(gs.prototype,"autoWidth",{get:function(){return this._autoWidth},set:function(e){var t=this._autoWidth;(this._autoWidth=e)&&Math.abs(this._element.anchor.x-this._element.anchor.z)<1e-4&&(this._element.width=this.width),t!==e&&(e=this._shouldAutoFit()?this._maxFontSize:this._originalFontSize)!==this._fontSize&&(this._fontSize=e,this._font&&this._updateText())}}),Object.defineProperty(gs.prototype,"autoHeight",{get:function(){return this._autoHeight},set:function(e){var t=this._autoHeight;(this._autoHeight=e)&&Math.abs(this._element.anchor.y-this._element.anchor.w)<1e-4&&(this._element.height=this.height),t!==e&&(e=this._shouldAutoFit()?this._maxFontSize:this._originalFontSize)!==this._fontSize&&(this._fontSize=e,this._font&&this._updateText())}}),Object.defineProperty(gs.prototype,"rtlReorder",{get:function(){return this._rtlReorder},set:function(e){this._rtlReorder!==e&&(this._rtlReorder=e,this._font&&this._updateText())}}),Object.defineProperty(gs.prototype,"unicodeConverter",{get:function(){return this._unicodeConverter},set:function(e){this._unicodeConverter!==e&&(this._unicodeConverter=e,this.text=this._text)}}),Object.defineProperty(gs.prototype,"aabb",{get:function(){if(this._aabbDirty){for(var e=!1,t=0;t<this._meshInfo.length;t++)this._meshInfo[t].meshInstance&&(e?this._aabb.add(this._meshInfo[t].meshInstance.aabb):(this._aabb.copy(this._meshInfo[t].meshInstance.aabb),e=!0));this._aabbDirty=!1}return this._aabb}}),Object.defineProperty(gs.prototype,"outlineColor",{get:function(){return this._outlineColor},set:function(e){var t=e instanceof te.Color?e.r:e[0],i=e instanceof te.Color?e.g:e[1],s=e instanceof te.Color?e.b:e[2];if(e=e instanceof te.Color?e.a:e[3],(this._outlineColor.r!==t||this._outlineColor.g!==i||this._outlineColor.b!==s||this._outlineColor.a!==e)&&(this._outlineColor.r=t,this._outlineColor.g=i,this._outlineColor.b=s,this._outlineColor.a=e,this._model))for(this._outlineColorUniform[0]=this._outlineColor.r,this._outlineColorUniform[1]=this._outlineColor.g,this._outlineColorUniform[2]=this._outlineColor.b,this._outlineColorUniform[3]=this._outlineColor.a,t=0,i=this._model.meshInstances.length;t<i;t++)this._model.meshInstances[t].setParameter("outline_color",this._outlineColorUniform)}}),Object.defineProperty(gs.prototype,"outlineThickness",{get:function(){return this._outlineThickness},set:function(e){var t=this._outlineThickness;if(t!==(this._outlineThickness=e)&&this._font&&this._model)for(e=0,t=this._model.meshInstances.length;e<t;e++)this._model.meshInstances[e].setParameter("outline_thickness",this._outlineThicknessScale*this._outlineThickness)}}),Object.defineProperty(gs.prototype,"shadowColor",{get:function(){return this._shadowColor},set:function(e){var t=e instanceof te.Color?e.r:e[0],i=e instanceof te.Color?e.g:e[1],s=e instanceof te.Color?e.b:e[2];if(e=e instanceof te.Color?e.a:e[3],(this._shadowColor.r!==t||this._shadowColor.g!==i||this._shadowColor.b!==s||this._shadowColor.a!==e)&&(this._shadowColor.r=t,this._shadowColor.g=i,this._shadowColor.b=s,this._shadowColor.a=e,this._model))for(this._shadowColorUniform[0]=this._shadowColor.r,this._shadowColorUniform[1]=this._shadowColor.g,this._shadowColorUniform[2]=this._shadowColor.b,this._shadowColorUniform[3]=this._shadowColor.a,t=0,i=this._model.meshInstances.length;t<i;t++)this._model.meshInstances[t].setParameter("shadow_color",this._shadowColorUniform)}}),Object.defineProperty(gs.prototype,"shadowOffset",{get:function(){return this._shadowOffset},set:function(e){var t=e instanceof te.Vec2?e.x:e[0];if(e=e instanceof te.Vec2?e.y:e[1],(this._shadowOffset.x!==t||this._shadowOffset.y!==e)&&(this._shadowOffset.set(t,e),this._font&&this._model))for(t=0,e=this._model.meshInstances.length;t<e;t++){var i=this._font.data.info.maps[t].width/this._font.data.info.maps[t].height;this._shadowOffsetUniform[0]=this._shadowOffsetScale*this._shadowOffset.x,this._shadowOffsetUniform[1]=i*this._shadowOffsetScale*this._shadowOffset.y,this._model.meshInstances[t].setParameter("shadow_offset",this._shadowOffsetUniform)}}}),Object.defineProperty(gs.prototype,"minFontSize",{get:function(){return this._minFontSize},set:function(e){this._minFontSize!==e&&(this._minFontSize=e,this.font&&this._shouldAutoFit()&&this._updateText())}}),Object.defineProperty(gs.prototype,"maxFontSize",{get:function(){return this._maxFontSize},set:function(e){this._maxFontSize!==e&&(this._maxFontSize=e,this.font&&this._shouldAutoFit()&&this._updateText())}}),Object.defineProperty(gs.prototype,"autoFitWidth",{get:function(){return this._autoFitWidth},set:function(e){this._autoFitWidth!==e&&(this._autoFitWidth=e,this._fontSize=this._shouldAutoFit()?this._maxFontSize:this._originalFontSize,this.font&&this._updateText())}}),Object.defineProperty(gs.prototype,"autoFitHeight",{get:function(){return this._autoFitHeight},set:function(e){this._autoFitHeight!==e&&(this._autoFitHeight=e,this._fontSize=this._shouldAutoFit()?this._maxFontSize:this._originalFontSize,this.font&&this._updateText())}}),Object.defineProperty(gs.prototype,"maxLines",{get:function(){return this._maxLines},set:function(e){this._maxLines===e||null===e&&-1===this._maxLines||(this._maxLines=null===e?-1:e,this.font&&this._wrapLines&&this._updateText())}}),Object.defineProperty(gs.prototype,"enableMarkup",{get:function(){return this._enableMarkup},set:function(e){e=!!e,this._enableMarkup!==e&&(this._enableMarkup=e,this.font&&this._updateText())}}),Object.defineProperty(gs.prototype,"symbols",{get:function(){return this._symbols}}),Object.defineProperty(gs.prototype,"symbolColors",{get:function(){return null===this._symbolColors?null:this._symbolColors.map(function(e){return this._colorPalette.slice(3*e,3*e+3)},this)}}),Object.defineProperty(gs.prototype,"rtl",{get:function(){return this._rtl}}),Object.defineProperty(gs.prototype,"rangeStart",{get:function(){return this._rangeStart},set:function(e){(e=Math.max(0,Math.min(e,this._symbols.length)))!==this._rangeStart&&(this._rangeStart=e,this._updateRenderRange())}}),Object.defineProperty(gs.prototype,"rangeEnd",{get:function(){return this._rangeEnd},set:function(e){(e=Math.max(this._rangeStart,Math.min(e,this._symbols.length)))!==this._rangeEnd&&(this._rangeEnd=e,this._updateRenderRange())}}),{TextElement:gs})),Object.assign(te,function(){function a(e,t){for(var i in t)if(t.hasOwnProperty(i)){var s=t[i];s instanceof Object?(e.hasOwnProperty(i)||(e[i]={}),a(e[i],t[i])):e[i]=s}}function c(e){if(0===e.length)return null;for(var t={},i=0;i<e.length;++i){var s=e[i],n={};n[s.name]={value:s.value,attributes:s.attributes},a(t,n)}return t}function t(e){var t=new n(e),i=[],s=[];return t.parse(i,s)?(t=s.find(function(e){return null===e.end}))?{symbols:e,tags:null}:{symbols:i,tags:e=function(e,t){function i(e){o=o.filter(function(t){return void 0===e.find(function(e){return e===t})})}function s(e){for(var t=0;t<e.length;++t)o.push(e[t])}var n;if(0===e.length)return null;var a={};for(n=0;n<e.length;++n){var r=e[n];a.hasOwnProperty(r.start)?null===a[r.start].open?a[r.start].open=[r]:a[r.start].open.push(r):a[r.start]={open:[r],close:null},a.hasOwnProperty(r.end)?null===a[r.end].close?a[r.end].close=[r]:a[r.end].close.push(r):a[r.end]={open:null,close:[r]}}var o=[],h=Object.keys(a).sort(function(e,t){return e-t});for(r=[],n=0;n<h.length;++n){var l=a[h[n]];null!==l.close&&i(l.close),null!==l.open&&s(l.open),r.push({start:h[n],tags:c(o)})}for(a=[],h=null,n=0;n<r.length;++n){for(l=r[n];a.length<l.start;)a.push(h?h.tags:null);h=l}for(;a.length<t;)a.push(null);return a}(s,i.length)}:{symbols:e,tags:null}}var i=function(e){this._symbols=e,this._last=this._index=0,this._cur=0<this._symbols.length?this._symbols[0]:null,this._buf=[],this._mode="text",this._error=null};Object.assign(i.prototype,{EOF_TOKEN:0,ERROR_TOKEN:1,TEXT_TOKEN:2,OPEN_BRACKET_TOKEN:3,CLOSE_BRACKET_TOKEN:4,EQUALS_TOKEN:5,STRING_TOKEN:6,IDENTIFIER_TOKEN:7,WHITESPACE_TOKEN:8,WHITESPACE_CHARS:" \t\n\r\v\f",IDENTIFIER_REGEX:/[A-Z|a-z|0-9|_|-|/]/,read:function(){for(var e=this._read();e===this.WHITESPACE_TOKEN;)e=this._read();return e!==this.EOF_TOKEN&&e!==this.ERROR_TOKEN&&(this._last=this._index),e},buf:function(){return this._buf},last:function(){return this._last},error:function(){return this._error},debugPrint:function(){for(var e="EOF ERROR TEXT OPEN_BRACKET CLOSE_BRACKET EQUALS STRING IDENTIFIER WHITESPACE".split(" "),t=this.read(),i="";i+=(0<i.length?"\n":"")+e[t]+" '"+this.buf().join("")+"'",t!==this.EOF_TOKEN&&t!==this.ERROR_TOKEN;)t=this.read();return i},_read:function(){return this._buf=[],this._eof()?this.EOF_TOKEN:"text"===this._mode?this._text():this._tag()},_text:function(){for(;;)switch(this._cur){case null:return 0<this._buf.length?this.TEXT_TOKEN:this.EOF_TOKEN;case"[":return this._mode="tag",0<this._buf.length?this.TEXT_TOKEN:this._tag();case"\\":switch(this._next(),this._cur){case"[":this._store();break;default:this._output("\\")}break;default:this._store()}},_tag:function(){for(;;)switch(this._cur){case null:return this._error="unexpected end of input reading tag",this.ERROR_TOKEN;case"[":return this._store(),this.OPEN_BRACKET_TOKEN;case"]":return this._store(),this._mode="text",this.CLOSE_BRACKET_TOKEN;case"=":return this._store(),this.EQUALS_TOKEN;case" ":case"\t":case"\n":case"\r":case"\v":case"\f":return this._whitespace();case'"':return this._string();default:return this._isIdentifierSymbol(this._cur)?this._identifier():(this._error="unrecognized character",this.ERROR_TOKEN)}},_whitespace:function(){for(this._store();-1!==this.WHITESPACE_CHARS.indexOf(this._cur);)this._store();return this.WHITESPACE_TOKEN},_string:function(){for(this._next();;)switch(this._cur){case null:return this._error="unexpected end of input reading string",this.ERROR_TOKEN;case'"':return this._next(),this.STRING_TOKEN;default:this._store()}},_identifier:function(){for(this._store();null!==this._cur&&this._isIdentifierSymbol(this._cur);)this._store();return this.IDENTIFIER_TOKEN},_isIdentifierSymbol:function(e){return 1===e.length&&null!==e.match(this.IDENTIFIER_REGEX)},_eof:function(){return null===this._cur},_next:function(){return this._eof()||(this._index++,this._cur=this._index<this._symbols.length?this._symbols[this._index]:null),this._cur},_store:function(){return this._buf.push(this._cur),this._next()},_output:function(e){this._buf.push(e)}});var n=function(e){this._scanner=new i(e),this._error=null};Object.assign(n.prototype,{parse:function(e,t){for(;;)switch(this._scanner.read()){case this._scanner.EOF_TOKEN:return!0;case this._scanner.ERROR_TOKEN:return!1;case this._scanner.TEXT_TOKEN:Array.prototype.push.apply(e,this._scanner.buf());break;case this._scanner.OPEN_BRACKET_TOKEN:if(!this._parseTag(e,t))return!1;break;default:return!1}},error:function(){return"Error evaluating markup at #"+this._scanner.last().toString()+" ("+(this._scanner.error()||this._error)+")"},_parseTag:function(e,t){var i=this._scanner.read();if(i!==this._scanner.IDENTIFIER_TOKEN)return!(this._error="expected identifier");var s=this._scanner.buf().join("");if("/"===s[0]){for(var n=t.length-1;0<=n;--n)if(s==="/"+t[n].name&&null===t[n].end)return t[n].end=e.length,(i=this._scanner.read())===this._scanner.CLOSE_BRACKET_TOKEN||!(this._error="expected close bracket");return!(this._error="failed to find matching tag")}if(s={name:s,value:null,attributes:{},start:e.length,end:null},(i=this._scanner.read())===this._scanner.EQUALS_TOKEN){if((i=this._scanner.read())!==this._scanner.STRING_TOKEN)return!(this._error="expected string");s.value=this._scanner.buf().join(""),i=this._scanner.read()}for(;;){switch(i){case this._scanner.CLOSE_BRACKET_TOKEN:return t.push(s),!0;case this._scanner.IDENTIFIER_TOKEN:if(n=this._scanner.buf().join(""),(i=this._scanner.read())!==this._scanner.EQUALS_TOKEN)return!(this._error="expected equals");if((i=this._scanner.read())!==this._scanner.STRING_TOKEN)return!(this._error="expected string");i=this._scanner.buf().join(""),s.attributes[n]=i;break;default:return!(this._error="expected close bracket or identifier")}i=this._scanner.read()}}});var e=function(){};return e.evaluate=function(e){return t(e)},{Markup:e}}()),Object.assign(te,(Ss=new te.Vec2,Ts=new te.Vec3,Es=new te.Vec3,xs=new te.Vec3,As=new te.Vec3,Ms=new te.Vec3,Cs=new te.Quat,Ps={x:"y",y:"x"},Is=function(e,t){if(!(e&&e instanceof te.ElementComponent))throw Error("Element was null or not an ElementComponent");if(t&&"x"!==t&&"y"!==t)throw Error("Unrecognized axis: "+t);this._element=e,this._app=e.system.app,this._axis=t||null,this._enabled=!0,this._dragScale=new te.Vec3,this._dragStartMousePosition=new te.Vec3,this._dragStartHandlePosition=new te.Vec3,this._deltaMousePosition=new te.Vec3,this._deltaHandlePosition=new te.Vec3,this._isDragging=!1,te.events.attach(this),this._toggleLifecycleListeners("on")},Object.assign(Is.prototype,{_toggleLifecycleListeners:function(e){this._element[e]("mousedown",this._onMouseDownOrTouchStart,this),this._element[e]("touchstart",this._onMouseDownOrTouchStart,this)},_toggleDragListeners:function(e){var t="on"===e,i=t?"addEventListener":"removeEventListener";this._hasDragListeners&&t||(this._handleMouseUpOrTouchEnd||(this._handleMouseUpOrTouchEnd=this._onMouseUpOrTouchEnd.bind(this)),this._app.mouse[e]("mousemove",this._onMove,this),window[i]("mouseup",this._handleMouseUpOrTouchEnd,!1),te.platform.touch&&(this._app.touch[e]("touchmove",this._onMove,this),window[i]("touchend",this._handleMouseUpOrTouchEnd,!1),window[i]("touchcancel",this._handleMouseUpOrTouchEnd,!1)),this._hasDragListeners=t)},_onMouseDownOrTouchStart:function(e){this._element&&!this._isDragging&&this.enabled&&(this._dragCamera=e.camera,this._calculateDragScale(),e=this._screenToLocal(e))&&(this._toggleDragListeners("on"),this._isDragging=!0,this._dragStartMousePosition.copy(e),this._dragStartHandlePosition.copy(this._element.entity.getLocalPosition()),this.fire("drag:start"))},_onMouseUpOrTouchEnd:function(){this._isDragging&&(this._isDragging=!1,this._toggleDragListeners("off"),this.fire("drag:end"))},_screenToLocal:function(e){return this._determineInputPosition(e),this._chooseRayOriginAndDirection(),As.copy(this._element.entity.getPosition()),Ms.copy(this._element.entity.forward).scale(-1),e=Ms.dot(xs),0<Math.abs(e)?(e=As.sub(Es).dot(Ms)/e,e=Es.add(xs.scale(e)),Cs.copy(this._element.entity.getRotation()).invert().transformVector(e,e),e.mul(this._dragScale),e):null},_determineInputPosition:function(e){var t=this._app.graphicsDevice.maxPixelRatio;void 0!==e.x&&void 0!==e.y?(Ss.x=e.x*t,Ss.y=e.y*t):e.changedTouches&&(Ss.x=e.changedTouches[0].x*t,Ss.y=e.changedTouches[0].y*t)},_chooseRayOriginAndDirection:function(){this._element.screen&&this._element.screen.screen.screenSpace?(Es.set(Ss.x,-Ss.y,0),xs.set(0,0,-1)):(Ts.copy(this._dragCamera.screenToWorld(Ss.x,Ss.y,1)),Es.copy(this._dragCamera.entity.getPosition()),xs.copy(Ts).sub(Es).normalize())},_calculateDragScale:function(){var e=this._element.entity.parent,t=(i=this._element.screen&&this._element.screen.screen)&&i.screenSpace,i=t?i.scale:1,s=this._dragScale;for(s.set(i,i,i);e&&(s.mul(e.getLocalScale()),e=e.parent,!t||!e.screen););s.x=1/s.x,s.y=1/s.y,s.z=1/s.z},_onMove:function(e){if(this._element&&this._isDragging&&this.enabled&&this._element.enabled&&this._element.entity.enabled&&(e=this._screenToLocal(e),this._dragStartMousePosition&&e)){if(this._deltaMousePosition.copy(e).sub(this._dragStartMousePosition),this._deltaHandlePosition.copy(this._dragStartHandlePosition).add(this._deltaMousePosition),this._axis){e=this._element.entity.getLocalPosition();var t=Ps[this._axis];this._deltaHandlePosition[t]=e[t]}this._element.entity.setLocalPosition(this._deltaHandlePosition),this.fire("drag:move",this._deltaHandlePosition)}},destroy:function(){this._toggleLifecycleListeners("off"),this._toggleDragListeners("off")}}),Object.defineProperty(Is.prototype,"enabled",{get:function(){return this._enabled},set:function(e){this._enabled=e}}),Object.defineProperty(Is.prototype,"isDragging",{get:function(){return this._isDragging}}),{ElementDragHelper:Is})),Object.assign(te,{BUTTON_TRANSITION_MODE_TINT:0,BUTTON_TRANSITION_MODE_SPRITE_CHANGE:1}),Object.assign(te,(ws={DEFAULT:"_defaultTint",HOVER:"hoverTint",PRESSED:"pressedTint",INACTIVE:"inactiveTint"},Os={DEFAULT:"_defaultSpriteAsset",HOVER:"hoverSpriteAsset",PRESSED:"pressedSpriteAsset",INACTIVE:"inactiveSpriteAsset"},Rs={DEFAULT:"_defaultSpriteFrame",HOVER:"hoverSpriteFrame",PRESSED:"pressedSpriteFrame",INACTIVE:"inactiveSpriteFrame"},((Ls=function(e,t){te.Component.call(this,e,t),this._visualState="DEFAULT",this._isPressed=this._isHovering=!1,this._defaultTint=new te.Color(1,1,1,1),this._defaultSpriteAsset=null,this._defaultSpriteFrame=0,this._imageReference=new te.EntityReference(this,"imageEntity",{"element#gain":this._onImageElementGain,"element#lose":this._onImageElementLose,"element#set:color":this._onSetColor,"element#set:opacity":this._onSetOpacity,"element#set:spriteAsset":this._onSetSpriteAsset,"element#set:spriteFrame":this._onSetSpriteFrame}),this._toggleLifecycleListeners("on",e)}).prototype=Object.create(te.Component.prototype)).constructor=Ls,Object.assign(Ls.prototype,{_toggleLifecycleListeners:function(e,t){this[e]("set_active",this._onSetActive,this),this[e]("set_transitionMode",this._onSetTransitionMode,this),this[e]("set_hoverTint",this._onSetTransitionValue,this),this[e]("set_pressedTint",this._onSetTransitionValue,this),this[e]("set_inactiveTint",this._onSetTransitionValue,this),this[e]("set_hoverSpriteAsset",this._onSetTransitionValue,this),this[e]("set_hoverSpriteFrame",this._onSetTransitionValue,this),this[e]("set_pressedSpriteAsset",this._onSetTransitionValue,this),this[e]("set_pressedSpriteFrame",this._onSetTransitionValue,this),this[e]("set_inactiveSpriteAsset",this._onSetTransitionValue,this),this[e]("set_inactiveSpriteFrame",this._onSetTransitionValue,this),t.app.systems.element[e]("add",this._onElementComponentAdd,this),t.app.systems.element[e]("beforeremove",this._onElementComponentRemove,this)},_onSetActive:function(e,t,i){t!==i&&this._updateVisualState()},_onSetTransitionMode:function(e,t,i){t!==i&&(this._cancelTween(),this._resetToDefaultVisualState(t),this._forceReapplyVisualState())},_onSetTransitionValue:function(e,t,i){t!==i&&this._forceReapplyVisualState()},_onElementComponentRemove:function(e){this.entity===e&&this._toggleHitElementListeners("off")},_onElementComponentAdd:function(e){this.entity===e&&this._toggleHitElementListeners("on")},_onImageElementLose:function(){this._cancelTween(),this._resetToDefaultVisualState(this.transitionMode)},_onImageElementGain:function(){this._storeDefaultVisualState(),this._forceReapplyVisualState()},_toggleHitElementListeners:function(e){if(this.entity.element){var t="on"===e;t&&this._hasHitElementListeners||(this.entity.element[e]("mouseenter",this._onMouseEnter,this),this.entity.element[e]("mouseleave",this._onMouseLeave,this),this.entity.element[e]("mousedown",this._onMouseDown,this),this.entity.element[e]("mouseup",this._onMouseUp,this),this.entity.element[e]("touchstart",this._onTouchStart,this),this.entity.element[e]("touchend",this._onTouchEnd,this),this.entity.element[e]("touchleave",this._onTouchLeave,this),this.entity.element[e]("touchcancel",this._onTouchCancel,this),this.entity.element[e]("click",this._onClick,this),this._hasHitElementListeners=t)}},_storeDefaultVisualState:function(){this._imageReference.hasComponent("element")&&(this._storeDefaultColor(this._imageReference.entity.element.color),this._storeDefaultOpacity(this._imageReference.entity.element.opacity),this._storeDefaultSpriteAsset(this._imageReference.entity.element.spriteAsset),this._storeDefaultSpriteFrame(this._imageReference.entity.element.spriteFrame))},_storeDefaultColor:function(e){this._defaultTint.r=e.r,this._defaultTint.g=e.g,this._defaultTint.b=e.b},_storeDefaultOpacity:function(e){this._defaultTint.a=e},_storeDefaultSpriteAsset:function(e){this._defaultSpriteAsset=e},_storeDefaultSpriteFrame:function(e){this._defaultSpriteFrame=e},_onSetColor:function(e){this._isApplyingTint||(this._storeDefaultColor(e),this._forceReapplyVisualState())},_onSetOpacity:function(e){this._isApplyingTint||(this._storeDefaultOpacity(e),this._forceReapplyVisualState())},_onSetSpriteAsset:function(e){this._isApplyingSprite||(this._storeDefaultSpriteAsset(e),this._forceReapplyVisualState())},_onSetSpriteFrame:function(e){this._isApplyingSprite||(this._storeDefaultSpriteFrame(e),this._forceReapplyVisualState())},_onMouseEnter:function(e){this._isHovering=!0,this._updateVisualState(),this._fireIfActive("mouseenter",e)},_onMouseLeave:function(e){this._isPressed=this._isHovering=!1,this._updateVisualState(),this._fireIfActive("mouseleave",e)},_onMouseDown:function(e){this._isPressed=!0,this._updateVisualState(),this._fireIfActive("mousedown",e)},_onMouseUp:function(e){this._isPressed=!1,this._updateVisualState(),this._fireIfActive("mouseup",e)},_onTouchStart:function(e){this._isPressed=!0,this._updateVisualState(),this._fireIfActive("touchstart",e)},_onTouchEnd:function(e){e.event.preventDefault(),this._isPressed=!1,this._updateVisualState(),this._fireIfActive("touchend",e)},_onTouchLeave:function(e){this._isPressed=!1,this._updateVisualState(),this._fireIfActive("touchleave",e)},_onTouchCancel:function(e){this._isPressed=!1,this._updateVisualState(),this._fireIfActive("touchcancel",e)},_onClick:function(e){this._fireIfActive("click",e)},_fireIfActive:function(e,t){this.data.active&&this.fire(e,t)},_updateVisualState:function(e){var t=this._visualState,i=this._determineVisualState();if((t!==i||e)&&this.enabled)switch(this._visualState=i,"HOVER"===t&&this._fireIfActive("hoverend"),"PRESSED"===t&&this._fireIfActive("pressedend"),"HOVER"===i&&this._fireIfActive("hoverstart"),"PRESSED"===i&&this._fireIfActive("pressedstart"),this.transitionMode){case te.BUTTON_TRANSITION_MODE_TINT:this._applyTint(this[ws[this._visualState]]);break;case te.BUTTON_TRANSITION_MODE_SPRITE_CHANGE:this._applySprite(this[Os[this._visualState]],this[Rs[this._visualState]])}},_forceReapplyVisualState:function(){this._updateVisualState(!0)},_resetToDefaultVisualState:function(e){if(this._imageReference.hasComponent("element"))switch(e){case te.BUTTON_TRANSITION_MODE_TINT:this._cancelTween(),this._applyTintImmediately(this._defaultTint);break;case te.BUTTON_TRANSITION_MODE_SPRITE_CHANGE:this._applySprite(this._defaultSpriteAsset,this._defaultSpriteFrame)}},_determineVisualState:function(){return this.active?this._isPressed?"PRESSED":this._isHovering?"HOVER":"DEFAULT":"INACTIVE"},_applySprite:function(e,t){t=t||0,this._imageReference.hasComponent("element")&&(this._isApplyingSprite=!0,this._imageReference.entity.element.spriteAsset=e,this._imageReference.entity.element.spriteFrame=t,this._isApplyingSprite=!1)},_applyTint:function(e){this._cancelTween(),0===this.fadeDuration?this._applyTintImmediately(e):this._applyTintWithTween(e)},_applyTintImmediately:function(e){this._imageReference.hasComponent("element")&&e&&(this._isApplyingTint=!0,this._imageReference.entity.element.color=new te.Color(e.r,e.g,e.b),this._imageReference.entity.element.opacity=e.a,this._isApplyingTint=!1)},_applyTintWithTween:function(e){if(this._imageReference.hasComponent("element")&&e){var t=this._imageReference.entity.element.color,i=this._imageReference.entity.element.opacity;this._tweenInfo={startTime:te.now(),from:new te.Color(t.r,t.g,t.b,i),to:e.clone(),lerpColor:new te.Color}}},_updateTintTween:function(){var e=te.now()-this._tweenInfo.startTime;if(e=0===this.fadeDuration?1:e/this.fadeDuration,e=te.math.clamp(e,0,1),1e-5<Math.abs(e-1)){var t=this._tweenInfo.lerpColor;t.lerp(this._tweenInfo.from,this._tweenInfo.to,e),this._applyTintImmediately(new te.Color(t.r,t.g,t.b,t.a))}else this._applyTintImmediately(this._tweenInfo.to),this._cancelTween()},_cancelTween:function(){delete this._tweenInfo},onUpdate:function(){this._tweenInfo&&this._updateTintTween()},onEnable:function(){this._imageReference.onParentComponentEnable(),this._toggleHitElementListeners("on"),this._forceReapplyVisualState()},onDisable:function(){this._toggleHitElementListeners("off"),this._resetToDefaultVisualState(this.transitionMode)},onRemove:function(){this._toggleLifecycleListeners("off",this.system),this.onDisable()}}),{ButtonComponent:Ls})),Object.assign(te,(Ds=["enabled","active",{name:"imageEntity",type:"entity"},{name:"hitPadding",type:"vec4"},"transitionMode",{name:"hoverTint",type:"rgba"},{name:"pressedTint",type:"rgba"},{name:"inactiveTint",type:"rgba"},"fadeDuration","hoverSpriteAsset","hoverSpriteFrame","pressedSpriteAsset","pressedSpriteFrame","inactiveSpriteAsset","inactiveSpriteFrame"],((Ns=function(e){te.ComponentSystem.call(this,e),this.id="button",this.app=e,this.ComponentType=te.ButtonComponent,this.DataType=te.ButtonComponentData,this.schema=Ds,this.on("beforeremove",this._onRemoveComponent,this),te.ComponentSystem.bind("update",this.onUpdate,this)}).prototype=Object.create(te.ComponentSystem.prototype)).constructor=Ns,te.Component._buildAccessors(te.ButtonComponent.prototype,Ds),Object.assign(Ns.prototype,{initializeComponentData:function(e,t,i){te.ComponentSystem.prototype.initializeComponentData.call(this,e,t,Ds)},onUpdate:function(e){for(var t in e=this.store){var i=e[t].entity,s=i.button;s.enabled&&i.enabled&&s.onUpdate()}},_onRemoveComponent:function(e,t){t.onRemove()}}),{ButtonComponentSystem:Ns})),Object.assign(te,{ButtonComponentData:function(){this.active=this.enabled=!0,this.imageEntity=null,this.hitPadding=new te.Vec4,this.transitionMode=te.BUTTON_TRANSITION_MODE_TINT,this.hoverTint=new te.Color(.75,.75,.75),this.pressedTint=new te.Color(.5,.5,.5),this.inactiveTint=new te.Color(.25,.25,.25),this.fadeDuration=0,this.hoverSpriteAsset=null,this.hoverSpriteFrame=0,this.pressedSpriteAsset=null,this.pressedSpriteFrame=0,this.inactiveSpriteAsset=null,this.inactiveSpriteFrame=0}}),Object.assign(te,{SCROLL_MODE_CLAMP:0,SCROLL_MODE_BOUNCE:1,SCROLL_MODE_INFINITE:2,SCROLLBAR_VISIBILITY_SHOW_ALWAYS:0,SCROLLBAR_VISIBILITY_SHOW_WHEN_REQUIRED:1}),Object.assign(te,(Fs=new te.Vec2,((Bs=function(e,t){te.Component.call(this,e,t),this._viewportReference=new te.EntityReference(this,"viewportEntity",{"element#gain":this._onViewportElementGain,"element#resize":this._onSetContentOrViewportSize}),this._contentReference=new te.EntityReference(this,"contentEntity",{"element#gain":this._onContentElementGain,"element#lose":this._onContentElementLose,"element#resize":this._onSetContentOrViewportSize}),this._scrollbarUpdateFlags={},this._scrollbarReferences={},this._scrollbarReferences[te.ORIENTATION_HORIZONTAL]=new te.EntityReference(this,"horizontalScrollbarEntity",{"scrollbar#set:value":this._onSetHorizontalScrollbarValue,"scrollbar#gain":this._onHorizontalScrollbarGain}),this._scrollbarReferences[te.ORIENTATION_VERTICAL]=new te.EntityReference(this,"verticalScrollbarEntity",{"scrollbar#set:value":this._onSetVerticalScrollbarValue,"scrollbar#gain":this._onVerticalScrollbarGain}),this._prevContentSizes={},this._prevContentSizes[te.ORIENTATION_HORIZONTAL]=null,this._prevContentSizes[te.ORIENTATION_VERTICAL]=null,this._scroll=new te.Vec2,this._velocity=new te.Vec3,this._dragStartPosition=new te.Vec3,this._disabledContentInput=!1,this._disabledContentInputEntities=[],this._toggleLifecycleListeners("on",e),this._toggleElementListeners("on")}).prototype=Object.create(te.Component.prototype)).constructor=Bs,Object.assign(Bs.prototype,{_toggleLifecycleListeners:function(e,t){this[e]("set_horizontal",this._onSetHorizontalScrollingEnabled,this),this[e]("set_vertical",this._onSetVerticalScrollingEnabled,this),t.app.systems.element[e]("add",this._onElementComponentAdd,this),t.app.systems.element[e]("beforeremove",this._onElementComponentRemove,this)},_toggleElementListeners:function(e){!this.entity.element||"on"===e&&this._hasElementListeners||(this.entity.element[e]("resize",this._onSetContentOrViewportSize,this),this._hasElementListeners="on"===e)},_onElementComponentAdd:function(e){this.entity===e&&this._toggleElementListeners("on")},_onElementComponentRemove:function(e){this.entity===e&&this._toggleElementListeners("off")},_onViewportElementGain:function(){this._syncAll()},_onContentElementGain:function(){this._destroyDragHelper(),this._contentDragHelper=new te.ElementDragHelper(this._contentReference.entity.element),this._contentDragHelper.on("drag:start",this._onContentDragStart,this),this._contentDragHelper.on("drag:end",this._onContentDragEnd,this),this._contentDragHelper.on("drag:move",this._onContentDragMove,this),this._prevContentSizes[te.ORIENTATION_HORIZONTAL]=null,this._prevContentSizes[te.ORIENTATION_VERTICAL]=null,this._syncAll()},_onContentElementLose:function(){this._destroyDragHelper()},_onContentDragStart:function(){this._contentReference.entity&&this.enabled&&this.entity.enabled&&this._dragStartPosition.copy(this._contentReference.entity.getLocalPosition())},_onContentDragEnd:function(){this._prevContentDragPosition=null,this._enableContentInput()},_onContentDragMove:function(e){if(this._contentReference.entity&&this.enabled&&this.entity.enabled&&(this._wasDragged=!0,this._setScrollFromContentPosition(e),this._setVelocityFromContentPositionDelta(e),!this._disabledContentInput)){var t=e.y-this._dragStartPosition.y;(Math.abs(e.x-this._dragStartPosition.x)>this.dragThreshold||Math.abs(t)>this.dragThreshold)&&this._disableContentInput()}},_onSetContentOrViewportSize:function(){this._syncAll()},_onSetHorizontalScrollbarValue:function(e){!this._scrollbarUpdateFlags[te.ORIENTATION_HORIZONTAL]&&this.enabled&&this.entity.enabled&&this._onSetScroll(e,null)},_onSetVerticalScrollbarValue:function(e){!this._scrollbarUpdateFlags[te.ORIENTATION_VERTICAL]&&this.enabled&&this.entity.enabled&&this._onSetScroll(null,e)},_onSetHorizontalScrollingEnabled:function(){this._syncScrollbarEnabledState(te.ORIENTATION_HORIZONTAL)},_onSetVerticalScrollingEnabled:function(){this._syncScrollbarEnabledState(te.ORIENTATION_VERTICAL)},_onHorizontalScrollbarGain:function(){this._syncScrollbarEnabledState(te.ORIENTATION_HORIZONTAL),this._syncScrollbarPosition(te.ORIENTATION_HORIZONTAL)},_onVerticalScrollbarGain:function(){this._syncScrollbarEnabledState(te.ORIENTATION_VERTICAL),this._syncScrollbarPosition(te.ORIENTATION_VERTICAL)},_onSetScroll:function(e,t,i){!1!==i&&this._velocity.set(0,0,0),e=0|this._updateAxis(e,"x",te.ORIENTATION_HORIZONTAL),(e|=this._updateAxis(t,"y",te.ORIENTATION_VERTICAL))&&this.fire("set:scroll",this._scroll)},_updateAxis:function(e,t,i){var s=null!==e&&1e-5<Math.abs(e-this._scroll[t]);return(s||this._isDragging()||0===e)&&(this._scroll[t]=this._determineNewScrollValue(e,t,i),this._syncContentPosition(i),this._syncScrollbarPosition(i)),s},_determineNewScrollValue:function(e,t,i){if(!this._getScrollingEnabled(i))return this._scroll[t];switch(this.scrollMode){case te.SCROLL_MODE_CLAMP:return te.math.clamp(e,0,this._getMaxScrollValue(i));case te.SCROLL_MODE_BOUNCE:return this._setVelocityFromOvershoot(e,t,i),e;case te.SCROLL_MODE_INFINITE:default:return e}},_syncAll:function(){this._syncContentPosition(te.ORIENTATION_HORIZONTAL),this._syncContentPosition(te.ORIENTATION_VERTICAL),this._syncScrollbarPosition(te.ORIENTATION_HORIZONTAL),this._syncScrollbarPosition(te.ORIENTATION_VERTICAL),this._syncScrollbarEnabledState(te.ORIENTATION_HORIZONTAL),this._syncScrollbarEnabledState(te.ORIENTATION_VERTICAL)},_syncContentPosition:function(e){var t=this._getAxis(e),i=this._getSign(e),s=this._contentReference.entity;if(s){var n=this._prevContentSizes[e],a=this._getContentSize(e);if(null!==n&&1e-4<Math.abs(n-a)){n=this._getMaxOffset(e,n);var r=this._getMaxOffset(e,a);this._scroll[t]=0===r?1:te.math.clamp(this._scroll[t]*n/r,0,1)}n=this._scroll[t]*this._getMaxOffset(e),(r=s.getLocalPosition())[t]=n*i,s.setLocalPosition(r),this._prevContentSizes[e]=a}},_syncScrollbarPosition:function(e){var t=this._getAxis(e),i=this._scrollbarReferences[e].entity;i&&i.scrollbar&&(this._scrollbarUpdateFlags[e]=!0,i.scrollbar.value=this._scroll[t],i.scrollbar.handleSize=this._getScrollbarHandleSize(t,e),this._scrollbarUpdateFlags[e]=!1)},_syncScrollbarEnabledState:function(e){var t=this._scrollbarReferences[e].entity;if(t){var i=this._getScrollingEnabled(e),s=this._getScrollbarVisibility(e);switch(s){case te.SCROLLBAR_VISIBILITY_SHOW_ALWAYS:t.enabled=i;break;case te.SCROLLBAR_VISIBILITY_SHOW_WHEN_REQUIRED:t.enabled=i&&this._contentIsLargerThanViewport(e);break;default:t.enabled=i}}},_contentIsLargerThanViewport:function(e){return this._getContentSize(e)>this._getViewportSize(e)},_contentPositionToScrollValue:function(e){var t=this._getMaxOffset(te.ORIENTATION_HORIZONTAL),i=this._getMaxOffset(te.ORIENTATION_VERTICAL);return Fs.x=0===t?0:e.x/t,Fs.y=0===i?0:e.y/-i,Fs},_getMaxOffset:function(e,t){t=void 0===t?this._getContentSize(e):t;var i=this._getViewportSize(e);return t<i?-this._getViewportSize(e):i-t},_getMaxScrollValue:function(e){return this._contentIsLargerThanViewport(e)?1:0},_getScrollbarHandleSize:function(e,t){var i=this._getViewportSize(t),s=this._getContentSize(t);return Math.abs(s)<.001?1:(i=Math.min(i/s,1),0===(s=this._toOvershoot(this._scroll[e],t))?i:i/(1+Math.abs(s)))},_getViewportSize:function(e){return this._getSize(e,this._viewportReference)},_getContentSize:function(e){return this._getSize(e,this._contentReference)},_getSize:function(e,t){return t.entity&&t.entity.element?t.entity.element[this._getCalculatedDimension(e)]:0},_getScrollingEnabled:function(e){return e===te.ORIENTATION_HORIZONTAL?this.horizontal:e===te.ORIENTATION_VERTICAL?this.vertical:void 0},_getScrollbarVisibility:function(e){return e===te.ORIENTATION_HORIZONTAL?this.horizontalScrollbarVisibility:e===te.ORIENTATION_VERTICAL?this.verticalScrollbarVisibility:void 0},_getSign:function(e){return e===te.ORIENTATION_HORIZONTAL?1:-1},_getAxis:function(e){return e===te.ORIENTATION_HORIZONTAL?"x":"y"},_getCalculatedDimension:function(e){return e===te.ORIENTATION_HORIZONTAL?"calculatedWidth":"calculatedHeight"},_destroyDragHelper:function(){this._contentDragHelper&&this._contentDragHelper.destroy()},onUpdate:function(){this._contentReference.entity&&(this._updateVelocity(),this._syncScrollbarEnabledState(te.ORIENTATION_HORIZONTAL),this._syncScrollbarEnabledState(te.ORIENTATION_VERTICAL))},_updateVelocity:function(){if(!this._isDragging()&&(this.scrollMode===te.SCROLL_MODE_BOUNCE&&(this._hasOvershoot("x",te.ORIENTATION_HORIZONTAL)&&this._setVelocityFromOvershoot(this.scroll.x,"x",te.ORIENTATION_HORIZONTAL),this._hasOvershoot("y",te.ORIENTATION_VERTICAL)&&this._setVelocityFromOvershoot(this.scroll.y,"y",te.ORIENTATION_VERTICAL)),this._velocity.x*=1-this.friction,this._velocity.y*=1-this.friction,1e-4<Math.abs(this._velocity.x)||1e-4<Math.abs(this._velocity.y))){var e=this._contentReference.entity.getLocalPosition();e.x+=this._velocity.x,e.y+=this._velocity.y,this._contentReference.entity.setLocalPosition(e),this._setScrollFromContentPosition(e)}},_hasOvershoot:function(e,t){return.001<Math.abs(this._toOvershoot(this.scroll[e],t))},_toOvershoot:function(e,t){var i=this._getMaxScrollValue(t);return e<0?e:i<e?e-i:0},_setVelocityFromOvershoot:function(e,t,i){e=this._toOvershoot(e,i)*this._getMaxOffset(i)*this._getSign(i),0<Math.abs(e)&&(this._velocity[t]=-e/(50*this.bounceAmount+1))},_setVelocityFromContentPositionDelta:function(e){this._prevContentDragPosition?(this._velocity.sub2(e,this._prevContentDragPosition),this._prevContentDragPosition.copy(e)):(this._velocity.set(0,0,0),this._prevContentDragPosition=e.clone())},_setScrollFromContentPosition:function(e){e=this._contentPositionToScrollValue(e),this._isDragging()&&(e=this._applyScrollValueTension(e)),this._onSetScroll(e.x,e.y,!1)},_applyScrollValueTension:function(e){var t,i;return t=this._getMaxScrollValue(te.ORIENTATION_HORIZONTAL),0<(i=this._toOvershoot(e.x,te.ORIENTATION_HORIZONTAL))?e.x=t+1*Math.log10(1+i):i<0&&(e.x=-1*Math.log10(1-i)),t=this._getMaxScrollValue(te.ORIENTATION_VERTICAL),0<(i=this._toOvershoot(e.y,te.ORIENTATION_VERTICAL))?e.y=t+1*Math.log10(1+i):i<0&&(e.y=-1*Math.log10(1-i)),e},_isDragging:function(){return this._contentDragHelper&&this._contentDragHelper.isDragging},_setScrollbarComponentsEnabled:function(e){this._scrollbarReferences[te.ORIENTATION_HORIZONTAL].hasComponent("scrollbar")&&(this._scrollbarReferences[te.ORIENTATION_HORIZONTAL].entity.scrollbar.enabled=e),this._scrollbarReferences[te.ORIENTATION_VERTICAL].hasComponent("scrollbar")&&(this._scrollbarReferences[te.ORIENTATION_VERTICAL].entity.scrollbar.enabled=e)},_setContentDraggingEnabled:function(e){this._contentDragHelper&&(this._contentDragHelper.enabled=e)},_enableContentInput:function(){for(;this._disabledContentInputEntities.length;){var e=this._disabledContentInputEntities.pop();e.element&&(e.element.useInput=!0)}this._disabledContentInput=!1},_disableContentInput:function(){var s=this,n=function(e){var t,i;for(e.element&&e.element.useInput&&(s._disabledContentInputEntities.push(e),e.element.useInput=!1),t=0,i=(e=e.children).length;t<i;t++)n(e[t])};if(e=this._contentReference.entity){var e,t,i=(e=e.children).length;for(t=0;t<i;t++)n(e[t])}this._disabledContentInput=!0},onEnable:function(){this._viewportReference.onParentComponentEnable(),this._contentReference.onParentComponentEnable(),this._scrollbarReferences[te.ORIENTATION_HORIZONTAL].onParentComponentEnable(),this._scrollbarReferences[te.ORIENTATION_VERTICAL].onParentComponentEnable(),this._setScrollbarComponentsEnabled(!0),this._setContentDraggingEnabled(!0),this._syncAll()},onDisable:function(){this._setScrollbarComponentsEnabled(!1),this._setContentDraggingEnabled(!1)},onRemove:function(){this._toggleLifecycleListeners("off",this.system),this._toggleElementListeners("off"),this._destroyDragHelper()}}),Object.defineProperty(Bs.prototype,"scroll",{get:function(){return this._scroll},set:function(e){this._onSetScroll(e.x,e.y)}}),{ScrollViewComponent:Bs})),Object.assign(te,(ks=[{name:"enabled",type:"boolean"},{name:"horizontal",type:"boolean"},{name:"vertical",type:"boolean"},{name:"scrollMode",type:"number"},{name:"bounceAmount",type:"number"},{name:"friction",type:"number"},{name:"dragThreshold",type:"number"},{name:"horizontalScrollbarVisibility",type:"number"},{name:"verticalScrollbarVisibility",type:"number"},{name:"viewportEntity",type:"entity"},{name:"contentEntity",type:"entity"},{name:"horizontalScrollbarEntity",type:"entity"},{name:"verticalScrollbarEntity",type:"entity"}],((Vs=function(e){te.ComponentSystem.call(this,e),this.id="scrollview",this.app=e,this.ComponentType=te.ScrollViewComponent,this.DataType=te.ScrollViewComponentData,this.schema=ks,this.on("beforeremove",this._onRemoveComponent,this),te.ComponentSystem.bind("update",this.onUpdate,this)}).prototype=Object.create(te.ComponentSystem.prototype)).constructor=Vs,te.Component._buildAccessors(te.ScrollViewComponent.prototype,ks),Object.assign(Vs.prototype,{initializeComponentData:function(e,t,i){void 0===t.dragThreshold&&(t.dragThreshold=10),te.ComponentSystem.prototype.initializeComponentData.call(this,e,t,ks)},onUpdate:function(e){for(var t in e=this.store){var i=e[t].entity,s=i.scrollview;s.enabled&&i.enabled&&s.onUpdate()}},_onRemoveComponent:function(e,t){t.onRemove()}}),{ScrollViewComponentSystem:Vs})),Object.assign(te,{ScrollViewComponentData:function(){this.enabled=!0}}),Object.assign(te,(((Us=function(e,t){te.Component.call(this,e,t),this._app=e.app,this._handleReference=new te.EntityReference(this,"handleEntity",{"element#gain":this._onHandleElementGain,"element#lose":this._onHandleElementLose,"element#set:anchor":this._onSetHandleAlignment,"element#set:margin":this._onSetHandleAlignment,"element#set:pivot":this._onSetHandleAlignment}),this._toggleLifecycleListeners("on")}).prototype=Object.create(te.Component.prototype)).constructor=Us,Object.assign(Us.prototype,{_toggleLifecycleListeners:function(e){this[e]("set_value",this._onSetValue,this),this[e]("set_handleSize",this._onSetHandleSize,this),this[e]("set_orientation",this._onSetOrientation,this)},_onHandleElementGain:function(){this._destroyDragHelper(),this._handleDragHelper=new te.ElementDragHelper(this._handleReference.entity.element,this._getAxis()),this._handleDragHelper.on("drag:move",this._onHandleDrag,this),this._updateHandlePositionAndSize()},_onHandleElementLose:function(){this._destroyDragHelper()},_onHandleDrag:function(e){this._handleReference.entity&&this.enabled&&this.entity.enabled&&(this.value=this._handlePositionToScrollValue(e[this._getAxis()]))},_onSetValue:function(e,t,i){1e-5<Math.abs(i-t)&&(this.data.value=te.math.clamp(i,0,1),this._updateHandlePositionAndSize(),this.fire("set:value",this.data.value))},_onSetHandleSize:function(e,t,i){1e-5<Math.abs(i-t)&&(this.data.handleSize=te.math.clamp(i,0,1),this._updateHandlePositionAndSize())},_onSetHandleAlignment:function(){this._updateHandlePositionAndSize()},_onSetOrientation:function(e,t,i){i!==t&&this._handleReference.hasComponent("element")&&(this._handleReference.entity.element[this._getOppositeDimension()]=0)},_updateHandlePositionAndSize:function(){var e=this._handleReference.entity,t=e&&e.element;e&&((e=e.getLocalPosition())[this._getAxis()]=this._getHandlePosition(),this._handleReference.entity.setLocalPosition(e)),t&&(t[this._getDimension()]=this._getHandleLength())},_handlePositionToScrollValue:function(e){return e*this._getSign()/this._getUsableTrackLength()},_scrollValueToHandlePosition:function(e){return e*this._getSign()*this._getUsableTrackLength()},_getUsableTrackLength:function(){return Math.max(this._getTrackLength()-this._getHandleLength(),.001)},_getTrackLength:function(){return this.entity.element?this.orientation===te.ORIENTATION_HORIZONTAL?this.entity.element.calculatedWidth:this.entity.element.calculatedHeight:0},_getHandleLength:function(){return this._getTrackLength()*this.handleSize},_getHandlePosition:function(){return this._scrollValueToHandlePosition(this.value)},_getSign:function(){return this.orientation===te.ORIENTATION_HORIZONTAL?1:-1},_getAxis:function(){return this.orientation===te.ORIENTATION_HORIZONTAL?"x":"y"},_getDimension:function(){return this.orientation===te.ORIENTATION_HORIZONTAL?"width":"height"},_getOppositeDimension:function(){return this.orientation===te.ORIENTATION_HORIZONTAL?"height":"width"},_destroyDragHelper:function(){this._handleDragHelper&&this._handleDragHelper.destroy()},_setHandleDraggingEnabled:function(e){this._handleDragHelper&&(this._handleDragHelper.enabled=e)},onEnable:function(){this._handleReference.onParentComponentEnable(),this._setHandleDraggingEnabled(!0)},onDisable:function(){this._setHandleDraggingEnabled(!1)},onRemove:function(){this._destroyDragHelper(),this._toggleLifecycleListeners("off")}}),{ScrollbarComponent:Us})),Object.assign(te,(zs=[{name:"enabled",type:"boolean"},{name:"orientation",type:"number"},{name:"value",type:"number"},{name:"handleSize",type:"number"},{name:"handleEntity",type:"entity"}],((Hs=function(e){te.ComponentSystem.call(this,e),this.id="scrollbar",this.app=e,this.ComponentType=te.ScrollbarComponent,this.DataType=te.ScrollbarComponentData,this.schema=zs,this.on("beforeremove",this._onRemoveComponent,this)}).prototype=Object.create(te.ComponentSystem.prototype)).constructor=Hs,te.Component._buildAccessors(te.ScrollbarComponent.prototype,zs),Object.assign(Hs.prototype,{initializeComponentData:function(e,t,i){te.ComponentSystem.prototype.initializeComponentData.call(this,e,t,zs)},_onRemoveComponent:function(e,t){t.onRemove()}}),{ScrollbarComponentSystem:Hs})),Object.assign(te,{ScrollbarComponentData:function(){this.enabled=!0}}),Object.assign(te,{FITTING_NONE:0,FITTING_STRETCH:1,FITTING_SHRINK:2,FITTING_BOTH:3}),Object.assign(te,function(){function i(e){return e.element}function s(e){return e.enabled&&e.element&&e.element.enabled}function e(e){var t="_"+e;Object.defineProperty(n.prototype,e,{get:function(){return this[t]},set:function(e){this[t]!==e&&(this[t]=e,this._scheduleReflow())}})}var n=function(e,t){te.Component.call(this,e,t),this._orientation=te.ORIENTATION_HORIZONTAL,this._reverseX=!1,this._reverseY=!0,this._alignment=new te.Vec2(0,1),this._padding=new te.Vec4,this._spacing=new te.Vec2,this._heightFitting=this._widthFitting=te.FITTING_NONE,this._wrap=!1,this._layoutCalculator=new te.LayoutCalculator,this._listenForReflowEvents(this.entity,"on"),this.entity.children.forEach(function(e){this._listenForReflowEvents(e,"on")}.bind(this)),this.entity.on("childinsert",this._onChildInsert,this),this.entity.on("childremove",this._onChildRemove,this),e.app.systems.element.on("add",this._onElementOrLayoutComponentAdd,this),e.app.systems.element.on("beforeremove",this._onElementOrLayoutComponentRemove,this),e.app.systems.layoutchild.on("add",this._onElementOrLayoutComponentAdd,this),e.app.systems.layoutchild.on("beforeremove",this._onElementOrLayoutComponentRemove,this)};return(n.prototype=Object.create(te.Component.prototype)).constructor=n,Object.assign(n.prototype,{_isSelfOrChild:function(e){return e===this.entity||-1!==this.entity.children.indexOf(e)},_listenForReflowEvents:function(e,t){e.element&&(e.element[t]("enableelement",this._scheduleReflow,this),e.element[t]("disableelement",this._scheduleReflow,this),e.element[t]("resize",this._scheduleReflow,this),e.element[t]("set:pivot",this._scheduleReflow,this)),e.layoutchild&&(e.layoutchild[t]("set_enabled",this._scheduleReflow,this),e.layoutchild[t]("resize",this._scheduleReflow,this))},_onElementOrLayoutComponentAdd:function(e){this._isSelfOrChild(e)&&(this._listenForReflowEvents(e,"on"),this._scheduleReflow())},_onElementOrLayoutComponentRemove:function(e){this._isSelfOrChild(e)&&(this._listenForReflowEvents(e,"off"),this._scheduleReflow())},_onChildInsert:function(e){this._listenForReflowEvents(e,"on"),this._scheduleReflow()},_onChildRemove:function(e){this._listenForReflowEvents(e,"off"),this._scheduleReflow()},_scheduleReflow:function(){this.enabled&&this.entity&&this.entity.enabled&&!this._isPerformingReflow&&this.system.scheduleReflow(this)},reflow:function(){var e=this.entity.element,t=this.entity.children.filter(s).map(i);e&&0!==t.length&&(e={orientation:this._orientation,reverseX:this._reverseX,reverseY:this._reverseY,alignment:this._alignment,padding:this._padding,spacing:this._spacing,widthFitting:this._widthFitting,heightFitting:this._heightFitting,wrap:this._wrap,containerSize:new te.Vec2(Math.max(e.calculatedWidth,0),Math.max(e.calculatedHeight,0))},this._isPerformingReflow=!0,t=this._layoutCalculator.calculateLayout(t,e),this._isPerformingReflow=!1,this.fire("reflow",t))},onEnable:function(){this._scheduleReflow()},onRemove:function(){this.entity.off("childinsert",this._onChildInsert,this),this.entity.off("childremove",this._onChildRemove,this),this._listenForReflowEvents(this.entity,"off"),this.entity.children.forEach(function(e){this._listenForReflowEvents(e,"off")}.bind(this)),this.system.app.systems.element.off("add",this._onElementOrLayoutComponentAdd,this),this.system.app.systems.element.off("beforeremove",this._onElementOrLayoutComponentRemove,this),this.system.app.systems.layoutchild.off("add",this._onElementOrLayoutComponentAdd,this),this.system.app.systems.layoutchild.off("beforeremove",this._onElementOrLayoutComponentRemove,this)}}),e("orientation"),e("reverseX"),e("reverseY"),e("alignment"),e("padding"),e("spacing"),e("widthFitting"),e("heightFitting"),e("wrap"),{LayoutGroupComponent:n}}()),Object.assign(te,(js=["enabled"],((Gs=function(e){te.ComponentSystem.call(this,e),this.id="layoutgroup",this.app=e,this.ComponentType=te.LayoutGroupComponent,this.DataType=te.LayoutGroupComponentData,this.schema=js,this._reflowQueue=[],this.on("beforeremove",this._onRemoveComponent,this),te.ComponentSystem.bind("postUpdate",this._onPostUpdate,this)}).prototype=Object.create(te.ComponentSystem.prototype)).constructor=Gs,te.Component._buildAccessors(te.LayoutGroupComponent.prototype,js),Object.assign(Gs.prototype,{initializeComponentData:function(e,t,i){void 0!==t.enabled&&(e.enabled=t.enabled),void 0!==t.orientation&&(e.orientation=t.orientation),void 0!==t.reverseX&&(e.reverseX=t.reverseX),void 0!==t.reverseY&&(e.reverseY=t.reverseY),void 0!==t.alignment&&(t.alignment instanceof te.Vec2?e.alignment.copy(t.alignment):e.alignment.set(t.alignment[0],t.alignment[1]),e.alignment=e.alignment),void 0!==t.padding&&(t.padding instanceof te.Vec4?e.padding.copy(t.padding):e.padding.set(t.padding[0],t.padding[1],t.padding[2],t.padding[3]),e.padding=e.padding),void 0!==t.spacing&&(t.spacing instanceof te.Vec2?e.spacing.copy(t.spacing):e.spacing.set(t.spacing[0],t.spacing[1]),e.spacing=e.spacing),void 0!==t.widthFitting&&(e.widthFitting=t.widthFitting),void 0!==t.heightFitting&&(e.heightFitting=t.heightFitting),void 0!==t.wrap&&(e.wrap=t.wrap),te.ComponentSystem.prototype.initializeComponentData.call(this,e,t,i)},cloneComponent:function(e,t){var i=e.layoutgroup;return this.addComponent(t,{enabled:i.enabled,orientation:i.orientation,reverseX:i.reverseX,reverseY:i.reverseY,alignment:i.alignment,padding:i.padding,spacing:i.spacing,widthFitting:i.widthFitting,heightFitting:i.heightFitting,wrap:i.wrap})},scheduleReflow:function(e){-1===this._reflowQueue.indexOf(e)&&this._reflowQueue.push(e)},_onPostUpdate:function(){this._processReflowQueue()},_processReflowQueue:function(){if(0!==this._reflowQueue.length)for(var e=0;0<this._reflowQueue.length;){var t=this._reflowQueue.slice();this._reflowQueue.length=0,t.sort(function(e,t){return e.entity.graphDepth-t.entity.graphDepth});for(var i=0;i<t.length;++i)t[i].reflow();if(100<=++e)break}},_onRemoveComponent:function(e,t){t.onRemove()}}),{LayoutGroupComponentSystem:Gs})),Object.assign(te,{LayoutGroupComponentData:function(){this.enabled=!0}}),Object.assign(te,function(){function e(){}function t(e){function y(e){return!(e=e.entity.layoutchild)||!e.enabled||!e.excludeFromLayout}function v(e,t,i){switch(e){case te.FITTING_NONE:return W7a.NONE;case te.FITTING_STRETCH:return t<i?W7a.APPLY_STRETCHING:W7a.NONE;case te.FITTING_SHRINK:return i<=t?W7a.APPLY_SHRINKING:W7a.NONE;case te.FITTING_BOTH:return t<i?W7a.APPLY_STRETCHING:i<=t?W7a.APPLY_SHRINKING:W7a.NONE;default:throw Error("Unrecognized fitting mode: "+e)}}function b(e,t){return r(e,t.size)+(e.length-1)*x.spacing[t.axis]}function S(e,t,i){var s=f(e,i.maxSize),n=p(e,i.fittingProportion),a=m(n,s);t=C[i.axis]-t;for(var r=0;r<e.length;++r){var o=s[r],h=d(o,t,n,a),l=e[o][i.size]+h,c=Math.min(l,e[o][i.maxSize]);e[o][i.size]=c,t-=h-Math.max(l-c,0)}}function T(e,t,i){var s,n=f(e,i.minSize,!0);if(1===(s=p(e,i.fittingProportion)).length)s=[1];else{for(var a=[],r=s.length,o=0;o<r;++o)a.push((1-s[o])/(r-1));s=a}for(a=m(s,n),t-=C[i.axis],r=0;r<e.length;++r){var h=d(o=n[r],t,s,a),l=e[o][i.size]-h,c=Math.max(l,e[o][i.minSize]);e[o][i.size]=c,t-=h-Math.max(c-l,0)}}function d(e,t,i,s){return i=i[e],e=s[e],Math.abs(i)<1e-5&&Math.abs(e)<1e-5?t:t*i/e}function E(e){for(var t=[],i=0;i<e.length;++i){var s,n,a=e[i],r=Math.max(u(a,"minWidth"),0),o=Math.max(u(a,"minHeight"),0),h=Math.max(u(a,"maxWidth"),r),l=Math.max(u(a,"maxHeight"),o);s=u(a,"width"),s=Math.min(Math.max(s,r),h),n=u(a,"height"),n=Math.min(Math.max(n,o),l);var c=u(a,"fitWidthProportion");a=u(a,"fitHeightProportion");t.push({minWidth:r,minHeight:o,maxWidth:h,maxHeight:l,width:s,height:n,fitWidthProportion:c,fitHeightProportion:a})}return t}function u(e,t){var i=e.entity.layoutchild;return i&&i.enabled&&void 0!==i[t]&&null!==i[t]?i[t]:void 0!==e[t]?e[t]:a[t]}function r(e,i){return e.reduce(function(e,t){return e+t[i]},0)}function p(e,t){var i,s=r(e,t),n=[],a=e.length;if(0===s)for(i=0;i<a;++i)n.push(1/a);else for(i=0;i<a;++i)n.push(e[i][t]/s);return n}function f(e,i,s){return e.forEach(t),e.slice().sort(function(e,t){return s?t[i]-e[i]:e[i]-t[i]}).map(n)}function t(e,t){e.index=t}function n(e){return e.index}function m(e,t){var i=[];i[t[e.length-1]]=e[t[e.length-1]];for(var s=e.length-2;0<=s;--s)i[t[s]]=i[t[s+1]]+e[t[s]];return i}var x,A=i[e],M=i[s[e]];return function(e,t){e=e.filter(y),x=t,C.x=x.containerSize.x-x.padding.x-x.padding.z,C.y=x.containerSize.y-x.padding.y-x.padding.w;for(var i=e,s=0;s<i.length;++s){0===(a=(n=i[s]).anchor).x&&0===a.y&&0===a.z&&0===a.w||(n.anchor=te.Vec4.ZERO)}if(i=e,x.wrap){s=[[]];for(var n=E(i),a=0,r=x[A.fitting]===te.FITTING_SHRINK,o=0;o<i.length;++o){0<s[s.length-1].length&&(a+=x.spacing[A.axis]);a=a+(h=n[o][A.size]);!r&&a>C[A.axis]&&0!==s[s.length-1].length&&(a=h,s.push([])),s[s.length-1].push(i[o]),r&&a>C[A.axis]&&o!==i.length-1&&(a=0,s.push([]))}i=s}else i=[i];if(s=x.orientation===te.ORIENTATION_HORIZONTAL&&x.reverseX||x.orientation===te.ORIENTATION_VERTICAL&&x.reverseY,n=x.orientation===te.ORIENTATION_HORIZONTAL&&x.reverseY||x.orientation===te.ORIENTATION_VERTICAL&&x.reverseX,s)for(a=0;a<i.length;++a)s&&i[a].reverse();for(n&&i.reverse(),s=[],n=0;n<i.length;++n)r=b(a=E(i[n]),A),(o=v(x[A.fitting],r,C[A.axis]))===W7a.APPLY_STRETCHING?S(a,r,A):o===W7a.APPLY_SHRINKING&&T(a,r,A),s.push(a);for(h=[],o=[],a=0;a<i.length;++a){for((r=i[a]).largestElement=null,r.largestSize={width:Number.NEGATIVE_INFINITY,height:Number.NEGATIVE_INFINITY},n=0;n<r.length;++n){(l=s[a][n])[M.size]>r.largestSize[M.size]&&(r.largestElement=r[n],r.largestSize=l)}h.push(r.largestElement),o.push(r.largestSize)}for(n=b(o,M),(a=v(x[M.fitting],n,C[M.axis]))===W7a.APPLY_STRETCHING?S(o,n,M):a===W7a.APPLY_SHRINKING&&T(o,n,M),a=0;a<i.length;++a)for(r=i[a],n=0;n<r.length;++n)o=s[a][n],h=1===i.length?C[M.axis]:r.largestSize[M.size],(l=v(x[M.fitting],o[M.size],h))===W7a.APPLY_STRETCHING?o[M.size]=Math.min(h,o[M.maxSize]):l===W7a.APPLY_SHRINKING&&(o[M.size]=Math.max(h,o[M.minSize]));e:{for((n={})[A.axis]=0,n[M.axis]=0,i[A.size]=Number.NEGATIVE_INFINITY,a=[],r=0;r<i.length;++r){if(0===(o=i[r]).length){n=void 0;break e}for(var h=[],l=s[r],c=0;c<o.length;++c){var d=o[c],u=l[c];n[M.axis]-=-u[M.size]*d.pivot[M.axis],n[A.axis]-=-u[A.size]*d.pivot[A.axis],h[c]={},h[c][A.axis]=n[A.axis],h[c][M.axis]=n[M.axis],n[M.axis]+=-u[M.size]*d.pivot[M.axis],n[A.axis]+=u[A.size]*(1-d.pivot[A.axis])+x.spacing[A.axis]}o[A.size]=n[A.axis]-x.spacing[A.axis],o[M.size]=o.largestSize[M.size],i[A.size]=Math.max(i[A.size],o[A.size]),n[A.axis]=0,n[M.axis]+=o[M.size]+x.spacing[M.axis],a.push(h)}i[M.size]=n[M.axis]-x.spacing[M.axis],n=a}for(a=n,r=x.alignment[A.axis],o=x.alignment[M.axis],h=x.padding[A.axis],l=x.padding[M.axis],c=0;c<i.length;++c){d=i[c],u=s[c];for(var p=a[c],f=(C[A.axis]-d[A.size])*r+h,m=(C[M.axis]-i[M.size])*o+l,_=0;_<d.length;++_){var g=(d[M.size]-u[_][M.size])*x.alignment[M.axis];p[_][A.axis]+=f,p[_][M.axis]+=m+g}}for(a=0;a<i.length;++a)for(r=i[a],o=s[a],h=n[a],l=0;l<r.length;++l)(c=r[l])[A.calculatedSize]=o[l][A.size],c[M.calculatedSize]=o[l][M.size],x.orientation===te.ORIENTATION_HORIZONTAL?c.entity.setLocalPosition(h[l][A.axis],h[l][M.axis],c.entity.getLocalPosition().z):c.entity.setLocalPosition(h[l][M.axis],h[l][A.axis],c.entity.getLocalPosition().z);return s=i.width,i=i.height,{bounds:new te.Vec4((C.x-s)*x.alignment.x+x.padding.x,(C.y-i)*x.alignment.y+x.padding.y,s,i)}}}var i={};i[te.ORIENTATION_HORIZONTAL]={axis:"x",size:"width",calculatedSize:"calculatedWidth",minSize:"minWidth",maxSize:"maxWidth",fitting:"widthFitting",fittingProportion:"fitWidthProportion"},i[te.ORIENTATION_VERTICAL]={axis:"y",size:"height",calculatedSize:"calculatedHeight",minSize:"minHeight",maxSize:"maxHeight",fitting:"heightFitting",fittingProportion:"fitHeightProportion"};var s={};s[te.ORIENTATION_HORIZONTAL]=te.ORIENTATION_VERTICAL,s[te.ORIENTATION_VERTICAL]=te.ORIENTATION_HORIZONTAL;var a={minWidth:0,minHeight:0,maxWidth:Number.POSITIVE_INFINITY,maxHeight:Number.POSITIVE_INFINITY,width:null,height:null,fitWidthProportion:0,fitHeightProportion:0},C=new te.Vec2,n={};return n[te.ORIENTATION_HORIZONTAL]=t(te.ORIENTATION_HORIZONTAL),n[te.ORIENTATION_VERTICAL]=t(te.ORIENTATION_VERTICAL),Object.assign(e.prototype,{calculateLayout:function(e,t){var i=n[t.orientation];if(i)return i(e,t);throw Error("Unrecognized orientation value: "+t.orientation)}}),{LayoutCalculator:e}}()),Object.assign(te,function(){function e(e){var t="_"+e;Object.defineProperty(i.prototype,e,{get:function(){return this[t]},set:function(e){this[t]!==e&&(this[t]=e,this.fire("resize"))}})}var i=function(e,t){te.Component.call(this,e,t),this._minHeight=this._minWidth=0,this._maxHeight=this._maxWidth=null,this._fitHeightProportion=this._fitWidthProportion=0,this._excludeFromLayout=!1};return(i.prototype=Object.create(te.Component.prototype)).constructor=i,e("minWidth"),e("minHeight"),e("maxWidth"),e("maxHeight"),e("fitWidthProportion"),e("fitHeightProportion"),e("excludeFromLayout"),{LayoutChildComponent:i}}()),Object.assign(te,(Ws=["enabled"],((Ys=function(e){te.ComponentSystem.call(this,e),this.id="layoutchild",this.app=e,this.ComponentType=te.LayoutChildComponent,this.DataType=te.LayoutChildComponentData,this.schema=Ws}).prototype=Object.create(te.ComponentSystem.prototype)).constructor=Ys,te.Component._buildAccessors(te.LayoutChildComponent.prototype,Ws),Object.assign(Ys.prototype,{initializeComponentData:function(e,t,i){void 0!==t.enabled&&(e.enabled=t.enabled),void 0!==t.minWidth&&(e.minWidth=t.minWidth),void 0!==t.minHeight&&(e.minHeight=t.minHeight),void 0!==t.maxWidth&&(e.maxWidth=t.maxWidth),void 0!==t.maxHeight&&(e.maxHeight=t.maxHeight),void 0!==t.fitWidthProportion&&(e.fitWidthProportion=t.fitWidthProportion),void 0!==t.fitHeightProportion&&(e.fitHeightProportion=t.fitHeightProportion),void 0!==t.excludeFromLayout&&(e.excludeFromLayout=t.excludeFromLayout),te.ComponentSystem.prototype.initializeComponentData.call(this,e,t,i)},cloneComponent:function(e,t){var i=e.layoutchild;return this.addComponent(t,{enabled:i.enabled,minWidth:i.minWidth,minHeight:i.minHeight,maxWidth:i.maxWidth,maxHeight:i.maxHeight,fitWidthProportion:i.fitWidthProportion,fitHeightProportion:i.fitHeightProportion,excludeFromLayout:i.excludeFromLayout})}}),{LayoutChildComponentSystem:Ys})),Object.assign(te,{LayoutChildComponentData:function(){this.enabled=!0}}),Object.assign(te,function(){te.FONT_MSDF="msdf",te.FONT_BITMAP="bitmap";var e=function(e,t){this.type=t&&t.type||te.FONT_MSDF,this.em=1,this.textures=e,this.intensity=0,this._data=null,this.data=t};return Object.defineProperty(e.prototype,"data",{get:function(){return this._data},set:function(e){if((this._data=e)&&(void 0!==this._data.intensity&&(this.intensity=this._data.intensity),this._data.info||(this._data.info={}),(!this._data.version||this._data.version<2)&&(this._data.info.maps=[{width:this._data.info.width,height:this._data.info.height}],this._data.chars)))for(var t in this._data.chars)this._data.chars[t].map=0}}),{FONT_MSDF:te.FONT_MSDF,Font:e}}()),Object.assign(te,((Xs=function(e,t){this.type="bitmap",this.app=e,this.intensity=0,t=t||{},this.fontWeight=t.fontWeight||"normal",this.glyphSize=this.fontSize=parseInt(t.fontSize,10),this.fontName=t.fontName||"Arial",this.color=t.color||new te.Color(1,1,1),this.padding=t.padding||0;var i=4096<t.width?4096:t.width||512,s=4096<t.height?4096:t.height||512,n=document.createElement("canvas");n.height=s,n.width=i,(i=new te.Texture(this.app.graphicsDevice,{format:te.PIXELFORMAT_R8_G8_B8_A8,autoMipmap:!0})).name="font",i.setSource(n),i.minFilter=te.FILTER_LINEAR_MIPMAP_LINEAR,i.magFilter=te.FILTER_LINEAR,i.addressU=te.ADDRESS_CLAMP_TO_EDGE,i.addressV=te.ADDRESS_CLAMP_TO_EDGE,this.textures=[i],this.chars="",this.data={},te.events.attach(this)}).prototype.createTextures=function(e){if((e=this._normalizeCharsSet(e)).length!==this.chars.length)this._renderAtlas(e);else for(var t=0;t<e.length;t++)if(e[t]!==this.chars[t]){this._renderAtlas(e);break}},Xs.prototype.updateTextures=function(e){e=this._normalizeCharsSet(e);for(var t=[],i=0;i<e.length;i++){var s=e[i];this.data.chars[s]||t.push(s)}0<t.length&&this._renderAtlas(this.chars.concat(t))},Xs.prototype.destroy=function(){for(var e=0;e<this.textures.length;e++)this.textures[e].destroy();this.fontWeight=this.type=this.textures=this.intensity=this.glyphSize=this.fontSize=this.fontName=this.data=this.color=this.chars=null},Xs.prototype._getAndClearContext=function(e,t){var i=e.width,s=e.height,n=e.getContext("2d",{alpha:!0});return n.clearRect(0,0,i,s),n.fillStyle=t,n.fillRect(0,0,i,s),n},Xs.prototype._colorToRgbString=function(e,t){var i=Math.round(255*e.r),s=Math.round(255*e.g),n=Math.round(255*e.b);return t?"rgba("+i+", "+s+", "+n+", "+e.a+")":"rgb("+i+", "+s+", "+n+")"},Xs.prototype.renderCharacter=function(e,t,i,s,n){e.fillStyle=n,e.fillText(t,i,s)},Xs.prototype._renderAtlas=function(e){this.chars=e,e=1;var t=(g=this.textures[e-1].getSource()).width,i=g.height,s=this._colorToRgbString(this.color,!1),n=this.color.a;this.color.a=1/255;var a=this._colorToRgbString(this.color,!0);this.color.a=n,(n=this._getAndClearContext(g,a)).font=this.fontWeight+" "+this.fontSize.toString()+"px "+this.fontName,n.textAlign="center",n.textBaseline="alphabetic",this.data=this._createJson(this.chars,this.fontName,t,i);var r,o=te.string.getSymbols(this.chars.join("")),h=this.textures.length,l=0,c=0,d={};for(r=0;r<o.length;r++)d[g=o[r]]=this._getTextMetrics(g),l=Math.max(l,d[g].height),c=Math.max(c,d[g].descent);this.glyphSize=Math.max(this.glyphSize,l),l=this.glyphSize+2*this.padding;var u=this.glyphSize+2*this.padding,p=this.glyphSize/2+this.padding,f=u-c-this.padding,m=0,_=0;for(r=0;r<o.length;r++){var g=o[r],y=te.string.getCodePoint(o[r]),v=this.fontSize;n.font=this.fontWeight+" "+v.toString()+"px "+this.fontName,n.textAlign="center",n.textBaseline="alphabetic";var b=n.measureText(g).width;v<b&&(v=this.fontSize*this.fontSize/b,n.font=this.fontWeight+" "+v.toString()+"px "+this.fontName,b=this.fontSize),this.renderCharacter(n,g,m+p,_+f,s),this._addChar(this.data,g,y,m,_,l,u,this.padding+(this.glyphSize-b)/2,-this.padding+d[g].descent-c,b,e-1,t,i),t<(m+=l)+l&&(m=0,i<(_+=u)+u&&(this.textures[e-1].upload(),_=0,h<++e?((g=document.createElement("canvas")).height=i,g.width=t,n=this._getAndClearContext(g,a),(y=new te.Texture(this.app.graphicsDevice,{format:te.PIXELFORMAT_R8_G8_B8_A8,autoMipmap:!0})).name="font-atlas",y.setSource(g),y.minFilter=te.FILTER_LINEAR_MIPMAP_LINEAR,y.magFilter=te.FILTER_LINEAR,y.addressU=te.ADDRESS_CLAMP_TO_EDGE,y.addressV=te.ADDRESS_CLAMP_TO_EDGE,this.textures.push(y)):(g=this.textures[e-1].getSource(),n=this._getAndClearContext(g,a))))}if(this.textures[e-1].upload(),e<h){for(r=e;r<h;r++)this.textures[r].destroy();this.textures.splice(e)}this.fire("render")},Xs.prototype._createJson=function(e,t,i,s){return{version:3,intensity:this.intensity,info:{face:t,width:i,height:s,maps:[{width:i,height:s}]},chars:{}}},Xs.prototype._addChar=function(e,t,i,s,n,a,r,o,h,l,c,d,u){e.info.maps.length<c+1&&e.info.maps.push({width:d,height:u}),d=this.fontSize/32,e.chars[t]={id:i,letter:t,x:s,y:n,width:a,height:r,xadvance:l/d,xoffset:o/d,yoffset:(h+this.padding)/d,scale:d,range:1,map:c,bounds:[0,0,a/d,r/d]}},Xs.prototype._normalizeCharsSet=function(e){var t,i=this.app.systems.element.getUnicodeConverter();for(i&&(e=i(e)),i={},e=te.string.getSymbols(e),t=0;t<e.length;t++){var s=e[t];i[s]||(i[s]=s)}return Object.keys(i).sort()},Xs.prototype._getTextMetrics=function(e){var t=document.createElement("span");t.id="content-span",t.innerHTML=e,(e=document.createElement("div")).id="content-block",e.style.display="inline-block",e.style.width="1px",e.style.height="0px";var i=document.createElement("div");i.appendChild(t),i.appendChild(e),i.style.font=this.fontName,i.style.fontSize=this.fontSize+"px",document.body.appendChild(i);var s=-1,n=-1,a=-1;try{e.style["vertical-align"]="baseline",s=e.offsetTop-t.offsetTop,e.style["vertical-align"]="bottom",n=(a=e.offsetTop-t.offsetTop)-s}finally{document.body.removeChild(i)}return{ascent:s,descent:n,height:a}},{CanvasFont:Xs})),Object.assign(te,(((qs=function(e,t){te.Component.call(this,e,t),this._oldState=!0,this._size=new te.Vec3,this.on("set_enabled",this._onSetEnabled,this)}).prototype=Object.create(te.Component.prototype)).constructor=qs,Object.assign(qs.prototype,{onEnable:function(){this._checkState()},onDisable:function(){this._checkState()},_onSetEnabled:function(e,t,i){this._checkState()},_checkState:function(){var e=this.enabled&&this.entity.enabled;e!==this._oldState&&(this._oldState=e,this.fire("enable"),this.fire("state",this.enabled))},_onBeforeRemove:function(){this.fire("remove")}}),Object.defineProperty(qs.prototype,"size",{set:function(e){e instanceof te.Vec3?this._size.copy(e):e instanceof Array&&3<=e.length&&this.size.set(e[0],e[1],e[2])},get:function(){return this._size}}),{ZoneComponent:qs})),Object.assign(te,(Ks=["enabled"],((Zs=function(e){te.ComponentSystem.call(this,e),this.id="zone",this.app=e,this.ComponentType=te.ZoneComponent,this.DataType=te.ZoneComponentData,this.schema=Ks,this.on("beforeremove",this._onBeforeRemove,this)}).prototype=Object.create(te.ComponentSystem.prototype)).constructor=Zs,te.Component._buildAccessors(te.ZoneComponent.prototype,Ks),Object.assign(Zs.prototype,{initializeComponentData:function(e,t,i){e.enabled=!t.hasOwnProperty("enabled")||!!t.enabled,t.size&&(t.size instanceof te.Vec3?e.size.copy(t.size):t.size instanceof Array&&3<=t.size.length&&e.size.set(t.size[0],t.size[1],t.size[2]))},cloneComponent:function(e,t){return this.addComponent(t,{size:e.zone.size})},_onBeforeRemove:function(e,t){t._onBeforeRemove()}}),{ZoneComponentSystem:Zs})),Object.assign(te,{ZoneComponentData:function(){this.enabled=!0}}),Object.assign(te,((((Qs=function(e,t){if(te.GraphNode.call(this,e),e instanceof te.Application&&(t=e),this._batchHandle=null,this.c={},!(this._app=t)&&(this._app=te.Application.getApplication(),!this._app))throw Error("Couldn't find current application");this._request=this._guid=null,this._destroying=!1,te.events.attach(this)}).prototype=Object.create(te.GraphNode.prototype)).constructor=Qs).prototype.addComponent=function(e,t){var i=this._app.systems[e];return!i||this.c[e]?null:i.addComponent(this,t)},Qs.prototype.removeComponent=function(e){var t=this._app.systems[e];t&&this.c[e]&&t.removeComponent(this)},Qs.prototype.findComponent=function(t){var e=this.findOne(function(e){return e.c&&e.c[t]});return e&&e.c[t]},Qs.prototype.findComponents=function(t){return this.find(function(e){return e.c&&e.c[t]}).map(function(e){return e.c[t]})},Qs.prototype.getGuid=function(){return this._guid||this.setGuid(te.guid.create()),this._guid},Qs.prototype.setGuid=function(e){var t=this._app._entityIndex;this._guid&&delete t[this._guid],this._guid=e,t[this._guid]=this},Qs.prototype._notifyHierarchyStateChanged=function(e,t){var i=!1;e===this&&0===this._app._enableList.length&&(i=!0),e._beingEnabled=!0,e._onHierarchyStateChanged(t),e._onHierarchyStatePostChanged&&this._app._enableList.push(e);var s,n,a=e._children;for(s=0,n=a.length;s<n;s++)a[s]._enabled&&this._notifyHierarchyStateChanged(a[s],t);if(e._beingEnabled=!1,i){for(s=0,n=this._app._enableList.length;s<n;s++)this._app._enableList[s]._onHierarchyStatePostChanged();this._app._enableList.length=0}},Qs.prototype._onHierarchyStateChanged=function(e){te.GraphNode.prototype._onHierarchyStateChanged.call(this,e);var t,i,s=this.c;for(i in s)s.hasOwnProperty(i)&&(t=s[i]).enabled&&(e?t.onEnable():t.onDisable())},Qs.prototype._onHierarchyStatePostChanged=function(){var e,t=this.c;for(e in t)t.hasOwnProperty(e)&&t[e].onPostStateChange()},Qs.prototype.setRequest=function(e){this._request=e},Qs.prototype.getRequest=function(){return this._request},Qs.prototype.findByGuid=function(e){return this._guid===e?this:(e=this._app._entityIndex[e])&&(e===this||e.isDescendantOf(this))?e:null},Qs.prototype.destroy=function(){var e;for(e in this._destroying=!0,this.c)this.c[e].enabled=!1;for(e in this.c)this.c[e].system.removeComponent(this);this._parent&&this._parent.removeChild(this);for(var t=(e=this._children).shift();t;)t instanceof te.Entity&&t.destroy(),t._parent=null,t=e.shift();this.fire("destroy",this),this.off(),this._guid&&delete this._app._entityIndex[this._guid],this._destroying=!1},Qs.prototype.clone=function(){var e={},t=this._cloneRecursively(e);return e[this.getGuid()]=t,function e(t,i,s,n){var a,r;if(i instanceof te.Entity){var o,h=i.c;for(o in h){var l=h[o],c=l.system.getPropertiesOfType("entity");for(a=0,r=c.length;a<r;a++){var d=c[a].name,u=l[d];t.findByGuid(u)&&(u=n[u].getGuid())&&(s.c[o][d]=u)}}for(h.script&&!s._app.useLegacyScriptAttributeCloning&&s.script.resolveDuplicatedEntityReferenceProperties(h.script,n),i=i.children.filter(function(e){return e instanceof te.Entity}),s=s.children.filter(function(e){return e instanceof te.Entity}),a=0,r=i.length;a<r;a++)e(t,i[a],s[a],n)}}(this,this,t,e),t},Qs.prototype._cloneRecursively=function(e){var t=new te.Entity(this._app);for(var i in te.GraphNode.prototype._cloneInternal.call(this,t),this.c)this.c[i].system.cloneComponent(this,t);for(i=0;i<this._children.length;i++){var s=this._children[i];if(s instanceof te.Entity){var n=s._cloneRecursively(e);t.addChild(n),e[s.getGuid()]=n}}return t},{Entity:Qs})),Object.assign(te,function(){function e(e,t,i){if(!(e&&e instanceof te.Component))throw Error("The parentComponent argument is required and must be a Component");if(!t||"string"!=typeof t)throw Error("The propertyName argument is required and must be a string");if(i&&"object"!=typeof i)throw Error("If provided, the eventConfig argument must be an object");this._parentComponent=e,this._entityPropertyName=t,this._entity=null,this._app=e.system.app,this._configureEventListeners(i||{},{"entity#destroy":this._onEntityDestroy}),this._toggleLifecycleListeners("on")}return Object.assign(e.prototype,{_configureEventListeners:function(e,t){var i=this._parseEventListenerConfig(e,"external",this._parentComponent),s=this._parseEventListenerConfig(t,"internal",this);this._eventListenerConfigs=i.concat(s),this._listenerStatusFlags={},this._gainListeners={},this._loseListeners={}},_parseEventListenerConfig:function(r,o,h){return Object.keys(r).map(function(e,t){var i=e.split("#"),s=i[0],n=i[1],a=r[e];if(2!==i.length||"string"!=typeof s||0===s.length||"string"!=typeof n||0===n.length)throw Error("Invalid event listener description: `"+e+"`");if("function"!=typeof a)throw Error("Invalid or missing callback for event listener `"+e+"`");return{id:o+"_"+t+"_"+e,sourceName:s,eventName:n,callback:a,scope:h}},this)},_toggleLifecycleListeners:function(e){this._parentComponent[e]("set_"+this._entityPropertyName,this._onSetEntity,this),this._parentComponent.system[e]("beforeremove",this._onParentComponentRemove,this),te.ComponentSystem[e]("postinitialize",this._onPostInitialize,this),this._app[e]("tools:sceneloaded",this._onSceneLoaded,this);for(var t=[],i=0;i<this._eventListenerConfigs.length;++i){var s=this._eventListenerConfigs[i],n=this._app.systems[s.sourceName];n&&(-1===t.indexOf(n)&&t.push(n),n&&"gain"===s.eventName&&(this._gainListeners[s.sourceName]=s),n&&"lose"===s.eventName&&(this._loseListeners[s.sourceName]=s))}for(i=0;i<t.length;++i)t[i][e]("add",this._onComponentAdd,this),t[i][e]("beforeremove",this._onComponentRemove,this)},_onSetEntity:function(e,t,i){i instanceof te.Entity?this._updateEntityReference():null!=i&&"string"!=typeof i||t!==i&&this._updateEntityReference()},_onPostInitialize:function(){this._updateEntityReference()},onParentComponentEnable:function(){this._entity||this._updateEntityReference()},_onSceneLoaded:function(){this._updateEntityReference()},_updateEntityReference:function(){var e,t=this._parentComponent.data[this._entityPropertyName];t instanceof te.Entity?(t=(e=t).getGuid(),this._parentComponent.data[this._entityPropertyName]=t):(e=this._parentComponent.system.app.root,e=this._parentComponent.entity.isDescendantOf(e)&&t?e.findByGuid(t):null),this._entity!==e&&(this._entity&&this._onBeforeEntityChange(),(this._entity=e)&&this._onAfterEntityChange())},_onBeforeEntityChange:function(){this._toggleEntityListeners("off"),this._callAllGainOrLoseListeners(this._loseListeners)},_onAfterEntityChange:function(){this._toggleEntityListeners("on"),this._callAllGainOrLoseListeners(this._gainListeners)},_onComponentAdd:function(e,t){var i=t.system.id;e===this._entity&&(this._callGainOrLoseListener(i,this._gainListeners),this._toggleComponentListeners("on",i))},_onComponentRemove:function(e,t){var i=t.system.id;e===this._entity&&(this._callGainOrLoseListener(i,this._loseListeners),this._toggleComponentListeners("off",i,!0))},_callAllGainOrLoseListeners:function(e){for(var t in this._entity.c)this._callGainOrLoseListener(t,e)},_callGainOrLoseListener:function(e,t){if(this._entity.c.hasOwnProperty(e)&&t[e]){var i=t[e];i.callback.call(i.scope)}},_toggleEntityListeners:function(e,t){if(this._entity)for(var i=0;i<this._eventListenerConfigs.length;++i)this._safeToggleListener(e,this._eventListenerConfigs[i],t)},_toggleComponentListeners:function(e,t,i){for(var s=0;s<this._eventListenerConfigs.length;++s){var n=this._eventListenerConfigs[s];n.sourceName===t&&this._safeToggleListener(e,n,i)}},_safeToggleListener:function(e,t,i){var s="on"===e;s&&this._listenerStatusFlags[t.id]||(i=this._getEventSource(t.sourceName,i))&&(i[e](t.eventName,t.callback,t.scope),this._listenerStatusFlags[t.id]=s)},_getEventSource:function(e,t){if("entity"===e)return this._entity;var i=this._entity[e];return i||null},_onEntityDestroy:function(e){this._entity===e&&(this._toggleEntityListeners("off",!0),this._entity=null)},_onParentComponentRemove:function(e,t){t===this._parentComponent&&(this._toggleLifecycleListeners("off"),this._toggleEntityListeners("off",!0))},hasComponent:function(e){return!(!this._entity||!this._entity.c)&&!!this._entity.c[e]}}),Object.defineProperty(e.prototype,"entity",{get:function(){return this._entity}}),{EntityReference:e}}()),Object.assign(te,(($s=function(e){this._sortBy=e.sortBy,this.items=[],this.length=0,this.loopIndex=-1,this._sortHandler=this._doSort.bind(this)}).prototype._binarySearch=function(e){var t,i,s=0,n=this.items.length-1;for(e=e[this._sortBy];s<=n;)t=Math.floor((s+n)/2),(i=this.items[t][this._sortBy])<=e?s=t+1:e<i&&(n=t-1);return s},$s.prototype._doSort=function(e,t){var i=this._sortBy;return e[i]-t[i]},$s.prototype.insert=function(e){var t=this._binarySearch(e);this.items.splice(t,0,e),this.length++,this.loopIndex>=t&&this.loopIndex++},$s.prototype.append=function(e){this.items.push(e),this.length++},$s.prototype.remove=function(e){(e=this.items.indexOf(e))<0||(this.items.splice(e,1),this.length--,this.loopIndex>=e&&this.loopIndex--)},$s.prototype.sort=function(){var e=0<=this.loopIndex?this.items[this.loopIndex]:null;this.items.sort(this._sortHandler),null!==e&&(this.loopIndex=this.items.indexOf(e))},{SortedLoopArray:$s})),Object.assign(te,(Js=function(e){this._handlers={},this._requests={},this._cache={},this._app=e},Object.assign(Js.prototype,{addHandler:function(e,t){(this._handlers[e]=t)._loader=this},removeHandler:function(e){delete this._handlers[e]},getHandler:function(e){return this._handlers[e]},load:function(i,e,t,r){var o=this._handlers[e];if(o){var h=i+e;if(void 0!==this._cache[h])t(null,this._cache[h]);else if(this._requests[h])this._requests[h].push(t);else{this._requests[h]=[t];var s=function(e,a){if(e){if(this._requests[h])for(var t=0,i=this._requests[h].length;t<i;t++)this._requests[h][t](e);delete this._requests[h]}else o.load(a,function(t,e,i){if(this._requests[h]){var s,n=this._requests[h].length;if(!t)try{s=o.open(a.original,e,r)}catch(e){t=e}if(t)for(e=0;e<n;e++)this._requests[h][e](t);else for(this._cache[h]=s,e=0;e<n;e++)this._requests[h][e](null,s,i);delete this._requests[h]}}.bind(this),r)}.bind(this);e=i.split("?")[0],this._app.enableBundles&&this._app.bundles.hasUrl(e)?this._app.bundles.canLoadUrl(e)?this._app.bundles.loadUrl(e,function(e,t){s(e,{load:t,original:i})}):s("Bundle for "+i+" not loaded yet"):s(null,{load:i,original:i})}}else t("No handler for asset type: "+e)},open:function(e,t){var i=this._handlers[e];return i?i.open(null,t):t},patch:function(e,t){var i=this._handlers[e.type];i&&i.patch&&i.patch(e,t)},clearCache:function(e,t){delete this._cache[e+t]},getFromCache:function(e,t){if(this._cache[e+t])return this._cache[e+t]},enableRetry:function(){for(var e in this._handlers)this._handlers[e].retryRequests=!0},disableRetry:function(){for(var e in this._handlers)this._handlers[e].retryRequests=!1},destroy:function(){this._handlers={},this._requests={},this._cache={}}}),{ResourceLoader:Js})),Object.assign(te,(en=function(e){this._assets=e,this._worker=null,this.retryRequests=!1},Object.assign(en.prototype,{load:function(i,s){"string"==typeof i&&(i={load:i,original:i});var n=this;te.http.get(i.load,{responseType:te.Http.ResponseType.ARRAY_BUFFER,retry:this.retryRequests},function(e,t){if(e)s("Error loading bundle resource "+i.original+": "+e);else try{n._untar(t,s)}catch(e){s("Error loading bundle resource "+i.original+": "+e)}})},_untar:function(e,i){var s=this;if(te.platform.workers)s._worker||(s._worker=new te.UntarWorker(s._assets.prefix)),s._worker.untar(e,function(e,t){i(e,t),s._worker.hasPendingRequests()||(s._worker.destroy(),s._worker=null)});else{var t=new te.Untar(e).untar(s._assets.prefix);i(null,t)}},open:function(e,t){return new te.Bundle(t)},patch:function(e,t){}}),{BundleHandler:en})),Object.assign(te,function(){function e(l){function c(e){this._fields=e}var h,d;"undefined"!=typeof TextDecoder&&(h=new TextDecoder("utf-8"),d=new TextDecoder("windows-1252")),c.parse=function(e,t,i){for(var s=new Uint8Array(e,t,i),n=0,a=[];n<i;){var r;for(r=n;r<i&&32!=s[r];r++);if(i<=r)throw Error("Invalid PAX header data format.");var o=parseInt(h.decode(new Uint8Array(e,t+n,r-n)),10);if(2!==(r=h.decode(new Uint8Array(e,t+r+1,o-(r-n)-2)).split("=")).length)throw Error("Invalid PAX header data format.");0===r[1].length&&(r[1]=null),a.push({name:r[0],value:r[1]}),n+=o}return new c(a)},c.prototype.applyHeader=function(e){for(var t=0;t<this._fields.length;t++){var i=this._fields[t].name,s=this._fields[t].value;"path"===i&&(i="name"),null===s?delete e[i]:e[i]=s}};var s=function(e){this._arrayBuffer=e||new ArrayBuffer(0),this._bufferView=new DataView(this._arrayBuffer),this._globalPaxHeader=null,this._bytesRead=0};l||(t=s),s.prototype._hasNext=function(){return this._bytesRead+4<this._arrayBuffer.byteLength&&0!==this._bufferView.getUint32(this._bytesRead)},s.prototype._readNextFile=function(){var e=new DataView(this._arrayBuffer,this._bytesRead,512),t=d.decode(e);this._bytesRead+=512;e=t.substr(0,100).replace(/\0/g,"");var i,s=t.substr(257,6),n=parseInt(t.substr(124,12),8),a=t.substr(156,1),r=this._bytesRead,o=null,h=!1;switch(a){case"0":case"":h=!0,l||(o=new Blob([this._arrayBuffer.slice(this._bytesRead,this._bytesRead+n)]),o=URL.createObjectURL(o));break;case"g":this._globalPaxHeader=c.parse(this._arrayBuffer,this._bytesRead,n);break;case"x":i=c.parse(this._arrayBuffer,this._bytesRead,n)}return this._bytesRead+=n,0!==(a=n%512)&&(this._bytesRead+=512-a),h?(-1!==s.indexOf("ustar")&&(0<(t=t.substr(345,155).replace(/\0/g,"")).length&&(e=t.trim()+e.trim())),e={name:e,start:r,size:n,url:o},this._globalPaxHeader&&this._globalPaxHeader.applyHeader(e),i&&i.applyHeader(e),e):null},s.prototype.untar=function(e){if(!h)return[];for(var t=[];this._hasNext();){var i=this._readNextFile();i&&(e&&i.name&&(i.name=e+i.name),t.push(i))}return t},l&&(self.onmessage=function(e){var t=e.data.id;try{var i=new s(e.data.arrayBuffer).untar(e.data.prefix);postMessage({id:t,files:i,arrayBuffer:e.data.arrayBuffer},[e.data.arrayBuffer])}catch(e){postMessage({id:t,error:e.toString()})}})}var t,i,s=(i=new Blob(["("+e.toString()+")(true)\n\n"],{type:"application/javascript"}),URL.createObjectURL(i)),n=function(e){this._requestId=0,this._pendingRequests={},this._filenamePrefix=e,this._worker=new Worker(s),this._worker.addEventListener("message",this._onMessage.bind(this))};return n.prototype._onMessage=function(e){var t=e.data.id;if(this._pendingRequests[t]){var i=this._pendingRequests[t];if(delete this._pendingRequests[t],e.data.error)i(e.data.error);else{t=e.data.arrayBuffer;for(var s=0,n=e.data.files.length;s<n;s++){var a=e.data.files[s],r=new Blob([t.slice(a.start,a.start+a.size)]);a.url=URL.createObjectURL(r)}i(null,e.data.files)}}},n.prototype.untar=function(e,t){var i=this._requestId++;this._pendingRequests[i]=t,this._worker.postMessage({id:i,prefix:this._filenamePrefix,arrayBuffer:e},[e])},n.prototype.hasPendingRequests=function(){for(var e in this._pendingRequests)return!0;return!1},n.prototype.destroy=function(){this._worker&&(this._worker.terminate(),this._pendingRequests=this._worker=null)},e(),{Untar:t,UntarWorker:n}}()),Object.assign(te,(tn=function(){this.retryRequests=!1},Object.assign(tn.prototype,{load:function(i,s){"string"==typeof i&&(i={load:i,original:i});var e={retry:this.retryRequests};i.load.startsWith("blob:")&&(e.responseType=te.Http.ResponseType.JSON),te.http.get(i.load,e,function(e,t){e?s(te.string.format("Error loading animation resource: {0} [{1}]",i.original,e)):s(null,t)})},open:function(e,t){return this["_parseAnimationV"+t.animation.version](t)},_parseAnimationV3:function(e){e=e.animation;var t=new te.Animation;t.setName(e.name),t.duration=e.duration;for(var i=0;i<e.nodes.length;i++){var s=new te.Node,n=e.nodes[i];s._name=n.name;for(var a=0;a<n.keys.length;a++){var r=(l=n.keys[a]).time,o=l.pos,h=l.rot,l=l.scale;o=new te.Vec3(o[0],o[1],o[2]),h=(new te.Quat).setFromEulerAngles(h[0],h[1],h[2]),l=new te.Vec3(l[0],l[1],l[2]),r=new te.Key(r,o,h,l),s._keys.push(r)}t.addNode(s)}return t},_parseAnimationV4:function(e){e=e.animation;var t=new te.Animation;t.setName(e.name),t.duration=e.duration;for(var i=0;i<e.nodes.length;i++){var s=new te.Node,n=e.nodes[i];s._name=n.name;for(var a=n.defaults.p,r=n.defaults.r,o=n.defaults.s,h=0;h<n.keys.length;h++){var l=(u=n.keys[h]).t,c=a||u.p,d=r||u.r,u=o||u.s;c=new te.Vec3(c[0],c[1],c[2]),d=(new te.Quat).setFromEulerAngles(d[0],d[1],d[2]),u=new te.Vec3(u[0],u[1],u[2]),l=new te.Key(l,c,d,u),s._keys.push(l)}t.addNode(s)}return t}}),{AnimationHandler:tn})),Object.assign(te,(sn=window.navigator.userAgent,an=0<(nn=sn.indexOf("MSIE "))?parseInt(sn.substring(nn+5,sn.indexOf(".",nn)),10):0<sn.indexOf("Trident/")&&(nn=sn.indexOf("rv:"),parseInt(sn.substring(nn+3,sn.indexOf(".",nn)),10)),rn=function(e){this.manager=e,this.retryRequests=!1},Object.assign(rn.prototype,{_isSupported:function(e){return!!{".ogg":"audio/ogg",".mp3":"audio/mpeg",".wav":"audio/x-wav",".mp4a":"audio/mp4",".m4a":"audio/mp4",".mp4":"audio/mp4",".aac":"audio/aac"}[te.path.getExtension(e)]},load:function(i,s){"string"==typeof i&&(i={load:i,original:i});var e=function(e){var t="Error loading audio url: "+i.original;e&&(t+=": "+(e.message||e)),s(t)};this._createSound?this._isSupported(i.original)?this._createSound(i.load,function(e){s(null,new te.Sound(e))},e):e(te.string.format("Audio format for {0} not supported",i.original)):e(null)},open:function(e,t){return t}}),te.SoundManager.hasAudioContext()?rn.prototype._createSound=function(e,i,s){var n=this.manager;if(n.context){var t={retry:this.retryRequests};e.startsWith("blob:")&&(t.responseType=te.Http.ResponseType.ARRAY_BUFFER),te.http.get(e,t,function(e,t){e?s(e):n.context.decodeAudioData(t,i,s)})}else s("Audio manager has no audio context")}:te.SoundManager.hasAudio()&&(rn.prototype._createSound=function(e,t,i){var s=null;try{s=new Audio}catch(e){return void i("No support for Audio element")}an&&document.body.appendChild(s);var n=function(){s.removeEventListener("canplaythrough",n),an&&document.body.removeChild(s),t(s)};s.onerror=function(){s.onerror=null,an&&document.body.removeChild(s),i()},s.addEventListener("canplaythrough",n),s.src=e}),{AudioHandler:rn})),Object.assign(te,(on=function(e,t,i){this._device=e,this._assets=t,this._loader=i},Object.assign(on.prototype,{load:function(e,t){},open:function(e,t){},patch:function(i,s){var n=this,e=!1;if(i.resources[0]||(i.resources[0]=new te.Texture(this._device,{format:te.PIXELFORMAT_R8_G8_B8_A8,cubemap:!0,mipmaps:!0,fixCubemapSeams:!!i._dds}),i.resources[0].name="cubemap",e=!0),i.file){if(i.file&&!i._dds){var t=i.getFileUrl();s._loader.load(t+"?t="+i.file.hash,"texture",function(e,t){e?(s.fire("error",e,i),s.fire("error:"+i.id,e,i),i.fire("error",e,i)):(s._loader.patch({resource:t,type:"texture",data:i.data},s),i._dds=t,n.patch(i,s))})}}else delete i._dds;if(i.file&&i._dds||!i.resources[1]){if(i._dds&&!i.resources[1]){for(i.resources=[i.resources[0]],i._dds.fixCubemapSeams=!0,i._dds.addressU=te.ADDRESS_CLAMP_TO_EDGE,i._dds.addressV=te.ADDRESS_CLAMP_TO_EDGE,e=0,this._device.useTexCubeLod&&(i.resources.push(i._dds),e=1);e<6;e++)(t=new te.Texture(this._device,{cubemap:!0,fixCubemapSeams:!0,mipmaps:!0,format:i._dds.format,rgbm:i._dds.rgbm,width:Math.pow(2,7-e),height:Math.pow(2,7-e)})).name="cubemap-mip",t._levels[0]=i._dds._levels[e],t.upload(),i.resources.push(t);e=!0}}else i.resources=[i.resources[0]],e=!0;(t=i.resource).name!==i.name&&(t.name=i.name);var a=!!i.data.rgbm;i.data.hasOwnProperty("rgbm")&&t.rgbm!==a&&(t.rgbm=a),t.fixCubemapSeams=!!i._dds,i.data.hasOwnProperty("minFilter")&&t.minFilter!==i.data.minFilter&&(t.minFilter=i.data.minFilter),i.data.hasOwnProperty("magFilter")&&t.magFilter!==i.data.magFilter&&(t.magFilter=i.data.magFilter),i.data.hasOwnProperty("anisotropy")&&t.anisotropy!==i.data.anisotropy&&(t.anisotropy=i.data.anisotropy),t.addressU!==te.ADDRESS_CLAMP_TO_EDGE&&(t.addressU=te.ADDRESS_CLAMP_TO_EDGE),t.addressV!==te.ADDRESS_CLAMP_TO_EDGE&&(t.addressV=te.ADDRESS_CLAMP_TO_EDGE),this._patchTextureFaces(i,s),e&&(s.fire("load",i),s.fire("load:"+i.id,i),i.fire("load",i))},_patchTexture:function(){this.registry._loader._handlers.cubemap._patchTextureFaces(this,this.registry)},_patchTextureFaces:function(n,a){if(n.loadFaces||!n.file){var r=n.resource,o=[],h=0,l=!1,c=this;n._levelsEvents||(n._levelsEvents=[null,null,null,null,null,null]),n.data.textures.forEach(function(e,i){var t=function(e){h++,o[i]=e&&e.resource.getSource()||null;var t=n._levelsEvents[i];t!==e&&(t&&t.off("load",c._patchTexture,n),e&&e.on("load",c._patchTexture,n),n._levelsEvents[i]=e||null),o[i]!==r._levels[0][i]&&(l=!0),6===h&&l&&(r.setSource(o),a.fire("load",n),a.fire("load:"+n.id,n),n.fire("load",n))},s=a.get(e);s?(s.ready(t),a.load(s)):e?(a.once("load:"+e,t),a.once("add:"+e,function(e){e.ready(t),a.load(e)})):t(null)})}}}),{CubemapHandler:on})),Object.assign(te,(hn=function(){this.retryRequests=!1},Object.assign(hn.prototype,{load:function(i,s){"string"==typeof i&&(i={load:i,original:i});var e={retry:this.retryRequests};i.load.startsWith("blob:")&&(e.responseType=te.Http.ResponseType.JSON),te.http.get(i.load,e,function(e,t){e?s(te.string.format("Error loading JSON resource: {0} [{1}]",i.original,e)):s(null,t)})},open:function(e,t){return t},patch:function(e,t){}}),{JsonHandler:hn})),Object.assign(te,(ln={aoMap:"white",diffuseMap:"gray",specularMap:"gray",metalnessMap:"black",glossMap:"gray",emissiveMap:"gray",normalMap:"normal",heightMap:"gray",opacityMap:"gray",sphereMap:"gray",lightMap:"white"},cn=function(e){this._assets=e.assets,this._device=e.graphicsDevice,this._placeholderTextures=null,this._parser=new te.JsonStandardMaterialParser,this.retryRequests=!1},Object.assign(cn.prototype,{load:function(i,s){"string"==typeof i&&(i={load:i,original:i}),te.http.get(i.load,{retry:this.retryRequests},function(e,t){e?s&&s(te.string.format("Error loading material: {0} [{1}]",i.original,e)):s&&(t._engine=!0,s(null,t))})},open:function(e,t){var i=this._parser.parse(t);return t._engine&&delete(i._data=t)._engine,i},_createPlaceholders:function(){this._placeholderTextures={};var e,t={white:[255,255,255,255],gray:[128,128,128,255],black:[0,0,0,255],normal:[128,128,255,255]};for(e in t)if(t.hasOwnProperty(e)){this._placeholderTextures[e]=new te.Texture(this._device,{width:2,height:2,format:te.PIXELFORMAT_R8_G8_B8_A8}),this._placeholderTextures[e].name="placeholder";for(var i=this._placeholderTextures[e].lock(),s=0;s<4;s++)for(var n=0;n<4;n++)i[4*s+n]=t[e][n];this._placeholderTextures[e].unlock()}},patch:function(e,t){e.resource._data&&(e._data=e.resource._data,delete e.resource._data),e.data.name=e.name,e.resource.name=e.name,this._bindAndAssignAssets(e,t),e.off("unload",this._onAssetUnload,this),e.on("unload",this._onAssetUnload,this)},_onAssetUnload:function(e){delete e.data.parameters,delete e.data.chunks,delete e.data.name},_assignTexture:function(e,t,i){t.data[e]=i,t.resource[e]=i},_assignPlaceholderTexture:function(e,t){this._placeholderTextures||this._createPlaceholders(),t.resource[e]=this._placeholderTextures[ln[e]]},_onTextureLoad:function(e,t,i){this._assignTexture(e,t,i.resource),t.resource.update()},_onTextureAdd:function(e,t,i){this._assets.load(i)},_onTextureRemove:function(e,t,i){var s=t.resource;s[e]===i.resource&&(this._assignTexture(e,t,null),s.update())},_assignCubemap:function(e,t,i){t.data[e]=i[0],7===i.length&&(t.data.prefilteredCubeMap128=i[1],t.data.prefilteredCubeMap64=i[2],t.data.prefilteredCubeMap32=i[3],t.data.prefilteredCubeMap16=i[4],t.data.prefilteredCubeMap8=i[5],t.data.prefilteredCubeMap4=i[6])},_onCubemapLoad:function(e,t,i){this._assignCubemap(e,t,i.resources),this._parser.initialize(t.resource,t.data)},_onCubemapAdd:function(e,t,i){t.data.shadingModel===te.SPECULAR_PHONG&&(t.loadFaces=!0),this._assets.load(i)},_onCubemapRemove:function(e,t,i){var s=t.resource;s[e]===i.resource&&(this._assignCubemap(e,t,[null,null,null,null,null,null,null]),s.update())},_bindAndAssignAssets:function(e,t){var i,s,n,a,r=this._parser.migrate(e.data),o=e.resource,h="path"===r.mappingFormat,l=te.StandardMaterial.TEXTURE_PARAMETERS;for(h&&(i=te.path.getDirectory(e.getFileUrl())),s=0;s<l.length;s++)n=l[s],a=o._assetReferences[n],!r[n]||r[n]instanceof te.Texture?a&&(h?a.url=null:a.id=null):(a||(a=new te.AssetReference(n,e,t,{load:this._onTextureLoad,add:this._onTextureAdd,remove:this._onTextureRemove},this),o._assetReferences[n]=a),h?a.url=te.path.join(i,r[n]):a.id=r[n],a.asset&&(a.asset.resource?this._assignTexture(n,e,a.asset.resource):this._assignPlaceholderTexture(n,e),t.load(a.asset)));for(l=te.StandardMaterial.CUBEMAP_PARAMETERS,s=0;s<l.length;s++)n=l[s],a=o._assetReferences[n],!r[n]||r[n]instanceof te.Texture||(a||(a=new te.AssetReference(n,e,t,{load:this._onCubemapLoad,add:this._onCubemapAdd,remove:this._onCubemapRemove},this),o._assetReferences[n]=a),h?a.url=r[n]:a.id=r[n],a.asset&&(a.asset.resource&&this._assignCubemap(n,e,a.asset.resources),t.load(a.asset)));this._parser.initialize(o,r)}}),{MaterialHandler:cn})),Object.assign(te,(dn=function(e,t){this._device=e,this._parsers=[],this._defaultMaterial=t,this.retryRequests=!1,this.addParser(new te.JsonModelParser(this._device),function(e,t){return".json"===te.path.getExtension(e)})},Object.assign(dn.prototype,{load:function(i,s){"string"==typeof i&&(i={load:i,original:i});var e={retry:this.retryRequests};i.load.startsWith("blob:")&&(e.responseType=te.Http.ResponseType.JSON),te.http.get(i.load,e,function(e,t){s&&(e?s(te.string.format("Error loading model: {0} [{1}]",i.original,e)):s(null,t))})},open:function(e,t){for(var i=0;i<this._parsers.length;i++){var s=this._parsers[i];if(s.decider(e,t))return s.parser.parse(t)}return Ie(te.string.format("No model parser found for: {0}",e)),null},patch:function(a,r){if(a.resource){var o=a.data,h=this;a.resource.meshInstances.forEach(function(t,e){if(o.mapping){var i=function(e){e.resource?t.material=e.resource:(e.once("load",i),r.load(e)),e.once("remove",function(e){t.material===e.resource&&(t.material=h._defaultMaterial)})};if(o.mapping[e]){var s=o.mapping[e].material,n=o.mapping[e].path;void 0!==s?s?(n=r.get(s))?i(n):r.once("add:"+s,i):t.material=h._defaultMaterial:n&&(s=a.getFileUrl(),s=te.path.getDirectory(s),s=te.path.join(s,o.mapping[e].path),(n=r.getByUrl(s))?i(n):r.once("add:url:"+s,i))}else t.material=h._defaultMaterial}})}},addParser:function(e,t){this._parsers.push({parser:e,decider:t})}}),{ModelHandler:dn})),Object.assign(te,((un=function(e){this._app=e,this._scripts={},this._cache={}})._types=[],un._push=function(e){te.script.legacy&&0<un._types.length||un._types.push(e)},Object.assign(un.prototype,{load:function(e,n){"string"==typeof e&&(e={load:e,original:e});var a=this;te.script.app=this._app,this._loadScript(e.original,function(e,t,i){if(e)n(e);else if(te.script.legacy)e=null,un._types.length&&(e=un._types.pop()),e?this._scripts[t]=e:e=null,n(null,e,i);else{e={};for(var s=0;s<un._types.length;s++)e[un._types[s].name]=un._types[s];un._types.length=0,n(null,e,i),delete a._loader._cache[t+"script"]}}.bind(this))},open:function(e,t){return t},patch:function(e,t){},_loadScript:function(e,t){var i=document.head,s=document.createElement("script");(this._cache[e]=s).async=!1,s.addEventListener("error",function(e){t(te.string.format("Script: {0} failed to load",e.target.src))},!1);var n=!1;s.onload=s.onreadystatechange=function(){n||this.readyState&&"loaded"!=this.readyState&&"complete"!=this.readyState||(n=!0,t(null,e,s))},s.src=e,i.appendChild(s)}}),{ScriptHandler:un})),Object.assign(te,(pn=function(){this.retryRequests=!1},Object.assign(pn.prototype,{load:function(i,s){"string"==typeof i&&(i={load:i,original:i}),te.http.get(i.load,{retry:this.retryRequests},function(e,t){e?s(te.string.format("Error loading text resource: {0} [{1}]",i.original,e)):s(null,t)})},open:function(e,t){return t},patch:function(e,t){}}),{TextHandler:pn})),Object.assign(te,(fn=function(){this.retryRequests=!1},Object.assign(fn.prototype,{load:function(i,s){"string"==typeof i&&(i={load:i,original:i}),te.http.get(i.load,{responseType:te.Http.ResponseType.ARRAY_BUFFER,retry:this.retryRequests},function(e,t){e?s(te.string.format("Error loading binary resource: {0} [{1}]",i.original,e)):s(null,t)})},open:function(e,t){return t},patch:function(e,t){}}),{BinaryHandler:fn})),Object.assign(te,(_n=(mn=function(e){return e.charCodeAt(0)+(e.charCodeAt(1)<<8)+(e.charCodeAt(2)<<16)+(e.charCodeAt(3)<<24)})("DDS "),gn=mn("DXT1"),yn=mn("DXT5"),vn=mn("DX10"),bn=mn("ETC1"),Sn=mn("P231"),Tn=mn("P241"),En=mn("P431"),xn=mn("P441"),(An={})[116]=te.PIXELFORMAT_RGBA32F,An[gn]=te.PIXELFORMAT_DXT1,An[yn]=te.PIXELFORMAT_DXT5,An[bn]=te.PIXELFORMAT_ETC1,An[Sn]=te.PIXELFORMAT_PVRTC_2BPP_RGB_1,An[Tn]=te.PIXELFORMAT_PVRTC_2BPP_RGBA_1,An[En]=te.PIXELFORMAT_PVRTC_4BPP_RGB_1,An[xn]=te.PIXELFORMAT_PVRTC_4BPP_RGBA_1,{DdsParser:function(e){var t=new Uint32Array(e,0,32);if(t[0]!==_n)return null;var i=t[1],s=t[2],n=t[3],a=t[4],r=Math.max(t[7],1),o=t[22],h=t[28];if(124!==i)return null;i=4+i;var l=t[21];if(4&t[20]&&l===vn&&(new Uint32Array(e,128,5),i+=20),h=(t=65024===h)?6:1,s=131072&s?r:1,r=[],t)for(var c=0;c<s;c++)r.push([]);for(c=0;c<h;c++)for(var d=a,u=n,p=0;p<s;p++){var f;if(l===gn||l===yn||l===bn)f=Math.floor((d+3)/4)*Math.floor((u+3)/4)*(l===yn?16:8);else if(l===Sn||l===Tn)f=Math.max(d,16)*Math.max(u,8)/4;else if(l===En||l===xn)f=Math.max(d,8)*Math.max(u,8)/2;else{if(32!==o)return null;f=d*u*4}var m=116===l?new Float32Array(e,i,f):new Uint8Array(e,i,f);t?r[p][c]=m:r.push(m),i+=116===l?4*f:f,d=Math.max(.5*d,1),u=Math.max(.5*u,1)}this.format=An[l]||te.PIXELFORMAT_R8_G8_B8_A8,this.width=a,this.height=n,this.levels=r,this.cubemap=t}})),Object.assign(te,(Mn=[1481919403,3140563232,169478669],Cn={33776:te.PIXELFORMAT_DXT1,33778:te.PIXELFORMAT_DXT3,33779:te.PIXELFORMAT_DXT5,36196:te.PIXELFORMAT_ETC1,37492:te.PIXELFORMAT_ETC2_RGB,37496:te.PIXELFORMAT_ETC2_RGBA,35840:te.PIXELFORMAT_PVRTC_4BPP_RGB_1,35841:te.PIXELFORMAT_PVRTC_2BPP_RGB_1,35842:te.PIXELFORMAT_PVRTC_4BPP_RGBA_1,35843:te.PIXELFORMAT_PVRTC_2BPP_RGBA_1},{KtxParser:function(e){var t=new Uint32Array(e,0,16);if(Mn[0]!==t[0]||Mn[1]!==t[1]||Mn[2]!==t[2])return null;var i=t[6],s=t[7],n=t[9],a=t[10],r=t[12],o=t[13],h=t[14];if(1<t[11]||1<r||0!==i||!Cn[s])return null;t=64+t[15],r=!(i=[]);for(var l=0;l<(h||1);l++){var c=new Uint32Array(e.slice(t,t+4))[0];t+=4,c/=o||1,1<o&&(r=!0,i.push([]));for(var d=0;d<o;d++){var u=new Uint8Array(e,t,c);1<o?i[l].push(u):i.push(u),t+=c}t+=3-(t+3)%4}this.format=Cn[s],this.width=n,this.height=a,this.levels=i,this.cubemap=r}})),Object.assign(te,(Pn={repeat:te.ADDRESS_REPEAT,clamp:te.ADDRESS_CLAMP_TO_EDGE,mirror:te.ADDRESS_MIRRORED_REPEAT},In={nearest:te.FILTER_NEAREST,linear:te.FILTER_LINEAR,nearest_mip_nearest:te.FILTER_NEAREST_MIPMAP_NEAREST,linear_mip_nearest:te.FILTER_LINEAR_MIPMAP_NEAREST,nearest_mip_linear:te.FILTER_NEAREST_MIPMAP_LINEAR,linear_mip_linear:te.FILTER_LINEAR_MIPMAP_LINEAR},wn=function(e,t,i){this._device=e,this._assets=t,this._loader=i,this.crossOrigin=void 0,t.prefix&&(this.crossOrigin="anonymous"),this.retryRequests=!1},Object.assign(wn.prototype,{load:function(e,i){"string"==typeof e&&(e={load:e,original:e});var t=0<=e.original.indexOf("?")?e.original.split("?")[0]:e.original,s=te.path.getExtension(t).toLowerCase();if(".dds"===s||".ktx"===s)te.http.get(e.load,{cache:!0,responseType:"arraybuffer",retry:this.retryRequests},function(e,t){e?i(e):i(null,t)});else if(".jpg"===s||".jpeg"===s||".gif"===s||".png"===s){var n;void 0!==this.crossOrigin&&te.ABSOLUTE_URL.test(e.original)&&(n=this.crossOrigin),this._loadImage(e.load,e.original,n,i)}else 0<=(n=t.indexOf("blob:"))?(e=t=t.substr(n),this._loadImage(e,e,null,i)):setTimeout(function(){i(te.string.format("Error loading Texture: format not supported: '{0}'",s))},0)},_loadImage:function(i,s,e,n){var a=new Image;e&&(a.crossOrigin=e);var r,o=0,h=this.retryRequests;a.onload=function(){n(null,a)},a.onerror=function(){if(!r)if(h&&++o<=5){var e=100*Math.pow(2,o),t=0<=i.indexOf("?")?"&":"?";r=setTimeout(function(){a.src=i+t+"retry="+Date.now(),r=null},e)}else n(te.string.format("Error loading Texture from: '{0}'",s))},a.src=i},open:function(e,t){if(e){var i,s=te.path.getExtension(e).toLowerCase();if(t instanceof Image||t instanceof HTMLImageElement)i=".jpg"===s||".jpeg"===s?te.PIXELFORMAT_R8_G8_B8:te.PIXELFORMAT_R8_G8_B8_A8,(i=new te.Texture(this._device,{width:t.width,height:t.height,format:i})).name=e,i.setSource(t);else if(t instanceof ArrayBuffer)if(".dds"===s){i=t;var n=this._device;if(".crn"===te.path.getExtension(e).toLowerCase()){s=i.byteLength;var a=new Uint8Array(i);i=Module._malloc(s);var r,o=Module.HEAPU8,h=i/4,l=s%4,c=new Uint32Array(a.buffer,0,(s-l)/4),d=new Uint32Array(o.buffer);for(r=0;r<c.length;r++)d[h+r]=c[r];for(r=s-l;r<s;r++)o[i+r]=a[r];a=Module._crn_decompress_get_data(i,s),i=Module._crn_decompress_get_size(i,s),i=Module.HEAPU8.buffer.slice(a,a+i)}s=(y=new Uint32Array(i,0,32))[4],a=y[3],o=Math.max(y[7],1);var u=y[21],p=y[22];r=65024===y[28];var f=d=c=l=h=!1,m=null;if(4===y[20]?827611204===u?(m=te.PIXELFORMAT_DXT1,h=!0):894720068===u?(m=te.PIXELFORMAT_DXT5,h=!0):116===u?(m=te.PIXELFORMAT_RGBA32F,l=!0):826496069===u?(m=te.PIXELFORMAT_ETC1,c=h=!0):825438800===u||825504336===u?(m=825438800===u?te.PIXELFORMAT_PVRTC_2BPP_RGB_1:te.PIXELFORMAT_PVRTC_2BPP_RGBA_1,d=h=!0):825439312!==u&&825504848!==u||(m=825439312===u?te.PIXELFORMAT_PVRTC_4BPP_RGB_1:te.PIXELFORMAT_PVRTC_4BPP_RGBA_1,f=h=!0):32===p&&(m=te.PIXELFORMAT_R8_G8_B8_A8),m){n=new te.Texture(n,{width:s,height:a,format:m,cubemap:r}),r&&(n.addressU=te.ADDRESS_CLAMP_TO_EDGE,n.addressV=te.ADDRESS_CLAMP_TO_EDGE);var _,g,y=128;for(p=r?6:1,u=827611204===u?8:16,m=0;m<p;m++)for(var v=s,b=a,S=0;S<o;S++)h?c?_=Math.floor((v+3)/4)*Math.floor((b+3)/4)*8:d?_=Math.max(v,16)*Math.max(b,8)/4:f?_=Math.max(v,8)*Math.max(b,8)/2:(_=Math.floor((v+4-1)/4),_*=g=Math.floor((b+4-1)/4),_*=u):_=v*b*4,g=l?new Float32Array(i,y,_):new Uint8Array(i,y,_),r?(n._levels[S]||(n._levels[S]=[]),n._levels[S][m]=g):n._levels[S]=g,y+=l?4*_:_,v=Math.max(.5*v,1),b=Math.max(.5*b,1);n.name=e,n.upload()}else(n=new te.Texture(n,{width:4,height:4,format:te.PIXELFORMAT_R8_G8_B8})).name="dds-legacy-empty";i=n}else{switch(s){case".dds":a=new te.DdsParser(t);break;case".ktx":a=new te.KtxParser(t)}if(!a)return(i=new te.Texture(this._device,{width:4,height:4,format:te.PIXELFORMAT_R8_G8_B8})).name="unsupported-empty",i;(i=new te.Texture(this._device,{addressU:a.cubemap?te.ADDRESS_CLAMP_TO_EDGE:te.ADDRESS_REPEAT,addressV:a.cubemap?te.ADDRESS_CLAMP_TO_EDGE:te.ADDRESS_REPEAT,width:a.width,height:a.height,format:a.format,cubemap:a.cubemap,levels:a.levels})).name=e,i.upload()}return function(e){var t=Math.log2(Math.max(e._width,e._height))+1,i=function(e){return e instanceof HTMLCanvasElement||e instanceof HTMLImageElement||e instanceof HTMLVideoElement};if(!(e._format!==te.PIXELFORMAT_R8_G8_B8_A8&&e._format!==te.PIXELFORMAT_RGBA32F||e._volume||e._compressed||1===e._levels.length||e._levels.length===t||i(e._cubemap?e._levels[0][0]:e._levels[0]))){i=function(e,t,i){for(var s=Math.max(1,e>>1),n=Math.max(1,t>>1),a=new i.constructor(s*n*4),r=Math.floor(e/s),o=r*(t=Math.floor(t/n)),h=0;h<n;++h)for(var l=0;l<s;++l)for(var c=0;c<4;++c){for(var d=0,u=0;u<t;++u)for(var p=0;p<r;++p)d+=i[4*(l*r+p+(h*t+u)*e)+c];a[4*(l+h*s)+c]=d/o}return a};for(var s=e._levels.length;s<t;++s){var n=Math.max(1,e._width>>s-1),a=Math.max(1,e._height>>s-1);if(e._cubemap){for(var r=[],o=0;o<6;++o)r.push(i(n,a,e._levels[s-1][o]));e._levels.push(r)}else e._levels.push(i(n,a,e._levels[s-1]))}e._levelsUpdated=e._cubemap?[[!0,!0,!0,!0,!0,!0]]:[!0]}}(i),i}},patch:function(e,t){var i=e.resource;if(i){i.name!==e.name&&(i.name=e.name),e.data.hasOwnProperty("minfilter")&&i.minFilter!==In[e.data.minfilter]&&(i.minFilter=In[e.data.minfilter]),e.data.hasOwnProperty("magfilter")&&i.magFilter!==In[e.data.magfilter]&&(i.magFilter=In[e.data.magfilter]),e.data.hasOwnProperty("addressu")&&i.addressU!==Pn[e.data.addressu]&&(i.addressU=Pn[e.data.addressu]),e.data.hasOwnProperty("addressv")&&i.addressV!==Pn[e.data.addressv]&&(i.addressV=Pn[e.data.addressv]),e.data.hasOwnProperty("mipmaps")&&i.mipmaps!==e.data.mipmaps&&(i.mipmaps=e.data.mipmaps),e.data.hasOwnProperty("anisotropy")&&i.anisotropy!==e.data.anisotropy&&(i.anisotropy=e.data.anisotropy);var s=!!e.data.rgbm;e.data.hasOwnProperty("rgbm")&&i.rgbm!==s&&(i.rgbm=s)}}}),{TextureHandler:wn})),Object.assign(te,(On=function(){this.retryRequests=!1},Object.assign(On.prototype,{load:function(i,s){"string"==typeof i&&(i={load:i,original:i}),te.http.get(i.load,{retry:this.retryRequests},function(e,t){e?s(te.string.format("Error loading html resource: {0} [{1}]",i.original,e)):s(null,t)})},open:function(e,t){return t},patch:function(e,t){}}),{HtmlHandler:On})),Object.assign(te,(Rn=function(){this.retryRequests=!1},Object.assign(Rn.prototype,{load:function(i,s){"string"==typeof i&&(i={load:i,original:i}),te.http.get(i.load,{retry:this.retryRequests},function(e,t){e?s(te.string.format("Error loading css resource: {0} [{1}]",i.original,e)):s(null,t)})},open:function(e,t){return t},patch:function(e,t){}}),{CssHandler:Rn,createStyle:function(e){var t=document.createElement("style");return t.type="text/css",t.styleSheet?t.styleSheet.cssText=e:t.appendChild(document.createTextNode(e)),t}})),Object.assign(te,(Ln=function(){this.retryRequests=!1},Object.assign(Ln.prototype,{load:function(i,s){"string"==typeof i&&(i={load:i,original:i}),te.http.get(i.load,{retry:this.retryRequests},function(e,t){e?s(te.string.format("Error loading shader resource: {0} [{1}]",i.original,e)):s(null,t)})},open:function(e,t){return t},patch:function(e,t){}}),{ShaderHandler:Ln})),Object.assign(te,(Dn=function(e){this._app=e,this.retryRequests=!1},Object.assign(Dn.prototype,{load:function(s,n){"string"==typeof s&&(s={load:s,original:s}),te.http.get(s.load,{retry:this.retryRequests},function(e,t){if(e){var i="Error while loading scene "+s.original;e.message?(i+=": "+e.message,e.stack&&(i+="\n"+e.stack)):i+=": "+e,n(i)}else n(null,t)})},open:function(e,t){this._app.systems.script.preloading=!0;var i=new te.SceneParser(this._app).parse(t),s=this._app.scene;return s.root=i,this._app.applySceneSettings(t.settings),this._app.systems.script.preloading=!1,s},patch:function(e,t){}}),{SceneHandler:Dn})),Object.assign(te,(Nn=function(e){this._app=e,this.retryRequests=!1},Object.assign(Nn.prototype,{load:function(s,n){"string"==typeof s&&(s={load:s,original:s}),te.http.get(s.load,{retry:this.retryRequests},function(e,t){if(e){var i="Error while loading scene "+s.original;e.message?(i+=": "+e.message,e.stack&&(i+="\n"+e.stack)):i+=": "+e,n(i)}else n(null,t)})},open:function(e,t){this._app.systems.script.preloading=!0;var i=new te.SceneParser(this._app).parse(t);return this._app.systems.script.preloading=!1,i}}),{HierarchyHandler:Nn})),Object.assign(te,(Fn=function(e){this._app=e,this.retryRequests=!1},Object.assign(Fn.prototype,{load:function(s,n){"string"==typeof s&&(s={load:s,original:s}),te.http.get(s.load,{retry:this.retryRequests},function(e,t){if(e){var i="Error while loading scene settings "+s.original;e.message?(i+=": "+e.message,e.stack&&(i+="\n"+e.stack)):i+=": "+e,n(i)}else n(null,t)})},open:function(e,t){return t.settings}}),{SceneSettingsHandler:Fn})),Object.assign(te,(Bn=function(){},Object.assign(Bn.prototype,{load:function(e,t){t(null,null)},open:function(e,t){return t}}),{FolderHandler:Bn})),Object.assign(te,function(){function r(n){return n.version<3&&(n.version<2&&(n.info.maps=n.info.maps||[{width:n.info.width,height:n.info.height}]),n.chars=Object.keys(n.chars||{}).reduce(function(e,t){var i=n.chars[t],s=void 0!==i.letter?i.letter:te.string.fromCodePoint(t);return n.version<2&&(i.map=i.map||0),e[s]=i,e},{}),n.version=3),n}var e=function(e){this._loader=e,this.retryRequests=!1};return Object.assign(e.prototype,{load:function(s,n,e){"string"==typeof s&&(s={load:s,original:s});var a=this;".json"===te.path.getExtension(s.original)?te.http.get(s.load,{retry:this.retryRequests},function(e,t){var i=r(t);e?n(te.string.format("Error loading font resource: {0} [{1}]",s.original,e)):a._loadTextures(s.original.replace(".json",".png"),i,function(e,t){if(e)return n(e);n(null,{data:i,textures:t})})}):(e&&e.data&&(e.data=r(e.data)),this._loadTextures(s.original,e&&e.data,n))},_loadTextures:function(t,e,s){var n=e.info.maps.length,a=0,r=null,o=Array(n),h=this._loader;e=function(i){var e=function(e,t){if(!r){if(e)return s(r=e);t.upload(),o[i]=t,++a===n&&s(null,o)}};0===i?h.load(t,"texture",e):h.load(t.replace(".png",i+".png"),"texture",e)};for(var i=0;i<n;i++)e(i)},open:function(e,t,i){return t.textures?new te.Font(t.textures,t.data):new te.Font(t,null)},patch:function(e,t){var i=e.resource;!i.data&&e.data?i.data=e.data:!e.data&&i.data&&(e.data=i.data),e.data&&(e.data=r(e.data))}}),{FontHandler:e}}()),Object.assign(te,(kn={repeat:te.ADDRESS_REPEAT,clamp:te.ADDRESS_CLAMP_TO_EDGE,mirror:te.ADDRESS_MIRRORED_REPEAT},Vn={nearest:te.FILTER_NEAREST,linear:te.FILTER_LINEAR,nearest_mip_nearest:te.FILTER_NEAREST_MIPMAP_NEAREST,linear_mip_nearest:te.FILTER_LINEAR_MIPMAP_NEAREST,nearest_mip_linear:te.FILTER_NEAREST_MIPMAP_LINEAR,linear_mip_linear:te.FILTER_LINEAR_MIPMAP_LINEAR},Un=/^data\.frames\.(\d+)$/,zn=function(e){this._loader=e,this.retryRequests=!1},Object.assign(zn.prototype,{load:function(s,n){"string"==typeof s&&(s={load:s,original:s});var a=this,e=this._loader.getHandler("texture");if(".json"!==te.path.getExtension(s.original))return e.load(s,n);te.http.get(s.load,{retry:this.retryRequests},function(e,i){if(e)n(e);else{var t=s.original.replace(".json",".png");a._loader.load(t,"texture",function(e,t){e?n(e):n(null,{data:i,texture:t})})}})},open:function(e,t){var i=new te.TextureAtlas;if(t.texture&&t.data)i.texture=t.texture,i.__data=t.data;else{var s=this._loader.getHandler("texture").open(e,t);if(!s)return null;i.texture=s}return i},patch:function(e,t){if(e.resource.__data&&(void 0!==e.resource.__data.minfilter&&(e.data.minfilter=e.resource.__data.minfilter),void 0!==e.resource.__data.magfilter&&(e.data.magfilter=e.resource.__data.magfilter),void 0!==e.resource.__data.addressu&&(e.data.addressu=e.resource.__data.addressu),void 0!==e.resource.__data.addressv&&(e.data.addressv=e.resource.__data.addressv),void 0!==e.resource.__data.mipmaps&&(e.data.mipmaps=e.resource.__data.mipmaps),void 0!==e.resource.__data.anisotropy&&(e.data.anisotropy=e.resource.__data.anisotropy),void 0!==e.resource.__data.rgbm&&(e.data.rgbm=!!e.resource.__data.rgbm),e.data.frames=e.resource.__data.frames,delete e.resource.__data),n=e.resource.texture){n.name=e.name,e.data.hasOwnProperty("minfilter")&&n.minFilter!==Vn[e.data.minfilter]&&(n.minFilter=Vn[e.data.minfilter]),e.data.hasOwnProperty("magfilter")&&n.magFilter!==Vn[e.data.magfilter]&&(n.magFilter=Vn[e.data.magfilter]),e.data.hasOwnProperty("addressu")&&n.addressU!==kn[e.data.addressu]&&(n.addressU=kn[e.data.addressu]),e.data.hasOwnProperty("addressv")&&n.addressV!==kn[e.data.addressv]&&(n.addressV=kn[e.data.addressv]),e.data.hasOwnProperty("mipmaps")&&n.mipmaps!==e.data.mipmaps&&(n.mipmaps=e.data.mipmaps),e.data.hasOwnProperty("anisotropy")&&n.anisotropy!==e.data.anisotropy&&(n.anisotropy=e.data.anisotropy);var i=!!e.data.rgbm;e.data.hasOwnProperty("rgbm")&&n.rgbm!==i&&(n.rgbm=i)}e.resource.texture=n;var s,n={};for(s in e.data.frames)i=e.data.frames[s],n[s]={rect:new te.Vec4(i.rect),pivot:new te.Vec2(i.pivot),border:new te.Vec4(i.border)};e.resource.frames=n,e.off("change",this._onAssetChange,this),e.on("change",this._onAssetChange,this)},_onAssetChange:function(e,t,i){if("data"===t||"data.frames"===t){var s,n={};for(s in i.frames)t=i.frames[s],n[s]={rect:new te.Vec4(t.rect),pivot:new te.Vec2(t.pivot),border:new te.Vec4(t.border)};e.resource.frames=n}else(t=t.match(Un))&&(s=t[1],i?(e.resource.frames[s]?((t=e.resource.frames[s]).rect.set(i.rect[0],i.rect[1],i.rect[2],i.rect[3]),t.pivot.set(i.pivot[0],i.pivot[1]),t.border.set(i.border[0],i.border[1],i.border[2],i.border[3])):e.resource.frames[s]={rect:new te.Vec4(i.rect),pivot:new te.Vec2(i.pivot),border:new te.Vec4(i.border)},e.resource.fire("set:frame",s,e.resource.frames[s])):e.resource.frames[s]&&(delete e.resource.frames[s],e.resource.fire("remove:frame",s)))}}),{TextureAtlasHandler:zn})),Object.assign(te,(Hn=function(e,t){this._assets=e,this._device=t,this.retryRequests=!1},jn=function(e){this.resource&&(this.resource.atlas=e.resource)},Gn=function(e){this.registry.load(e)},Object.assign(Hn.prototype,{load:function(e,i){"string"==typeof e&&(e={load:e,original:e}),".json"===te.path.getExtension(e.original)&&te.http.get(e.load,{retry:this.retryRequests},function(e,t){e?i(e):i(null,t)})},open:function(e,t){var i=new te.Sprite(this._device);return e&&(i.__data=t),i},patch:function(e,t){var i=e.resource;if(i.__data&&(e.data.pixelsPerUnit=i.__data.pixelsPerUnit,e.data.renderMode=i.__data.renderMode,e.data.frameKeys=i.__data.frameKeys,i.__data.textureAtlasAsset)){var s=t.getByUrl(i.__data.textureAtlasAsset);s&&(e.data.textureAtlasAsset=s.id)}i.startUpdate(),i.renderMode=e.data.renderMode,i.pixelsPerUnit=e.data.pixelsPerUnit,i.frameKeys=e.data.frameKeys,this._updateAtlas(e),i.endUpdate(),e.off("change",this._onAssetChange,this),e.on("change",this._onAssetChange,this)},_updateAtlas:function(e){var t=e.resource;if(e.data.textureAtlasAsset){this._assets.off("load:"+e.data.textureAtlasAsset,jn,e),this._assets.on("load:"+e.data.textureAtlasAsset,jn,e);var i=this._assets.get(e.data.textureAtlasAsset);i&&i.resource?t.atlas=i.resource:i?this._assets.load(i):(this._assets.off("add:"+e.data.textureAtlasAsset,Gn,e),this._assets.on("add:"+e.data.textureAtlasAsset,Gn,e))}else t.atlas=null},_onAssetChange:function(e,t,i,s){"data"===t&&i&&i.textureAtlasAsset&&s&&i.textureAtlasAsset!==s.textureAtlasAsset&&(this._assets.off("load:"+s.textureAtlasAsset,jn,e),this._assets.off("add:"+s.textureAtlasAsset,Gn,e))}}),{SpriteHandler:Hn})),Object.assign(te,(Wn={points:te.PRIMITIVE_POINTS,lines:te.PRIMITIVE_LINES,lineloop:te.PRIMITIVE_LINELOOP,linestrip:te.PRIMITIVE_LINESTRIP,triangles:te.PRIMITIVE_TRIANGLES,trianglestrip:te.PRIMITIVE_TRISTRIP,trianglefan:te.PRIMITIVE_TRIFAN},Yn={int8:te.TYPE_INT8,uint8:te.TYPE_UINT8,int16:te.TYPE_INT16,uint16:te.TYPE_UINT16,int32:te.TYPE_INT32,uint32:te.TYPE_UINT32,float32:te.TYPE_FLOAT32},Xn=function(e){this._device=e,this._defaultMaterial=te.getDefaultMaterial()},Object.assign(Xn.prototype,{parse:function(e){if(!(t=e.model)||t.version<=1)return null;var t=this._parseNodes(e),i=this._parseSkins(e,t),s=this._parseMorphs(e,t),n=this._parseVertexBuffers(e),a=this._parseIndexBuffers(e,n);return a=this._parseMeshes(e,i.skins,s.morphs,n,a.buffer,a.data),this._initMorphs(e,s.morphs,n,a),e=this._parseMeshInstances(e,t,a,i.skins,i.instances,s.morphs,s.instances),(n=new te.Model).graph=t[0],n.meshInstances=e,n.skinInstances=i.instances,n.morphInstances=s.instances,n.getGraph().syncHierarchy(),n},_parseNodes:function(e){e=e.model;var t,i=[];for(t=0;t<e.nodes.length;t++){var s=e.nodes[t],n=new te.GraphNode(s.name);n.setLocalPosition(s.position[0],s.position[1],s.position[2]),n.setLocalEulerAngles(s.rotation[0],s.rotation[1],s.rotation[2]),n.setLocalScale(s.scale[0],s.scale[1],s.scale[2]),n.scaleCompensation=!!s.scaleCompensation,i.push(n)}for(t=1;t<e.parents.length;t++)i[e.parents[t]].addChild(i[t]);return i},_parseSkins:function(e,t){var i,s,n=e.model,a=[],r=[];for(!this._device.supportsBoneTextures&&0<n.skins.length&&(i=this._device.getBoneLimit(),te.partitionSkin(n,null,i)),i=0;i<n.skins.length;i++){var o=n.skins[i],h=[];for(s=0;s<o.inverseBindMatrices.length;s++){var l=o.inverseBindMatrices[s];h[s]=(new te.Mat4).set(l)}for(o=new te.Skin(this._device,h,o.boneNames),a.push(o),h=new te.SkinInstance(o),l=[],s=0;s<o.boneNames.length;s++){var c=t[0].findByName(o.boneNames[s]);l.push(c)}h.bones=l,r.push(h)}return{skins:a,instances:r}},_parseMorphs:function(e,t){var i,s,n,a,r,o=e.model,h=[],l=[];if(o.morphs)for(i=0;i<o.morphs.length;i++){for(n=o.morphs[i].targets,r=[],s=0;s<n.length;s++){var c=n[s].aabb;a=c.min,c=c.max,a=new te.BoundingBox(new te.Vec3(.5*(c[0]+a[0]),.5*(c[1]+a[1]),.5*(c[2]+a[2])),new te.Vec3(.5*(c[0]-a[0]),.5*(c[1]-a[1]),.5*(c[2]-a[2]))),a=new te.MorphTarget({indices:n[s].indices,deltaPositions:n[s].deltaPositions,deltaNormals:n[s].deltaNormals,name:n[s].name,aabb:a}),r.push(a)}s=new te.Morph(r),h.push(s),s=new te.MorphInstance(s),l.push(s)}return{morphs:h,instances:l}},_calculateTangentsMorphTarget:function(e,t,i,s,n,a,r,o){var h,l,c,d,u,p,f,m,_,g,y,v,b,S,T,E,x,A,M,C;for(E=s.length/3,C=0;C<E;C++)x=s[3*C],A=s[3*C+1],M=s[3*C+2],f=e[3*x],u=e[3*x+1],p=e[3*x+2],d=e[3*A],m=e[3*A+1],_=e[3*A+2],g=e[3*M],y=e[3*M+1],v=e[3*M+2],b=i[2*x],h=i[2*x+1],S=i[2*A],c=i[2*A+1],T=i[2*M],d-=f,f=g-f,m-=u,u=y-u,_-=p,p=v-p,p=0==(h=(S-=b)*(v=(l=i[2*M+1])-h)-(b=T-b)*(c-=h))?(d=l=1,u=c=h=0):(h=(v*d-c*f)*(T=1/h),l=(v*m-c*u)*T,c=(v*_-c*p)*T,d=(S*f-b*d)*T,u=(S*u-b*m)*T,(S*p-b*_)*T),n[3*x+0]+=h,n[3*x+1]+=l,n[3*x+2]+=c,n[3*A+0]+=h,n[3*A+1]+=l,n[3*A+2]+=c,n[3*M+0]+=h,n[3*M+1]+=l,n[3*M+2]+=c,a[3*x+0]+=d,a[3*x+1]+=u,a[3*x+2]+=p,a[3*A+0]+=d,a[3*A+1]+=u,a[3*A+2]+=p,a[3*M+0]+=d,a[3*M+1]+=u,a[3*M+2]+=p;for(h=r.length,M=0;M<h;M++)_=t[3*(C=r[M])],l=t[3*C+1],m=t[3*C+2],e=n[3*C],i=n[3*C+1],s=n[3*C+2],E=a[3*C],x=a[3*C+1],A=a[3*C+2],f=_*(p=_*e+l*i+m*s),u=l*p,p*=m,d=l*s-i*m,m=m*e-s*_,_=_*i-e*l,e-=f,i-=u,s-=p,e*=p=1/Math.sqrt(e*e+i*i+s*s),i*=p,s*=p,o[4*C]=e,o[4*C+1]=i,o[4*C+2]=s,o[4*C+3]=d*E+m*x+_*A<0?-1:1;return o},_initMorphs:function(e,t,i,s){e=e.model;var n,a,r,o,h,l,c,d,u,p,f,m,_,g,y,v=[],b=[];for(i=0;i<s.length;i++)if(!b[u=e.meshes[i].vertices]&&(a=e.vertices[u]).tangent){var S=new Float32Array(a.tangent.data);if(b[u]=!0,a.position&&a.normal&&a.texCoord0){var T=[];for(n=0;n<e.meshes.length;n++)e.meshes[n].vertices===u&&(T=T.concat(e.meshes[n].indices));u=a.position.data,p=a.normal.data,f=a.texCoord0.data,m=u.length/3,_=T.length;var E=new Float32Array(4*m),x=new Float32Array(3*m),A=new Float32Array(3*m);for((g=new Float32Array(3*m)).set(u),(y=new Float32Array(3*m)).set(p),n=0;n<t.length;n++)if(e.meshes[i].morph===n)for(r=0;r<t[n]._targets.length;r++){var M=(a=t[n]._targets[r]).indices,C=M.length;if(0!==C){if(a.deltaTangents=new Float32Array(4*C),!d||d.length<m)d=new Uint8Array(m);else for(o=0;o<m;o++)d[o]=0;for(o=0;o<C;o++)d[h=M[o]]=1;var P=0;for(o=0;o<_;o+=3)h=T[o],l=T[o+1],c=T[o+2],(d[h]||d[l]||d[c])&&(v[P]=h,v[P+1]=l,v[P+2]=c,P+=3);for(v.length=P,l=a.deltaPositions,c=a.deltaNormals,o=0;o<C;o++)g[3*(h=M[o])]+=l[3*o],g[3*h+1]+=l[3*o+1],g[3*h+2]+=l[3*o+2],y[3*h]+=c[3*o],y[3*h+1]+=c[3*o+1],y[3*h+2]+=c[3*o+2];for(this._calculateTangentsMorphTarget(g,y,f,v,x,A,M,E),l=a.deltaTangents,o=0;o<C;o++)h=M[o],l[4*o]=E[4*o]-S[4*h],l[4*o+1]=E[4*o+1]-S[4*h+1],l[4*o+2]=E[4*o+2]-S[4*h+2],l[4*o+3]=E[4*o+3]-S[4*h+3];if(r!==t[n]._targets.length-1){for(o=0;o<_;o+=3)h=T[o],l=T[o+1],c=T[o+2],x[3*h+0]=0,x[3*h+1]=0,x[3*h+2]=0,x[3*l+0]=0,x[3*l+1]=0,x[3*l+2]=0,x[3*c+0]=0,x[3*c+1]=0,A[3*h+(x[3*c+2]=0)]=0,A[3*h+1]=0,A[3*h+2]=0,A[3*l+0]=0,A[3*l+1]=0,A[3*l+2]=0,A[3*c+0]=0,A[3*c+1]=0,A[3*c+2]=0;for(o=0;o<C;o++)g[3*(h=a.indices[o])]=u[3*h],g[3*h+1]=u[3*h+1],g[3*h+2]=u[3*h+2],y[3*h]=p[3*h],y[3*h+1]=p[3*h+1],y[3*h+2]=p[3*h+2]}}}}}},_parseVertexBuffers:function(e){e=e.model;var t,i,s,n,a=[],r={position:te.SEMANTIC_POSITION,normal:te.SEMANTIC_NORMAL,tangent:te.SEMANTIC_TANGENT,blendWeight:te.SEMANTIC_BLENDWEIGHT,blendIndices:te.SEMANTIC_BLENDINDICES,color:te.SEMANTIC_COLOR,texCoord0:te.SEMANTIC_TEXCOORD0,texCoord1:te.SEMANTIC_TEXCOORD1,texCoord2:te.SEMANTIC_TEXCOORD2,texCoord3:te.SEMANTIC_TEXCOORD3,texCoord4:te.SEMANTIC_TEXCOORD4,texCoord5:te.SEMANTIC_TEXCOORD5,texCoord6:te.SEMANTIC_TEXCOORD6,texCoord7:te.SEMANTIC_TEXCOORD7};for(s=0;s<e.vertices.length;s++){var o=e.vertices[s],h=[];for(i in o)t=o[i],h.push({semantic:r[i],components:t.components,type:Yn[t.type],normalize:r[i]===te.SEMANTIC_COLOR});t=new te.VertexFormat(this._device,h),h=o.position.data.length/o.position.components;var l=new te.VertexBuffer(this._device,t,h),c=new te.VertexIterator(l);for(n=0;n<h;n++){for(i in o)switch(t=o[i],t.components){case 1:c.element[r[i]].set(t.data[n]);break;case 2:c.element[r[i]].set(t.data[2*n],t.data[2*n+1]);break;case 3:c.element[r[i]].set(t.data[3*n],t.data[3*n+1],t.data[3*n+2]);break;case 4:c.element[r[i]].set(t.data[4*n],t.data[4*n+1],t.data[4*n+2],t.data[4*n+3])}c.next()}c.end(),a.push(l)}return a},_parseIndexBuffers:function(e,t){var i,s=e.model,n=null,a=null,r=0;for(i=0;i<s.meshes.length;i++){var o=s.meshes[i];void 0!==o.indices&&(r+=o.indices.length)}for(i=s=0;i<t.length;i++)s=Math.max(s,t[i].numVertices);return 0<r&&(a=65535<s&&this._device.extUintElement?(n=new te.IndexBuffer(this._device,te.INDEXFORMAT_UINT32,r),new Uint32Array(n.lock())):(n=new te.IndexBuffer(this._device,te.INDEXFORMAT_UINT16,r),new Uint16Array(n.lock()))),{buffer:n,data:a}},_parseMeshes:function(e,t,i,s,n,a){e=e.model;var r,o=[],h=0;for(r=0;r<e.meshes.length;r++){var l=e.meshes[r],c=(d=l.aabb).min,d=d.max,u=(c=new te.BoundingBox(new te.Vec3(.5*(d[0]+c[0]),.5*(d[1]+c[1]),.5*(d[2]+c[2])),new te.Vec3(.5*(d[0]-c[0]),.5*(d[1]-c[1]),.5*(d[2]-c[2]))),d=void 0!==l.indices,new te.Mesh);u.vertexBuffer=s[l.vertices],u.indexBuffer[0]=d?n:null,u.primitive[0].type=Wn[l.type],u.primitive[0].base=d?l.base+h:l.base,u.primitive[0].count=l.count,u.primitive[0].indexed=d,u.skin=void 0!==l.skin?t[l.skin]:null,u.morph=void 0!==l.morph?i[l.morph]:null,u.aabb=c,d&&(a.set(l.indices,h),h+=l.indices.length),o.push(u)}return null!==n&&n.unlock(),o},_parseMeshInstances:function(e,t,i,s,n,a,r){e=e.model;var o,h=[];for(o=0;o<e.meshInstances.length;o++){var l=i[(c=e.meshInstances[o]).mesh],c=new te.MeshInstance(t[c.node],l,this._defaultMaterial);if(l.skin){var d=s.indexOf(l.skin);c.skinInstance=n[d]}l.morph&&(l=a.indexOf(l.morph),c.morphInstance=r[l]),h.push(c)}return h}}),{JsonModelParser:Xn})),Object.assign(te,(qn=function(e){this._app=e},Object.assign(qn.prototype,{parse:function(e){var t,i,s={},n=null;for(t in e.entities)s[t]=this._createEntity(e.entities[t]),null===e.entities[t].parent&&(n=s[t]);for(t in e.entities){var a=e.entities[t].children.length;for(i=0;i<a;i++){var r=e.entities[t].children[i];s[r]&&s[t].addChild(s[r])}}return this._openComponentData(n,e.entities),n},_createEntity:function(e){var t=new te.Entity,i=e.position,s=e.rotation,n=e.scale;if(t.name=e.name,t.setGuid(e.resource_id),t.setLocalPosition(i[0],i[1],i[2]),t.setLocalEulerAngles(s[0],s[1],s[2]),t.setLocalScale(n[0],n[1],n[2]),t._enabled=void 0===e.enabled||e.enabled,t._enabledInHierarchy=t._enabled,t.template=e.template,e.tags)for(i=0;i<e.tags.length;i++)t.tags.add(e.tags[i]);return e.labels&&e.labels.forEach(function(e){t.addLabel(e)}),t},_openComponentData:function(e,t){var i,s=this._app.systems.list,n=s.length,a=t[e.getGuid()];for(i=0;i<n;i++){var r=s[i],o=a.components[r.id];o&&r.addComponent(e,o)}for(n=a.children.length,s=e._children,i=0;i<n;i++)s[i]=this._openComponentData(s[i],t);return e}}),{SceneParser:qn})),Object.assign(te,((Kn=function(){this._validator=null}).prototype.parse=function(e){e=this.migrate(e),e=this._validate(e);var t=new te.StandardMaterial;return this.initialize(t,e),t},Kn.prototype.initialize=function(e,t){for(var i in t.validated||(this._validator||(this._validator=new te.StandardMaterialValidator),this._validator.validate(t)),t.chunks&&e.chunks.copy(t.chunks),t){var s=te.StandardMaterial.PARAMETER_TYPES[i],n=t[i];"vec2"===s?e[i]=new te.Vec2(n[0],n[1]):"rgb"===s?e[i]=new te.Color(n[0],n[1],n[2]):"texture"===s?n instanceof te.Texture?e[i]=n:e[i]instanceof te.Texture&&"number"==typeof n&&0<n||(e[i]=null):"cubemap"===s?n instanceof te.Texture?e[i]=n:e[i]instanceof te.Texture&&"number"==typeof n&&0<n||(e[i]=null):"boundingbox"===s?(s=new te.Vec3(n.center[0],n.center[1],n.center[2]),n=new te.Vec3(n.halfExtents[0],n.halfExtents[1],n.halfExtents[2]),e[i]=new te.BoundingBox(s,n)):e[i]=t[i]}e.update()},Kn.prototype.migrate=function(e){void 0===e.shadingModel&&(e.shadingModel="blinn"===e.shader?te.SPECULAR_BLINN:te.SPECULAR_PHONG),e.shader&&delete e.shader,e.mapping_format&&(e.mappingFormat=e.mapping_format,delete e.mapping_format);var t,i=[["bumpMapFactor","bumpiness"],["aoUvSet","aoMapUv"],["aoMapVertexColor","aoVertexColor"],["diffuseMapVertexColor","diffuseVertexColor"],["emissiveMapVertexColor","emissiveVertexColor"],["specularMapVertexColor","specularVertexColor"],["metalnessMapVertexColor","metalnessVertexColor"],["opacityMapVertexColor","opacityVertexColor"],["glossMapVertexColor","glossVertexColor"],["lightMapVertexColor","lightVertexColor"],["diffuseMapTint","diffuseTint"],["specularMapTint","specularTint"],["emissiveMapTint","emissiveTint"],["metalnessMapTint","metalnessTint"]];for(t=0;t<i.length;t++){var s=i[t][0],n=i[t][1];void 0!==e[s]&&void 0===e[n]&&(e[n]=e[s],delete e[s])}for(i=["fresnelFactor","shadowSampleType"],t=0;t<i.length;t++)s=i[t],e.hasOwnProperty(s)&&delete e[s];return e},Kn.prototype._validate=function(e){return this._validator||(this._validator=new te.StandardMaterialValidator),this._validator.validate(e),e},{JsonStandardMaterialParser:Kn})),Object.assign(te,(Zn=0,Qn=/^\s*(?:[a-z]+[a-z0-9\-\+\.]*:)?\/\//i,$n={pvr:"extCompressedTexturePVRTC",dxt:"extCompressedTextureS3TC",etc2:"extCompressedTextureETC",etc1:"extCompressedTextureETC1"},Jn=["pvr","dxt","etc2","etc1"],ea=function(e,t,i,s){this._id=++Zn,this.name=e||"",this.type=t,this.tags=new te.Tags(this),this._preload=!1,this.variants=new te.AssetVariants(this),this._file=null,this._data=s||{},this._resources=[],this._i18n={},this.loading=this.loaded=!1,this.registry=null,te.events.attach(this),i&&(this.file=i)},Object.assign(ea.prototype,{getFileUrl:function(){var e=this.getPreferredFile();if(!e||!e.url)return null;var t=e.url;if(this.registry&&this.registry.prefix&&!Qn.test(t)&&(t=this.registry.prefix+t),"script"!==this.type&&e.hash){var i=-1!==t.indexOf("?")?"&":"?";t=t+i+"t="+e.hash}return t},getPreferredFile:function(){if(!this.file)return null;if("texture"===this.type||"textureatlas"===this.type||"bundle"===this.type)for(var e=this.registry._loader._app,t=e.graphicsDevice,i=0,s=Jn.length;i<s;i++){var n=Jn[i];if(t[$n[n]]){if(this.file.variants[n])return this.file.variants[n];if(e.enableBundles){var a=e.bundles.listBundlesForAsset(this);if(a)for(var r=0,o=a.length;r<o;r++)if(a[r].file&&a[r].file.variants&&a[r].file.variants[n])return this.file}}}return this.file},getLocalizedAssetId:function(e){return e=te.I18n.findAvailableLocale(e,this._i18n),this._i18n[e]||null},addLocalizedAssetId:function(e,t){this._i18n[e]=t,this.fire("add:localized",e,t)},removeLocalizedAssetId:function(e){var t=this._i18n[e];t&&(delete this._i18n[e],this.fire("remove:localized",e,t))},ready:function(t,i){i=i||this,this.resource?t.call(i,this):this.once("load",function(e){t.call(i,e)})},reload:function(){this.loaded&&("cubemap"===this.type?this.registry._loader.patch(this,this.registry):(this.loaded=!1,this.registry.load(this)))},unload:function(){(this.loaded||this.resource)&&(this.fire("unload",this),this.registry.fire("unload:"+this.id,this),this.resource&&this.resource.destroy&&this.resource.destroy(),this.resource=null,this.loaded=!1,this.file&&this.registry._loader.clearCache(this.getFileUrl(),this.type))}}),Object.defineProperty(ea.prototype,"id",{get:function(){return this._id},set:function(e){this._id=e,Zn<e&&(Zn=e)}}),Object.defineProperty(ea.prototype,"file",{get:function(){return this._file},set:function(e){var t;if(!!e!=!!this._file||e&&this._file&&e.hash!==this._file)if(e){if(this._file||(this._file={}),this._file.url=e.url,this._file.filename=e.filename,this._file.hash=e.hash,this._file.size=e.size,this._file.variants=this.variants,e.hasOwnProperty("variants")&&(this.variants.clear(),e.variants))for(t in e.variants)e.variants[t]&&(this.variants[t]=e.variants[t]);this.fire("change",this,"file",this._file,this._file),this.reload()}else this._file=null,this.variants.clear();else if(e&&this._file&&e.hasOwnProperty("variants")&&(this.variants.clear(),e.variants))for(t in e.variants)e.variants[t]&&(this.variants[t]=e.variants[t])}}),Object.defineProperty(ea.prototype,"data",{get:function(){return this._data},set:function(e){var t=this._data;(this._data=e)!==t&&(this.fire("change",this,"data",e,t),this.loaded&&this.registry._loader.patch(this,this.registry))}}),Object.defineProperty(ea.prototype,"resource",{get:function(){return this._resources[0]},set:function(e){var t=this._resources[0];this._resources[0]=e,this.fire("change",this,"resource",e,t)}}),Object.defineProperty(ea.prototype,"resources",{get:function(){return this._resources},set:function(e){var t=this._resources;this._resources=e,this.fire("change",this,"resources",e,t)}}),Object.defineProperty(ea.prototype,"preload",{get:function(){return this._preload},set:function(e){e=!!e,this._preload!==e&&(this._preload=e)&&!this.loaded&&!this.loading&&this.registry&&this.registry.load(this)}}),{Asset:ea,ASSET_ANIMATION:"animation",ASSET_AUDIO:"audio",ASSET_IMAGE:"image",ASSET_JSON:"json",ASSET_MODEL:"model",ASSET_MATERIAL:"material",ASSET_TEXT:"text",ASSET_TEXTURE:"texture",ASSET_CUBEMAP:"cubemap",ASSET_SHADER:"shader",ASSET_CSS:"css",ASSET_HTML:"html",ASSET_SCRIPT:"script",ABSOLUTE_URL:Qn})),Object.assign(te,(ta=[],ia=function(e){this.asset=e},(sa=function(e){var t="_"+e;ta.push(t),Object.defineProperty(ia.prototype,e,{get:function(){return this[t]||null},set:function(e){(!!this[t]!=!!e||this[t]&&e&&this[t].hash!==e.hash)&&(this[t]=e?{url:e.url,filename:e.filename,size:e.size,hash:e.hash,opt:e.opt||0}:null,this.asset.file&&(this.asset.fire("change",this.asset,"file",this.asset._file,this.asset._file),this.asset.reload()))}})})("dxt"),sa("pvr"),sa("etc1"),sa("etc2"),ia.prototype.clear=function(){for(var e=0;e<ta.length;e++)this[ta[e]]=null},{AssetVariants:ia})),Object.assign(te,(na=function(e){this._loader=e,this._assets=[],this._cache={},this._names={},this._tags=new te.TagsCache("_id"),this._urls={},this.prefix=null,te.events.attach(this)},Object.assign(na.prototype,{list:function(i){return i=i||{},this._assets.filter(function(e){var t=!0;return void 0!==i.preload&&(t=e.preload===i.preload),t})},add:function(e){var t,i=this._assets.push(e)-1;this._cache[e.id]=i,this._names[e.name]||(this._names[e.name]=[]),this._names[e.name].push(i),e.file&&(t=e.file.url,this._urls[t]=i),(e.registry=this)._tags.addItem(e),e.tags.on("add",this._onTagAdd,this),e.tags.on("remove",this._onTagRemove,this),this.fire("add",e),this.fire("add:"+e.id,e),t&&this.fire("add:url:"+t,e),e.preload&&this.load(e)},remove:function(e){var t=this._cache[e.id],i=e.file?e.file.url:null;if(void 0===t)return!1;this._assets.splice(t,1),delete this._cache[e.id],this._names={},this._urls=[],t=0;for(var s=this._assets.length;t<s;t++){var n=this._assets[t];this._cache[n.id]=t,this._names[n.name]||(this._names[n.name]=[]),this._names[n.name].push(t),n.file&&(this._urls[n.file.url]=t)}return this._tags.removeItem(e),e.tags.off("add",this._onTagAdd,this),e.tags.off("remove",this._onTagRemove,this),e.fire("remove",e),this.fire("remove",e),this.fire("remove:"+e.id,e),i&&this.fire("remove:url:"+i,e),!0},get:function(e){return this._assets[this._cache[e]]},getByUrl:function(e){return this._assets[this._urls[e]]},load:function(s){if(!s.loading){var n=this;if(s.loaded)"cubemap"===s.type&&n._loader.patch(s,this);else{var e=!!s.file,a=s.getPreferredFile(),i=function(){var e=n._loader.open(s.type,s.data);e instanceof Array?s.resources=e:s.resource=e,s.loaded=!0,n._loader.patch(s,n),n.fire("load",s),n.fire("load:"+s.id,s),a&&a.url&&n.fire("load:url:"+a.url,s),s.fire("load",s)};if(a&&"cubemap"===s.type){e=!1;var t=s.getFileUrl();this._loader.load(t,"texture",function(e,t){e?(n.fire("error",e,s),n.fire("error:"+s.id,e,s),s.fire("error",e,s)):(n._loader.patch({resource:t,type:"texture",data:s.data},n),s._dds=t,i())})}a?e&&(this.fire("load:start",s),this.fire("load:"+s.id+":start",s),r=s.getFileUrl(),s.loading=!0,n._loader.load(r,s.type,function(e,t,i){s.loaded=!0,s.loading=!1,e?(n.fire("error",e,s),n.fire("error:"+s.id,e,s),s.fire("error",e,s)):(t instanceof Array?s.resources=t:s.resource=t,te.script.legacy||"script"!==s.type||((e=n._loader.getHandler("script"))._cache[s.id]&&e._cache[s.id].parentNode===document.head&&document.head.removeChild(e._cache[s.id]),e._cache[s.id]=i),n._loader.patch(s,n),n.fire("load",s),n.fire("load:"+s.id,s),a&&a.url&&n.fire("load:url:"+a.url,s),s.fire("load",s))},s)):i()}}var r},loadFromUrl:function(e,t,i){var s=te.path.getBasename(e),n={url:e};(e=this.getByUrl(e))||(e=new te.Asset(s,t,n,{}),this.add(e)),"model"===t?this._loadModel(e,i):(e.once("load",function(e){i(null,e)}),e.once("error",function(e){i(e)}),this.load(e))},_loadModel:function(s,t){var n=this,e=s.getFileUrl(),a=te.path.getDirectory(e),i=te.path.getBasename(e),r=function(e){s.once("load",function(e){t(null,e)}),s.once("error",function(e){t(e)}),n.load(e)};".json"===te.path.getExtension(e)?(e=te.path.join(a,i.replace(".json",".mapping.json")),this._loader.load(e,"json",function(e,i){e?(s.data={mapping:[]},r(s)):n._loadMaterials(a,i,function(e,t){s.data=i,r(s)})})):r(s)},_loadMaterials:function(e,t,s){var i,n=this,a=t.mapping.length,r=[];0===a&&s(null,r);var o=function(e,t){r.push(t),0==--a&&function(e,i){n._loadTextures(i,function(e,t){s(null,i)})}(0,r)};for(i=0;i<t.mapping.length;i++){var h=t.mapping[i].path;h?(h=te.path.join(e,h),n.loadFromUrl(h,"material",o)):a--}},_loadTextures:function(e,i){var t,s={},n=[],a=[],r=0;for(t=0;t<e.length;t++){var o=e[t].data;if("path"!==o.mappingFormat);else for(var h,l=e[t].getFileUrl(),c=(l=te.path.getDirectory(l),0);c<te.StandardMaterial.TEXTURE_PARAMETERS.length;c++)o[h=te.StandardMaterial.TEXTURE_PARAMETERS[c]]&&(s[h=te.path.join(l,o[h])]||(s[h]=!0,n.push(h),r++))}if(r)for(s=function(e,t){a.push(t),0==--r&&i(null,a)},t=0;t<n.length;t++)this.loadFromUrl(n[t],"texture",s);else i(null,a)},findAll:function(e,t){var i=this,s=this._names[e];return s?(s=s.map(function(e){return i._assets[e]}),t?s.filter(function(e){return e.type===t}):s):[]},_onTagAdd:function(e,t){this._tags.add(e,t)},_onTagRemove:function(e,t){this._tags.remove(e,t)},findByTag:function(){return this._tags.find(arguments)},filter:function(e){for(var t=[],i=0,s=this._assets.length;i<s;i++)e(this._assets[i])&&t.push(this._assets[i]);return t},find:function(e,t){var i=this.findAll(e,t);return i?i[0]:null},getAssetById:function(e){return this.get(e)}}),{AssetRegistry:na})),Object.assign(te,((aa=function(e,t,i,s,n){this.propertyName=e,this.parent=t,this._scope=n,this._registry=i,this.asset=this.url=this.id=null,this._onAssetLoad=s.load,this._onAssetAdd=s.add,this._onAssetRemove=s.remove}).prototype._bind=function(){this.id&&(this._onAssetLoad&&this._registry.on("load:"+this.id,this._onLoad,this),this._onAssetAdd&&this._registry.once("add:"+this.id,this._onAdd,this),this._onAssetRemove&&this._registry.on("remove:"+this.id,this._onRemove,this)),this.url&&(this._onAssetLoad&&this._registry.on("load:url:"+this.url,this._onLoad,this),this._onAssetAdd&&this._registry.once("add:url:"+this.url,this._onAdd,this),this._onAssetRemove&&this._registry.on("remove:url:"+this.url,this._onRemove,this))},aa.prototype._unbind=function(){this.id&&(this._onAssetLoad&&this._registry.off("load:"+this.id,this._onLoad,this),this._onAssetAdd&&this._registry.off("add:"+this.id,this._onAdd,this),this._onAssetRemove&&this._registry.off("remove:"+this.id,this._onRemove,this)),this.url&&(this._onAssetLoad&&this._registry.off("load:"+this.url,this._onLoad,this),this._onAssetAdd&&this._registry.off("add:"+this.url,this._onAdd,this),this._onAssetRemove&&this._registry.off("remove:"+this.url,this._onRemove,this))},aa.prototype._onLoad=function(e){this._onAssetLoad.call(this._scope,this.propertyName,this.parent,e)},aa.prototype._onAdd=function(e){this._onAssetAdd.call(this._scope,this.propertyName,this.parent,e)},aa.prototype._onRemove=function(e){this._onAssetRemove.call(this._scope,this.propertyName,this.parent,e)},Object.defineProperty(aa.prototype,"id",{get:function(){return this._id},set:function(e){if(this.url)throw Error("Can't set id and url");this._unbind(),this._id=e,this.asset=this._registry.get(this._id),this._bind()}}),Object.defineProperty(aa.prototype,"url",{get:function(){return this._url},set:function(e){if(this.id)throw Error("Can't set id and url");this._unbind(),this._url=e,this.asset=this._registry.getByUrl(this._url),this._bind()}}),{AssetReference:aa})),Object.assign(te,((ra=function(e){(this._app=e).i18n.on("set:locale",this._onSetLocale,this),this._disableLocalization=this._autoLoad=!1,this._localizedAsset=this._defaultAsset=null,te.events.attach(this)}).prototype._bindDefaultAsset=function(){var e=this._app.assets.get(this._defaultAsset);e?this._onDefaultAssetAdd(e):this._app.assets.once("add:"+this._defaultAsset,this._onDefaultAssetAdd,this)},ra.prototype._unbindDefaultAsset=function(){if(this._defaultAsset){this._app.assets.off("add:"+this._defaultAsset,this._onDefaultAssetAdd,this);var e=this._app.assets.get(this._defaultAsset);e&&(e.off("add:localized",this._onLocaleAdd,this),e.off("remove:localized",this._onLocaleRemove,this),e.off("remove",this._onDefaultAssetRemove,this))}},ra.prototype._onDefaultAssetAdd=function(e){this._defaultAsset===e.id&&(e.on("add:localized",this._onLocaleAdd,this),e.on("remove:localized",this._onLocaleRemove,this),e.once("remove",this._onDefaultAssetRemove,this))},ra.prototype._onDefaultAssetRemove=function(e){this._defaultAsset===e.id&&(e.off("add:localized",this._onLocaleAdd,this),e.off("remove:localized",this._onLocaleAdd,this),this._app.assets.once("add:"+this._defaultAsset,this._onDefaultAssetAdd,this))},ra.prototype._bindLocalizedAsset=function(){if(this._autoLoad){var e=this._app.assets.get(this._localizedAsset);e&&(e.on("load",this._onLocalizedAssetLoad,this),e.on("change",this._onLocalizedAssetChange,this),e.on("remove",this._onLocalizedAssetRemove,this),e.resource?this._onLocalizedAssetLoad(e):this._app.assets.load(e))}},ra.prototype._unbindLocalizedAsset=function(){var e=this._app.assets.get(this._localizedAsset);e&&(e.off("load",this._onLocalizedAssetLoad,this),e.off("change",this._onLocalizedAssetChange,this),e.off("remove",this._onLocalizedAssetRemove,this))},ra.prototype._onLocalizedAssetAdd=function(e){this._localizedAsset===e.id&&this._bindLocalizedAsset()},ra.prototype._onLocalizedAssetLoad=function(e){this.fire("load",e)},ra.prototype._onLocalizedAssetChange=function(e,t,i,s){this.fire("change",e,t,i,s)},ra.prototype._onLocalizedAssetRemove=function(e){this._localizedAsset===e.id&&(this.localizedAsset=this._defaultAsset),this.fire("remove",e)},ra.prototype._onLocaleAdd=function(e,t){this._app.i18n.locale===e&&this._onSetLocale(e)},ra.prototype._onLocaleRemove=function(e,t){this._app.i18n.locale===e&&this._onSetLocale(e)},ra.prototype._onSetLocale=function(e){if(this._defaultAsset){var t=this._app.assets.get(this._defaultAsset);this.localizedAsset=!t||this._disableLocalization?this._defaultAsset:(e=t.getLocalizedAssetId(e))?e:this._defaultAsset}else this.localizedAsset=null},ra.prototype.destroy=function(){this.defaultAsset=null,this._app.i18n.off("set:locale",this._onSetLocale,this),this.off()},Object.defineProperty(ra.prototype,"defaultAsset",{get:function(){return this._defaultAsset},set:function(e){e=e instanceof te.Asset?e.id:e,this._defaultAsset!==e&&(this._defaultAsset&&this._unbindDefaultAsset(),(this._defaultAsset=e)&&this._bindDefaultAsset(),this._onSetLocale(this._app.i18n.locale))}}),Object.defineProperty(ra.prototype,"localizedAsset",{get:function(){return this._localizedAsset},set:function(e){e=e instanceof te.Asset?e.id:e,this._localizedAsset!==e&&(this._localizedAsset&&(this._app.assets.off("add:"+this._localizedAsset,this._onLocalizedAssetAdd,this),this._unbindLocalizedAsset(),this._localizedAsset=null),this._localizedAsset=e)&&(this._app.assets.get(this._localizedAsset)?this._bindLocalizedAsset():this._app.assets.once("add:"+this._localizedAsset,this._onLocalizedAssetAdd,this))}}),Object.defineProperty(ra.prototype,"autoLoad",{get:function(){return this._autoLoad},set:function(e){this._autoLoad!==e&&(this._autoLoad=e)&&this._localizedAsset&&(this._unbindLocalizedAsset(),this._bindLocalizedAsset())}}),Object.defineProperty(ra.prototype,"disableLocalization",{get:function(){return this._disableLocalization},set:function(e){this._disableLocalization!==e&&(this._disableLocalization=e,this._onSetLocale(this._app.i18n.locale))}}),{LocalizedAsset:ra})),Object.assign(te,((oa=function(e,t){if(this._assets=[],this._registry=t,this._loaded=!1,this._total=this._count=0,this._failed=[],this._waitingAssets=[],e.length&&e[0]instanceof te.Asset)this._assets=e;else for(var i=0;i<e.length;i++){var s=t.get(e[i]);s?this._assets.push(s):(this._waitForAsset(e[i]),this._total++)}te.events.attach(this)}).prototype.destroy=function(){var t=this;this._registry.off("load",this._onLoad),this._registry.off("error",this._onError),this._waitingAssets.forEach(function(e){t._registry.off("add:"+e,this._onAddAsset)}),this.off("progress"),this.off("load")},oa.prototype.load=function(e,t){var i,s,n=this._assets.length;for(this._count=0,this._failed=[],this._callback=e,this._scope=t,this._registry.on("load",this._onLoad,this),this._registry.on("error",this._onError,this),i=0;i<n;i++)(s=this._assets[i]).loading||s.loaded||(this._registry.load(s),this._total++)},oa.prototype.ready=function(t,i){i=i||this,this._loaded?t.call(i,this._assets):this.once("load",function(e){t.call(i,e)})},oa.prototype._loadingComplete=function(){this._loaded=!0,this._registry.off("load",this._onLoad,this),this._registry.off("error",this._onError,this),this._failed&&this._failed.length?(this._callback&&this._callback.call(this._scope,"Failed to load some assets",this._failed),this.fire("error",this._failed)):(this._callback&&this._callback.call(this._scope),this.fire("load",this._assets))},oa.prototype._onLoad=function(e){var t=this;0<=this._assets.indexOf(e)&&(this._count++,this.fire("progress",e)),this._count===this._total&&setTimeout(function(){t._loadingComplete(t._failed)},0)},oa.prototype._onError=function(e,t){var i=this;0<=this._assets.indexOf(t)&&(this._count++,this._failed.push(t)),this._count===this._total&&setTimeout(function(){i._loadingComplete(i._failed)},0)},oa.prototype._onAddAsset=function(e){0<=(i=this._waitingAssets.indexOf(e))&&this._waitingAssets.splice(i,1),this._assets.push(e);for(var t=this._assets.length,i=0;i<t;i++)(e=this._assets[i]).loading||e.loaded||this._registry.load(e)},oa.prototype._waitForAsset=function(e){this._waitingAssets.push(e),this._registry.once("add:"+e,this._onAddAsset,this)},{AssetListLoader:oa})),Object.assign(te,{inherits:function(h,l){var e=function(){},t=function(e,t,i,s,n,a,r,o){l.call(this,e,t,i,s,n,a,r,o),h.call(this,e,t,i,s,n,a,r,o)};return t._super=l.prototype,e.prototype=l.prototype,t.prototype=new e,t}}),te.anim={Animation:te.Animation,Key:te.Key,Node:te.Node,Skeleton:te.Skeleton},te.asset={ASSET_ANIMATION:"animation",ASSET_AUDIO:"audio",ASSET_IMAGE:"image",ASSET_JSON:"json",ASSET_MODEL:"model",ASSET_MATERIAL:"material",ASSET_TEXT:"text",ASSET_TEXTURE:"texture",ASSET_CUBEMAP:"cubemap",ASSET_SCRIPT:"script"},te.audio={AudioManager:te.SoundManager,Channel:te.Channel,Channel3d:te.Channel3d,Listener:te.Listener,Sound:te.Sound},te.fw={Application:te.Application,Component:te.Component,ComponentData:te.ComponentData,ComponentSystem:te.ComponentSystem,Entity:te.Entity,FillMode:{NONE:te.FILLMODE_NONE,FILL_WINDOW:te.FILLMODE_FILL_WINDOW,KEEP_ASPECT:te.FILLMODE_KEEP_ASPECT},ResolutionMode:{AUTO:te.RESOLUTION_AUTO,FIXED:te.RESOLUTION_FIXED}},Object.assign(te.gfx,{drawQuadWithShader:te.drawQuadWithShader,programlib:te.programlib,shaderChunks:te.shaderChunks,ContextCreationError:te.ContextCreationError,Device:te.GraphicsDevice,IndexBuffer:te.IndexBuffer,ProgramLibrary:te.ProgramLibrary,RenderTarget:te.RenderTarget,ScopeId:te.ScopeId,Shader:te.Shader,ShaderInput:te.ShaderInput,Texture:te.Texture,UnsupportedBrowserError:te.UnsupportedBrowserError,VertexBuffer:te.VertexBuffer,VertexFormat:te.VertexFormat,VertexIterator:te.VertexIterator}),function(){function e(e){this.name="UnsupportedBrowserError",this.message=e||""}function t(e){this.name="ContextCreationError",this.message=e||""}e.prototype=Error.prototype,t.prototype=Error.prototype,te.ContextCreationError=t,te.UnsupportedBrowserError=e}(),Object.assign(te.input,{getTouchTargetCoords:te.getTouchTargetCoords,Controller:te.Controller,GamePads:te.GamePads,Keyboard:te.Keyboard,KeyboardEvent:te.KeyboardEvent,Mouse:te.Mouse,MouseEvent:te.MouseEvent,Touch:te.Touch,TouchDevice:te.TouchDevice,TouchEvent:te.TouchEvent}),te.math.INV_LOG2=Math.LOG2E,te.math.intToBytes=te.math.intToBytes32,te.math.bytesToInt=te.math.bytesToInt32,te.posteffect={createFullscreenQuad:te.createFullscreenQuad,drawFullscreenQuad:te.drawFullscreenQuad,PostEffect:te.PostEffect,PostEffectQueue:te.PostEffectQueue},Object.assign(te.scene,{partitionSkin:te.partitionSkin,procedural:{calculateTangents:te.calculateTangents,createMesh:te.createMesh,createTorus:te.createTorus,createCylinder:te.createCylinder,createCapsule:te.createCapsule,createCone:te.createCone,createSphere:te.createSphere,createPlane:te.createPlane,createBox:te.createBox},BasicMaterial:te.BasicMaterial,DepthMaterial:te.DepthMaterial,ForwardRenderer:te.ForwardRenderer,GraphNode:te.GraphNode,Material:te.Material,Command:te.Command,Mesh:te.Mesh,MeshInstance:te.MeshInstance,Model:te.Model,ParticleEmitter:te.ParticleEmitter,PhongMaterial:te.StandardMaterial,Picker:te.Picker,PickMaterial:te.PickMaterial,Projection:{ORTHOGRAPHIC:te.PROJECTION_ORTHOGRAPHIC,PERSPECTIVE:te.PROJECTION_PERSPECTIVE},Scene:te.Scene,Skin:te.Skin,SkinInstance:te.SkinInstance}),te.shape={Aabb:te.BoundingBox,Sphere:te.BoundingSphere,Plane:te.Plane},te.time={now:te.now,Timer:te.Timer},te.PhongMaterial=te.StandardMaterial,te.BoundingSphere.prototype.intersectRay=te.BoundingSphere.prototype.intersectsRay,te.ELEMENTTYPE_INT8=te.TYPE_INT8,te.ELEMENTTYPE_UINT8=te.TYPE_UINT8,te.ELEMENTTYPE_INT16=te.TYPE_INT16,te.ELEMENTTYPE_UINT16=te.TYPE_UINT16,te.ELEMENTTYPE_INT32=te.TYPE_INT32,te.ELEMENTTYPE_UINT32=te.TYPE_UINT32,te.ELEMENTTYPE_FLOAT32=te.TYPE_FLOAT32,Object.defineProperty(te.shaderChunks,"transformSkinnedVS",{get:function(){return"#define SKIN\n"+te.shaderChunks.transformVS}}),Object.defineProperty(te.Vec2.prototype,"data",{get:function(){return this._data||(this._data=new Float32Array(2)),this._data[0]=this.x,this._data[1]=this.y,this._data}}),Object.defineProperty(te.Vec3.prototype,"data",{get:function(){return this._data||(this._data=new Float32Array(3)),this._data[0]=this.x,this._data[1]=this.y,this._data[2]=this.z,this._data}}),Object.defineProperty(te.Vec4.prototype,"data",{get:function(){return this._data||(this._data=new Float32Array(4)),this._data[0]=this.x,this._data[1]=this.y,this._data[2]=this.z,this._data[3]=this.w,this._data}}),Object.defineProperty(te.Color.prototype,"data",{get:function(){return this._data||(this._data=new Float32Array(4)),this._data[0]=this.r,this._data[1]=this.g,this._data[2]=this.b,this._data[3]=this.a,this._data}}),Object.defineProperty(te.Color.prototype,"data3",{get:function(){return this._data3||(this._data3=new Float32Array(3)),this._data3[0]=this.r,this._data3[1]=this.g,this._data3[2]=this.b,this._data3}}),te.Material.prototype.getName=function(){return this.name},te.Material.prototype.setName=function(e){this.name=e},te.Material.prototype.getShader=function(){return this.shader},te.Material.prototype.setShader=function(e){this.shader=e},te.GraphNode.prototype._dirtify=function(e){e?this._dirtifyLocal():this._dirtifyWorld()},te.GraphNode.prototype.addLabel=function(e){this._labels[e]=!0},te.GraphNode.prototype.getLabels=function(){return Object.keys(this._labels)},te.GraphNode.prototype.hasLabel=function(e){return!!this._labels[e]},te.GraphNode.prototype.removeLabel=function(e){delete this._labels[e]},te.GraphNode.prototype.findByLabel=function(e,t){var i,s=this._children.length;for(t=t||[],this.hasLabel(e)&&t.push(this),i=0;i<s;++i)t=this._children[i].findByLabel(e,t);return t},te.GraphNode.prototype.getChildren=function(){return this.children},te.GraphNode.prototype.getName=function(){return this.name},te.GraphNode.prototype.getPath=function(){return this.path},te.GraphNode.prototype.getRoot=function(){return this.root},te.GraphNode.prototype.getParent=function(){return this.parent},te.GraphNode.prototype.setName=function(e){this.name=e},te.Application.prototype.isFullscreen=function(){return!!document.fullscreenElement},te.Application.prototype.enableFullscreen=function(e,t,i){e=e||this.graphicsDevice.canvas;var s=function(){t(),document.removeEventListener("fullscreenchange",s)},n=function(){i(),document.removeEventListener("fullscreenerror",n)};t&&document.addEventListener("fullscreenchange",s,!1),i&&document.addEventListener("fullscreenerror",n,!1),e.requestFullscreen?e.requestFullscreen(Element.ALLOW_KEYBOARD_INPUT):i()},te.Application.prototype.disableFullscreen=function(e){var t=function(){e(),document.removeEventListener("fullscreenchange",t)};e&&document.addEventListener("fullscreenchange",t,!1),document.exitFullscreen()},te.RigidBodyComponentSystem.prototype.setGravity=function(){1===arguments.length?this.gravity.copy(arguments[0]):this.gravity.set(arguments[0],arguments[1],arguments[2])},Object.assign(te.Application.prototype,function(){var a=new te.GraphNode,n=new te.GraphNode,r=[],o=!1,e=function(e){this.lineVertexFormat=new te.VertexFormat(e,[{semantic:te.SEMANTIC_POSITION,components:3,type:te.TYPE_FLOAT32},{semantic:te.SEMANTIC_COLOR,components:4,type:te.TYPE_UINT8,normalize:!0}]),this.lineBatches=[],this.layers=[],this.layerToBatch={},this.cubeWorldPos=this.cubeLocalPos=this.quadMesh=null,this.identityGraphNode=new te.GraphNode};e.prototype.addLayer=function(e){this.layers.indexOf(e)<0&&this.layers.push(e)},e.prototype.getLayerIdx=function(e){return this.layerToBatch[e.id]},e.prototype.addLayerIdx=function(e,t){this.layerToBatch[t.id]=e};var h=function(){this.numLinesAllocated=128,this.mesh=this.vbRam=this.vb=null,this.linesUsed=0,this.layer=this.meshInstance=this.material=null};return Object.assign(h.prototype,{init:function(e,t,i,s){for(this.mesh||(this.mesh=new te.Mesh,this.mesh.primitive[0].type=te.PRIMITIVE_LINES,this.mesh.primitive[0].base=0,this.mesh.primitive[0].indexed=!1,this.material=new te.BasicMaterial,this.material.vertexColors=!0,this.material.blend=!0,this.material.blendType=te.BLEND_NORMAL,this.material.update()),this.layer=i;this.linesUsed+s>this.numLinesAllocated;)this.vb&&(this.vb.destroy(),this.vb=null),this.numLinesAllocated*=2;this.vertexFormat=t,this.vb||(this.vb=new te.VertexBuffer(e,t,2*this.numLinesAllocated,te.BUFFER_DYNAMIC),this.mesh.vertexBuffer=this.vb,this.vbRam=new DataView(this.vb.lock()),this.meshInstance||(n.worldTransform=te.Mat4.IDENTITY,n._dirtyWorld=n._dirtyNormal=!1,this.meshInstance=new te.MeshInstance(n,this.mesh,this.material),this.meshInstance.cull=!1))},addLines:function(e,t){for(var i,s=!!t.length,n=2*this.linesUsed*this.vertexFormat.size,a=0;a<e.length;a++)this.vbRam.setFloat32(n,e[a].x,!0),n+=4,this.vbRam.setFloat32(n,e[a].y,!0),n+=4,this.vbRam.setFloat32(n,e[a].z,!0),n+=4,i=s?t[a]:t,this.vbRam.setUint8(n,255*i.r),n+=1,this.vbRam.setUint8(n,255*i.g),n+=1,this.vbRam.setUint8(n,255*i.b),n+=1,this.vbRam.setUint8(n,255*i.a),n+=1;this.linesUsed+=e.length/2},finalize:function(){0<this.linesUsed&&(this.vb.setData(this.vbRam.buffer),this.mesh.primitive[0].count=2*this.linesUsed,r[0]=this.meshInstance,this.layer.addMeshInstances(r,!0),this.linesUsed=0)}}),{renderMeshInstance:function(e,t){t||(t={layer:this.scene.layers.getLayerById(te.LAYERID_IMMEDIATE)}),this._initImmediate(),this._immediateData.addLayer(t.layer),r[0]=e,t.layer.addMeshInstances(r,!0)},renderMesh:function(e,t,i,s){s||(s={layer:this.scene.layers.getLayerById(te.LAYERID_IMMEDIATE)}),this._initImmediate(),a.worldTransform=i,a._dirtyWorld=a._dirtyNormal=!1,(e=new te.MeshInstance(a,e,t)).cull=!1,s.mask&&(e.mask=s.mask),this._immediateData.addLayer(s.layer),r[0]=e,s.layer.addMeshInstances(r,!0)},renderLine:function(e,t,i,s,n){var a=i;s=s instanceof te.Color?(a=s,"number"==typeof n?(o||(o=!0),n===te.LINEBATCH_OVERLAY?{layer:this.scene.layers.getLayerById(te.LAYERID_IMMEDIATE),depthTest:!1}:{layer:this.scene.layers.getLayerById(te.LAYERID_IMMEDIATE),depthTest:!0}):n):"number"==typeof s?(o||(o=!0),a=i,s===te.LINEBATCH_OVERLAY?{layer:this.scene.layers.getLayerById(te.LAYERID_IMMEDIATE),depthTest:!1}:{layer:this.scene.layers.getLayerById(te.LAYERID_IMMEDIATE),depthTest:!0}):s||{layer:this.scene.layers.getLayerById(te.LAYERID_IMMEDIATE),depthTest:!0},this._addLines([e,t],[i,a],s)},renderLines:function(e,t,i){i?"number"==typeof i&&(o||(o=!0),i=i===te.LINEBATCH_OVERLAY?{layer:this.scene.layers.getLayerById(te.LAYERID_IMMEDIATE),depthTest:!1}:{layer:this.scene.layers.getLayerById(te.LAYERID_IMMEDIATE),depthTest:!0}):i={layer:this.scene.layers.getLayerById(te.LAYERID_IMMEDIATE),depthTest:!0},t.length&&e.length!==t.length?te.log.error("renderLines: position/color arrays have different lengths"):0!=e.length%2?te.log.error("renderLines: array length is not divisible by 2"):this._addLines(e,t,i)},renderQuad:function(e,t,i){if(i||(i={layer:this.scene.layers.getLayerById(te.LAYERID_IMMEDIATE)}),this._initImmediate(),!this._immediateData.quadMesh){var s=new te.VertexFormat(this.graphicsDevice,[{semantic:te.SEMANTIC_POSITION,components:3,type:te.TYPE_FLOAT32}]),n=(s=new te.VertexBuffer(this.graphicsDevice,s,4),new te.VertexIterator(s));n.element[te.SEMANTIC_POSITION].set(-.5,-.5,0),n.next(),n.element[te.SEMANTIC_POSITION].set(.5,-.5,0),n.next(),n.element[te.SEMANTIC_POSITION].set(-.5,.5,0),n.next(),n.element[te.SEMANTIC_POSITION].set(.5,.5,0),n.end(),this._immediateData.quadMesh=new te.Mesh,this._immediateData.quadMesh.vertexBuffer=s,this._immediateData.quadMesh.primitive[0].type=te.PRIMITIVE_TRISTRIP,this._immediateData.quadMesh.primitive[0].base=0,this._immediateData.quadMesh.primitive[0].count=4,this._immediateData.quadMesh.primitive[0].indexed=!1}a.worldTransform=e,a._dirtyWorld=a._dirtyNormal=!1,(e=new te.MeshInstance(a,this._immediateData.quadMesh,t)).cull=!1,r[0]=e,this._immediateData.addLayer(i.layer),i.layer.addMeshInstances(r,!0)},renderWireCube:function(e,t,i){var s;this._initImmediate(),this._immediateData.cubeLocalPos||(this._immediateData.cubeLocalPos=[new te.Vec3(-.5,-.5,-.5),new te.Vec3(-.5,.5,-.5),new te.Vec3(.5,.5,-.5),new te.Vec3(.5,-.5,-.5),new te.Vec3(-.5,-.5,.5),new te.Vec3(-.5,.5,.5),new te.Vec3(.5,.5,.5),new te.Vec3(.5,-.5,.5)],this._immediateData.cubeWorldPos=[new te.Vec3,new te.Vec3,new te.Vec3,new te.Vec3,new te.Vec3,new te.Vec3,new te.Vec3,new te.Vec3]);var n=this._immediateData.cubeLocalPos,a=this._immediateData.cubeWorldPos;for(s=0;s<8;s++)e.transformPoint(n[s],a[s]);this.renderLines([a[0],a[1],a[1],a[2],a[2],a[3],a[3],a[0],a[4],a[5],a[5],a[6],a[6],a[7],a[7],a[4],a[0],a[4],a[1],a[5],a[2],a[6],a[3],a[7]],t,i)},_addLines:function(e,t,i){void 0===i.layer&&(i.layer=this.scene.layers.getLayerById(te.LAYERID_IMMEDIATE)),void 0===i.depthTest&&(i.depthTest=!0),this._initImmediate();var s=i.layer;this._immediateData.addLayer(s);var n=this._immediateData.getLayerIdx(s);void 0===n?((n=new h).init(this.graphicsDevice,this._immediateData.lineVertexFormat,s,e.length/2),n.material.depthTest=i.depthTest,i.mask&&(n.meshInstance.mask=i.mask),n=this._immediateData.lineBatches.push(n)-1,this._immediateData.addLayerIdx(n,s)):(this._immediateData.lineBatches[n].init(this.graphicsDevice,this._immediateData.lineVertexFormat,s,e.length/2),this._immediateData.lineBatches[n].material.depthTest=i.depthTest,i.mask&&(this._immediateData.lineBatches[n].meshInstance.mask=i.mask)),this._immediateData.lineBatches[n].addLines(e,t)},_initImmediate:function(){this._immediateData||(this._immediateData=new e(this.graphicsDevice),this.on("prerender",this._preRenderImmediate,this),this.on("postrender",this._postRenderImmediate,this))},_preRenderImmediate:function(){for(var e=0;e<this._immediateData.lineBatches.length;e++)this._immediateData.lineBatches[e]&&this._immediateData.lineBatches[e].finalize()},_postRenderImmediate:function(){for(var e=0;e<this._immediateData.layers.length;e++)this._immediateData.layers[e].clearMeshInstances(!0);this._immediateData.layers.length=0}}}()),Object.assign(te,function(){function W(e,t,i,s){if(e.enabled){var n;if(e.model&&e.model.model&&e.model.enabled&&(s&&s.push(e),e.model.lightmapped&&t)){var a=!0,r=e.model.model.meshInstances;for(n=0;n<r.length;n++)if(!r[n].mesh.vertexBuffer.format.hasUv1){a=!1;break}if(a){var o,h=[];for(n=0;n<r.length;n++){for(o=!1,a=0;a<r.length;a++)n!==a&&r[n].mesh===r[a].mesh&&(o=!0);o?(t.push(e),i.push([r[n]])):h.push(r[n])}0<h.length&&(t.push(e),i.push(h))}}for(n=0;n<e._children.length;n++)W(e._children[n],t,i,s)}}var Y,X=[],q=[],K=new te.Vec3,Z=new te.BoundingBox,Q=new te.BoundingBox,$={},J=["texture_lightMap","texture_dirLightMap"],ee=[],e=function(e,t,i,s,n){this.device=e,this.root=t,this.scene=i,this.renderer=s,this.assets=n};return Object.assign(e.prototype,{destroy:function(){this.assets=this.renderer=this.scene=this.root=this.device=null},calculateLightmapSize:function(e){var t,i=this.scene.lightmapSizeMultiplier||16,s=1,n=1,a=1,r=1;for(e.model.asset?(t=this.assets.get(e.model.asset).data).area&&(s=t.area.x,n=t.area.y,a=t.area.z,r=t.area.uv):e.model._area&&((t=e.model)._area&&(s=t._area.x,n=t._area.y,a=t._area.z,r=t._area.uv)),s*=t=e.model.lightmapSizeMultiplier||1,n*=t,a*=t,K.copy(e.localScale),e=e._parent;e;)K.mul(e.localScale),e=e._parent;return K.x=Math.abs(K.x),K.y=Math.abs(K.y),K.z=Math.abs(K.z),s=s*K.y*K.z+n*K.x*K.z+a*K.x*K.y,s=Math.sqrt(s/r),Math.min(te.math.nextPowerOfTwo(s*i),this.scene.lightmapMaxResolution||2048)},bake:function(e,t){var i,s,n=this.device,a=this.scene,r=1;void 0===t&&(t=te.BAKE_COLORDIR),t===te.BAKE_COLORDIR&&(r=2);var o,h=[],l=[];if(e){var c;for(i=q.length-1;0<=i;i--)for(s=0;s<e.length;s++)if(q[i]===e[s]){for(c=0;c<X[i].length;c++)X[i][c].destroy();X.splice(i,1),q.splice(i,1)}for(c=[],i=0;i<e.length;i++)W(e[i],c,l);e=c,W(this.root,null,null,h)}else{for(i=0;i<X.length;i++)for(s=0;s<X[i].length;s++)X[i][s].destroy();X=[],q=[],e=[],W(this.root,e,l,h)}if(0===e.length)n.fire("lightmapper:end",{timestamp:te.now(),target:this});else{c=!1,a._needsStaticPrepare&&(c=!(a._needsStaticPrepare=!1));var d,u,p=[],f=[[],[]],m={};for((s=new te.Texture(this.device,{width:4,height:4,format:te.PIXELFORMAT_R8_G8_B8_A8,rgbm:!0})).name="lightmap",i=0;i<e.length;i++){for(d=this.calculateLightmapSize(e[i]),p.push(d),o=0;o<r;o++)(u=new te.Texture(n,{width:d,height:d,format:te.PIXELFORMAT_R8_G8_B8_A8,mipmaps:!1,rgbm:0===o,minFilter:te.FILTER_NEAREST,magFilter:te.FILTER_NEAREST})).name="lightmap",f[o].push(u);if(!m[d])(_=new te.Texture(n,{width:d,height:d,format:te.PIXELFORMAT_R8_G8_B8_A8,mipmaps:!1,rgbm:!0,minFilter:te.FILTER_NEAREST,magFilter:te.FILTER_NEAREST})).name="lightmap",_=new te.RenderTarget(n,_,{depth:!1}),m[d]=_}(M=a.layers)._update(),p=[],d=[];var _=[],g=[],y=M._lights;for(i=0;i<y.length;i++)y[i]._enabled&&(0!=(4&(u=y[i]._mask))&&(d.push(u),_.push(y[i].shadowUpdateMode),y[i]._mask=4294967295,y[i].shadowUpdateMode=y[i]._type===te.LIGHTTYPE_DIRECTIONAL?te.SHADOWUPDATE_REALTIME:te.SHADOWUPDATE_THISFRAME,p.push(y[i]),y[i].isStatic=!1)),g.push(y[i]._enabled),y[i].enabled=!1;var v=te.shaderChunks,b="#define UV1LAYOUT\n"+v.transformVS,S=v.bakeLmEndPS;u=v.createShaderFromCode(n,v.fullscreenQuadVS,v.dilatePS,"lmDilate");var T=n.scope.resolve("source"),E=n.scope.resolve("pixelOffset"),x=n.scope.resolve("bakeDir"),A=new Float32Array(2),M=M._meshInstances;for(i=0;i<M.length;i++)M[i].node&&M[i].node.getWorldTransform();M=a.fog;var C=a.ambientLight.r,P=a.ambientLight.g,I=a.ambientLight.b;a.fog=te.FOG_NONE,a.ambientLight.set(0,0,0),Y||((Y=new te.Camera)._node=new te.GraphNode,Y.clearColor[0]=0,Y.clearColor[1]=0,Y.clearColor[2]=0,Y.clearColor[3]=0,Y.clearDepth=1,Y.clearFlags=te.CLEARFLAG_COLOR,Y.clearStencil=null,Y.frustumCulling=!1);var w,O,R,L,D,N=[];for(N.length=q.length,w=0;w<h.length;w++){for(R=h[w].model.model.meshInstances,D=[],i=0;i<R.length;i++)D.push(R[i]._shaderDefs),R[i]._shaderDefs&=~(te.SHADERDEF_LM|te.SHADERDEF_DIRLM);for(i=0;i<q.length;i++)if(q[i]===h[w]){N[i]=D;break}}D=[];var F,B=[];for(w=0;w<h.length;w++)if(D[w]=h[w].model.castShadows,h[w].model.castShadows=h[w].model.castShadowsLightmap,h[w].model.castShadowsLightmap)for(F=h[w].model.meshInstances,i=0;i<F.length;i++)F[i].visibleThisFrame=!0,B.push(F[i]);this.renderer.updateCpuSkinMatrices(B),this.renderer.gpuUpdate(B);var k=[],V=[];F=[[],[]];var U,z,H,j=[];for(j.length=e.length,o=0;o<r;o++)ee[o]||((i=new te.StandardMaterial).chunks.transformVS=b,0===o?(i.chunks.endPS=S,i.ambient=new te.Color(0,0,0),i.ambientTint=!0,i.lightMap=s):(i.chunks.basePS=v.basePS+"\nuniform sampler2D texture_dirLightMap;\nuniform float bakeDir;\n",i.chunks.endPS=v.bakeDirLmEndPS),i.chunks.outputAlphaPS="\n",i.chunks.outputAlphaOpaquePS="\n",i.chunks.outputAlphaPremulPS="\n",i.cull=te.CULLFACE_NONE,i.forceUv1=!0,i.update(),i.updateShader(n,a),i.name="lmMaterial"+o,ee[o]=i);for(w=0;w<e.length;w++){if(R=l[w],(j[w]=0)<R.length)for(Z.copy(R[0].aabb),i=0;i<R.length;i++)R[i].node.getWorldTransform(),Z.add(R[i].aabb);for((i=new te.BoundingBox).copy(Z),V.push(i),i=0;i<R.length;i++)(L=R[i])._shaderDefs&=~(te.SHADERDEF_LM|te.SHADERDEF_DIRLM),L.mask=4,L.deleteParameter("texture_lightMap"),L.deleteParameter("texture_dirLightMap"),L.setParameter("texture_lightMap",L.material.lightMap?L.material.lightMap:s),L.setParameter("texture_dirLightMap",s);for(o=0;o<r;o++)O=f[o][w],U=new te.RenderTarget(n,O,{depth:!1}),F[o].push(U)}for(s=0;s<p.length;s++)p[s].enabled=!1;for(b=!(v=[[],[],[]]),i=0;i<p.length;i++){for(S=!(p[i].enabled=!0),p[i]._cacheShadowMap=!0,p[i]._type!==te.LIGHTTYPE_DIRECTIONAL&&(p[i]._node.getWorldTransform(),p[i].getBoundingSphere($),Q.center=$.center,Q.halfExtents.x=$.radius,Q.halfExtents.y=$.radius,Q.halfExtents.z=$.radius),p[i]._type===te.LIGHTTYPE_SPOT&&(s=p[i],(H=this.renderer.getShadowCamera(n,s))._node.setPosition(s._node.getPosition()),H._node.setRotation(s._node.getRotation()),H._node.rotateLocal(-90,0,0),H.projection=te.PROJECTION_PERSPECTIVE,H.nearClip=s.attenuationEnd/1e3,H.farClip=s.attenuationEnd,H.aspectRatio=1,H.fov=2*s._outerConeAngle,this.renderer.updateCameraFrustum(H)),0<l.length&&this.renderer.updateShaders(l[0]),w=0;w<e.length;w++){if(R=l[w],Z=V[w],p[i]._type===te.LIGHTTYPE_DIRECTIONAL)K.copy(Z.center),K.y+=Z.halfExtents.y,Y._node.setPosition(K),Y._node.setEulerAngles(-90,0,0),s=Math.max(Z.halfExtents.x,Z.halfExtents.z),Y.projection=te.PROJECTION_ORTHOGRAPHIC,Y.nearClip=0,Y.farClip=2*Z.halfExtents.y,Y.aspectRatio=1,Y.orthoHeight=s;else if(!Q.intersects(Z))continue;if(p[i]._type===te.LIGHTTYPE_SPOT){for(o=!1,s=0;s<R.length;s++)if(this.renderer._isVisible(H,R[s])){o=!0;break}if(!o)continue}for(p[i]._type===te.LIGHTTYPE_DIRECTIONAL?(v[te.LIGHTTYPE_DIRECTIONAL][0]=p[i],v[te.LIGHTTYPE_POINT].length=0,v[te.LIGHTTYPE_SPOT].length=0,!S&&p[i].castShadows&&(this.renderer.cullDirectionalShadowmap(p[i],B,Y,0),this.renderer.renderShadows(v[te.LIGHTTYPE_DIRECTIONAL],0),S=!0)):(v[te.LIGHTTYPE_DIRECTIONAL].length=0,p[i]._type===te.LIGHTTYPE_POINT?(v[te.LIGHTTYPE_POINT][0]=p[i],v[te.LIGHTTYPE_SPOT].length=0,!S&&p[i].castShadows&&(this.renderer.cullLocalShadowmap(p[i],B),this.renderer.renderShadows(v[te.LIGHTTYPE_POINT]),S=!0)):(v[te.LIGHTTYPE_POINT].length=0,v[te.LIGHTTYPE_SPOT][0]=p[i],!S&&p[i].castShadows&&(this.renderer.cullLocalShadowmap(p[i],B),this.renderer.renderShadows(v[te.LIGHTTYPE_SPOT]),S=!0))),s=0;s<R.length;s++)k[s]=R[s].material;for(o=0;o<r;o++){for(O=f[o][w],U=F[o][w],z=(L=m[O.width]).colorBuffer,0===o?b=a.updateShaders:b&&(a.updateShaders=!0),s=0;s<R.length;s++)R[s].material=ee[o];for(1<r&&this.renderer.updateShaders(R),this.renderer.setCamera(Y,L,!0),1===o&&x.setValue(p[i].bakeDir?1:0),this.renderer._forwardTime=0,this.renderer._shadowMapTime=0,this.renderer.renderForward(Y,R,R.length,v,te.SHADER_FORWARDHDR),f[o][w]=z,F[o][w]=L,m[O.width]=U,s=0;s<R.length;s++)(L=R[s]).setParameter(J[o],z),L._shaderDefs|=te.SHADERDEF_LM}for(j[w]++,s=0;s<R.length;s++)R[s].material=k[s]}p[i].enabled=!1,p[i]._cacheShadowMap=!1,p[i]._isCachedShadowMap&&p[i]._destroyShadowMap()}for(w=0;w<e.length;w++){for(R=l[w],H=[],o=0;o<r;o++){for(O=f[o][w],U=F[o][w],z=(L=m[O.width]).colorBuffer,A[0]=1/O.width,A[1]=1/O.height,E.setValue(A),i=0;i<4;i++)T.setValue(O),te.drawQuadWithShader(n,L,u),T.setValue(z),te.drawQuadWithShader(n,U,u);for(i=0;i<R.length;i++)(L=R[i]).mask=2,R[i].setParameter(J[o],O),1===o&&(R[i]._shaderDefs|=te.SHADERDEF_DIRLM);H[o]=O,o===r-1&&U.destroy()}X.push(H),q.push(e[w])}for(var G in m)m.hasOwnProperty(G)&&(m[G].colorBuffer.destroy(),m[G].destroy());for(i=0;i<X.length;i++)for(s=0;s<X[i].length;s++)(u=X[i][s]).minFilter=te.FILTER_LINEAR,u.magFilter=te.FILTER_LINEAR;for(w=0;w<h.length;w++)h[w].model.castShadows=D[w];for(i=0;i<N.length;i++)if(N[i])for(R=q[i].model.model.meshInstances,s=0;s<R.length;s++)R[s]._shaderDefs|=N[i][s]&(te.SHADERDEF_LM|te.SHADERDEF_DIRLM);for(i=0;i<p.length;i++)p[i]._mask=d[i],p[i].shadowUpdateMode=_[i];for(i=0;i<y.length;i++)y[i].enabled=g[i];a.fog=M,a.ambientLight.set(C,P,I),c&&(a._needsStaticPrepare=!0)}}}),{Lightmapper:e}}()),Object.assign(te,function(){function s(e,t){if(e&&!t||!e&&t)return!1;if((e=e.data)===(t=t.data))return!0;if(e instanceof Float32Array&&t instanceof Float32Array){if(e.length!==t.length)return!1;for(var i=0;i<e.length;i++)if(e[i]!==t[i])return!1;return!0}return!1}function A(e,t){for(var i in e)if(e.hasOwnProperty(i)&&!s(e[i],t[i]))return!1;for(i in t)if(t.hasOwnProperty(i)&&!s(t[i],e[i]))return!1;return!0}function M(e,t){var i;for(i=0;i<e.length;i++)if(t.indexOf(e[i])<0)return!1;for(i=0;i<t.length;i++)if(e.indexOf(t[i])<0)return!1;return!0}function V(e){return(e=e.node.worldTransform).getX(i),e.getY(n),e.getZ(a),i.cross(i,n),0<=i.dot(a)?1:-1}var e=function(e,t,i,s,n){this.dynamic=i,this.maxAabbSize=s,this.id=e,this.name=t,this.layers=void 0===n?[te.LAYERID_WORLD]:n,this._sprite=this._ui=!1,this._obj={model:[],element:[],sprite:[]}};e.MODEL="model",e.ELEMENT="element",e.SPRITE="sprite";var U=function(e,t,i){this.device=e,this.rootNode=i,this._dirty=!0,t=(this.bones=t).length,e.supportsBoneTextures?(t=256<t?64:64<t?32:16<t?16:8,this.boneTexture=new te.Texture(e,{width:t,height:t,format:te.PIXELFORMAT_RGBA32F,mipmaps:!1,minFilter:te.FILTER_NEAREST,magFilter:te.FILTER_NEAREST}),this.boneTexture.name="batching",this.matrixPalette=this.boneTexture.lock()):this.matrixPalette=new Float32Array(16*t)};Object.assign(U.prototype,{updateMatrices:function(e){},updateMatrixPalette:function(){for(var e,t,i=this.matrixPalette,s=this.bones.length-1;0<=s;s--)e=this.bones[s].getWorldTransform().data,i[t=16*s]=e[0],i[1+t]=e[1],i[2+t]=e[2],i[3+t]=e[3],i[4+t]=e[4],i[5+t]=e[5],i[6+t]=e[6],i[7+t]=e[7],i[8+t]=e[8],i[9+t]=e[9],i[10+t]=e[10],i[11+t]=e[11],i[12+t]=e[12],i[13+t]=e[13],i[14+t]=e[14],i[15+t]=e[15];this.device.supportsBoneTextures&&(this.boneTexture.lock(),this.boneTexture.unlock())}});var t=function(e,t,i){this.device=e,this.rootNode=t,this.scene=i,this._init=!1,this._batchGroups={},this._batchGroupCounter=0,this._batchList=[],this._dirtyGroups=[]};t.prototype.destroyManager=function(){this.scene=this.rootNode=this.device=null,this._batchGroups={},this._batchList=[],this._dirtyGroups=[]},t.prototype.addGroup=function(e,t,i,s,n){if(void 0===s&&(s=this._batchGroupCounter,this._batchGroupCounter++),!this._batchGroups[s])return this._batchGroups[s]=new te.BatchGroup(s,e,t,i,n)},t.prototype.removeGroup=function(e){if(this._batchGroups[e]){for(var t=[],i=0;i<this._batchList.length;i++)this._batchList[i].batchGroupId!==e?t.push(this._batchList[i]):this.destroy(this._batchList[i]);this._batchList=t,this._removeModelsFromBatchGroup(this.rootNode,e),delete this._batchGroups[e]}},t.prototype.markGroupDirty=function(e){this._dirtyGroups.indexOf(e)<0&&this._dirtyGroups.push(e)},t.prototype.getGroupByName=function(e){var t,i=this._batchGroups;for(t in i)if(i.hasOwnProperty(t)&&i[t].name===e)return i[t];return null},t.prototype.getBatches=function(e){for(var t=[],i=this._batchList.length,s=0;s<i;s++){var n=this._batchList[s];n.batchGroupId===e&&t.push(n)}return t},t.prototype._removeModelsFromBatchGroup=function(e,t){if(e.enabled){e.model&&e.model.batchGroupId===t&&(e.model.batchGroupId=-1),e.element&&e.element.batchGroupId===t&&(e.element.batchGroupId=-1),e.sprite&&e.sprite.batchGroupId===t&&(e.sprite.batchGroupId=-1);for(var i=0;i<e._children.length;i++)this._removeModelsFromBatchGroup(e._children[i],t)}},t.prototype.insert=function(e,t,i){var s=this._batchGroups[t];s&&s._obj[e].indexOf(i)<0&&(s._obj[e].push(i),this.markGroupDirty(t))},t.prototype.remove=function(e,t,i){var s=this._batchGroups[t];s&&(0<=(i=s._obj[e].indexOf(i))&&(s._obj[e].splice(i,1),this.markGroupDirty(t)))},t.prototype._extractModel=function(e,t,i,s){if(!e.model||!e.model.model)return t;if(e.model.isStatic){s=this.scene.drawCalls;var n=e.model.meshInstances;for(i=0;i<s.length;i++)s[i]._staticSource&&(n.indexOf(s[i]._staticSource)<0||t.push(s[i]));for(i=0;i<n.length;i++)0<=s.indexOf(n[i])&&t.push(n[i])}else t=s[e.model.batchGroupId]=t.concat(e.model.meshInstances);return e.model.removeModelFromLayers(e.model.model),t},t.prototype._extractElement=function(e,t,i){if(e.element){var s=!1;e.element._text&&0<e.element._text._model.meshInstances.length?(t.push(e.element._text._model.meshInstances[0]),e.element.removeModelFromLayers(e.element._text._model),s=!0):e.element._image&&(t.push(e.element._image._renderable.meshInstance),e.element.removeModelFromLayers(e.element._image._renderable.model),e.element._image._renderable.unmaskMeshInstance&&(t.push(e.element._image._renderable.unmaskMeshInstance),e.element._image._renderable.unmaskMeshInstance.stencilFront&&e.element._image._renderable.unmaskMeshInstance.stencilBack||(e.element._dirtifyMask(),e.element._onPrerender())),s=!0),s&&(i._ui=!0)}},t.prototype._collectAndRemoveModels=function(e,t){for(var i,s,n,a=0;a<t.length;a++)if(i=t[a],s=this._batchGroups[i]){for((n=e[i])||(n=e[i]=[]),i=0;i<s._obj.model.length;i++)n=this._extractModel(s._obj.model[i],n,s,e);for(i=0;i<s._obj.element.length;i++)this._extractElement(s._obj.element[i],n,s);for(var r=0;r<s._obj.sprite.length;r++)(i=s._obj.sprite[r]).sprite&&i.sprite._meshInstance&&(s.dynamic||i.sprite.sprite._renderMode===te.SPRITE_RENDERMODE_SIMPLE)&&(n.push(i.sprite._meshInstance),i.sprite.removeModelFromLayers(),s._sprite=!0,i.sprite._batchGroup=s)}},t.prototype.generate=function(e){var t,i,s,n,a,r={};for(e||(e=Object.keys(this._batchGroups)),i=[],t=0;t<this._batchList.length;t++)e.indexOf(this._batchList[t].batchGroupId)<0?i.push(this._batchList[t]):this.destroy(this._batchList[t]);if(this._batchList=i,this._collectAndRemoveModels(r,e),e===this._dirtyGroups)this._dirtyGroups.length=0;else{for(i=[],t=0;t<this._dirtyGroups.length;t++)e.indexOf(this._dirtyGroups[t])<0&&i.push(this._dirtyGroups[t]);this._dirtyGroups=i}for(a in r)if(r.hasOwnProperty(a)&&(t=r[a],e=this._batchGroups[a]))for(s=this.prepare(t,e.dynamic,e.maxAabbSize,e._ui||e._sprite),t=0;t<s.length;t++)if(n=this.create(s[t],e.dynamic,parseInt(a,10)))for(i=0;i<e.layers.length;i++){var o=this.scene.layers.getLayerById(e.layers[i]);o&&o.addMeshInstances(n.model.meshInstances)}};var i=new te.Vec3,n=new te.Vec3,a=new te.Vec3;return t.prototype.prepare=function(e,t,i,s){if(0===e.length)return[];void 0===i&&(i=Number.POSITIVE_INFINITY),i*=.5;var n,a,r,o,h,l,c,d,u,p,f=this.device.supportsBoneTextures?1024:this.device.boneLimit,m=new te.BoundingBox,_=new te.BoundingBox,g=null,y=[],v=0;s&&e.sort(function(e,t){return e.drawOrder-t.drawOrder});for(var b,S,T,E=e,x=s?function(e){g?g.add(e.aabb):g=e.aabb.clone(),b.push(e)}:function(e){b.push(e)};0<E.length;){for(y[v]=[E[0]],b=[],n=E[0].material,a=E[0].layer,l=E[0]._shaderDefs,o=E[0].parameters,c=E[0].stencilFront,h=E[0]._staticLightList,r=E[0].mesh.vertexBuffer.getNumVertices(),p=E[0].drawOrder,m.copy(E[0].aabb),u=V(E[0]),g=null,e=1;e<E.length;e++){if(S=E[e],t&&y[v].length>=f){b=b.concat(E.slice(e));break}if(n!==S.material||a!==S.layer||l!==S._shaderDefs||65535<r+S.mesh.vertexBuffer.getNumVertices())x(S);else if(_.copy(m),_.add(S.aabb),_.halfExtents.x>i||_.halfExtents.y>i||_.halfExtents.z>i)x(S);else if(!c||(T=S.stencilFront)&&c.func==T.func&&c.zpass==T.zpass)if(u!=V(S))x(S);else if(A(o,S.parameters)){if(d=S._staticLightList,h&&d){if(!M(h,d)){x(S);continue}}else if(h||d){x(S);continue}s&&g&&g.intersects(S.aabb)&&S.drawOrder!==p?x(S):(m.add(S.aabb),r+=S.mesh.vertexBuffer.getNumVertices(),y[v].push(S))}else x(S);else x(S)}v++,E=b}return y},t.prototype.create=function(e,t,i){this._init||(this.transformVS="#define BONE_LIMIT "+this.device.getBoneLimit()+"\n#define DYNAMICBATCH\n"+te.shaderChunks.transformVS,this.skinTexVS=te.shaderChunks.skinBatchTexVS,this.skinConstVS=te.shaderChunks.skinBatchConstVS,this.vertexFormats={},this._init=!0);var s,n,a,r,o,h,l,c,d,u,p,f=null,m=0,_=0,g=0;for(s=0;s<e.length;s++)if(e[s].visible){if(g++,f){if(f!==e[s].material)return}else f=e[s].material;for(r=(a=e[s].mesh).vertexBuffer.format.elements,m+=o=a.vertexBuffer.numVertices,n=0;n<r.length;n++)r[n].name===te.SEMANTIC_POSITION?h=!0:r[n].name===te.SEMANTIC_NORMAL?l=!0:r[n].name===te.SEMANTIC_TEXCOORD0?c=!0:r[n].name===te.SEMANTIC_TEXCOORD1?d=!0:r[n].name===te.SEMANTIC_TANGENT?u=!0:r[n].name===te.SEMANTIC_COLOR&&(p=!0);_+=a.primitive[0].indexed?a.primitive[0].count:4===a.primitive[0].count?6:0}if(g&&h){i=new te.Batch(e,t,i),this._batchList.push(i);var y=3+(l?3:0)+(c?2:0)+(d?2:0)+(u?4:0)+(p?1:0)+(t?1:0),v=l?6:3,b=(l?6:3)+(c?2:0),S=(l?6:3)+(c?2:0)+(d?2:0),T=(l?6:3)+(c?2:0)+(d?2:0)+(u?4:0),E=(l?6:3)+(c?2:0)+(d?2:0)+(u?4:0)+(p?1:0);s=new ArrayBuffer(m*y*4),h=new Float32Array(s);var x,A,M,C,P,I,w,O,R,L=new Uint8Array(s),D=(g=new te.IndexBuffer(this.device,te.INDEXFORMAT_UINT16,_,te.BUFFER_STATIC),new Uint16Array(g.lock())),N=0,F=0,B=0,k=new te.Vec3;for(s=0;s<e.length;s++)if(e[s].visible){for(r=(a=e[s].mesh).vertexBuffer.format.elements,o=a.vertexBuffer.numVertices,x=(n=a.vertexBuffer.format.size)/4,n=0;n<r.length;n++)r[n].name===te.SEMANTIC_POSITION?M=r[n].offset/4:r[n].name===te.SEMANTIC_NORMAL?C=r[n].offset/4:r[n].name===te.SEMANTIC_TEXCOORD0?P=r[n].offset/4:r[n].name===te.SEMANTIC_TEXCOORD1?I=r[n].offset/4:r[n].name===te.SEMANTIC_TANGENT?w=r[n].offset/4:r[n].name===te.SEMANTIC_COLOR&&(O=r[n].offset/4);for(r=new Float32Array(a.vertexBuffer.storage),A=new Uint8Array(a.vertexBuffer.storage),R=e[s].node.getWorldTransform(),n=0;n<o;n++)k.set(r[n*x+M],r[n*x+M+1],r[n*x+M+2]),t||R.transformPoint(k,k),h[n*y+B]=k.x,h[n*y+B+1]=k.y,h[n*y+B+2]=k.z,l&&(k.set(r[n*x+C],r[n*x+C+1],r[n*x+C+2]),t||R.transformVector(k,k),h[n*y+B+3]=k.x,h[n*y+B+3+1]=k.y,h[n*y+B+3+2]=k.z),c&&(h[n*y+B+v]=r[n*x+P],h[n*y+B+v+1]=r[n*x+P+1]),d&&(h[n*y+B+b]=r[n*x+I],h[n*y+B+b+1]=r[n*x+I+1]),u&&(k.set(r[n*x+w],r[n*x+w+1],r[n*x+w+2]),t||R.transformVector(k,k),h[n*y+B+S]=k.x,h[n*y+B+S+1]=k.y,h[n*y+B+S+2]=k.z,h[n*y+B+S+3]=r[n*x+w+3]),p&&(L[n*y*4+4*B+4*T]=A[n*x*4+4*O],L[n*y*4+4*B+4*T+1]=A[n*x*4+4*O+1],L[n*y*4+4*B+4*T+2]=A[n*x*4+4*O+2],L[n*y*4+4*B+4*T+3]=A[n*x*4+4*O+3]),t&&(h[n*y+E+B]=s);if(r=a.primitive[0].base,x=a.primitive[0].count,a.primitive[0].indexed)a=new Uint16Array(a.indexBuffer[0].storage);else{if(4!==x)continue;x=6,a=[r=0,1,3,2,3,1]}for(n=0;n<x;n++)D[n+F]=a[r+n]+N;F+=x,B=(N+=o)*y}if(s=0,l&&(s|=2),c&&(s|=4),d&&(s|=8),u&&(s|=16),p&&(s|=32),t&&(s|=64),(e=this.vertexFormats[s])||((e=[]).push({semantic:te.SEMANTIC_POSITION,components:3,type:te.ELEMENTTYPE_FLOAT32,normalize:!1}),l&&e.push({semantic:te.SEMANTIC_NORMAL,components:3,type:te.ELEMENTTYPE_FLOAT32,normalize:!1}),c&&e.push({semantic:te.SEMANTIC_TEXCOORD0,components:2,type:te.ELEMENTTYPE_FLOAT32,normalize:!1}),d&&e.push({semantic:te.SEMANTIC_TEXCOORD1,components:2,type:te.ELEMENTTYPE_FLOAT32,normalize:!1}),u&&e.push({semantic:te.SEMANTIC_TANGENT,components:4,type:te.ELEMENTTYPE_FLOAT32,normalize:!1}),p&&e.push({semantic:te.SEMANTIC_COLOR,components:4,type:te.ELEMENTTYPE_UINT8,normalize:!0}),t&&e.push({semantic:te.SEMANTIC_BLENDINDICES,components:1,type:te.ELEMENTTYPE_FLOAT32,normalize:!1}),e=this.vertexFormats[s]=new te.VertexFormat(this.device,e)),l=new te.VertexBuffer(this.device,e,m,te.BUFFER_STATIC,h.buffer),g.unlock(),(a=new te.Mesh).vertexBuffer=l,a.indexBuffer[0]=g,a.primitive[0].type=te.PRIMITIVE_TRIANGLES,a.primitive[0].base=0,a.primitive[0].count=_,a.primitive[0].indexed=!0,a.cull=!1,t&&((f=f.clone()).chunks.transformVS=this.transformVS,f.chunks.skinTexVS=this.skinTexVS,f.chunks.skinConstVS=this.skinConstVS,f.update()),(f=new te.MeshInstance(this.rootNode,a,f)).castShadow=i.origMeshInstances[0].castShadow,f.parameters=i.origMeshInstances[0].parameters,f.isStatic=i.origMeshInstances[0].isStatic,f.cull=i.origMeshInstances[0].cull,f.layer=i.origMeshInstances[0].layer,f._staticLightList=i.origMeshInstances[0]._staticLightList,f._shaderDefs=i.origMeshInstances[0]._shaderDefs,t){for(t=[],s=0;s<i.origMeshInstances.length;s++)t.push(i.origMeshInstances[s].node);f.skinInstance=new U(this.device,t,this.rootNode)}return f._updateAabb=!1,f.drawOrder=i.origMeshInstances[0].drawOrder,f.stencilFront=i.origMeshInstances[0].stencilFront,f.stencilBack=i.origMeshInstances[0].stencilBack,f.flipFaces=V(i.origMeshInstances[0])<0,i.meshInstance=f,this.update(i),(t=new te.Model).meshInstances=[i.meshInstance],t.castShadows=i.origMeshInstances[0].castShadows,i.model=t,i}},t.prototype.update=function(e){e._aabb.copy(e.origMeshInstances[0].aabb);for(var t=1;t<e.origMeshInstances.length;t++)e._aabb.add(e.origMeshInstances[t].aabb);e.meshInstance.aabb=e._aabb,e._aabb._radiusVer=-1,e.meshInstance._aabbVer=0},t.prototype.updateAll=function(){0<this._dirtyGroups.length&&this.generate(this._dirtyGroups);for(var e=0;e<this._batchList.length;e++)this._batchList[e].dynamic&&this.update(this._batchList[e])},t.prototype.clone=function(e,t){var i=new te.Batch(t,e.dynamic,e.batchGroupId);this._batchList.push(i);for(var s=[],n=0;n<t.length;n++)s.push(t[n].node);return i.meshInstance=new te.MeshInstance(e.meshInstance.node,e.meshInstance.mesh,e.meshInstance.material),i.meshInstance._updateAabb=!1,i.meshInstance.parameters=t[0].parameters,i.meshInstance.isStatic=t[0].isStatic,i.meshInstance.cull=t[0].cull,i.meshInstance.layer=t[0].layer,i.meshInstance._staticLightList=t[0]._staticLightList,e.dynamic&&(i.meshInstance.skinInstance=new U(this.device,s,this.rootNode)),i.meshInstance.castShadow=e.meshInstance.castShadow,i.meshInstance._shader=e.meshInstance._shader,(s=new te.Model).meshInstances=[i.meshInstance],s.castShadows=e.origMeshInstances[0].castShadows,i.model=s,i},t.prototype.destroy=function(e){if(e.refCounter=0,e.model){for(var t=this._batchGroups[e.batchGroupId].layers,i=0;i<t.length;i++){var s=this.scene.layers.getLayerById(t[i]);s&&s.removeMeshInstances(e.model.meshInstances)}e.model.destroy()}},t.prototype.decrement=function(e){e.refCounter--,0===e.refCounter&&this.destroy(e)},{Batch:function(e,t,i){this.origMeshInstances=e,this._aabb=new te.BoundingBox,this.model=this.meshInstance=null,this.dynamic=t,this.batchGroupId=i,this.refCounter=0},BatchGroup:e,BatchManager:t}}()),te}),Object.assign(pc,function(){var r=function(e){this._app=e,this._scripts={},this._cache={}};return r._types=[],r._push=function(e){pc.script.legacy&&0<r._types.length||r._types.push(e)},Object.assign(r.prototype,{load:function(e,n){var a=this;pc.script.app=this._app,this._loadScript(e,function(e,t,i){if(e)n(e);else if(pc.script.legacy)e=null,r._types.length&&(e=r._types.pop()),e?this._scripts[t]=e:e=null,n(null,e,i);else{e={};for(var s=0;s<r._types.length;s++)e[r._types[s].name]=r._types[s];r._types.length=0,n(null,e,i),delete a._loader._cache[t+"script"]}}.bind(this))},open:function(e,t){return t},patch:function(e,t){},_loadScript:function(e,t){document.head;t(null,e,document.createElement("script"))}}),{ScriptHandler:r}}()),ASSET_PREFIX="",SCRIPT_PREFIX="",SCENE_PATH="672806.json",CONTEXT_OPTIONS={antialias:!0,alpha:!0,preserveDrawingBuffer:!1,preferWebGl2:!0},SCRIPTS=[15989368,15989370,15989369,15989383,15989382,15989367,16011468,15989379,15989376,15989378,15989371,15989366,16065021],CONFIG_FILENAME="config.json",INPUT_SETTINGS={useKeyboard:!0,useMouse:!0,useGamepads:!1,useTouch:!0},pc.script.legacy=!1,PRELOAD_MODULES=[],function(){var n,e,i,t,s,a=function(){i.resizeCanvas(n.width,n.height);n.style.width="",n.style.height="";var e=i._fillMode;e!=pc.FILLMODE_NONE&&e!=pc.FILLMODE_KEEP_ASPECT||(e==pc.FILLMODE_NONE&&n.clientHeight<window.innerHeight||n.clientWidth/n.clientHeight>=window.innerWidth/window.innerHeight?n.style.marginTop=Math.floor((window.innerHeight-n.clientHeight)/2)+"px":n.style.marginTop="")},r=function(e){var t=document.createElement("div");t.innerHTML='<table style="background-color: #8CE; width: 100%; height: 100%;"><tr><td align="center"><div style="display: table-cell; vertical-align: middle;"><div style="">'+e+"</div></div></td></tr></table>",document.body.appendChild(t)};(n=document.createElement("canvas")).setAttribute("id","application-canvas"),n.setAttribute("tabindex",0),n.onselectstart=function(){return!1},document.body.appendChild(n),t=n=n,s={elementInput:new pc.ElementInput(t),keyboard:new pc.Keyboard(window),mouse:new pc.Mouse(t),gamepads:new pc.GamePads},"ontouchstart"in window&&(s.touch=new pc.TouchDevice(t)),e=s;try{i=new pc.Application(n,{elementInput:e.elementInput,keyboard:e.keyboard,mouse:e.mouse,gamepads:e.gamepads,touch:e.touch,graphicsDeviceOptions:window.CONTEXT_OPTIONS,assetPrefix:window.ASSET_PREFIX||"",scriptPrefix:window.SCRIPT_PREFIX||"",scriptsOrder:window.SCRIPTS||[]})}catch(e){return e instanceof pc.UnsupportedBrowserError?r("WebGL.<br/>"):e instanceof pc.ContextCreationError?r("WebGL.<br/>"):r(". Error: "+e)}i.configure(CONFIG_FILENAME,function(e){!function(e,t,i){n.classList&&n.classList.add("fill-mode-"+e);var s="@media screen and (min-aspect-ratio: "+t+"/"+i+") {";s+="    #application-canvas.fill-mode-KEEP_ASPECT {",s+="        width: auto;",s+="        height: 100%;",s+="        margin: 0 auto;",s+="    }",s+="}",document.head.querySelector&&(document.head.querySelector("style").innerHTML+=s)}(i._fillMode,i._width,i._height),a(),window.addEventListener("resize",a,!1),window.addEventListener("orientationchange",a,!1),i.preload(function(e){i.loadScene(SCENE_PATH,function(e,t){i.start()})})})}(),function(){var e=pc.Application.getApplication();e.on("start",function(){gblStat.postData("firstFrameComplete",+new Date)}),e.on("preload:end",function(){gblStat.postData("preloadEnd",+new Date)})}(),pc.script.createLoadingScreen(function(e){var t,i,c=function(e,t){return window.editor?"https://playcanvas.com/api/assets/"+e+"/file/"+t:"files/assets/"+e+"/1/"+t},d=function(){var e=document.getElementsByClassName("start-wrap")[0],t=e.offsetWidth/71.5;e.style.height=t+"px"};window.addEventListener("resize",d),t=["body {","   height: 100%;,","    width: 100%;","    overflow: hidden;","    margin: 0;","    padding: 0;","    font-size:0","}","html,body{background-color:transparent;}","#application-splash-wrapper{","\theight:100%;","\twidth:100%;","    background-size: cover;","    background-position: center;","    background-repeat: no-repeat;","    background-color: #fff;","   margin: auto;","}",".front,.back {","    background-repeat: no-repeat;","    background-size: cover;","    height: 100%;","    width: 100%;","    background-position: absolute;","    left: 0%;","    position: absolute;","}",".back {","    width: 0;","    background-position: left;","}",".front {","}",".start-wrap {","    width:34.5%;","    position: absolute;","    left: 50%;","    transform: translate(-50%,0%);","    top: 57%;","    max-width: 143px;","    max-height: 2px;","}",".title {","    width:100%;","    position: absolute;","    height: 13.75%;","    top: 22%;","    left: 50%;","    transform: translate(-50%,0%);","    background-repeat: no-repeat;","    background-size: contain;","    background-position: center;","}",".cctv {","    width:42.27%;","    position: absolute;","    height: 4.75%;","    bottom: 5%;","    left: 50%;","    transform: translate(-50%,0%);","    background-repeat: no-repeat;","    background-size: contain;","    background-position: center;","}",".pic {","    width:34.1%;","    height: 17.6%;","    position: absolute;","    left: 50%;","    transform : translate(-50%,0);","    top: 38%;","    opacity: 0;","    z-index: 2;","    background-repeat: no-repeat;","    background-size: contain;","    background-position: center;","}",".corner {","    width:34.1%;","    height: 17.6%;","    position: absolute;","    left: 50%;","    transform : translate(-50%,0);","    top: 38%;","    z-index: 2;","    background-repeat: no-repeat;","    background-size: contain;","    background-position: center;","}",".grey {","    width:34.1%;","    height: 17.6%;","    position: absolute;","    left: 50%;","    transform : translate(-50%,0);","    top: 38%;","    z-index: 1;","    background-repeat: no-repeat;","    background-size: contain;","    background-position: center;","}",".logo {","    width:27.3%;","    height: 10.1%;","    position: absolute;","    left: 50%;","    transform : translate(-50%,0);","    top: 6%;","    background-repeat: no-repeat;","    background-size: contain;","    background-position: center;","}","@media (max-height:700px) {",".title {","    height: 15.75%;","    top: 21%;","}",".pic {","    height: 21.6%;","    width: 35%;","    top: 38%;","}",".corner {","    height: 21.6%;","    width: 35%;","    top: 38%;","}",".grey {","    height: 21.6%;","    width: 35%;","    top: 38%;","}",".logo {","    height: 12%;","    width: 27.3%;","    top: 6%;","}",".cctv {","    height: 5.7%;","    bottom: 5%;","}",".start-wrap {","    top: 60.5%;","}","}"].join("\n"),(i=document.createElement("style")).type="text/css",i.styleSheet?i.styleSheet.cssText=t:i.appendChild(document.createTextNode(t)),document.head.appendChild(i),function(){var e=document.createElement("div");e.id="application-splash-wrapper",e.style.backgroundImage="url("+c(15989405,"loading-bg.jpg")+")",document.body.appendChild(e);var t=document.createElement("div");t.className="start-wrap",e.appendChild(t);var i=document.createElement("div");i.className="front",i.style.backgroundImage="url("+c(15989410,"loading-line-black.png")+")";var s=document.createElement("div");s.className="back",s.style.backgroundImage="url("+c(15989411,"loading-line-golden.png")+")";var n=document.createElement("div");n.className="title",n.style.backgroundImage="url("+c(16040697,"SJ-loading-title.png")+")";var a=document.createElement("div");a.className="pic",a.style.backgroundImage="url("+c(16040104,"icon-SK.png")+")";var r=document.createElement("div");r.className="corner",r.style.backgroundImage="url("+c(15989407,"loading-corner.png")+")";var o=document.createElement("div");o.className="grey",o.style.backgroundImage="url("+c(15989409,"loading-grey.png")+")";var h=document.createElement("div");h.className="logo",h.style.backgroundImage="url("+c(15989412,"loading-logo.png")+")";var l=document.createElement("div");l.className="cctv",l.style.backgroundImage="url("+c(16064154,"loading-cctv.png")+")",e.appendChild(n),e.appendChild(a),e.appendChild(r),e.appendChild(h),e.appendChild(o),e.appendChild(l),t.appendChild(i),t.appendChild(s),d()}(),e.on("preload:end",function(){e.off("preload:progress")}),e.on("preload:progress",function(e){document.getElementsByClassName("back")[0].style.width=100*e+"%",document.getElementsByClassName("pic")[0].style.opacity=e}),e.on("start",function(){var e=document.getElementById("application-splash-wrapper");e.parentElement.removeChild(e),window.removeEventListener("resize",d),pc.events.fire("StepChange",0)})}),function(a,n,e,d){"use strict";function o(e,t,i){return setTimeout(h(e,i),t)}function s(e,t,i){return!!Array.isArray(e)&&(r(e,i[t],i),!0)}function r(e,t,i){var s;if(e)if(e.forEach)e.forEach(t,i);else if(e.length!==d)for(s=0;s<e.length;)t.call(i,e[s],s,e),s++;else for(s in e)e.hasOwnProperty(s)&&t.call(i,e[s],s,e)}function t(s,e,t){var n="DEPRECATED METHOD: "+e+"\n"+t+" AT \n";return function(){var e=new Error("get-stack-trace"),t=e&&e.stack?e.stack.replace(/^[^\(]+?[\n$]/gm,"").replace(/^\s+at\s+/gm,"").replace(/^Object.<anonymous>\s*\(/gm,"{anonymous}()@"):"Unknown Stack Trace",i=a.console&&(a.console.warn||a.console.log);return i&&i.call(a.console,n,t),s.apply(this,arguments)}}function i(e,t,i){var s,n=t.prototype;(s=e.prototype=Object.create(n)).constructor=e,s._super=n,i&&Q(s,i)}function h(e,t){return function(){return e.apply(t,arguments)}}function l(e,t){return typeof e==ee?e.apply(t&&t[0]||d,t):e}function c(e,t){return e===d?t:e}function u(t,e,i){r(_(e),function(e){t.addEventListener(e,i,!1)})}function p(t,e,i){r(_(e),function(e){t.removeEventListener(e,i,!1)})}function f(e,t){for(;e;){if(e==t)return!0;e=e.parentNode}return!1}function m(e,t){return-1<e.indexOf(t)}function _(e){return e.trim().split(/\s+/g)}function g(e,t,i){if(e.indexOf&&!i)return e.indexOf(t);for(var s=0;s<e.length;){if(i&&e[s][i]==t||!i&&e[s]===t)return s;s++}return-1}function y(e){return Array.prototype.slice.call(e,0)}function v(e,i,t){for(var s=[],n=[],a=0;a<e.length;){var r=i?e[a][i]:e[a];g(n,r)<0&&s.push(e[a]),n[a]=r,a++}return t&&(s=i?s.sort(function(e,t){return e[i]>t[i]}):s.sort()),s}function b(e,t){for(var i,s,n=t[0].toUpperCase()+t.slice(1),a=0;a<$.length;){if((s=(i=$[a])?i+n:t)in e)return s;a++}return d}function S(e){var t=e.ownerDocument||e;return t.defaultView||t.parentWindow||a}function T(t,e){var i=this;this.manager=t,this.callback=e,this.element=t.element,this.target=t.options.inputTarget,this.domHandler=function(e){l(t.options.enable,[t])&&i.handler(e)},this.init()}function E(e,t,i){var s=i.pointers.length,n=i.changedPointers.length,a=t&ue&&s-n==0,r=t&(pe|fe)&&s-n==0;i.isFirst=!!a,i.isFinal=!!r,a&&(e.session={}),i.eventType=t,function(e,t){var i=e.session,s=t.pointers,n=s.length;i.firstInput||(i.firstInput=x(t)),1<n&&!i.firstMultiple?i.firstMultiple=x(t):1===n&&(i.firstMultiple=!1);var a=i.firstInput,r=i.firstMultiple,o=r?r.center:a.center,h=t.center=A(s);t.timeStamp=se(),t.deltaTime=t.timeStamp-a.timeStamp,t.angle=I(o,h),t.distance=P(o,h),function(e,t){var i=t.center,s=e.offsetDelta||{},n=e.prevDelta||{},a=e.prevInput||{};t.eventType!==ue&&a.eventType!==pe||(n=e.prevDelta={x:a.deltaX||0,y:a.deltaY||0},s=e.offsetDelta={x:i.x,y:i.y}),t.deltaX=n.x+(i.x-s.x),t.deltaY=n.y+(i.y-s.y)}(i,t),t.offsetDirection=C(t.deltaX,t.deltaY);var l=M(t.deltaTime,t.deltaX,t.deltaY);t.overallVelocityX=l.x,t.overallVelocityY=l.y,t.overallVelocity=ie(l.x)>ie(l.y)?l.x:l.y,t.scale=r?function(e,t){return P(t[0],t[1],xe)/P(e[0],e[1],xe)}(r.pointers,s):1,t.rotation=r?function(e,t){return I(t[1],t[0],xe)+I(e[1],e[0],xe)}(r.pointers,s):0,t.maxPointers=i.prevInput?t.pointers.length>i.prevInput.maxPointers?t.pointers.length:i.prevInput.maxPointers:t.pointers.length,function(e,t){var i,s,n,a,r=e.lastInterval||t,o=t.timeStamp-r.timeStamp;if(t.eventType!=fe&&(de<o||r.velocity===d)){var h=t.deltaX-r.deltaX,l=t.deltaY-r.deltaY,c=M(o,h,l);s=c.x,n=c.y,i=ie(c.x)>ie(c.y)?c.x:c.y,a=C(h,l),e.lastInterval=t}else i=r.velocity,s=r.velocityX,n=r.velocityY,a=r.direction;t.velocity=i,t.velocityX=s,t.velocityY=n,t.direction=a}(i,t);var c=e.element;f(t.srcEvent.target,c)&&(c=t.srcEvent.target),t.target=c}(e,i),e.emit("hammer.input",i),e.recognize(i),e.session.prevInput=i}function x(e){for(var t=[],i=0;i<e.pointers.length;)t[i]={clientX:te(e.pointers[i].clientX),clientY:te(e.pointers[i].clientY)},i++;return{timeStamp:se(),pointers:t,center:A(t),deltaX:e.deltaX,deltaY:e.deltaY}}function A(e){var t=e.length;if(1===t)return{x:te(e[0].clientX),y:te(e[0].clientY)};for(var i=0,s=0,n=0;n<t;)i+=e[n].clientX,s+=e[n].clientY,n++;return{x:te(i/t),y:te(s/t)}}function M(e,t,i){return{x:t/e||0,y:i/e||0}}function C(e,t){return e===t?me:ie(e)>=ie(t)?e<0?_e:ge:t<0?ye:ve}function P(e,t,i){i||(i=Ee);var s=t[i[0]]-e[i[0]],n=t[i[1]]-e[i[1]];return Math.sqrt(s*s+n*n)}function I(e,t,i){i||(i=Ee);var s=t[i[0]]-e[i[0]],n=t[i[1]]-e[i[1]];return 180*Math.atan2(n,s)/Math.PI}function w(){this.evEl=Me,this.evWin=Ce,this.pressed=!1,T.apply(this,arguments)}function O(){this.evEl=we,this.evWin=Oe,T.apply(this,arguments),this.store=this.manager.session.pointerEvents=[]}function R(){this.evTarget="touchstart",this.evWin="touchstart touchmove touchend touchcancel",this.started=!1,T.apply(this,arguments)}function L(){this.evTarget=De,this.targetIds={},T.apply(this,arguments)}function D(){T.apply(this,arguments);var e=h(this.handler,this);this.touch=new L(this.manager,e),this.mouse=new w(this.manager,e),this.primaryTouch=null,this.lastTouches=[]}function N(e){var t=e.changedPointers[0];if(t.identifier===this.primaryTouch){var i={x:t.clientX,y:t.clientY};this.lastTouches.push(i);var s=this.lastTouches;setTimeout(function(){var e=s.indexOf(i);-1<e&&s.splice(e,1)},Ne)}}function F(e,t){this.manager=e,this.set(t)}function B(e){this.options=Q({},this.defaults,e||{}),this.id=re++,this.manager=null,this.options.enable=c(this.options.enable,!0),this.state=je,this.simultaneous={},this.requireFail=[]}function k(e){return 16&e?"cancel":8&e?"end":4&e?"move":2&e?"start":""}function V(e){return e==ve?"down":e==ye?"up":e==_e?"left":e==ge?"right":""}function U(e,t){var i=t.manager;return i?i.get(e):e}function z(){B.apply(this,arguments)}function H(){z.apply(this,arguments),this.pX=null,this.pY=null}function j(){z.apply(this,arguments)}function G(){B.apply(this,arguments),this._timer=null,this._input=null}function W(){z.apply(this,arguments)}function Y(){z.apply(this,arguments)}function X(){B.apply(this,arguments),this.pTime=!1,this.pCenter=!1,this._timer=null,this._input=null,this.count=0}function q(e,t){return(t=t||{}).recognizers=c(t.recognizers,q.defaults.preset),new K(e,t)}function K(e,t){this.options=Q({},q.defaults,t||{}),this.options.inputTarget=this.options.inputTarget||e,this.handlers={},this.session={},this.recognizers=[],this.oldCssProps={},this.element=e,this.input=function(e){var t=e.options.inputClass;return new(t||(he?O:le?L:oe?D:w))(e,E)}(this),this.touchAction=new F(this,this.options.touchAction),Z(this,!0),r(this.options.recognizers,function(e){var t=this.add(new e[0](e[1]));e[2]&&t.recognizeWith(e[2]),e[3]&&t.requireFailure(e[3])},this)}function Z(i,s){var n,a=i.element;a.style&&(r(i.options.cssProps,function(e,t){n=b(a.style,t),s?(i.oldCssProps[n]=a.style[n],a.style[n]=e):a.style[n]=i.oldCssProps[n]||""}),s||(i.oldCssProps={}))}var Q,$=["","webkit","Moz","MS","ms","o"],J=n.createElement("div"),ee="function",te=Math.round,ie=Math.abs,se=Date.now;Q="function"!=typeof Object.assign?function(e){if(e===d||null===e)throw new TypeError("Cannot convert undefined or null to object");for(var t=Object(e),i=1;i<arguments.length;i++){var s=arguments[i];if(s!==d&&null!==s)for(var n in s)s.hasOwnProperty(n)&&(t[n]=s[n])}return t}:Object.assign;var ne=t(function(e,t,i){for(var s=Object.keys(t),n=0;n<s.length;)(!i||i&&e[s[n]]===d)&&(e[s[n]]=t[s[n]]),n++;return e},"extend","Use `assign`."),ae=t(function(e,t){return ne(e,t,!0)},"merge","Use `assign`."),re=1,oe="ontouchstart"in a,he=b(a,"PointerEvent")!==d,le=oe&&/mobile|tablet|ip(ad|hone|od)|android/i.test(navigator.userAgent),ce="touch",de=25,ue=1,pe=4,fe=8,me=1,_e=2,ge=4,ye=8,ve=16,be=_e|ge,Se=ye|ve,Te=be|Se,Ee=["x","y"],xe=["clientX","clientY"];T.prototype={handler:function(){},init:function(){this.evEl&&u(this.element,this.evEl,this.domHandler),this.evTarget&&u(this.target,this.evTarget,this.domHandler),this.evWin&&u(S(this.element),this.evWin,this.domHandler)},destroy:function(){this.evEl&&p(this.element,this.evEl,this.domHandler),this.evTarget&&p(this.target,this.evTarget,this.domHandler),this.evWin&&p(S(this.element),this.evWin,this.domHandler)}};var Ae={mousedown:ue,mousemove:2,mouseup:pe},Me="mousedown",Ce="mousemove mouseup";i(w,T,{handler:function(e){var t=Ae[e.type];t&ue&&0===e.button&&(this.pressed=!0),2&t&&1!==e.which&&(t=pe),this.pressed&&(t&pe&&(this.pressed=!1),this.callback(this.manager,t,{pointers:[e],changedPointers:[e],pointerType:"mouse",srcEvent:e}))}});var Pe={pointerdown:ue,pointermove:2,pointerup:pe,pointercancel:fe,pointerout:fe},Ie={2:ce,3:"pen",4:"mouse",5:"kinect"},we="pointerdown",Oe="pointermove pointerup pointercancel";a.MSPointerEvent&&!a.PointerEvent&&(we="MSPointerDown",Oe="MSPointerMove MSPointerUp MSPointerCancel"),i(O,T,{handler:function(e){var t=this.store,i=!1,s=e.type.toLowerCase().replace("ms",""),n=Pe[s],a=Ie[e.pointerType]||e.pointerType,r=a==ce,o=g(t,e.pointerId,"pointerId");n&ue&&(0===e.button||r)?o<0&&(t.push(e),o=t.length-1):n&(pe|fe)&&(i=!0),o<0||(t[o]=e,this.callback(this.manager,n,{pointers:t,changedPointers:[e],pointerType:a,srcEvent:e}),i&&t.splice(o,1))}});var Re={touchstart:ue,touchmove:2,touchend:pe,touchcancel:fe};i(R,T,{handler:function(e){var t=Re[e.type];if(t===ue&&(this.started=!0),this.started){var i=function(e,t){var i=y(e.touches),s=y(e.changedTouches);return t&(pe|fe)&&(i=v(i.concat(s),"identifier",!0)),[i,s]}.call(this,e,t);t&(pe|fe)&&i[0].length-i[1].length==0&&(this.started=!1),this.callback(this.manager,t,{pointers:i[0],changedPointers:i[1],pointerType:ce,srcEvent:e})}}});var Le={touchstart:ue,touchmove:2,touchend:pe,touchcancel:fe},De="touchstart touchmove touchend touchcancel";i(L,T,{handler:function(e){var t=Le[e.type],i=function(e,t){var i=y(e.touches),s=this.targetIds;if(t&(2|ue)&&1===i.length)return s[i[0].identifier]=!0,[i,i];var n,a,r=y(e.changedTouches),o=[],h=this.target;if(a=i.filter(function(e){return f(e.target,h)}),t===ue)for(n=0;n<a.length;)s[a[n].identifier]=!0,n++;for(n=0;n<r.length;)s[r[n].identifier]&&o.push(r[n]),t&(pe|fe)&&delete s[r[n].identifier],n++;return o.length?[v(a.concat(o),"identifier",!0),o]:void 0}.call(this,e,t);i&&this.callback(this.manager,t,{pointers:i[0],changedPointers:i[1],pointerType:ce,srcEvent:e})}});var Ne=2500;i(D,T,{handler:function(e,t,i){var s=i.pointerType==ce,n="mouse"==i.pointerType;if(!(n&&i.sourceCapabilities&&i.sourceCapabilities.firesTouchEvents)){if(s)(function(e,t){e&ue?(this.primaryTouch=t.changedPointers[0].identifier,N.call(this,t)):e&(pe|fe)&&N.call(this,t)}).call(this,t,i);else if(n&&function(e){for(var t=e.srcEvent.clientX,i=e.srcEvent.clientY,s=0;s<this.lastTouches.length;s++){var n=this.lastTouches[s],a=Math.abs(t-n.x),r=Math.abs(i-n.y);if(a<=25&&r<=25)return!0}return!1}.call(this,i))return;this.callback(e,t,i)}},destroy:function(){this.touch.destroy(),this.mouse.destroy()}});var Fe=b(J.style,"touchAction"),Be=Fe!==d,ke="manipulation",Ve="none",Ue="pan-x",ze="pan-y",He=function(){if(!Be)return!1;var t={},i=a.CSS&&a.CSS.supports;return["auto","manipulation","pan-y","pan-x","pan-x pan-y","none"].forEach(function(e){t[e]=!i||a.CSS.supports("touch-action",e)}),t}();F.prototype={set:function(e){"compute"==e&&(e=this.compute()),Be&&this.manager.element.style&&He[e]&&(this.manager.element.style[Fe]=e),this.actions=e.toLowerCase().trim()},update:function(){this.set(this.manager.options.touchAction)},compute:function(){var t=[];return r(this.manager.recognizers,function(e){l(e.options.enable,[e])&&(t=t.concat(e.getTouchAction()))}),function(e){if(m(e,Ve))return Ve;var t=m(e,Ue),i=m(e,ze);return t&&i?Ve:t||i?t?Ue:ze:m(e,ke)?ke:"auto"}(t.join(" "))},preventDefaults:function(e){var t=e.srcEvent,i=e.offsetDirection;if(!this.manager.session.prevented){var s=this.actions,n=m(s,Ve)&&!He.none,a=m(s,ze)&&!He[ze],r=m(s,Ue)&&!He[Ue];if(n){var o=1===e.pointers.length,h=e.distance<2,l=e.deltaTime<250;if(o&&h&&l)return}return r&&a?void 0:n||a&&i&be||r&&i&Se?this.preventSrc(t):void 0}t.preventDefault()},preventSrc:function(e){this.manager.session.prevented=!0,e.preventDefault()}};var je=1;B.prototype={defaults:{},set:function(e){return Q(this.options,e),this.manager&&this.manager.touchAction.update(),this},recognizeWith:function(e){if(s(e,"recognizeWith",this))return this;var t=this.simultaneous;return t[(e=U(e,this)).id]||(t[e.id]=e).recognizeWith(this),this},dropRecognizeWith:function(e){return s(e,"dropRecognizeWith",this)||(e=U(e,this),delete this.simultaneous[e.id]),this},requireFailure:function(e){if(s(e,"requireFailure",this))return this;var t=this.requireFail;return-1===g(t,e=U(e,this))&&(t.push(e),e.requireFailure(this)),this},dropRequireFailure:function(e){if(s(e,"dropRequireFailure",this))return this;e=U(e,this);var t=g(this.requireFail,e);return-1<t&&this.requireFail.splice(t,1),this},hasRequireFailures:function(){return 0<this.requireFail.length},canRecognizeWith:function(e){return!!this.simultaneous[e.id]},emit:function(t){function e(e){i.manager.emit(e,t)}var i=this,s=this.state;s<8&&e(i.options.event+k(s)),e(i.options.event),t.additionalEvent&&e(t.additionalEvent),8<=s&&e(i.options.event+k(s))},tryEmit:function(e){return this.canEmit()?this.emit(e):void(this.state=32)},canEmit:function(){for(var e=0;e<this.requireFail.length;){if(!(this.requireFail[e].state&(32|je)))return!1;e++}return!0},recognize:function(e){var t=Q({},e);return l(this.options.enable,[this,t])?(56&this.state&&(this.state=je),this.state=this.process(t),void(30&this.state&&this.tryEmit(t))):(this.reset(),void(this.state=32))},process:function(e){},getTouchAction:function(){},reset:function(){}},i(z,B,{defaults:{pointers:1},attrTest:function(e){var t=this.options.pointers;return 0===t||e.pointers.length===t},process:function(e){var t=this.state,i=e.eventType,s=6&t,n=this.attrTest(e);return s&&(i&fe||!n)?16|t:s||n?i&pe?8|t:2&t?4|t:2:32}}),i(H,z,{defaults:{event:"pan",threshold:10,pointers:1,direction:Te},getTouchAction:function(){var e=this.options.direction,t=[];return e&be&&t.push(ze),e&Se&&t.push(Ue),t},directionTest:function(e){var t=this.options,i=!0,s=e.distance,n=e.direction,a=e.deltaX,r=e.deltaY;return n&t.direction||(s=t.direction&be?(n=0===a?me:a<0?_e:ge,i=a!=this.pX,Math.abs(e.deltaX)):(n=0===r?me:r<0?ye:ve,i=r!=this.pY,Math.abs(e.deltaY))),e.direction=n,i&&s>t.threshold&&n&t.direction},attrTest:function(e){return z.prototype.attrTest.call(this,e)&&(2&this.state||!(2&this.state)&&this.directionTest(e))},emit:function(e){this.pX=e.deltaX,this.pY=e.deltaY;var t=V(e.direction);t&&(e.additionalEvent=this.options.event+t),this._super.emit.call(this,e)}}),i(j,z,{defaults:{event:"pinch",threshold:0,pointers:2},getTouchAction:function(){return[Ve]},attrTest:function(e){return this._super.attrTest.call(this,e)&&(Math.abs(e.scale-1)>this.options.threshold||2&this.state)},emit:function(e){if(1!==e.scale){var t=e.scale<1?"in":"out";e.additionalEvent=this.options.event+t}this._super.emit.call(this,e)}}),i(G,B,{defaults:{event:"press",pointers:1,time:251,threshold:9},getTouchAction:function(){return["auto"]},process:function(e){var t=this.options,i=e.pointers.length===t.pointers,s=e.distance<t.threshold,n=e.deltaTime>t.time;if(this._input=e,!s||!i||e.eventType&(pe|fe)&&!n)this.reset();else if(e.eventType&ue)this.reset(),this._timer=o(function(){this.state=8,this.tryEmit()},t.time,this);else if(e.eventType&pe)return 8;return 32},reset:function(){clearTimeout(this._timer)},emit:function(e){8===this.state&&(e&&e.eventType&pe?this.manager.emit(this.options.event+"up",e):(this._input.timeStamp=se(),this.manager.emit(this.options.event,this._input)))}}),i(W,z,{defaults:{event:"rotate",threshold:0,pointers:2},getTouchAction:function(){return[Ve]},attrTest:function(e){return this._super.attrTest.call(this,e)&&(Math.abs(e.rotation)>this.options.threshold||2&this.state)}}),i(Y,z,{defaults:{event:"swipe",threshold:10,velocity:.3,direction:be|Se,pointers:1},getTouchAction:function(){return H.prototype.getTouchAction.call(this)},attrTest:function(e){var t,i=this.options.direction;return i&(be|Se)?t=e.overallVelocity:i&be?t=e.overallVelocityX:i&Se&&(t=e.overallVelocityY),this._super.attrTest.call(this,e)&&i&e.offsetDirection&&e.distance>this.options.threshold&&e.maxPointers==this.options.pointers&&ie(t)>this.options.velocity&&e.eventType&pe},emit:function(e){var t=V(e.offsetDirection);t&&this.manager.emit(this.options.event+t,e),this.manager.emit(this.options.event,e)}}),i(X,B,{defaults:{event:"tap",pointers:1,taps:1,interval:300,time:250,threshold:9,posThreshold:10},getTouchAction:function(){return[ke]},process:function(e){var t=this.options,i=e.pointers.length===t.pointers,s=e.distance<t.threshold,n=e.deltaTime<t.time;if(this.reset(),e.eventType&ue&&0===this.count)return this.failTimeout();if(s&&n&&i){if(e.eventType!=pe)return this.failTimeout();var a=!this.pTime||e.timeStamp-this.pTime<t.interval,r=!this.pCenter||P(this.pCenter,e.center)<t.posThreshold;if(this.pTime=e.timeStamp,this.pCenter=e.center,r&&a?this.count+=1:this.count=1,this._input=e,0==this.count%t.taps)return this.hasRequireFailures()?(this._timer=o(function(){this.state=8,this.tryEmit()},t.interval,this),2):8}return 32},failTimeout:function(){return this._timer=o(function(){this.state=32},this.options.interval,this),32},reset:function(){clearTimeout(this._timer)},emit:function(){8==this.state&&(this._input.tapCount=this.count,this.manager.emit(this.options.event,this._input))}}),q.VERSION="2.0.8",q.defaults={domEvents:!1,touchAction:"compute",enable:!0,inputTarget:null,inputClass:null,preset:[[W,{enable:!1}],[j,{enable:!1},["rotate"]],[Y,{direction:be}],[H,{direction:be},["swipe"]],[X],[X,{event:"doubletap",taps:2},["tap"]],[G]],cssProps:{userSelect:"none",touchSelect:"none",touchCallout:"none",contentZooming:"none",userDrag:"none",tapHighlightColor:"rgba(0,0,0,0)"}};K.prototype={set:function(e){return Q(this.options,e),e.touchAction&&this.touchAction.update(),e.inputTarget&&(this.input.destroy(),this.input.target=e.inputTarget,this.input.init()),this},stop:function(e){this.session.stopped=e?2:1},recognize:function(e){var t=this.session;if(!t.stopped){this.touchAction.preventDefaults(e);var i,s=this.recognizers,n=t.curRecognizer;(!n||n&&8&n.state)&&(n=t.curRecognizer=null);for(var a=0;a<s.length;)i=s[a],2===t.stopped||n&&i!=n&&!i.canRecognizeWith(n)?i.reset():i.recognize(e),!n&&14&i.state&&(n=t.curRecognizer=i),a++}},get:function(e){if(e instanceof B)return e;for(var t=this.recognizers,i=0;i<t.length;i++)if(t[i].options.event==e)return t[i];return null},add:function(e){if(s(e,"add",this))return this;var t=this.get(e.options.event);return t&&this.remove(t),this.recognizers.push(e),(e.manager=this).touchAction.update(),e},remove:function(e){if(s(e,"remove",this))return this;if(e=this.get(e)){var t=this.recognizers,i=g(t,e);-1!==i&&(t.splice(i,1),this.touchAction.update())}return this},on:function(e,t){if(e!==d&&t!==d){var i=this.handlers;return r(_(e),function(e){i[e]=i[e]||[],i[e].push(t)}),this}},off:function(e,t){if(e!==d){var i=this.handlers;return r(_(e),function(e){t?i[e]&&i[e].splice(g(i[e],t),1):delete i[e]}),this}},emit:function(e,t){this.options.domEvents&&function(e,t){var i=n.createEvent("Event");i.initEvent(e,!0,!0),(i.gesture=t).target.dispatchEvent(i)}(e,t);var i=this.handlers[e]&&this.handlers[e].slice();if(i&&i.length){t.type=e,t.preventDefault=function(){t.srcEvent.preventDefault()};for(var s=0;s<i.length;)i[s](t),s++}},destroy:function(){this.element&&Z(this,!1),this.handlers={},this.session={},this.input.destroy(),this.element=null}},Q(q,{INPUT_START:ue,INPUT_MOVE:2,INPUT_END:pe,INPUT_CANCEL:fe,STATE_POSSIBLE:je,STATE_BEGAN:2,STATE_CHANGED:4,STATE_ENDED:8,STATE_RECOGNIZED:8,STATE_CANCELLED:16,STATE_FAILED:32,DIRECTION_NONE:me,DIRECTION_LEFT:_e,DIRECTION_RIGHT:ge,DIRECTION_UP:ye,DIRECTION_DOWN:ve,DIRECTION_HORIZONTAL:be,DIRECTION_VERTICAL:Se,DIRECTION_ALL:Te,Manager:K,Input:T,TouchAction:F,TouchInput:L,MouseInput:w,PointerEventInput:O,TouchMouseInput:D,SingleTouchInput:R,Recognizer:B,AttrRecognizer:z,Tap:X,Pan:H,Swipe:Y,Pinch:j,Rotate:W,Press:G,on:u,off:p,each:r,merge:ae,extend:ne,assign:Q,inherit:i,bindFn:h,prefixed:b}),(void 0!==a?a:"undefined"!=typeof self?self:{}).Hammer=q,"function"==typeof define&&define.amd?define(function(){return q}):"undefined"!=typeof module&&module.exports?module.exports=q:a.Hammer=q}(window,document),function(e,t){"use strict";"object"==typeof module&&"object"==typeof module.exports?module.exports=e.document?t(e,!0):function(e){if(!e.document)throw new Error("jQuery requires a window with a document");return t(e)}:t(e)}("undefined"!=typeof window?window:this,function(E,e){"use strict";var t=[],x=E.document,s=Object.getPrototypeOf,o=t.slice,m=t.concat,h=t.push,n=t.indexOf,i={},a=i.toString,f=i.hasOwnProperty,r=f.toString,l=r.call(Object),_={};function g(e,t){var i=(t=t||x).createElement("script");i.text=e,t.head.appendChild(i).parentNode.removeChild(i)}var A=function(e,t){return new A.fn.init(e,t)},c=/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g,d=/^-ms-/,u=/-([a-z])/g,p=function(e,t){return t.toUpperCase()};function y(e){var t=!!e&&"length"in e&&e.length,i=A.type(e);return"function"!==i&&!A.isWindow(e)&&("array"===i||0===t||"number"==typeof t&&0<t&&t-1 in e)}A.fn=A.prototype={jquery:"3.2.1",constructor:A,length:0,toArray:function(){return o.call(this)},get:function(e){return null==e?o.call(this):e<0?this[e+this.length]:this[e]},pushStack:function(e){var t=A.merge(this.constructor(),e);return t.prevObject=this,t},each:function(e){return A.each(this,e)},map:function(i){return this.pushStack(A.map(this,function(e,t){return i.call(e,t,e)}))},slice:function(){return this.pushStack(o.apply(this,arguments))},first:function(){return this.eq(0)},last:function(){return this.eq(-1)},eq:function(e){var t=this.length,i=+e+(e<0?t:0);return this.pushStack(0<=i&&i<t?[this[i]]:[])},end:function(){return this.prevObject||this.constructor()},push:h,sort:t.sort,splice:t.splice},A.extend=A.fn.extend=function(){var e,t,i,s,n,a,r=arguments[0]||{},o=1,h=arguments.length,l=!1;for("boolean"==typeof r&&(l=r,r=arguments[o]||{},o++),"object"==typeof r||A.isFunction(r)||(r={}),o===h&&(r=this,o--);o<h;o++)if(null!=(e=arguments[o]))for(t in e)i=r[t],r!==(s=e[t])&&(l&&s&&(A.isPlainObject(s)||(n=Array.isArray(s)))?(a=n?(n=!1,i&&Array.isArray(i)?i:[]):i&&A.isPlainObject(i)?i:{},r[t]=A.extend(l,a,s)):void 0!==s&&(r[t]=s));return r},A.extend({expando:"jQuery"+("3.2.1"+Math.random()).replace(/\D/g,""),isReady:!0,error:function(e){throw new Error(e)},noop:function(){},isFunction:function(e){return"function"===A.type(e)},isWindow:function(e){return null!=e&&e===e.window},isNumeric:function(e){var t=A.type(e);return("number"===t||"string"===t)&&!isNaN(e-parseFloat(e))},isPlainObject:function(e){var t,i;return!(!e||"[object Object]"!==a.call(e)||(t=s(e))&&("function"!=typeof(i=f.call(t,"constructor")&&t.constructor)||r.call(i)!==l))},isEmptyObject:function(e){var t;for(t in e)return!1;return!0},type:function(e){return null==e?e+"":"object"==typeof e||"function"==typeof e?i[a.call(e)]||"object":typeof e},globalEval:function(e){g(e)},camelCase:function(e){return e.replace(d,"ms-").replace(u,p)},each:function(e,t){var i,s=0;if(y(e))for(i=e.length;s<i&&!1!==t.call(e[s],s,e[s]);s++);else for(s in e)if(!1===t.call(e[s],s,e[s]))break;return e},trim:function(e){return null==e?"":(e+"").replace(c,"")},makeArray:function(e,t){var i=t||[];return null!=e&&(y(Object(e))?A.merge(i,"string"==typeof e?[e]:e):h.call(i,e)),i},inArray:function(e,t,i){return null==t?-1:n.call(t,e,i)},merge:function(e,t){for(var i=+t.length,s=0,n=e.length;s<i;s++)e[n++]=t[s];return e.length=n,e},grep:function(e,t,i){for(var s=[],n=0,a=e.length,r=!i;n<a;n++)!t(e[n],n)!=r&&s.push(e[n]);return s},map:function(e,t,i){var s,n,a=0,r=[];if(y(e))for(s=e.length;a<s;a++)null!=(n=t(e[a],a,i))&&r.push(n);else for(a in e)null!=(n=t(e[a],a,i))&&r.push(n);return m.apply([],r)},guid:1,proxy:function(e,t){var i,s,n;if("string"==typeof t&&(i=e[t],t=e,e=i),A.isFunction(e))return s=o.call(arguments,2),(n=function(){return e.apply(t||this,s.concat(o.call(arguments)))}).guid=e.guid=e.guid||A.guid++,n},now:Date.now,support:_}),"function"==typeof Symbol&&(A.fn[Symbol.iterator]=t[Symbol.iterator]),A.each("Boolean Number String Function Array Date RegExp Object Error Symbol".split(" "),function(e,t){i["[object "+t+"]"]=t.toLowerCase()});var v=function(i){var e,p,b,a,n,f,d,m,S,h,l,T,E,r,x,_,o,c,g,A="sizzle"+1*new Date,y=i.document,M=0,s=0,u=re(),v=re(),C=re(),P=function(e,t){return e===t&&(l=!0),0},I={}.hasOwnProperty,t=[],w=t.pop,O=t.push,R=t.push,L=t.slice,D=function(e,t){for(var i=0,s=e.length;i<s;i++)if(e[i]===t)return i;return-1},N="checked|selected|async|autofocus|autoplay|controls|defer|disabled|hidden|ismap|loop|multiple|open|readonly|required|scoped",F="[\\x20\\t\\r\\n\\f]",B="(?:\\\\.|[\\w-]|[^\0-\\xa0])+",k="\\["+F+"*("+B+")(?:"+F+"*([*^$|!~]?=)"+F+"*(?:'((?:\\\\.|[^\\\\'])*)'|\"((?:\\\\.|[^\\\\\"])*)\"|("+B+"))|)"+F+"*\\]",V=":("+B+")(?:\\((('((?:\\\\.|[^\\\\'])*)'|\"((?:\\\\.|[^\\\\\"])*)\")|((?:\\\\.|[^\\\\()[\\]]|"+k+")*)|.*)\\)|)",U=new RegExp(F+"+","g"),z=new RegExp("^"+F+"+|((?:^|[^\\\\])(?:\\\\.)*)"+F+"+$","g"),H=new RegExp("^"+F+"*,"+F+"*"),j=new RegExp("^"+F+"*([>+~]|"+F+")"+F+"*"),G=new RegExp("="+F+"*([^\\]'\"]*?)"+F+"*\\]","g"),W=new RegExp(V),Y=new RegExp("^"+B+"$"),X={ID:new RegExp("^#("+B+")"),CLASS:new RegExp("^\\.("+B+")"),TAG:new RegExp("^("+B+"|[*])"),ATTR:new RegExp("^"+k),PSEUDO:new RegExp("^"+V),CHILD:new RegExp("^:(only|first|last|nth|nth-last)-(child|of-type)(?:\\("+F+"*(even|odd|(([+-]|)(\\d*)n|)"+F+"*(?:([+-]|)"+F+"*(\\d+)|))"+F+"*\\)|)","i"),bool:new RegExp("^(?:"+N+")$","i"),needsContext:new RegExp("^"+F+"*[>+~]|:(even|odd|eq|gt|lt|nth|first|last)(?:\\("+F+"*((?:-\\d)?\\d*)"+F+"*\\)|)(?=[^-]|$)","i")},q=/^(?:input|select|textarea|button)$/i,K=/^h\d$/i,Z=/^[^{]+\{\s*\[native \w/,Q=/^(?:#([\w-]+)|(\w+)|\.([\w-]+))$/,$=/[+~]/,J=new RegExp("\\\\([\\da-f]{1,6}"+F+"?|("+F+")|.)","ig"),ee=function(e,t,i){var s="0x"+t-65536;return s!=s||i?t:s<0?String.fromCharCode(65536+s):String.fromCharCode(s>>10|55296,1023&s|56320)},te=/([\0-\x1f\x7f]|^-?\d)|^-$|[^\0-\x1f\x7f-\uFFFF\w-]/g,ie=function(e,t){return t?"\0"===e?"":e.slice(0,-1)+"\\"+e.charCodeAt(e.length-1).toString(16)+" ":"\\"+e},se=function(){T()},ne=ye(function(e){return!0===e.disabled&&("form"in e||"label"in e)},{dir:"parentNode",next:"legend"});try{R.apply(t=L.call(y.childNodes),y.childNodes),t[y.childNodes.length].nodeType}catch(e){R={apply:t.length?function(e,t){O.apply(e,L.call(t))}:function(e,t){for(var i=e.length,s=0;e[i++]=t[s++];);e.length=i-1}}}function ae(e,t,i,s){var n,a,r,o,h,l,c,d=t&&t.ownerDocument,u=t?t.nodeType:9;if(i=i||[],"string"!=typeof e||!e||1!==u&&9!==u&&11!==u)return i;if(!s&&((t?t.ownerDocument||t:y)!==E&&T(t),t=t||E,x)){if(11!==u&&(h=Q.exec(e)))if(n=h[1]){if(9===u){if(!(r=t.getElementById(n)))return i;if(r.id===n)return i.push(r),i}else if(d&&(r=d.getElementById(n))&&g(t,r)&&r.id===n)return i.push(r),i}else{if(h[2])return R.apply(i,t.getElementsByTagName(e)),i;if((n=h[3])&&p.getElementsByClassName&&t.getElementsByClassName)return R.apply(i,t.getElementsByClassName(n)),i}if(p.qsa&&!C[e+" "]&&(!_||!_.test(e))){if(1!==u)d=t,c=e;else if("object"!==t.nodeName.toLowerCase()){for((o=t.getAttribute("id"))?o=o.replace(te,ie):t.setAttribute("id",o=A),a=(l=f(e)).length;a--;)l[a]="#"+o+" "+ge(l[a]);c=l.join(","),d=$.test(e)&&me(t.parentNode)||t}if(c)try{return R.apply(i,d.querySelectorAll(c)),i}catch(e){}finally{o===A&&t.removeAttribute("id")}}}return m(e.replace(z,"$1"),t,i,s)}function re(){var s=[];return function e(t,i){return s.push(t+" ")>b.cacheLength&&delete e[s.shift()],e[t+" "]=i}}function oe(e){return e[A]=!0,e}function he(e){var t=E.createElement("fieldset");try{return!!e(t)}catch(e){return!1}finally{t.parentNode&&t.parentNode.removeChild(t),t=null}}function le(e,t){for(var i=e.split("|"),s=i.length;s--;)b.attrHandle[i[s]]=t}function ce(e,t){var i=t&&e,s=i&&1===e.nodeType&&1===t.nodeType&&e.sourceIndex-t.sourceIndex;if(s)return s;if(i)for(;i=i.nextSibling;)if(i===t)return-1;return e?1:-1}function de(t){return function(e){return"input"===e.nodeName.toLowerCase()&&e.type===t}}function ue(i){return function(e){var t=e.nodeName.toLowerCase();return("input"===t||"button"===t)&&e.type===i}}function pe(t){return function(e){return"form"in e?e.parentNode&&!1===e.disabled?"label"in e?"label"in e.parentNode?e.parentNode.disabled===t:e.disabled===t:e.isDisabled===t||e.isDisabled!==!t&&ne(e)===t:e.disabled===t:"label"in e&&e.disabled===t}}function fe(r){return oe(function(a){return a=+a,oe(function(e,t){for(var i,s=r([],e.length,a),n=s.length;n--;)e[i=s[n]]&&(e[i]=!(t[i]=e[i]))})})}function me(e){return e&&void 0!==e.getElementsByTagName&&e}for(e in p=ae.support={},n=ae.isXML=function(e){var t=e&&(e.ownerDocument||e).documentElement;return!!t&&"HTML"!==t.nodeName},T=ae.setDocument=function(e){var t,i,s=e?e.ownerDocument||e:y;return s!==E&&9===s.nodeType&&s.documentElement&&(r=(E=s).documentElement,x=!n(E),y!==E&&(i=E.defaultView)&&i.top!==i&&(i.addEventListener?i.addEventListener("unload",se,!1):i.attachEvent&&i.attachEvent("onunload",se)),p.attributes=he(function(e){return e.className="i",!e.getAttribute("className")}),p.getElementsByTagName=he(function(e){return e.appendChild(E.createComment("")),!e.getElementsByTagName("*").length}),p.getElementsByClassName=Z.test(E.getElementsByClassName),p.getById=he(function(e){return r.appendChild(e).id=A,!E.getElementsByName||!E.getElementsByName(A).length}),p.getById?(b.filter.ID=function(e){var t=e.replace(J,ee);return function(e){return e.getAttribute("id")===t}},b.find.ID=function(e,t){if(void 0!==t.getElementById&&x){var i=t.getElementById(e);return i?[i]:[]}}):(b.filter.ID=function(e){var i=e.replace(J,ee);return function(e){var t=void 0!==e.getAttributeNode&&e.getAttributeNode("id");return t&&t.value===i}},b.find.ID=function(e,t){if(void 0!==t.getElementById&&x){var i,s,n,a=t.getElementById(e);if(a){if((i=a.getAttributeNode("id"))&&i.value===e)return[a];for(n=t.getElementsByName(e),s=0;a=n[s++];)if((i=a.getAttributeNode("id"))&&i.value===e)return[a]}return[]}}),b.find.TAG=p.getElementsByTagName?function(e,t){return void 0!==t.getElementsByTagName?t.getElementsByTagName(e):p.qsa?t.querySelectorAll(e):void 0}:function(e,t){var i,s=[],n=0,a=t.getElementsByTagName(e);if("*"!==e)return a;for(;i=a[n++];)1===i.nodeType&&s.push(i);return s},b.find.CLASS=p.getElementsByClassName&&function(e,t){if(void 0!==t.getElementsByClassName&&x)return t.getElementsByClassName(e)},o=[],_=[],(p.qsa=Z.test(E.querySelectorAll))&&(he(function(e){r.appendChild(e).innerHTML="<a id='"+A+"'></a><select id='"+A+"-\r\\' msallowcapture=''><option selected=''></option></select>",e.querySelectorAll("[msallowcapture^='']").length&&_.push("[*^$]="+F+"*(?:''|\"\")"),e.querySelectorAll("[selected]").length||_.push("\\["+F+"*(?:value|"+N+")"),e.querySelectorAll("[id~="+A+"-]").length||_.push("~="),e.querySelectorAll(":checked").length||_.push(":checked"),e.querySelectorAll("a#"+A+"+*").length||_.push(".#.+[+~]")}),he(function(e){e.innerHTML="<a href='' disabled='disabled'></a><select disabled='disabled'><option/></select>";var t=E.createElement("input");t.setAttribute("type","hidden"),e.appendChild(t).setAttribute("name","D"),e.querySelectorAll("[name=d]").length&&_.push("name"+F+"*[*^$|!~]?="),2!==e.querySelectorAll(":enabled").length&&_.push(":enabled",":disabled"),r.appendChild(e).disabled=!0,2!==e.querySelectorAll(":disabled").length&&_.push(":enabled",":disabled"),e.querySelectorAll("*,:x"),_.push(",.*:")})),(p.matchesSelector=Z.test(c=r.matches||r.webkitMatchesSelector||r.mozMatchesSelector||r.oMatchesSelector||r.msMatchesSelector))&&he(function(e){p.disconnectedMatch=c.call(e,"*"),c.call(e,"[s!='']:x"),o.push("!=",V)}),_=_.length&&new RegExp(_.join("|")),o=o.length&&new RegExp(o.join("|")),t=Z.test(r.compareDocumentPosition),g=t||Z.test(r.contains)?function(e,t){var i=9===e.nodeType?e.documentElement:e,s=t&&t.parentNode;return e===s||!(!s||1!==s.nodeType||!(i.contains?i.contains(s):e.compareDocumentPosition&&16&e.compareDocumentPosition(s)))}:function(e,t){if(t)for(;t=t.parentNode;)if(t===e)return!0;return!1},P=t?function(e,t){if(e===t)return l=!0,0;var i=!e.compareDocumentPosition-!t.compareDocumentPosition;return i||(1&(i=(e.ownerDocument||e)===(t.ownerDocument||t)?e.compareDocumentPosition(t):1)||!p.sortDetached&&t.compareDocumentPosition(e)===i?e===E||e.ownerDocument===y&&g(y,e)?-1:t===E||t.ownerDocument===y&&g(y,t)?1:h?D(h,e)-D(h,t):0:4&i?-1:1)}:function(e,t){if(e===t)return l=!0,0;var i,s=0,n=e.parentNode,a=t.parentNode,r=[e],o=[t];if(!n||!a)return e===E?-1:t===E?1:n?-1:a?1:h?D(h,e)-D(h,t):0;if(n===a)return ce(e,t);for(i=e;i=i.parentNode;)r.unshift(i);for(i=t;i=i.parentNode;)o.unshift(i);for(;r[s]===o[s];)s++;return s?ce(r[s],o[s]):r[s]===y?-1:o[s]===y?1:0}),E},ae.matches=function(e,t){return ae(e,null,null,t)},ae.matchesSelector=function(e,t){if((e.ownerDocument||e)!==E&&T(e),t=t.replace(G,"='$1']"),p.matchesSelector&&x&&!C[t+" "]&&(!o||!o.test(t))&&(!_||!_.test(t)))try{var i=c.call(e,t);if(i||p.disconnectedMatch||e.document&&11!==e.document.nodeType)return i}catch(e){}return 0<ae(t,E,null,[e]).length},ae.contains=function(e,t){return(e.ownerDocument||e)!==E&&T(e),g(e,t)},ae.attr=function(e,t){(e.ownerDocument||e)!==E&&T(e);var i=b.attrHandle[t.toLowerCase()],s=i&&I.call(b.attrHandle,t.toLowerCase())?i(e,t,!x):void 0;return void 0!==s?s:p.attributes||!x?e.getAttribute(t):(s=e.getAttributeNode(t))&&s.specified?s.value:null},ae.escape=function(e){return(e+"").replace(te,ie)},ae.error=function(e){throw new Error("Syntax error, unrecognized expression: "+e)},ae.uniqueSort=function(e){var t,i=[],s=0,n=0;if(l=!p.detectDuplicates,h=!p.sortStable&&e.slice(0),e.sort(P),l){for(;t=e[n++];)t===e[n]&&(s=i.push(n));for(;s--;)e.splice(i[s],1)}return h=null,e},a=ae.getText=function(e){var t,i="",s=0,n=e.nodeType;if(n){if(1===n||9===n||11===n){if("string"==typeof e.textContent)return e.textContent;for(e=e.firstChild;e;e=e.nextSibling)i+=a(e)}else if(3===n||4===n)return e.nodeValue}else for(;t=e[s++];)i+=a(t);return i},(b=ae.selectors={cacheLength:50,createPseudo:oe,match:X,attrHandle:{},find:{},relative:{">":{dir:"parentNode",first:!0}," ":{dir:"parentNode"},"+":{dir:"previousSibling",first:!0},"~":{dir:"previousSibling"}},preFilter:{ATTR:function(e){return e[1]=e[1].replace(J,ee),e[3]=(e[3]||e[4]||e[5]||"").replace(J,ee),"~="===e[2]&&(e[3]=" "+e[3]+" "),e.slice(0,4)},CHILD:function(e){return e[1]=e[1].toLowerCase(),"nth"===e[1].slice(0,3)?(e[3]||ae.error(e[0]),e[4]=+(e[4]?e[5]+(e[6]||1):2*("even"===e[3]||"odd"===e[3])),e[5]=+(e[7]+e[8]||"odd"===e[3])):e[3]&&ae.error(e[0]),e},PSEUDO:function(e){var t,i=!e[6]&&e[2];return X.CHILD.test(e[0])?null:(e[3]?e[2]=e[4]||e[5]||"":i&&W.test(i)&&(t=f(i,!0))&&(t=i.indexOf(")",i.length-t)-i.length)&&(e[0]=e[0].slice(0,t),e[2]=i.slice(0,t)),e.slice(0,3))}},filter:{TAG:function(e){var t=e.replace(J,ee).toLowerCase();return"*"===e?function(){return!0}:function(e){return e.nodeName&&e.nodeName.toLowerCase()===t}},CLASS:function(e){var t=u[e+" "];return t||(t=new RegExp("(^|"+F+")"+e+"("+F+"|$)"))&&u(e,function(e){return t.test("string"==typeof e.className&&e.className||void 0!==e.getAttribute&&e.getAttribute("class")||"")})},ATTR:function(i,s,n){return function(e){var t=ae.attr(e,i);return null==t?"!="===s:!s||(t+="","="===s?t===n:"!="===s?t!==n:"^="===s?n&&0===t.indexOf(n):"*="===s?n&&-1<t.indexOf(n):"$="===s?n&&t.slice(-n.length)===n:"~="===s?-1<(" "+t.replace(U," ")+" ").indexOf(n):"|="===s&&(t===n||t.slice(0,n.length+1)===n+"-"))}},CHILD:function(f,e,t,m,_){var g="nth"!==f.slice(0,3),y="last"!==f.slice(-4),v="of-type"===e;return 1===m&&0===_?function(e){return!!e.parentNode}:function(e,t,i){var s,n,a,r,o,h,l=g!=y?"nextSibling":"previousSibling",c=e.parentNode,d=v&&e.nodeName.toLowerCase(),u=!i&&!v,p=!1;if(c){if(g){for(;l;){for(r=e;r=r[l];)if(v?r.nodeName.toLowerCase()===d:1===r.nodeType)return!1;h=l="only"===f&&!h&&"nextSibling"}return!0}if(h=[y?c.firstChild:c.lastChild],y&&u){for(p=(o=(s=(n=(a=(r=c)[A]||(r[A]={}))[r.uniqueID]||(a[r.uniqueID]={}))[f]||[])[0]===M&&s[1])&&s[2],r=o&&c.childNodes[o];r=++o&&r&&r[l]||(p=o=0)||h.pop();)if(1===r.nodeType&&++p&&r===e){n[f]=[M,o,p];break}}else if(u&&(p=o=(s=(n=(a=(r=e)[A]||(r[A]={}))[r.uniqueID]||(a[r.uniqueID]={}))[f]||[])[0]===M&&s[1]),!1===p)for(;(r=++o&&r&&r[l]||(p=o=0)||h.pop())&&((v?r.nodeName.toLowerCase()!==d:1!==r.nodeType)||!++p||(u&&((n=(a=r[A]||(r[A]={}))[r.uniqueID]||(a[r.uniqueID]={}))[f]=[M,p]),r!==e)););return(p-=_)===m||p%m==0&&0<=p/m}}},PSEUDO:function(e,a){var t,r=b.pseudos[e]||b.setFilters[e.toLowerCase()]||ae.error("unsupported pseudo: "+e);return r[A]?r(a):1<r.length?(t=[e,e,"",a],b.setFilters.hasOwnProperty(e.toLowerCase())?oe(function(e,t){for(var i,s=r(e,a),n=s.length;n--;)e[i=D(e,s[n])]=!(t[i]=s[n])}):function(e){return r(e,0,t)}):r}},pseudos:{not:oe(function(e){var s=[],n=[],o=d(e.replace(z,"$1"));return o[A]?oe(function(e,t,i,s){for(var n,a=o(e,null,s,[]),r=e.length;r--;)(n=a[r])&&(e[r]=!(t[r]=n))}):function(e,t,i){return s[0]=e,o(s,null,i,n),s[0]=null,!n.pop()}}),has:oe(function(t){return function(e){return 0<ae(t,e).length}}),contains:oe(function(t){return t=t.replace(J,ee),function(e){return-1<(e.textContent||e.innerText||a(e)).indexOf(t)}}),lang:oe(function(i){return Y.test(i||"")||ae.error("unsupported lang: "+i),i=i.replace(J,ee).toLowerCase(),function(e){var t;do{if(t=x?e.lang:e.getAttribute("xml:lang")||e.getAttribute("lang"))return(t=t.toLowerCase())===i||0===t.indexOf(i+"-")}while((e=e.parentNode)&&1===e.nodeType);return!1}}),target:function(e){var t=i.location&&i.location.hash;return t&&t.slice(1)===e.id},root:function(e){return e===r},focus:function(e){return e===E.activeElement&&(!E.hasFocus||E.hasFocus())&&!!(e.type||e.href||~e.tabIndex)},enabled:pe(!1),disabled:pe(!0),checked:function(e){var t=e.nodeName.toLowerCase();return"input"===t&&!!e.checked||"option"===t&&!!e.selected},selected:function(e){return e.parentNode&&e.parentNode.selectedIndex,!0===e.selected},empty:function(e){for(e=e.firstChild;e;e=e.nextSibling)if(e.nodeType<6)return!1;return!0},parent:function(e){return!b.pseudos.empty(e)},header:function(e){return K.test(e.nodeName)},input:function(e){return q.test(e.nodeName)},button:function(e){var t=e.nodeName.toLowerCase();return"input"===t&&"button"===e.type||"button"===t},text:function(e){var t;return"input"===e.nodeName.toLowerCase()&&"text"===e.type&&(null==(t=e.getAttribute("type"))||"text"===t.toLowerCase())},first:fe(function(){return[0]}),last:fe(function(e,t){return[t-1]}),eq:fe(function(e,t,i){return[i<0?i+t:i]}),even:fe(function(e,t){for(var i=0;i<t;i+=2)e.push(i);return e}),odd:fe(function(e,t){for(var i=1;i<t;i+=2)e.push(i);return e}),lt:fe(function(e,t,i){for(var s=i<0?i+t:i;0<=--s;)e.push(s);return e}),gt:fe(function(e,t,i){for(var s=i<0?i+t:i;++s<t;)e.push(s);return e})}}).pseudos.nth=b.pseudos.eq,{radio:!0,checkbox:!0,file:!0,password:!0,image:!0})b.pseudos[e]=de(e);for(e in{submit:!0,reset:!0})b.pseudos[e]=ue(e);function _e(){}function ge(e){for(var t=0,i=e.length,s="";t<i;t++)s+=e[t].value;return s}function ye(o,e,t){var h=e.dir,l=e.next,c=l||h,d=t&&"parentNode"===c,u=s++;return e.first?function(e,t,i){for(;e=e[h];)if(1===e.nodeType||d)return o(e,t,i);return!1}:function(e,t,i){var s,n,a,r=[M,u];if(i){for(;e=e[h];)if((1===e.nodeType||d)&&o(e,t,i))return!0}else for(;e=e[h];)if(1===e.nodeType||d)if(n=(a=e[A]||(e[A]={}))[e.uniqueID]||(a[e.uniqueID]={}),l&&l===e.nodeName.toLowerCase())e=e[h]||e;else{if((s=n[c])&&s[0]===M&&s[1]===u)return r[2]=s[2];if((n[c]=r)[2]=o(e,t,i))return!0}return!1}}function ve(n){return 1<n.length?function(e,t,i){for(var s=n.length;s--;)if(!n[s](e,t,i))return!1;return!0}:n[0]}function be(e,t,i,s,n){for(var a,r=[],o=0,h=e.length,l=null!=t;o<h;o++)(a=e[o])&&(i&&!i(a,s,n)||(r.push(a),l&&t.push(o)));return r}function Se(p,f,m,_,g,e){return _&&!_[A]&&(_=Se(_)),g&&!g[A]&&(g=Se(g,e)),oe(function(e,t,i,s){var n,a,r,o=[],h=[],l=t.length,c=e||function(e,t,i){for(var s=0,n=t.length;s<n;s++)ae(e,t[s],i);return i}(f||"*",i.nodeType?[i]:i,[]),d=!p||!e&&f?c:be(c,o,p,i,s),u=m?g||(e?p:l||_)?[]:t:d;if(m&&m(d,u,i,s),_)for(n=be(u,h),_(n,[],i,s),a=n.length;a--;)(r=n[a])&&(u[h[a]]=!(d[h[a]]=r));if(e){if(g||p){if(g){for(n=[],a=u.length;a--;)(r=u[a])&&n.push(d[a]=r);g(null,u=[],n,s)}for(a=u.length;a--;)(r=u[a])&&-1<(n=g?D(e,r):o[a])&&(e[n]=!(t[n]=r))}}else u=be(u===t?u.splice(l,u.length):u),g?g(null,t,u,s):R.apply(t,u)})}function Te(e){for(var n,t,i,s=e.length,a=b.relative[e[0].type],r=a||b.relative[" "],o=a?1:0,h=ye(function(e){return e===n},r,!0),l=ye(function(e){return-1<D(n,e)},r,!0),c=[function(e,t,i){var s=!a&&(i||t!==S)||((n=t).nodeType?h(e,t,i):l(e,t,i));return n=null,s}];o<s;o++)if(t=b.relative[e[o].type])c=[ye(ve(c),t)];else{if((t=b.filter[e[o].type].apply(null,e[o].matches))[A]){for(i=++o;i<s&&!b.relative[e[i].type];i++);return Se(1<o&&ve(c),1<o&&ge(e.slice(0,o-1).concat({value:" "===e[o-2].type?"*":""})).replace(z,"$1"),t,o<i&&Te(e.slice(o,i)),i<s&&Te(e=e.slice(i)),i<s&&ge(e))}c.push(t)}return ve(c)}return _e.prototype=b.filters=b.pseudos,b.setFilters=new _e,f=ae.tokenize=function(e,t){var i,s,n,a,r,o,h,l=v[e+" "];if(l)return t?0:l.slice(0);for(r=e,o=[],h=b.preFilter;r;){for(a in i&&!(s=H.exec(r))||(s&&(r=r.slice(s[0].length)||r),o.push(n=[])),i=!1,(s=j.exec(r))&&(i=s.shift(),n.push({value:i,type:s[0].replace(z," ")}),r=r.slice(i.length)),b.filter)!(s=X[a].exec(r))||h[a]&&!(s=h[a](s))||(i=s.shift(),n.push({value:i,type:a,matches:s}),r=r.slice(i.length));if(!i)break}return t?r.length:r?ae.error(e):v(e,o).slice(0)},d=ae.compile=function(e,t){var i,s=[],n=[],a=C[e+" "];if(!a){for(t||(t=f(e)),i=t.length;i--;)(a=Te(t[i]))[A]?s.push(a):n.push(a);(a=C(e,function(_,g){var y=0<g.length,v=0<_.length,e=function(e,t,i,s,n){var a,r,o,h=0,l="0",c=e&&[],d=[],u=S,p=e||v&&b.find.TAG("*",n),f=M+=null==u?1:Math.random()||.1,m=p.length;for(n&&(S=t===E||t||n);l!==m&&null!=(a=p[l]);l++){if(v&&a){for(r=0,t||a.ownerDocument===E||(T(a),i=!x);o=_[r++];)if(o(a,t||E,i)){s.push(a);break}n&&(M=f)}y&&((a=!o&&a)&&h--,e&&c.push(a))}if(h+=l,y&&l!==h){for(r=0;o=g[r++];)o(c,d,t,i);if(e){if(0<h)for(;l--;)c[l]||d[l]||(d[l]=w.call(s));d=be(d)}R.apply(s,d),n&&!e&&0<d.length&&1<h+g.length&&ae.uniqueSort(s)}return n&&(M=f,S=u),c};return y?oe(e):e}(n,s))).selector=e}return a},m=ae.select=function(e,t,i,s){var n,a,r,o,h,l="function"==typeof e&&e,c=!s&&f(e=l.selector||e);if(i=i||[],1===c.length){if(2<(a=c[0]=c[0].slice(0)).length&&"ID"===(r=a[0]).type&&9===t.nodeType&&x&&b.relative[a[1].type]){if(!(t=(b.find.ID(r.matches[0].replace(J,ee),t)||[])[0]))return i;l&&(t=t.parentNode),e=e.slice(a.shift().value.length)}for(n=X.needsContext.test(e)?0:a.length;n--&&(r=a[n],!b.relative[o=r.type]);)if((h=b.find[o])&&(s=h(r.matches[0].replace(J,ee),$.test(a[0].type)&&me(t.parentNode)||t))){if(a.splice(n,1),!(e=s.length&&ge(a)))return R.apply(i,s),i;break}}return(l||d(e,c))(s,t,!x,i,!t||$.test(e)&&me(t.parentNode)||t),i},p.sortStable=A.split("").sort(P).join("")===A,p.detectDuplicates=!!l,T(),p.sortDetached=he(function(e){return 1&e.compareDocumentPosition(E.createElement("fieldset"))}),he(function(e){return e.innerHTML="<a href='#'></a>","#"===e.firstChild.getAttribute("href")})||le("type|href|height|width",function(e,t,i){if(!i)return e.getAttribute(t,"type"===t.toLowerCase()?1:2)}),p.attributes&&he(function(e){return e.innerHTML="<input/>",e.firstChild.setAttribute("value",""),""===e.firstChild.getAttribute("value")})||le("value",function(e,t,i){if(!i&&"input"===e.nodeName.toLowerCase())return e.defaultValue}),he(function(e){return null==e.getAttribute("disabled")})||le(N,function(e,t,i){var s;if(!i)return!0===e[t]?t.toLowerCase():(s=e.getAttributeNode(t))&&s.specified?s.value:null}),ae}(E);A.find=v,A.expr=v.selectors,A.expr[":"]=A.expr.pseudos,A.uniqueSort=A.unique=v.uniqueSort,A.text=v.getText,A.isXMLDoc=v.isXML,A.contains=v.contains,A.escapeSelector=v.escape;var b=function(e,t,i){for(var s=[],n=void 0!==i;(e=e[t])&&9!==e.nodeType;)if(1===e.nodeType){if(n&&A(e).is(i))break;s.push(e)}return s},S=function(e,t){for(var i=[];e;e=e.nextSibling)1===e.nodeType&&e!==t&&i.push(e);return i},T=A.expr.match.needsContext;function M(e,t){return e.nodeName&&e.nodeName.toLowerCase()===t.toLowerCase()}var C=/^<([a-z][^\/\0>:\x20\t\r\n\f]*)[\x20\t\r\n\f]*\/?>(?:<\/\1>|)$/i,P=/^.[^:#\[\.,]*$/;function I(e,i,s){return A.isFunction(i)?A.grep(e,function(e,t){return!!i.call(e,t,e)!==s}):i.nodeType?A.grep(e,function(e){return e===i!==s}):"string"!=typeof i?A.grep(e,function(e){return-1<n.call(i,e)!==s}):P.test(i)?A.filter(i,e,s):(i=A.filter(i,e),A.grep(e,function(e){return-1<n.call(i,e)!==s&&1===e.nodeType}))}A.filter=function(e,t,i){var s=t[0];return i&&(e=":not("+e+")"),1===t.length&&1===s.nodeType?A.find.matchesSelector(s,e)?[s]:[]:A.find.matches(e,A.grep(t,function(e){return 1===e.nodeType}))},A.fn.extend({find:function(e){var t,i,s=this.length,n=this;if("string"!=typeof e)return this.pushStack(A(e).filter(function(){for(t=0;t<s;t++)if(A.contains(n[t],this))return!0}));for(i=this.pushStack([]),t=0;t<s;t++)A.find(e,n[t],i);return 1<s?A.uniqueSort(i):i},filter:function(e){return this.pushStack(I(this,e||[],!1))},not:function(e){return this.pushStack(I(this,e||[],!0))},is:function(e){return!!I(this,"string"==typeof e&&T.test(e)?A(e):e||[],!1).length}});var w,O=/^(?:\s*(<[\w\W]+>)[^>]*|#([\w-]+))$/;(A.fn.init=function(e,t,i){var s,n;if(!e)return this;if(i=i||w,"string"!=typeof e)return e.nodeType?(this[0]=e,this.length=1,this):A.isFunction(e)?void 0!==i.ready?i.ready(e):e(A):A.makeArray(e,this);if(!(s="<"===e[0]&&">"===e[e.length-1]&&3<=e.length?[null,e,null]:O.exec(e))||!s[1]&&t)return!t||t.jquery?(t||i).find(e):this.constructor(t).find(e);if(s[1]){if(t=t instanceof A?t[0]:t,A.merge(this,A.parseHTML(s[1],t&&t.nodeType?t.ownerDocument||t:x,!0)),C.test(s[1])&&A.isPlainObject(t))for(s in t)A.isFunction(this[s])?this[s](t[s]):this.attr(s,t[s]);return this}return(n=x.getElementById(s[2]))&&(this[0]=n,this.length=1),this}).prototype=A.fn,w=A(x);var R=/^(?:parents|prev(?:Until|All))/,L={children:!0,contents:!0,next:!0,prev:!0};function D(e,t){for(;(e=e[t])&&1!==e.nodeType;);return e}A.fn.extend({has:function(e){var t=A(e,this),i=t.length;return this.filter(function(){for(var e=0;e<i;e++)if(A.contains(this,t[e]))return!0})},closest:function(e,t){var i,s=0,n=this.length,a=[],r="string"!=typeof e&&A(e);if(!T.test(e))for(;s<n;s++)for(i=this[s];i&&i!==t;i=i.parentNode)if(i.nodeType<11&&(r?-1<r.index(i):1===i.nodeType&&A.find.matchesSelector(i,e))){a.push(i);break}return this.pushStack(1<a.length?A.uniqueSort(a):a)},index:function(e){return e?"string"==typeof e?n.call(A(e),this[0]):n.call(this,e.jquery?e[0]:e):this[0]&&this[0].parentNode?this.first().prevAll().length:-1},add:function(e,t){return this.pushStack(A.uniqueSort(A.merge(this.get(),A(e,t))))},addBack:function(e){return this.add(null==e?this.prevObject:this.prevObject.filter(e))}}),A.each({parent:function(e){var t=e.parentNode;return t&&11!==t.nodeType?t:null},parents:function(e){return b(e,"parentNode")},parentsUntil:function(e,t,i){return b(e,"parentNode",i)},next:function(e){return D(e,"nextSibling")},prev:function(e){return D(e,"previousSibling")},nextAll:function(e){return b(e,"nextSibling")},prevAll:function(e){return b(e,"previousSibling")},nextUntil:function(e,t,i){return b(e,"nextSibling",i)},prevUntil:function(e,t,i){return b(e,"previousSibling",i)},siblings:function(e){return S((e.parentNode||{}).firstChild,e)},children:function(e){return S(e.firstChild)},contents:function(e){return M(e,"iframe")?e.contentDocument:(M(e,"template")&&(e=e.content||e),A.merge([],e.childNodes))}},function(s,n){A.fn[s]=function(e,t){var i=A.map(this,n,e);return"Until"!==s.slice(-5)&&(t=e),t&&"string"==typeof t&&(i=A.filter(t,i)),1<this.length&&(L[s]||A.uniqueSort(i),R.test(s)&&i.reverse()),this.pushStack(i)}});var N=/[^\x20\t\r\n\f]+/g;function F(e){return e}function B(e){throw e}function k(e,t,i,s){var n;try{e&&A.isFunction(n=e.promise)?n.call(e).done(t).fail(i):e&&A.isFunction(n=e.then)?n.call(e,t,i):t.apply(void 0,[e].slice(s))}catch(e){i.apply(void 0,[e])}}A.Callbacks=function(s){s="string"==typeof s?function(e){var i={};return A.each(e.match(N)||[],function(e,t){i[t]=!0}),i}(s):A.extend({},s);var i,e,t,n,a=[],r=[],o=-1,h=function(){for(n=n||s.once,t=i=!0;r.length;o=-1)for(e=r.shift();++o<a.length;)!1===a[o].apply(e[0],e[1])&&s.stopOnFalse&&(o=a.length,e=!1);s.memory||(e=!1),i=!1,n&&(a=e?[]:"")},l={add:function(){return a&&(e&&!i&&(o=a.length-1,r.push(e)),function i(e){A.each(e,function(e,t){A.isFunction(t)?s.unique&&l.has(t)||a.push(t):t&&t.length&&"string"!==A.type(t)&&i(t)})}(arguments),e&&!i&&h()),this},remove:function(){return A.each(arguments,function(e,t){for(var i;-1<(i=A.inArray(t,a,i));)a.splice(i,1),i<=o&&o--}),this},has:function(e){return e?-1<A.inArray(e,a):0<a.length},empty:function(){return a&&(a=[]),this},disable:function(){return n=r=[],a=e="",this},disabled:function(){return!a},lock:function(){return n=r=[],e||i||(a=e=""),this},locked:function(){return!!n},fireWith:function(e,t){return n||(t=[e,(t=t||[]).slice?t.slice():t],r.push(t),i||h()),this},fire:function(){return l.fireWith(this,arguments),this},fired:function(){return!!t}};return l},A.extend({Deferred:function(e){var a=[["notify","progress",A.Callbacks("memory"),A.Callbacks("memory"),2],["resolve","done",A.Callbacks("once memory"),A.Callbacks("once memory"),0,"resolved"],["reject","fail",A.Callbacks("once memory"),A.Callbacks("once memory"),1,"rejected"]],n="pending",r={state:function(){return n},always:function(){return o.done(arguments).fail(arguments),this},catch:function(e){return r.then(null,e)},pipe:function(){var n=arguments;return A.Deferred(function(s){A.each(a,function(e,t){var i=A.isFunction(n[t[4]])&&n[t[4]];o[t[1]](function(){var e=i&&i.apply(this,arguments);e&&A.isFunction(e.promise)?e.promise().progress(s.notify).done(s.resolve).fail(s.reject):s[t[0]+"With"](this,i?[e]:arguments)})}),n=null}).promise()},then:function(t,i,s){var h=0;function l(n,a,r,o){return function(){var i=this,s=arguments,e=function(){var e,t;if(!(n<h)){if((e=r.apply(i,s))===a.promise())throw new TypeError("Thenable self-resolution");t=e&&("object"==typeof e||"function"==typeof e)&&e.then,A.isFunction(t)?o?t.call(e,l(h,a,F,o),l(h,a,B,o)):(h++,t.call(e,l(h,a,F,o),l(h,a,B,o),l(h,a,F,a.notifyWith))):(r!==F&&(i=void 0,s=[e]),(o||a.resolveWith)(i,s))}},t=o?e:function(){try{e()}catch(e){A.Deferred.exceptionHook&&A.Deferred.exceptionHook(e,t.stackTrace),h<=n+1&&(r!==B&&(i=void 0,s=[e]),a.rejectWith(i,s))}};n?t():(A.Deferred.getStackHook&&(t.stackTrace=A.Deferred.getStackHook()),E.setTimeout(t))}}return A.Deferred(function(e){a[0][3].add(l(0,e,A.isFunction(s)?s:F,e.notifyWith)),a[1][3].add(l(0,e,A.isFunction(t)?t:F)),a[2][3].add(l(0,e,A.isFunction(i)?i:B))}).promise()},promise:function(e){return null!=e?A.extend(e,r):r}},o={};return A.each(a,function(e,t){var i=t[2],s=t[5];r[t[1]]=i.add,s&&i.add(function(){n=s},a[3-e][2].disable,a[0][2].lock),i.add(t[3].fire),o[t[0]]=function(){return o[t[0]+"With"](this===o?void 0:this,arguments),this},o[t[0]+"With"]=i.fireWith}),r.promise(o),e&&e.call(o,o),o},when:function(e){var i=arguments.length,t=i,s=Array(t),n=o.call(arguments),a=A.Deferred(),r=function(t){return function(e){s[t]=this,n[t]=1<arguments.length?o.call(arguments):e,--i||a.resolveWith(s,n)}};if(i<=1&&(k(e,a.done(r(t)).resolve,a.reject,!i),"pending"===a.state()||A.isFunction(n[t]&&n[t].then)))return a.then();for(;t--;)k(n[t],r(t),a.reject);return a.promise()}});var V=/^(Eval|Internal|Range|Reference|Syntax|Type|URI)Error$/;A.Deferred.exceptionHook=function(e,t){E.console&&E.console.warn&&e&&V.test(e.name)&&E.console.warn("jQuery.Deferred exception: "+e.message,e.stack,t)},A.readyException=function(e){E.setTimeout(function(){throw e})};var U=A.Deferred();function z(){x.removeEventListener("DOMContentLoaded",z),E.removeEventListener("load",z),A.ready()}A.fn.ready=function(e){return U.then(e).catch(function(e){A.readyException(e)}),this},A.extend({isReady:!1,readyWait:1,ready:function(e){(!0===e?--A.readyWait:A.isReady)||((A.isReady=!0)!==e&&0<--A.readyWait||U.resolveWith(x,[A]))}}),A.ready.then=U.then,"complete"===x.readyState||"loading"!==x.readyState&&!x.documentElement.doScroll?E.setTimeout(A.ready):(x.addEventListener("DOMContentLoaded",z),E.addEventListener("load",z));var H=function(e,t,i,s,n,a,r){var o=0,h=e.length,l=null==i;if("object"===A.type(i))for(o in n=!0,i)H(e,t,o,i[o],!0,a,r);else if(void 0!==s&&(n=!0,A.isFunction(s)||(r=!0),l&&(t=r?(t.call(e,s),null):(l=t,function(e,t,i){return l.call(A(e),i)})),t))for(;o<h;o++)t(e[o],i,r?s:s.call(e[o],o,t(e[o],i)));return n?e:l?t.call(e):h?t(e[0],i):a},j=function(e){return 1===e.nodeType||9===e.nodeType||!+e.nodeType};function G(){this.expando=A.expando+G.uid++}G.uid=1,G.prototype={cache:function(e){var t=e[this.expando];return t||(t={},j(e)&&(e.nodeType?e[this.expando]=t:Object.defineProperty(e,this.expando,{value:t,configurable:!0}))),t},set:function(e,t,i){var s,n=this.cache(e);if("string"==typeof t)n[A.camelCase(t)]=i;else for(s in t)n[A.camelCase(s)]=t[s];return n},get:function(e,t){return void 0===t?this.cache(e):e[this.expando]&&e[this.expando][A.camelCase(t)]},access:function(e,t,i){return void 0===t||t&&"string"==typeof t&&void 0===i?this.get(e,t):(this.set(e,t,i),void 0!==i?i:t)},remove:function(e,t){var i,s=e[this.expando];if(void 0!==s){if(void 0!==t){i=(t=Array.isArray(t)?t.map(A.camelCase):(t=A.camelCase(t))in s?[t]:t.match(N)||[]).length;for(;i--;)delete s[t[i]]}(void 0===t||A.isEmptyObject(s))&&(e.nodeType?e[this.expando]=void 0:delete e[this.expando])}},hasData:function(e){var t=e[this.expando];return void 0!==t&&!A.isEmptyObject(t)}};var W=new G,Y=new G,X=/^(?:\{[\w\W]*\}|\[[\w\W]*\])$/,q=/[A-Z]/g;function K(e,t,i){var s;if(void 0===i&&1===e.nodeType)if(s="data-"+t.replace(q,"-$&").toLowerCase(),"string"==typeof(i=e.getAttribute(s))){try{i=function(e){return"true"===e||"false"!==e&&("null"===e?null:e===+e+""?+e:X.test(e)?JSON.parse(e):e)}(i)}catch(e){}Y.set(e,t,i)}else i=void 0;return i}A.extend({hasData:function(e){return Y.hasData(e)||W.hasData(e)},data:function(e,t,i){return Y.access(e,t,i)},removeData:function(e,t){Y.remove(e,t)},_data:function(e,t,i){return W.access(e,t,i)},_removeData:function(e,t){W.remove(e,t)}}),A.fn.extend({data:function(i,e){var t,s,n,a=this[0],r=a&&a.attributes;if(void 0!==i)return"object"==typeof i?this.each(function(){Y.set(this,i)}):H(this,function(e){var t;if(a&&void 0===e){if(void 0!==(t=Y.get(a,i)))return t;if(void 0!==(t=K(a,i)))return t}else this.each(function(){Y.set(this,i,e)})},null,e,1<arguments.length,null,!0);if(this.length&&(n=Y.get(a),1===a.nodeType&&!W.get(a,"hasDataAttrs"))){for(t=r.length;t--;)r[t]&&(0===(s=r[t].name).indexOf("data-")&&(s=A.camelCase(s.slice(5)),K(a,s,n[s])));W.set(a,"hasDataAttrs",!0)}return n},removeData:function(e){return this.each(function(){Y.remove(this,e)})}}),A.extend({queue:function(e,t,i){var s;if(e)return t=(t||"fx")+"queue",s=W.get(e,t),i&&(!s||Array.isArray(i)?s=W.access(e,t,A.makeArray(i)):s.push(i)),s||[]},dequeue:function(e,t){t=t||"fx";var i=A.queue(e,t),s=i.length,n=i.shift(),a=A._queueHooks(e,t);"inprogress"===n&&(n=i.shift(),s--),n&&("fx"===t&&i.unshift("inprogress"),delete a.stop,n.call(e,function(){A.dequeue(e,t)},a)),!s&&a&&a.empty.fire()},_queueHooks:function(e,t){var i=t+"queueHooks";return W.get(e,i)||W.access(e,i,{empty:A.Callbacks("once memory").add(function(){W.remove(e,[t+"queue",i])})})}}),A.fn.extend({queue:function(t,i){var e=2;return"string"!=typeof t&&(i=t,t="fx",e--),arguments.length<e?A.queue(this[0],t):void 0===i?this:this.each(function(){var e=A.queue(this,t,i);A._queueHooks(this,t),"fx"===t&&"inprogress"!==e[0]&&A.dequeue(this,t)})},dequeue:function(e){return this.each(function(){A.dequeue(this,e)})},clearQueue:function(e){return this.queue(e||"fx",[])},promise:function(e,t){var i,s=1,n=A.Deferred(),a=this,r=this.length,o=function(){--s||n.resolveWith(a,[a])};for("string"!=typeof e&&(t=e,e=void 0),e=e||"fx";r--;)(i=W.get(a[r],e+"queueHooks"))&&i.empty&&(s++,i.empty.add(o));return o(),n.promise(t)}});var Z=/[+-]?(?:\d*\.|)\d+(?:[eE][+-]?\d+|)/.source,Q=new RegExp("^(?:([+-])=|)("+Z+")([a-z%]*)$","i"),$=["Top","Right","Bottom","Left"],J=function(e,t){return"none"===(e=t||e).style.display||""===e.style.display&&A.contains(e.ownerDocument,e)&&"none"===A.css(e,"display")},ee=function(e,t,i,s){var n,a,r={};for(a in t)r[a]=e.style[a],e.style[a]=t[a];for(a in n=i.apply(e,s||[]),t)e.style[a]=r[a];return n};function te(e,t,i,s){var n,a=1,r=20,o=s?function(){return s.cur()}:function(){return A.css(e,t,"")},h=o(),l=i&&i[3]||(A.cssNumber[t]?"":"px"),c=(A.cssNumber[t]||"px"!==l&&+h)&&Q.exec(A.css(e,t));if(c&&c[3]!==l)for(l=l||c[3],i=i||[],c=+h||1;c/=a=a||".5",A.style(e,t,c+l),a!==(a=o()/h)&&1!==a&&--r;);return i&&(c=+c||+h||0,n=i[1]?c+(i[1]+1)*i[2]:+i[2],s&&(s.unit=l,s.start=c,s.end=n)),n}var ie={};function se(e,t){for(var i,s,n=[],a=0,r=e.length;a<r;a++)(s=e[a]).style&&(i=s.style.display,t?("none"===i&&(n[a]=W.get(s,"display")||null,n[a]||(s.style.display="")),""===s.style.display&&J(s)&&(n[a]=(d=l=h=void 0,l=(o=s).ownerDocument,c=o.nodeName,(d=ie[c])||(h=l.body.appendChild(l.createElement(c)),d=A.css(h,"display"),h.parentNode.removeChild(h),"none"===d&&(d="block"),ie[c]=d)))):"none"!==i&&(n[a]="none",W.set(s,"display",i)));var o,h,l,c,d;for(a=0;a<r;a++)null!=n[a]&&(e[a].style.display=n[a]);return e}A.fn.extend({show:function(){return se(this,!0)},hide:function(){return se(this)},toggle:function(e){return"boolean"==typeof e?e?this.show():this.hide():this.each(function(){J(this)?A(this).show():A(this).hide()})}});var ne=/^(?:checkbox|radio)$/i,ae=/<([a-z][^\/\0>\x20\t\r\n\f]+)/i,re=/^$|\/(?:java|ecma)script/i,oe={option:[1,"<select multiple='multiple'>","</select>"],thead:[1,"<table>","</table>"],col:[2,"<table><colgroup>","</colgroup></table>"],tr:[2,"<table><tbody>","</tbody></table>"],td:[3,"<table><tbody><tr>","</tr></tbody></table>"],_default:[0,"",""]};function he(e,t){var i;return i=void 0!==e.getElementsByTagName?e.getElementsByTagName(t||"*"):void 0!==e.querySelectorAll?e.querySelectorAll(t||"*"):[],void 0===t||t&&M(e,t)?A.merge([e],i):i}function le(e,t){for(var i=0,s=e.length;i<s;i++)W.set(e[i],"globalEval",!t||W.get(t[i],"globalEval"))}oe.optgroup=oe.option,oe.tbody=oe.tfoot=oe.colgroup=oe.caption=oe.thead,oe.th=oe.td;var ce,de,ue=/<|&#?\w+;/;function pe(e,t,i,s,n){for(var a,r,o,h,l,c,d=t.createDocumentFragment(),u=[],p=0,f=e.length;p<f;p++)if((a=e[p])||0===a)if("object"===A.type(a))A.merge(u,a.nodeType?[a]:a);else if(ue.test(a)){for(r=r||d.appendChild(t.createElement("div")),o=(ae.exec(a)||["",""])[1].toLowerCase(),h=oe[o]||oe._default,r.innerHTML=h[1]+A.htmlPrefilter(a)+h[2],c=h[0];c--;)r=r.lastChild;A.merge(u,r.childNodes),(r=d.firstChild).textContent=""}else u.push(t.createTextNode(a));for(d.textContent="",p=0;a=u[p++];)if(s&&-1<A.inArray(a,s))n&&n.push(a);else if(l=A.contains(a.ownerDocument,a),r=he(d.appendChild(a),"script"),l&&le(r),i)for(c=0;a=r[c++];)re.test(a.type||"")&&i.push(a);return d}ce=x.createDocumentFragment().appendChild(x.createElement("div")),(de=x.createElement("input")).setAttribute("type","radio"),de.setAttribute("checked","checked"),de.setAttribute("name","t"),ce.appendChild(de),_.checkClone=ce.cloneNode(!0).cloneNode(!0).lastChild.checked,ce.innerHTML="<textarea>x</textarea>",_.noCloneChecked=!!ce.cloneNode(!0).lastChild.defaultValue;var fe=x.documentElement,me=/^key/,_e=/^(?:mouse|pointer|contextmenu|drag|drop)|click/,ge=/^([^.]*)(?:\.(.+)|)/;function ye(){return!0}function ve(){return!1}function be(){try{return x.activeElement}catch(e){}}function Se(e,t,i,s,n,a){var r,o;if("object"==typeof t){for(o in"string"!=typeof i&&(s=s||i,i=void 0),t)Se(e,o,i,s,t[o],a);return e}if(null==s&&null==n?(n=i,s=i=void 0):null==n&&("string"==typeof i?(n=s,s=void 0):(n=s,s=i,i=void 0)),!1===n)n=ve;else if(!n)return e;return 1===a&&(r=n,(n=function(e){return A().off(e),r.apply(this,arguments)}).guid=r.guid||(r.guid=A.guid++)),e.each(function(){A.event.add(this,t,n,s,i)})}A.event={global:{},add:function(t,e,i,s,n){var a,r,o,h,l,c,d,u,p,f,m,_=W.get(t);if(_)for(i.handler&&(i=(a=i).handler,n=a.selector),n&&A.find.matchesSelector(fe,n),i.guid||(i.guid=A.guid++),(h=_.events)||(h=_.events={}),(r=_.handle)||(r=_.handle=function(e){return void 0!==A&&A.event.triggered!==e.type?A.event.dispatch.apply(t,arguments):void 0}),l=(e=(e||"").match(N)||[""]).length;l--;)p=m=(o=ge.exec(e[l])||[])[1],f=(o[2]||"").split(".").sort(),p&&(d=A.event.special[p]||{},p=(n?d.delegateType:d.bindType)||p,d=A.event.special[p]||{},c=A.extend({type:p,origType:m,data:s,handler:i,guid:i.guid,selector:n,needsContext:n&&A.expr.match.needsContext.test(n),namespace:f.join(".")},a),(u=h[p])||((u=h[p]=[]).delegateCount=0,d.setup&&!1!==d.setup.call(t,s,f,r)||t.addEventListener&&t.addEventListener(p,r)),d.add&&(d.add.call(t,c),c.handler.guid||(c.handler.guid=i.guid)),n?u.splice(u.delegateCount++,0,c):u.push(c),A.event.global[p]=!0)},remove:function(e,t,i,s,n){var a,r,o,h,l,c,d,u,p,f,m,_=W.hasData(e)&&W.get(e);if(_&&(h=_.events)){for(l=(t=(t||"").match(N)||[""]).length;l--;)if(p=m=(o=ge.exec(t[l])||[])[1],f=(o[2]||"").split(".").sort(),p){for(d=A.event.special[p]||{},u=h[p=(s?d.delegateType:d.bindType)||p]||[],o=o[2]&&new RegExp("(^|\\.)"+f.join("\\.(?:.*\\.|)")+"(\\.|$)"),r=a=u.length;a--;)c=u[a],!n&&m!==c.origType||i&&i.guid!==c.guid||o&&!o.test(c.namespace)||s&&s!==c.selector&&("**"!==s||!c.selector)||(u.splice(a,1),c.selector&&u.delegateCount--,d.remove&&d.remove.call(e,c));r&&!u.length&&(d.teardown&&!1!==d.teardown.call(e,f,_.handle)||A.removeEvent(e,p,_.handle),delete h[p])}else for(p in h)A.event.remove(e,p+t[l],i,s,!0);A.isEmptyObject(h)&&W.remove(e,"handle events")}},dispatch:function(e){var t,i,s,n,a,r,o=A.event.fix(e),h=new Array(arguments.length),l=(W.get(this,"events")||{})[o.type]||[],c=A.event.special[o.type]||{};for(h[0]=o,t=1;t<arguments.length;t++)h[t]=arguments[t];if(o.delegateTarget=this,!c.preDispatch||!1!==c.preDispatch.call(this,o)){for(r=A.event.handlers.call(this,o,l),t=0;(n=r[t++])&&!o.isPropagationStopped();)for(o.currentTarget=n.elem,i=0;(a=n.handlers[i++])&&!o.isImmediatePropagationStopped();)o.rnamespace&&!o.rnamespace.test(a.namespace)||(o.handleObj=a,o.data=a.data,void 0!==(s=((A.event.special[a.origType]||{}).handle||a.handler).apply(n.elem,h))&&!1===(o.result=s)&&(o.preventDefault(),o.stopPropagation()));return c.postDispatch&&c.postDispatch.call(this,o),o.result}},handlers:function(e,t){var i,s,n,a,r,o=[],h=t.delegateCount,l=e.target;if(h&&l.nodeType&&!("click"===e.type&&1<=e.button))for(;l!==this;l=l.parentNode||this)if(1===l.nodeType&&("click"!==e.type||!0!==l.disabled)){for(a=[],r={},i=0;i<h;i++)void 0===r[n=(s=t[i]).selector+" "]&&(r[n]=s.needsContext?-1<A(n,this).index(l):A.find(n,this,null,[l]).length),r[n]&&a.push(s);a.length&&o.push({elem:l,handlers:a})}return l=this,h<t.length&&o.push({elem:l,handlers:t.slice(h)}),o},addProp:function(t,e){Object.defineProperty(A.Event.prototype,t,{enumerable:!0,configurable:!0,get:A.isFunction(e)?function(){if(this.originalEvent)return e(this.originalEvent)}:function(){if(this.originalEvent)return this.originalEvent[t]},set:function(e){Object.defineProperty(this,t,{enumerable:!0,configurable:!0,writable:!0,value:e})}})},fix:function(e){return e[A.expando]?e:new A.Event(e)},special:{load:{noBubble:!0},focus:{trigger:function(){if(this!==be()&&this.focus)return this.focus(),!1},delegateType:"focusin"},blur:{trigger:function(){if(this===be()&&this.blur)return this.blur(),!1},delegateType:"focusout"},click:{trigger:function(){if("checkbox"===this.type&&this.click&&M(this,"input"))return this.click(),!1},_default:function(e){return M(e.target,"a")}},beforeunload:{postDispatch:function(e){void 0!==e.result&&e.originalEvent&&(e.originalEvent.returnValue=e.result)}}}},A.removeEvent=function(e,t,i){e.removeEventListener&&e.removeEventListener(t,i)},A.Event=function(e,t){return this instanceof A.Event?(e&&e.type?(this.originalEvent=e,this.type=e.type,this.isDefaultPrevented=e.defaultPrevented||void 0===e.defaultPrevented&&!1===e.returnValue?ye:ve,this.target=e.target&&3===e.target.nodeType?e.target.parentNode:e.target,this.currentTarget=e.currentTarget,this.relatedTarget=e.relatedTarget):this.type=e,t&&A.extend(this,t),this.timeStamp=e&&e.timeStamp||A.now(),void(this[A.expando]=!0)):new A.Event(e,t)},A.Event.prototype={constructor:A.Event,isDefaultPrevented:ve,isPropagationStopped:ve,isImmediatePropagationStopped:ve,isSimulated:!1,preventDefault:function(){var e=this.originalEvent;this.isDefaultPrevented=ye,e&&!this.isSimulated&&e.preventDefault()},stopPropagation:function(){var e=this.originalEvent;this.isPropagationStopped=ye,e&&!this.isSimulated&&e.stopPropagation()},stopImmediatePropagation:function(){var e=this.originalEvent;this.isImmediatePropagationStopped=ye,e&&!this.isSimulated&&e.stopImmediatePropagation(),this.stopPropagation()}},A.each({altKey:!0,bubbles:!0,cancelable:!0,changedTouches:!0,ctrlKey:!0,detail:!0,eventPhase:!0,metaKey:!0,pageX:!0,pageY:!0,shiftKey:!0,view:!0,char:!0,charCode:!0,key:!0,keyCode:!0,button:!0,buttons:!0,clientX:!0,clientY:!0,offsetX:!0,offsetY:!0,pointerId:!0,pointerType:!0,screenX:!0,screenY:!0,targetTouches:!0,toElement:!0,touches:!0,which:function(e){var t=e.button;return null==e.which&&me.test(e.type)?null!=e.charCode?e.charCode:e.keyCode:!e.which&&void 0!==t&&_e.test(e.type)?1&t?1:2&t?3:4&t?2:0:e.which}},A.event.addProp),A.each({mouseenter:"mouseover",mouseleave:"mouseout",pointerenter:"pointerover",pointerleave:"pointerout"},function(e,n){A.event.special[e]={delegateType:n,bindType:n,handle:function(e){var t,i=e.relatedTarget,s=e.handleObj;return i&&(i===this||A.contains(this,i))||(e.type=s.origType,t=s.handler.apply(this,arguments),e.type=n),t}}}),A.fn.extend({on:function(e,t,i,s){return Se(this,e,t,i,s)},one:function(e,t,i,s){return Se(this,e,t,i,s,1)},off:function(e,t,i){var s,n;if(e&&e.preventDefault&&e.handleObj)return s=e.handleObj,A(e.delegateTarget).off(s.namespace?s.origType+"."+s.namespace:s.origType,s.selector,s.handler),this;if("object"!=typeof e)return!1!==t&&"function"!=typeof t||(i=t,t=void 0),!1===i&&(i=ve),this.each(function(){A.event.remove(this,e,i,t)});for(n in e)this.off(n,t,e[n]);return this}});var Te=/<(?!area|br|col|embed|hr|img|input|link|meta|param)(([a-z][^\/\0>\x20\t\r\n\f]*)[^>]*)\/>/gi,Ee=/<script|<style|<link/i,xe=/checked\s*(?:[^=]|=\s*.checked.)/i,Ae=/^true\/(.*)/,Me=/^\s*<!(?:\[CDATA\[|--)|(?:\]\]|--)>\s*$/g;function Ce(e,t){return M(e,"table")&&M(11!==t.nodeType?t:t.firstChild,"tr")&&A(">tbody",e)[0]||e}function Pe(e){return e.type=(null!==e.getAttribute("type"))+"/"+e.type,e}function Ie(e){var t=Ae.exec(e.type);return t?e.type=t[1]:e.removeAttribute("type"),e}function we(e,t){var i,s,n,a,r,o,h,l;if(1===t.nodeType){if(W.hasData(e)&&(a=W.access(e),r=W.set(t,a),l=a.events))for(n in delete r.handle,r.events={},l)for(i=0,s=l[n].length;i<s;i++)A.event.add(t,n,l[n][i]);Y.hasData(e)&&(o=Y.access(e),h=A.extend({},o),Y.set(t,h))}}function Oe(i,s,n,a){s=m.apply([],s);var e,t,r,o,h,l,c=0,d=i.length,u=d-1,p=s[0],f=A.isFunction(p);if(f||1<d&&"string"==typeof p&&!_.checkClone&&xe.test(p))return i.each(function(e){var t=i.eq(e);f&&(s[0]=p.call(this,e,t.html())),Oe(t,s,n,a)});if(d&&(t=(e=pe(s,i[0].ownerDocument,!1,i,a)).firstChild,1===e.childNodes.length&&(e=t),t||a)){for(o=(r=A.map(he(e,"script"),Pe)).length;c<d;c++)h=e,c!==u&&(h=A.clone(h,!0,!0),o&&A.merge(r,he(h,"script"))),n.call(i[c],h,c);if(o)for(l=r[r.length-1].ownerDocument,A.map(r,Ie),c=0;c<o;c++)h=r[c],re.test(h.type||"")&&!W.access(h,"globalEval")&&A.contains(l,h)&&(h.src?A._evalUrl&&A._evalUrl(h.src):g(h.textContent.replace(Me,""),l))}return i}function Re(e,t,i){for(var s,n=t?A.filter(t,e):e,a=0;null!=(s=n[a]);a++)i||1!==s.nodeType||A.cleanData(he(s)),s.parentNode&&(i&&A.contains(s.ownerDocument,s)&&le(he(s,"script")),s.parentNode.removeChild(s));return e}A.extend({htmlPrefilter:function(e){return e.replace(Te,"<$1></$2>")},clone:function(e,t,i){var s,n,a,r,o,h,l,c=e.cloneNode(!0),d=A.contains(e.ownerDocument,e);if(!(_.noCloneChecked||1!==e.nodeType&&11!==e.nodeType||A.isXMLDoc(e)))for(r=he(c),s=0,n=(a=he(e)).length;s<n;s++)o=a[s],h=r[s],void 0,"input"===(l=h.nodeName.toLowerCase())&&ne.test(o.type)?h.checked=o.checked:"input"!==l&&"textarea"!==l||(h.defaultValue=o.defaultValue);if(t)if(i)for(a=a||he(e),r=r||he(c),s=0,n=a.length;s<n;s++)we(a[s],r[s]);else we(e,c);return 0<(r=he(c,"script")).length&&le(r,!d&&he(e,"script")),c},cleanData:function(e){for(var t,i,s,n=A.event.special,a=0;void 0!==(i=e[a]);a++)if(j(i)){if(t=i[W.expando]){if(t.events)for(s in t.events)n[s]?A.event.remove(i,s):A.removeEvent(i,s,t.handle);i[W.expando]=void 0}i[Y.expando]&&(i[Y.expando]=void 0)}}}),A.fn.extend({detach:function(e){return Re(this,e,!0)},remove:function(e){return Re(this,e)},text:function(e){return H(this,function(e){return void 0===e?A.text(this):this.empty().each(function(){1!==this.nodeType&&11!==this.nodeType&&9!==this.nodeType||(this.textContent=e)})},null,e,arguments.length)},append:function(){return Oe(this,arguments,function(e){1!==this.nodeType&&11!==this.nodeType&&9!==this.nodeType||Ce(this,e).appendChild(e)})},prepend:function(){return Oe(this,arguments,function(e){if(1===this.nodeType||11===this.nodeType||9===this.nodeType){var t=Ce(this,e);t.insertBefore(e,t.firstChild)}})},before:function(){return Oe(this,arguments,function(e){this.parentNode&&this.parentNode.insertBefore(e,this)})},after:function(){return Oe(this,arguments,function(e){this.parentNode&&this.parentNode.insertBefore(e,this.nextSibling)})},empty:function(){for(var e,t=0;null!=(e=this[t]);t++)1===e.nodeType&&(A.cleanData(he(e,!1)),e.textContent="");return this},clone:function(e,t){return e=null!=e&&e,t=null==t?e:t,this.map(function(){return A.clone(this,e,t)})},html:function(e){return H(this,function(e){var t=this[0]||{},i=0,s=this.length;if(void 0===e&&1===t.nodeType)return t.innerHTML;if("string"==typeof e&&!Ee.test(e)&&!oe[(ae.exec(e)||["",""])[1].toLowerCase()]){e=A.htmlPrefilter(e);try{for(;i<s;i++)1===(t=this[i]||{}).nodeType&&(A.cleanData(he(t,!1)),t.innerHTML=e);t=0}catch(e){}}t&&this.empty().append(e)},null,e,arguments.length)},replaceWith:function(){var i=[];return Oe(this,arguments,function(e){var t=this.parentNode;A.inArray(this,i)<0&&(A.cleanData(he(this)),t&&t.replaceChild(e,this))},i)}}),A.each({appendTo:"append",prependTo:"prepend",insertBefore:"before",insertAfter:"after",replaceAll:"replaceWith"},function(e,r){A.fn[e]=function(e){for(var t,i=[],s=A(e),n=s.length-1,a=0;a<=n;a++)t=a===n?this:this.clone(!0),A(s[a])[r](t),h.apply(i,t.get());return this.pushStack(i)}});var Le=/^margin/,De=new RegExp("^("+Z+")(?!px)[a-z%]+$","i"),Ne=function(e){var t=e.ownerDocument.defaultView;return t&&t.opener||(t=E),t.getComputedStyle(e)};function Fe(e,t,i){var s,n,a,r,o=e.style;return(i=i||Ne(e))&&(""!==(r=i.getPropertyValue(t)||i[t])||A.contains(e.ownerDocument,e)||(r=A.style(e,t)),!_.pixelMarginRight()&&De.test(r)&&Le.test(t)&&(s=o.width,n=o.minWidth,a=o.maxWidth,o.minWidth=o.maxWidth=o.width=r,r=i.width,o.width=s,o.minWidth=n,o.maxWidth=a)),void 0!==r?r+"":r}function Be(e,t){return{get:function(){return e()?void delete this.get:(this.get=t).apply(this,arguments)}}}!function(){function e(){if(r){r.style.cssText="box-sizing:border-box;position:relative;display:block;margin:auto;border:1px;padding:1px;top:1%;width:50%",r.innerHTML="",fe.appendChild(a);var e=E.getComputedStyle(r);t="1%"!==e.top,n="2px"===e.marginLeft,i="4px"===e.width,r.style.marginRight="50%",s="4px"===e.marginRight,fe.removeChild(a),r=null}}var t,i,s,n,a=x.createElement("div"),r=x.createElement("div");r.style&&(r.style.backgroundClip="content-box",r.cloneNode(!0).style.backgroundClip="",_.clearCloneStyle="content-box"===r.style.backgroundClip,a.style.cssText="border:0;width:8px;height:0;top:0;left:-9999px;padding:0;margin-top:1px;position:absolute",a.appendChild(r),A.extend(_,{pixelPosition:function(){return e(),t},boxSizingReliable:function(){return e(),i},pixelMarginRight:function(){return e(),s},reliableMarginLeft:function(){return e(),n}}))}();var ke=/^(none|table(?!-c[ea]).+)/,Ve=/^--/,Ue={position:"absolute",visibility:"hidden",display:"block"},ze={letterSpacing:"0",fontWeight:"400"},He=["Webkit","Moz","ms"],je=x.createElement("div").style;function Ge(e){var t=A.cssProps[e];return t||(t=A.cssProps[e]=function(e){if(e in je)return e;for(var t=e[0].toUpperCase()+e.slice(1),i=He.length;i--;)if((e=He[i]+t)in je)return e}(e)||e),t}function We(e,t,i){var s=Q.exec(t);return s?Math.max(0,s[2]-(i||0))+(s[3]||"px"):t}function Ye(e,t,i,s,n){var a,r=0;for(a=i===(s?"border":"content")?4:"width"===t?1:0;a<4;a+=2)"margin"===i&&(r+=A.css(e,i+$[a],!0,n)),s?("content"===i&&(r-=A.css(e,"padding"+$[a],!0,n)),"margin"!==i&&(r-=A.css(e,"border"+$[a]+"Width",!0,n))):(r+=A.css(e,"padding"+$[a],!0,n),"padding"!==i&&(r+=A.css(e,"border"+$[a]+"Width",!0,n)));return r}function Xe(e,t,i){var s,n=Ne(e),a=Fe(e,t,n),r="border-box"===A.css(e,"boxSizing",!1,n);return De.test(a)?a:(s=r&&(_.boxSizingReliable()||a===e.style[t]),"auto"===a&&(a=e["offset"+t[0].toUpperCase()+t.slice(1)]),(a=parseFloat(a)||0)+Ye(e,t,i||(r?"border":"content"),s,n)+"px")}function qe(e,t,i,s,n){return new qe.prototype.init(e,t,i,s,n)}A.extend({cssHooks:{opacity:{get:function(e,t){if(t){var i=Fe(e,"opacity");return""===i?"1":i}}}},cssNumber:{animationIterationCount:!0,columnCount:!0,fillOpacity:!0,flexGrow:!0,flexShrink:!0,fontWeight:!0,lineHeight:!0,opacity:!0,order:!0,orphans:!0,widows:!0,zIndex:!0,zoom:!0},cssProps:{float:"cssFloat"},style:function(e,t,i,s){if(e&&3!==e.nodeType&&8!==e.nodeType&&e.style){var n,a,r,o=A.camelCase(t),h=Ve.test(t),l=e.style;return h||(t=Ge(o)),r=A.cssHooks[t]||A.cssHooks[o],void 0===i?r&&"get"in r&&void 0!==(n=r.get(e,!1,s))?n:l[t]:("string"===(a=typeof i)&&(n=Q.exec(i))&&n[1]&&(i=te(e,t,n),a="number"),void(null!=i&&i==i&&("number"===a&&(i+=n&&n[3]||(A.cssNumber[o]?"":"px")),_.clearCloneStyle||""!==i||0!==t.indexOf("background")||(l[t]="inherit"),r&&"set"in r&&void 0===(i=r.set(e,i,s))||(h?l.setProperty(t,i):l[t]=i))))}},css:function(e,t,i,s){var n,a,r,o=A.camelCase(t);return Ve.test(t)||(t=Ge(o)),(r=A.cssHooks[t]||A.cssHooks[o])&&"get"in r&&(n=r.get(e,!0,i)),void 0===n&&(n=Fe(e,t,s)),"normal"===n&&t in ze&&(n=ze[t]),""===i||i?(a=parseFloat(n),!0===i||isFinite(a)?a||0:n):n}}),A.each(["height","width"],function(e,r){A.cssHooks[r]={get:function(e,t,i){if(t)return!ke.test(A.css(e,"display"))||e.getClientRects().length&&e.getBoundingClientRect().width?Xe(e,r,i):ee(e,Ue,function(){return Xe(e,r,i)})},set:function(e,t,i){var s,n=i&&Ne(e),a=i&&Ye(e,r,i,"border-box"===A.css(e,"boxSizing",!1,n),n);return a&&(s=Q.exec(t))&&"px"!==(s[3]||"px")&&(e.style[r]=t,t=A.css(e,r)),We(0,t,a)}}}),A.cssHooks.marginLeft=Be(_.reliableMarginLeft,function(e,t){if(t)return(parseFloat(Fe(e,"marginLeft"))||e.getBoundingClientRect().left-ee(e,{marginLeft:0},function(){return e.getBoundingClientRect().left}))+"px"}),A.each({margin:"",padding:"",border:"Width"},function(n,a){A.cssHooks[n+a]={expand:function(e){for(var t=0,i={},s="string"==typeof e?e.split(" "):[e];t<4;t++)i[n+$[t]+a]=s[t]||s[t-2]||s[0];return i}},Le.test(n)||(A.cssHooks[n+a].set=We)}),A.fn.extend({css:function(e,t){return H(this,function(e,t,i){var s,n,a={},r=0;if(Array.isArray(t)){for(s=Ne(e),n=t.length;r<n;r++)a[t[r]]=A.css(e,t[r],!1,s);return a}return void 0!==i?A.style(e,t,i):A.css(e,t)},e,t,1<arguments.length)}}),((A.Tween=qe).prototype={constructor:qe,init:function(e,t,i,s,n,a){this.elem=e,this.prop=i,this.easing=n||A.easing._default,this.options=t,this.start=this.now=this.cur(),this.end=s,this.unit=a||(A.cssNumber[i]?"":"px")},cur:function(){var e=qe.propHooks[this.prop];return e&&e.get?e.get(this):qe.propHooks._default.get(this)},run:function(e){var t,i=qe.propHooks[this.prop];return this.options.duration?this.pos=t=A.easing[this.easing](e,this.options.duration*e,0,1,this.options.duration):this.pos=t=e,this.now=(this.end-this.start)*t+this.start,this.options.step&&this.options.step.call(this.elem,this.now,this),i&&i.set?i.set(this):qe.propHooks._default.set(this),this}}).init.prototype=qe.prototype,(qe.propHooks={_default:{get:function(e){var t;return 1!==e.elem.nodeType||null!=e.elem[e.prop]&&null==e.elem.style[e.prop]?e.elem[e.prop]:(t=A.css(e.elem,e.prop,""))&&"auto"!==t?t:0},set:function(e){A.fx.step[e.prop]?A.fx.step[e.prop](e):1!==e.elem.nodeType||null==e.elem.style[A.cssProps[e.prop]]&&!A.cssHooks[e.prop]?e.elem[e.prop]=e.now:A.style(e.elem,e.prop,e.now+e.unit)}}}).scrollTop=qe.propHooks.scrollLeft={set:function(e){e.elem.nodeType&&e.elem.parentNode&&(e.elem[e.prop]=e.now)}},A.easing={linear:function(e){return e},swing:function(e){return.5-Math.cos(e*Math.PI)/2},_default:"swing"},A.fx=qe.prototype.init,A.fx.step={};var Ke,Ze,Qe,$e,Je=/^(?:toggle|show|hide)$/,et=/queueHooks$/;function tt(){Ze&&(!1===x.hidden&&E.requestAnimationFrame?E.requestAnimationFrame(tt):E.setTimeout(tt,A.fx.interval),A.fx.tick())}function it(){return E.setTimeout(function(){Ke=void 0}),Ke=A.now()}function st(e,t){var i,s=0,n={height:e};for(t=t?1:0;s<4;s+=2-t)n["margin"+(i=$[s])]=n["padding"+i]=e;return t&&(n.opacity=n.width=e),n}function nt(e,t,i){for(var s,n=(at.tweeners[t]||[]).concat(at.tweeners["*"]),a=0,r=n.length;a<r;a++)if(s=n[a].call(i,t,e))return s}function at(a,e,t){var i,r,s=0,n=at.prefilters.length,o=A.Deferred().always(function(){delete h.elem}),h=function(){if(r)return!1;for(var e=Ke||it(),t=Math.max(0,l.startTime+l.duration-e),i=1-(t/l.duration||0),s=0,n=l.tweens.length;s<n;s++)l.tweens[s].run(i);return o.notifyWith(a,[l,i,t]),i<1&&n?t:(n||o.notifyWith(a,[l,1,0]),o.resolveWith(a,[l]),!1)},l=o.promise({elem:a,props:A.extend({},e),opts:A.extend(!0,{specialEasing:{},easing:A.easing._default},t),originalProperties:e,originalOptions:t,startTime:Ke||it(),duration:t.duration,tweens:[],createTween:function(e,t){var i=A.Tween(a,l.opts,e,t,l.opts.specialEasing[e]||l.opts.easing);return l.tweens.push(i),i},stop:function(e){var t=0,i=e?l.tweens.length:0;if(r)return this;for(r=!0;t<i;t++)l.tweens[t].run(1);return e?(o.notifyWith(a,[l,1,0]),o.resolveWith(a,[l,e])):o.rejectWith(a,[l,e]),this}}),c=l.props;for(function(e,t){var i,s,n,a,r;for(i in e)if(n=t[s=A.camelCase(i)],a=e[i],Array.isArray(a)&&(n=a[1],a=e[i]=a[0]),i!==s&&(e[s]=a,delete e[i]),(r=A.cssHooks[s])&&"expand"in r)for(i in a=r.expand(a),delete e[s],a)i in e||(e[i]=a[i],t[i]=n);else t[s]=n}(c,l.opts.specialEasing);s<n;s++)if(i=at.prefilters[s].call(l,a,c,l.opts))return A.isFunction(i.stop)&&(A._queueHooks(l.elem,l.opts.queue).stop=A.proxy(i.stop,i)),i;return A.map(c,nt,l),A.isFunction(l.opts.start)&&l.opts.start.call(a,l),l.progress(l.opts.progress).done(l.opts.done,l.opts.complete).fail(l.opts.fail).always(l.opts.always),A.fx.timer(A.extend(h,{elem:a,anim:l,queue:l.opts.queue})),l}A.Animation=A.extend(at,{tweeners:{"*":[function(e,t){var i=this.createTween(e,t);return te(i.elem,e,Q.exec(t),i),i}]},tweener:function(e,t){for(var i,s=0,n=(e=A.isFunction(e)?(t=e,["*"]):e.match(N)).length;s<n;s++)i=e[s],at.tweeners[i]=at.tweeners[i]||[],at.tweeners[i].unshift(t)},prefilters:[function(e,t,i){var s,n,a,r,o,h,l,c,d="width"in t||"height"in t,u=this,p={},f=e.style,m=e.nodeType&&J(e),_=W.get(e,"fxshow");for(s in i.queue||(null==(r=A._queueHooks(e,"fx")).unqueued&&(r.unqueued=0,o=r.empty.fire,r.empty.fire=function(){r.unqueued||o()}),r.unqueued++,u.always(function(){u.always(function(){r.unqueued--,A.queue(e,"fx").length||r.empty.fire()})})),t)if(n=t[s],Je.test(n)){if(delete t[s],a=a||"toggle"===n,n===(m?"hide":"show")){if("show"!==n||!_||void 0===_[s])continue;m=!0}p[s]=_&&_[s]||A.style(e,s)}if((h=!A.isEmptyObject(t))||!A.isEmptyObject(p))for(s in d&&1===e.nodeType&&(i.overflow=[f.overflow,f.overflowX,f.overflowY],null==(l=_&&_.display)&&(l=W.get(e,"display")),"none"===(c=A.css(e,"display"))&&(l?c=l:(se([e],!0),l=e.style.display||l,c=A.css(e,"display"),se([e]))),("inline"===c||"inline-block"===c&&null!=l)&&"none"===A.css(e,"float")&&(h||(u.done(function(){f.display=l}),null==l&&(c=f.display,l="none"===c?"":c)),f.display="inline-block")),i.overflow&&(f.overflow="hidden",u.always(function(){f.overflow=i.overflow[0],f.overflowX=i.overflow[1],f.overflowY=i.overflow[2]})),h=!1,p)h||(_?"hidden"in _&&(m=_.hidden):_=W.access(e,"fxshow",{display:l}),a&&(_.hidden=!m),m&&se([e],!0),u.done(function(){for(s in m||se([e]),W.remove(e,"fxshow"),p)A.style(e,s,p[s])})),h=nt(m?_[s]:0,s,u),s in _||(_[s]=h.start,m&&(h.end=h.start,h.start=0))}],prefilter:function(e,t){t?at.prefilters.unshift(e):at.prefilters.push(e)}}),A.speed=function(e,t,i){var s=e&&"object"==typeof e?A.extend({},e):{complete:i||!i&&t||A.isFunction(e)&&e,duration:e,easing:i&&t||t&&!A.isFunction(t)&&t};return A.fx.off?s.duration=0:"number"!=typeof s.duration&&(s.duration in A.fx.speeds?s.duration=A.fx.speeds[s.duration]:s.duration=A.fx.speeds._default),null!=s.queue&&!0!==s.queue||(s.queue="fx"),s.old=s.complete,s.complete=function(){A.isFunction(s.old)&&s.old.call(this),s.queue&&A.dequeue(this,s.queue)},s},A.fn.extend({fadeTo:function(e,t,i,s){return this.filter(J).css("opacity",0).show().end().animate({opacity:t},e,i,s)},animate:function(t,e,i,s){var n=A.isEmptyObject(t),a=A.speed(e,i,s),r=function(){var e=at(this,A.extend({},t),a);(n||W.get(this,"finish"))&&e.stop(!0)};return r.finish=r,n||!1===a.queue?this.each(r):this.queue(a.queue,r)},stop:function(n,e,a){var r=function(e){var t=e.stop;delete e.stop,t(a)};return"string"!=typeof n&&(a=e,e=n,n=void 0),e&&!1!==n&&this.queue(n||"fx",[]),this.each(function(){var e=!0,t=null!=n&&n+"queueHooks",i=A.timers,s=W.get(this);if(t)s[t]&&s[t].stop&&r(s[t]);else for(t in s)s[t]&&s[t].stop&&et.test(t)&&r(s[t]);for(t=i.length;t--;)i[t].elem!==this||null!=n&&i[t].queue!==n||(i[t].anim.stop(a),e=!1,i.splice(t,1));!e&&a||A.dequeue(this,n)})},finish:function(r){return!1!==r&&(r=r||"fx"),this.each(function(){var e,t=W.get(this),i=t[r+"queue"],s=t[r+"queueHooks"],n=A.timers,a=i?i.length:0;for(t.finish=!0,A.queue(this,r,[]),s&&s.stop&&s.stop.call(this,!0),e=n.length;e--;)n[e].elem===this&&n[e].queue===r&&(n[e].anim.stop(!0),n.splice(e,1));for(e=0;e<a;e++)i[e]&&i[e].finish&&i[e].finish.call(this);delete t.finish})}}),A.each(["toggle","show","hide"],function(e,s){var n=A.fn[s];A.fn[s]=function(e,t,i){return null==e||"boolean"==typeof e?n.apply(this,arguments):this.animate(st(s,!0),e,t,i)}}),A.each({slideDown:st("show"),slideUp:st("hide"),slideToggle:st("toggle"),fadeIn:{opacity:"show"},fadeOut:{opacity:"hide"},fadeToggle:{opacity:"toggle"}},function(e,s){A.fn[e]=function(e,t,i){return this.animate(s,e,t,i)}}),A.timers=[],A.fx.tick=function(){var e,t=0,i=A.timers;for(Ke=A.now();t<i.length;t++)(e=i[t])()||i[t]!==e||i.splice(t--,1);i.length||A.fx.stop(),Ke=void 0},A.fx.timer=function(e){A.timers.push(e),A.fx.start()},A.fx.interval=13,A.fx.start=function(){Ze||(Ze=!0,tt())},A.fx.stop=function(){Ze=null},A.fx.speeds={slow:600,fast:200,_default:400},A.fn.delay=function(s,e){return s=A.fx&&A.fx.speeds[s]||s,e=e||"fx",this.queue(e,function(e,t){var i=E.setTimeout(e,s);t.stop=function(){E.clearTimeout(i)}})},Qe=x.createElement("input"),$e=x.createElement("select").appendChild(x.createElement("option")),Qe.type="checkbox",_.checkOn=""!==Qe.value,_.optSelected=$e.selected,(Qe=x.createElement("input")).value="t",Qe.type="radio",_.radioValue="t"===Qe.value;var rt,ot=A.expr.attrHandle;A.fn.extend({attr:function(e,t){return H(this,A.attr,e,t,1<arguments.length)},removeAttr:function(e){return this.each(function(){A.removeAttr(this,e)})}}),A.extend({attr:function(e,t,i){var s,n,a=e.nodeType;if(3!==a&&8!==a&&2!==a)return void 0===e.getAttribute?A.prop(e,t,i):(1===a&&A.isXMLDoc(e)||(n=A.attrHooks[t.toLowerCase()]||(A.expr.match.bool.test(t)?rt:void 0)),void 0!==i?null===i?void A.removeAttr(e,t):n&&"set"in n&&void 0!==(s=n.set(e,i,t))?s:(e.setAttribute(t,i+""),i):n&&"get"in n&&null!==(s=n.get(e,t))?s:null==(s=A.find.attr(e,t))?void 0:s)},attrHooks:{type:{set:function(e,t){if(!_.radioValue&&"radio"===t&&M(e,"input")){var i=e.value;return e.setAttribute("type",t),i&&(e.value=i),t}}}},removeAttr:function(e,t){var i,s=0,n=t&&t.match(N);if(n&&1===e.nodeType)for(;i=n[s++];)e.removeAttribute(i)}}),rt={set:function(e,t,i){return!1===t?A.removeAttr(e,i):e.setAttribute(i,i),i}},A.each(A.expr.match.bool.source.match(/\w+/g),function(e,t){var r=ot[t]||A.find.attr;ot[t]=function(e,t,i){var s,n,a=t.toLowerCase();return i||(n=ot[a],ot[a]=s,s=null!=r(e,t,i)?a:null,ot[a]=n),s}});var ht=/^(?:input|select|textarea|button)$/i,lt=/^(?:a|area)$/i;function ct(e){return(e.match(N)||[]).join(" ")}function dt(e){return e.getAttribute&&e.getAttribute("class")||""}A.fn.extend({prop:function(e,t){return H(this,A.prop,e,t,1<arguments.length)},removeProp:function(e){return this.each(function(){delete this[A.propFix[e]||e]})}}),A.extend({prop:function(e,t,i){var s,n,a=e.nodeType;if(3!==a&&8!==a&&2!==a)return 1===a&&A.isXMLDoc(e)||(t=A.propFix[t]||t,n=A.propHooks[t]),void 0!==i?n&&"set"in n&&void 0!==(s=n.set(e,i,t))?s:e[t]=i:n&&"get"in n&&null!==(s=n.get(e,t))?s:e[t]},propHooks:{tabIndex:{get:function(e){var t=A.find.attr(e,"tabindex");return t?parseInt(t,10):ht.test(e.nodeName)||lt.test(e.nodeName)&&e.href?0:-1}}},propFix:{for:"htmlFor",class:"className"}}),_.optSelected||(A.propHooks.selected={get:function(e){var t=e.parentNode;return t&&t.parentNode&&t.parentNode.selectedIndex,null},set:function(e){var t=e.parentNode;t&&(t.selectedIndex,t.parentNode&&t.parentNode.selectedIndex)}}),A.each(["tabIndex","readOnly","maxLength","cellSpacing","cellPadding","rowSpan","colSpan","useMap","frameBorder","contentEditable"],function(){A.propFix[this.toLowerCase()]=this}),A.fn.extend({addClass:function(t){var e,i,s,n,a,r,o,h=0;if(A.isFunction(t))return this.each(function(e){A(this).addClass(t.call(this,e,dt(this)))});if("string"==typeof t&&t)for(e=t.match(N)||[];i=this[h++];)if(n=dt(i),s=1===i.nodeType&&" "+ct(n)+" "){for(r=0;a=e[r++];)s.indexOf(" "+a+" ")<0&&(s+=a+" ");n!==(o=ct(s))&&i.setAttribute("class",o)}return this},removeClass:function(t){var e,i,s,n,a,r,o,h=0;if(A.isFunction(t))return this.each(function(e){A(this).removeClass(t.call(this,e,dt(this)))});if(!arguments.length)return this.attr("class","");if("string"==typeof t&&t)for(e=t.match(N)||[];i=this[h++];)if(n=dt(i),s=1===i.nodeType&&" "+ct(n)+" "){for(r=0;a=e[r++];)for(;-1<s.indexOf(" "+a+" ");)s=s.replace(" "+a+" "," ");n!==(o=ct(s))&&i.setAttribute("class",o)}return this},toggleClass:function(n,t){var a=typeof n;return"boolean"==typeof t&&"string"==a?t?this.addClass(n):this.removeClass(n):A.isFunction(n)?this.each(function(e){A(this).toggleClass(n.call(this,e,dt(this),t),t)}):this.each(function(){var e,t,i,s;if("string"==a)for(t=0,i=A(this),s=n.match(N)||[];e=s[t++];)i.hasClass(e)?i.removeClass(e):i.addClass(e);else void 0!==n&&"boolean"!=a||((e=dt(this))&&W.set(this,"__className__",e),this.setAttribute&&this.setAttribute("class",e||!1===n?"":W.get(this,"__className__")||""))})},hasClass:function(e){var t,i,s=0;for(t=" "+e+" ";i=this[s++];)if(1===i.nodeType&&-1<(" "+ct(dt(i))+" ").indexOf(t))return!0;return!1}});var ut=/\r/g;A.fn.extend({val:function(i){var s,e,n,t=this[0];return arguments.length?(n=A.isFunction(i),this.each(function(e){var t;1===this.nodeType&&(null==(t=n?i.call(this,e,A(this).val()):i)?t="":"number"==typeof t?t+="":Array.isArray(t)&&(t=A.map(t,function(e){return null==e?"":e+""})),(s=A.valHooks[this.type]||A.valHooks[this.nodeName.toLowerCase()])&&"set"in s&&void 0!==s.set(this,t,"value")||(this.value=t))})):t?(s=A.valHooks[t.type]||A.valHooks[t.nodeName.toLowerCase()])&&"get"in s&&void 0!==(e=s.get(t,"value"))?e:"string"==typeof(e=t.value)?e.replace(ut,""):null==e?"":e:void 0}}),A.extend({valHooks:{option:{get:function(e){var t=A.find.attr(e,"value");return null!=t?t:ct(A.text(e))}},select:{get:function(e){var t,i,s,n=e.options,a=e.selectedIndex,r="select-one"===e.type,o=r?null:[],h=r?a+1:n.length;for(s=a<0?h:r?a:0;s<h;s++)if(((i=n[s]).selected||s===a)&&!i.disabled&&(!i.parentNode.disabled||!M(i.parentNode,"optgroup"))){if(t=A(i).val(),r)return t;o.push(t)}return o},set:function(e,t){for(var i,s,n=e.options,a=A.makeArray(t),r=n.length;r--;)((s=n[r]).selected=-1<A.inArray(A.valHooks.option.get(s),a))&&(i=!0);return i||(e.selectedIndex=-1),a}}}}),A.each(["radio","checkbox"],function(){A.valHooks[this]={set:function(e,t){if(Array.isArray(t))return e.checked=-1<A.inArray(A(e).val(),t)}},_.checkOn||(A.valHooks[this].get=function(e){return null===e.getAttribute("value")?"on":e.value})});var pt=/^(?:focusinfocus|focusoutblur)$/;A.extend(A.event,{trigger:function(e,t,i,s){var n,a,r,o,h,l,c,d=[i||x],u=f.call(e,"type")?e.type:e,p=f.call(e,"namespace")?e.namespace.split("."):[];if(a=r=i=i||x,3!==i.nodeType&&8!==i.nodeType&&!pt.test(u+A.event.triggered)&&(-1<u.indexOf(".")&&(u=(p=u.split(".")).shift(),p.sort()),h=u.indexOf(":")<0&&"on"+u,(e=e[A.expando]?e:new A.Event(u,"object"==typeof e&&e)).isTrigger=s?2:3,e.namespace=p.join("."),e.rnamespace=e.namespace?new RegExp("(^|\\.)"+p.join("\\.(?:.*\\.|)")+"(\\.|$)"):null,e.result=void 0,e.target||(e.target=i),t=null==t?[e]:A.makeArray(t,[e]),c=A.event.special[u]||{},s||!c.trigger||!1!==c.trigger.apply(i,t))){if(!s&&!c.noBubble&&!A.isWindow(i)){for(o=c.delegateType||u,pt.test(o+u)||(a=a.parentNode);a;a=a.parentNode)d.push(a),r=a;r===(i.ownerDocument||x)&&d.push(r.defaultView||r.parentWindow||E)}for(n=0;(a=d[n++])&&!e.isPropagationStopped();)e.type=1<n?o:c.bindType||u,(l=(W.get(a,"events")||{})[e.type]&&W.get(a,"handle"))&&l.apply(a,t),(l=h&&a[h])&&l.apply&&j(a)&&(e.result=l.apply(a,t),!1===e.result&&e.preventDefault());return e.type=u,s||e.isDefaultPrevented()||c._default&&!1!==c._default.apply(d.pop(),t)||!j(i)||h&&A.isFunction(i[u])&&!A.isWindow(i)&&((r=i[h])&&(i[h]=null),i[A.event.triggered=u](),A.event.triggered=void 0,r&&(i[h]=r)),e.result}},simulate:function(e,t,i){var s=A.extend(new A.Event,i,{type:e,isSimulated:!0});A.event.trigger(s,null,t)}}),A.fn.extend({trigger:function(e,t){return this.each(function(){A.event.trigger(e,t,this)})},triggerHandler:function(e,t){var i=this[0];if(i)return A.event.trigger(e,t,i,!0)}}),A.each("blur focus focusin focusout resize scroll click dblclick mousedown mouseup mousemove mouseover mouseout mouseenter mouseleave change select submit keydown keypress keyup contextmenu".split(" "),function(e,i){A.fn[i]=function(e,t){return 0<arguments.length?this.on(i,null,e,t):this.trigger(i)}}),A.fn.extend({hover:function(e,t){return this.mouseenter(e).mouseleave(t||e)}}),_.focusin="onfocusin"in E,_.focusin||A.each({focus:"focusin",blur:"focusout"},function(i,s){var n=function(e){A.event.simulate(s,e.target,A.event.fix(e))};A.event.special[s]={setup:function(){var e=this.ownerDocument||this,t=W.access(e,s);t||e.addEventListener(i,n,!0),W.access(e,s,(t||0)+1)},teardown:function(){var e=this.ownerDocument||this,t=W.access(e,s)-1;t?W.access(e,s,t):(e.removeEventListener(i,n,!0),W.remove(e,s))}}});var ft=E.location,mt=A.now(),_t=/\?/;A.parseXML=function(e){var t;if(!e||"string"!=typeof e)return null;try{t=(new E.DOMParser).parseFromString(e,"text/xml")}catch(e){t=void 0}return t&&!t.getElementsByTagName("parsererror").length||A.error("Invalid XML: "+e),t};var gt=/\[\]$/,yt=/\r?\n/g,vt=/^(?:submit|button|image|reset|file)$/i,bt=/^(?:input|select|textarea|keygen)/i;function St(i,e,s,n){var t;if(Array.isArray(e))A.each(e,function(e,t){s||gt.test(i)?n(i,t):St(i+"["+("object"==typeof t&&null!=t?e:"")+"]",t,s,n)});else if(s||"object"!==A.type(e))n(i,e);else for(t in e)St(i+"["+t+"]",e[t],s,n)}A.param=function(e,t){var i,s=[],n=function(e,t){var i=A.isFunction(t)?t():t;s[s.length]=encodeURIComponent(e)+"="+encodeURIComponent(null==i?"":i)};if(Array.isArray(e)||e.jquery&&!A.isPlainObject(e))A.each(e,function(){n(this.name,this.value)});else for(i in e)St(i,e[i],t,n);return s.join("&")},A.fn.extend({serialize:function(){return A.param(this.serializeArray())},serializeArray:function(){return this.map(function(){var e=A.prop(this,"elements");return e?A.makeArray(e):this}).filter(function(){var e=this.type;return this.name&&!A(this).is(":disabled")&&bt.test(this.nodeName)&&!vt.test(e)&&(this.checked||!ne.test(e))}).map(function(e,t){var i=A(this).val();return null==i?null:Array.isArray(i)?A.map(i,function(e){return{name:t.name,value:e.replace(yt,"\r\n")}}):{name:t.name,value:i.replace(yt,"\r\n")}}).get()}});var Tt=/%20/g,Et=/#.*$/,xt=/([?&])_=[^&]*/,At=/^(.*?):[ \t]*([^\r\n]*)$/gm,Mt=/^(?:GET|HEAD)$/,Ct=/^\/\//,Pt={},It={},wt="*/".concat("*"),Ot=x.createElement("a");function Rt(a){return function(e,t){"string"!=typeof e&&(t=e,e="*");var i,s=0,n=e.toLowerCase().match(N)||[];if(A.isFunction(t))for(;i=n[s++];)"+"===i[0]?(i=i.slice(1)||"*",(a[i]=a[i]||[]).unshift(t)):(a[i]=a[i]||[]).push(t)}}function Lt(t,n,a,r){var o={},h=t===It;function l(e){var s;return o[e]=!0,A.each(t[e]||[],function(e,t){var i=t(n,a,r);return"string"!=typeof i||h||o[i]?h?!(s=i):void 0:(n.dataTypes.unshift(i),l(i),!1)}),s}return l(n.dataTypes[0])||!o["*"]&&l("*")}function Dt(e,t){var i,s,n=A.ajaxSettings.flatOptions||{};for(i in t)void 0!==t[i]&&((n[i]?e:s||(s={}))[i]=t[i]);return s&&A.extend(!0,e,s),e}Ot.href=ft.href,A.extend({active:0,lastModified:{},etag:{},ajaxSettings:{url:ft.href,type:"GET",isLocal:/^(?:about|app|app-storage|.+-extension|file|res|widget):$/.test(ft.protocol),global:!0,processData:!0,async:!0,contentType:"application/x-www-form-urlencoded; charset=UTF-8",accepts:{"*":wt,text:"text/plain",html:"text/html",xml:"application/xml, text/xml",json:"application/json, text/javascript"},contents:{xml:/\bxml\b/,html:/\bhtml/,json:/\bjson\b/},responseFields:{xml:"responseXML",text:"responseText",json:"responseJSON"},converters:{"* text":String,"text html":!0,"text json":JSON.parse,"text xml":A.parseXML},flatOptions:{url:!0,context:!0}},ajaxSetup:function(e,t){return t?Dt(Dt(e,A.ajaxSettings),t):Dt(A.ajaxSettings,e)},ajaxPrefilter:Rt(Pt),ajaxTransport:Rt(It),ajax:function(e,t){"object"==typeof e&&(t=e,e=void 0),t=t||{};var c,d,u,i,p,s,f,m,n,a,_=A.ajaxSetup({},t),g=_.context||_,y=_.context&&(g.nodeType||g.jquery)?A(g):A.event,v=A.Deferred(),b=A.Callbacks("once memory"),S=_.statusCode||{},r={},o={},h="canceled",T={readyState:0,getResponseHeader:function(e){var t;if(f){if(!i)for(i={};t=At.exec(u);)i[t[1].toLowerCase()]=t[2];t=i[e.toLowerCase()]}return null==t?null:t},getAllResponseHeaders:function(){return f?u:null},setRequestHeader:function(e,t){return null==f&&(e=o[e.toLowerCase()]=o[e.toLowerCase()]||e,r[e]=t),this},overrideMimeType:function(e){return null==f&&(_.mimeType=e),this},statusCode:function(e){var t;if(e)if(f)T.always(e[T.status]);else for(t in e)S[t]=[S[t],e[t]];return this},abort:function(e){var t=e||h;return c&&c.abort(t),l(0,t),this}};if(v.promise(T),_.url=((e||_.url||ft.href)+"").replace(Ct,ft.protocol+"//"),_.type=t.method||t.type||_.method||_.type,_.dataTypes=(_.dataType||"*").toLowerCase().match(N)||[""],null==_.crossDomain){s=x.createElement("a");try{s.href=_.url,s.href=s.href,_.crossDomain=Ot.protocol+"//"+Ot.host!=s.protocol+"//"+s.host}catch(e){_.crossDomain=!0}}if(_.data&&_.processData&&"string"!=typeof _.data&&(_.data=A.param(_.data,_.traditional)),Lt(Pt,_,t,T),f)return T;for(n in(m=A.event&&_.global)&&0==A.active++&&A.event.trigger("ajaxStart"),_.type=_.type.toUpperCase(),_.hasContent=!Mt.test(_.type),d=_.url.replace(Et,""),_.hasContent?_.data&&_.processData&&0===(_.contentType||"").indexOf("application/x-www-form-urlencoded")&&(_.data=_.data.replace(Tt,"+")):(a=_.url.slice(d.length),_.data&&(d+=(_t.test(d)?"&":"?")+_.data,delete _.data),!1===_.cache&&(d=d.replace(xt,"$1"),a=(_t.test(d)?"&":"?")+"_="+mt+++a),_.url=d+a),_.ifModified&&(A.lastModified[d]&&T.setRequestHeader("If-Modified-Since",A.lastModified[d]),A.etag[d]&&T.setRequestHeader("If-None-Match",A.etag[d])),(_.data&&_.hasContent&&!1!==_.contentType||t.contentType)&&T.setRequestHeader("Content-Type",_.contentType),T.setRequestHeader("Accept",_.dataTypes[0]&&_.accepts[_.dataTypes[0]]?_.accepts[_.dataTypes[0]]+("*"!==_.dataTypes[0]?", "+wt+"; q=0.01":""):_.accepts["*"]),_.headers)T.setRequestHeader(n,_.headers[n]);if(_.beforeSend&&(!1===_.beforeSend.call(g,T,_)||f))return T.abort();if(h="abort",b.add(_.complete),T.done(_.success),T.fail(_.error),c=Lt(It,_,t,T)){if(T.readyState=1,m&&y.trigger("ajaxSend",[T,_]),f)return T;_.async&&0<_.timeout&&(p=E.setTimeout(function(){T.abort("timeout")},_.timeout));try{f=!1,c.send(r,l)}catch(e){if(f)throw e;l(-1,e)}}else l(-1,"No Transport");function l(e,t,i,s){var n,a,r,o,h,l=t;f||(f=!0,p&&E.clearTimeout(p),c=void 0,u=s||"",T.readyState=0<e?4:0,n=200<=e&&e<300||304===e,i&&(o=function(e,t,i){for(var s,n,a,r,o=e.contents,h=e.dataTypes;"*"===h[0];)h.shift(),void 0===s&&(s=e.mimeType||t.getResponseHeader("Content-Type"));if(s)for(n in o)if(o[n]&&o[n].test(s)){h.unshift(n);break}if(h[0]in i)a=h[0];else{for(n in i){if(!h[0]||e.converters[n+" "+h[0]]){a=n;break}r||(r=n)}a=a||r}if(a)return a!==h[0]&&h.unshift(a),i[a]}(_,T,i)),o=function(e,t,i,s){var n,a,r,o,h,l={},c=e.dataTypes.slice();if(c[1])for(r in e.converters)l[r.toLowerCase()]=e.converters[r];for(a=c.shift();a;)if(e.responseFields[a]&&(i[e.responseFields[a]]=t),!h&&s&&e.dataFilter&&(t=e.dataFilter(t,e.dataType)),h=a,a=c.shift())if("*"===a)a=h;else if("*"!==h&&h!==a){if(!(r=l[h+" "+a]||l["* "+a]))for(n in l)if((o=n.split(" "))[1]===a&&(r=l[h+" "+o[0]]||l["* "+o[0]])){!0===r?r=l[n]:!0!==l[n]&&(a=o[0],c.unshift(o[1]));break}if(!0!==r)if(r&&e.throws)t=r(t);else try{t=r(t)}catch(e){return{state:"parsererror",error:r?e:"No conversion from "+h+" to "+a}}}return{state:"success",data:t}}(_,o,T,n),n?(_.ifModified&&((h=T.getResponseHeader("Last-Modified"))&&(A.lastModified[d]=h),(h=T.getResponseHeader("etag"))&&(A.etag[d]=h)),204===e||"HEAD"===_.type?l="nocontent":304===e?l="notmodified":(l=o.state,a=o.data,n=!(r=o.error))):(r=l,!e&&l||(l="error",e<0&&(e=0))),T.status=e,T.statusText=(t||l)+"",n?v.resolveWith(g,[a,l,T]):v.rejectWith(g,[T,l,r]),T.statusCode(S),S=void 0,m&&y.trigger(n?"ajaxSuccess":"ajaxError",[T,_,n?a:r]),b.fireWith(g,[T,l]),m&&(y.trigger("ajaxComplete",[T,_]),--A.active||A.event.trigger("ajaxStop")))}return T},getJSON:function(e,t,i){return A.get(e,t,i,"json")},getScript:function(e,t){return A.get(e,void 0,t,"script")}}),A.each(["get","post"],function(e,n){A[n]=function(e,t,i,s){return A.isFunction(t)&&(s=s||i,i=t,t=void 0),A.ajax(A.extend({url:e,type:n,dataType:s,data:t,success:i},A.isPlainObject(e)&&e))}}),A._evalUrl=function(e){return A.ajax({url:e,type:"GET",dataType:"script",cache:!0,async:!1,global:!1,throws:!0})},A.fn.extend({wrapAll:function(e){var t;return this[0]&&(A.isFunction(e)&&(e=e.call(this[0])),t=A(e,this[0].ownerDocument).eq(0).clone(!0),this[0].parentNode&&t.insertBefore(this[0]),t.map(function(){for(var e=this;e.firstElementChild;)e=e.firstElementChild;return e}).append(this)),this},wrapInner:function(i){return A.isFunction(i)?this.each(function(e){A(this).wrapInner(i.call(this,e))}):this.each(function(){var e=A(this),t=e.contents();t.length?t.wrapAll(i):e.append(i)})},wrap:function(t){var i=A.isFunction(t);return this.each(function(e){A(this).wrapAll(i?t.call(this,e):t)})},unwrap:function(e){return this.parent(e).not("body").each(function(){A(this).replaceWith(this.childNodes)}),this}}),A.expr.pseudos.hidden=function(e){return!A.expr.pseudos.visible(e)},A.expr.pseudos.visible=function(e){return!!(e.offsetWidth||e.offsetHeight||e.getClientRects().length)},A.ajaxSettings.xhr=function(){try{return new E.XMLHttpRequest}catch(e){}};var Nt={0:200,1223:204},Ft=A.ajaxSettings.xhr();_.cors=!!Ft&&"withCredentials"in Ft,_.ajax=Ft=!!Ft,A.ajaxTransport(function(n){var a,r;if(_.cors||Ft&&!n.crossDomain)return{send:function(e,t){var i,s=n.xhr();if(s.open(n.type,n.url,n.async,n.username,n.password),n.xhrFields)for(i in n.xhrFields)s[i]=n.xhrFields[i];for(i in n.mimeType&&s.overrideMimeType&&s.overrideMimeType(n.mimeType),n.crossDomain||e["X-Requested-With"]||(e["X-Requested-With"]="XMLHttpRequest"),e)s.setRequestHeader(i,e[i]);a=function(e){return function(){a&&(a=r=s.onload=s.onerror=s.onabort=s.onreadystatechange=null,"abort"===e?s.abort():"error"===e?"number"!=typeof s.status?t(0,"error"):t(s.status,s.statusText):t(Nt[s.status]||s.status,s.statusText,"text"!==(s.responseType||"text")||"string"!=typeof s.responseText?{binary:s.response}:{text:s.responseText},s.getAllResponseHeaders()))}},s.onload=a(),r=s.onerror=a("error"),void 0!==s.onabort?s.onabort=r:s.onreadystatechange=function(){4===s.readyState&&E.setTimeout(function(){a&&r()})},a=a("abort");try{s.send(n.hasContent&&n.data||null)}catch(e){if(a)throw e}},abort:function(){a&&a()}}}),A.ajaxPrefilter(function(e){e.crossDomain&&(e.contents.script=!1)}),A.ajaxSetup({accepts:{script:"text/javascript, application/javascript, application/ecmascript, application/x-ecmascript"},contents:{script:/\b(?:java|ecma)script\b/},converters:{"text script":function(e){return A.globalEval(e),e}}}),A.ajaxPrefilter("script",function(e){void 0===e.cache&&(e.cache=!1),e.crossDomain&&(e.type="GET")}),A.ajaxTransport("script",function(i){var s,n;if(i.crossDomain)return{send:function(e,t){s=A("<script>").prop({charset:i.scriptCharset,src:i.url}).on("load error",n=function(e){s.remove(),n=null,e&&t("error"===e.type?404:200,e.type)}),x.head.appendChild(s[0])},abort:function(){n&&n()}}});var Bt,kt=[],Vt=/(=)\?(?=&|$)|\?\?/;A.ajaxSetup({jsonp:"callback",jsonpCallback:function(){var e=kt.pop()||A.expando+"_"+mt++;return this[e]=!0,e}}),A.ajaxPrefilter("json jsonp",function(e,t,i){var s,n,a,r=!1!==e.jsonp&&(Vt.test(e.url)?"url":"string"==typeof e.data&&0===(e.contentType||"").indexOf("application/x-www-form-urlencoded")&&Vt.test(e.data)&&"data");if(r||"jsonp"===e.dataTypes[0])return s=e.jsonpCallback=A.isFunction(e.jsonpCallback)?e.jsonpCallback():e.jsonpCallback,r?e[r]=e[r].replace(Vt,"$1"+s):!1!==e.jsonp&&(e.url+=(_t.test(e.url)?"&":"?")+e.jsonp+"="+s),e.converters["script json"]=function(){return a||A.error(s+" was not called"),a[0]},e.dataTypes[0]="json",n=E[s],E[s]=function(){a=arguments},i.always(function(){void 0===n?A(E).removeProp(s):E[s]=n,e[s]&&(e.jsonpCallback=t.jsonpCallback,kt.push(s)),a&&A.isFunction(n)&&n(a[0]),a=n=void 0}),"script"}),_.createHTMLDocument=((Bt=x.implementation.createHTMLDocument("").body).innerHTML="<form></form><form></form>",2===Bt.childNodes.length),A.parseHTML=function(e,t,i){return"string"!=typeof e?[]:("boolean"==typeof t&&(i=t,t=!1),t||(_.createHTMLDocument?((s=(t=x.implementation.createHTMLDocument("")).createElement("base")).href=x.location.href,t.head.appendChild(s)):t=x),a=!i&&[],(n=C.exec(e))?[t.createElement(n[1])]:(n=pe([e],t,a),a&&a.length&&A(a).remove(),A.merge([],n.childNodes)));var s,n,a},A.fn.load=function(e,t,i){var s,n,a,r=this,o=e.indexOf(" ");return-1<o&&(s=ct(e.slice(o)),e=e.slice(0,o)),A.isFunction(t)?(i=t,t=void 0):t&&"object"==typeof t&&(n="POST"),0<r.length&&A.ajax({url:e,type:n||"GET",dataType:"html",data:t}).done(function(e){a=arguments,r.html(s?A("<div>").append(A.parseHTML(e)).find(s):e)}).always(i&&function(e,t){r.each(function(){i.apply(this,a||[e.responseText,t,e])})}),this},A.each(["ajaxStart","ajaxStop","ajaxComplete","ajaxError","ajaxSuccess","ajaxSend"],function(e,t){A.fn[t]=function(e){return this.on(t,e)}}),A.expr.pseudos.animated=function(t){return A.grep(A.timers,function(e){return t===e.elem}).length},A.offset={setOffset:function(e,t,i){var s,n,a,r,o,h,l=A.css(e,"position"),c=A(e),d={};"static"===l&&(e.style.position="relative"),o=c.offset(),a=A.css(e,"top"),h=A.css(e,"left"),n=("absolute"===l||"fixed"===l)&&-1<(a+h).indexOf("auto")?(r=(s=c.position()).top,s.left):(r=parseFloat(a)||0,parseFloat(h)||0),A.isFunction(t)&&(t=t.call(e,i,A.extend({},o))),null!=t.top&&(d.top=t.top-o.top+r),null!=t.left&&(d.left=t.left-o.left+n),"using"in t?t.using.call(e,d):c.css(d)}},A.fn.extend({offset:function(t){if(arguments.length)return void 0===t?this:this.each(function(e){A.offset.setOffset(this,t,e)});var e,i,s,n,a=this[0];return a?a.getClientRects().length?(s=a.getBoundingClientRect(),i=(e=a.ownerDocument).documentElement,n=e.defaultView,{top:s.top+n.pageYOffset-i.clientTop,left:s.left+n.pageXOffset-i.clientLeft}):{top:0,left:0}:void 0},position:function(){if(this[0]){var e,t,i=this[0],s={top:0,left:0};return"fixed"===A.css(i,"position")?t=i.getBoundingClientRect():(e=this.offsetParent(),t=this.offset(),M(e[0],"html")||(s=e.offset()),s={top:s.top+A.css(e[0],"borderTopWidth",!0),left:s.left+A.css(e[0],"borderLeftWidth",!0)}),{top:t.top-s.top-A.css(i,"marginTop",!0),left:t.left-s.left-A.css(i,"marginLeft",!0)}}},offsetParent:function(){return this.map(function(){for(var e=this.offsetParent;e&&"static"===A.css(e,"position");)e=e.offsetParent;return e||fe})}}),A.each({scrollLeft:"pageXOffset",scrollTop:"pageYOffset"},function(t,n){var a="pageYOffset"===n;A.fn[t]=function(e){return H(this,function(e,t,i){var s;return A.isWindow(e)?s=e:9===e.nodeType&&(s=e.defaultView),void 0===i?s?s[n]:e[t]:void(s?s.scrollTo(a?s.pageXOffset:i,a?i:s.pageYOffset):e[t]=i)},t,e,arguments.length)}}),A.each(["top","left"],function(e,i){A.cssHooks[i]=Be(_.pixelPosition,function(e,t){if(t)return t=Fe(e,i),De.test(t)?A(e).position()[i]+"px":t})}),A.each({Height:"height",Width:"width"},function(r,o){A.each({padding:"inner"+r,content:o,"":"outer"+r},function(s,a){A.fn[a]=function(e,t){var i=arguments.length&&(s||"boolean"!=typeof e),n=s||(!0===e||!0===t?"margin":"border");return H(this,function(e,t,i){var s;return A.isWindow(e)?0===a.indexOf("outer")?e["inner"+r]:e.document.documentElement["client"+r]:9===e.nodeType?(s=e.documentElement,Math.max(e.body["scroll"+r],s["scroll"+r],e.body["offset"+r],s["offset"+r],s["client"+r])):void 0===i?A.css(e,t,n):A.style(e,t,i,n)},o,i?e:void 0,i)}})}),A.fn.extend({bind:function(e,t,i){return this.on(e,null,t,i)},unbind:function(e,t){return this.off(e,null,t)},delegate:function(e,t,i,s){return this.on(t,e,i,s)},undelegate:function(e,t,i){return 1===arguments.length?this.off(e,"**"):this.off(t,e||"**",i)}}),A.holdReady=function(e){e?A.readyWait++:A.ready(!0)},A.isArray=Array.isArray,A.parseJSON=JSON.parse,A.nodeName=M,"function"==typeof define&&define.amd&&define("jquery",[],function(){return A});var Ut=E.jQuery,zt=E.$;return A.noConflict=function(e){return E.$===A&&(E.$=zt),e&&E.jQuery===A&&(E.jQuery=Ut),A},e||(E.jQuery=E.$=A),A}),function(a,r,u){var f=a.requestAnimationFrame||a.webkitRequestAnimationFrame||a.mozRequestAnimationFrame||a.oRequestAnimationFrame||a.msRequestAnimationFrame||function(e){a.setTimeout(e,1e3/60)},m=function(){var s={},n=r.createElement("div").style,t=function(){for(var e=["t","webkitT","MozT","msT","OT"],t=0,i=e.length;t<i;t++)if(e[t]+"ransform"in n)return e[t].substr(0,e[t].length-1);return!1}();function e(e){return!1!==t&&(""===t?e:t+e.charAt(0).toUpperCase()+e.substr(1))}s.getTime=Date.now||function(){return(new Date).getTime()},s.extend=function(e,t){for(var i in t)e[i]=t[i]},s.addEvent=function(e,t,i,s){e.addEventListener(t,i,!!s)},s.removeEvent=function(e,t,i,s){e.removeEventListener(t,i,!!s)},s.prefixPointerEvent=function(e){return a.MSPointerEvent?"MSPointer"+e.charAt(7).toUpperCase()+e.substr(8):e},s.momentum=function(e,t,i,s,n,a){var r,o,h=e-t,l=u.abs(h)/i;return o=l/(a=void 0===a?6e-4:a),(r=e+l*l/(2*a)*(h<0?-1:1))<s?(r=n?s-n/2.5*(l/8):s,o=(h=u.abs(r-e))/l):0<r&&(r=n?n/2.5*(l/8):0,o=(h=u.abs(e)+r)/l),{destination:u.round(r),duration:o}};var i=e("transform");return s.extend(s,{hasTransform:!1!==i,hasPerspective:e("perspective")in n,hasTouch:"ontouchstart"in a,hasPointer:!(!a.PointerEvent&&!a.MSPointerEvent),hasTransition:e("transition")in n}),s.isBadAndroid=function(){var e=a.navigator.appVersion;if(!/Android/.test(e)||/Chrome\/\d/.test(e))return!1;var t=e.match(/Safari\/(\d+.\d)/);return!(t&&"object"==typeof t&&2<=t.length)||parseFloat(t[1])<535.19}(),s.extend(s.style={},{transform:i,transitionTimingFunction:e("transitionTimingFunction"),transitionDuration:e("transitionDuration"),transitionDelay:e("transitionDelay"),transformOrigin:e("transformOrigin"),touchAction:e("touchAction")}),s.hasClass=function(e,t){return new RegExp("(^|\\s)"+t+"(\\s|$)").test(e.className)},s.addClass=function(e,t){if(!s.hasClass(e,t)){var i=e.className.split(" ");i.push(t),e.className=i.join(" ")}},s.removeClass=function(e,t){if(s.hasClass(e,t)){var i=new RegExp("(^|\\s)"+t+"(\\s|$)","g");e.className=e.className.replace(i," ")}},s.offset=function(e){for(var t=-e.offsetLeft,i=-e.offsetTop;e=e.offsetParent;)t-=e.offsetLeft,i-=e.offsetTop;return{left:t,top:i}},s.preventDefaultException=function(e,t){for(var i in t)if(t[i].test(e[i]))return!0;return!1},s.extend(s.eventType={},{touchstart:1,touchmove:1,touchend:1,mousedown:2,mousemove:2,mouseup:2,pointerdown:3,pointermove:3,pointerup:3,MSPointerDown:3,MSPointerMove:3,MSPointerUp:3}),s.extend(s.ease={},{quadratic:{style:"cubic-bezier(0.25, 0.46, 0.45, 0.94)",fn:function(e){return e*(2-e)}},circular:{style:"cubic-bezier(0.1, 0.57, 0.1, 1)",fn:function(e){return u.sqrt(1- --e*e)}},back:{style:"cubic-bezier(0.175, 0.885, 0.32, 1.275)",fn:function(e){return(e-=1)*e*(5*e+4)+1}},bounce:{style:"",fn:function(e){return(e/=1)<1/2.75?7.5625*e*e:e<2/2.75?7.5625*(e-=1.5/2.75)*e+.75:e<2.5/2.75?7.5625*(e-=2.25/2.75)*e+.9375:7.5625*(e-=2.625/2.75)*e+.984375}},elastic:{style:"",fn:function(e){return 0===e?0:1==e?1:.4*u.pow(2,-10*e)*u.sin((e-.055)*(2*u.PI)/.22)+1}}}),s.tap=function(e,t){var i=r.createEvent("Event");i.initEvent(t,!0,!0),i.pageX=e.pageX,i.pageY=e.pageY,e.target.dispatchEvent(i)},s.click=function(e){var t,i=e.target;/(SELECT|INPUT|TEXTAREA)/i.test(i.tagName)||((t=r.createEvent(a.MouseEvent?"MouseEvents":"Event")).initEvent("click",!0,!0),t.view=e.view||a,t.detail=1,t.screenX=i.screenX||0,t.screenY=i.screenY||0,t.clientX=i.clientX||0,t.clientY=i.clientY||0,t.ctrlKey=!!e.ctrlKey,t.altKey=!!e.altKey,t.shiftKey=!!e.shiftKey,t.metaKey=!!e.metaKey,t.button=0,t.relatedTarget=null,t._constructed=!0,i.dispatchEvent(t))},s.getTouchAction=function(e,t){var i="none";return"vertical"===e?i="pan-y":"horizontal"===e&&(i="pan-x"),t&&"none"!=i&&(i+=" pinch-zoom"),i},s.getRect=function(e){if(e instanceof SVGElement){var t=e.getBoundingClientRect();return{top:t.top,left:t.left,width:t.width,height:t.height}}return{top:e.offsetTop,left:e.offsetLeft,width:e.offsetWidth,height:e.offsetHeight}},s}();function e(e,t){for(var i in this.wrapper="string"==typeof e?r.querySelector(e):e,this.scroller=this.wrapper.children[0],this.scrollerStyle=this.scroller.style,this.options={resizeScrollbars:!0,mouseWheelSpeed:20,snapThreshold:.334,disablePointer:!m.hasPointer,disableTouch:m.hasPointer||!m.hasTouch,disableMouse:m.hasPointer||m.hasTouch,startX:0,startY:0,scrollY:!0,directionLockThreshold:5,momentum:!0,bounce:!0,bounceTime:600,bounceEasing:"",preventDefault:!0,preventDefaultException:{tagName:/^(INPUT|TEXTAREA|BUTTON|SELECT)$/},HWCompositing:!0,useTransition:!0,useTransform:!0,bindToWrapper:void 0===a.onmousedown},t)this.options[i]=t[i];this.translateZ=this.options.HWCompositing&&m.hasPerspective?" translateZ(0)":"",this.options.useTransition=m.hasTransition&&this.options.useTransition,this.options.useTransform=m.hasTransform&&this.options.useTransform,this.options.eventPassthrough=!0===this.options.eventPassthrough?"vertical":this.options.eventPassthrough,this.options.preventDefault=!this.options.eventPassthrough&&this.options.preventDefault,this.options.scrollY="vertical"!=this.options.eventPassthrough&&this.options.scrollY,this.options.scrollX="horizontal"!=this.options.eventPassthrough&&this.options.scrollX,this.options.freeScroll=this.options.freeScroll&&!this.options.eventPassthrough,this.options.directionLockThreshold=this.options.eventPassthrough?0:this.options.directionLockThreshold,this.options.bounceEasing="string"==typeof this.options.bounceEasing?m.ease[this.options.bounceEasing]||m.ease.circular:this.options.bounceEasing,this.options.resizePolling=void 0===this.options.resizePolling?60:this.options.resizePolling,!0===this.options.tap&&(this.options.tap="tap"),this.options.useTransition||this.options.useTransform||/relative|absolute/i.test(this.scrollerStyle.position)||(this.scrollerStyle.position="relative"),"scale"==this.options.shrinkScrollbars&&(this.options.useTransition=!1),this.options.invertWheelDirection=this.options.invertWheelDirection?-1:1,this.x=0,this.y=0,this.directionX=0,this.directionY=0,this._events={},this._init(),this.refresh(),this.scrollTo(this.options.startX,this.options.startY),this.enable()}function o(e,t,i){var s=r.createElement("div"),n=r.createElement("div");return!0===i&&(s.style.cssText="position:absolute;z-index:9999",n.style.cssText="-webkit-box-sizing:border-box;-moz-box-sizing:border-box;box-sizing:border-box;position:absolute;background:rgba(0,0,0,0.5);border:1px solid rgba(255,255,255,0.9);border-radius:3px"),n.className="iScrollIndicator","h"==e?(!0===i&&(s.style.cssText+=";height:7px;left:2px;right:2px;bottom:0",n.style.height="100%"),s.className="iScrollHorizontalScrollbar"):(!0===i&&(s.style.cssText+=";width:7px;bottom:2px;top:2px;right:1px",n.style.width="100%"),s.className="iScrollVerticalScrollbar"),s.style.cssText+=";overflow:hidden",t||(s.style.pointerEvents="none"),s.appendChild(n),s}function h(e,t){for(var i in this.wrapper="string"==typeof t.el?r.querySelector(t.el):t.el,this.wrapperStyle=this.wrapper.style,this.indicator=this.wrapper.children[0],this.indicatorStyle=this.indicator.style,this.scroller=e,this.options={listenX:!0,listenY:!0,interactive:!1,resize:!0,defaultScrollbars:!1,shrink:!1,fade:!1,speedRatioX:0,speedRatioY:0},t)this.options[i]=t[i];if(this.sizeRatioX=1,this.sizeRatioY=1,this.maxPosX=0,this.maxPosY=0,this.options.interactive&&(this.options.disableTouch||(m.addEvent(this.indicator,"touchstart",this),m.addEvent(a,"touchend",this)),this.options.disablePointer||(m.addEvent(this.indicator,m.prefixPointerEvent("pointerdown"),this),m.addEvent(a,m.prefixPointerEvent("pointerup"),this)),this.options.disableMouse||(m.addEvent(this.indicator,"mousedown",this),m.addEvent(a,"mouseup",this))),this.options.fade){this.wrapperStyle[m.style.transform]=this.scroller.translateZ;var s=m.style.transitionDuration;if(!s)return;this.wrapperStyle[s]=m.isBadAndroid?"0.0001ms":"0ms";var n=this;m.isBadAndroid&&f(function(){"0.0001ms"===n.wrapperStyle[s]&&(n.wrapperStyle[s]="0s")}),this.wrapperStyle.opacity="0"}}e.prototype={version:"5.2.0-snapshot",_init:function(){this._initEvents(),(this.options.scrollbars||this.options.indicators)&&this._initIndicators(),this.options.mouseWheel&&this._initWheel(),this.options.snap&&this._initSnap(),this.options.keyBindings&&this._initKeys()},destroy:function(){this._initEvents(!0),clearTimeout(this.resizeTimeout),this.resizeTimeout=null,this._execEvent("destroy")},_transitionEnd:function(e){e.target==this.scroller&&this.isInTransition&&(this._transitionTime(),this.resetPosition(this.options.bounceTime)||(this.isInTransition=!1,this._execEvent("scrollEnd")))},_start:function(e){if((1==m.eventType[e.type]||0===(e.which?e.button:e.button<2?0:4==e.button?1:2))&&this.enabled&&(!this.initiated||m.eventType[e.type]===this.initiated)){!this.options.preventDefault||m.isBadAndroid||m.preventDefaultException(e.target,this.options.preventDefaultException)||e.preventDefault();var t,i=e.touches?e.touches[0]:e;this.initiated=m.eventType[e.type],this.moved=!1,this.distX=0,this.distY=0,this.directionX=0,this.directionY=0,this.directionLocked=0,this.startTime=m.getTime(),this.options.useTransition&&this.isInTransition?(this._transitionTime(),this.isInTransition=!1,t=this.getComputedPosition(),this._translate(u.round(t.x),u.round(t.y)),this._execEvent("scrollEnd")):!this.options.useTransition&&this.isAnimating&&(this.isAnimating=!1,this._execEvent("scrollEnd")),this.startX=this.x,this.startY=this.y,this.absStartX=this.x,this.absStartY=this.y,this.pointX=i.pageX,this.pointY=i.pageY,this._execEvent("beforeScrollStart")}},_move:function(e){if(this.enabled&&m.eventType[e.type]===this.initiated){this.options.preventDefault&&e.preventDefault();var t,i,s,n,a=e.touches?e.touches[0]:e,r=a.pageX-this.pointX,o=a.pageY-this.pointY,h=m.getTime();if(this.pointX=a.pageX,this.pointY=a.pageY,this.distX+=r,this.distY+=o,s=u.abs(this.distX),n=u.abs(this.distY),!(300<h-this.endTime&&s<10&&n<10)){if(this.directionLocked||this.options.freeScroll||(s>n+this.options.directionLockThreshold?this.directionLocked="h":n>=s+this.options.directionLockThreshold?this.directionLocked="v":this.directionLocked="n"),"h"==this.directionLocked){if("vertical"==this.options.eventPassthrough)e.preventDefault();else if("horizontal"==this.options.eventPassthrough)return void(this.initiated=!1);o=0}else if("v"==this.directionLocked){if("horizontal"==this.options.eventPassthrough)e.preventDefault();else if("vertical"==this.options.eventPassthrough)return void(this.initiated=!1);r=0}r=this.hasHorizontalScroll?r:0,o=this.hasVerticalScroll?o:0,t=this.x+r,i=this.y+o,(0<t||t<this.maxScrollX)&&(t=this.options.bounce?this.x+r/3:0<t?0:this.maxScrollX),(0<i||i<this.maxScrollY)&&(i=this.options.bounce?this.y+o/3:0<i?0:this.maxScrollY),this.directionX=0<r?-1:r<0?1:0,this.directionY=0<o?-1:o<0?1:0,this.moved||this._execEvent("scrollStart"),this.moved=!0,this._translate(t,i),300<h-this.startTime&&(this.startTime=h,this.startX=this.x,this.startY=this.y)}}},_end:function(e){if(this.enabled&&m.eventType[e.type]===this.initiated){this.options.preventDefault&&!m.preventDefaultException(e.target,this.options.preventDefaultException)&&e.preventDefault(),e.changedTouches&&e.changedTouches[0];var t,i,s=m.getTime()-this.startTime,n=u.round(this.x),a=u.round(this.y),r=u.abs(n-this.startX),o=u.abs(a-this.startY),h=0,l="";if(this.isInTransition=0,this.initiated=0,this.endTime=m.getTime(),!this.resetPosition(this.options.bounceTime)){if(this.scrollTo(n,a),!this.moved)return this.options.tap&&m.tap(e,this.options.tap),this.options.click&&m.click(e),void this._execEvent("scrollCancel");if(this._events.flick&&s<200&&r<100&&o<100)this._execEvent("flick");else{if(this.options.momentum&&s<300&&(t=this.hasHorizontalScroll?m.momentum(this.x,this.startX,s,this.maxScrollX,this.options.bounce?this.wrapperWidth:0,this.options.deceleration):{destination:n,duration:0},i=this.hasVerticalScroll?m.momentum(this.y,this.startY,s,this.maxScrollY,this.options.bounce?this.wrapperHeight:0,this.options.deceleration):{destination:a,duration:0},n=t.destination,a=i.destination,h=u.max(t.duration,i.duration),this.isInTransition=1),this.options.snap){var c=this._nearestSnap(n,a);this.currentPage=c,h=this.options.snapSpeed||u.max(u.max(u.min(u.abs(n-c.x),1e3),u.min(u.abs(a-c.y),1e3)),300),n=c.x,a=c.y,this.directionX=0,this.directionY=0,l=this.options.bounceEasing}if(n!=this.x||a!=this.y)return(0<n||n<this.maxScrollX||0<a||a<this.maxScrollY)&&(l=m.ease.quadratic),void this.scrollTo(n,a,h,l);this._execEvent("scrollEnd")}}}},_resize:function(){var e=this;clearTimeout(this.resizeTimeout),this.resizeTimeout=setTimeout(function(){e.refresh()},this.options.resizePolling)},resetPosition:function(e){var t=this.x,i=this.y;return e=e||0,!this.hasHorizontalScroll||0<this.x?t=0:this.x<this.maxScrollX&&(t=this.maxScrollX),!this.hasVerticalScroll||0<this.y?i=0:this.y<this.maxScrollY&&(i=this.maxScrollY),(t!=this.x||i!=this.y)&&(this.scrollTo(t,i,e,this.options.bounceEasing),!0)},disable:function(){this.enabled=!1},enable:function(){this.enabled=!0},refresh:function(){m.getRect(this.wrapper),this.wrapperWidth=this.wrapper.clientWidth,this.wrapperHeight=this.wrapper.clientHeight;var e=m.getRect(this.scroller);this.scrollerWidth=e.width,this.scrollerHeight=e.height,this.maxScrollX=this.wrapperWidth-this.scrollerWidth,this.maxScrollY=this.wrapperHeight-this.scrollerHeight,this.hasHorizontalScroll=this.options.scrollX&&this.maxScrollX<0,this.hasVerticalScroll=this.options.scrollY&&this.maxScrollY<0,this.hasHorizontalScroll||(this.maxScrollX=0,this.scrollerWidth=this.wrapperWidth),this.hasVerticalScroll||(this.maxScrollY=0,this.scrollerHeight=this.wrapperHeight),this.endTime=0,this.directionX=0,this.directionY=0,m.hasPointer&&!this.options.disablePointer&&(this.wrapper.style[m.style.touchAction]=m.getTouchAction(this.options.eventPassthrough,!0),this.wrapper.style[m.style.touchAction]||(this.wrapper.style[m.style.touchAction]=m.getTouchAction(this.options.eventPassthrough,!1))),this.wrapperOffset=m.offset(this.wrapper),this._execEvent("refresh"),this.resetPosition()},on:function(e,t){this._events[e]||(this._events[e]=[]),this._events[e].push(t)},off:function(e,t){if(this._events[e]){var i=this._events[e].indexOf(t);-1<i&&this._events[e].splice(i,1)}},_execEvent:function(e){if(this._events[e]){var t=0,i=this._events[e].length;if(i)for(;t<i;t++)this._events[e][t].apply(this,[].slice.call(arguments,1))}},scrollBy:function(e,t,i,s){e=this.x+e,t=this.y+t,i=i||0,this.scrollTo(e,t,i,s)},scrollTo:function(e,t,i,s){s=s||m.ease.circular,this.isInTransition=this.options.useTransition&&0<i;var n=this.options.useTransition&&s.style;!i||n?(n&&(this._transitionTimingFunction(s.style),this._transitionTime(i)),this._translate(e,t)):this._animate(e,t,i,s.fn)},scrollToElement:function(e,t,i,s,n){if(e=e.nodeType?e:this.scroller.querySelector(e)){var a=m.offset(e);a.left-=this.wrapperOffset.left,a.top-=this.wrapperOffset.top;var r=m.getRect(e),o=m.getRect(this.wrapper);!0===i&&(i=u.round(r.width/2-o.width/2)),!0===s&&(s=u.round(r.height/2-o.height/2)),a.left-=i||0,a.top-=s||0,a.left=0<a.left?0:a.left<this.maxScrollX?this.maxScrollX:a.left,a.top=0<a.top?0:a.top<this.maxScrollY?this.maxScrollY:a.top,t=null==t||"auto"===t?u.max(u.abs(this.x-a.left),u.abs(this.y-a.top)):t,this.scrollTo(a.left,a.top,t,n)}},_transitionTime:function(e){if(this.options.useTransition){e=e||0;var t=m.style.transitionDuration;if(t){if(this.scrollerStyle[t]=e+"ms",!e&&m.isBadAndroid){this.scrollerStyle[t]="0.0001ms";var i=this;f(function(){"0.0001ms"===i.scrollerStyle[t]&&(i.scrollerStyle[t]="0s")})}if(this.indicators)for(var s=this.indicators.length;s--;)this.indicators[s].transitionTime(e)}}},_transitionTimingFunction:function(e){if(this.scrollerStyle[m.style.transitionTimingFunction]=e,this.indicators)for(var t=this.indicators.length;t--;)this.indicators[t].transitionTimingFunction(e)},_translate:function(e,t){if(this.options.useTransform?this.scrollerStyle[m.style.transform]="translate("+e+"px,"+t+"px)"+this.translateZ:(e=u.round(e),t=u.round(t),this.scrollerStyle.left=e+"px",this.scrollerStyle.top=t+"px"),this.x=e,this.y=t,this.indicators)for(var i=this.indicators.length;i--;)this.indicators[i].updatePosition()},_initEvents:function(e){var t=e?m.removeEvent:m.addEvent,i=this.options.bindToWrapper?this.wrapper:a;t(a,"orientationchange",this),t(a,"resize",this),this.options.click&&t(this.wrapper,"click",this,!0),this.options.disableMouse||(t(this.wrapper,"mousedown",this),t(i,"mousemove",this),t(i,"mousecancel",this),t(i,"mouseup",this)),m.hasPointer&&!this.options.disablePointer&&(t(this.wrapper,m.prefixPointerEvent("pointerdown"),this),t(i,m.prefixPointerEvent("pointermove"),this),t(i,m.prefixPointerEvent("pointercancel"),this),t(i,m.prefixPointerEvent("pointerup"),this)),m.hasTouch&&!this.options.disableTouch&&(t(this.wrapper,"touchstart",this),t(i,"touchmove",this),t(i,"touchcancel",this),t(i,"touchend",this)),t(this.scroller,"transitionend",this),t(this.scroller,"webkitTransitionEnd",this),t(this.scroller,"oTransitionEnd",this),t(this.scroller,"MSTransitionEnd",this)},getComputedPosition:function(){var e,t,i=a.getComputedStyle(this.scroller,null);return t=this.options.useTransform?(e=+((i=i[m.style.transform].split(")")[0].split(", "))[12]||i[4]),+(i[13]||i[5])):(e=+i.left.replace(/[^-\d.]/g,""),+i.top.replace(/[^-\d.]/g,"")),{x:e,y:t}},_initIndicators:function(){var e,t=this.options.interactiveScrollbars,i="string"!=typeof this.options.scrollbars,s=[],n=this;this.indicators=[],this.options.scrollbars&&(this.options.scrollY&&(e={el:o("v",t,this.options.scrollbars),interactive:t,defaultScrollbars:!0,customStyle:i,resize:this.options.resizeScrollbars,shrink:this.options.shrinkScrollbars,fade:this.options.fadeScrollbars,listenX:!1},this.wrapper.appendChild(e.el),s.push(e)),this.options.scrollX&&(e={el:o("h",t,this.options.scrollbars),interactive:t,defaultScrollbars:!0,customStyle:i,resize:this.options.resizeScrollbars,shrink:this.options.shrinkScrollbars,fade:this.options.fadeScrollbars,listenY:!1},this.wrapper.appendChild(e.el),s.push(e))),this.options.indicators&&(s=s.concat(this.options.indicators));for(var a=s.length;a--;)this.indicators.push(new h(this,s[a]));function r(e){if(n.indicators)for(var t=n.indicators.length;t--;)e.call(n.indicators[t])}this.options.fadeScrollbars&&(this.on("scrollEnd",function(){r(function(){this.fade()})}),this.on("scrollCancel",function(){r(function(){this.fade()})}),this.on("scrollStart",function(){r(function(){this.fade(1)})}),this.on("beforeScrollStart",function(){r(function(){this.fade(1,!0)})})),this.on("refresh",function(){r(function(){this.refresh()})}),this.on("destroy",function(){r(function(){this.destroy()}),delete this.indicators})},_initWheel:function(){m.addEvent(this.wrapper,"wheel",this),m.addEvent(this.wrapper,"mousewheel",this),m.addEvent(this.wrapper,"DOMMouseScroll",this),this.on("destroy",function(){clearTimeout(this.wheelTimeout),this.wheelTimeout=null,m.removeEvent(this.wrapper,"wheel",this),m.removeEvent(this.wrapper,"mousewheel",this),m.removeEvent(this.wrapper,"DOMMouseScroll",this)})},_wheel:function(e){if(this.enabled){e.preventDefault();var t,i,s,n,a=this;if(void 0===this.wheelTimeout&&a._execEvent("scrollStart"),clearTimeout(this.wheelTimeout),this.wheelTimeout=setTimeout(function(){a.options.snap||a._execEvent("scrollEnd"),a.wheelTimeout=void 0},400),"deltaX"in e)i=1===e.deltaMode?(t=-e.deltaX*this.options.mouseWheelSpeed,-e.deltaY*this.options.mouseWheelSpeed):(t=-e.deltaX,-e.deltaY);else if("wheelDeltaX"in e)t=e.wheelDeltaX/120*this.options.mouseWheelSpeed,i=e.wheelDeltaY/120*this.options.mouseWheelSpeed;else if("wheelDelta"in e)t=i=e.wheelDelta/120*this.options.mouseWheelSpeed;else{if(!("detail"in e))return;t=i=-e.detail/3*this.options.mouseWheelSpeed}if(t*=this.options.invertWheelDirection,i*=this.options.invertWheelDirection,this.hasVerticalScroll||(t=i,i=0),this.options.snap)return s=this.currentPage.pageX,n=this.currentPage.pageY,0<t?s--:t<0&&s++,0<i?n--:i<0&&n++,void this.goToPage(s,n);s=this.x+u.round(this.hasHorizontalScroll?t:0),n=this.y+u.round(this.hasVerticalScroll?i:0),this.directionX=0<t?-1:t<0?1:0,this.directionY=0<i?-1:i<0?1:0,0<s?s=0:s<this.maxScrollX&&(s=this.maxScrollX),0<n?n=0:n<this.maxScrollY&&(n=this.maxScrollY),this.scrollTo(s,n,0)}},_initSnap:function(){this.currentPage={},"string"==typeof this.options.snap&&(this.options.snap=this.scroller.querySelectorAll(this.options.snap)),this.on("refresh",function(){var e,t,i,s,n,a,r,o=0,h=0,l=0,c=this.options.snapStepX||this.wrapperWidth,d=this.options.snapStepY||this.wrapperHeight;if(this.pages=[],this.wrapperWidth&&this.wrapperHeight&&this.scrollerWidth&&this.scrollerHeight){if(!0===this.options.snap)for(i=u.round(c/2),s=u.round(d/2);l>-this.scrollerWidth;){for(this.pages[o]=[],n=e=0;n>-this.scrollerHeight;)this.pages[o][e]={x:u.max(l,this.maxScrollX),y:u.max(n,this.maxScrollY),width:c,height:d,cx:l-i,cy:n-s},n-=d,e++;l-=c,o++}else for(e=(a=this.options.snap).length,t=-1;o<e;o++)r=m.getRect(a[o]),(0===o||r.left<=m.getRect(a[o-1]).left)&&(h=0,t++),this.pages[h]||(this.pages[h]=[]),l=u.max(-r.left,this.maxScrollX),n=u.max(-r.top,this.maxScrollY),i=l-u.round(r.width/2),s=n-u.round(r.height/2),this.pages[h][t]={x:l,y:n,width:r.width,height:r.height,cx:i,cy:s},l>this.maxScrollX&&h++;this.goToPage(this.currentPage.pageX||0,this.currentPage.pageY||0,0),this.options.snapThreshold%1==0?(this.snapThresholdX=this.options.snapThreshold,this.snapThresholdY=this.options.snapThreshold):(this.snapThresholdX=u.round(this.pages[this.currentPage.pageX][this.currentPage.pageY].width*this.options.snapThreshold),this.snapThresholdY=u.round(this.pages[this.currentPage.pageX][this.currentPage.pageY].height*this.options.snapThreshold))}}),this.on("flick",function(){var e=this.options.snapSpeed||u.max(u.max(u.min(u.abs(this.x-this.startX),1e3),u.min(u.abs(this.y-this.startY),1e3)),300);this.goToPage(this.currentPage.pageX+this.directionX,this.currentPage.pageY+this.directionY,e)})},_nearestSnap:function(e,t){if(!this.pages.length)return{x:0,y:0,pageX:0,pageY:0};var i=0,s=this.pages.length,n=0;if(u.abs(e-this.absStartX)<this.snapThresholdX&&u.abs(t-this.absStartY)<this.snapThresholdY)return this.currentPage;for(0<e?e=0:e<this.maxScrollX&&(e=this.maxScrollX),0<t?t=0:t<this.maxScrollY&&(t=this.maxScrollY);i<s;i++)if(e>=this.pages[i][0].cx){e=this.pages[i][0].x;break}for(s=this.pages[i].length;n<s;n++)if(t>=this.pages[0][n].cy){t=this.pages[0][n].y;break}return i==this.currentPage.pageX&&((i+=this.directionX)<0?i=0:i>=this.pages.length&&(i=this.pages.length-1),e=this.pages[i][0].x),n==this.currentPage.pageY&&((n+=this.directionY)<0?n=0:n>=this.pages[0].length&&(n=this.pages[0].length-1),t=this.pages[0][n].y),{x:e,y:t,pageX:i,pageY:n}},goToPage:function(e,t,i,s){s=s||this.options.bounceEasing,e>=this.pages.length?e=this.pages.length-1:e<0&&(e=0),t>=this.pages[e].length?t=this.pages[e].length-1:t<0&&(t=0);var n=this.pages[e][t].x,a=this.pages[e][t].y;i=void 0===i?this.options.snapSpeed||u.max(u.max(u.min(u.abs(n-this.x),1e3),u.min(u.abs(a-this.y),1e3)),300):i,this.currentPage={x:n,y:a,pageX:e,pageY:t},this.scrollTo(n,a,i,s)},next:function(e,t){var i=this.currentPage.pageX,s=this.currentPage.pageY;++i>=this.pages.length&&this.hasVerticalScroll&&(i=0,s++),this.goToPage(i,s,e,t)},prev:function(e,t){var i=this.currentPage.pageX,s=this.currentPage.pageY;--i<0&&this.hasVerticalScroll&&(i=0,s--),this.goToPage(i,s,e,t)},_initKeys:function(e){var t,i={pageUp:33,pageDown:34,end:35,home:36,left:37,up:38,right:39,down:40};if("object"==typeof this.options.keyBindings)for(t in this.options.keyBindings)"string"==typeof this.options.keyBindings[t]&&(this.options.keyBindings[t]=this.options.keyBindings[t].toUpperCase().charCodeAt(0));else this.options.keyBindings={};for(t in i)this.options.keyBindings[t]=this.options.keyBindings[t]||i[t];m.addEvent(a,"keydown",this),this.on("destroy",function(){m.removeEvent(a,"keydown",this)})},_key:function(e){if(this.enabled){var t,i=this.options.snap,s=i?this.currentPage.pageX:this.x,n=i?this.currentPage.pageY:this.y,a=m.getTime(),r=this.keyTime||0;switch(this.options.useTransition&&this.isInTransition&&(t=this.getComputedPosition(),this._translate(u.round(t.x),u.round(t.y)),this.isInTransition=!1),this.keyAcceleration=a-r<200?u.min(this.keyAcceleration+.25,50):0,e.keyCode){case this.options.keyBindings.pageUp:this.hasHorizontalScroll&&!this.hasVerticalScroll?s+=i?1:this.wrapperWidth:n+=i?1:this.wrapperHeight;break;case this.options.keyBindings.pageDown:this.hasHorizontalScroll&&!this.hasVerticalScroll?s-=i?1:this.wrapperWidth:n-=i?1:this.wrapperHeight;break;case this.options.keyBindings.end:s=i?this.pages.length-1:this.maxScrollX,n=i?this.pages[0].length-1:this.maxScrollY;break;case this.options.keyBindings.home:n=s=0;break;case this.options.keyBindings.left:s+=i?-1:5+this.keyAcceleration>>0;break;case this.options.keyBindings.up:n+=i?1:5+this.keyAcceleration>>0;break;case this.options.keyBindings.right:s-=i?-1:5+this.keyAcceleration>>0;break;case this.options.keyBindings.down:n-=i?1:5+this.keyAcceleration>>0;break;default:return}i?this.goToPage(s,n):(0<s?(s=0,this.keyAcceleration=0):s<this.maxScrollX&&(s=this.maxScrollX,this.keyAcceleration=0),0<n?(n=0,this.keyAcceleration=0):n<this.maxScrollY&&(n=this.maxScrollY,this.keyAcceleration=0),this.scrollTo(s,n,0),this.keyTime=a)}},_animate:function(a,r,o,h){var l=this,c=this.x,d=this.y,u=m.getTime(),p=u+o;this.isAnimating=!0,function e(){var t,i,s,n=m.getTime();if(p<=n)return l.isAnimating=!1,l._translate(a,r),void(l.resetPosition(l.options.bounceTime)||l._execEvent("scrollEnd"));s=h(n=(n-u)/o),t=(a-c)*s+c,i=(r-d)*s+d,l._translate(t,i),l.isAnimating&&f(e)}()},handleEvent:function(e){switch(e.type){case"touchstart":case"pointerdown":case"MSPointerDown":case"mousedown":this._start(e);break;case"touchmove":case"pointermove":case"MSPointerMove":case"mousemove":this._move(e);break;case"touchend":case"pointerup":case"MSPointerUp":case"mouseup":case"touchcancel":case"pointercancel":case"MSPointerCancel":case"mousecancel":this._end(e);break;case"orientationchange":case"resize":this._resize();break;case"transitionend":case"webkitTransitionEnd":case"oTransitionEnd":case"MSTransitionEnd":this._transitionEnd(e);break;case"wheel":case"DOMMouseScroll":case"mousewheel":this._wheel(e);break;case"keydown":this._key(e);break;case"click":this.enabled&&!e._constructed&&(e.preventDefault(),e.stopPropagation())}}},h.prototype={handleEvent:function(e){switch(e.type){case"touchstart":case"pointerdown":case"MSPointerDown":case"mousedown":this._start(e);break;case"touchmove":case"pointermove":case"MSPointerMove":case"mousemove":this._move(e);break;case"touchend":case"pointerup":case"MSPointerUp":case"mouseup":case"touchcancel":case"pointercancel":case"MSPointerCancel":case"mousecancel":this._end(e)}},destroy:function(){this.options.fadeScrollbars&&(clearTimeout(this.fadeTimeout),this.fadeTimeout=null),this.options.interactive&&(m.removeEvent(this.indicator,"touchstart",this),m.removeEvent(this.indicator,m.prefixPointerEvent("pointerdown"),this),m.removeEvent(this.indicator,"mousedown",this),m.removeEvent(a,"touchmove",this),m.removeEvent(a,m.prefixPointerEvent("pointermove"),this),m.removeEvent(a,"mousemove",this),m.removeEvent(a,"touchend",this),m.removeEvent(a,m.prefixPointerEvent("pointerup"),this),m.removeEvent(a,"mouseup",this)),this.options.defaultScrollbars&&this.wrapper.parentNode&&this.wrapper.parentNode.removeChild(this.wrapper)},_start:function(e){var t=e.touches?e.touches[0]:e;e.preventDefault(),e.stopPropagation(),this.transitionTime(),this.initiated=!0,this.moved=!1,this.lastPointX=t.pageX,this.lastPointY=t.pageY,this.startTime=m.getTime(),this.options.disableTouch||m.addEvent(a,"touchmove",this),this.options.disablePointer||m.addEvent(a,m.prefixPointerEvent("pointermove"),this),this.options.disableMouse||m.addEvent(a,"mousemove",this),this.scroller._execEvent("beforeScrollStart")},_move:function(e){var t,i,s,n,a=e.touches?e.touches[0]:e;m.getTime(),this.moved||this.scroller._execEvent("scrollStart"),this.moved=!0,t=a.pageX-this.lastPointX,this.lastPointX=a.pageX,i=a.pageY-this.lastPointY,this.lastPointY=a.pageY,s=this.x+t,n=this.y+i,this._pos(s,n),e.preventDefault(),e.stopPropagation()},_end:function(e){if(this.initiated){if(this.initiated=!1,e.preventDefault(),e.stopPropagation(),m.removeEvent(a,"touchmove",this),m.removeEvent(a,m.prefixPointerEvent("pointermove"),this),m.removeEvent(a,"mousemove",this),this.scroller.options.snap){var t=this.scroller._nearestSnap(this.scroller.x,this.scroller.y),i=this.options.snapSpeed||u.max(u.max(u.min(u.abs(this.scroller.x-t.x),1e3),u.min(u.abs(this.scroller.y-t.y),1e3)),300);this.scroller.x==t.x&&this.scroller.y==t.y||(this.scroller.directionX=0,this.scroller.directionY=0,this.scroller.currentPage=t,this.scroller.scrollTo(t.x,t.y,i,this.scroller.options.bounceEasing))}this.moved&&this.scroller._execEvent("scrollEnd")}},transitionTime:function(e){e=e||0;var t=m.style.transitionDuration;if(t&&(this.indicatorStyle[t]=e+"ms",!e&&m.isBadAndroid)){this.indicatorStyle[t]="0.0001ms";var i=this;f(function(){"0.0001ms"===i.indicatorStyle[t]&&(i.indicatorStyle[t]="0s")})}},transitionTimingFunction:function(e){this.indicatorStyle[m.style.transitionTimingFunction]=e},refresh:function(){this.transitionTime(),this.options.listenX&&!this.options.listenY?this.indicatorStyle.display=this.scroller.hasHorizontalScroll?"block":"none":this.options.listenY&&!this.options.listenX?this.indicatorStyle.display=this.scroller.hasVerticalScroll?"block":"none":this.indicatorStyle.display=this.scroller.hasHorizontalScroll||this.scroller.hasVerticalScroll?"block":"none",this.scroller.hasHorizontalScroll&&this.scroller.hasVerticalScroll?(m.addClass(this.wrapper,"iScrollBothScrollbars"),m.removeClass(this.wrapper,"iScrollLoneScrollbar"),this.options.defaultScrollbars&&this.options.customStyle&&(this.options.listenX?this.wrapper.style.right="8px":this.wrapper.style.bottom="8px")):(m.removeClass(this.wrapper,"iScrollBothScrollbars"),m.addClass(this.wrapper,"iScrollLoneScrollbar"),this.options.defaultScrollbars&&this.options.customStyle&&(this.options.listenX?this.wrapper.style.right="2px":this.wrapper.style.bottom="2px")),m.getRect(this.wrapper),this.options.listenX&&(this.wrapperWidth=this.wrapper.clientWidth,this.options.resize?(this.indicatorWidth=u.max(u.round(this.wrapperWidth*this.wrapperWidth/(this.scroller.scrollerWidth||this.wrapperWidth||1)),8),this.indicatorStyle.width=this.indicatorWidth+"px"):this.indicatorWidth=this.indicator.clientWidth,this.maxPosX=this.wrapperWidth-this.indicatorWidth,"clip"==this.options.shrink?(this.minBoundaryX=8-this.indicatorWidth,this.maxBoundaryX=this.wrapperWidth-8):(this.minBoundaryX=0,this.maxBoundaryX=this.maxPosX),this.sizeRatioX=this.options.speedRatioX||this.scroller.maxScrollX&&this.maxPosX/this.scroller.maxScrollX),this.options.listenY&&(this.wrapperHeight=this.wrapper.clientHeight,this.options.resize?(this.indicatorHeight=u.max(u.round(this.wrapperHeight*this.wrapperHeight/(this.scroller.scrollerHeight||this.wrapperHeight||1)),8),this.indicatorStyle.height=this.indicatorHeight+"px"):this.indicatorHeight=this.indicator.clientHeight,this.maxPosY=this.wrapperHeight-this.indicatorHeight,"clip"==this.options.shrink?(this.minBoundaryY=8-this.indicatorHeight,this.maxBoundaryY=this.wrapperHeight-8):(this.minBoundaryY=0,this.maxBoundaryY=this.maxPosY),this.maxPosY=this.wrapperHeight-this.indicatorHeight,this.sizeRatioY=this.options.speedRatioY||this.scroller.maxScrollY&&this.maxPosY/this.scroller.maxScrollY),this.updatePosition()},updatePosition:function(){var e=this.options.listenX&&u.round(this.sizeRatioX*this.scroller.x)||0,t=this.options.listenY&&u.round(this.sizeRatioY*this.scroller.y)||0;this.options.ignoreBoundaries||(e<this.minBoundaryX?("scale"==this.options.shrink&&(this.width=u.max(this.indicatorWidth+e,8),this.indicatorStyle.width=this.width+"px"),e=this.minBoundaryX):e>this.maxBoundaryX?e="scale"==this.options.shrink?(this.width=u.max(this.indicatorWidth-(e-this.maxPosX),8),this.indicatorStyle.width=this.width+"px",this.maxPosX+this.indicatorWidth-this.width):this.maxBoundaryX:"scale"==this.options.shrink&&this.width!=this.indicatorWidth&&(this.width=this.indicatorWidth,this.indicatorStyle.width=this.width+"px"),t<this.minBoundaryY?("scale"==this.options.shrink&&(this.height=u.max(this.indicatorHeight+3*t,8),this.indicatorStyle.height=this.height+"px"),t=this.minBoundaryY):t>this.maxBoundaryY?t="scale"==this.options.shrink?(this.height=u.max(this.indicatorHeight-3*(t-this.maxPosY),8),this.indicatorStyle.height=this.height+"px",this.maxPosY+this.indicatorHeight-this.height):this.maxBoundaryY:"scale"==this.options.shrink&&this.height!=this.indicatorHeight&&(this.height=this.indicatorHeight,this.indicatorStyle.height=this.height+"px")),this.x=e,this.y=t,this.scroller.options.useTransform?this.indicatorStyle[m.style.transform]="translate("+e+"px,"+t+"px)"+this.scroller.translateZ:(this.indicatorStyle.left=e+"px",this.indicatorStyle.top=t+"px")},_pos:function(e,t){e<0?e=0:e>this.maxPosX&&(e=this.maxPosX),t<0?t=0:t>this.maxPosY&&(t=this.maxPosY),e=this.options.listenX?u.round(e/this.sizeRatioX):this.scroller.x,t=this.options.listenY?u.round(t/this.sizeRatioY):this.scroller.y,this.scroller.scrollTo(e,t)},fade:function(e,t){if(!t||this.visible){clearTimeout(this.fadeTimeout),this.fadeTimeout=null;var i=e?250:500,s=e?0:300;e=e?"1":"0",this.wrapperStyle[m.style.transitionDuration]=i+"ms",this.fadeTimeout=setTimeout(function(e){this.wrapperStyle.opacity=e,this.visible=+e}.bind(this,e),s)}}},e.utils=m,"undefined"!=typeof module&&module.exports?module.exports=e:"function"==typeof define&&define.amd?define(function(){return e}):a.IScroll=e}(window,document,Math);var cachedX,cachedY,pinchScale,panWheelX,panWheelY,currtentValue,Camera=pc.createScript("camera");Camera.attributes.add("maxElevationUp",{type:"number",default:-90}),Camera.attributes.add("maxElevationDown",{type:"number",default:0}),Camera.attributes.add("maxElevationLeft",{type:"number",default:-30}),Camera.attributes.add("maxElevationRight",{type:"number",default:30}),Camera.attributes.add("rotLerpSpeed",{type:"number",default:.3}),Camera.attributes.add("panLerpSpeed",{type:"number",default:.2}),Camera.attributes.add("zoomLerpSpeed",{type:"number",default:.2}),Camera.attributes.add("pinchSensitivity",{type:"number",default:.1}),Camera.attributes.add("yawSensitivity",{type:"number",default:.2}),Camera.attributes.add("minDistance",{type:"number",default:.5}),Camera.attributes.add("maxDistance",{type:"number",default:10}),Camera.attributes.add("handpickCenter",{type:"entity"}),Camera.attributes.add("YH",{type:"entity"}),Camera.attributes.add("LJD",{type:"entity"}),Camera.attributes.add("GH",{type:"entity"}),Camera.attributes.add("L",{type:"entity"}),Camera.attributes.add("GT",{type:"entity"}),Camera.attributes.add("WaiteNum",{type:"number",default:5}),Camera.attributes.add("autoSpeed",{type:"number",default:30}),Camera.attributes.add("clampRotY",{type:"boolean",default:!1});var angle_maxUp,angle_maxDown,distance_max,distance_min,bl_AutoRotate=!1,fl_time=0,blCanControl=!0,startY=0;Object.assign(pc.events,{_callbacks:{},_callbackActive:{}}),Camera.prototype.swap=function(e){},Camera.extend({initialize:function(){angle_maxUp=this.maxElevationUp,angle_maxDown=this.maxElevationDown,distance_max=this.maxDistance,distance_min=this.minDistance,pc.events.on("StepChange",this.onStepChange,this),(window.camera=this).viewPos=new pc.Vec3,this.targetViewPos=new pc.Vec3,this.viewPosOffset=new pc.Vec3,this.targetViewPosOffset=new pc.Vec3,this.distance=3,this.targetDistance=3,this.rotX=-7.6,this.rotY=0,this.targetRotX=-7.6,this.targetRotY=0,this.quatA=new pc.Quat,this.quatB=new pc.Quat,this.transformStarted=!1,this.panX=0,this.panY=1.64,this.targetPanX=0,this.targetPanY=1.64,this.zoomLocked=!0,this.rotLocked=!0,this.panLocked=!0,this.lockX=!1,this.lockY=!1,this.runEnable=!0,this.operating=!1,this.step_Rotate=!1,this.app.mouse.disableContextMenu(),this.setBestCameraPositionForModel(),this.camAnchor=this.entity.getParent().findByName("CamAnchor"),this.hammer=new Hammer(this.app.graphicsDevice.canvas),this.hammer.add(new Hammer.Pan({event:"pan2",pointers:2,threshold:35})),this.hammer.get("pinch").set({threshold:0}).recognizeWith([this.hammer.get("pan2")]),this.hammer.get("pan").set({threshold:0}),this.hammer.on("pan2start",function(e){panWheelX=e.center.x,panWheelY=e.center.y}.bind(this)),this.hammer.on("pan2move",function(e){var t=this.distance/500,i=e.center.x-panWheelX,s=e.center.y-panWheelY;this.pan(i*-t,s*t),panWheelX=e.center.x,panWheelY=e.center.y}.bind(this)),pc.events.on("StepChange",function(){this.targetViewPos.copy(this.handpickCenter.getPosition()),document.getElementById("ID_imagehow").style.opacity=0}.bind(this)),pc.events.on("PointChange",function(e){this.targetViewPos.copy(this.handpickCenter.getPosition()),1===floor_point&&this.targetViewPos.copy(this.YH.getPosition()),2===floor_point&&this.targetViewPos.copy(this.LJD.getPosition()),3===floor_point&&this.targetViewPos.copy(this.GH.getPosition()),4===floor_point&&this.targetViewPos.copy(this.L.getPosition()),5===floor_point&&this.targetViewPos.copy(this.GT.getPosition())}.bind(this)),this.hammer.on("panstart",function(e){if(cachedX=e.center.x,cachedY=e.center.y,!this.transformStarted){var t=e.srcEvent,i=void 0!==t.touches?t.touches.length:1;this.panning=2===i,this.dragStarted=!0,document.getElementById("ID_imagehow").style.opacity=0}}.bind(this)),this.hammer.on("panmove",function(e){var t=e.center.y-cachedY,i=e.center.x-cachedX;this.orbit(t*-this.yawSensitivity,i*-this.yawSensitivity),blCanControl?startY=0:startY+=i/2,cachedX=e.center.x,cachedY=e.center.y}.bind(this)),this.hammer.on("panend",function(e){this.dragStarted&&(this.dragStarted=!1,this.panning=!1)}.bind(this)),this.hammer.get("pinch").set({enable:!0}),this.hammer.on("pinchstart ",function(e){pinchScale=e.scale}.bind(this)),this.hammer.on("pinchend",function(e){}.bind(this)),this.hammer.on("pinchmove",function(e){var t=e.scale-pinchScale;this.dolly(t*-this.pinchSensitivity*15),pinchScale=e.scale}.bind(this)),this.app.mouse.on(pc.input.EVENT_MOUSEMOVE,this.onMouseMove,this),this.app.mouse.on(pc.input.EVENT_MOUSEWHEEL,this.onMouseWheel,this),this.entity.camera.clearColor.set(1,1,1,1)},setBestCameraPositionForModel:function(){this.app.scene.getModels();var e=this.handpickCenter.getPosition();this.reset(e,50)},reset:function(e,t){this.viewPos.copy(e),this.targetViewPos.copy(e),this.distance=t,this.targetDistance=t},rotateByDegree:function(e,t){this.targetRotY=e.y,this.targetRotY=this.calShortRotate(e.y,this.rotY),this.targetRotX=e.x,this.targetDistance=t},calShortRotate:function(e,t){return t<0||360<t?t-t%360+e:e},pan:function(e,t){blCanControl&&(this.panLocked||(fl_time=0,this.targetPanX+=e,this.targetPanY+=t),this.operating=!0)},translateCam:function(e,t){this.targetPanX=e,this.targetPanY=t},dolly:function(e){blCanControl&&(this.zoomLocked||(fl_time=0,this.targetDistance+=e,this.targetDistance<this.minDistance?this.targetDistance=this.minDistance:this.targetDistance>this.maxDistance&&(this.targetDistance=this.maxDistance)),this.operating=!0)},orbit:function(e,t){if(blCanControl){if(!this.rotLocked){if(fl_time=0,!this.lockY){this.targetRotY=this.targetRotY+t;var i=parseInt(this.targetRotY/360);this.clampRotY&&(this.targetRotY=pc.math.clamp(this.targetRotY,360*i+this.maxElevationLeft,360*i+this.maxElevationRight))}this.lockX||(this.targetRotX+=e,this.targetRotX=pc.math.clamp(this.targetRotX,this.maxElevationUp,this.maxElevationDown))}this.operating=!0}},onMouseWheel:function(e){blCanControl&&this.dolly(e.wheel*-this.pinchSensitivity)},onMouseMove:function(e){if(blCanControl&&e.buttons[pc.input.MOUSEBUTTON_RIGHT]){var t=this.distance/500;this.pan(e.dx*-t,e.dy*t)}},clampAngle:function(e){return e<-360&&(e+=360),360<e&&(e-=360),e},getCamYawAngle:function(){return this.rotY%360<0?360+this.rotY%360:this.rotY%360},update:function(e){this.viewPos.lerp(this.viewPos,this.targetViewPos,e/.1),this.distance=pc.math.lerp(this.distance,this.targetDistance,e/this.zoomLerpSpeed),this.rotX=pc.math.lerp(this.rotX,this.targetRotX,e/this.rotLerpSpeed),this.rotY=pc.math.lerpAngle(this.rotY,this.targetRotY,e/this.rotLerpSpeed),this.panX=pc.math.lerp(this.panX,this.targetPanX,e/this.panLerpSpeed),this.panY=pc.math.lerp(this.panY,this.targetPanY,e/this.panLerpSpeed),this.camAnchor.setEulerAngles(this.rotX,this.rotY,0),this.camAnchor.setPosition(this.viewPos),this.camAnchor.translateLocal(0,0,this.distance),this.entity.camera.orthoHeight=.4*this.distance,this.entity.setPosition(this.camAnchor.getPosition()),this.entity.setRotation(this.camAnchor.getRotation()),this.entity.translateLocal(this.panX,this.panY,0),(bl_AutoRotate=fl_time>this.WaiteNum||(fl_time+=e,!1))&&this.step_Rotate&&(this.targetRotY+=e*this.autoSpeed)},onStepChange:function(e){fl_time=0,bl_AutoRotate=!1},lock:function(e,t,i){this.rotLocked=e,this.zoomLocked=t,this.panLocked=i},setTargetPos:function(e){this.rotX=this.targetRotX=e.rotX,this.rotY=this.targetRotY=e.rotY,this.panX=this.targetPanX=e.panX,this.panY=this.targetPanY=e.panY,this.distance=this.targetDistance=e.dist,this.camAnchor.setEulerAngles(this.rotX,this.rotY,0),this.camAnchor.setPosition(this.viewPos),this.camAnchor.translateLocal(0,0,this.distance),this.entity.setPosition(this.camAnchor.getPosition()),this.entity.setRotation(this.camAnchor.getRotation()),this.entity.translateLocal(this.panX,this.panY,0)},getTargetPos:function(){return{rotX:this.targetRotX,rotY:this.targetRotY,panX:this.targetPanX,panY:this.targetPanY,dist:this.targetDistance}},print:function(){},print2:function(){var e=this.entity.getPosition(),t=this.entity.getEulerAngles(),i=this.entity.forward;this.targetViewPos.x,this.targetViewPos.y,this.targetViewPos.z,e.x,e.y,e.z,t.x,t.y,t.z,i.x,i.y,i.z,this.targetPanX,this.targetPanY}});var CameraHandle=pc.createScript("cameraHandle");CameraHandle.attributes.add("StepData",{type:"asset"}),CameraHandle.camScript,CameraHandle.prototype.initialize=function(){CameraHandle.camScript=this.entity.script.camera,pc.events.on("StepChange",this.onStepChange,this),this.stepData=this.StepData.resources},CameraHandle.prototype.onStepChange=function(e){var t=new pc.Vec2(this.stepData[e].rotX,this.stepData[e].rotY),i=this.stepData[e].dist,s=this.stepData[e].panX,n=this.stepData[e].panY;CameraHandle.camScript.translateCam(s,n),CameraHandle.camScript.rotateByDegree(t,i),CameraHandle.camScript.rotLocked=this.stepData[e].lockRot,CameraHandle.camScript.zoomLocked=this.stepData[e].lockZoom,CameraHandle.camScript.panLocked=this.stepData[e].lockPan,CameraHandle.camScript.rotXLocked=this.stepData[e].lockRotX,CameraHandle.camScript.rotYLocked=this.stepData[e].lockRotY,CameraHandle.camScript.lockX=this.stepData[e].lockX,CameraHandle.camScript.lockY=this.stepData[e].lockY,CameraHandle.camScript.step_Rotate=this.stepData[e].autoRotate,null!==this.stepData[e].maxup?CameraHandle.camScript.maxElevationUp=this.stepData[e].maxup:CameraHandle.camScript.maxElevationUp=angle_maxUp,null!==this.stepData[e].maxdown?CameraHandle.camScript.maxElevationDown=this.stepData[e].maxdown:CameraHandle.camScript.maxElevationDown=angle_maxDown},CameraHandle.prototype.swap=function(e){};var EvtAnimation=pc.createScript("evtAnimation"),callbackOffset=0;EvtAnimation.prototype.initialize=function(){},EvtAnimation.prototype.playAnimation=function(e,t,i,s,n,a){if(null!==i&&null!==e&&null!==t){var r=e.animation;r.loop=n,r.speed=s,this._play(r,t.name,a)}},EvtAnimation.prototype._play=function(e,t,i){e.duration&&e.currentTime===e.duration&&(e.currentTime-=1e-6),e._isPlayed&&e.currentClip==t?e.playing=!0:(e.play(t),e._isPlayed=!0),e.currentClip=t,clearTimeout(e.callback),e.callback=setTimeout(i,e.duration/e.speed*1e3)},EvtAnimation.prototype.update=function(e){};var UieventControl=pc.createScript("uieventControl");UieventControl.attributes.add("TotalStep",{type:"number"});var total_number,div,mScroll,timepoint,timelineg,current_number=0;UieventControl.attributes.add("MT_TouMing",{type:"asset"}),UieventControl.attributes.add("Hidel",{type:"entity"});var str_index="msg_1",canclick=!1,isWeChart=!1,floor_point=0;UieventControl.prototype.initialize=function(){var e=document.createElement("script");e.src="https://res.wx.qq.com/open/js/jweixin-1.3.2.js",document.body.appendChild(e),e.addEventListener("load",function(){wx.miniProgram.getEnv(function(e){isWeChart=e.miniprogram})}),$("#rightBtn").on("click",this.changeStep),$("#leftBtn").on("click",this.changeStep),$("#btnlink").on("click",this.BtnLink),$(".btnAudio").on("click",this.BtnPlay),$("#stp4_YH").on("click",function(){pc.events.fire("PointChange",1)}),$("#stp4_LJD").on("click",function(){pc.events.fire("PointChange",2)}),$("#stp4_GH").on("click",function(){pc.events.fire("PointChange",3)}),$("#stp4_L").on("click",function(){pc.events.fire("PointChange",4)}),$("#stp4_GT").on("click",function(){pc.events.fire("PointChange",5)}),total_number=this.TotalStep-1,this.bl_First=!0,this.Cover=!1,pc.events.on("StepChange",this.OnStepChange,this),pc.events.on("PointChange",this.Fen,this),document.getElementById("timeline").style.width=document.body.offsetWidth+"px",(div=this).stp1=document.getElementsByClassName("step1title")[0].style,div.timelinegold=document.getElementsByClassName("timelinegold")[0].style,div.timepoint=document.getElementsByClassName("timepoint")[0].style,div.timeyear=document.getElementsByClassName("timeyear")[0].style,div.timenum=document.getElementsByClassName("timenum")[0].style,div.timepoint2=document.getElementsByClassName("timepoint2")[0].style,div.timeyear2=document.getElementsByClassName("timeyear2")[0].style,div.timenum2=document.getElementsByClassName("timenum2")[0].style,div.how=document.getElementsByClassName("imagehow")[0].style,div.title=document.getElementsByClassName("stptitle"),div.stp2bg1=document.getElementsByClassName("stp2bg1")[0].style,div.stp2bg2=document.getElementsByClassName("stp2bg2")[0].style,div.stp2icon=document.getElementsByClassName("stp2icon")[0].style,div.stp3material=document.getElementsByClassName("stp3material")[0].style,div.stp3msg=document.getElementsByClassName("stp3msg")[0].style,div.stp5link=document.getElementById("btnlink").style,div.stp5msg=document.getElementsByClassName("stp5msg")[0].style,div.timelinegold.overflow="hidden",mScroll=new IScroll("#wrapper1",{scrollY:!0,freeScroll:!0,scrollbars:!0,bounce:!1}),div.stp2bg2.display="none"},UieventControl.prototype.BtnPlay=function(e){"isplay"===e.currentTarget.id?(pc.events.fire("audio:pause",e),document.getElementById("isplay").style.display="none",document.getElementById("noplay").style.display="block"):(pc.events.fire("audio:play",e),document.getElementById("isplay").style.display="block",document.getElementById("noplay").style.display="none")},UieventControl.prototype.BtnLink=function(){pc.events.fire("replace:share")},UieventControl.prototype.update=function(e){this.Cover?(this.MT_TouMing.resource.opacity-=.015,this.MT_TouMing.resource.update()):canclick&&(this.Hidel.enabled=!1)},UieventControl.prototype.OnStepChange=function(e){if(!(total_number<e)){clearTimeout(timelineg),clearTimeout(timepoint);for(var t=0;t<div.title.length;t++)div.title[t].style.opacity=e-1===t?1:0;switch(1!==e?(div.stp2bg1.opacity=0,div.stp2bg2.display="none",div.stp2icon.opacity=0):(div.stp2bg1.opacity=1,div.stp2bg2.display="block",div.stp2icon.opacity=1),2!==e?(div.stp3material.opacity=0,div.stp3msg.opacity=0):(div.stp3material.opacity=1,div.stp3msg.opacity=1),3!==e?this.Step4(0):this.Step4(1),4!==e?(div.stp5msg.opacity=0,div.stp5link.display="none"):(div.stp5msg.opacity=1,div.stp5link.display="block"),e){case 0:this.bl_First?(this.bl_First=!1,timelineg=setTimeout(function(){div.timelinegold.width="100%",div.timepoint.transform="scale(1)",div.timeyear.opacity=1,div.timenum.opacity=1,div.timepoint2.transform="scale(1)",div.timeyear2.opacity=1,div.timenum2.opacity=1,div.how.opacity=1,this.Cover=!0}.bind(this),100),timepoint=setTimeout(function(){div.timelinegold.overflow="unset",canclick=!0,this.Cover=!1}.bind(this),2200)):(div.how.opacity=0,div.stp1.opacity=1,clearTimeout(timelineg),clearTimeout(timepoint),div.timelinegold.transition="all 0.3s",div.timepoint.transition="all 0.3s",div.timeyear.transition="all 0.3s",div.timenum.transition="all 0.3s",div.timepoint2.transition="all 0.3s",div.timeyear2.transition="all 0.3s",div.timenum2.transition="all 0.3s",div.timeyear.opacity=1,div.timenum.opacity=1,div.timepoint.transform="scale(1)",div.timeyear2.opacity=1,div.timenum2.opacity=1,div.timepoint2.transform="scale(1)",div.timelinegold.width="100%",div.timelinegold.opacity=1);break;case 1:mScroll.refresh(),div.timelinegold.opacity=0,div.stp1.opacity=0;break;case 2:this.Step4_Hide(),div.timelinegold.opacity=0,div.stp1.opacity=0;break;case 3:div.timelinegold.opacity=0,div.stp1.opacity=0;break;case 4:this.Step4_Hide(),div.timelinegold.opacity=0,div.stp1.opacity=0}}},UieventControl.prototype.changeStep=function(e){if(canclick){floor_point=0,"rightBtn"===e.currentTarget.id?current_number++:current_number--,total_number<current_number?current_number=0:current_number<0&&(current_number=total_number),document.getElementsByClassName("iconActive")[0].className="iconNormal";for(var t=0;t<document.getElementsByClassName("iconNormal").length;t++)t===current_number&&(document.getElementsByClassName("iconNormal")[current_number].className="iconActive");pc.events.fire("StepChange",current_number)}},UieventControl.prototype.Fen=function(e){this.Step4_Hide(),1===e&&(1==floor_point?(pc.events.fire("StepChange",3),floor_point=0):(pc.events.fire("StepChange",5),floor_point=1,document.getElementById("stp4_YH_On").style.opacity=1)),2===e&&(2==floor_point?(pc.events.fire("StepChange",3),floor_point=0):(pc.events.fire("StepChange",6),floor_point=2,document.getElementById("ID_stp4_Sq1").style.opacity=1,document.getElementById("stp4_LJD_On").style.opacity=1)),3===e&&(3==floor_point?(pc.events.fire("StepChange",3),floor_point=0):(pc.events.fire("StepChange",7),floor_point=3,document.getElementById("stp4_GH_On").style.opacity=1)),4===e&&(4==floor_point?(floor_point=0,pc.events.fire("StepChange",3)):(pc.events.fire("StepChange",8),floor_point=4,document.getElementById("stp4_L_On").style.opacity=1,document.getElementById("ID_stp4_Sq2").style.opacity=1)),5===e&&(5==floor_point?(floor_point=0,pc.events.fire("StepChange",3)):(pc.events.fire("StepChange",9),floor_point=5,document.getElementById("stp4_GT_On").style.opacity=1))},UieventControl.prototype.Step4_Hide=function(){document.getElementById("stp4_YH_On").style.opacity=0,document.getElementById("stp4_LJD_On").style.opacity=0,document.getElementById("stp4_GH_On").style.opacity=0,document.getElementById("stp4_L_On").style.opacity=0,document.getElementById("stp4_GT_On").style.opacity=0,document.getElementById("ID_stp4_Sq1").style.opacity=0,document.getElementById("ID_stp4_Sq2").style.opacity=0},UieventControl.prototype.Step4=function(e){0===e?(document.getElementById("stp4_YH").style.display="none",document.getElementById("stp4_LJD").style.display="none",document.getElementById("stp4_GH").style.display="none",document.getElementById("stp4_L").style.display="none",document.getElementById("stp4_GT").style.display="none"):(document.getElementById("stp4_YH").style.display="block",document.getElementById("stp4_LJD").style.display="block",document.getElementById("stp4_GH").style.display="block",document.getElementById("stp4_L").style.display="block",document.getElementById("stp4_GT").style.display="block"),document.getElementById("ID_stp4_TopWord").style.opacity=e,document.getElementById("stp4").style.opacity=e,document.getElementById("ID_stp4_BG_K2").style.opacity=e,document.getElementById("ID_stp4_BG_K").style.opacity=e};var Cam,ModEveCon=pc.createScript("modEveCon");ModEveCon.attributes.add("Box",{type:"entity"}),ModEveCon.attributes.add("Mt_WK",{type:"asset",array:!0}),ModEveCon.attributes.add("Ani_Box",{type:"asset"}),ModEveCon.attributes.add("Modle",{type:"entity"}),ModEveCon.attributes.add("Ani_Size",{type:"asset"}),ModEveCon.attributes.add("MT_Size",{type:"asset"}),ModEveCon.attributes.add("Sea",{type:"entity"}),ModEveCon.attributes.add("Ani_Sea",{type:"asset"});var IsSize_MT=!1;ModEveCon.prototype.initialize=function(){this.Sea.animation.currentTime=0,this.Sea.animation.speed=0,Cam=this.entity.findByName("Camera").script.camera,pc.events.on("StepChange",this.PageNum,this),timelineg=setTimeout(function(){this.entity.script.evtAnimation.playAnimation(this.Box,this.Ani_Box,!0,1,!1,function(){this.Box.enabled=!1,this.entity.script.evtAnimation.playAnimation(this.Sea,this.Ani_Sea,!0,-1,!1),pc.events.fire("StepChange",0)}.bind(this))}.bind(this),1200),timepoint=setTimeout(function(){}.bind(this),3200),this.mt_wk=new Array(2);for(var e=0;e<this.mt_wk.length;e++)this.mt_wk[e]=this.Mt_WK[e].resource;pc.events.on("PointChange",this.PointNum,this),this.IsMode=!1,this.Rot=0},ModEveCon.prototype.update=function(e){if(!canclick)for(var t=0;t<this.mt_wk.length;t++)this.mt_wk[t].opacity-=.01,this.mt_wk[t].update();this.IsMode&&this.Rot<=360&&(this.Modle.setEulerAngles(0,this.Rot,0),this.Rot+=110*e)},ModEveCon.prototype.PageNum=function(e){if(this.IsMode=!1,this.Modle.setEulerAngles(0,0,0),this.Rot=0,!(total_number<e)){if(0===e){if(!canclick)return;this.Sea.animation.currentTime=.9,this.Sea.animation.speed=0,this.entity.script.evtAnimation.playAnimation(this.Sea,this.Ani_Sea,!0,-1,!1)}1==e?(this.Rot=0,this.Sea.setLocalScale(.001,.001,.001),this.Modle.setLocalScale(.001,.001,.001)):(this.Sea.setLocalScale(1,1,1),this.Modle.setLocalScale(1,1,1)),2==e&&(this.Sea.animation.currentTime=0,this.Sea.animation.speed=0,canclick=!1,this.entity.script.evtAnimation.playAnimation(this.Sea,this.Ani_Sea,!0,1,!1,function(){this.IsMode=!0,canclick=!0}.bind(this))),3==e&&this.Sea.setLocalScale(.001,.001,.001),4==e&&(this.Sea.setLocalScale(1,1,1),this.Sea.animation.currentTime=.9,this.Sea.animation.speed=0)}},ModEveCon.prototype.PointNum=function(e){this.Sea.setLocalScale(.001,.001,.001)};var UiControl=pc.createScript("uiControl");UiControl.attributes.add("uiAssets",{type:"asset",array:!0}),UiControl.attributes.add("uiHtml",{type:"asset"}),UiControl.prototype.initialize=function(){document.body.addEventListener("touchmove",function(e){e.preventDefault()},{passive:!1}),$(document.body).append(this.editImgUrl(this.uiHtml.resource));for(var e=0;e<this.uiAssets.length;e++)this.createElement(this.uiAssets[e])},UiControl.prototype.createElement=function(e){switch(e.type){case"css":var t=document.createElement("style");t.innerHTML=this.editImgUrl(e.resource),document.head.appendChild(t);break;case"script":var i=document.createElement("script");t.src=e.getFileUrl(),document.body.appendChild(i)}},UiControl.prototype.editImgUrl=function(e){var t=e.match(/\$(\d){8}\%/g);if(null===t)return e;for(var i=0;i<t.length;i++){var s=t[i].substr(1,8),n=this.app.assets.get(s);if(null!=n){var a=n.getFileUrl();e=e.replace(t[i],a)}}return e};var MtUv=pc.createScript("mtUv"),canplay=!1,isWangLou=!1,isZiTie=!1;MtUv.attributes.add("MT_YuanHuan",{type:"asset"}),MtUv.attributes.add("MT_LianJieDai",{type:"asset"}),MtUv.attributes.add("MT_GouHuan",{type:"asset"}),MtUv.attributes.add("MT_Lian",{type:"asset"}),MtUv.attributes.add("MT_GouTou",{type:"asset"}),MtUv.attributes.add("MT_Effect1",{type:"asset"}),MtUv.prototype.initialize=function(){this.UVSpeed=.1,this.num=.1,this.GouTou=!1,this.GouHuan=!1,this.Lian=!1,this.LianJieDai=!1,this.YuanHuan=!1,pc.events.on("PointChange",this.PointNum,this),pc.events.on("StepChange",this.PageNum,this),this.mt1=this.MT_YuanHuan.resource,this.mt2=this.MT_LianJieDai.resource,this.mt3=this.MT_GouHuan.resource,this.mt4=this.MT_Lian.resource,this.mt5=this.MT_GouTou.resource,this.mt_1=this.MT_Effect1.resource},MtUv.prototype.update=function(e){this.UVSpeed+=e/25,this.UVSpeed=this.UVSpeed%1,this.mt_1.diffuseMapOffset.x=this.UVSpeed,this.mt_1.diffuseMapOffset.y=this.UVSpeed,this.mt_1.glossMapOffset.x=this.UVSpeed,this.mt_1.glossMapOffset.y=this.UVSpeed,this.mt_1.normalMapOffset.x=this.UVSpeed,this.mt_1.normalMapOffset.y=this.UVSpeed,this.mt_1.update(),this.YuanHuan&&(this.num-=e/2,this.num=this.num%1,this.mt1.opacityMapOffset.y=this.num,this.mt1.update()),this.LianJieDai&&(this.num-=e/2,this.num=this.num%1,this.mt2.opacityMapOffset.y=this.num,this.mt2.update()),this.GouHuan&&(this.num-=e/2,this.num=this.num%1,this.mt3.opacityMapOffset.y=this.num,this.mt3.update()),this.Lian&&(this.num-=e/2,this.num=this.num%1,this.mt4.opacityMapOffset.y=this.num,this.mt4.update()),this.GouTou&&(this.num-=e/4,this.num=this.num%1,this.mt5.opacityMapOffset.y=this.num,this.mt5.update())},MtUv.prototype.PageNum=function(e){this.PointNum(0)},MtUv.prototype.PointNum=function(e){this.Fun(),1===floor_point?(this.YuanHuan=!0,this.mt1.opacity=.8):this.mt1.opacity=0,this.mt1.update(),2===floor_point?(this.LianJieDai=!0,this.mt2.opacity=.8):this.mt2.opacity=0,this.mt2.update(),3===floor_point?(this.GouHuan=!0,this.mt3.opacity=.8):this.mt3.opacity=0,this.mt3.update(),4===floor_point?(this.Lian=!0,this.mt4.opacity=.8):this.mt4.opacity=0,this.mt4.update(),5===floor_point?(this.GouTou=!0,this.mt5.opacity=.8):this.mt5.opacity=0,this.mt5.update()},MtUv.prototype.Fun=function(){this.GouTou=!1,this.GouHuan=!1,this.Lian=!1,this.LianJieDai=!1,this.YuanHuan=!1};var Audiocontorl=pc.createScript("audiocontorl");Audiocontorl.attributes.add("path",{type:"string"});var bl_touch=!0;Audiocontorl.prototype.initialize=function(){var e=document.createElement("audio");e.src=this.path,e.controls="controls",e.style.display="none",e.loop="loop",document.body.appendChild(e),this._audio=e,document.addEventListener("touchstart",this._play.bind(this)),pc.events.on("audio:play",this._play,this),pc.events.on("audio:pause",this._pause,this)},Audiocontorl.prototype._play=function(e){"touchstart"===e.type&&bl_touch?(this._audio.play(),document.removeEventListener("touchstart",this._play)):"click"===e.type&&this._audio.play()},Audiocontorl.prototype._pause=function(){bl_touch=!1,this._audio.pause()},Audiocontorl.prototype.update=function(e){};var str_url,ReplaceUrl=pc.createScript("replaceUrl");ReplaceUrl.attributes.add("name",{type:"string"}),ReplaceUrl.prototype.initialize=function(){this._path="";var t=this;$.get("https://cdn.weshape3d.com/GJBZ_wechat/gjbz_share.json",function(e){t._path=e[t.name]}),pc.events.on("replace:share",this._replace,this),str_url=this._path},ReplaceUrl.prototype._replace=function(){isWeChart?wx.miniProgram.navigateTo({url:"/pages/index/share?url="+this._path}):window.location.replace(this._path)};